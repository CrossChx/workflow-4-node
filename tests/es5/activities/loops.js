"use strict";
"use strict";
var wf4node = require("../../../");
var Func = wf4node.activities.Func;
var activityMarkup = wf4node.activities.activityMarkup;
var ActivityExecutionEngine = wf4node.activities.ActivityExecutionEngine;
var assert = require("assert");
var Bluebird = require("bluebird");
var Block = wf4node.activities.Block;
var _ = require("lodash");
describe("Loops", function() {
  describe("While", function() {
    it("should run a basic cycle", function(done) {
      var block = activityMarkup.parse({"@block": {
          i: 10,
          j: 0,
          z: 0,
          args: [{"@while": {
              condition: "# this.get('j') < this.get('i')",
              args: "# this.postfixInc('j')",
              "@to": "z"
            }}, "# { j: this.get('j'), z: this.get('z') }"]
        }});
      var engine = new ActivityExecutionEngine(block);
      engine.invoke().then(function(result) {
        assert.ok(_.isObject(result));
        assert.equal(result.j, 10);
        assert.equal(result.z, 9);
      }).nodeify(done);
    });
  });
  describe('For', function() {
    it('should work between range 0 and 10 by step 1', function(done) {
      var engine = new ActivityExecutionEngine({"@block": {
          seq: "",
          args: [{"@for": {
              from: 0,
              to: {"@func": {code: function() {
                    return Bluebird.delay(100).then(function() {
                      return 10;
                    });
                  }}},
              args: "# this.set('seq', this.get('seq') + this.get('i'))"
            }}, "# this.get('seq')"]
        }});
      engine.invoke().then(function(result) {
        assert(_.isString(result));
        assert.equal(result, "0123456789");
      }).nodeify(done);
    });
    it('should work between range 10 downto 4 by step -2', function(done) {
      var engine = new ActivityExecutionEngine({"@block": {
          seq: "",
          r: null,
          args: [{"@for": {
              from: 10,
              to: {"@func": {code: function() {
                    return Bluebird.delay(100).then(function() {
                      return 4;
                    });
                  }}},
              step: -2,
              varName: "klow",
              args: "# this.set('seq', this.get('seq') + this.get('klow'))",
              "@to": "r"
            }}, "# { v: this.get('seq'), r: this.get('r') }"]
        }});
      engine.invoke().then(function(result) {
        assert(_.isObject(result));
        assert.equal(result.v, "1086");
        assert.equal(result.r, "1086");
      }).nodeify(done);
    });
  });
  describe('ForEach', function() {
    it('should work non parallel', function(done) {
      var engine = new ActivityExecutionEngine({"@block": {
          seq: {"@func": {code: function() {
                return [1, 2, 3, 4, 5, 6];
              }}},
          result: "",
          args: [{"@forEach": {
              items: "# this.get('seq')",
              args: "# this.set('result', this.get('result') + this.get('item'))"
            }}, "# this.get('result')"]
        }});
      engine.invoke().then(function(result) {
        assert(_.isString(result));
        assert.equal(result, "123456");
      }).nodeify(done);
    });
    it('should work parallel non scheduled', function(done) {
      var engine = new ActivityExecutionEngine({"@block": {
          seq: {"@func": {code: function() {
                return [1, 2, 3, 4, 5, 6];
              }}},
          result: "",
          args: [{"@forEach": {
              parallel: true,
              varName: "klow",
              items: "# this.get('seq')",
              args: "# this.set('result', this.get('result') + this.get('klow'))"
            }}, "# this.get('result')"]
        }});
      engine.invoke().then(function(result) {
        assert(_.isString(result));
        assert.equal(result, "123456");
      }).nodeify(done);
    });
    it('should work parallel scheduled', function(done) {
      var engine = new ActivityExecutionEngine({"@block": {
          seq: "function () { return [1, 2, 3, 4, 5, 6]; }",
          result: [],
          args: [{"@forEach": {
              parallel: true,
              varName: "klow",
              items: "# this.get('seq')",
              args: function() {
                var self = this;
                return Bluebird.delay(Math.random() * 100).then(function() {
                  self.get("result").push(self.get("klow"));
                });
              }
            }}, "# this.get('result')"]
        }});
      engine.invoke().then(function(result) {
        assert(_.isArray(result));
        assert.equal(result.length, 6);
        assert.equal(_(result).sum(), 6 + 5 + 4 + 3 + 2 + 1);
      }).nodeify(done);
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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QSIsImZpbGUiOiJhY3Rpdml0aWVzL2xvb3BzLmpzIiwic291cmNlUm9vdCI6InRlc3RzL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKiBnbG9iYWwgZGVzY3JpYmUsaXQgKi9cblxubGV0IHdmNG5vZGUgPSByZXF1aXJlKFwiLi4vLi4vLi4vXCIpO1xubGV0IEZ1bmMgPSB3ZjRub2RlLmFjdGl2aXRpZXMuRnVuYztcbmxldCBhY3Rpdml0eU1hcmt1cCA9IHdmNG5vZGUuYWN0aXZpdGllcy5hY3Rpdml0eU1hcmt1cDtcbmxldCBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZSA9IHdmNG5vZGUuYWN0aXZpdGllcy5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZTtcbmxldCBhc3NlcnQgPSByZXF1aXJlKFwiYXNzZXJ0XCIpO1xubGV0IEJsdWViaXJkID0gcmVxdWlyZShcImJsdWViaXJkXCIpO1xubGV0IEJsb2NrID0gd2Y0bm9kZS5hY3Rpdml0aWVzLkJsb2NrO1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xuXG5kZXNjcmliZShcIkxvb3BzXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBkZXNjcmliZShcIldoaWxlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaXQoXCJzaG91bGQgcnVuIGEgYmFzaWMgY3ljbGVcIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGxldCBibG9jayA9IGFjdGl2aXR5TWFya3VwLnBhcnNlKFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgXCJAYmxvY2tcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgaTogMTAsXG4gICAgICAgICAgICAgICAgICAgICAgICBqOiAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgejogMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQHdoaWxlXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbjogXCIjIHRoaXMuZ2V0KCdqJykgPCB0aGlzLmdldCgnaScpXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBcIiMgdGhpcy5wb3N0Zml4SW5jKCdqJylcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQHRvXCI6IFwielwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiIyB7IGo6IHRoaXMuZ2V0KCdqJyksIHo6IHRoaXMuZ2V0KCd6JykgfVwiXG4gICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IGVuZ2luZSA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZShibG9jayk7XG4gICAgICAgICAgICAvL2VuZ2luZS5hZGRUcmFja2VyKG5ldyBDb25zb2xlVHJhY2tlcigpKTtcblxuICAgICAgICAgICAgZW5naW5lLmludm9rZSgpLnRoZW4oXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQub2soXy5pc09iamVjdChyZXN1bHQpKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHJlc3VsdC5qLCAxMCk7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbChyZXN1bHQueiwgOSk7XG4gICAgICAgICAgICAgICAgfSkubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnRm9yJywgZnVuY3Rpb24gKCkge1xuICAgICAgICBpdCgnc2hvdWxkIHdvcmsgYmV0d2VlbiByYW5nZSAwIGFuZCAxMCBieSBzdGVwIDEnLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgbGV0IGVuZ2luZSA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZSh7XG4gICAgICAgICAgICAgICAgXCJAYmxvY2tcIjoge1xuICAgICAgICAgICAgICAgICAgICBzZXE6IFwiXCIsXG4gICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBmb3JcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gQmx1ZWJpcmQuZGVsYXkoMTAwKS50aGVuKGZ1bmN0aW9uICgpIHsgcmV0dXJuIDEwOyB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IFwiIyB0aGlzLnNldCgnc2VxJywgdGhpcy5nZXQoJ3NlcScpICsgdGhpcy5nZXQoJ2knKSlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBcIiMgdGhpcy5nZXQoJ3NlcScpXCJcbiAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBlbmdpbmUuaW52b2tlKCkudGhlbihcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydChfLmlzU3RyaW5nKHJlc3VsdCkpO1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0LCBcIjAxMjM0NTY3ODlcIik7XG4gICAgICAgICAgICAgICAgfSkubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCB3b3JrIGJldHdlZW4gcmFuZ2UgMTAgZG93bnRvIDQgYnkgc3RlcCAtMicsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgZW5naW5lID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKHtcbiAgICAgICAgICAgICAgICBcIkBibG9ja1wiOiB7XG4gICAgICAgICAgICAgICAgICAgIHNlcTogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgcjogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgYXJnczogW1xuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZvclwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IDEwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gQmx1ZWJpcmQuZGVsYXkoMTAwKS50aGVuKGZ1bmN0aW9uICgpIHsgcmV0dXJuIDQ7IH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RlcDogLTIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhck5hbWU6IFwia2xvd1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBcIiMgdGhpcy5zZXQoJ3NlcScsIHRoaXMuZ2V0KCdzZXEnKSArIHRoaXMuZ2V0KCdrbG93JykpXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQHRvXCI6IFwiclwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiIyB7IHY6IHRoaXMuZ2V0KCdzZXEnKSwgcjogdGhpcy5nZXQoJ3InKSB9XCJcbiAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBlbmdpbmUuaW52b2tlKCkudGhlbihcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydChfLmlzT2JqZWN0KHJlc3VsdCkpO1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0LnYsIFwiMTA4NlwiKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHJlc3VsdC5yLCBcIjEwODZcIik7XG4gICAgICAgICAgICAgICAgfSkubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnRm9yRWFjaCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaXQoJ3Nob3VsZCB3b3JrIG5vbiBwYXJhbGxlbCcsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgZW5naW5lID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKHtcbiAgICAgICAgICAgICAgICBcIkBibG9ja1wiOiB7XG4gICAgICAgICAgICAgICAgICAgIHNlcToge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzEsIDIsIDMsIDQsIDUsIDZdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBhcmdzOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZm9yRWFjaFwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zOiBcIiMgdGhpcy5nZXQoJ3NlcScpXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IFwiIyB0aGlzLnNldCgncmVzdWx0JywgdGhpcy5nZXQoJ3Jlc3VsdCcpICsgdGhpcy5nZXQoJ2l0ZW0nKSlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBcIiMgdGhpcy5nZXQoJ3Jlc3VsdCcpXCJcbiAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBlbmdpbmUuaW52b2tlKCkudGhlbihcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydChfLmlzU3RyaW5nKHJlc3VsdCkpO1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0LCBcIjEyMzQ1NlwiKTtcbiAgICAgICAgICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHdvcmsgcGFyYWxsZWwgbm9uIHNjaGVkdWxlZCcsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgZW5naW5lID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKHtcbiAgICAgICAgICAgICAgICBcIkBibG9ja1wiOiB7XG4gICAgICAgICAgICAgICAgICAgIHNlcToge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzEsIDIsIDMsIDQsIDUsIDZdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBhcmdzOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZm9yRWFjaFwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFsbGVsOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJOYW1lOiBcImtsb3dcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXM6IFwiIyB0aGlzLmdldCgnc2VxJylcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogXCIjIHRoaXMuc2V0KCdyZXN1bHQnLCB0aGlzLmdldCgncmVzdWx0JykgKyB0aGlzLmdldCgna2xvdycpKVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiIyB0aGlzLmdldCgncmVzdWx0JylcIlxuICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGVuZ2luZS5pbnZva2UoKS50aGVuKFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0KF8uaXNTdHJpbmcocmVzdWx0KSk7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbChyZXN1bHQsIFwiMTIzNDU2XCIpO1xuICAgICAgICAgICAgICAgIH0pLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgd29yayBwYXJhbGxlbCBzY2hlZHVsZWQnLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgbGV0IGVuZ2luZSA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZSh7XG4gICAgICAgICAgICAgICAgXCJAYmxvY2tcIjoge1xuICAgICAgICAgICAgICAgICAgICBzZXE6IFwiZnVuY3Rpb24gKCkgeyByZXR1cm4gWzEsIDIsIDMsIDQsIDUsIDZdOyB9XCIsXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDogW10sXG4gICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBmb3JFYWNoXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYWxsZWw6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhck5hbWU6IFwia2xvd1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtczogXCIjIHRoaXMuZ2V0KCdzZXEnKVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gQmx1ZWJpcmQuZGVsYXkoTWF0aC5yYW5kb20oKSAqIDEwMClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZ2V0KFwicmVzdWx0XCIpLnB1c2goc2VsZi5nZXQoXCJrbG93XCIpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBcIiMgdGhpcy5nZXQoJ3Jlc3VsdCcpXCJcbiAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBlbmdpbmUuaW52b2tlKCkudGhlbihcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydChfLmlzQXJyYXkocmVzdWx0KSk7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbChyZXN1bHQubGVuZ3RoLCA2KTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKF8ocmVzdWx0KS5zdW0oKSwgNiArIDUgKyA0ICsgMyArIDIgKyAxKTtcbiAgICAgICAgICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pOyJdfQ==
