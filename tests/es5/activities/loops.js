"use strict";
var wf4node = require("../../../");
var Func = wf4node.activities.Func;
var activityMarkup = wf4node.activities.activityMarkup;
var ActivityExecutionEngine = wf4node.activities.ActivityExecutionEngine;
var assert = require("assert");
var Bluebird = require("bluebird");
var Block = wf4node.activities.Block;
var _ = require("lodash");
describe("Loops", function() {
  describe("While", function() {
    it("should run a basic cycle", function(done) {
      var block = activityMarkup.parse({"@block": {
          i: 10,
          j: 0,
          z: 0,
          args: [{"@while": {
              condition: "= this.j < this.i",
              args: "= this.j++",
              "@to": "z"
            }}, "= { j: this.j, z: this.z }"]
        }});
      var engine = new ActivityExecutionEngine(block);
      engine.invoke().then(function(result) {
        assert.ok(_.isObject(result));
        assert.equal(result.j, 10);
        assert.equal(result.z, 9);
      }).nodeify(done);
    });
  });
  describe('For', function() {
    it('should work between range 0 and 10 by step 1', function(done) {
      var engine = new ActivityExecutionEngine({"@block": {
          seq: "",
          args: [{"@for": {
              from: 0,
              to: {"@func": {code: function() {
                    return Bluebird.delay(100).then(function() {
                      return 10;
                    });
                  }}},
              args: "= this.seq = this.seq + this.i"
            }}, "= this.seq"]
        }});
      engine.invoke().then(function(result) {
        assert(_.isString(result));
        assert.equal(result, "0123456789");
      }).nodeify(done);
    });
    it('should work between range 10 downto 4 by step -2', function(done) {
      var engine = new ActivityExecutionEngine({"@block": {
          seq: "",
          r: null,
          args: [{"@for": {
              from: 10,
              to: {"@func": {code: function() {
                    return Bluebird.delay(100).then(function() {
                      return 4;
                    });
                  }}},
              step: -2,
              varName: "klow",
              args: "= this.seq += this.klow",
              "@to": "r"
            }}, "= { v: this.seq, r: this.r }"]
        }});
      engine.invoke().then(function(result) {
        assert(_.isObject(result));
        assert.equal(result.v, "1086");
        assert.equal(result.r, "1086");
      }).nodeify(done);
    });
  });
  describe('ForEach', function() {
    it('should work non parallel', function(done) {
      var engine = new ActivityExecutionEngine({"@block": {
          seq: {"@func": {code: function() {
                return [1, 2, 3, 4, 5, 6];
              }}},
          result: "",
          args: [{"@forEach": {
              items: "= this.seq",
              args: "= this.result += this.item"
            }}, "= this.result"]
        }});
      engine.invoke().then(function(result) {
        assert(_.isString(result));
        assert.equal(result, "123456");
      }).nodeify(done);
    });
    it('should work parallel non scheduled', function(done) {
      var engine = new ActivityExecutionEngine({"@block": {
          seq: {"@func": {code: function() {
                return [1, 2, 3, 4, 5, 6];
              }}},
          result: "",
          args: [{"@forEach": {
              parallel: true,
              varName: "klow",
              items: "= this.seq",
              args: "= this.result += this.klow"
            }}, "= this.result"]
        }});
      engine.invoke().then(function(result) {
        assert(_.isString(result));
        assert.equal(result, "123456");
      }).nodeify(done);
    });
    it('should work parallel scheduled', function(done) {
      var engine = new ActivityExecutionEngine({"@block": {
          seq: "function () { return [1, 2, 3, 4, 5, 6]; }",
          result: [],
          args: [{"@forEach": {
              parallel: true,
              varName: "klow",
              items: "= this.seq",
              args: function() {
                var self = this;
                return Bluebird.delay(Math.random() * 100).then(function() {
                  self.result.push(self.klow);
                });
              }
            }}, "= this.result"]
        }});
      engine.invoke().then(function(result) {
        assert(_.isArray(result));
        assert.equal(result.length, 6);
        assert.equal(_(result).sum(), 6 + 5 + 4 + 3 + 2 + 1);
      }).nodeify(done);
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKiBnbG9iYWwgZGVzY3JpYmUsaXQgKi9cblxubGV0IHdmNG5vZGUgPSByZXF1aXJlKFwiLi4vLi4vLi4vXCIpO1xubGV0IEZ1bmMgPSB3ZjRub2RlLmFjdGl2aXRpZXMuRnVuYztcbmxldCBhY3Rpdml0eU1hcmt1cCA9IHdmNG5vZGUuYWN0aXZpdGllcy5hY3Rpdml0eU1hcmt1cDtcbmxldCBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZSA9IHdmNG5vZGUuYWN0aXZpdGllcy5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZTtcbmxldCBhc3NlcnQgPSByZXF1aXJlKFwiYXNzZXJ0XCIpO1xubGV0IEJsdWViaXJkID0gcmVxdWlyZShcImJsdWViaXJkXCIpO1xubGV0IEJsb2NrID0gd2Y0bm9kZS5hY3Rpdml0aWVzLkJsb2NrO1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xuXG5kZXNjcmliZShcIkxvb3BzXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBkZXNjcmliZShcIldoaWxlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaXQoXCJzaG91bGQgcnVuIGEgYmFzaWMgY3ljbGVcIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGxldCBibG9jayA9IGFjdGl2aXR5TWFya3VwLnBhcnNlKFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgXCJAYmxvY2tcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgaTogMTAsXG4gICAgICAgICAgICAgICAgICAgICAgICBqOiAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgejogMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQHdoaWxlXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbjogXCI9IHRoaXMuaiA8IHRoaXMuaVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogXCI9IHRoaXMuaisrXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkB0b1wiOiBcInpcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIj0geyBqOiB0aGlzLmosIHo6IHRoaXMueiB9XCJcbiAgICAgICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgZW5naW5lID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKGJsb2NrKTtcbiAgICAgICAgICAgIC8vZW5naW5lLmFkZFRyYWNrZXIobmV3IENvbnNvbGVUcmFja2VyKCkpO1xuXG4gICAgICAgICAgICBlbmdpbmUuaW52b2tlKCkudGhlbihcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydC5vayhfLmlzT2JqZWN0KHJlc3VsdCkpO1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0LmosIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHJlc3VsdC56LCA5KTtcbiAgICAgICAgICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdGb3InLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGl0KCdzaG91bGQgd29yayBiZXR3ZWVuIHJhbmdlIDAgYW5kIDEwIGJ5IHN0ZXAgMScsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgZW5naW5lID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKHtcbiAgICAgICAgICAgICAgICBcIkBibG9ja1wiOiB7XG4gICAgICAgICAgICAgICAgICAgIHNlcTogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgYXJnczogW1xuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZvclwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IDAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBmdW5jXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBCbHVlYmlyZC5kZWxheSgxMDApLnRoZW4oZnVuY3Rpb24gKCkgeyByZXR1cm4gMTA7IH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogXCI9IHRoaXMuc2VxID0gdGhpcy5zZXEgKyB0aGlzLmlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBcIj0gdGhpcy5zZXFcIlxuICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGVuZ2luZS5pbnZva2UoKS50aGVuKFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0KF8uaXNTdHJpbmcocmVzdWx0KSk7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbChyZXN1bHQsIFwiMDEyMzQ1Njc4OVwiKTtcbiAgICAgICAgICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHdvcmsgYmV0d2VlbiByYW5nZSAxMCBkb3dudG8gNCBieSBzdGVwIC0yJywgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGxldCBlbmdpbmUgPSBuZXcgQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUoe1xuICAgICAgICAgICAgICAgIFwiQGJsb2NrXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgc2VxOiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICByOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICBhcmdzOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZm9yXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogMTAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBmdW5jXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBCbHVlYmlyZC5kZWxheSgxMDApLnRoZW4oZnVuY3Rpb24gKCkgeyByZXR1cm4gNDsgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGVwOiAtMixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyTmFtZTogXCJrbG93XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IFwiPSB0aGlzLnNlcSArPSB0aGlzLmtsb3dcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAdG9cIjogXCJyXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgXCI9IHsgdjogdGhpcy5zZXEsIHI6IHRoaXMuciB9XCJcbiAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBlbmdpbmUuaW52b2tlKCkudGhlbihcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydChfLmlzT2JqZWN0KHJlc3VsdCkpO1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0LnYsIFwiMTA4NlwiKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHJlc3VsdC5yLCBcIjEwODZcIik7XG4gICAgICAgICAgICAgICAgfSkubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnRm9yRWFjaCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaXQoJ3Nob3VsZCB3b3JrIG5vbiBwYXJhbGxlbCcsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgZW5naW5lID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKHtcbiAgICAgICAgICAgICAgICBcIkBibG9ja1wiOiB7XG4gICAgICAgICAgICAgICAgICAgIHNlcToge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzEsIDIsIDMsIDQsIDUsIDZdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBhcmdzOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZm9yRWFjaFwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zOiBcIj0gdGhpcy5zZXFcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogXCI9IHRoaXMucmVzdWx0ICs9IHRoaXMuaXRlbVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiPSB0aGlzLnJlc3VsdFwiXG4gICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgZW5naW5lLmludm9rZSgpLnRoZW4oXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQoXy5pc1N0cmluZyhyZXN1bHQpKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHJlc3VsdCwgXCIxMjM0NTZcIik7XG4gICAgICAgICAgICAgICAgfSkubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCB3b3JrIHBhcmFsbGVsIG5vbiBzY2hlZHVsZWQnLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgbGV0IGVuZ2luZSA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZSh7XG4gICAgICAgICAgICAgICAgXCJAYmxvY2tcIjoge1xuICAgICAgICAgICAgICAgICAgICBzZXE6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZ1bmNcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsxLCAyLCAzLCA0LCA1LCA2XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgYXJnczogW1xuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZvckVhY2hcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbGxlbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyTmFtZTogXCJrbG93XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zOiBcIj0gdGhpcy5zZXFcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogXCI9IHRoaXMucmVzdWx0ICs9IHRoaXMua2xvd1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiPSB0aGlzLnJlc3VsdFwiXG4gICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgZW5naW5lLmludm9rZSgpLnRoZW4oXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQoXy5pc1N0cmluZyhyZXN1bHQpKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHJlc3VsdCwgXCIxMjM0NTZcIik7XG4gICAgICAgICAgICAgICAgfSkubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCB3b3JrIHBhcmFsbGVsIHNjaGVkdWxlZCcsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgZW5naW5lID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKHtcbiAgICAgICAgICAgICAgICBcIkBibG9ja1wiOiB7XG4gICAgICAgICAgICAgICAgICAgIHNlcTogXCJmdW5jdGlvbiAoKSB7IHJldHVybiBbMSwgMiwgMywgNCwgNSwgNl07IH1cIixcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBbXSxcbiAgICAgICAgICAgICAgICAgICAgYXJnczogW1xuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZvckVhY2hcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbGxlbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyTmFtZTogXCJrbG93XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zOiBcIj0gdGhpcy5zZXFcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEJsdWViaXJkLmRlbGF5KE1hdGgucmFuZG9tKCkgKiAxMDApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJlc3VsdC5wdXNoKHNlbGYua2xvdyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgXCI9IHRoaXMucmVzdWx0XCJcbiAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBlbmdpbmUuaW52b2tlKCkudGhlbihcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydChfLmlzQXJyYXkocmVzdWx0KSk7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbChyZXN1bHQubGVuZ3RoLCA2KTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKF8ocmVzdWx0KS5zdW0oKSwgNiArIDUgKyA0ICsgMyArIDIgKyAxKTtcbiAgICAgICAgICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pOyJdfQ==
