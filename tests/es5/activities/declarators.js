"use strict";
"use strict";
var wf4node = require("../../../");
var Func = wf4node.activities.Func;
var activityMarkup = wf4node.activities.activityMarkup;
var ActivityExecutionEngine = wf4node.activities.ActivityExecutionEngine;
var assert = require("assert");
var Bluebird = require("bluebird");
var Block = wf4node.activities.Block;
var _ = require("lodash");
describe("declarators", function() {
  describe("Block", function() {
    it("should handle variables well", function(done) {
      var block = new Block();
      block.let1 = 1;
      block.let2 = 2;
      block.let3 = 3;
      var f1 = new Func();
      f1.code = function() {
        return this.set("let3", this.get("let3") + this.get("let1") * 2);
      };
      var f2 = new Func();
      f2.code = function() {
        return this.set("let3", this.get("let3") + this.get("let2") * 3);
      };
      var f3 = new Func();
      f3.code = function() {
        return this.get("let3") * 4;
      };
      var engine = new ActivityExecutionEngine(block);
      engine.invoke(f1, f2, f3).then(function(result) {
        var x1 = 1;
        var x2 = 2;
        var x3 = 3;
        x3 += x1 * 2;
        x3 += x2 * 3;
        var r = x3 * 4;
        assert.equal(result, r);
      }).nodeify(done);
    });
    it("can be generated from markup", function(done) {
      var block = activityMarkup.parse({"@block": {
          let1: 1,
          let2: {"@func": {code: function() {
                return 2;
              }}},
          let3: 3,
          args: [{"@func": {code: function bubu() {
                return this.set("let3", this.get("let3") + this.get("let1") * 2);
              }}}, {"@func": {code: function kittyfuck() {
                return this.set("let3", this.get("let3") + this.get("let2") * 3);
              }}}, {"@func": {code: function() {
                return this.get("let3") * 4;
              }}}]
        }});
      var engine = new ActivityExecutionEngine(block);
      engine.invoke().then(function(result) {
        var x1 = 1;
        var x2 = 2;
        var x3 = 3;
        x3 += x1 * 2;
        x3 += x2 * 3;
        var r = x3 * 4;
        assert.equal(result, r);
      }).nodeify(done);
    });
    it("can be generated from markup string", function(done) {
      var markup = {"@block": {
          let1: 1,
          let2: 2,
          let3: 3,
          args: [{"@func": {code: function bubu() {
                return this.set("let3", this.get("let3") + this.get("let1") * 2);
              }}}, {"@func": {code: function kittyfuck() {
                return this.set("let3", this.get("let3") + this.get("let2") * 3);
              }}}, {"@func": {code: function() {
                return this.get("let3") * 4;
              }}}]
        }};
      var markupString = activityMarkup.stringify(markup);
      assert.ok(_.isString(markupString));
      var block = activityMarkup.parse(markupString);
      var engine = new ActivityExecutionEngine(block);
      engine.invoke().then(function(result) {
        var x1 = 1;
        var x2 = 2;
        var x3 = 3;
        x3 += x1 * 2;
        x3 += x2 * 3;
        var r = x3 * 4;
        assert.equal(result, r);
      }).nodeify(done);
    });
  });
  describe("Parallel", function() {
    it("should work as expected with sync activities", function(done) {
      var activity = activityMarkup.parse({"@parallel": {
          let1: "",
          args: [{"@func": {code: function() {
                return this.add("let1", "a");
              }}}, {"@func": {code: 'function() { return this.add("let1", "b"); }'}}]
        }});
      var engine = new ActivityExecutionEngine(activity);
      engine.invoke().then(function(result) {
        assert.equal(result.length, 2);
        assert.equal(result[0], "a");
        assert.equal(result[1], "ab");
      }).nodeify(done);
    });
    it("should work as expected with async activities", function(done) {
      var activity = activityMarkup.parse({"@parallel": {
          let1: "",
          args: [{"@func": {code: function() {
                return this.add("let1", "a");
              }}}, {"@func": {code: 'function() { return this.add("let1", "b"); }'}}, {"@func": {code: function() {
                return Bluebird.delay(100).then(function() {
                  return 42;
                });
              }}}, {"@func": {code: function() {
                return new Bluebird(function(resolve, reject) {
                  setImmediate(function() {
                    resolve(0);
                  });
                });
              }}}]
        }});
      var engine = new ActivityExecutionEngine(activity);
      engine.invoke().then(function(result) {
        assert.equal(result.length, 4);
        assert.equal(result[0], "a");
        assert.equal(result[1], "ab");
        assert.equal(result[2], 42);
        assert.equal(result[3], 0);
      }).nodeify(done);
    });
  });
  describe("Pick", function() {
    it("should work as expected with sync activities", function(done) {
      var activity = activityMarkup.parse({"@pick": {
          let1: "",
          args: [{"@func": {code: function() {
                return this.add("let1", "a");
              }}}, {"@func": {code: 'function() { return this.add("let1", "b"); }'}}]
        }});
      var engine = new ActivityExecutionEngine(activity);
      engine.invoke().then(function(result) {
        assert.equal(result, "a");
      }).nodeify(done);
    });
    it("should work as expected with async activities", function(done) {
      var activity = activityMarkup.parse({"@pick": [{"@func": {code: function() {
              return Bluebird.delay(100).then(function() {
                return 42;
              });
            }}}, {"@func": {code: function() {
              return new Bluebird(function(resolve, reject) {
                setImmediate(function() {
                  resolve(0);
                });
              });
            }}}]});
      var engine = new ActivityExecutionEngine(activity);
      engine.invoke().then(function(result) {
        assert.equal(result, 0);
      }).nodeify(done);
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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QUMsQ0FBQztnQkFDZCxDQUFDLENBQUM7Y0FDTixDQUFDLENBQUM7WUFDTixDQUNKLENBQ0osQ0FDSixDQUNKLENBQUMsQ0FBQztBQUVOLEFBQUksUUFBQSxDQUFBLE1BQUssRUFBSSxJQUFJLHdCQUFzQixBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFFbEQsV0FBSyxPQUFPLEFBQUMsRUFBQyxLQUFLLEFBQUMsQ0FDaEIsU0FBVSxNQUFLLENBQUc7QUFDZCxhQUFLLE1BQU0sQUFBQyxDQUFDLE1BQUssQ0FBRyxFQUFBLENBQUMsQ0FBQztNQUMzQixDQUFDLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0lBQ3hCLENBQUMsQ0FBQztFQUNOLENBQUMsQ0FBQztBQUNOLENBQUMsQ0FBQztBQUNGIiwiZmlsZSI6ImFjdGl2aXRpZXMvZGVjbGFyYXRvcnMuanMiLCJzb3VyY2VSb290IjoidGVzdHMvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qIGdsb2JhbCBkZXNjcmliZSxpdCAqL1xuXG5sZXQgd2Y0bm9kZSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9cIik7XG5sZXQgRnVuYyA9IHdmNG5vZGUuYWN0aXZpdGllcy5GdW5jO1xubGV0IGFjdGl2aXR5TWFya3VwID0gd2Y0bm9kZS5hY3Rpdml0aWVzLmFjdGl2aXR5TWFya3VwO1xubGV0IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lID0gd2Y0bm9kZS5hY3Rpdml0aWVzLkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lO1xubGV0IGFzc2VydCA9IHJlcXVpcmUoXCJhc3NlcnRcIik7XG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5sZXQgQmxvY2sgPSB3ZjRub2RlLmFjdGl2aXRpZXMuQmxvY2s7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5cbmRlc2NyaWJlKFwiZGVjbGFyYXRvcnNcIiwgZnVuY3Rpb24oKSB7XG4gICAgZGVzY3JpYmUoXCJCbG9ja1wiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGl0KFwic2hvdWxkIGhhbmRsZSB2YXJpYWJsZXMgd2VsbFwiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgbGV0IGJsb2NrID0gbmV3IEJsb2NrKCk7XG4gICAgICAgICAgICBibG9jay5sZXQxID0gMTtcbiAgICAgICAgICAgIGJsb2NrLmxldDIgPSAyO1xuICAgICAgICAgICAgYmxvY2subGV0MyA9IDM7XG5cbiAgICAgICAgICAgIGxldCBmMSA9IG5ldyBGdW5jKCk7XG4gICAgICAgICAgICBmMS5jb2RlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldChcImxldDNcIiwgdGhpcy5nZXQoXCJsZXQzXCIpICsgdGhpcy5nZXQoXCJsZXQxXCIpICogMik7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgZjIgPSBuZXcgRnVuYygpO1xuICAgICAgICAgICAgZjIuY29kZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZXQoXCJsZXQzXCIsIHRoaXMuZ2V0KFwibGV0M1wiKSArIHRoaXMuZ2V0KFwibGV0MlwiKSAqIDMpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgbGV0IGYzID0gbmV3IEZ1bmMoKTtcbiAgICAgICAgICAgIGYzLmNvZGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KFwibGV0M1wiKSAqIDQ7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgZW5naW5lID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKGJsb2NrKTtcblxuICAgICAgICAgICAgZW5naW5lLmludm9rZShmMSwgZjIsIGYzKS50aGVuKFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgxID0gMTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgyID0gMjtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgzID0gMztcbiAgICAgICAgICAgICAgICAgICAgeDMgKz0geDEgKiAyO1xuICAgICAgICAgICAgICAgICAgICB4MyArPSB4MiAqIDM7XG4gICAgICAgICAgICAgICAgICAgIGxldCByID0geDMgKiA0O1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0LCByKTtcbiAgICAgICAgICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdChcImNhbiBiZSBnZW5lcmF0ZWQgZnJvbSBtYXJrdXBcIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGxldCBibG9jayA9IGFjdGl2aXR5TWFya3VwLnBhcnNlKFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgXCJAYmxvY2tcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0MTogMSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldDI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBmdW5jXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0MzogMyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZ1bmNcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogZnVuY3Rpb24gYnVidSgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZXQoXCJsZXQzXCIsIHRoaXMuZ2V0KFwibGV0M1wiKSArIHRoaXMuZ2V0KFwibGV0MVwiKSAqIDIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZ1bmNcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogZnVuY3Rpb24ga2l0dHlmdWNrKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldChcImxldDNcIiwgdGhpcy5nZXQoXCJsZXQzXCIpICsgdGhpcy5nZXQoXCJsZXQyXCIpICogMyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KFwibGV0M1wiKSAqIDQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IGVuZ2luZSA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZShibG9jayk7XG5cbiAgICAgICAgICAgIGVuZ2luZS5pbnZva2UoKS50aGVuKFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgxID0gMTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgyID0gMjtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgzID0gMztcbiAgICAgICAgICAgICAgICAgICAgeDMgKz0geDEgKiAyO1xuICAgICAgICAgICAgICAgICAgICB4MyArPSB4MiAqIDM7XG4gICAgICAgICAgICAgICAgICAgIGxldCByID0geDMgKiA0O1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0LCByKTtcbiAgICAgICAgICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdChcImNhbiBiZSBnZW5lcmF0ZWQgZnJvbSBtYXJrdXAgc3RyaW5nXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgbWFya3VwID0ge1xuICAgICAgICAgICAgICAgIFwiQGJsb2NrXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0MTogMSxcbiAgICAgICAgICAgICAgICAgICAgbGV0MjogMixcbiAgICAgICAgICAgICAgICAgICAgbGV0MzogMyxcbiAgICAgICAgICAgICAgICAgICAgYXJnczogW1xuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZ1bmNcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBmdW5jdGlvbiBidWJ1KCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0KFwibGV0M1wiLCB0aGlzLmdldChcImxldDNcIikgKyB0aGlzLmdldChcImxldDFcIikgKiAyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGZ1bmN0aW9uIGtpdHR5ZnVjaygpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldChcImxldDNcIiwgdGhpcy5nZXQoXCJsZXQzXCIpICsgdGhpcy5nZXQoXCJsZXQyXCIpICogMyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZ1bmNcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoXCJsZXQzXCIpICogNDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCBtYXJrdXBTdHJpbmcgPSBhY3Rpdml0eU1hcmt1cC5zdHJpbmdpZnkobWFya3VwKTtcbiAgICAgICAgICAgIGFzc2VydC5vayhfLmlzU3RyaW5nKG1hcmt1cFN0cmluZykpO1xuICAgICAgICAgICAgbGV0IGJsb2NrID0gYWN0aXZpdHlNYXJrdXAucGFyc2UobWFya3VwU3RyaW5nKTtcblxuICAgICAgICAgICAgbGV0IGVuZ2luZSA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZShibG9jayk7XG5cbiAgICAgICAgICAgIGVuZ2luZS5pbnZva2UoKS50aGVuKFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgxID0gMTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgyID0gMjtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgzID0gMztcbiAgICAgICAgICAgICAgICAgICAgeDMgKz0geDEgKiAyO1xuICAgICAgICAgICAgICAgICAgICB4MyArPSB4MiAqIDM7XG4gICAgICAgICAgICAgICAgICAgIGxldCByID0geDMgKiA0O1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0LCByKTtcbiAgICAgICAgICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKFwiUGFyYWxsZWxcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICBpdChcInNob3VsZCB3b3JrIGFzIGV4cGVjdGVkIHdpdGggc3luYyBhY3Rpdml0aWVzXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgYWN0aXZpdHkgPSBhY3Rpdml0eU1hcmt1cC5wYXJzZShcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFwiQHBhcmFsbGVsXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldDE6IFwiXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBmdW5jXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGQoXCJsZXQxXCIsIFwiYVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBmdW5jXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6ICdmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuYWRkKFwibGV0MVwiLCBcImJcIik7IH0nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IGVuZ2luZSA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZShhY3Rpdml0eSk7XG4gICAgICAgICAgICAvL2VuZ2luZS5hZGRUcmFja2VyKG5ldyBDb25zb2xlVHJhY2tlcigpKTtcblxuICAgICAgICAgICAgZW5naW5lLmludm9rZSgpLnRoZW4oXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0Lmxlbmd0aCwgMik7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbChyZXN1bHRbMF0sIFwiYVwiKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHJlc3VsdFsxXSwgXCJhYlwiKTtcbiAgICAgICAgICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdChcInNob3VsZCB3b3JrIGFzIGV4cGVjdGVkIHdpdGggYXN5bmMgYWN0aXZpdGllc1wiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgbGV0IGFjdGl2aXR5ID0gYWN0aXZpdHlNYXJrdXAucGFyc2UoXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBcIkBwYXJhbGxlbFwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQxOiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkKFwibGV0MVwiLCBcImFcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiAnZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLmFkZChcImxldDFcIiwgXCJiXCIpOyB9J1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZ1bmNcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBCbHVlYmlyZC5kZWxheSgxMDApLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gNDI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBCbHVlYmlyZChmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldEltbWVkaWF0ZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgZW5naW5lID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKGFjdGl2aXR5KTtcbiAgICAgICAgICAgIC8vZW5naW5lLmFkZFRyYWNrZXIobmV3IENvbnNvbGVUcmFja2VyKCkpO1xuXG4gICAgICAgICAgICBlbmdpbmUuaW52b2tlKCkudGhlbihcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbChyZXN1bHQubGVuZ3RoLCA0KTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHJlc3VsdFswXSwgXCJhXCIpO1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0WzFdLCBcImFiXCIpO1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0WzJdLCA0Mik7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbChyZXN1bHRbM10sIDApO1xuICAgICAgICAgICAgICAgIH0pLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoXCJQaWNrXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaXQoXCJzaG91bGQgd29yayBhcyBleHBlY3RlZCB3aXRoIHN5bmMgYWN0aXZpdGllc1wiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgbGV0IGFjdGl2aXR5ID0gYWN0aXZpdHlNYXJrdXAucGFyc2UoXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBcIkBwaWNrXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldDE6IFwiXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBmdW5jXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGQoXCJsZXQxXCIsIFwiYVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBmdW5jXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6ICdmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuYWRkKFwibGV0MVwiLCBcImJcIik7IH0nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IGVuZ2luZSA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZShhY3Rpdml0eSk7XG5cbiAgICAgICAgICAgIGVuZ2luZS5pbnZva2UoKS50aGVuKFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHJlc3VsdCwgXCJhXCIpO1xuICAgICAgICAgICAgICAgIH0pLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KFwic2hvdWxkIHdvcmsgYXMgZXhwZWN0ZWQgd2l0aCBhc3luYyBhY3Rpdml0aWVzXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgYWN0aXZpdHkgPSBhY3Rpdml0eU1hcmt1cC5wYXJzZShcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFwiQHBpY2tcIjogW1xuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZ1bmNcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gQmx1ZWJpcmQuZGVsYXkoMTAwKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gNDI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQmx1ZWJpcmQoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldEltbWVkaWF0ZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgZW5naW5lID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKGFjdGl2aXR5KTtcblxuICAgICAgICAgICAgZW5naW5lLmludm9rZSgpLnRoZW4oXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwocmVzdWx0LCAwKTtcbiAgICAgICAgICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIl19
