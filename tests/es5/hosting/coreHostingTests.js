"use strict";
var wf4node = require("../../../");
var InstanceIdParser = wf4node.hosting.InstanceIdParser;
var _ = require("lodash");
var hostingTestCommon = require("./hostingTestCommon");
var MemoryPersistence = wf4node.hosting.MemoryPersistence;
var Serializer = require("backpack-node").system.Serializer;
var assert = require("assert");
describe("InstanceIdParser", function() {
  describe("#parse()", function() {
    it("should understand common paths", function() {
      var p = new InstanceIdParser();
      assert.equal(p.parse("this", 1), 1);
      assert.equal(p.parse("[0]", [1]), 1);
      assert.equal(p.parse("[0]", [4, 5]), 4);
      assert.equal(p.parse("[1].id", [{id: 1}, {id: 2}]), 2);
      assert.equal(p.parse("id[0].a", {id: [{a: "foo"}]}), "foo");
    });
  });
});
describe("WorkflowHost", function() {
  describe("Without persistence", function() {
    it("should run basic hosting example", function(done) {
      hostingTestCommon.doBasicHostTest().nodeify(done);
    });
    it("should run correlated calculator example", function(done) {
      hostingTestCommon.doCalculatorTest().nodeify(done);
    });
  });
  describe("With MemoryPersistence", function() {
    this.timeout(5000);
    it("should run basic hosting example in non-lazy mode", function(done) {
      var hostOptions = {
        persistence: new MemoryPersistence(),
        lazyPersistence: false,
        serializer: null,
        alwaysLoadState: true
      };
      hostingTestCommon.doBasicHostTest(hostOptions).nodeify(done);
    });
    it("should run basic hosting example in lazy mode", function(done) {
      var hostOptions = {
        persistence: new MemoryPersistence(),
        lazyPersistence: true,
        serializer: null,
        alwaysLoadState: true
      };
      hostingTestCommon.doBasicHostTest(hostOptions).nodeify(done);
    });
    it("should run correlated calculator example in non-lazy mode", function(done) {
      var hostOptions = {
        persistence: new MemoryPersistence(),
        lazyPersistence: false,
        serializer: null,
        alwaysLoadState: true
      };
      hostingTestCommon.doCalculatorTest(hostOptions).nodeify(done);
    });
    it("should run correlated calculator example in lazy mode", function(done) {
      var hostOptions = {
        persistence: new MemoryPersistence(),
        lazyPersistence: true,
        serializer: null,
        alwaysLoadState: true
      };
      hostingTestCommon.doCalculatorTest(hostOptions).nodeify(done);
    });
    it("should run correlated calculator example if state is serialized", function(done) {
      var hostOptions = {
        persistence: new MemoryPersistence(),
        lazyPersistence: false,
        serializer: new Serializer(),
        alwaysLoadState: true
      };
      hostingTestCommon.doCalculatorTest(hostOptions).nodeify(done);
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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UUFBQSxDQUFBLFdBQVUsRUFBSTtBQUNkLGtCQUFVLENBQUcsSUFBSSxrQkFBZ0IsQUFBQyxFQUFDO0FBQ25DLHNCQUFjLENBQUcsS0FBRztBQUNwQixpQkFBUyxDQUFHLEtBQUc7QUFDZixzQkFBYyxDQUFHLEtBQUc7QUFBQSxNQUN4QixDQUFDO0FBQ0Qsc0JBQWdCLGlCQUFpQixBQUFDLENBQUMsV0FBVSxDQUFDLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0lBQ2pFLENBQUMsQ0FBQztBQUVGLEtBQUMsQUFBQyxDQUFDLGlFQUFnRSxDQUFHLFVBQVUsSUFBRyxDQUFHO0FBQ2xGLEFBQUksUUFBQSxDQUFBLFdBQVUsRUFBSTtBQUNkLGtCQUFVLENBQUcsSUFBSSxrQkFBZ0IsQUFBQyxFQUFDO0FBQ25DLHNCQUFjLENBQUcsTUFBSTtBQUNyQixpQkFBUyxDQUFHLElBQUksV0FBUyxBQUFDLEVBQUM7QUFDM0Isc0JBQWMsQ0FBRyxLQUFHO0FBQUEsTUFDeEIsQ0FBQztBQUNELHNCQUFnQixpQkFBaUIsQUFBQyxDQUFDLFdBQVUsQ0FBQyxRQUFRLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztJQUNqRSxDQUFDLENBQUM7RUFDTixDQUFDLENBQUM7QUFDTixDQUFDLENBQUM7QUFDRiIsImZpbGUiOiJob3N0aW5nL2NvcmVIb3N0aW5nVGVzdHMuanMiLCJzb3VyY2VSb290IjoidGVzdHMvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsidmFyIHdmNG5vZGUgPSByZXF1aXJlKFwiLi4vLi4vLi4vXCIpO1xudmFyIEluc3RhbmNlSWRQYXJzZXIgPSB3ZjRub2RlLmhvc3RpbmcuSW5zdGFuY2VJZFBhcnNlcjtcbnZhciBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbnZhciBob3N0aW5nVGVzdENvbW1vbiA9IHJlcXVpcmUoXCIuL2hvc3RpbmdUZXN0Q29tbW9uXCIpO1xudmFyIE1lbW9yeVBlcnNpc3RlbmNlID0gd2Y0bm9kZS5ob3N0aW5nLk1lbW9yeVBlcnNpc3RlbmNlO1xudmFyIFNlcmlhbGl6ZXIgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5zeXN0ZW0uU2VyaWFsaXplcjtcblxudmFyIGFzc2VydCA9IHJlcXVpcmUoXCJhc3NlcnRcIik7XG5cbmRlc2NyaWJlKFwiSW5zdGFuY2VJZFBhcnNlclwiLCBmdW5jdGlvbiAoKSB7XG4gICAgZGVzY3JpYmUoXCIjcGFyc2UoKVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGl0KFwic2hvdWxkIHVuZGVyc3RhbmQgY29tbW9uIHBhdGhzXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBwID0gbmV3IEluc3RhbmNlSWRQYXJzZXIoKTtcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChwLnBhcnNlKFwidGhpc1wiLCAxKSwgMSk7XG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwocC5wYXJzZShcIlswXVwiLCBbMV0pLCAxKTtcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChwLnBhcnNlKFwiWzBdXCIsIFs0LCA1XSksIDQpO1xuICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHAucGFyc2UoXCJbMV0uaWRcIiwgW3tpZDogMX0sIHtpZDogMn1dKSwgMik7XG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwocC5wYXJzZShcImlkWzBdLmFcIiwge2lkOiBbe2E6IFwiZm9vXCJ9XX0pLCBcImZvb1wiKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcblxuZGVzY3JpYmUoXCJXb3JrZmxvd0hvc3RcIiwgZnVuY3Rpb24gKCkge1xuICAgIGRlc2NyaWJlKFwiV2l0aG91dCBwZXJzaXN0ZW5jZVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGl0KFwic2hvdWxkIHJ1biBiYXNpYyBob3N0aW5nIGV4YW1wbGVcIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGhvc3RpbmdUZXN0Q29tbW9uLmRvQmFzaWNIb3N0VGVzdCgpLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KFwic2hvdWxkIHJ1biBjb3JyZWxhdGVkIGNhbGN1bGF0b3IgZXhhbXBsZVwiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgaG9zdGluZ1Rlc3RDb21tb24uZG9DYWxjdWxhdG9yVGVzdCgpLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoXCJXaXRoIE1lbW9yeVBlcnNpc3RlbmNlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy50aW1lb3V0KDUwMDApO1xuXG4gICAgICAgIGl0KFwic2hvdWxkIHJ1biBiYXNpYyBob3N0aW5nIGV4YW1wbGUgaW4gbm9uLWxhenkgbW9kZVwiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgdmFyIGhvc3RPcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIHBlcnNpc3RlbmNlOiBuZXcgTWVtb3J5UGVyc2lzdGVuY2UoKSxcbiAgICAgICAgICAgICAgICBsYXp5UGVyc2lzdGVuY2U6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHNlcmlhbGl6ZXI6IG51bGwsXG4gICAgICAgICAgICAgICAgYWx3YXlzTG9hZFN0YXRlOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgaG9zdGluZ1Rlc3RDb21tb24uZG9CYXNpY0hvc3RUZXN0KGhvc3RPcHRpb25zKS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdChcInNob3VsZCBydW4gYmFzaWMgaG9zdGluZyBleGFtcGxlIGluIGxhenkgbW9kZVwiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgdmFyIGhvc3RPcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIHBlcnNpc3RlbmNlOiBuZXcgTWVtb3J5UGVyc2lzdGVuY2UoKSxcbiAgICAgICAgICAgICAgICBsYXp5UGVyc2lzdGVuY2U6IHRydWUsXG4gICAgICAgICAgICAgICAgc2VyaWFsaXplcjogbnVsbCxcbiAgICAgICAgICAgICAgICBhbHdheXNMb2FkU3RhdGU6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBob3N0aW5nVGVzdENvbW1vbi5kb0Jhc2ljSG9zdFRlc3QoaG9zdE9wdGlvbnMpLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KFwic2hvdWxkIHJ1biBjb3JyZWxhdGVkIGNhbGN1bGF0b3IgZXhhbXBsZSBpbiBub24tbGF6eSBtb2RlXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICB2YXIgaG9zdE9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgcGVyc2lzdGVuY2U6IG5ldyBNZW1vcnlQZXJzaXN0ZW5jZSgpLFxuICAgICAgICAgICAgICAgIGxhenlQZXJzaXN0ZW5jZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgc2VyaWFsaXplcjogbnVsbCxcbiAgICAgICAgICAgICAgICBhbHdheXNMb2FkU3RhdGU6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBob3N0aW5nVGVzdENvbW1vbi5kb0NhbGN1bGF0b3JUZXN0KGhvc3RPcHRpb25zKS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdChcInNob3VsZCBydW4gY29ycmVsYXRlZCBjYWxjdWxhdG9yIGV4YW1wbGUgaW4gbGF6eSBtb2RlXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICB2YXIgaG9zdE9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgcGVyc2lzdGVuY2U6IG5ldyBNZW1vcnlQZXJzaXN0ZW5jZSgpLFxuICAgICAgICAgICAgICAgIGxhenlQZXJzaXN0ZW5jZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzZXJpYWxpemVyOiBudWxsLFxuICAgICAgICAgICAgICAgIGFsd2F5c0xvYWRTdGF0ZTogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGhvc3RpbmdUZXN0Q29tbW9uLmRvQ2FsY3VsYXRvclRlc3QoaG9zdE9wdGlvbnMpLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KFwic2hvdWxkIHJ1biBjb3JyZWxhdGVkIGNhbGN1bGF0b3IgZXhhbXBsZSBpZiBzdGF0ZSBpcyBzZXJpYWxpemVkXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICB2YXIgaG9zdE9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgcGVyc2lzdGVuY2U6IG5ldyBNZW1vcnlQZXJzaXN0ZW5jZSgpLFxuICAgICAgICAgICAgICAgIGxhenlQZXJzaXN0ZW5jZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgc2VyaWFsaXplcjogbmV3IFNlcmlhbGl6ZXIoKSxcbiAgICAgICAgICAgICAgICBhbHdheXNMb2FkU3RhdGU6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBob3N0aW5nVGVzdENvbW1vbi5kb0NhbGN1bGF0b3JUZXN0KGhvc3RPcHRpb25zKS5ub2RlaWZ5KGRvbmUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIl19
