"use strict";
var wf4node = require("../../../");
var InstanceIdParser = wf4node.hosting.InstanceIdParser;
var _ = require("lodash");
var hostingTestCommon = require("./hostingTestCommon");
var MemoryPersistence = wf4node.hosting.MemoryPersistence;
var Serializer = require("backpack-node").system.Serializer;
var assert = require("assert");
describe("InstanceIdParser", function() {
  describe("parse()", function() {
    it("should understand common paths", function() {
      var p = new InstanceIdParser();
      assert.equal(p.parse("this", 1), 1);
      assert.equal(p.parse("[0]", [1]), 1);
      assert.equal(p.parse("[0]", [4, 5]), 4);
      assert.equal(p.parse("[1].id", [{id: 1}, {id: 2}]), 2);
      assert.equal(p.parse("id[0].a", {id: [{a: "foo"}]}), "foo");
    });
  });
});
describe("WorkflowHost", function() {
  this.timeout(60000);
  function getInfo(options) {
    return ("persistence: " + (options.persistence ? "on" : "off") + ", lazy: " + (options.lazyPersistence ? "yes" : "no") + ", serializer: " + (options.serializer ? "yes" : "no") + ", alwaysLoad: " + (options.alwaysLoadState ? "yes" : "no"));
  }
  function testBasic(options) {
    it("should run by: " + getInfo(options), function(done) {
      hostingTestCommon.doBasicHostTest(options).nodeify(done);
    });
  }
  function testCalc(options) {
    it("should run by: " + getInfo(options), function(done) {
      hostingTestCommon.doCalculatorTest(options).nodeify(done);
    });
  }
  function testDelayTo(options) {
    it("should run by: " + getInfo(options), function(done) {
      hostingTestCommon.doDelayTest(options).nodeify(done);
    });
  }
  function testStopOutdatedVersions(options) {
    it("should run by: " + getInfo(options), function(done) {
      hostingTestCommon.doStopOutdatedVersionsTest(options).nodeify(done);
    });
  }
  var allOptions = [{
    persistence: null,
    lazyPersistence: false,
    serializer: null,
    alwaysLoadState: false
  }, {
    persistence: new MemoryPersistence(),
    lazyPersistence: false,
    serializer: null,
    alwaysLoadState: false
  }, {
    persistence: new MemoryPersistence(),
    lazyPersistence: true,
    serializer: null,
    alwaysLoadState: false
  }, {
    persistence: new MemoryPersistence(),
    lazyPersistence: false,
    serializer: new Serializer(),
    alwaysLoadState: false
  }, {
    persistence: new MemoryPersistence(),
    lazyPersistence: true,
    serializer: new Serializer(),
    alwaysLoadState: false
  }, {
    persistence: new MemoryPersistence(),
    lazyPersistence: false,
    serializer: new Serializer(),
    alwaysLoadState: true
  }, {
    persistence: new MemoryPersistence(),
    lazyPersistence: true,
    serializer: new Serializer(),
    alwaysLoadState: true
  }];
  describe("Without Persistence and With Memory Persistence", function() {
    describe("Basic Example", function() {
      var $__5 = true;
      var $__6 = false;
      var $__7 = undefined;
      try {
        for (var $__3 = void 0,
            $__2 = (allOptions)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
          var opt = $__3.value;
          {
            if (opt.persistence) {
              opt.persistence.clear();
            }
            testBasic(opt);
          }
        }
      } catch ($__8) {
        $__6 = true;
        $__7 = $__8;
      } finally {
        try {
          if (!$__5 && $__2.return != null) {
            $__2.return();
          }
        } finally {
          if ($__6) {
            throw $__7;
          }
        }
      }
    });
    describe("Calculator Example", function() {
      var $__5 = true;
      var $__6 = false;
      var $__7 = undefined;
      try {
        for (var $__3 = void 0,
            $__2 = (allOptions)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
          var opt = $__3.value;
          {
            if (opt.persistence) {
              opt.persistence.clear();
            }
            testCalc(opt);
          }
        }
      } catch ($__8) {
        $__6 = true;
        $__7 = $__8;
      } finally {
        try {
          if (!$__5 && $__2.return != null) {
            $__2.return();
          }
        } finally {
          if ($__6) {
            throw $__7;
          }
        }
      }
    });
    describe("DelayTo Example", function() {
      var $__5 = true;
      var $__6 = false;
      var $__7 = undefined;
      try {
        for (var $__3 = void 0,
            $__2 = (allOptions)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
          var opt = $__3.value;
          {
            if (opt.persistence) {
              opt.persistence.clear();
            }
            testDelayTo(opt);
          }
        }
      } catch ($__8) {
        $__6 = true;
        $__7 = $__8;
      } finally {
        try {
          if (!$__5 && $__2.return != null) {
            $__2.return();
          }
        } finally {
          if ($__6) {
            throw $__7;
          }
        }
      }
    });
    describe("StopOutdatedVersions Example", function() {
      var $__5 = true;
      var $__6 = false;
      var $__7 = undefined;
      try {
        for (var $__3 = void 0,
            $__2 = (allOptions)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
          var opt = $__3.value;
          {
            if (opt.persistence) {
              opt.persistence.clear();
            }
            testStopOutdatedVersions(opt);
          }
        }
      } catch ($__8) {
        $__6 = true;
        $__7 = $__8;
      } finally {
        try {
          if (!$__5 && $__2.return != null) {
            $__2.return();
          }
        } finally {
          if ($__6) {
            throw $__7;
          }
        }
      }
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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RkEsQ0FBRSxZQUEwQjtBQUMxQixhQUFvQixLQUFHLENBQUM7QUFDeEIsa0JBQW9DLENBQUM7TUFDdkMsQ0FBRSxPQUFRO0FBQ1IsVUFBSTtBQUNGLGFBQUksS0FBaUIsR0FBSyxDQUFBLFdBQXVCLEdBQUssS0FBRyxDQUFHO0FBQzFELHNCQUF3QixBQUFDLEVBQUMsQ0FBQztVQUM3QjtBQUFBLFFBQ0YsQ0FBRSxPQUFRO0FBQ1Isa0JBQXdCO0FBQ3RCLHNCQUF3QjtVQUMxQjtBQUFBLFFBQ0Y7QUFBQSxNQUNGO0FBQUEsSUFzSEEsQ0FBQyxDQUFDO0VBQ04sQ0FBQyxDQUFDO0FBQ04sQ0FBQyxDQUFDO0FBQ0YiLCJmaWxlIjoiaG9zdGluZy9jb3JlSG9zdGluZ1Rlc3RzLmpzIiwic291cmNlUm9vdCI6InRlc3RzL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKiBnbG9iYWwgZGVzY3JpYmUsaXQgKi9cblxubGV0IHdmNG5vZGUgPSByZXF1aXJlKFwiLi4vLi4vLi4vXCIpO1xubGV0IEluc3RhbmNlSWRQYXJzZXIgPSB3ZjRub2RlLmhvc3RpbmcuSW5zdGFuY2VJZFBhcnNlcjtcbmxldCBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbmxldCBob3N0aW5nVGVzdENvbW1vbiA9IHJlcXVpcmUoXCIuL2hvc3RpbmdUZXN0Q29tbW9uXCIpO1xubGV0IE1lbW9yeVBlcnNpc3RlbmNlID0gd2Y0bm9kZS5ob3N0aW5nLk1lbW9yeVBlcnNpc3RlbmNlO1xubGV0IFNlcmlhbGl6ZXIgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5zeXN0ZW0uU2VyaWFsaXplcjtcblxubGV0IGFzc2VydCA9IHJlcXVpcmUoXCJhc3NlcnRcIik7XG5cbmRlc2NyaWJlKFwiSW5zdGFuY2VJZFBhcnNlclwiLCBmdW5jdGlvbiAoKSB7XG4gICAgZGVzY3JpYmUoXCJwYXJzZSgpXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaXQoXCJzaG91bGQgdW5kZXJzdGFuZCBjb21tb24gcGF0aHNcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgbGV0IHAgPSBuZXcgSW5zdGFuY2VJZFBhcnNlcigpO1xuICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHAucGFyc2UoXCJ0aGlzXCIsIDEpLCAxKTtcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChwLnBhcnNlKFwiWzBdXCIsIFsxXSksIDEpO1xuICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHAucGFyc2UoXCJbMF1cIiwgWzQsIDVdKSwgNCk7XG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwocC5wYXJzZShcIlsxXS5pZFwiLCBbeyBpZDogMSB9LCB7IGlkOiAyIH1dKSwgMik7XG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwocC5wYXJzZShcImlkWzBdLmFcIiwgeyBpZDogW3sgYTogXCJmb29cIiB9XSB9KSwgXCJmb29cIik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG5cbmRlc2NyaWJlKFwiV29ya2Zsb3dIb3N0XCIsIGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnRpbWVvdXQoNjAwMDApO1xuXG4gICAgZnVuY3Rpb24gZ2V0SW5mbyhvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBgcGVyc2lzdGVuY2U6ICR7b3B0aW9ucy5wZXJzaXN0ZW5jZSA/IFwib25cIiA6IFwib2ZmXCJ9LCBsYXp5OiAke29wdGlvbnMubGF6eVBlcnNpc3RlbmNlID8gXCJ5ZXNcIiA6IFwibm9cIn0sIHNlcmlhbGl6ZXI6ICR7b3B0aW9ucy5zZXJpYWxpemVyID8gXCJ5ZXNcIiA6IFwibm9cIn0sIGFsd2F5c0xvYWQ6ICR7b3B0aW9ucy5hbHdheXNMb2FkU3RhdGUgPyBcInllc1wiIDogXCJub1wifWA7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdGVzdEJhc2ljKG9wdGlvbnMpIHtcbiAgICAgICAgaXQoXCJzaG91bGQgcnVuIGJ5OiBcIiArIGdldEluZm8ob3B0aW9ucyksIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBob3N0aW5nVGVzdENvbW1vbi5kb0Jhc2ljSG9zdFRlc3Qob3B0aW9ucykubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdGVzdENhbGMob3B0aW9ucykge1xuICAgICAgICBpdChcInNob3VsZCBydW4gYnk6IFwiICsgZ2V0SW5mbyhvcHRpb25zKSwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGhvc3RpbmdUZXN0Q29tbW9uLmRvQ2FsY3VsYXRvclRlc3Qob3B0aW9ucykubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdGVzdERlbGF5VG8ob3B0aW9ucykge1xuICAgICAgICBpdChcInNob3VsZCBydW4gYnk6IFwiICsgZ2V0SW5mbyhvcHRpb25zKSwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGhvc3RpbmdUZXN0Q29tbW9uLmRvRGVsYXlUZXN0KG9wdGlvbnMpLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHRlc3RTdG9wT3V0ZGF0ZWRWZXJzaW9ucyhvcHRpb25zKSB7XG4gICAgICAgIGl0KFwic2hvdWxkIHJ1biBieTogXCIgKyBnZXRJbmZvKG9wdGlvbnMpLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgaG9zdGluZ1Rlc3RDb21tb24uZG9TdG9wT3V0ZGF0ZWRWZXJzaW9uc1Rlc3Qob3B0aW9ucykubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgbGV0IGFsbE9wdGlvbnMgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICAgIHBlcnNpc3RlbmNlOiBudWxsLFxuICAgICAgICAgICAgbGF6eVBlcnNpc3RlbmNlOiBmYWxzZSxcbiAgICAgICAgICAgIHNlcmlhbGl6ZXI6IG51bGwsXG4gICAgICAgICAgICBhbHdheXNMb2FkU3RhdGU6IGZhbHNlXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIHBlcnNpc3RlbmNlOiBuZXcgTWVtb3J5UGVyc2lzdGVuY2UoKSxcbiAgICAgICAgICAgIGxhenlQZXJzaXN0ZW5jZTogZmFsc2UsXG4gICAgICAgICAgICBzZXJpYWxpemVyOiBudWxsLFxuICAgICAgICAgICAgYWx3YXlzTG9hZFN0YXRlOiBmYWxzZVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBwZXJzaXN0ZW5jZTogbmV3IE1lbW9yeVBlcnNpc3RlbmNlKCksXG4gICAgICAgICAgICBsYXp5UGVyc2lzdGVuY2U6IHRydWUsXG4gICAgICAgICAgICBzZXJpYWxpemVyOiBudWxsLFxuICAgICAgICAgICAgYWx3YXlzTG9hZFN0YXRlOiBmYWxzZVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBwZXJzaXN0ZW5jZTogbmV3IE1lbW9yeVBlcnNpc3RlbmNlKCksXG4gICAgICAgICAgICBsYXp5UGVyc2lzdGVuY2U6IGZhbHNlLFxuICAgICAgICAgICAgc2VyaWFsaXplcjogbmV3IFNlcmlhbGl6ZXIoKSxcbiAgICAgICAgICAgIGFsd2F5c0xvYWRTdGF0ZTogZmFsc2VcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgcGVyc2lzdGVuY2U6IG5ldyBNZW1vcnlQZXJzaXN0ZW5jZSgpLFxuICAgICAgICAgICAgbGF6eVBlcnNpc3RlbmNlOiB0cnVlLFxuICAgICAgICAgICAgc2VyaWFsaXplcjogbmV3IFNlcmlhbGl6ZXIoKSxcbiAgICAgICAgICAgIGFsd2F5c0xvYWRTdGF0ZTogZmFsc2VcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgcGVyc2lzdGVuY2U6IG5ldyBNZW1vcnlQZXJzaXN0ZW5jZSgpLFxuICAgICAgICAgICAgbGF6eVBlcnNpc3RlbmNlOiBmYWxzZSxcbiAgICAgICAgICAgIHNlcmlhbGl6ZXI6IG5ldyBTZXJpYWxpemVyKCksXG4gICAgICAgICAgICBhbHdheXNMb2FkU3RhdGU6IHRydWVcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgcGVyc2lzdGVuY2U6IG5ldyBNZW1vcnlQZXJzaXN0ZW5jZSgpLFxuICAgICAgICAgICAgbGF6eVBlcnNpc3RlbmNlOiB0cnVlLFxuICAgICAgICAgICAgc2VyaWFsaXplcjogbmV3IFNlcmlhbGl6ZXIoKSxcbiAgICAgICAgICAgIGFsd2F5c0xvYWRTdGF0ZTogdHJ1ZVxuICAgICAgICB9XG4gICAgXTtcblxuICAgIGRlc2NyaWJlKFwiV2l0aG91dCBQZXJzaXN0ZW5jZSBhbmQgV2l0aCBNZW1vcnkgUGVyc2lzdGVuY2VcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICBkZXNjcmliZShcIkJhc2ljIEV4YW1wbGVcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgZm9yIChsZXQgb3B0IG9mIGFsbE9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBpZiAob3B0LnBlcnNpc3RlbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdC5wZXJzaXN0ZW5jZS5jbGVhcigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0ZXN0QmFzaWMob3B0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgZGVzY3JpYmUoXCJDYWxjdWxhdG9yIEV4YW1wbGVcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgZm9yIChsZXQgb3B0IG9mIGFsbE9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBpZiAob3B0LnBlcnNpc3RlbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdC5wZXJzaXN0ZW5jZS5jbGVhcigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0ZXN0Q2FsYyhvcHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZShcIkRlbGF5VG8gRXhhbXBsZVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBvcHQgb2YgYWxsT3B0aW9ucykge1xuICAgICAgICAgICAgICAgIGlmIChvcHQucGVyc2lzdGVuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0LnBlcnNpc3RlbmNlLmNsZWFyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRlc3REZWxheVRvKG9wdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGRlc2NyaWJlKFwiU3RvcE91dGRhdGVkVmVyc2lvbnMgRXhhbXBsZVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBvcHQgb2YgYWxsT3B0aW9ucykge1xuICAgICAgICAgICAgICAgIGlmIChvcHQucGVyc2lzdGVuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0LnBlcnNpc3RlbmNlLmNsZWFyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRlc3RTdG9wT3V0ZGF0ZWRWZXJzaW9ucyhvcHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIl19
