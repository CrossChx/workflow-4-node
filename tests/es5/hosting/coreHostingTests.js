"use strict";
"use strict";
var wf4node = require("../../../");
var InstanceIdParser = wf4node.hosting.InstanceIdParser;
var _ = require("lodash");
var hostingTestCommon = require("./hostingTestCommon");
var MemoryPersistence = wf4node.hosting.MemoryPersistence;
var Serializer = require("backpack-node").system.Serializer;
var assert = require("assert");
describe("InstanceIdParser", function() {
  describe("#parse()", function() {
    it("should understand common paths", function() {
      var p = new InstanceIdParser();
      assert.equal(p.parse("this", 1), 1);
      assert.equal(p.parse("[0]", [1]), 1);
      assert.equal(p.parse("[0]", [4, 5]), 4);
      assert.equal(p.parse("[1].id", [{id: 1}, {id: 2}]), 2);
      assert.equal(p.parse("id[0].a", {id: [{a: "foo"}]}), "foo");
    });
  });
});
describe("WorkflowHost", function() {
  describe("Without persistence", function() {
    it("should run basic hosting example", function(done) {
      hostingTestCommon.doBasicHostTest().nodeify(done);
    });
    it("should run correlated calculator example", function(done) {
      hostingTestCommon.doCalculatorTest().nodeify(done);
    });
  });
  describe("With MemoryPersistence", function() {
    this.timeout(5000);
    it("should run basic hosting example in non-lazy mode", function(done) {
      var hostOptions = {
        persistence: new MemoryPersistence(),
        lazyPersistence: false,
        serializer: null,
        alwaysLoadState: true
      };
      hostingTestCommon.doBasicHostTest(hostOptions).nodeify(done);
    });
    it("should run basic hosting example in lazy mode", function(done) {
      var hostOptions = {
        persistence: new MemoryPersistence(),
        lazyPersistence: true,
        serializer: null,
        alwaysLoadState: true
      };
      hostingTestCommon.doBasicHostTest(hostOptions).nodeify(done);
    });
    it("should run correlated calculator example in non-lazy mode", function(done) {
      var hostOptions = {
        persistence: new MemoryPersistence(),
        lazyPersistence: false,
        serializer: null,
        alwaysLoadState: true
      };
      hostingTestCommon.doCalculatorTest(hostOptions).nodeify(done);
    });
    it("should run correlated calculator example in lazy mode", function(done) {
      var hostOptions = {
        persistence: new MemoryPersistence(),
        lazyPersistence: true,
        serializer: null,
        alwaysLoadState: true
      };
      hostingTestCommon.doCalculatorTest(hostOptions).nodeify(done);
    });
    it("should run correlated calculator example if state is serialized", function(done) {
      var hostOptions = {
        persistence: new MemoryPersistence(),
        lazyPersistence: false,
        serializer: new Serializer(),
        alwaysLoadState: true
      };
      hostingTestCommon.doCalculatorTest(hostOptions).nodeify(done);
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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QUFHO0FBQ3hFLEFBQUksUUFBQSxDQUFBLFdBQVUsRUFBSTtBQUNkLGtCQUFVLENBQUcsSUFBSSxrQkFBZ0IsQUFBQyxFQUFDO0FBQ25DLHNCQUFjLENBQUcsS0FBRztBQUNwQixpQkFBUyxDQUFHLEtBQUc7QUFDZixzQkFBYyxDQUFHLEtBQUc7QUFBQSxNQUN4QixDQUFDO0FBQ0Qsc0JBQWdCLGlCQUFpQixBQUFDLENBQUMsV0FBVSxDQUFDLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0lBQ2pFLENBQUMsQ0FBQztBQUVGLEtBQUMsQUFBQyxDQUFDLGlFQUFnRSxDQUFHLFVBQVUsSUFBRyxDQUFHO0FBQ2xGLEFBQUksUUFBQSxDQUFBLFdBQVUsRUFBSTtBQUNkLGtCQUFVLENBQUcsSUFBSSxrQkFBZ0IsQUFBQyxFQUFDO0FBQ25DLHNCQUFjLENBQUcsTUFBSTtBQUNyQixpQkFBUyxDQUFHLElBQUksV0FBUyxBQUFDLEVBQUM7QUFDM0Isc0JBQWMsQ0FBRyxLQUFHO0FBQUEsTUFDeEIsQ0FBQztBQUNELHNCQUFnQixpQkFBaUIsQUFBQyxDQUFDLFdBQVUsQ0FBQyxRQUFRLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztJQUNqRSxDQUFDLENBQUM7RUFDTixDQUFDLENBQUM7QUFDTixDQUFDLENBQUM7QUFDRiIsImZpbGUiOiJob3N0aW5nL2NvcmVIb3N0aW5nVGVzdHMuanMiLCJzb3VyY2VSb290IjoidGVzdHMvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qIGdsb2JhbCBkZXNjcmliZSxpdCAqL1xuXG5sZXQgd2Y0bm9kZSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9cIik7XG5sZXQgSW5zdGFuY2VJZFBhcnNlciA9IHdmNG5vZGUuaG9zdGluZy5JbnN0YW5jZUlkUGFyc2VyO1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IGhvc3RpbmdUZXN0Q29tbW9uID0gcmVxdWlyZShcIi4vaG9zdGluZ1Rlc3RDb21tb25cIik7XG5sZXQgTWVtb3J5UGVyc2lzdGVuY2UgPSB3ZjRub2RlLmhvc3RpbmcuTWVtb3J5UGVyc2lzdGVuY2U7XG5sZXQgU2VyaWFsaXplciA9IHJlcXVpcmUoXCJiYWNrcGFjay1ub2RlXCIpLnN5c3RlbS5TZXJpYWxpemVyO1xuXG5sZXQgYXNzZXJ0ID0gcmVxdWlyZShcImFzc2VydFwiKTtcblxuZGVzY3JpYmUoXCJJbnN0YW5jZUlkUGFyc2VyXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBkZXNjcmliZShcIiNwYXJzZSgpXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaXQoXCJzaG91bGQgdW5kZXJzdGFuZCBjb21tb24gcGF0aHNcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgbGV0IHAgPSBuZXcgSW5zdGFuY2VJZFBhcnNlcigpO1xuICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHAucGFyc2UoXCJ0aGlzXCIsIDEpLCAxKTtcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChwLnBhcnNlKFwiWzBdXCIsIFsxXSksIDEpO1xuICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHAucGFyc2UoXCJbMF1cIiwgWzQsIDVdKSwgNCk7XG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwocC5wYXJzZShcIlsxXS5pZFwiLCBbe2lkOiAxfSwge2lkOiAyfV0pLCAyKTtcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChwLnBhcnNlKFwiaWRbMF0uYVwiLCB7aWQ6IFt7YTogXCJmb29cIn1dfSksIFwiZm9vXCIpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuXG5kZXNjcmliZShcIldvcmtmbG93SG9zdFwiLCBmdW5jdGlvbiAoKSB7XG4gICAgZGVzY3JpYmUoXCJXaXRob3V0IHBlcnNpc3RlbmNlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaXQoXCJzaG91bGQgcnVuIGJhc2ljIGhvc3RpbmcgZXhhbXBsZVwiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgaG9zdGluZ1Rlc3RDb21tb24uZG9CYXNpY0hvc3RUZXN0KCkubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoXCJzaG91bGQgcnVuIGNvcnJlbGF0ZWQgY2FsY3VsYXRvciBleGFtcGxlXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBob3N0aW5nVGVzdENvbW1vbi5kb0NhbGN1bGF0b3JUZXN0KCkubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZShcIldpdGggTWVtb3J5UGVyc2lzdGVuY2VcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLnRpbWVvdXQoNTAwMCk7XG5cbiAgICAgICAgaXQoXCJzaG91bGQgcnVuIGJhc2ljIGhvc3RpbmcgZXhhbXBsZSBpbiBub24tbGF6eSBtb2RlXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgaG9zdE9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgcGVyc2lzdGVuY2U6IG5ldyBNZW1vcnlQZXJzaXN0ZW5jZSgpLFxuICAgICAgICAgICAgICAgIGxhenlQZXJzaXN0ZW5jZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgc2VyaWFsaXplcjogbnVsbCxcbiAgICAgICAgICAgICAgICBhbHdheXNMb2FkU3RhdGU6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBob3N0aW5nVGVzdENvbW1vbi5kb0Jhc2ljSG9zdFRlc3QoaG9zdE9wdGlvbnMpLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KFwic2hvdWxkIHJ1biBiYXNpYyBob3N0aW5nIGV4YW1wbGUgaW4gbGF6eSBtb2RlXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBsZXQgaG9zdE9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgcGVyc2lzdGVuY2U6IG5ldyBNZW1vcnlQZXJzaXN0ZW5jZSgpLFxuICAgICAgICAgICAgICAgIGxhenlQZXJzaXN0ZW5jZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzZXJpYWxpemVyOiBudWxsLFxuICAgICAgICAgICAgICAgIGFsd2F5c0xvYWRTdGF0ZTogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGhvc3RpbmdUZXN0Q29tbW9uLmRvQmFzaWNIb3N0VGVzdChob3N0T3B0aW9ucykubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoXCJzaG91bGQgcnVuIGNvcnJlbGF0ZWQgY2FsY3VsYXRvciBleGFtcGxlIGluIG5vbi1sYXp5IG1vZGVcIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGxldCBob3N0T3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBwZXJzaXN0ZW5jZTogbmV3IE1lbW9yeVBlcnNpc3RlbmNlKCksXG4gICAgICAgICAgICAgICAgbGF6eVBlcnNpc3RlbmNlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBzZXJpYWxpemVyOiBudWxsLFxuICAgICAgICAgICAgICAgIGFsd2F5c0xvYWRTdGF0ZTogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGhvc3RpbmdUZXN0Q29tbW9uLmRvQ2FsY3VsYXRvclRlc3QoaG9zdE9wdGlvbnMpLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KFwic2hvdWxkIHJ1biBjb3JyZWxhdGVkIGNhbGN1bGF0b3IgZXhhbXBsZSBpbiBsYXp5IG1vZGVcIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGxldCBob3N0T3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBwZXJzaXN0ZW5jZTogbmV3IE1lbW9yeVBlcnNpc3RlbmNlKCksXG4gICAgICAgICAgICAgICAgbGF6eVBlcnNpc3RlbmNlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHNlcmlhbGl6ZXI6IG51bGwsXG4gICAgICAgICAgICAgICAgYWx3YXlzTG9hZFN0YXRlOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgaG9zdGluZ1Rlc3RDb21tb24uZG9DYWxjdWxhdG9yVGVzdChob3N0T3B0aW9ucykubm9kZWlmeShkb25lKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoXCJzaG91bGQgcnVuIGNvcnJlbGF0ZWQgY2FsY3VsYXRvciBleGFtcGxlIGlmIHN0YXRlIGlzIHNlcmlhbGl6ZWRcIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGxldCBob3N0T3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBwZXJzaXN0ZW5jZTogbmV3IE1lbW9yeVBlcnNpc3RlbmNlKCksXG4gICAgICAgICAgICAgICAgbGF6eVBlcnNpc3RlbmNlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBzZXJpYWxpemVyOiBuZXcgU2VyaWFsaXplcigpLFxuICAgICAgICAgICAgICAgIGFsd2F5c0xvYWRTdGF0ZTogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGhvc3RpbmdUZXN0Q29tbW9uLmRvQ2FsY3VsYXRvclRlc3QoaG9zdE9wdGlvbnMpLm5vZGVpZnkoZG9uZSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG4iXX0=
