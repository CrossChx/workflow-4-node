"use strict";
var wf4node = require("../../../");
var InstanceIdParser = wf4node.hosting.InstanceIdParser;
var _ = require("lodash");
var hostingTestCommon = require("./hostingTestCommon");
var MemoryPersistence = wf4node.hosting.MemoryPersistence;
var Serializer = require("backpack-node").system.Serializer;
var WorkflowHost = wf4node.hosting.WorkflowHost;
var asyncHelpers = wf4node.common.asyncHelpers;
var Bluebird = require("bluebird");
var async = asyncHelpers.async;
var util = require("util");
var Activity = wf4node.activities.Activity;
var Block = wf4node.activities.Block;
var assert = require("better-assert");
describe("serializing", function() {
  var doTest = async($traceurRuntime.initGeneratorFunction(function $__8(hostOptions) {
    var now,
        rex,
        host,
        err,
        aDate,
        aMap,
        aSet,
        aResult,
        aRegExp,
        aProp,
        wf;
    return $traceurRuntime.createGeneratorInstance(function($ctx) {
      while (true)
        switch ($ctx.state) {
          case 0:
            now = new Date();
            rex = /abc/gi;
            host = new WorkflowHost(hostOptions);
            err = null;
            host.on("error", function(e) {
              err = e;
            });
            aDate = null;
            aMap = null;
            aSet = null;
            aResult = null;
            aRegExp = null;
            aProp = null;
            wf = {"@workflow": {
                name: "serializerWF",
                aDate: null,
                aMap: null,
                aSet: null,
                aResult: null,
                aRegExp: null,
                "`aCode": function() {
                  return "Hello!";
                },
                args: {"@block": {
                    p: "= this.$parent",
                    args: [function() {
                      assert(this.p.name === "serializerWF");
                    }, {"@method": {
                        methodName: "start",
                        canCreateInstance: true,
                        instanceIdPath: "[0]"
                      }}, {"@assign": {
                        to: "aDate",
                        value: now
                      }}, {"@assign": {
                        to: "aMap",
                        value: function() {
                          var map = new Map();
                          map.set(1, "1");
                          map.set(2, "2");
                          return map;
                        }
                      }}, {"@assign": {
                        to: "aSet",
                        value: function() {
                          var set = new Set();
                          set.add(1);
                          set.add(2);
                          return set;
                        }
                      }}, {"@assign": {
                        to: "aRegExp",
                        value: rex
                      }}, {"@method": {
                        methodName: "get",
                        canCreateInstance: true,
                        instanceIdPath: "[0]"
                      }}, {"@assign": {
                        to: "aResult",
                        value: {"@func": {code: "= this.aCode.code"}}
                      }}, function() {
                      aDate = this.aDate;
                      aMap = this.aMap;
                      aSet = this.aSet;
                      aResult = this.aResult;
                      aRegExp = this.aRegExp;
                      aProp = this.p.name;
                    }]
                  }}
              }};
            $ctx.state = 24;
            break;
          case 24:
            $ctx.pushTry(null, 16);
            $ctx.state = 18;
            break;
          case 18:
            host.registerWorkflow(wf);
            $ctx.state = 10;
            break;
          case 10:
            $ctx.state = 2;
            return host.invokeMethod("serializerWF", "start", "0");
          case 2:
            $ctx.maybeThrow();
            $ctx.state = 4;
            break;
          case 4:
            host.shutdown();
            host = new WorkflowHost(hostOptions);
            host.registerWorkflow(wf);
            host.on("error", function(e) {
              err = e;
            });
            $ctx.state = 12;
            break;
          case 12:
            $ctx.state = 6;
            return host.invokeMethod("serializerWF", "get", "0");
          case 6:
            $ctx.maybeThrow();
            $ctx.state = 8;
            break;
          case 8:
            assert(_.isDate(aDate));
            assert(aDate.getTime() === now.getTime());
            assert(aMap instanceof Map);
            assert(aMap.get(1) === "1");
            assert(aMap.get(2) === "2");
            assert(aMap.size === 2);
            assert(aSet instanceof Set);
            assert(aSet.has(1));
            assert(aSet.has(2));
            assert(aSet.size === 2);
            assert(aRegExp instanceof RegExp);
            assert(aRegExp.pattern === rex.pattern);
            assert(aRegExp.flags === rex.flags);
            assert(aResult === "Hello!");
            assert(aProp === "serializerWF");
            if (err) {
              throw err;
            }
            $ctx.state = 16;
            $ctx.finallyFallThrough = -2;
            break;
          case 16:
            $ctx.popTry();
            $ctx.state = 22;
            break;
          case 22:
            host.shutdown();
            $ctx.state = 20;
            break;
          case 20:
            $ctx.state = $ctx.finallyFallThrough;
            break;
          default:
            return $ctx.end();
        }
    }, $__8, this);
  }));
  it("should serialize Date, code, Map, Set, RegExp without a serializer", function(done) {
    doTest({
      persistence: new MemoryPersistence(),
      lazyPersistence: true,
      serializer: null,
      alwaysLoadState: false
    }).nodeify(done);
  });
  it("should serialize Date, code, Map, Set, RegExp with a serializer", function(done) {
    doTest({
      persistence: new MemoryPersistence(),
      lazyPersistence: true,
      serializer: new Serializer(),
      alwaysLoadState: false
    }).nodeify(done);
  });
});
//# sourceMappingURL=data:application/json;base64,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S1osZUFBRyxtQkFBbUIsS0FBb0IsQ0FBQTs7O0FBQTFDLGVBQUcsT0FBTyxBQUFDLEVBQUMsQ0FBQzs7OztBQXVLRCxlQUFHLFNBQVMsQUFBQyxFQUFDLENBQUM7Ozs7QUF0S0wsZUFBRyxNQUFNLEVBQUksQ0FBQSxJQUFHLG1CQUFtQixDQUFDO0FBQ3BDLGlCQUFLOztBQUYzQixpQkFBTyxDQUFBLElBQUcsSUFBSSxBQUFDLEVBQUMsQ0FBQTs7QUFDbUIsSUFDL0IsT0FBNkIsS0FBRyxDQUFDLENBQUM7RUF1S2xDLENBekttRCxDQXlLbEQsQ0FBQztBQUVGLEdBQUMsQUFBQyxDQUFDLG9FQUFtRSxDQUFHLFVBQVMsSUFBRyxDQUFHO0FBQ3BGLFNBQUssQUFBQyxDQUFDO0FBQ0gsZ0JBQVUsQ0FBRyxJQUFJLGtCQUFnQixBQUFDLEVBQUM7QUFDbkMsb0JBQWMsQ0FBRyxLQUFHO0FBQ3BCLGVBQVMsQ0FBRyxLQUFHO0FBQ2Ysb0JBQWMsQ0FBRyxNQUFJO0FBQUEsSUFDekIsQ0FBQyxRQUFRLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztFQUNwQixDQUFDLENBQUM7QUFFRixHQUFDLEFBQUMsQ0FBQyxpRUFBZ0UsQ0FBRyxVQUFTLElBQUcsQ0FBRztBQUNqRixTQUFLLEFBQUMsQ0FBQztBQUNILGdCQUFVLENBQUcsSUFBSSxrQkFBZ0IsQUFBQyxFQUFDO0FBQ25DLG9CQUFjLENBQUcsS0FBRztBQUNwQixlQUFTLENBQUcsSUFBSSxXQUFTLEFBQUMsRUFBQztBQUMzQixvQkFBYyxDQUFHLE1BQUk7QUFBQSxJQUN6QixDQUFDLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0VBQ3BCLENBQUMsQ0FBQztBQUNOLENBQUMsQ0FBQztBQUFBIiwiZmlsZSI6Imhvc3Rpbmcvc2VyaWFsaXppbmcuanMiLCJzb3VyY2VSb290IjoidGVzdHMvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4vKiBnbG9iYWwgZGVzY3JpYmUsaXQgKi9cclxuXHJcbmxldCB3ZjRub2RlID0gcmVxdWlyZShcIi4uLy4uLy4uL1wiKTtcclxubGV0IEluc3RhbmNlSWRQYXJzZXIgPSB3ZjRub2RlLmhvc3RpbmcuSW5zdGFuY2VJZFBhcnNlcjtcclxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG5sZXQgaG9zdGluZ1Rlc3RDb21tb24gPSByZXF1aXJlKFwiLi9ob3N0aW5nVGVzdENvbW1vblwiKTtcclxubGV0IE1lbW9yeVBlcnNpc3RlbmNlID0gd2Y0bm9kZS5ob3N0aW5nLk1lbW9yeVBlcnNpc3RlbmNlO1xyXG5sZXQgU2VyaWFsaXplciA9IHJlcXVpcmUoXCJiYWNrcGFjay1ub2RlXCIpLnN5c3RlbS5TZXJpYWxpemVyO1xyXG5sZXQgV29ya2Zsb3dIb3N0ID0gd2Y0bm9kZS5ob3N0aW5nLldvcmtmbG93SG9zdDtcclxubGV0IGFzeW5jSGVscGVycyA9IHdmNG5vZGUuY29tbW9uLmFzeW5jSGVscGVycztcclxubGV0IEJsdWViaXJkID0gcmVxdWlyZShcImJsdWViaXJkXCIpO1xyXG5sZXQgYXN5bmMgPSBhc3luY0hlbHBlcnMuYXN5bmM7XHJcbmxldCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XHJcbmxldCBBY3Rpdml0eSA9IHdmNG5vZGUuYWN0aXZpdGllcy5BY3Rpdml0eTtcclxubGV0IEJsb2NrID0gd2Y0bm9kZS5hY3Rpdml0aWVzLkJsb2NrO1xyXG5cclxubGV0IGFzc2VydCA9IHJlcXVpcmUoXCJiZXR0ZXItYXNzZXJ0XCIpO1xyXG5cclxuZGVzY3JpYmUoXCJzZXJpYWxpemluZ1wiLCBmdW5jdGlvbigpIHtcclxuICAgIGxldCBkb1Rlc3QgPSBhc3luYyhmdW5jdGlvbiogKGhvc3RPcHRpb25zKSB7XHJcbiAgICAgICAgbGV0IG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgbGV0IHJleCA9IC9hYmMvZ2k7XHJcbiAgICAgICAgbGV0IGhvc3QgPSBuZXcgV29ya2Zsb3dIb3N0KGhvc3RPcHRpb25zKTtcclxuICAgICAgICBsZXQgZXJyID0gbnVsbDtcclxuICAgICAgICBob3N0Lm9uKFwiZXJyb3JcIiwgZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICBlcnIgPSBlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsZXQgYURhdGUgPSBudWxsO1xyXG4gICAgICAgIGxldCBhTWFwID0gbnVsbDtcclxuICAgICAgICBsZXQgYVNldCA9IG51bGw7XHJcbiAgICAgICAgbGV0IGFSZXN1bHQgPSBudWxsO1xyXG4gICAgICAgIGxldCBhUmVnRXhwID0gbnVsbDtcclxuICAgICAgICBsZXQgYVByb3AgPSBudWxsO1xyXG5cclxuICAgICAgICBsZXQgd2YgPSB7XHJcbiAgICAgICAgICAgIFwiQHdvcmtmbG93XCI6IHtcclxuICAgICAgICAgICAgICAgIG5hbWU6IFwic2VyaWFsaXplcldGXCIsXHJcbiAgICAgICAgICAgICAgICBhRGF0ZTogbnVsbCxcclxuICAgICAgICAgICAgICAgIGFNYXA6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBhU2V0OiBudWxsLFxyXG4gICAgICAgICAgICAgICAgYVJlc3VsdDogbnVsbCxcclxuICAgICAgICAgICAgICAgIGFSZWdFeHA6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBcImBhQ29kZVwiOiBmdW5jdGlvbigpIHsgLy8gVE9ETzogaW4gdGhpcyBjYXNlIHRoYXQgc2hvdWxkIGJlIHRocmVhdGVkIGFzIGEgZnVuY3Rpb24gaW5zdGVhZCBvZiBhIEZ1bmNcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJIZWxsbyFcIjtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBhcmdzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgXCJAYmxvY2tcIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwOiBcIj0gdGhpcy4kcGFyZW50XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydCh0aGlzLnAubmFtZSA9PT0gXCJzZXJpYWxpemVyV0ZcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQG1ldGhvZFwiOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZE5hbWU6IFwic3RhcnRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuQ3JlYXRlSW5zdGFuY2U6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWRQYXRoOiBcIlswXVwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBhc3NpZ25cIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzogXCJhRGF0ZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbm93XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBhc3NpZ25cIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzogXCJhTWFwXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbWFwID0gbmV3IE1hcCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwLnNldCgxLCBcIjFcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAuc2V0KDIsIFwiMlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGFzc2lnblwiOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiBcImFTZXRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzZXQgPSBuZXcgU2V0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXQuYWRkKDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0LmFkZCgyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGFzc2lnblwiOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiBcImFSZWdFeHBcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHJleFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAbWV0aG9kXCI6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kTmFtZTogXCJnZXRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuQ3JlYXRlSW5zdGFuY2U6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWRQYXRoOiBcIlswXVwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBhc3NpZ25cIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzogXCJhUmVzdWx0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBmdW5jXCI6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBcIj0gdGhpcy5hQ29kZS5jb2RlXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYURhdGUgPSB0aGlzLmFEYXRlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFNYXAgPSB0aGlzLmFNYXA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYVNldCA9IHRoaXMuYVNldDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhUmVzdWx0ID0gdGhpcy5hUmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFSZWdFeHAgPSB0aGlzLmFSZWdFeHA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYVByb3AgPSB0aGlzLnAubmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGhvc3QucmVnaXN0ZXJXb3JrZmxvdyh3Zik7XHJcblxyXG4gICAgICAgICAgICB5aWVsZCBob3N0Lmludm9rZU1ldGhvZChcInNlcmlhbGl6ZXJXRlwiLCBcInN0YXJ0XCIsIFwiMFwiKTtcclxuICAgICAgICAgICAgaG9zdC5zaHV0ZG93bigpO1xyXG5cclxuICAgICAgICAgICAgaG9zdCA9IG5ldyBXb3JrZmxvd0hvc3QoaG9zdE9wdGlvbnMpO1xyXG4gICAgICAgICAgICBob3N0LnJlZ2lzdGVyV29ya2Zsb3cod2YpO1xyXG4gICAgICAgICAgICBob3N0Lm9uKFwiZXJyb3JcIiwgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgIGVyciA9IGU7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgeWllbGQgaG9zdC5pbnZva2VNZXRob2QoXCJzZXJpYWxpemVyV0ZcIiwgXCJnZXRcIiwgXCIwXCIpO1xyXG5cclxuICAgICAgICAgICAgYXNzZXJ0KF8uaXNEYXRlKGFEYXRlKSk7XHJcbiAgICAgICAgICAgIGFzc2VydChhRGF0ZS5nZXRUaW1lKCkgPT09IG5vdy5nZXRUaW1lKCkpO1xyXG5cclxuICAgICAgICAgICAgYXNzZXJ0KGFNYXAgaW5zdGFuY2VvZiBNYXApO1xyXG4gICAgICAgICAgICBhc3NlcnQoYU1hcC5nZXQoMSkgPT09IFwiMVwiKTtcclxuICAgICAgICAgICAgYXNzZXJ0KGFNYXAuZ2V0KDIpID09PSBcIjJcIik7XHJcbiAgICAgICAgICAgIGFzc2VydChhTWFwLnNpemUgPT09IDIpO1xyXG5cclxuICAgICAgICAgICAgYXNzZXJ0KGFTZXQgaW5zdGFuY2VvZiBTZXQpO1xyXG4gICAgICAgICAgICBhc3NlcnQoYVNldC5oYXMoMSkpO1xyXG4gICAgICAgICAgICBhc3NlcnQoYVNldC5oYXMoMikpO1xyXG4gICAgICAgICAgICBhc3NlcnQoYVNldC5zaXplID09PSAyKTtcclxuXHJcbiAgICAgICAgICAgIGFzc2VydChhUmVnRXhwIGluc3RhbmNlb2YgUmVnRXhwKTtcclxuICAgICAgICAgICAgYXNzZXJ0KGFSZWdFeHAucGF0dGVybiA9PT0gcmV4LnBhdHRlcm4pO1xyXG4gICAgICAgICAgICBhc3NlcnQoYVJlZ0V4cC5mbGFncyA9PT0gcmV4LmZsYWdzKTtcclxuXHJcbiAgICAgICAgICAgIGFzc2VydChhUmVzdWx0ID09PSBcIkhlbGxvIVwiKTtcclxuXHJcbiAgICAgICAgICAgIGFzc2VydChhUHJvcCA9PT0gXCJzZXJpYWxpemVyV0ZcIik7XHJcblxyXG4gICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZmluYWxseSB7XHJcbiAgICAgICAgICAgIGhvc3Quc2h1dGRvd24oKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcInNob3VsZCBzZXJpYWxpemUgRGF0ZSwgY29kZSwgTWFwLCBTZXQsIFJlZ0V4cCB3aXRob3V0IGEgc2VyaWFsaXplclwiLCBmdW5jdGlvbihkb25lKSB7XHJcbiAgICAgICAgZG9UZXN0KHtcclxuICAgICAgICAgICAgcGVyc2lzdGVuY2U6IG5ldyBNZW1vcnlQZXJzaXN0ZW5jZSgpLFxyXG4gICAgICAgICAgICBsYXp5UGVyc2lzdGVuY2U6IHRydWUsXHJcbiAgICAgICAgICAgIHNlcmlhbGl6ZXI6IG51bGwsXHJcbiAgICAgICAgICAgIGFsd2F5c0xvYWRTdGF0ZTogZmFsc2VcclxuICAgICAgICB9KS5ub2RlaWZ5KGRvbmUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJzaG91bGQgc2VyaWFsaXplIERhdGUsIGNvZGUsIE1hcCwgU2V0LCBSZWdFeHAgd2l0aCBhIHNlcmlhbGl6ZXJcIiwgZnVuY3Rpb24oZG9uZSkge1xyXG4gICAgICAgIGRvVGVzdCh7XHJcbiAgICAgICAgICAgIHBlcnNpc3RlbmNlOiBuZXcgTWVtb3J5UGVyc2lzdGVuY2UoKSxcclxuICAgICAgICAgICAgbGF6eVBlcnNpc3RlbmNlOiB0cnVlLFxyXG4gICAgICAgICAgICBzZXJpYWxpemVyOiBuZXcgU2VyaWFsaXplcigpLFxyXG4gICAgICAgICAgICBhbHdheXNMb2FkU3RhdGU6IGZhbHNlXHJcbiAgICAgICAgfSkubm9kZWlmeShkb25lKTtcclxuICAgIH0pO1xyXG59KTsiXX0=
