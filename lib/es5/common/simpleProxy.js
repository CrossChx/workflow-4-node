"use strict";
var _ = require("lodash");
var assert = require("better-assert");
function SimpleProxy(backend) {
  assert(_.isObject(backend));
  Object.defineProperty(this, "_backend", {
    enumerable: false,
    value: backend
  });
  Object.defineProperty(this, "_backendKeys", {
    enumerable: false,
    writable: false,
    value: []
  });
  this.update(SimpleProxy.updateMode.init);
}
SimpleProxy.updateMode = {
  twoWay: 0,
  oneWay: 1,
  init: 2
};
Object.defineProperties(SimpleProxy.prototype, {
  _skipKeys: {
    enumerable: false,
    writable: false,
    value: new Set(["getKeys", "getValue", "setValue"])
  },
  update: {
    enumerable: false,
    writable: false,
    value: function(mode) {
      var self = this;
      if (mode === SimpleProxy.updateMode.init) {
        var $__4 = true;
        var $__5 = false;
        var $__6 = undefined;
        try {
          var $__29 = this,
              $__30 = function() {
                var newKey = $__2.value;
                {
                  if (_.isUndefined($__29[newKey])) {
                    $__29._backendKeys.push(newKey);
                    Object.defineProperty(self, newKey, {
                      enumerable: true,
                      configurable: true,
                      get: function() {
                        return self._backend.getValue(self, newKey);
                      },
                      set: function(value) {
                        self._backend.setValue(self, newKey, value);
                      }
                    });
                  }
                }
              };
          for (var $__2 = void 0,
              $__1 = (this._backend.getKeys(this))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__4 = ($__2 = $__1.next()).done); $__4 = true) {
            $__30();
          }
        } catch ($__7) {
          $__5 = true;
          $__6 = $__7;
        } finally {
          try {
            if (!$__4 && $__1.return != null) {
              $__1.return();
            }
          } finally {
            if ($__5) {
              throw $__6;
            }
          }
        }
      } else if (mode === SimpleProxy.updateMode.oneWay) {
        var currBackendKeys = new Set(this._backend.getKeys(this));
        var $__31 = this,
            $__32 = function(key) {
              if (!currBackendKeys.has(key)) {
                $__31._backend.setValue(self, key, $__31[key]);
                Object.defineProperty(self, key, {
                  enumerable: true,
                  configurable: true,
                  get: function() {
                    return self._backend.getValue(self, key);
                  },
                  set: function(value) {
                    self._backend.setValue(self, key, value);
                  }
                });
                $__31._backendKeys.push(key);
              } else {
                currBackendKeys.delete(key);
              }
            };
        for (var key in this) {
          $__32(key);
        }
        var $__11 = true;
        var $__12 = false;
        var $__13 = undefined;
        try {
          for (var $__9 = void 0,
              $__8 = (currBackendKeys)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__11 = ($__9 = $__8.next()).done); $__11 = true) {
            var oldKey = $__9.value;
            {
              delete this[oldKey];
            }
          }
        } catch ($__14) {
          $__12 = true;
          $__13 = $__14;
        } finally {
          try {
            if (!$__11 && $__8.return != null) {
              $__8.return();
            }
          } finally {
            if ($__12) {
              throw $__13;
            }
          }
        }
      } else {
        var prevBackendKeys = new Set(this._backendKeys);
        var currBackendKeys$__33 = new Set(this._backend.getKeys(this));
        var backedKeys = new Set();
        var $__35 = this,
            $__36 = function(key) {
              if (!prevBackendKeys.has(key) && !currBackendKeys$__33.has(key)) {
                $__35._backend.setValue(self, key, $__35[key]);
                Object.defineProperty(self, key, {
                  enumerable: true,
                  configurable: true,
                  get: function() {
                    return self._backend.getValue(self, key);
                  },
                  set: function(value) {
                    self._backend.setValue(self, key, value);
                  }
                });
                backedKeys.add(key);
              }
            };
        for (var key$__34 in this) {
          $__36(key$__34);
        }
        this._backendKeys.length = 0;
        var $__18 = true;
        var $__19 = false;
        var $__20 = undefined;
        try {
          var $__37 = this,
              $__38 = function() {
                var newKey = $__16.value;
                {
                  if (!$__37._skipKeys.has(newKey)) {
                    $__37._backendKeys.push(newKey);
                    if (!prevBackendKeys.has(newKey) && !backedKeys.has(newKey)) {
                      Object.defineProperty(self, newKey, {
                        enumerable: true,
                        configurable: true,
                        get: function() {
                          return self._backend.getValue(self, newKey);
                        },
                        set: function(value) {
                          self._backend.setValue(self, newKey, value);
                        }
                      });
                    } else {
                      prevBackendKeys.delete(newKey);
                    }
                  }
                }
              };
          for (var $__16 = void 0,
              $__15 = (currBackendKeys$__33)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__18 = ($__16 = $__15.next()).done); $__18 = true) {
            $__38();
          }
        } catch ($__21) {
          $__19 = true;
          $__20 = $__21;
        } finally {
          try {
            if (!$__18 && $__15.return != null) {
              $__15.return();
            }
          } finally {
            if ($__19) {
              throw $__20;
            }
          }
        }
        var $__25 = true;
        var $__26 = false;
        var $__27 = undefined;
        try {
          for (var $__23 = void 0,
              $__22 = (prevBackendKeys)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__25 = ($__23 = $__22.next()).done); $__25 = true) {
            var oldKey$__39 = $__23.value;
            {
              delete this[oldKey$__39];
            }
          }
        } catch ($__28) {
          $__26 = true;
          $__27 = $__28;
        } finally {
          try {
            if (!$__25 && $__22.return != null) {
              $__22.return();
            }
          } finally {
            if ($__26) {
              throw $__27;
            }
          }
        }
      }
    }
  },
  delete: {
    enumerable: false,
    writable: false,
    value: function(key) {
      delete this[key];
      this._backend.delete(this, key);
    }
  }
});
module.exports = SimpleProxy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNpbXBsZVByb3h5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0EsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsTUFBSyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsZUFBYyxDQUFDLENBQUM7QUFFckMsT0FBUyxZQUFVLENBQUUsT0FBTSxDQUFHO0FBQzFCLE9BQUssQUFBQyxDQUFDLENBQUEsU0FBUyxBQUFDLENBQUMsT0FBTSxDQUFDLENBQUMsQ0FBQztBQUUzQixPQUFLLGVBQWUsQUFBQyxDQUFDLElBQUcsQ0FBRyxXQUFTLENBQUc7QUFDcEMsYUFBUyxDQUFHLE1BQUk7QUFDaEIsUUFBSSxDQUFHLFFBQU07QUFBQSxFQUNqQixDQUFDLENBQUM7QUFDRixPQUFLLGVBQWUsQUFBQyxDQUFDLElBQUcsQ0FBRyxlQUFhLENBQUc7QUFDeEMsYUFBUyxDQUFHLE1BQUk7QUFDaEIsV0FBTyxDQUFHLE1BQUk7QUFDZCxRQUFJLENBQUcsR0FBQztBQUFBLEVBQ1osQ0FBQyxDQUFDO0FBQ0YsS0FBRyxPQUFPLEFBQUMsQ0FBQyxXQUFVLFdBQVcsS0FBSyxDQUFDLENBQUM7QUFDNUM7QUFBQSxBQUVBLFVBQVUsV0FBVyxFQUFJO0FBQ3JCLE9BQUssQ0FBRyxFQUFBO0FBQ1IsT0FBSyxDQUFHLEVBQUE7QUFDUixLQUFHLENBQUcsRUFBQTtBQUFBLEFBQ1YsQ0FBQztBQUVELEtBQUssaUJBQWlCLEFBQUMsQ0FBQyxXQUFVLFVBQVUsQ0FBRztBQUMzQyxVQUFRLENBQUc7QUFDUCxhQUFTLENBQUcsTUFBSTtBQUNoQixXQUFPLENBQUcsTUFBSTtBQUNkLFFBQUksQ0FBRyxJQUFJLElBQUUsQUFBQyxDQUFDLENBQUMsU0FBUSxDQUFHLFdBQVMsQ0FBRyxXQUFTLENBQUMsQ0FBQztBQUFBLEVBQ3REO0FBQ0EsT0FBSyxDQUFHO0FBQ0osYUFBUyxDQUFHLE1BQUk7QUFDaEIsV0FBTyxDQUFHLE1BQUk7QUFDZCxRQUFJLENBQUcsVUFBUyxJQUFHO0FBQ2YsQUFBSSxRQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUNmLFNBQUksSUFBRyxJQUFNLENBQUEsV0FBVSxXQUFXLEtBQUssQ0FBRztBQW5DOUMsQUFBSSxVQUFBLE9BQW9CLEtBQUcsQ0FBQztBQUM1QixBQUFJLFVBQUEsT0FBb0IsTUFBSSxDQUFDO0FBQzdCLEFBQUksVUFBQSxPQUFvQixVQUFRLENBQUM7QUFDakMsVUFBSTs7O2tCQWlDYSxPQUFLO0FBQWtDO0FBQzVDLHFCQUFJLENBQUEsWUFBWSxBQUFDLENBQUMsTUFBSyxNQUFLLENBQUMsQ0FBQyxDQUFHO0FBQzdCLHFDQUFnQixLQUFLLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQztBQUM5Qix5QkFBSyxlQUFlLEFBQUMsQ0FDakIsSUFBRyxDQUNILE9BQUssQ0FDTDtBQUNJLCtCQUFTLENBQUcsS0FBRztBQUNmLGlDQUFXLENBQUcsS0FBRztBQUNqQix3QkFBRSxDQUFHLFVBQVUsQUFBRCxDQUFHO0FBQ2IsNkJBQU8sQ0FBQSxJQUFHLFNBQVMsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFHLE9BQUssQ0FBQyxDQUFDO3NCQUMvQztBQUNBLHdCQUFFLENBQUcsVUFBVSxLQUFJLENBQUc7QUFDbEIsMkJBQUcsU0FBUyxTQUFTLEFBQUMsQ0FBQyxJQUFHLENBQUcsT0FBSyxDQUFHLE1BQUksQ0FBQyxDQUFDO3NCQUMvQztBQUFBLG9CQUNKLENBQ0osQ0FBQztrQkFDTDtBQUFBLGdCQUNKOztBQXREUixjQUFTLEdBQUEsT0FEakIsS0FBSyxFQUFBLEFBQzRCO0FBQ2hCLG1CQUFvQixDQUFBLENBbUNGLElBQUcsU0FBUyxRQUFRLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FuQ04sQ0FDbEMsZUFBYyxXQUFXLEFBQUMsQ0FBQyxNQUFLLFNBQVMsQ0FBQyxDQUFDLEFBQUMsRUFBQyxDQUNyRCxFQUFDLENBQUMsTUFBb0IsQ0FBQSxDQUFDLE1BQW9CLENBQUEsU0FBcUIsQUFBQyxFQUFDLENBQUMsS0FBSyxDQUFDLENBQ3pFLE9BQW9CLEtBQUc7O1VBRzVCO1FBRkEsQ0FBRSxZQUEwQjtBQUMxQixlQUFvQixLQUFHLENBQUM7QUFDeEIsb0JBQW9DLENBQUM7UUFDdkMsQ0FBRSxPQUFRO0FBQ1IsWUFBSTtBQUNGLGVBQUksS0FBaUIsR0FBSyxDQUFBLFdBQXVCLEdBQUssS0FBRyxDQUFHO0FBQzFELHdCQUF3QixBQUFDLEVBQUMsQ0FBQztZQUM3QjtBQUFBLFVBQ0YsQ0FBRSxPQUFRO0FBQ1Isb0JBQXdCO0FBQ3RCLHdCQUF3QjtZQUMxQjtBQUFBLFVBQ0Y7QUFBQSxRQUNGO0FBQUEsTUFxQ0ksS0FDSyxLQUFJLElBQUcsSUFBTSxDQUFBLFdBQVUsV0FBVyxPQUFPLENBQUc7QUFDN0MsQUFBSSxVQUFBLENBQUEsZUFBYyxFQUFJLElBQUksSUFBRSxBQUFDLENBQUMsSUFBRyxTQUFTLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDLENBQUM7OztBQUV0RCxpQkFBSSxDQUFDLGVBQWMsSUFBSSxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUc7QUFFM0IsNkJBQVksU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFHLElBQUUsQ0FBRyxPQUFLLEdBQUUsQ0FBQyxDQUFDLENBQUM7QUFDNUMscUJBQUssZUFBZSxBQUFDLENBQ2pCLElBQUcsQ0FDSCxJQUFFLENBQ0Y7QUFDSSwyQkFBUyxDQUFHLEtBQUc7QUFDZiw2QkFBVyxDQUFHLEtBQUc7QUFDakIsb0JBQUUsQ0FBRyxVQUFVLEFBQUQsQ0FBRztBQUNiLHlCQUFPLENBQUEsSUFBRyxTQUFTLFNBQVMsQUFBQyxDQUFDLElBQUcsQ0FBRyxJQUFFLENBQUMsQ0FBQztrQkFDNUM7QUFDQSxvQkFBRSxDQUFHLFVBQVUsS0FBSSxDQUFHO0FBQ2xCLHVCQUFHLFNBQVMsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFHLElBQUUsQ0FBRyxNQUFJLENBQUMsQ0FBQztrQkFDNUM7QUFBQSxnQkFDSixDQUNKLENBQUM7QUFDRCxpQ0FBZ0IsS0FBSyxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUM7Y0FDL0IsS0FDSztBQUNELDhCQUFjLE9BQU8sQUFBQyxDQUFDLEdBQUUsQ0FBQyxDQUFDO2NBQy9CO0FBQUE7QUF0Qkosc0JBQWdCLEtBQUc7O1FBdUJuQjtBQWpGUixBQUFJLFVBQUEsUUFBb0IsS0FBRyxDQUFDO0FBQzVCLEFBQUksVUFBQSxRQUFvQixNQUFJLENBQUM7QUFDN0IsQUFBSSxVQUFBLFFBQW9CLFVBQVEsQ0FBQztBQUNqQyxVQUFJO0FBSEosY0FBUyxHQUFBLE9BRGpCLEtBQUssRUFBQSxBQUM0QjtBQUNoQixtQkFBb0IsQ0FBQSxDQWlGRixlQUFjLENBakZNLENBQ2xDLGVBQWMsV0FBVyxBQUFDLENBQUMsTUFBSyxTQUFTLENBQUMsQ0FBQyxBQUFDLEVBQUMsQ0FDckQsRUFBQyxDQUFDLE9BQW9CLENBQUEsQ0FBQyxNQUFvQixDQUFBLFNBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RSxRQUFvQixLQUFHLENBQUc7Y0E4RWQsT0FBSztBQUFzQjtBQUNoQyxtQkFBTyxLQUFHLENBQUUsTUFBSyxDQUFDLENBQUM7WUFDdkI7VUE3RVI7QUFBQSxRQUZBLENBQUUsYUFBMEI7QUFDMUIsZ0JBQW9CLEtBQUcsQ0FBQztBQUN4QixzQkFBb0MsQ0FBQztRQUN2QyxDQUFFLE9BQVE7QUFDUixZQUFJO0FBQ0YsZUFBSSxNQUFpQixHQUFLLENBQUEsV0FBdUIsR0FBSyxLQUFHLENBQUc7QUFDMUQsd0JBQXdCLEFBQUMsRUFBQyxDQUFDO1lBQzdCO0FBQUEsVUFDRixDQUFFLE9BQVE7QUFDUixxQkFBd0I7QUFDdEIseUJBQXdCO1lBQzFCO0FBQUEsVUFDRjtBQUFBLFFBQ0Y7QUFBQSxNQW1FSSxLQUNLO0FBQ0QsQUFBSSxVQUFBLENBQUEsZUFBYyxFQUFJLElBQUksSUFBRSxBQUFDLENBQUMsSUFBRyxhQUFhLENBQUMsQ0FBQztBQUNoRCxBQUFJLFVBQUEsQ0FBQSxvQkFBYyxFQUFJLElBQUksSUFBRSxBQUFDLENBQUMsSUFBRyxTQUFTLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDLENBQUM7QUFDMUQsQUFBSSxVQUFBLENBQUEsVUFBUyxFQUFJLElBQUksSUFBRSxBQUFDLEVBQUMsQ0FBQzs7O0FBR3RCLGlCQUFJLENBQUMsZUFBYyxJQUFJLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0FBQSxFQUFLLEVBQUMsd0JBQWtCLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0FBRztBQUV4RCw2QkFBWSxTQUFTLEFBQUMsQ0FBQyxJQUFHLENBQUcsSUFBRSxDQUFHLE9BQUssR0FBRSxDQUFDLENBQUMsQ0FBQztBQUM1QyxxQkFBSyxlQUFlLEFBQUMsQ0FDakIsSUFBRyxDQUNILElBQUUsQ0FDRjtBQUNJLDJCQUFTLENBQUcsS0FBRztBQUNmLDZCQUFXLENBQUcsS0FBRztBQUNqQixvQkFBRSxDQUFHLFVBQVUsQUFBRCxDQUFHO0FBQ2IseUJBQU8sQ0FBQSxJQUFHLFNBQVMsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFHLElBQUUsQ0FBQyxDQUFDO2tCQUM1QztBQUNBLG9CQUFFLENBQUcsVUFBVSxLQUFJLENBQUc7QUFDbEIsdUJBQUcsU0FBUyxTQUFTLEFBQUMsQ0FBQyxJQUFHLENBQUcsSUFBRSxDQUFHLE1BQUksQ0FBQyxDQUFDO2tCQUM1QztBQUFBLGdCQUNKLENBQ0osQ0FBQztBQUNELHlCQUFTLElBQUksQUFBQyxDQUFDLEdBQUUsQ0FBQyxDQUFDO2NBQ3ZCO0FBQUE7QUFuQkosMkJBQWdCLEtBQUc7O1FBb0JuQjtBQUVBLFdBQUcsYUFBYSxPQUFPLEVBQUksRUFBQSxDQUFDO0FBakhwQyxBQUFJLFVBQUEsUUFBb0IsS0FBRyxDQUFDO0FBQzVCLEFBQUksVUFBQSxRQUFvQixNQUFJLENBQUM7QUFDN0IsQUFBSSxVQUFBLFFBQW9CLFVBQVEsQ0FBQztBQUNqQyxVQUFJOzs7a0JBK0dhLE9BQUs7QUFBc0I7QUFDaEMscUJBQUksQ0FBQyxlQUFhLElBQUksQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFHO0FBQzdCLHFDQUFnQixLQUFLLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQztBQUM5Qix1QkFBSSxDQUFDLGVBQWMsSUFBSSxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUEsRUFBSyxFQUFDLFVBQVMsSUFBSSxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUc7QUFDekQsMkJBQUssZUFBZSxBQUFDLENBQ2pCLElBQUcsQ0FDSCxPQUFLLENBQ0w7QUFDSSxpQ0FBUyxDQUFHLEtBQUc7QUFDZixtQ0FBVyxDQUFHLEtBQUc7QUFDakIsMEJBQUUsQ0FBRyxVQUFVLEFBQUQsQ0FBRztBQUNiLCtCQUFPLENBQUEsSUFBRyxTQUFTLFNBQVMsQUFBQyxDQUFDLElBQUcsQ0FBRyxPQUFLLENBQUMsQ0FBQzt3QkFDL0M7QUFDQSwwQkFBRSxDQUFHLFVBQVUsS0FBSSxDQUFHO0FBQ2xCLDZCQUFHLFNBQVMsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFHLE9BQUssQ0FBRyxNQUFJLENBQUMsQ0FBQzt3QkFDL0M7QUFBQSxzQkFDSixDQUNKLENBQUM7b0JBQ0wsS0FDSztBQUNELG9DQUFjLE9BQU8sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO29CQUNsQztBQUFBLGtCQUNKO0FBQUEsZ0JBQ0o7O0FBeklSLGNBQVMsR0FBQSxRQURqQixLQUFLLEVBQUEsQUFDNEI7QUFDaEIsb0JBQW9CLENBQUEsc0JBQWtCLENBQ2xDLGVBQWMsV0FBVyxBQUFDLENBQUMsTUFBSyxTQUFTLENBQUMsQ0FBQyxBQUFDLEVBQUMsQ0FDckQsRUFBQyxDQUFDLE9BQW9CLENBQUEsQ0FBQyxPQUFvQixDQUFBLFVBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RSxRQUFvQixLQUFHOztVQUc1QjtRQUZBLENBQUUsYUFBMEI7QUFDMUIsZ0JBQW9CLEtBQUcsQ0FBQztBQUN4QixzQkFBb0MsQ0FBQztRQUN2QyxDQUFFLE9BQVE7QUFDUixZQUFJO0FBQ0YsZUFBSSxNQUFpQixHQUFLLENBQUEsWUFBdUIsR0FBSyxLQUFHLENBQUc7QUFDMUQseUJBQXdCLEFBQUMsRUFBQyxDQUFDO1lBQzdCO0FBQUEsVUFDRixDQUFFLE9BQVE7QUFDUixxQkFBd0I7QUFDdEIseUJBQXdCO1lBQzFCO0FBQUEsVUFDRjtBQUFBLFFBQ0Y7QUFBQSxBQWxCSSxVQUFBLFFBQW9CLEtBQUcsQ0FBQztBQUM1QixBQUFJLFVBQUEsUUFBb0IsTUFBSSxDQUFDO0FBQzdCLEFBQUksVUFBQSxRQUFvQixVQUFRLENBQUM7QUFDakMsVUFBSTtBQUhKLGNBQVMsR0FBQSxRQURqQixLQUFLLEVBQUEsQUFDNEI7QUFDaEIsb0JBQW9CLENBQUEsQ0F5SUYsZUFBYyxDQXpJTSxDQUNsQyxlQUFjLFdBQVcsQUFBQyxDQUFDLE1BQUssU0FBUyxDQUFDLENBQUMsQUFBQyxFQUFDLENBQ3JELEVBQUMsQ0FBQyxPQUFvQixDQUFBLENBQUMsT0FBb0IsQ0FBQSxVQUFxQixBQUFDLEVBQUMsQ0FBQyxLQUFLLENBQUMsQ0FDekUsUUFBb0IsS0FBRyxDQUFHO2NBc0lkLFlBQUs7QUFBc0I7QUFDaEMsbUJBQU8sS0FBRyxhQUFRLENBQUM7WUFDdkI7VUFySVI7QUFBQSxRQUZBLENBQUUsYUFBMEI7QUFDMUIsZ0JBQW9CLEtBQUcsQ0FBQztBQUN4QixzQkFBb0MsQ0FBQztRQUN2QyxDQUFFLE9BQVE7QUFDUixZQUFJO0FBQ0YsZUFBSSxNQUFpQixHQUFLLENBQUEsWUFBdUIsR0FBSyxLQUFHLENBQUc7QUFDMUQseUJBQXdCLEFBQUMsRUFBQyxDQUFDO1lBQzdCO0FBQUEsVUFDRixDQUFFLE9BQVE7QUFDUixxQkFBd0I7QUFDdEIseUJBQXdCO1lBQzFCO0FBQUEsVUFDRjtBQUFBLFFBQ0Y7QUFBQSxNQTJISTtBQUFBLElBQ0o7QUFBQSxFQUNKO0FBQ0EsT0FBSyxDQUFHO0FBQ0osYUFBUyxDQUFHLE1BQUk7QUFDaEIsV0FBTyxDQUFHLE1BQUk7QUFDZCxRQUFJLENBQUcsVUFBUyxHQUFFLENBQUc7QUFDakIsV0FBTyxLQUFHLENBQUUsR0FBRSxDQUFDLENBQUM7QUFDaEIsU0FBRyxTQUFTLE9BQU8sQUFBQyxDQUFDLElBQUcsQ0FBRyxJQUFFLENBQUMsQ0FBQztJQUNuQztBQUFBLEVBQ0o7QUFBQSxBQUNKLENBQUMsQ0FBQztBQUVGLEtBQUssUUFBUSxFQUFJLFlBQVUsQ0FBQztBQUFBIiwiZmlsZSI6ImNvbW1vbi9zaW1wbGVQcm94eS5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgYXNzZXJ0ID0gcmVxdWlyZShcImJldHRlci1hc3NlcnRcIik7XG5cbmZ1bmN0aW9uIFNpbXBsZVByb3h5KGJhY2tlbmQpIHtcbiAgICBhc3NlcnQoXy5pc09iamVjdChiYWNrZW5kKSk7XG5cbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgXCJfYmFja2VuZFwiLCB7XG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICB2YWx1ZTogYmFja2VuZFxuICAgIH0pO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBcIl9iYWNrZW5kS2V5c1wiLCB7XG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgIHZhbHVlOiBbXVxuICAgIH0pO1xuICAgIHRoaXMudXBkYXRlKFNpbXBsZVByb3h5LnVwZGF0ZU1vZGUuaW5pdCk7XG59XG5cblNpbXBsZVByb3h5LnVwZGF0ZU1vZGUgPSB7XG4gICAgdHdvV2F5OiAwLFxuICAgIG9uZVdheTogMSxcbiAgICBpbml0OiAyXG59O1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydGllcyhTaW1wbGVQcm94eS5wcm90b3R5cGUsIHtcbiAgICBfc2tpcEtleXM6IHtcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgIHdyaXRhYmxlOiBmYWxzZSxcbiAgICAgICAgdmFsdWU6IG5ldyBTZXQoW1wiZ2V0S2V5c1wiLCBcImdldFZhbHVlXCIsIFwic2V0VmFsdWVcIl0pXG4gICAgfSxcbiAgICB1cGRhdGU6IHtcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgIHdyaXRhYmxlOiBmYWxzZSxcbiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKG1vZGUpIHtcbiAgICAgICAgICAgIGxldCBzZWxmID0gdGhpcztcbiAgICAgICAgICAgIGlmIChtb2RlID09PSBTaW1wbGVQcm94eS51cGRhdGVNb2RlLmluaXQpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBuZXdLZXkgb2YgdGhpcy5fYmFja2VuZC5nZXRLZXlzKHRoaXMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKHRoaXNbbmV3S2V5XSkpIHsgLy8gVGhpcyBtYWtlcyB0aGUgbGlzdCBhcyB1bmlxdWVcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JhY2tlbmRLZXlzLnB1c2gobmV3S2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0tleSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5fYmFja2VuZC5nZXRWYWx1ZShzZWxmLCBuZXdLZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fYmFja2VuZC5zZXRWYWx1ZShzZWxmLCBuZXdLZXksIHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChtb2RlID09PSBTaW1wbGVQcm94eS51cGRhdGVNb2RlLm9uZVdheSkge1xuICAgICAgICAgICAgICAgIGxldCBjdXJyQmFja2VuZEtleXMgPSBuZXcgU2V0KHRoaXMuX2JhY2tlbmQuZ2V0S2V5cyh0aGlzKSk7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjdXJyQmFja2VuZEtleXMuaGFzKGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5ldyBrZXkgb24gcHJveHksIGFuZCBub3QgZGVmaW5lZCBvbiBiYWNrZW5kOlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmFja2VuZC5zZXRWYWx1ZShzZWxmLCBrZXksIHRoaXNba2V5XSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2JhY2tlbmQuZ2V0VmFsdWUoc2VsZiwga2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2JhY2tlbmQuc2V0VmFsdWUoc2VsZiwga2V5LCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmFja2VuZEtleXMucHVzaChrZXkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VyckJhY2tlbmRLZXlzLmRlbGV0ZShrZXkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAobGV0IG9sZEtleSBvZiBjdXJyQmFja2VuZEtleXMpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbb2xkS2V5XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgcHJldkJhY2tlbmRLZXlzID0gbmV3IFNldCh0aGlzLl9iYWNrZW5kS2V5cyk7XG4gICAgICAgICAgICAgICAgbGV0IGN1cnJCYWNrZW5kS2V5cyA9IG5ldyBTZXQodGhpcy5fYmFja2VuZC5nZXRLZXlzKHRoaXMpKTtcbiAgICAgICAgICAgICAgICBsZXQgYmFja2VkS2V5cyA9IG5ldyBTZXQoKTtcblxuICAgICAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiB0aGlzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcHJldkJhY2tlbmRLZXlzLmhhcyhrZXkpICYmICFjdXJyQmFja2VuZEtleXMuaGFzKGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5ldyBrZXkgb24gcHJveHksIGFuZCBub3QgZGVmaW5lZCBvbiBiYWNrZW5kOlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmFja2VuZC5zZXRWYWx1ZShzZWxmLCBrZXksIHRoaXNba2V5XSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2JhY2tlbmQuZ2V0VmFsdWUoc2VsZiwga2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2JhY2tlbmQuc2V0VmFsdWUoc2VsZiwga2V5LCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgYmFja2VkS2V5cy5hZGQoa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMuX2JhY2tlbmRLZXlzLmxlbmd0aCA9IDA7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgbmV3S2V5IG9mIGN1cnJCYWNrZW5kS2V5cykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3NraXBLZXlzLmhhcyhuZXdLZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9iYWNrZW5kS2V5cy5wdXNoKG5ld0tleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXByZXZCYWNrZW5kS2V5cy5oYXMobmV3S2V5KSAmJiAhYmFja2VkS2V5cy5oYXMobmV3S2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3S2V5LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2JhY2tlbmQuZ2V0VmFsdWUoc2VsZiwgbmV3S2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2JhY2tlbmQuc2V0VmFsdWUoc2VsZiwgbmV3S2V5LCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldkJhY2tlbmRLZXlzLmRlbGV0ZShuZXdLZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAobGV0IG9sZEtleSBvZiBwcmV2QmFja2VuZEtleXMpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbb2xkS2V5XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9LFxuICAgIGRlbGV0ZToge1xuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgd3JpdGFibGU6IGZhbHNlLFxuICAgICAgICB2YWx1ZTogZnVuY3Rpb24oa2V5KSB7XG4gICAgICAgICAgICBkZWxldGUgdGhpc1trZXldO1xuICAgICAgICAgICAgdGhpcy5fYmFja2VuZC5kZWxldGUodGhpcywga2V5KTtcbiAgICAgICAgfVxuICAgIH1cbn0pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IFNpbXBsZVByb3h5OyJdfQ==
