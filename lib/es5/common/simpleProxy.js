"use strict";
var _ = require("lodash");
var assert = require("better-assert");
function SimpleProxy(backend) {
  assert(_.isObject(backend));
  var self = this;
  Object.defineProperty(this, "_backend", {
    enumerable: false,
    value: backend
  });
  Object.defineProperty(this, "_backendKeys", {
    enumerable: false,
    writable: false,
    value: []
  });
  Object.defineProperty(this, "$keys", {
    enumerable: false,
    get: function() {
      return backend.getKeys(self);
    }
  });
  this.update(SimpleProxy.updateMode.init);
}
SimpleProxy.updateMode = {
  twoWay: 0,
  oneWay: 1,
  init: 2
};
Object.defineProperties(SimpleProxy.prototype, {
  _skipKeys: {
    enumerable: false,
    writable: false,
    value: new Set(["getKeys", "getValue", "setValue"])
  },
  update: {
    enumerable: false,
    writable: false,
    value: function(mode) {
      var self = this;
      if (mode === SimpleProxy.updateMode.init) {
        var $__4 = true;
        var $__5 = false;
        var $__6 = undefined;
        try {
          var $__29 = this,
              $__30 = function() {
                var newKey = $__2.value;
                {
                  if (_.isUndefined($__29[newKey])) {
                    $__29._backendKeys.push(newKey);
                    Object.defineProperty(self, newKey, {
                      enumerable: true,
                      configurable: true,
                      get: function() {
                        return self._backend.getValue(self, newKey);
                      },
                      set: function(value) {
                        self._backend.setValue(self, newKey, value);
                      }
                    });
                  }
                }
              };
          for (var $__2 = void 0,
              $__1 = (this._backend.getKeys(this))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__4 = ($__2 = $__1.next()).done); $__4 = true) {
            $__30();
          }
        } catch ($__7) {
          $__5 = true;
          $__6 = $__7;
        } finally {
          try {
            if (!$__4 && $__1.return != null) {
              $__1.return();
            }
          } finally {
            if ($__5) {
              throw $__6;
            }
          }
        }
      } else if (mode === SimpleProxy.updateMode.oneWay) {
        var currBackendKeys = new Set(this._backend.getKeys(this));
        var $__31 = this,
            $__32 = function(key) {
              if (!currBackendKeys.has(key)) {
                $__31._backend.setValue(self, key, $__31[key]);
                Object.defineProperty(self, key, {
                  enumerable: true,
                  configurable: true,
                  get: function() {
                    return self._backend.getValue(self, key);
                  },
                  set: function(value) {
                    self._backend.setValue(self, key, value);
                  }
                });
                $__31._backendKeys.push(key);
              } else {
                currBackendKeys.delete(key);
              }
            };
        for (var key in this) {
          $__32(key);
        }
        var $__11 = true;
        var $__12 = false;
        var $__13 = undefined;
        try {
          for (var $__9 = void 0,
              $__8 = (currBackendKeys)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__11 = ($__9 = $__8.next()).done); $__11 = true) {
            var oldKey = $__9.value;
            {
              delete this[oldKey];
            }
          }
        } catch ($__14) {
          $__12 = true;
          $__13 = $__14;
        } finally {
          try {
            if (!$__11 && $__8.return != null) {
              $__8.return();
            }
          } finally {
            if ($__12) {
              throw $__13;
            }
          }
        }
      } else {
        var prevBackendKeys = new Set(this._backendKeys);
        var currBackendKeys$__33 = new Set(this._backend.getKeys(this));
        var backedKeys = new Set();
        var $__35 = this,
            $__36 = function(key) {
              if (!prevBackendKeys.has(key) && !currBackendKeys$__33.has(key)) {
                $__35._backend.setValue(self, key, $__35[key]);
                Object.defineProperty(self, key, {
                  enumerable: true,
                  configurable: true,
                  get: function() {
                    return self._backend.getValue(self, key);
                  },
                  set: function(value) {
                    self._backend.setValue(self, key, value);
                  }
                });
                backedKeys.add(key);
              }
            };
        for (var key$__34 in this) {
          $__36(key$__34);
        }
        this._backendKeys.length = 0;
        var $__18 = true;
        var $__19 = false;
        var $__20 = undefined;
        try {
          var $__37 = this,
              $__38 = function() {
                var newKey = $__16.value;
                {
                  if (!$__37._skipKeys.has(newKey)) {
                    $__37._backendKeys.push(newKey);
                    if (!prevBackendKeys.has(newKey) && !backedKeys.has(newKey)) {
                      Object.defineProperty(self, newKey, {
                        enumerable: true,
                        configurable: true,
                        get: function() {
                          return self._backend.getValue(self, newKey);
                        },
                        set: function(value) {
                          self._backend.setValue(self, newKey, value);
                        }
                      });
                    } else {
                      prevBackendKeys.delete(newKey);
                    }
                  }
                }
              };
          for (var $__16 = void 0,
              $__15 = (currBackendKeys$__33)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__18 = ($__16 = $__15.next()).done); $__18 = true) {
            $__38();
          }
        } catch ($__21) {
          $__19 = true;
          $__20 = $__21;
        } finally {
          try {
            if (!$__18 && $__15.return != null) {
              $__15.return();
            }
          } finally {
            if ($__19) {
              throw $__20;
            }
          }
        }
        var $__25 = true;
        var $__26 = false;
        var $__27 = undefined;
        try {
          for (var $__23 = void 0,
              $__22 = (prevBackendKeys)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__25 = ($__23 = $__22.next()).done); $__25 = true) {
            var oldKey$__39 = $__23.value;
            {
              delete this[oldKey$__39];
            }
          }
        } catch ($__28) {
          $__26 = true;
          $__27 = $__28;
        } finally {
          try {
            if (!$__25 && $__22.return != null) {
              $__22.return();
            }
          } finally {
            if ($__26) {
              throw $__27;
            }
          }
        }
      }
    }
  },
  delete: {
    enumerable: false,
    writable: false,
    value: function(key) {
      delete this[key];
      this._backend.delete(this, key);
    }
  }
});
module.exports = SimpleProxy;
//# sourceMappingURL=data:application/json;base64,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QUEsVUFDRjtBQUFBLFFBQ0Y7QUFBQSxNQWtJSTtBQUFBLElBQ0o7QUFBQSxFQUNKO0FBQ0EsT0FBSyxDQUFHO0FBQ0osYUFBUyxDQUFHLE1BQUk7QUFDaEIsV0FBTyxDQUFHLE1BQUk7QUFDZCxRQUFJLENBQUcsVUFBUyxHQUFFLENBQUc7QUFDakIsV0FBTyxLQUFHLENBQUUsR0FBRSxDQUFDLENBQUM7QUFDaEIsU0FBRyxTQUFTLE9BQU8sQUFBQyxDQUFDLElBQUcsQ0FBRyxJQUFFLENBQUMsQ0FBQztJQUNuQztBQUFBLEVBQ0o7QUFBQSxBQUNKLENBQUMsQ0FBQztBQUVGLEtBQUssUUFBUSxFQUFJLFlBQVUsQ0FBQztBQUFBIiwiZmlsZSI6ImNvbW1vbi9zaW1wbGVQcm94eS5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgYXNzZXJ0ID0gcmVxdWlyZShcImJldHRlci1hc3NlcnRcIik7XG5cbmZ1bmN0aW9uIFNpbXBsZVByb3h5KGJhY2tlbmQpIHtcbiAgICBhc3NlcnQoXy5pc09iamVjdChiYWNrZW5kKSk7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIFwiX2JhY2tlbmRcIiwge1xuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgdmFsdWU6IGJhY2tlbmRcbiAgICB9KTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgXCJfYmFja2VuZEtleXNcIiwge1xuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgd3JpdGFibGU6IGZhbHNlLFxuICAgICAgICB2YWx1ZTogW11cbiAgICB9KTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgXCIka2V5c1wiLCB7XG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBiYWNrZW5kLmdldEtleXMoc2VsZik7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLnVwZGF0ZShTaW1wbGVQcm94eS51cGRhdGVNb2RlLmluaXQpO1xufVxuXG5TaW1wbGVQcm94eS51cGRhdGVNb2RlID0ge1xuICAgIHR3b1dheTogMCxcbiAgICBvbmVXYXk6IDEsXG4gICAgaW5pdDogMlxufTtcblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoU2ltcGxlUHJveHkucHJvdG90eXBlLCB7XG4gICAgX3NraXBLZXlzOiB7XG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgIHZhbHVlOiBuZXcgU2V0KFtcImdldEtleXNcIiwgXCJnZXRWYWx1ZVwiLCBcInNldFZhbHVlXCJdKVxuICAgIH0sXG4gICAgdXBkYXRlOiB7XG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgIHZhbHVlOiBmdW5jdGlvbihtb2RlKSB7XG4gICAgICAgICAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgICAgICAgICBpZiAobW9kZSA9PT0gU2ltcGxlUHJveHkudXBkYXRlTW9kZS5pbml0KSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgbmV3S2V5IG9mIHRoaXMuX2JhY2tlbmQuZ2V0S2V5cyh0aGlzKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZCh0aGlzW25ld0tleV0pKSB7IC8vIFRoaXMgbWFrZXMgdGhlIGxpc3QgYXMgdW5pcXVlXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9iYWNrZW5kS2V5cy5wdXNoKG5ld0tleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdLZXksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2JhY2tlbmQuZ2V0VmFsdWUoc2VsZiwgbmV3S2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2JhY2tlbmQuc2V0VmFsdWUoc2VsZiwgbmV3S2V5LCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAobW9kZSA9PT0gU2ltcGxlUHJveHkudXBkYXRlTW9kZS5vbmVXYXkpIHtcbiAgICAgICAgICAgICAgICBsZXQgY3VyckJhY2tlbmRLZXlzID0gbmV3IFNldCh0aGlzLl9iYWNrZW5kLmdldEtleXModGhpcykpO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiB0aGlzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghY3VyckJhY2tlbmRLZXlzLmhhcyhrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBuZXcga2V5IG9uIHByb3h5LCBhbmQgbm90IGRlZmluZWQgb24gYmFja2VuZDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JhY2tlbmQuc2V0VmFsdWUoc2VsZiwga2V5LCB0aGlzW2tleV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9iYWNrZW5kLmdldFZhbHVlKHNlbGYsIGtleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9iYWNrZW5kLnNldFZhbHVlKHNlbGYsIGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JhY2tlbmRLZXlzLnB1c2goa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJCYWNrZW5kS2V5cy5kZWxldGUoa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBvbGRLZXkgb2YgY3VyckJhY2tlbmRLZXlzKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzW29sZEtleV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgbGV0IHByZXZCYWNrZW5kS2V5cyA9IG5ldyBTZXQodGhpcy5fYmFja2VuZEtleXMpO1xuICAgICAgICAgICAgICAgIGxldCBjdXJyQmFja2VuZEtleXMgPSBuZXcgU2V0KHRoaXMuX2JhY2tlbmQuZ2V0S2V5cyh0aGlzKSk7XG4gICAgICAgICAgICAgICAgbGV0IGJhY2tlZEtleXMgPSBuZXcgU2V0KCk7XG5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXByZXZCYWNrZW5kS2V5cy5oYXMoa2V5KSAmJiAhY3VyckJhY2tlbmRLZXlzLmhhcyhrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBuZXcga2V5IG9uIHByb3h5LCBhbmQgbm90IGRlZmluZWQgb24gYmFja2VuZDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2JhY2tlbmQuc2V0VmFsdWUoc2VsZiwga2V5LCB0aGlzW2tleV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9iYWNrZW5kLmdldFZhbHVlKHNlbGYsIGtleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9iYWNrZW5kLnNldFZhbHVlKHNlbGYsIGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tlZEtleXMuYWRkKGtleSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9iYWNrZW5kS2V5cy5sZW5ndGggPSAwO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IG5ld0tleSBvZiBjdXJyQmFja2VuZEtleXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9za2lwS2V5cy5oYXMobmV3S2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmFja2VuZEtleXMucHVzaChuZXdLZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwcmV2QmFja2VuZEtleXMuaGFzKG5ld0tleSkgJiYgIWJhY2tlZEtleXMuaGFzKG5ld0tleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0tleSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9iYWNrZW5kLmdldFZhbHVlKHNlbGYsIG5ld0tleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9iYWNrZW5kLnNldFZhbHVlKHNlbGYsIG5ld0tleSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZCYWNrZW5kS2V5cy5kZWxldGUobmV3S2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBvbGRLZXkgb2YgcHJldkJhY2tlbmRLZXlzKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzW29sZEtleV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcbiAgICBkZWxldGU6IHtcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgIHdyaXRhYmxlOiBmYWxzZSxcbiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKGtleSkge1xuICAgICAgICAgICAgZGVsZXRlIHRoaXNba2V5XTtcbiAgICAgICAgICAgIHRoaXMuX2JhY2tlbmQuZGVsZXRlKHRoaXMsIGtleSk7XG4gICAgICAgIH1cbiAgICB9XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSBTaW1wbGVQcm94eTsiXX0=
