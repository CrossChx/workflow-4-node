"use strict";
var Activity = require("./activity");
var util = require("util");
var _ = require("lodash");
var Case = require("./case");
var When = require("./when");
var Default = require("./default");
var errors = require("../common/errors");
var guids = require("../common/guids");
function Switch() {
  Activity.call(this);
  this.expression = null;
}
util.inherits(Switch, Activity);
Switch.prototype.run = function(callContext, args) {
  if (args && args.length) {
    var parts = {
      cases: [],
      whens: [],
      default: null
    };
    var $__4 = true;
    var $__5 = false;
    var $__6 = undefined;
    try {
      for (var $__2 = void 0,
          $__1 = (args)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__4 = ($__2 = $__1.next()).done); $__4 = true) {
        var arg = $__2.value;
        {
          if (arg instanceof Case) {
            parts.cases.push(arg);
          } else if (arg instanceof When) {
            parts.whens.push(arg);
          } else if (arg instanceof Default) {
            if (parts.default === null) {
              parts.default = arg;
            } else {
              throw new errors.ActivityRuntimeError("Multiple default for a switch is not allowed.");
            }
          }
        }
      }
    } catch ($__7) {
      $__5 = true;
      $__6 = $__7;
    } finally {
      try {
        if (!$__4 && $__1.return != null) {
          $__1.return();
        }
      } finally {
        if ($__5) {
          throw $__6;
        }
      }
    }
    if (parts.cases.length || parts.whens.length || parts.default) {
      this._parts = parts;
      if (parts.cases.length) {
        this._doCase = true;
        callContext.schedule(this.expression, "_expressionGot");
      } else {
        this._doCase = false;
        callContext.activity._step.call(this, callContext);
      }
      return;
    }
  }
  callContext.complete();
};
Switch.prototype._expressionGot = function(callContext, reason, result) {
  if (reason === Activity.states.complete) {
    this.expression = result;
    callContext.activity._step.call(this, callContext);
  } else {
    callContext.end(reason, result);
  }
};
Switch.prototype._step = function(callContext) {
  var parts = this._parts;
  var doCase = this._doCase;
  if (doCase && parts.cases.length) {
    var next = parts.cases[0];
    parts.cases.splice(0, 1);
    callContext.schedule(next, "_partCompleted");
  } else if (!doCase && parts.whens.length) {
    var next$__8 = parts.whens[0];
    parts.whens.splice(0, 1);
    callContext.schedule(next$__8, "_partCompleted");
  } else if (parts.default) {
    callContext.schedule(parts.default, "_partCompleted");
  } else {
    callContext.complete();
  }
};
Switch.prototype._partCompleted = function(callContext, reason, result) {
  if (reason === Activity.states.complete) {
    if (result === guids.markers.nope) {
      callContext.activity._step.call(this, callContext);
    } else {
      callContext.complete(result);
    }
  } else {
    callContext.end(reason, result);
  }
};
module.exports = Switch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN3aXRjaC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUVBLEFBQUksRUFBQSxDQUFBLFFBQU8sRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFlBQVcsQ0FBQyxDQUFDO0FBQ3BDLEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLENBQUEsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0FBQ3pCLEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0FBQzVCLEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0FBQzVCLEFBQUksRUFBQSxDQUFBLE9BQU0sRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFdBQVUsQ0FBQyxDQUFDO0FBQ2xDLEFBQUksRUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGtCQUFpQixDQUFDLENBQUM7QUFDeEMsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsaUJBQWdCLENBQUMsQ0FBQztBQUV0QyxPQUFTLE9BQUssQ0FBRSxBQUFELENBQUc7QUFDZCxTQUFPLEtBQUssQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0FBRW5CLEtBQUcsV0FBVyxFQUFJLEtBQUcsQ0FBQztBQUMxQjtBQUFBLEFBRUEsR0FBRyxTQUFTLEFBQUMsQ0FBQyxNQUFLLENBQUcsU0FBTyxDQUFDLENBQUM7QUFFL0IsS0FBSyxVQUFVLElBQUksRUFBSSxVQUFVLFdBQVUsQ0FBRyxDQUFBLElBQUc7QUFDN0MsS0FBSSxJQUFHLEdBQUssQ0FBQSxJQUFHLE9BQU8sQ0FBRztBQUNyQixBQUFJLE1BQUEsQ0FBQSxLQUFJLEVBQUk7QUFDUixVQUFJLENBQUcsR0FBQztBQUNSLFVBQUksQ0FBRyxHQUFDO0FBQ1IsWUFBTSxDQUFHLEtBQUc7QUFBQSxJQUNoQixDQUFDO0FBeEJELEFBQUksTUFBQSxPQUFvQixLQUFHLENBQUM7QUFDNUIsQUFBSSxNQUFBLE9BQW9CLE1BQUksQ0FBQztBQUM3QixBQUFJLE1BQUEsT0FBb0IsVUFBUSxDQUFDO0FBQ2pDLE1BQUk7QUFISixVQUFTLEdBQUEsT0FEakIsS0FBSyxFQUFBLEFBQzRCO0FBQ2hCLGVBQW9CLENBQUEsQ0F3QmIsSUFBRyxDQXhCNEIsQ0FDbEMsZUFBYyxXQUFXLEFBQUMsQ0FBQyxNQUFLLFNBQVMsQ0FBQyxDQUFDLEFBQUMsRUFBQyxDQUNyRCxFQUFDLENBQUMsTUFBb0IsQ0FBQSxDQUFDLE1BQW9CLENBQUEsU0FBcUIsQUFBQyxFQUFDLENBQUMsS0FBSyxDQUFDLENBQ3pFLE9BQW9CLEtBQUcsQ0FBRztVQXFCdEIsSUFBRTtBQUFXO0FBQ2xCLGFBQUksR0FBRSxXQUFhLEtBQUcsQ0FBRztBQUNyQixnQkFBSSxNQUFNLEtBQUssQUFBQyxDQUFDLEdBQUUsQ0FBQyxDQUFDO1VBQ3pCLEtBQ0ssS0FBSSxHQUFFLFdBQWEsS0FBRyxDQUFHO0FBQzFCLGdCQUFJLE1BQU0sS0FBSyxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUM7VUFDekIsS0FDSyxLQUFJLEdBQUUsV0FBYSxRQUFNLENBQUc7QUFDN0IsZUFBSSxLQUFJLFFBQVEsSUFBTSxLQUFHLENBQUc7QUFDeEIsa0JBQUksUUFBUSxFQUFJLElBQUUsQ0FBQztZQUN2QixLQUNLO0FBQ0Qsa0JBQU0sSUFBSSxDQUFBLE1BQUsscUJBQXFCLEFBQUMsQ0FBQywrQ0FBOEMsQ0FBQyxDQUFDO1lBQzFGO0FBQUEsVUFDSjtBQUFBLFFBQ0o7TUFqQ0E7QUFBQSxJQUZBLENBQUUsWUFBMEI7QUFDMUIsV0FBb0IsS0FBRyxDQUFDO0FBQ3hCLGdCQUFvQyxDQUFDO0lBQ3ZDLENBQUUsT0FBUTtBQUNSLFFBQUk7QUFDRixXQUFJLEtBQWlCLEdBQUssQ0FBQSxXQUF1QixHQUFLLEtBQUcsQ0FBRztBQUMxRCxvQkFBd0IsQUFBQyxFQUFDLENBQUM7UUFDN0I7QUFBQSxNQUNGLENBQUUsT0FBUTtBQUNSLGdCQUF3QjtBQUN0QixvQkFBd0I7UUFDMUI7QUFBQSxNQUNGO0FBQUEsSUFDRjtBQUFBLEFBdUJBLE9BQUksS0FBSSxNQUFNLE9BQU8sR0FBSyxDQUFBLEtBQUksTUFBTSxPQUFPLENBQUEsRUFBSyxDQUFBLEtBQUksUUFBUSxDQUFHO0FBQzNELFNBQUcsT0FBTyxFQUFJLE1BQUksQ0FBQztBQUNuQixTQUFJLEtBQUksTUFBTSxPQUFPLENBQUc7QUFDcEIsV0FBRyxRQUFRLEVBQUksS0FBRyxDQUFDO0FBQ25CLGtCQUFVLFNBQVMsQUFBQyxDQUFDLElBQUcsV0FBVyxDQUFHLGlCQUFlLENBQUMsQ0FBQztNQUMzRCxLQUNLO0FBQ0QsV0FBRyxRQUFRLEVBQUksTUFBSSxDQUFDO0FBQ3BCLGtCQUFVLFNBQVMsTUFBTSxLQUFLLEFBQUMsQ0FBQyxJQUFHLENBQUcsWUFBVSxDQUFDLENBQUM7TUFDdEQ7QUFBQSxBQUNBLFlBQU07SUFDVjtBQUFBLEVBQ0o7QUFBQSxBQUNBLFlBQVUsU0FBUyxBQUFDLEVBQUMsQ0FBQztBQUMxQixDQUFDO0FBRUQsS0FBSyxVQUFVLGVBQWUsRUFBSSxVQUFVLFdBQVUsQ0FBRyxDQUFBLE1BQUssQ0FBRyxDQUFBLE1BQUssQ0FBRztBQUNyRSxLQUFJLE1BQUssSUFBTSxDQUFBLFFBQU8sT0FBTyxTQUFTLENBQUc7QUFDckMsT0FBRyxXQUFXLEVBQUksT0FBSyxDQUFDO0FBQ3hCLGNBQVUsU0FBUyxNQUFNLEtBQUssQUFBQyxDQUFDLElBQUcsQ0FBRyxZQUFVLENBQUMsQ0FBQztFQUN0RCxLQUNLO0FBQ0QsY0FBVSxJQUFJLEFBQUMsQ0FBQyxNQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7RUFDbkM7QUFBQSxBQUNKLENBQUM7QUFFRCxLQUFLLFVBQVUsTUFBTSxFQUFJLFVBQVUsV0FBVSxDQUFHO0FBQzVDLEFBQUksSUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsT0FBTyxDQUFDO0FBQ3ZCLEFBQUksSUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLElBQUcsUUFBUSxDQUFDO0FBQ3pCLEtBQUksTUFBSyxHQUFLLENBQUEsS0FBSSxNQUFNLE9BQU8sQ0FBRztBQUM5QixBQUFJLE1BQUEsQ0FBQSxJQUFHLEVBQUksQ0FBQSxLQUFJLE1BQU0sQ0FBRSxDQUFBLENBQUMsQ0FBQztBQUN6QixRQUFJLE1BQU0sT0FBTyxBQUFDLENBQUMsQ0FBQSxDQUFHLEVBQUEsQ0FBQyxDQUFDO0FBQ3hCLGNBQVUsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFHLGlCQUFlLENBQUMsQ0FBQztFQUNoRCxLQUNLLEtBQUksQ0FBQyxNQUFLLENBQUEsRUFBSyxDQUFBLEtBQUksTUFBTSxPQUFPLENBQUc7QUFDcEMsQUFBSSxNQUFBLENBQUEsUUFBRyxFQUFJLENBQUEsS0FBSSxNQUFNLENBQUUsQ0FBQSxDQUFDLENBQUM7QUFDekIsUUFBSSxNQUFNLE9BQU8sQUFBQyxDQUFDLENBQUEsQ0FBRyxFQUFBLENBQUMsQ0FBQztBQUN4QixjQUFVLFNBQVMsQUFBQyxVQUFPLGlCQUFlLENBQUMsQ0FBQztFQUNoRCxLQUNLLEtBQUksS0FBSSxRQUFRLENBQUc7QUFDcEIsY0FBVSxTQUFTLEFBQUMsQ0FBQyxLQUFJLFFBQVEsQ0FBRyxpQkFBZSxDQUFDLENBQUM7RUFDekQsS0FDSztBQUNELGNBQVUsU0FBUyxBQUFDLEVBQUMsQ0FBQztFQUMxQjtBQUFBLEFBQ0osQ0FBQztBQUVELEtBQUssVUFBVSxlQUFlLEVBQUksVUFBVSxXQUFVLENBQUcsQ0FBQSxNQUFLLENBQUcsQ0FBQSxNQUFLLENBQUc7QUFDckUsS0FBSSxNQUFLLElBQU0sQ0FBQSxRQUFPLE9BQU8sU0FBUyxDQUFHO0FBQ3JDLE9BQUksTUFBSyxJQUFNLENBQUEsS0FBSSxRQUFRLEtBQUssQ0FBRztBQUMvQixnQkFBVSxTQUFTLE1BQU0sS0FBSyxBQUFDLENBQUMsSUFBRyxDQUFHLFlBQVUsQ0FBQyxDQUFDO0lBQ3RELEtBQ0s7QUFDRCxnQkFBVSxTQUFTLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQztJQUNoQztBQUFBLEVBQ0osS0FDSztBQUNELGNBQVUsSUFBSSxBQUFDLENBQUMsTUFBSyxDQUFHLE9BQUssQ0FBQyxDQUFDO0VBQ25DO0FBQUEsQUFDSixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksT0FBSyxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9zd2l0Y2guanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5sZXQgQWN0aXZpdHkgPSByZXF1aXJlKFwiLi9hY3Rpdml0eVwiKTtcbmxldCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgQ2FzZSA9IHJlcXVpcmUoXCIuL2Nhc2VcIik7XG5sZXQgV2hlbiA9IHJlcXVpcmUoXCIuL3doZW5cIik7XG5sZXQgRGVmYXVsdCA9IHJlcXVpcmUoXCIuL2RlZmF1bHRcIik7XG5sZXQgZXJyb3JzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lcnJvcnNcIik7XG5sZXQgZ3VpZHMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2d1aWRzXCIpO1xuXG5mdW5jdGlvbiBTd2l0Y2goKSB7XG4gICAgQWN0aXZpdHkuY2FsbCh0aGlzKTtcblxuICAgIHRoaXMuZXhwcmVzc2lvbiA9IG51bGw7XG59XG5cbnV0aWwuaW5oZXJpdHMoU3dpdGNoLCBBY3Rpdml0eSk7XG5cblN3aXRjaC5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBhcmdzKSB7XG4gICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGgpIHtcbiAgICAgICAgbGV0IHBhcnRzID0ge1xuICAgICAgICAgICAgY2FzZXM6IFtdLFxuICAgICAgICAgICAgd2hlbnM6IFtdLFxuICAgICAgICAgICAgZGVmYXVsdDogbnVsbFxuICAgICAgICB9O1xuICAgICAgICBmb3IgKGxldCBhcmcgb2YgYXJncykge1xuICAgICAgICAgICAgaWYgKGFyZyBpbnN0YW5jZW9mIENhc2UpIHtcbiAgICAgICAgICAgICAgICBwYXJ0cy5jYXNlcy5wdXNoKGFyZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBXaGVuKSB7XG4gICAgICAgICAgICAgICAgcGFydHMud2hlbnMucHVzaChhcmcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRGVmYXVsdCkge1xuICAgICAgICAgICAgICAgIGlmIChwYXJ0cy5kZWZhdWx0ID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRzLmRlZmF1bHQgPSBhcmc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiTXVsdGlwbGUgZGVmYXVsdCBmb3IgYSBzd2l0Y2ggaXMgbm90IGFsbG93ZWQuXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocGFydHMuY2FzZXMubGVuZ3RoIHx8IHBhcnRzLndoZW5zLmxlbmd0aCB8fCBwYXJ0cy5kZWZhdWx0KSB7XG4gICAgICAgICAgICB0aGlzLl9wYXJ0cyA9IHBhcnRzO1xuICAgICAgICAgICAgaWYgKHBhcnRzLmNhc2VzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2RvQ2FzZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgY2FsbENvbnRleHQuc2NoZWR1bGUodGhpcy5leHByZXNzaW9uLCBcIl9leHByZXNzaW9uR290XCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fZG9DYXNlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgY2FsbENvbnRleHQuYWN0aXZpdHkuX3N0ZXAuY2FsbCh0aGlzLCBjYWxsQ29udGV4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2FsbENvbnRleHQuY29tcGxldGUoKTtcbn07XG5cblN3aXRjaC5wcm90b3R5cGUuX2V4cHJlc3Npb25Hb3QgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XG4gICAgaWYgKHJlYXNvbiA9PT0gQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlKSB7XG4gICAgICAgIHRoaXMuZXhwcmVzc2lvbiA9IHJlc3VsdDtcbiAgICAgICAgY2FsbENvbnRleHQuYWN0aXZpdHkuX3N0ZXAuY2FsbCh0aGlzLCBjYWxsQ29udGV4dCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xuICAgIH1cbn07XG5cblN3aXRjaC5wcm90b3R5cGUuX3N0ZXAgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQpIHtcbiAgICBsZXQgcGFydHMgPSB0aGlzLl9wYXJ0cztcbiAgICBsZXQgZG9DYXNlID0gdGhpcy5fZG9DYXNlO1xuICAgIGlmIChkb0Nhc2UgJiYgcGFydHMuY2FzZXMubGVuZ3RoKSB7XG4gICAgICAgIGxldCBuZXh0ID0gcGFydHMuY2FzZXNbMF07XG4gICAgICAgIHBhcnRzLmNhc2VzLnNwbGljZSgwLCAxKTtcbiAgICAgICAgY2FsbENvbnRleHQuc2NoZWR1bGUobmV4dCwgXCJfcGFydENvbXBsZXRlZFwiKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoIWRvQ2FzZSAmJiBwYXJ0cy53aGVucy5sZW5ndGgpIHtcbiAgICAgICAgbGV0IG5leHQgPSBwYXJ0cy53aGVuc1swXTtcbiAgICAgICAgcGFydHMud2hlbnMuc3BsaWNlKDAsIDEpO1xuICAgICAgICBjYWxsQ29udGV4dC5zY2hlZHVsZShuZXh0LCBcIl9wYXJ0Q29tcGxldGVkXCIpO1xuICAgIH1cbiAgICBlbHNlIGlmIChwYXJ0cy5kZWZhdWx0KSB7XG4gICAgICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKHBhcnRzLmRlZmF1bHQsIFwiX3BhcnRDb21wbGV0ZWRcIik7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYWxsQ29udGV4dC5jb21wbGV0ZSgpO1xuICAgIH1cbn07XG5cblN3aXRjaC5wcm90b3R5cGUuX3BhcnRDb21wbGV0ZWQgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XG4gICAgaWYgKHJlYXNvbiA9PT0gQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlKSB7XG4gICAgICAgIGlmIChyZXN1bHQgPT09IGd1aWRzLm1hcmtlcnMubm9wZSkge1xuICAgICAgICAgICAgY2FsbENvbnRleHQuYWN0aXZpdHkuX3N0ZXAuY2FsbCh0aGlzLCBjYWxsQ29udGV4dCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjYWxsQ29udGV4dC5jb21wbGV0ZShyZXN1bHQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gU3dpdGNoOyJdfQ==
