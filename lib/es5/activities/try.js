"use strict";
var Activity = require("./activity");
var util = require("util");
var errors = require("../common/errors");
var _ = require("lodash");
var Block = require("./block");
function Try() {
  Activity.call(this);
  this.arrayProperties.add("catch");
  this.arrayProperties.add("finally");
  this.nonScopedProperties.add("continueAfterFinally");
  this.varName = "e";
  this._body = null;
  this.catch = null;
  this.finally = null;
}
util.inherits(Try, Activity);
Try.prototype.initializeStructure = function() {
  this._body = new Block();
  this._body.args = this.args;
  this.args = null;
  if (this.catch) {
    var prev = this.catch;
    this.catch = new Block();
    this.catch.args = prev;
  }
  if (this.finally) {
    var prev$__0 = this.finally;
    this.finally = new Block();
    this.finally.args = prev$__0;
  }
};
Try.prototype.run = function(callContext, args) {
  callContext.schedule(this._body, "_bodyFinished");
};
Try.prototype._bodyFinished = function(callContext, reason, result) {
  if (this.catch || this.finally) {
    this._originalResult = result;
    this._originalReason = reason;
    if (reason === Activity.states.fail && !(result instanceof errors.ActivityRuntimeError) && this.catch) {
      this[this.varName] = result;
      this.Try_ReThrow = false;
      callContext.schedule(this.catch, "_catchDone");
      return;
    } else if ((reason === Activity.states.fail || reason === Activity.states.complete) && this.finally) {
      callContext.schedule(this.finally, "_finallyDone");
      return;
    }
  }
  callContext.end(reason, result);
};
Try.prototype._catchDone = function(callContext, reason, result) {
  if (reason !== Activity.states.complete) {
    callContext.end(reason, result);
    return;
  }
  this._catchResult = result;
  if (this.finally) {
    callContext.schedule(this.finally, "_finallyDone");
  } else {
    callContext.activity.continueAfterFinally.call(this, callContext);
  }
};
Try.prototype._finallyDone = function(callContext, reason, result) {
  if (reason !== Activity.states.complete) {
    callContext.end(reason, result);
    return;
  }
  callContext.activity.continueAfterFinally.call(this, callContext);
};
Try.prototype.continueAfterFinally = function(callContext) {
  var reason = this._originalReason;
  var result = this._originalResult;
  if (reason === Activity.states.fail && !_.isUndefined(this.Try_ReThrow)) {
    if (this.Try_ReThrow === true) {
      callContext.fail(result);
    } else if (this.Try_ReThrow instanceof Error) {
      callContext.fail(this.Try_ReThrow);
    } else {
      callContext.complete(this._catchResult);
    }
  } else {
    callContext.end(reason, result);
  }
};
module.exports = Try;
//# sourceMappingURL=data:application/json;base64,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Q0FBQyxDQUFDO0FBQy9CLFVBQU07RUFDVjtBQUFBLEFBRUEsWUFBVSxTQUFTLHFCQUFxQixLQUFLLEFBQUMsQ0FBQyxJQUFHLENBQUcsWUFBVSxDQUFDLENBQUM7QUFDckUsQ0FBQztBQUVELEVBQUUsVUFBVSxxQkFBcUIsRUFBSSxVQUFTLFdBQVUsQ0FBRztBQUN2RCxBQUFJLElBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxJQUFHLGdCQUFnQixDQUFDO0FBQ2pDLEFBQUksSUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLElBQUcsZ0JBQWdCLENBQUM7QUFDakMsS0FBSSxNQUFLLElBQU0sQ0FBQSxRQUFPLE9BQU8sS0FBSyxDQUFBLEVBQUssRUFBQyxDQUFBLFlBQVksQUFBQyxDQUFDLElBQUcsWUFBWSxDQUFDLENBQUc7QUFFckUsT0FBSSxJQUFHLFlBQVksSUFBTSxLQUFHLENBQUc7QUFDM0IsZ0JBQVUsS0FBSyxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7SUFDNUIsS0FDSyxLQUFJLElBQUcsWUFBWSxXQUFhLE1BQUksQ0FBRztBQUN4QyxnQkFBVSxLQUFLLEFBQUMsQ0FBQyxJQUFHLFlBQVksQ0FBQyxDQUFDO0lBQ3RDLEtBQ0s7QUFDRCxnQkFBVSxTQUFTLEFBQUMsQ0FBQyxJQUFHLGFBQWEsQ0FBQyxDQUFDO0lBQzNDO0FBQUEsRUFDSixLQUNLO0FBQ0QsY0FBVSxJQUFJLEFBQUMsQ0FBQyxNQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7RUFDbkM7QUFBQSxBQUNKLENBQUM7QUFFRCxLQUFLLFFBQVEsRUFBSSxJQUFFLENBQUM7QUFBQSIsImZpbGUiOiJhY3Rpdml0aWVzL3RyeS5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCBBY3Rpdml0eSA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5XCIpO1xubGV0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcbmxldCBlcnJvcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2Vycm9yc1wiKTtcbmxldCBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbmxldCBCbG9jayA9IHJlcXVpcmUoXCIuL2Jsb2NrXCIpO1xuXG5mdW5jdGlvbiBUcnkoKSB7XG4gICAgQWN0aXZpdHkuY2FsbCh0aGlzKTtcblxuICAgIHRoaXMuYXJyYXlQcm9wZXJ0aWVzLmFkZChcImNhdGNoXCIpO1xuICAgIHRoaXMuYXJyYXlQcm9wZXJ0aWVzLmFkZChcImZpbmFsbHlcIik7XG4gICAgdGhpcy5ub25TY29wZWRQcm9wZXJ0aWVzLmFkZChcImNvbnRpbnVlQWZ0ZXJGaW5hbGx5XCIpO1xuXG4gICAgdGhpcy52YXJOYW1lID0gXCJlXCI7XG4gICAgdGhpcy5fYm9keSA9IG51bGw7XG4gICAgdGhpcy5jYXRjaCA9IG51bGw7XG4gICAgdGhpcy5maW5hbGx5ID0gbnVsbDtcbn1cblxudXRpbC5pbmhlcml0cyhUcnksIEFjdGl2aXR5KTtcblxuVHJ5LnByb3RvdHlwZS5pbml0aWFsaXplU3RydWN0dXJlID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fYm9keSA9IG5ldyBCbG9jaygpO1xuICAgIHRoaXMuX2JvZHkuYXJncyA9IHRoaXMuYXJncztcbiAgICB0aGlzLmFyZ3MgPSBudWxsO1xuICAgIGlmICh0aGlzLmNhdGNoKSB7XG4gICAgICAgIGxldCBwcmV2ID0gdGhpcy5jYXRjaDtcbiAgICAgICAgdGhpcy5jYXRjaCA9IG5ldyBCbG9jaygpO1xuICAgICAgICB0aGlzLmNhdGNoLmFyZ3MgPSBwcmV2O1xuICAgIH1cbiAgICBpZiAodGhpcy5maW5hbGx5KSB7XG4gICAgICAgIGxldCBwcmV2ID0gdGhpcy5maW5hbGx5O1xuICAgICAgICB0aGlzLmZpbmFsbHkgPSBuZXcgQmxvY2soKTtcbiAgICAgICAgdGhpcy5maW5hbGx5LmFyZ3MgPSBwcmV2O1xuICAgIH1cbn07XG5cblRyeS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBhcmdzKSB7XG4gICAgY2FsbENvbnRleHQuc2NoZWR1bGUodGhpcy5fYm9keSwgXCJfYm9keUZpbmlzaGVkXCIpO1xufTtcblxuVHJ5LnByb3RvdHlwZS5fYm9keUZpbmlzaGVkID0gZnVuY3Rpb24oY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XG4gICAgaWYgKHRoaXMuY2F0Y2ggfHwgdGhpcy5maW5hbGx5KSB7XG4gICAgICAgIHRoaXMuX29yaWdpbmFsUmVzdWx0ID0gcmVzdWx0O1xuICAgICAgICB0aGlzLl9vcmlnaW5hbFJlYXNvbiA9IHJlYXNvbjtcbiAgICAgICAgaWYgKHJlYXNvbiA9PT0gQWN0aXZpdHkuc3RhdGVzLmZhaWwgJiYgIShyZXN1bHQgaW5zdGFuY2VvZiBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IpICYmIHRoaXMuY2F0Y2gpIHtcbiAgICAgICAgICAgIHRoaXNbdGhpcy52YXJOYW1lXSA9IHJlc3VsdDtcbiAgICAgICAgICAgIHRoaXMuVHJ5X1JlVGhyb3cgPSBmYWxzZTtcbiAgICAgICAgICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKHRoaXMuY2F0Y2gsIFwiX2NhdGNoRG9uZVwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICgocmVhc29uID09PSBBY3Rpdml0eS5zdGF0ZXMuZmFpbCB8fCByZWFzb24gPT09IEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZSkgJiYgdGhpcy5maW5hbGx5KSB7XG4gICAgICAgICAgICBjYWxsQ29udGV4dC5zY2hlZHVsZSh0aGlzLmZpbmFsbHksIFwiX2ZpbmFsbHlEb25lXCIpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNhbGxDb250ZXh0LmVuZChyZWFzb24sIHJlc3VsdCk7XG59O1xuXG5UcnkucHJvdG90eXBlLl9jYXRjaERvbmUgPSBmdW5jdGlvbihjYWxsQ29udGV4dCwgcmVhc29uLCByZXN1bHQpIHtcbiAgICBpZiAocmVhc29uICE9PSBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUpIHtcbiAgICAgICAgY2FsbENvbnRleHQuZW5kKHJlYXNvbiwgcmVzdWx0KTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuX2NhdGNoUmVzdWx0ID0gcmVzdWx0O1xuICAgIGlmICh0aGlzLmZpbmFsbHkpIHtcbiAgICAgICAgY2FsbENvbnRleHQuc2NoZWR1bGUodGhpcy5maW5hbGx5LCBcIl9maW5hbGx5RG9uZVwiKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNhbGxDb250ZXh0LmFjdGl2aXR5LmNvbnRpbnVlQWZ0ZXJGaW5hbGx5LmNhbGwodGhpcywgY2FsbENvbnRleHQpO1xuICAgIH1cbn07XG5cblRyeS5wcm90b3R5cGUuX2ZpbmFsbHlEb25lID0gZnVuY3Rpb24oY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XG4gICAgaWYgKHJlYXNvbiAhPT0gQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlKSB7XG4gICAgICAgIGNhbGxDb250ZXh0LmVuZChyZWFzb24sIHJlc3VsdCk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjYWxsQ29udGV4dC5hY3Rpdml0eS5jb250aW51ZUFmdGVyRmluYWxseS5jYWxsKHRoaXMsIGNhbGxDb250ZXh0KTtcbn07XG5cblRyeS5wcm90b3R5cGUuY29udGludWVBZnRlckZpbmFsbHkgPSBmdW5jdGlvbihjYWxsQ29udGV4dCkge1xuICAgIGxldCByZWFzb24gPSB0aGlzLl9vcmlnaW5hbFJlYXNvbjtcbiAgICBsZXQgcmVzdWx0ID0gdGhpcy5fb3JpZ2luYWxSZXN1bHQ7XG4gICAgaWYgKHJlYXNvbiA9PT0gQWN0aXZpdHkuc3RhdGVzLmZhaWwgJiYgIV8uaXNVbmRlZmluZWQodGhpcy5UcnlfUmVUaHJvdykpIHtcbiAgICAgICAgLy8gV2UndmUgY2FtZSBmcm9tIGEgY2F0Y2g6XG4gICAgICAgIGlmICh0aGlzLlRyeV9SZVRocm93ID09PSB0cnVlKSB7XG4gICAgICAgICAgICBjYWxsQ29udGV4dC5mYWlsKHJlc3VsdCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodGhpcy5UcnlfUmVUaHJvdyBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgICAgICBjYWxsQ29udGV4dC5mYWlsKHRoaXMuVHJ5X1JlVGhyb3cpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY2FsbENvbnRleHQuY29tcGxldGUodGhpcy5fY2F0Y2hSZXN1bHQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gVHJ5OyJdfQ==
