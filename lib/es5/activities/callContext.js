"use strict";
var common = require("../common");
var is = common.is;
var _ = require("lodash");
function CallContext(executionContext, activityOrActivityId, scope) {
  this._executionContext = executionContext;
  this._activity = activityOrActivityId ? this._asActivity(activityOrActivityId) : null;
  this._activityInstanceId = this._activity ? this._activity.getInstanceId(executionContext) : null;
  this._scope = scope ? scope : null;
  this._executionState = null;
  this._scopePart = null;
}
Object.defineProperties(CallContext.prototype, {
  instanceId: {get: function() {
      return this._activityInstanceId;
    }},
  _parentActivityId: {get: function() {
      if (!this._activity) {
        return null;
      }
      var state = this._executionContext.getExecutionState(this.instanceId);
      return state.parentInstanceId;
    }},
  _scopeTree: {get: function() {
      return this._executionContext._scopeTree;
    }},
  activity: {get: function() {
      return this._activity;
    }},
  executionContext: {get: function() {
      return this._executionContext;
    }},
  executionState: {get: function() {
      return this._executionState || (this._activity ? (this._executionState = this._executionContext.getExecutionState(this.instanceId)) : null);
    }},
  scope: {get: function() {
      return this._scope || (this._scope = this._scopeTree.find(this.instanceId));
    }}
});
CallContext.prototype.next = function(childActivityOrActivityId, variables) {
  var child = this._asActivity(childActivityOrActivityId);
  var part = child.createScopePart();
  if (_.isObject(variables)) {
    _.extend(part, variables);
  }
  return new CallContext(this._executionContext, child, this._scopeTree.next(this.instanceId, child.getInstanceId(this.executionContext), part, child.id));
};
CallContext.prototype.back = function(keepScope) {
  var parentId = this._parentActivityId;
  if (parentId) {
    return new CallContext(this._executionContext, parentId, this._scopeTree.back(this.instanceId, keepScope));
  } else {
    return null;
  }
};
CallContext.prototype._asActivity = function(activityOrActivityId) {
  return is.activity(activityOrActivityId) ? activityOrActivityId : this._executionContext._getKnownActivity(activityOrActivityId);
};
CallContext.prototype.complete = function(result) {
  this.activity.complete(this, result);
};
CallContext.prototype.cancel = function() {
  this.activity.cancel(this);
};
CallContext.prototype.idle = function() {
  this.activity.idle(this);
};
CallContext.prototype.fail = function(e) {
  this.activity.fail(this, e);
};
CallContext.prototype.end = function(reason, result) {
  this.activity.end(this, reason, result);
};
CallContext.prototype.emitWorkflowEvent = function(args) {
  this.executionContext.emitWorkflowEvent(args);
};
CallContext.prototype.schedule = function(obj, endcallback) {
  this.activity.schedule(this, obj, endcallback);
};
CallContext.prototype.createBookmark = function(name, callback) {
  return this._executionContext.createBookmark(this.instanceId, name, callback);
};
CallContext.prototype.resumeBookmark = function(name, reason, result) {
  this._executionContext.resumeBookmarkInternal(this, name, reason, result);
};
module.exports = CallContext;
//# sourceMappingURL=data:application/json;base64,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LGVBQWUsRUFBSSxVQUFVLElBQUcsQ0FBRyxDQUFBLE1BQUssQ0FBRyxDQUFBLE1BQUssQ0FBRztBQUNuRSxLQUFHLGtCQUFrQix1QkFBdUIsQUFBQyxDQUFDLElBQUcsQ0FBRyxLQUFHLENBQUcsT0FBSyxDQUFHLE9BQUssQ0FBQyxDQUFDO0FBQzdFLENBQUM7QUFFRCxLQUFLLFFBQVEsRUFBSSxZQUFVLENBQUM7QUFDNUIiLCJmaWxlIjoiYWN0aXZpdGllcy9jYWxsQ29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCBjb21tb24gPSByZXF1aXJlKFwiLi4vY29tbW9uXCIpO1xubGV0IGlzID0gY29tbW9uLmlzO1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xuXG5mdW5jdGlvbiBDYWxsQ29udGV4dChleGVjdXRpb25Db250ZXh0LCBhY3Rpdml0eU9yQWN0aXZpdHlJZCwgc2NvcGUpIHtcbiAgICB0aGlzLl9leGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDtcbiAgICB0aGlzLl9hY3Rpdml0eSA9IGFjdGl2aXR5T3JBY3Rpdml0eUlkID8gdGhpcy5fYXNBY3Rpdml0eShhY3Rpdml0eU9yQWN0aXZpdHlJZCkgOiBudWxsO1xuICAgIHRoaXMuX2FjdGl2aXR5SW5zdGFuY2VJZCA9IHRoaXMuX2FjdGl2aXR5ID8gdGhpcy5fYWN0aXZpdHkuZ2V0SW5zdGFuY2VJZChleGVjdXRpb25Db250ZXh0KSA6IG51bGw7XG4gICAgdGhpcy5fc2NvcGUgPSBzY29wZSA/IHNjb3BlIDogbnVsbDtcbiAgICB0aGlzLl9leGVjdXRpb25TdGF0ZSA9IG51bGw7XG4gICAgdGhpcy5fc2NvcGVQYXJ0ID0gbnVsbDtcbn1cblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoXG4gICAgQ2FsbENvbnRleHQucHJvdG90eXBlLFxuICAgIHtcbiAgICAgICAgaW5zdGFuY2VJZDoge1xuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FjdGl2aXR5SW5zdGFuY2VJZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgX3BhcmVudEFjdGl2aXR5SWQ6IHtcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYWN0aXZpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxldCBzdGF0ZSA9IHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQuZ2V0RXhlY3V0aW9uU3RhdGUodGhpcy5pbnN0YW5jZUlkKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGUucGFyZW50SW5zdGFuY2VJZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgX3Njb3BlVHJlZToge1xuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQuX3Njb3BlVHJlZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgYWN0aXZpdHk6IHtcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9hY3Rpdml0eTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZXhlY3V0aW9uQ29udGV4dDoge1xuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGV4ZWN1dGlvblN0YXRlOiB7XG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0aW9uU3RhdGUgfHwgKHRoaXMuX2FjdGl2aXR5ID8gKHRoaXMuX2V4ZWN1dGlvblN0YXRlID0gdGhpcy5fZXhlY3V0aW9uQ29udGV4dC5nZXRFeGVjdXRpb25TdGF0ZSh0aGlzLmluc3RhbmNlSWQpKSA6IG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBzY29wZToge1xuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Njb3BlIHx8ICh0aGlzLl9zY29wZSA9IHRoaXMuX3Njb3BlVHJlZS5maW5kKHRoaXMuaW5zdGFuY2VJZCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuKTtcblxuQ2FsbENvbnRleHQucHJvdG90eXBlLm5leHQgPSBmdW5jdGlvbiAoY2hpbGRBY3Rpdml0eU9yQWN0aXZpdHlJZCwgdmFyaWFibGVzKSB7XG4gICAgbGV0IGNoaWxkID0gdGhpcy5fYXNBY3Rpdml0eShjaGlsZEFjdGl2aXR5T3JBY3Rpdml0eUlkKTtcbiAgICBsZXQgcGFydCA9IGNoaWxkLmNyZWF0ZVNjb3BlUGFydCgpO1xuICAgIGlmIChfLmlzT2JqZWN0KHZhcmlhYmxlcykpIHtcbiAgICAgICAgXy5leHRlbmQocGFydCwgdmFyaWFibGVzKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBDYWxsQ29udGV4dChcbiAgICAgICAgdGhpcy5fZXhlY3V0aW9uQ29udGV4dCxcbiAgICAgICAgY2hpbGQsXG4gICAgICAgIHRoaXMuX3Njb3BlVHJlZS5uZXh0KHRoaXMuaW5zdGFuY2VJZCwgY2hpbGQuZ2V0SW5zdGFuY2VJZCh0aGlzLmV4ZWN1dGlvbkNvbnRleHQpLCBwYXJ0LCBjaGlsZC5pZCkpO1xufTtcblxuQ2FsbENvbnRleHQucHJvdG90eXBlLmJhY2sgPSBmdW5jdGlvbiAoa2VlcFNjb3BlKSB7XG4gICAgbGV0IHBhcmVudElkID0gdGhpcy5fcGFyZW50QWN0aXZpdHlJZDtcbiAgICBpZiAocGFyZW50SWQpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBDYWxsQ29udGV4dChcbiAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQsXG4gICAgICAgICAgICBwYXJlbnRJZCxcbiAgICAgICAgICAgIHRoaXMuX3Njb3BlVHJlZS5iYWNrKHRoaXMuaW5zdGFuY2VJZCwga2VlcFNjb3BlKSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59O1xuXG5DYWxsQ29udGV4dC5wcm90b3R5cGUuX2FzQWN0aXZpdHkgPSBmdW5jdGlvbiAoYWN0aXZpdHlPckFjdGl2aXR5SWQpIHtcbiAgICByZXR1cm4gaXMuYWN0aXZpdHkoYWN0aXZpdHlPckFjdGl2aXR5SWQpID8gYWN0aXZpdHlPckFjdGl2aXR5SWQgOiB0aGlzLl9leGVjdXRpb25Db250ZXh0Ll9nZXRLbm93bkFjdGl2aXR5KGFjdGl2aXR5T3JBY3Rpdml0eUlkKTtcbn07XG5cbi8qIENhbGxiYWNrcyAqL1xuXG5DYWxsQ29udGV4dC5wcm90b3R5cGUuY29tcGxldGUgPSBmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgdGhpcy5hY3Rpdml0eS5jb21wbGV0ZSh0aGlzLCByZXN1bHQpO1xufTtcblxuQ2FsbENvbnRleHQucHJvdG90eXBlLmNhbmNlbCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmFjdGl2aXR5LmNhbmNlbCh0aGlzKTtcbn07XG5cbkNhbGxDb250ZXh0LnByb3RvdHlwZS5pZGxlID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuYWN0aXZpdHkuaWRsZSh0aGlzKTtcbn07XG5cbkNhbGxDb250ZXh0LnByb3RvdHlwZS5mYWlsID0gZnVuY3Rpb24gKGUpIHtcbiAgICB0aGlzLmFjdGl2aXR5LmZhaWwodGhpcywgZSk7XG59O1xuXG5DYWxsQ29udGV4dC5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24gKHJlYXNvbiwgcmVzdWx0KSB7XG4gICAgdGhpcy5hY3Rpdml0eS5lbmQodGhpcywgcmVhc29uLCByZXN1bHQpO1xufTtcblxuQ2FsbENvbnRleHQucHJvdG90eXBlLmVtaXRXb3JrZmxvd0V2ZW50ID0gZnVuY3Rpb24gKGFyZ3MpIHtcbiAgICB0aGlzLmV4ZWN1dGlvbkNvbnRleHQuZW1pdFdvcmtmbG93RXZlbnQoYXJncyk7XG59O1xuXG5DYWxsQ29udGV4dC5wcm90b3R5cGUuc2NoZWR1bGUgPSBmdW5jdGlvbiAob2JqLCBlbmRjYWxsYmFjaykge1xuICAgIHRoaXMuYWN0aXZpdHkuc2NoZWR1bGUodGhpcywgb2JqLCBlbmRjYWxsYmFjayk7XG59O1xuXG5DYWxsQ29udGV4dC5wcm90b3R5cGUuY3JlYXRlQm9va21hcmsgPSBmdW5jdGlvbiAobmFtZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0aW9uQ29udGV4dC5jcmVhdGVCb29rbWFyayh0aGlzLmluc3RhbmNlSWQsIG5hbWUsIGNhbGxiYWNrKTtcbn07XG5cbkNhbGxDb250ZXh0LnByb3RvdHlwZS5yZXN1bWVCb29rbWFyayA9IGZ1bmN0aW9uIChuYW1lLCByZWFzb24sIHJlc3VsdCkge1xuICAgIHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQucmVzdW1lQm9va21hcmtJbnRlcm5hbCh0aGlzLCBuYW1lLCByZWFzb24sIHJlc3VsdCk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IENhbGxDb250ZXh0O1xuIl19
