"use strict";
var is = require("../common/is");
function CallContext(executionContext, activityOrActivityId, scope) {
  this._executionContext = executionContext;
  this._activity = activityOrActivityId ? this._asActivity(activityOrActivityId) : null;
  this._scope = scope ? scope : null;
  this._executionState = null;
}
Object.defineProperties(CallContext.prototype, {
  activityId: {get: function() {
      return this._activity ? this._activity.id : null;
    }},
  _parentActivityId: {get: function() {
      if (!this._activity)
        return null;
      var state = this._executionContext.getState(this.activityId);
      return state.parentActivityId;
    }},
  _scopeTree: {get: function() {
      return this._executionContext._scopeTree;
    }},
  activity: {get: function() {
      return this._activity;
    }},
  executionContext: {get: function() {
      return this._executionContext;
    }},
  executionState: {get: function() {
      return this._executionState || (this._activity ? (this._executionState = this._executionContext.getState(this._activity.id)) : null);
    }},
  scope: {get: function() {
      return this._scope || (this._scope = this._scopeTree.find(this.activityId));
    }}
});
CallContext.prototype.next = function(childActivityOrActivityId) {
  var child = this._asActivity(childActivityOrActivityId);
  return new CallContext(this._executionContext, child, this._scopeTree.next(this.activityId, child.id, child.createScopePart()));
};
CallContext.prototype.back = function(keepScope) {
  var parentId = this._parentActivityId;
  if (parentId) {
    return new CallContext(this._executionContext, parentId, this._scopeTree.back(this.activityId, keepScope));
  } else {
    return null;
  }
};
CallContext.prototype._asActivity = function(activityOrActivityId) {
  return is.activity(activityOrActivityId) ? activityOrActivityId : this._executionContext._getKnownActivity(activityOrActivityId);
};
CallContext.prototype.complete = function(result) {
  this.activity.complete(this, result);
};
CallContext.prototype.cancel = function() {
  this.activity.cancel(this);
};
CallContext.prototype.idle = function() {
  this.activity.idle(this);
};
CallContext.prototype.fail = function(e) {
  this.activity.fail(this, e);
};
CallContext.prototype.end = function(reason, result) {
  this.activity.end(this, reason, result);
};
CallContext.prototype.schedule = function(obj, endcallback) {
  this.activity.schedule(this, obj, endcallback);
};
CallContext.prototype.createBookmark = function(name, callback) {
  return this._executionContext.createBookmark(this.activityId, name, callback);
};
CallContext.prototype.resumeBookmark = function(name, reason, result) {
  this._executionContext.resumeBookmarkInternal(this, name, reason, result);
};
module.exports = CallContext;
//# sourceMappingURL=data:application/json;base64,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QVMsSUFBSSxBQUFDLENBQUMsSUFBRyxDQUFHLE9BQUssQ0FBRyxPQUFLLENBQUMsQ0FBQztBQUMzQyxDQUFBO0FBRUEsVUFBVSxVQUFVLFNBQVMsRUFBSSxVQUFVLEdBQUUsQ0FBRyxDQUFBLFdBQVUsQ0FBRztBQUN6RCxLQUFHLFNBQVMsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFHLElBQUUsQ0FBRyxZQUFVLENBQUMsQ0FBQztBQUNsRCxDQUFBO0FBRUEsVUFBVSxVQUFVLGVBQWUsRUFBSSxVQUFVLElBQUcsQ0FBRyxDQUFBLFFBQU8sQ0FBRztBQUM3RCxPQUFPLENBQUEsSUFBRyxrQkFBa0IsZUFBZSxBQUFDLENBQUMsSUFBRyxXQUFXLENBQUcsS0FBRyxDQUFHLFNBQU8sQ0FBQyxDQUFDO0FBQ2pGLENBQUE7QUFFQSxVQUFVLFVBQVUsZUFBZSxFQUFJLFVBQVUsSUFBRyxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQ25FLEtBQUcsa0JBQWtCLHVCQUF1QixBQUFDLENBQUMsSUFBRyxDQUFHLEtBQUcsQ0FBRyxPQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7QUFDN0UsQ0FBQTtBQUVBLEtBQUssUUFBUSxFQUFJLFlBQVUsQ0FBQztBQUM1QiIsImZpbGUiOiJhY3Rpdml0aWVzL2NhbGxDb250ZXh0LmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgaXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2lzXCIpO1xyXG5cclxuZnVuY3Rpb24gQ2FsbENvbnRleHQoZXhlY3V0aW9uQ29udGV4dCwgYWN0aXZpdHlPckFjdGl2aXR5SWQsIHNjb3BlKSB7XHJcbiAgICB0aGlzLl9leGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDtcclxuICAgIHRoaXMuX2FjdGl2aXR5ID0gYWN0aXZpdHlPckFjdGl2aXR5SWQgPyB0aGlzLl9hc0FjdGl2aXR5KGFjdGl2aXR5T3JBY3Rpdml0eUlkKSA6IG51bGw7XHJcbiAgICB0aGlzLl9zY29wZSA9IHNjb3BlID8gc2NvcGUgOiBudWxsO1xyXG4gICAgdGhpcy5fZXhlY3V0aW9uU3RhdGUgPSBudWxsO1xyXG59XHJcblxyXG5PYmplY3QuZGVmaW5lUHJvcGVydGllcyhcclxuICAgIENhbGxDb250ZXh0LnByb3RvdHlwZSxcclxuICAgIHtcclxuICAgICAgICBhY3Rpdml0eUlkOiB7XHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FjdGl2aXR5ID8gdGhpcy5fYWN0aXZpdHkuaWQgOiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfcGFyZW50QWN0aXZpdHlJZDoge1xyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYWN0aXZpdHkpIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gdGhpcy5fZXhlY3V0aW9uQ29udGV4dC5nZXRTdGF0ZSh0aGlzLmFjdGl2aXR5SWQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnBhcmVudEFjdGl2aXR5SWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIF9zY29wZVRyZWU6IHtcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0aW9uQ29udGV4dC5fc2NvcGVUcmVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBhY3Rpdml0eToge1xyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9hY3Rpdml0eTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY3V0aW9uQ29udGV4dDoge1xyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRpb25Db250ZXh0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjdXRpb25TdGF0ZToge1xyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRpb25TdGF0ZSB8fCAodGhpcy5fYWN0aXZpdHkgPyAodGhpcy5fZXhlY3V0aW9uU3RhdGUgPSB0aGlzLl9leGVjdXRpb25Db250ZXh0LmdldFN0YXRlKHRoaXMuX2FjdGl2aXR5LmlkKSkgOiBudWxsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2NvcGU6IHtcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fc2NvcGUgfHwgKHRoaXMuX3Njb3BlID0gdGhpcy5fc2NvcGVUcmVlLmZpbmQodGhpcy5hY3Rpdml0eUlkKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbik7XHJcblxyXG5DYWxsQ29udGV4dC5wcm90b3R5cGUubmV4dCA9IGZ1bmN0aW9uIChjaGlsZEFjdGl2aXR5T3JBY3Rpdml0eUlkKSB7XHJcbiAgICB2YXIgY2hpbGQgPSB0aGlzLl9hc0FjdGl2aXR5KGNoaWxkQWN0aXZpdHlPckFjdGl2aXR5SWQpO1xyXG4gICAgcmV0dXJuIG5ldyBDYWxsQ29udGV4dChcclxuICAgICAgICB0aGlzLl9leGVjdXRpb25Db250ZXh0LFxyXG4gICAgICAgIGNoaWxkLFxyXG4gICAgICAgIHRoaXMuX3Njb3BlVHJlZS5uZXh0KHRoaXMuYWN0aXZpdHlJZCwgY2hpbGQuaWQsIGNoaWxkLmNyZWF0ZVNjb3BlUGFydCgpKSk7XHJcbn1cclxuXHJcbkNhbGxDb250ZXh0LnByb3RvdHlwZS5iYWNrID0gZnVuY3Rpb24gKGtlZXBTY29wZSkge1xyXG4gICAgdmFyIHBhcmVudElkID0gdGhpcy5fcGFyZW50QWN0aXZpdHlJZDtcclxuICAgIGlmIChwYXJlbnRJZCkge1xyXG4gICAgICAgIHJldHVybiBuZXcgQ2FsbENvbnRleHQoXHJcbiAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQsXHJcbiAgICAgICAgICAgIHBhcmVudElkLFxyXG4gICAgICAgICAgICB0aGlzLl9zY29wZVRyZWUuYmFjayh0aGlzLmFjdGl2aXR5SWQsIGtlZXBTY29wZSkpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbn1cclxuXHJcbkNhbGxDb250ZXh0LnByb3RvdHlwZS5fYXNBY3Rpdml0eSA9IGZ1bmN0aW9uIChhY3Rpdml0eU9yQWN0aXZpdHlJZCkge1xyXG4gICAgcmV0dXJuIGlzLmFjdGl2aXR5KGFjdGl2aXR5T3JBY3Rpdml0eUlkKSA/IGFjdGl2aXR5T3JBY3Rpdml0eUlkIDogdGhpcy5fZXhlY3V0aW9uQ29udGV4dC5fZ2V0S25vd25BY3Rpdml0eShhY3Rpdml0eU9yQWN0aXZpdHlJZCk7XHJcbn1cclxuXHJcbi8qIENhbGxiYWNrcyAqL1xyXG5cclxuQ2FsbENvbnRleHQucHJvdG90eXBlLmNvbXBsZXRlID0gZnVuY3Rpb24gKHJlc3VsdCkge1xyXG4gICAgdGhpcy5hY3Rpdml0eS5jb21wbGV0ZSh0aGlzLCByZXN1bHQpO1xyXG59XHJcblxyXG5DYWxsQ29udGV4dC5wcm90b3R5cGUuY2FuY2VsID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdGhpcy5hY3Rpdml0eS5jYW5jZWwodGhpcyk7XHJcbn1cclxuXHJcbkNhbGxDb250ZXh0LnByb3RvdHlwZS5pZGxlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdGhpcy5hY3Rpdml0eS5pZGxlKHRoaXMpO1xyXG59XHJcblxyXG5DYWxsQ29udGV4dC5wcm90b3R5cGUuZmFpbCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICB0aGlzLmFjdGl2aXR5LmZhaWwodGhpcywgZSk7XHJcbn1cclxuXHJcbkNhbGxDb250ZXh0LnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbiAocmVhc29uLCByZXN1bHQpIHtcclxuICAgIHRoaXMuYWN0aXZpdHkuZW5kKHRoaXMsIHJlYXNvbiwgcmVzdWx0KTtcclxufVxyXG5cclxuQ2FsbENvbnRleHQucHJvdG90eXBlLnNjaGVkdWxlID0gZnVuY3Rpb24gKG9iaiwgZW5kY2FsbGJhY2spIHtcclxuICAgIHRoaXMuYWN0aXZpdHkuc2NoZWR1bGUodGhpcywgb2JqLCBlbmRjYWxsYmFjayk7XHJcbn1cclxuXHJcbkNhbGxDb250ZXh0LnByb3RvdHlwZS5jcmVhdGVCb29rbWFyayA9IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaykge1xyXG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQuY3JlYXRlQm9va21hcmsodGhpcy5hY3Rpdml0eUlkLCBuYW1lLCBjYWxsYmFjayk7XHJcbn1cclxuXHJcbkNhbGxDb250ZXh0LnByb3RvdHlwZS5yZXN1bWVCb29rbWFyayA9IGZ1bmN0aW9uIChuYW1lLCByZWFzb24sIHJlc3VsdCkge1xyXG4gICAgdGhpcy5fZXhlY3V0aW9uQ29udGV4dC5yZXN1bWVCb29rbWFya0ludGVybmFsKHRoaXMsIG5hbWUsIHJlYXNvbiwgcmVzdWx0KTtcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBDYWxsQ29udGV4dDtcclxuIl19
