"use strict";
var ScopeNode = require("./scopeNode");
var guids = require("../common/guids");
var _ = require("lodash");
var specStrings = require("../common/specStrings");
var errors = require("../common/errors");
var is = require("../common/is");
var scope = require("./scope");
var Expression = require("./expression");
var scopeSerializer = require("./scopeSerializer");
function ScopeTree(initialScope, getActivityByIdFunc) {
  this._initialNode = new ScopeNode(guids.ids.initialScope, initialScope);
  this._nodes = new Map();
  this._nodes.set(this._initialNode.instanceId, this._initialNode);
  this._getActivityById = getActivityByIdFunc;
}
ScopeTree.prototype.getExecutionState = function(execContext, enablePromotions) {
  return scopeSerializer.serialize(execContext, this._getActivityById, enablePromotions, this._nodes.values());
};
ScopeTree.prototype.setState = function(json) {
  if (!_.isArray(json)) {
    throw new TypeError("Array argument expected.");
  }
  if (this._nodes.count !== 1) {
    var prev = this._nodes;
    this._nodes = new Map();
    this._nodes.set(guids.ids.initialScope, prev.get(guids.ids.initialScope));
    this._initialNode.clearChildren();
  }
  try {
    var $__3 = true;
    var $__4 = false;
    var $__5 = undefined;
    try {
      for (var $__1 = void 0,
          $__0 = (scopeSerializer.deserializeNodes(this._getActivityById, json))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
        var node = $__1.value;
        {
          this._nodes.set(node.instanceId, node);
        }
      }
    } catch ($__6) {
      $__4 = true;
      $__5 = $__6;
    } finally {
      try {
        if (!$__3 && $__0.return != null) {
          $__0.return();
        }
      } finally {
        if ($__4) {
          throw $__5;
        }
      }
    }
    var $__10 = true;
    var $__11 = false;
    var $__12 = undefined;
    try {
      for (var $__8 = void 0,
          $__7 = (json)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__10 = ($__8 = $__7.next()).done); $__10 = true) {
        var item = $__8.value;
        {
          this._nodes.get(item.instanceId).parent = this._nodes.get(item.parentId);
        }
      }
    } catch ($__13) {
      $__11 = true;
      $__12 = $__13;
    } finally {
      try {
        if (!$__10 && $__7.return != null) {
          $__7.return();
        }
      } finally {
        if ($__11) {
          throw $__12;
        }
      }
    }
  } catch (e) {
    throw new errors.WorkflowError("Cannot restore state tree, because data is corrupt. Inner error: " + e.stack);
  }
};
ScopeTree.prototype._getRealParent = function(currentNode) {
  var parent = currentNode.parent;
  if (this._getActivityById(currentNode.instanceId) instanceof Expression) {
    parent = parent.parent;
  }
  return parent;
};
ScopeTree.prototype.hasProperty = function(currentNode, name, noWalk) {
  if (name === "$parent") {
    var parent = this._getRealParent(currentNode);
    if (parent && parent !== this._initialNode) {
      return !!parent;
    }
  }
  if (name === "$activity") {
    return true;
  }
  var found = false;
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (currentNode.walkToRoot(noWalk))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var node = $__1.value;
      {
        if (node.isPropertyExists(name)) {
          found = true;
          break;
        }
        if (node.userId === name) {
          found = true;
          break;
        }
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
  return found;
};
ScopeTree.prototype.getValue = function(currentNode, name, noWalk) {
  var self = this;
  if (name === "$parent") {
    var parent = this._getRealParent(currentNode);
    if (parent && parent !== this._initialNode) {
      return scope.create(this, parent, true);
    } else {
      return undefined;
    }
  }
  if (name === "$activity") {
    return self._getActivityById(currentNode.instanceId);
  }
  var canReturnPrivate = true;
  var value;
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (currentNode.walkToRoot(noWalk))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var node = $__1.value;
      {
        if (!_.isUndefined(value = node.getPropertyValue(name, canReturnPrivate))) {
          break;
        }
        if (node.userId === name) {
          value = scope.create(self, node, true);
          break;
        }
        canReturnPrivate = false;
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
  return value;
};
ScopeTree.prototype.setValue = function(currentNode, name, value, noWalk) {
  if (this.isOnInitial) {
    throw new Error("Cannot set property of the initial scope.");
  }
  var self = this;
  var canSetPrivate = true;
  var setDone = false;
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (currentNode.walkToRoot(noWalk))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var node = $__1.value;
      {
        if (node === self._initialNode) {
          break;
        }
        if (node.setPropertyValue(name, value, canSetPrivate)) {
          setDone = true;
          break;
        }
        canSetPrivate = false;
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
  if (!setDone) {
    currentNode.createPropertyWithValue(name, value);
  }
  return true;
};
ScopeTree.prototype.deleteProperty = function(currentNode, name, noWalk) {
  var self = this;
  var canDeletePrivate = true;
  var deleteDone = false;
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (currentNode.walkToRoot(noWalk))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var node = $__1.value;
      {
        if (node === self._initialNode) {
          break;
        }
        if (node.deleteProperty(name, canDeletePrivate)) {
          deleteDone = true;
          break;
        }
        canDeletePrivate = false;
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
  return deleteDone;
};
ScopeTree.prototype.enumeratePropertyNames = $traceurRuntime.initGeneratorFunction(function $__14(currentNode, noWalk) {
  var canEnumeratePrivate,
      node,
      $__15,
      $__16;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          canEnumeratePrivate = true;
          node = currentNode;
          $ctx.state = 35;
          break;
        case 35:
          $ctx.state = 2;
          return "$parent";
        case 2:
          $ctx.maybeThrow();
          $ctx.state = 4;
          break;
        case 4:
          $ctx.state = 6;
          return "$activity";
        case 6:
          $ctx.maybeThrow();
          $ctx.state = 8;
          break;
        case 8:
          $ctx.state = (node.userId) ? 9 : 12;
          break;
        case 9:
          $ctx.state = 10;
          return node.userId;
        case 10:
          $ctx.maybeThrow();
          $ctx.state = 12;
          break;
        case 12:
          $__15 = $ctx.wrapYieldStar(node.enumeratePropertyNames(canEnumeratePrivate)[Symbol.iterator]());
          $ctx.sent = void 0;
          $ctx.action = 'next';
          $ctx.state = 25;
          break;
        case 25:
          $__16 = $__15[$ctx.action]($ctx.sentIgnoreThrow);
          $ctx.state = 22;
          break;
        case 22:
          $ctx.state = ($__16.done) ? 16 : 15;
          break;
        case 16:
          $ctx.sent = $__16.value;
          $ctx.state = 23;
          break;
        case 15:
          $ctx.state = 25;
          return $__16.value;
        case 23:
          canEnumeratePrivate = false;
          $ctx.state = 30;
          break;
        case 30:
          $ctx.state = (noWalk) ? -2 : 27;
          break;
        case 27:
          node = node.parent;
          $ctx.state = 32;
          break;
        case 32:
          $ctx.state = (node) ? 35 : -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__14, this);
});
ScopeTree.prototype.next = function(nodeInstanceId, childInstanceId, scopePart, childUserId) {
  var currentNode = this._getNodeByExternalId(nodeInstanceId);
  var nextNode = new ScopeNode(childInstanceId, scopePart, childUserId);
  currentNode.addChild(nextNode);
  this._nodes.set(childInstanceId, nextNode);
  return scope.create(this, nextNode);
};
ScopeTree.prototype.back = function(nodeId, keepItem) {
  var currentNode = this._getNodeByExternalId(nodeId);
  if (currentNode === this._initialNode) {
    throw new Error("Cannot go back because current scope is the initial scope.");
  }
  var toRemove = currentNode;
  var goTo = toRemove.parent;
  currentNode = goTo;
  if (!keepItem) {
    goTo.removeChild(toRemove);
    this._nodes.delete(toRemove.instanceId);
  }
  return scope.create(this, currentNode);
};
ScopeTree.prototype.find = function(nodeId) {
  var currentNode = this._getNodeByExternalId(nodeId);
  return scope.create(this, currentNode);
};
ScopeTree.prototype.findPart = function(nodeId) {
  var currentNode = this._getNodeByExternalId(nodeId);
  if (currentNode !== this._initialNode) {
    return currentNode.scopePart;
  }
  return null;
};
ScopeTree.prototype._getNodeByExternalId = function(id) {
  if (id === null) {
    return this._initialNode;
  }
  var node = this._nodes.get(id);
  if (!node) {
    throw new Error("Scope node for activity id '" + id + "' is not found.");
  }
  return node;
};
ScopeTree.prototype.deleteScopePart = function(currentNodeId, id) {
  var self = this;
  var currentNode = this._getNodeByExternalId(currentNodeId);
  var delNode = self._nodes.get(id);
  if (delNode) {
    if (delNode === self._initialNode) {
      throw new Error("Cannot delete the initial scope.");
    }
    var found = false;
    var $__3 = true;
    var $__4 = false;
    var $__5 = undefined;
    try {
      for (var $__1 = void 0,
          $__0 = (delNode.walkToRoot())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
        var node = $__1.value;
        {
          if (node === currentNode) {
            found = true;
            break;
          }
        }
      }
    } catch ($__6) {
      $__4 = true;
      $__5 = $__6;
    } finally {
      try {
        if (!$__3 && $__0.return != null) {
          $__0.return();
        }
      } finally {
        if ($__4) {
          throw $__5;
        }
      }
    }
    if (!found) {
      throw new Error("Cannot delete scope, because current active scope is inside in it.");
    }
    delNode.parent.removeChild(delNode);
    self._removeAllNodes(delNode);
  }
};
ScopeTree.prototype._removeAllNodes = function(node) {
  var self = this;
  self._nodes.delete(node.instanceId);
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (node.children())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var c = $__1.value;
      {
        self._removeAllNodes(c);
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
};
module.exports = ScopeTree;
//# sourceMappingURL=data:application/json;base64,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QUM3QixBQUFJLElBQUEsT0FBb0IsVUFBUSxDQUFDO0FBQ2pDLElBQUk7QUFISixRQUFTLEdBQUEsT0FEakIsS0FBSyxFQUFBLEFBQzRCO0FBQ2hCLGFBQW9CLENBQUEsQ0FxUW5CLElBQUcsU0FBUyxBQUFDLEVBQUMsQ0FyUXVCLENBQ2xDLGVBQWMsV0FBVyxBQUFDLENBQUMsTUFBSyxTQUFTLENBQUMsQ0FBQyxBQUFDLEVBQUMsQ0FDckQsRUFBQyxDQUFDLE1BQW9CLENBQUEsQ0FBQyxNQUFvQixDQUFBLFNBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RSxPQUFvQixLQUFHLENBQUc7UUFrUTFCLEVBQUE7QUFBc0I7QUFDM0IsV0FBRyxnQkFBZ0IsQUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDO01BQzNCO0lBalFJO0FBQUEsRUFGQSxDQUFFLFlBQTBCO0FBQzFCLFNBQW9CLEtBQUcsQ0FBQztBQUN4QixjQUFvQyxDQUFDO0VBQ3ZDLENBQUUsT0FBUTtBQUNSLE1BQUk7QUFDRixTQUFJLEtBQWlCLEdBQUssQ0FBQSxXQUF1QixHQUFLLEtBQUcsQ0FBRztBQUMxRCxrQkFBd0IsQUFBQyxFQUFDLENBQUM7TUFDN0I7QUFBQSxJQUNGLENBQUUsT0FBUTtBQUNSLGNBQXdCO0FBQ3RCLGtCQUF3QjtNQUMxQjtBQUFBLElBQ0Y7QUFBQSxFQUNGO0FBQUEsQUF1UFIsQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLFVBQVEsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvc2NvcGVUcmVlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IFNjb3BlTm9kZSA9IHJlcXVpcmUoXCIuL3Njb3BlTm9kZVwiKTtcbmxldCBndWlkcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZ3VpZHNcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgc3BlY1N0cmluZ3MgPSByZXF1aXJlKFwiLi4vY29tbW9uL3NwZWNTdHJpbmdzXCIpO1xubGV0IGVycm9ycyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZXJyb3JzXCIpO1xubGV0IGlzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9pc1wiKTtcbmxldCBzY29wZSA9IHJlcXVpcmUoXCIuL3Njb3BlXCIpO1xubGV0IEV4cHJlc3Npb24gPSByZXF1aXJlKFwiLi9leHByZXNzaW9uXCIpO1xubGV0IHNjb3BlU2VyaWFsaXplciA9IHJlcXVpcmUoXCIuL3Njb3BlU2VyaWFsaXplclwiKTtcblxuZnVuY3Rpb24gU2NvcGVUcmVlKGluaXRpYWxTY29wZSwgZ2V0QWN0aXZpdHlCeUlkRnVuYykge1xuICAgIHRoaXMuX2luaXRpYWxOb2RlID0gbmV3IFNjb3BlTm9kZShndWlkcy5pZHMuaW5pdGlhbFNjb3BlLCBpbml0aWFsU2NvcGUpO1xuICAgIHRoaXMuX25vZGVzID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuX25vZGVzLnNldCh0aGlzLl9pbml0aWFsTm9kZS5pbnN0YW5jZUlkLCB0aGlzLl9pbml0aWFsTm9kZSk7XG4gICAgdGhpcy5fZ2V0QWN0aXZpdHlCeUlkID0gZ2V0QWN0aXZpdHlCeUlkRnVuYztcbn1cblxuLyogU0VSSUFMSVpBVElPTiAqL1xuU2NvcGVUcmVlLnByb3RvdHlwZS5nZXRFeGVjdXRpb25TdGF0ZSA9IGZ1bmN0aW9uIChleGVjQ29udGV4dCwgZW5hYmxlUHJvbW90aW9ucykge1xuICAgIHJldHVybiBzY29wZVNlcmlhbGl6ZXIuc2VyaWFsaXplKGV4ZWNDb250ZXh0LCB0aGlzLl9nZXRBY3Rpdml0eUJ5SWQsIGVuYWJsZVByb21vdGlvbnMsIHRoaXMuX25vZGVzLnZhbHVlcygpKTtcbn07XG5cblNjb3BlVHJlZS5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbiAoanNvbikge1xuICAgIGlmICghXy5pc0FycmF5KGpzb24pKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcnJheSBhcmd1bWVudCBleHBlY3RlZC5cIik7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX25vZGVzLmNvdW50ICE9PSAxKSB7XG4gICAgICAgIGxldCBwcmV2ID0gdGhpcy5fbm9kZXM7XG4gICAgICAgIHRoaXMuX25vZGVzID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLl9ub2Rlcy5zZXQoZ3VpZHMuaWRzLmluaXRpYWxTY29wZSwgcHJldi5nZXQoZ3VpZHMuaWRzLmluaXRpYWxTY29wZSkpO1xuICAgICAgICB0aGlzLl9pbml0aWFsTm9kZS5jbGVhckNoaWxkcmVuKCk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgICAgLy8gQ3JlYXRlIG5vZGVzOlxuICAgICAgICBmb3IgKGxldCBub2RlIG9mIHNjb3BlU2VyaWFsaXplci5kZXNlcmlhbGl6ZU5vZGVzKHRoaXMuX2dldEFjdGl2aXR5QnlJZCwganNvbikpIHtcbiAgICAgICAgICAgIHRoaXMuX25vZGVzLnNldChub2RlLmluc3RhbmNlSWQsIG5vZGUpO1xuICAgICAgICB9XG4gICAgICAgIC8vIFNldHVwIFRyZWU6XG4gICAgICAgIGZvciAobGV0IGl0ZW0gb2YganNvbikge1xuICAgICAgICAgICAgdGhpcy5fbm9kZXMuZ2V0KGl0ZW0uaW5zdGFuY2VJZCkucGFyZW50ID0gdGhpcy5fbm9kZXMuZ2V0KGl0ZW0ucGFyZW50SWQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuV29ya2Zsb3dFcnJvcihcIkNhbm5vdCByZXN0b3JlIHN0YXRlIHRyZWUsIGJlY2F1c2UgZGF0YSBpcyBjb3JydXB0LiBJbm5lciBlcnJvcjogXCIgKyBlLnN0YWNrKTtcbiAgICB9XG59O1xuLyogU0VSSUFMSVpBVElPTiAqL1xuXG4vKiBQUk9YWSAqL1xuXG5TY29wZVRyZWUucHJvdG90eXBlLl9nZXRSZWFsUGFyZW50ID0gZnVuY3Rpb24gKGN1cnJlbnROb2RlKSB7XG4gICAgbGV0IHBhcmVudCA9IGN1cnJlbnROb2RlLnBhcmVudDtcbiAgICBpZiAodGhpcy5fZ2V0QWN0aXZpdHlCeUlkKGN1cnJlbnROb2RlLmluc3RhbmNlSWQpIGluc3RhbmNlb2YgRXhwcmVzc2lvbikge1xuICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50O1xuICAgIH1cbiAgICByZXR1cm4gcGFyZW50O1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5oYXNQcm9wZXJ0eSA9IGZ1bmN0aW9uIChjdXJyZW50Tm9kZSwgbmFtZSwgbm9XYWxrKSB7XG4gICAgaWYgKG5hbWUgPT09IFwiJHBhcmVudFwiKSB7XG4gICAgICAgIGxldCBwYXJlbnQgPSB0aGlzLl9nZXRSZWFsUGFyZW50KGN1cnJlbnROb2RlKTtcbiAgICAgICAgaWYgKHBhcmVudCAmJiBwYXJlbnQgIT09IHRoaXMuX2luaXRpYWxOb2RlKSB7XG4gICAgICAgICAgICByZXR1cm4gISFwYXJlbnQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobmFtZSA9PT0gXCIkYWN0aXZpdHlcIikge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICBmb3IgKGxldCBub2RlIG9mIGN1cnJlbnROb2RlLndhbGtUb1Jvb3Qobm9XYWxrKSkge1xuICAgICAgICBpZiAobm9kZS5pc1Byb3BlcnR5RXhpc3RzKG5hbWUpKSB7XG4gICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBpZiAobm9kZS51c2VySWQgPT09IG5hbWUpIHtcbiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmb3VuZDtcbn07XG5cblNjb3BlVHJlZS5wcm90b3R5cGUuZ2V0VmFsdWUgPSBmdW5jdGlvbiAoY3VycmVudE5vZGUsIG5hbWUsIG5vV2Fsaykge1xuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIGlmIChuYW1lID09PSBcIiRwYXJlbnRcIikge1xuICAgICAgICBsZXQgcGFyZW50ID0gdGhpcy5fZ2V0UmVhbFBhcmVudChjdXJyZW50Tm9kZSk7XG4gICAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50ICE9PSB0aGlzLl9pbml0aWFsTm9kZSkge1xuICAgICAgICAgICAgcmV0dXJuIHNjb3BlLmNyZWF0ZSh0aGlzLCBwYXJlbnQsIHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmIChuYW1lID09PSBcIiRhY3Rpdml0eVwiKSB7XG4gICAgICAgIHJldHVybiBzZWxmLl9nZXRBY3Rpdml0eUJ5SWQoY3VycmVudE5vZGUuaW5zdGFuY2VJZCk7XG4gICAgfVxuXG4gICAgbGV0IGNhblJldHVyblByaXZhdGUgPSB0cnVlO1xuICAgIGxldCB2YWx1ZTtcbiAgICBmb3IgKGxldCBub2RlIG9mIGN1cnJlbnROb2RlLndhbGtUb1Jvb3Qobm9XYWxrKSkge1xuICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQodmFsdWUgPSBub2RlLmdldFByb3BlcnR5VmFsdWUobmFtZSwgY2FuUmV0dXJuUHJpdmF0ZSkpKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBpZiAobm9kZS51c2VySWQgPT09IG5hbWUpIHtcbiAgICAgICAgICAgIHZhbHVlID0gc2NvcGUuY3JlYXRlKHNlbGYsIG5vZGUsIHRydWUpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FuUmV0dXJuUHJpdmF0ZSA9IGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG59O1xuXG5TY29wZVRyZWUucHJvdG90eXBlLnNldFZhbHVlID0gZnVuY3Rpb24gKGN1cnJlbnROb2RlLCBuYW1lLCB2YWx1ZSwgbm9XYWxrKSB7XG4gICAgaWYgKHRoaXMuaXNPbkluaXRpYWwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IHNldCBwcm9wZXJ0eSBvZiB0aGUgaW5pdGlhbCBzY29wZS5cIik7XG4gICAgfVxuXG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIGxldCBjYW5TZXRQcml2YXRlID0gdHJ1ZTtcbiAgICBsZXQgc2V0RG9uZSA9IGZhbHNlO1xuICAgIGZvciAobGV0IG5vZGUgb2YgY3VycmVudE5vZGUud2Fsa1RvUm9vdChub1dhbGspKSB7XG4gICAgICAgIGlmIChub2RlID09PSBzZWxmLl9pbml0aWFsTm9kZSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGUuc2V0UHJvcGVydHlWYWx1ZShuYW1lLCB2YWx1ZSwgY2FuU2V0UHJpdmF0ZSkpIHtcbiAgICAgICAgICAgIHNldERvbmUgPSB0cnVlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FuU2V0UHJpdmF0ZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIGlmICghc2V0RG9uZSkge1xuICAgICAgICBjdXJyZW50Tm9kZS5jcmVhdGVQcm9wZXJ0eVdpdGhWYWx1ZShuYW1lLCB2YWx1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG59O1xuXG5TY29wZVRyZWUucHJvdG90eXBlLmRlbGV0ZVByb3BlcnR5ID0gZnVuY3Rpb24gKGN1cnJlbnROb2RlLCBuYW1lLCBub1dhbGspIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGNhbkRlbGV0ZVByaXZhdGUgPSB0cnVlO1xuICAgIGxldCBkZWxldGVEb25lID0gZmFsc2U7XG4gICAgZm9yIChsZXQgbm9kZSBvZiBjdXJyZW50Tm9kZS53YWxrVG9Sb290KG5vV2FsaykpIHtcbiAgICAgICAgaWYgKG5vZGUgPT09IHNlbGYuX2luaXRpYWxOb2RlKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBpZiAobm9kZS5kZWxldGVQcm9wZXJ0eShuYW1lLCBjYW5EZWxldGVQcml2YXRlKSkge1xuICAgICAgICAgICAgZGVsZXRlRG9uZSA9IHRydWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjYW5EZWxldGVQcml2YXRlID0gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlbGV0ZURvbmU7XG59O1xuXG5TY29wZVRyZWUucHJvdG90eXBlLmVudW1lcmF0ZVByb3BlcnR5TmFtZXMgPSBmdW5jdGlvbiogKGN1cnJlbnROb2RlLCBub1dhbGspIHtcbiAgICBsZXQgY2FuRW51bWVyYXRlUHJpdmF0ZSA9IHRydWU7XG4gICAgbGV0IG5vZGUgPSBjdXJyZW50Tm9kZTtcbiAgICBkb1xuICAgIHtcbiAgICAgICAgeWllbGQgXCIkcGFyZW50XCI7XG4gICAgICAgIHlpZWxkIFwiJGFjdGl2aXR5XCI7XG4gICAgICAgIGlmIChub2RlLnVzZXJJZCkge1xuICAgICAgICAgICAgeWllbGQgbm9kZS51c2VySWQ7XG4gICAgICAgIH1cbiAgICAgICAgeWllbGQqIG5vZGUuZW51bWVyYXRlUHJvcGVydHlOYW1lcyhjYW5FbnVtZXJhdGVQcml2YXRlKTtcbiAgICAgICAgY2FuRW51bWVyYXRlUHJpdmF0ZSA9IGZhbHNlO1xuXG4gICAgICAgIGlmIChub1dhbGspIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50O1xuICAgIH1cbiAgICB3aGlsZSAobm9kZSk7XG59O1xuLyogUFJPWFkgKi9cblxuLyogV0FMSyAqL1xuU2NvcGVUcmVlLnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gKG5vZGVJbnN0YW5jZUlkLCBjaGlsZEluc3RhbmNlSWQsIHNjb3BlUGFydCwgY2hpbGRVc2VySWQpIHtcbiAgICBsZXQgY3VycmVudE5vZGUgPSB0aGlzLl9nZXROb2RlQnlFeHRlcm5hbElkKG5vZGVJbnN0YW5jZUlkKTtcbiAgICBsZXQgbmV4dE5vZGUgPSBuZXcgU2NvcGVOb2RlKGNoaWxkSW5zdGFuY2VJZCwgc2NvcGVQYXJ0LCBjaGlsZFVzZXJJZCk7XG4gICAgY3VycmVudE5vZGUuYWRkQ2hpbGQobmV4dE5vZGUpO1xuICAgIHRoaXMuX25vZGVzLnNldChjaGlsZEluc3RhbmNlSWQsIG5leHROb2RlKTtcbiAgICByZXR1cm4gc2NvcGUuY3JlYXRlKHRoaXMsIG5leHROb2RlKTtcbn07XG5cblNjb3BlVHJlZS5wcm90b3R5cGUuYmFjayA9IGZ1bmN0aW9uIChub2RlSWQsIGtlZXBJdGVtKSB7XG4gICAgbGV0IGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChub2RlSWQpO1xuICAgIGlmIChjdXJyZW50Tm9kZSA9PT0gdGhpcy5faW5pdGlhbE5vZGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGdvIGJhY2sgYmVjYXVzZSBjdXJyZW50IHNjb3BlIGlzIHRoZSBpbml0aWFsIHNjb3BlLlwiKTtcbiAgICB9XG4gICAgbGV0IHRvUmVtb3ZlID0gY3VycmVudE5vZGU7XG4gICAgbGV0IGdvVG8gPSB0b1JlbW92ZS5wYXJlbnQ7XG4gICAgY3VycmVudE5vZGUgPSBnb1RvO1xuICAgIGlmICgha2VlcEl0ZW0pIHtcbiAgICAgICAgZ29Uby5yZW1vdmVDaGlsZCh0b1JlbW92ZSk7XG4gICAgICAgIHRoaXMuX25vZGVzLmRlbGV0ZSh0b1JlbW92ZS5pbnN0YW5jZUlkKTtcbiAgICB9XG4gICAgcmV0dXJuIHNjb3BlLmNyZWF0ZSh0aGlzLCBjdXJyZW50Tm9kZSk7XG59O1xuXG5TY29wZVRyZWUucHJvdG90eXBlLmZpbmQgPSBmdW5jdGlvbiAobm9kZUlkKSB7XG4gICAgbGV0IGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChub2RlSWQpO1xuICAgIHJldHVybiBzY29wZS5jcmVhdGUodGhpcywgY3VycmVudE5vZGUpO1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5maW5kUGFydCA9IGZ1bmN0aW9uIChub2RlSWQpIHtcbiAgICBsZXQgY3VycmVudE5vZGUgPSB0aGlzLl9nZXROb2RlQnlFeHRlcm5hbElkKG5vZGVJZCk7XG4gICAgaWYgKGN1cnJlbnROb2RlICE9PSB0aGlzLl9pbml0aWFsTm9kZSkge1xuICAgICAgICByZXR1cm4gY3VycmVudE5vZGUuc2NvcGVQYXJ0O1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbn07XG4vKiBXQUxLICovXG5cblNjb3BlVHJlZS5wcm90b3R5cGUuX2dldE5vZGVCeUV4dGVybmFsSWQgPSBmdW5jdGlvbiAoaWQpIHtcbiAgICBpZiAoaWQgPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2luaXRpYWxOb2RlO1xuICAgIH1cbiAgICBsZXQgbm9kZSA9IHRoaXMuX25vZGVzLmdldChpZCk7XG4gICAgaWYgKCFub2RlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlNjb3BlIG5vZGUgZm9yIGFjdGl2aXR5IGlkICdcIiArIGlkICsgXCInIGlzIG5vdCBmb3VuZC5cIik7XG4gICAgfVxuICAgIHJldHVybiBub2RlO1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5kZWxldGVTY29wZVBhcnQgPSBmdW5jdGlvbiAoY3VycmVudE5vZGVJZCwgaWQpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChjdXJyZW50Tm9kZUlkKTtcbiAgICBsZXQgZGVsTm9kZSA9IHNlbGYuX25vZGVzLmdldChpZCk7XG4gICAgaWYgKGRlbE5vZGUpIHtcbiAgICAgICAgaWYgKGRlbE5vZGUgPT09IHNlbGYuX2luaXRpYWxOb2RlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgZGVsZXRlIHRoZSBpbml0aWFsIHNjb3BlLlwiKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICAgICAgZm9yIChsZXQgbm9kZSBvZiBkZWxOb2RlLndhbGtUb1Jvb3QoKSkge1xuICAgICAgICAgICAgaWYgKG5vZGUgPT09IGN1cnJlbnROb2RlKSB7XG4gICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBkZWxldGUgc2NvcGUsIGJlY2F1c2UgY3VycmVudCBhY3RpdmUgc2NvcGUgaXMgaW5zaWRlIGluIGl0LlwiKTtcbiAgICAgICAgfVxuICAgICAgICBkZWxOb2RlLnBhcmVudC5yZW1vdmVDaGlsZChkZWxOb2RlKTtcbiAgICAgICAgc2VsZi5fcmVtb3ZlQWxsTm9kZXMoZGVsTm9kZSk7XG4gICAgfVxufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5fcmVtb3ZlQWxsTm9kZXMgPSBmdW5jdGlvbiAobm9kZSkge1xuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIHNlbGYuX25vZGVzLmRlbGV0ZShub2RlLmluc3RhbmNlSWQpO1xuICAgIGZvciAobGV0IGMgb2Ygbm9kZS5jaGlsZHJlbigpKSB7XG4gICAgICAgIHNlbGYuX3JlbW92ZUFsbE5vZGVzKGMpO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gU2NvcGVUcmVlOyJdfQ==
