"use strict";
var ScopeNode = require("./scopeNode");
var guids = require("../common/guids");
var _ = require("lodash");
var specStrings = require("../common/specStrings");
var errors = require("../common/errors");
var is = require("../common/is");
var scope = require("./scope");
var Expression = require("./expression");
var scopeSerializer = require("./scopeSerializer");
function ScopeTree(initialScope, getActivityByIdFunc) {
  this._initialNode = new ScopeNode(guids.ids.initialScope, initialScope);
  this._nodes = new Map();
  this._nodes.set(this._initialNode.instanceId, this._initialNode);
  this._getActivityById = getActivityByIdFunc;
}
ScopeTree.prototype.getExecutionState = function(execContext, enablePromotions, serializer) {
  return scopeSerializer.serialize(execContext, this._getActivityById, enablePromotions, this._nodes.values(), serializer);
};
ScopeTree.prototype.setState = function(json, serializer) {
  if (!_.isArray(json)) {
    throw new TypeError("Array argument expected.");
  }
  if (this._nodes.count !== 1) {
    var prev = this._nodes;
    this._nodes = new Map();
    this._nodes.set(guids.ids.initialScope, prev.get(guids.ids.initialScope));
    this._initialNode.clearChildren();
  }
  try {
    var $__3 = true;
    var $__4 = false;
    var $__5 = undefined;
    try {
      for (var $__1 = void 0,
          $__0 = (scopeSerializer.deserializeNodes(this._getActivityById, json, serializer))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
        var node = $__1.value;
        {
          this._nodes.set(node.instanceId, node);
        }
      }
    } catch ($__6) {
      $__4 = true;
      $__5 = $__6;
    } finally {
      try {
        if (!$__3 && $__0.return != null) {
          $__0.return();
        }
      } finally {
        if ($__4) {
          throw $__5;
        }
      }
    }
    var $__10 = true;
    var $__11 = false;
    var $__12 = undefined;
    try {
      for (var $__8 = void 0,
          $__7 = (json)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__10 = ($__8 = $__7.next()).done); $__10 = true) {
        var item = $__8.value;
        {
          this._nodes.get(item.instanceId).parent = this._nodes.get(item.parentId);
        }
      }
    } catch ($__13) {
      $__11 = true;
      $__12 = $__13;
    } finally {
      try {
        if (!$__10 && $__7.return != null) {
          $__7.return();
        }
      } finally {
        if ($__11) {
          throw $__12;
        }
      }
    }
  } catch (e) {
    throw new errors.WorkflowError("Cannot restore state tree, because data is corrupt. Inner error: " + e.stack);
  }
};
ScopeTree.prototype._getRealParent = function(currentNode) {
  var parent = currentNode.parent;
  if (this._getActivityById(currentNode.instanceId) instanceof Expression) {
    parent = parent.parent;
  }
  return parent;
};
ScopeTree.prototype.hasProperty = function(currentNode, name, noWalk) {
  if (name === "$parent") {
    var parent = this._getRealParent(currentNode);
    if (parent && parent !== this._initialNode) {
      return !!parent;
    }
  }
  if (name === "$activity") {
    return true;
  }
  var found = false;
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (currentNode.walkToRoot(noWalk))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var node = $__1.value;
      {
        if (node.isPropertyExists(name)) {
          found = true;
          break;
        }
        if (node.userId === name) {
          found = true;
          break;
        }
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
  return found;
};
ScopeTree.prototype.getValue = function(currentNode, name, noWalk) {
  var self = this;
  if (name === "$parent") {
    var parent = this._getRealParent(currentNode);
    if (parent && parent !== this._initialNode) {
      var parentScope = scope.create(this, parent, true);
      parentScope.__marker = guids.markers.$parent;
      return parentScope;
    } else {
      return undefined;
    }
  }
  if (name === "$activity") {
    return self._getActivityById(currentNode.instanceId);
  }
  var canReturnPrivate = true;
  var value;
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (currentNode.walkToRoot(noWalk))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var node = $__1.value;
      {
        if (!_.isUndefined(value = node.getPropertyValue(name, canReturnPrivate))) {
          break;
        }
        if (node.userId === name && node !== currentNode) {
          value = scope.create(self, node, true);
          break;
        }
        canReturnPrivate = false;
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
  return value;
};
ScopeTree.prototype.setValue = function(currentNode, name, value, noWalk) {
  if (this.isOnInitial) {
    throw new Error("Cannot set property of the initial scope.");
  }
  var self = this;
  var canSetPrivate = true;
  var setDone = false;
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (currentNode.walkToRoot(noWalk))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var node = $__1.value;
      {
        if (node === self._initialNode) {
          break;
        }
        if (node.setPropertyValue(name, value, canSetPrivate)) {
          setDone = true;
          break;
        }
        canSetPrivate = false;
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
  if (!setDone) {
    currentNode.createPropertyWithValue(name, value);
  }
  return true;
};
ScopeTree.prototype.deleteProperty = function(currentNode, name, noWalk) {
  var self = this;
  var canDeletePrivate = true;
  var deleteDone = false;
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (currentNode.walkToRoot(noWalk))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var node = $__1.value;
      {
        if (node === self._initialNode) {
          break;
        }
        if (node.deleteProperty(name, canDeletePrivate)) {
          deleteDone = true;
          break;
        }
        canDeletePrivate = false;
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
  return deleteDone;
};
ScopeTree.prototype.enumeratePropertyNames = $traceurRuntime.initGeneratorFunction(function $__14(currentNode, noWalk) {
  var canEnumeratePrivate,
      node,
      $__15,
      $__16;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          canEnumeratePrivate = true;
          node = currentNode;
          $ctx.state = 35;
          break;
        case 35:
          $ctx.state = 2;
          return "$parent";
        case 2:
          $ctx.maybeThrow();
          $ctx.state = 4;
          break;
        case 4:
          $ctx.state = 6;
          return "$activity";
        case 6:
          $ctx.maybeThrow();
          $ctx.state = 8;
          break;
        case 8:
          $ctx.state = (node.userId) ? 9 : 12;
          break;
        case 9:
          $ctx.state = 10;
          return node.userId;
        case 10:
          $ctx.maybeThrow();
          $ctx.state = 12;
          break;
        case 12:
          $__15 = $ctx.wrapYieldStar(node.enumeratePropertyNames(canEnumeratePrivate)[Symbol.iterator]());
          $ctx.sent = void 0;
          $ctx.action = 'next';
          $ctx.state = 25;
          break;
        case 25:
          $__16 = $__15[$ctx.action]($ctx.sentIgnoreThrow);
          $ctx.state = 22;
          break;
        case 22:
          $ctx.state = ($__16.done) ? 16 : 15;
          break;
        case 16:
          $ctx.sent = $__16.value;
          $ctx.state = 23;
          break;
        case 15:
          $ctx.state = 25;
          return $__16.value;
        case 23:
          canEnumeratePrivate = false;
          $ctx.state = 30;
          break;
        case 30:
          $ctx.state = (noWalk) ? -2 : 27;
          break;
        case 27:
          node = node.parent;
          $ctx.state = 32;
          break;
        case 32:
          $ctx.state = (node) ? 35 : -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__14, this);
});
ScopeTree.prototype.next = function(nodeInstanceId, childInstanceId, scopePart, childUserId) {
  var currentNode = this._getNodeByExternalId(nodeInstanceId);
  var nextNode = new ScopeNode(childInstanceId, scopePart, childUserId);
  currentNode.addChild(nextNode);
  this._nodes.set(childInstanceId, nextNode);
  return scope.create(this, nextNode);
};
ScopeTree.prototype.back = function(nodeId, keepItem) {
  var currentNode = this._getNodeByExternalId(nodeId);
  if (currentNode === this._initialNode) {
    throw new Error("Cannot go back because current scope is the initial scope.");
  }
  var toRemove = currentNode;
  var goTo = toRemove.parent;
  currentNode = goTo;
  if (!keepItem) {
    goTo.removeChild(toRemove);
    this._nodes.delete(toRemove.instanceId);
  }
  return scope.create(this, currentNode);
};
ScopeTree.prototype.find = function(nodeId) {
  var currentNode = this._getNodeByExternalId(nodeId);
  return scope.create(this, currentNode);
};
ScopeTree.prototype.findPart = function(nodeId) {
  var currentNode = this._getNodeByExternalId(nodeId);
  if (currentNode !== this._initialNode) {
    return currentNode.scopePart;
  }
  return null;
};
ScopeTree.prototype._getNodeByExternalId = function(id) {
  if (id === null) {
    return this._initialNode;
  }
  var node = this._nodes.get(id);
  if (!node) {
    throw new Error("Scope node for activity id '" + id + "' is not found.");
  }
  return node;
};
ScopeTree.prototype.deleteScopePart = function(currentNodeId, id) {
  var self = this;
  var currentNode = this._getNodeByExternalId(currentNodeId);
  var delNode = self._nodes.get(id);
  if (delNode) {
    if (delNode === self._initialNode) {
      throw new Error("Cannot delete the initial scope.");
    }
    var found = false;
    var $__3 = true;
    var $__4 = false;
    var $__5 = undefined;
    try {
      for (var $__1 = void 0,
          $__0 = (delNode.walkToRoot())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
        var node = $__1.value;
        {
          if (node === currentNode) {
            found = true;
            break;
          }
        }
      }
    } catch ($__6) {
      $__4 = true;
      $__5 = $__6;
    } finally {
      try {
        if (!$__3 && $__0.return != null) {
          $__0.return();
        }
      } finally {
        if ($__4) {
          throw $__5;
        }
      }
    }
    if (!found) {
      throw new Error("Cannot delete scope, because current active scope is inside in it.");
    }
    delNode.parent.removeChild(delNode);
    self._removeAllNodes(delNode);
  }
};
ScopeTree.prototype._removeAllNodes = function(node) {
  var self = this;
  self._nodes.delete(node.instanceId);
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (node.children())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var c = $__1.value;
      {
        self._removeAllNodes(c);
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
};
module.exports = ScopeTree;
//# sourceMappingURL=data:application/json;base64,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LFVBQVUsSUFBRztBQUMvQyxBQUFJLElBQUEsQ0FBQSxJQUFHLEVBQUksS0FBRyxDQUFDO0FBRWYsS0FBRyxPQUFPLE9BQU8sQUFBQyxDQUFDLElBQUcsV0FBVyxDQUFDLENBQUM7QUF2US9CLEFBQUksSUFBQSxPQUFvQixLQUFHLENBQUM7QUFDNUIsQUFBSSxJQUFBLE9BQW9CLE1BQUksQ0FBQztBQUM3QixBQUFJLElBQUEsT0FBb0IsVUFBUSxDQUFDO0FBQ2pDLElBQUk7QUFISixRQUFTLEdBQUEsT0FEakIsS0FBSyxFQUFBLEFBQzRCO0FBQ2hCLGFBQW9CLENBQUEsQ0F1UW5CLElBQUcsU0FBUyxBQUFDLEVBQUMsQ0F2UXVCLENBQ2xDLGVBQWMsV0FBVyxBQUFDLENBQUMsTUFBSyxTQUFTLENBQUMsQ0FBQyxBQUFDLEVBQUMsQ0FDckQsRUFBQyxDQUFDLE1BQW9CLENBQUEsQ0FBQyxNQUFvQixDQUFBLFNBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RSxPQUFvQixLQUFHLENBQUc7UUFvUTFCLEVBQUE7QUFBc0I7QUFDM0IsV0FBRyxnQkFBZ0IsQUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDO01BQzNCO0lBblFJO0FBQUEsRUFGQSxDQUFFLFlBQTBCO0FBQzFCLFNBQW9CLEtBQUcsQ0FBQztBQUN4QixjQUFvQyxDQUFDO0VBQ3ZDLENBQUUsT0FBUTtBQUNSLE1BQUk7QUFDRixTQUFJLEtBQWlCLEdBQUssQ0FBQSxXQUF1QixHQUFLLEtBQUcsQ0FBRztBQUMxRCxrQkFBd0IsQUFBQyxFQUFDLENBQUM7TUFDN0I7QUFBQSxJQUNGLENBQUUsT0FBUTtBQUNSLGNBQXdCO0FBQ3RCLGtCQUF3QjtNQUMxQjtBQUFBLElBQ0Y7QUFBQSxFQUNGO0FBQUEsQUF5UFIsQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLFVBQVEsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvc2NvcGVUcmVlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IFNjb3BlTm9kZSA9IHJlcXVpcmUoXCIuL3Njb3BlTm9kZVwiKTtcbmxldCBndWlkcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZ3VpZHNcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgc3BlY1N0cmluZ3MgPSByZXF1aXJlKFwiLi4vY29tbW9uL3NwZWNTdHJpbmdzXCIpO1xubGV0IGVycm9ycyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZXJyb3JzXCIpO1xubGV0IGlzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9pc1wiKTtcbmxldCBzY29wZSA9IHJlcXVpcmUoXCIuL3Njb3BlXCIpO1xubGV0IEV4cHJlc3Npb24gPSByZXF1aXJlKFwiLi9leHByZXNzaW9uXCIpO1xubGV0IHNjb3BlU2VyaWFsaXplciA9IHJlcXVpcmUoXCIuL3Njb3BlU2VyaWFsaXplclwiKTtcblxuZnVuY3Rpb24gU2NvcGVUcmVlKGluaXRpYWxTY29wZSwgZ2V0QWN0aXZpdHlCeUlkRnVuYykge1xuICAgIHRoaXMuX2luaXRpYWxOb2RlID0gbmV3IFNjb3BlTm9kZShndWlkcy5pZHMuaW5pdGlhbFNjb3BlLCBpbml0aWFsU2NvcGUpO1xuICAgIHRoaXMuX25vZGVzID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuX25vZGVzLnNldCh0aGlzLl9pbml0aWFsTm9kZS5pbnN0YW5jZUlkLCB0aGlzLl9pbml0aWFsTm9kZSk7XG4gICAgdGhpcy5fZ2V0QWN0aXZpdHlCeUlkID0gZ2V0QWN0aXZpdHlCeUlkRnVuYztcbn1cblxuLyogU0VSSUFMSVpBVElPTiAqL1xuU2NvcGVUcmVlLnByb3RvdHlwZS5nZXRFeGVjdXRpb25TdGF0ZSA9IGZ1bmN0aW9uIChleGVjQ29udGV4dCwgZW5hYmxlUHJvbW90aW9ucywgc2VyaWFsaXplcikge1xuICAgIHJldHVybiBzY29wZVNlcmlhbGl6ZXIuc2VyaWFsaXplKGV4ZWNDb250ZXh0LCB0aGlzLl9nZXRBY3Rpdml0eUJ5SWQsIGVuYWJsZVByb21vdGlvbnMsIHRoaXMuX25vZGVzLnZhbHVlcygpLCBzZXJpYWxpemVyKTtcbn07XG5cblNjb3BlVHJlZS5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbiAoanNvbiwgc2VyaWFsaXplcikge1xuICAgIGlmICghXy5pc0FycmF5KGpzb24pKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcnJheSBhcmd1bWVudCBleHBlY3RlZC5cIik7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX25vZGVzLmNvdW50ICE9PSAxKSB7XG4gICAgICAgIGxldCBwcmV2ID0gdGhpcy5fbm9kZXM7XG4gICAgICAgIHRoaXMuX25vZGVzID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLl9ub2Rlcy5zZXQoZ3VpZHMuaWRzLmluaXRpYWxTY29wZSwgcHJldi5nZXQoZ3VpZHMuaWRzLmluaXRpYWxTY29wZSkpO1xuICAgICAgICB0aGlzLl9pbml0aWFsTm9kZS5jbGVhckNoaWxkcmVuKCk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgICAgLy8gQ3JlYXRlIG5vZGVzOlxuICAgICAgICBmb3IgKGxldCBub2RlIG9mIHNjb3BlU2VyaWFsaXplci5kZXNlcmlhbGl6ZU5vZGVzKHRoaXMuX2dldEFjdGl2aXR5QnlJZCwganNvbiwgc2VyaWFsaXplcikpIHtcbiAgICAgICAgICAgIHRoaXMuX25vZGVzLnNldChub2RlLmluc3RhbmNlSWQsIG5vZGUpO1xuICAgICAgICB9XG4gICAgICAgIC8vIFNldHVwIFRyZWU6XG4gICAgICAgIGZvciAobGV0IGl0ZW0gb2YganNvbikge1xuICAgICAgICAgICAgdGhpcy5fbm9kZXMuZ2V0KGl0ZW0uaW5zdGFuY2VJZCkucGFyZW50ID0gdGhpcy5fbm9kZXMuZ2V0KGl0ZW0ucGFyZW50SWQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuV29ya2Zsb3dFcnJvcihcIkNhbm5vdCByZXN0b3JlIHN0YXRlIHRyZWUsIGJlY2F1c2UgZGF0YSBpcyBjb3JydXB0LiBJbm5lciBlcnJvcjogXCIgKyBlLnN0YWNrKTtcbiAgICB9XG59O1xuLyogU0VSSUFMSVpBVElPTiAqL1xuXG4vKiBQUk9YWSAqL1xuXG5TY29wZVRyZWUucHJvdG90eXBlLl9nZXRSZWFsUGFyZW50ID0gZnVuY3Rpb24gKGN1cnJlbnROb2RlKSB7XG4gICAgbGV0IHBhcmVudCA9IGN1cnJlbnROb2RlLnBhcmVudDtcbiAgICBpZiAodGhpcy5fZ2V0QWN0aXZpdHlCeUlkKGN1cnJlbnROb2RlLmluc3RhbmNlSWQpIGluc3RhbmNlb2YgRXhwcmVzc2lvbikge1xuICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50O1xuICAgIH1cbiAgICByZXR1cm4gcGFyZW50O1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5oYXNQcm9wZXJ0eSA9IGZ1bmN0aW9uIChjdXJyZW50Tm9kZSwgbmFtZSwgbm9XYWxrKSB7XG4gICAgaWYgKG5hbWUgPT09IFwiJHBhcmVudFwiKSB7XG4gICAgICAgIGxldCBwYXJlbnQgPSB0aGlzLl9nZXRSZWFsUGFyZW50KGN1cnJlbnROb2RlKTtcbiAgICAgICAgaWYgKHBhcmVudCAmJiBwYXJlbnQgIT09IHRoaXMuX2luaXRpYWxOb2RlKSB7XG4gICAgICAgICAgICByZXR1cm4gISFwYXJlbnQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobmFtZSA9PT0gXCIkYWN0aXZpdHlcIikge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICBmb3IgKGxldCBub2RlIG9mIGN1cnJlbnROb2RlLndhbGtUb1Jvb3Qobm9XYWxrKSkge1xuICAgICAgICBpZiAobm9kZS5pc1Byb3BlcnR5RXhpc3RzKG5hbWUpKSB7XG4gICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBpZiAobm9kZS51c2VySWQgPT09IG5hbWUpIHtcbiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmb3VuZDtcbn07XG5cblNjb3BlVHJlZS5wcm90b3R5cGUuZ2V0VmFsdWUgPSBmdW5jdGlvbiAoY3VycmVudE5vZGUsIG5hbWUsIG5vV2Fsaykge1xuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIGlmIChuYW1lID09PSBcIiRwYXJlbnRcIikge1xuICAgICAgICBsZXQgcGFyZW50ID0gdGhpcy5fZ2V0UmVhbFBhcmVudChjdXJyZW50Tm9kZSk7XG4gICAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50ICE9PSB0aGlzLl9pbml0aWFsTm9kZSkge1xuICAgICAgICAgICAgbGV0IHBhcmVudFNjb3BlID0gc2NvcGUuY3JlYXRlKHRoaXMsIHBhcmVudCwgdHJ1ZSk7XG4gICAgICAgICAgICBwYXJlbnRTY29wZS5fX21hcmtlciA9IGd1aWRzLm1hcmtlcnMuJHBhcmVudDtcbiAgICAgICAgICAgIHJldHVybiBwYXJlbnRTY29wZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobmFtZSA9PT0gXCIkYWN0aXZpdHlcIikge1xuICAgICAgICByZXR1cm4gc2VsZi5fZ2V0QWN0aXZpdHlCeUlkKGN1cnJlbnROb2RlLmluc3RhbmNlSWQpO1xuICAgIH1cblxuICAgIGxldCBjYW5SZXR1cm5Qcml2YXRlID0gdHJ1ZTtcbiAgICBsZXQgdmFsdWU7XG4gICAgZm9yIChsZXQgbm9kZSBvZiBjdXJyZW50Tm9kZS53YWxrVG9Sb290KG5vV2FsaykpIHtcbiAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHZhbHVlID0gbm9kZS5nZXRQcm9wZXJ0eVZhbHVlKG5hbWUsIGNhblJldHVyblByaXZhdGUpKSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGUudXNlcklkID09PSBuYW1lICYmIG5vZGUgIT09IGN1cnJlbnROb2RlKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IHNjb3BlLmNyZWF0ZShzZWxmLCBub2RlLCB0cnVlKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhblJldHVyblByaXZhdGUgPSBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5zZXRWYWx1ZSA9IGZ1bmN0aW9uIChjdXJyZW50Tm9kZSwgbmFtZSwgdmFsdWUsIG5vV2Fsaykge1xuICAgIGlmICh0aGlzLmlzT25Jbml0aWFsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBzZXQgcHJvcGVydHkgb2YgdGhlIGluaXRpYWwgc2NvcGUuXCIpO1xuICAgIH1cblxuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBsZXQgY2FuU2V0UHJpdmF0ZSA9IHRydWU7XG4gICAgbGV0IHNldERvbmUgPSBmYWxzZTtcbiAgICBmb3IgKGxldCBub2RlIG9mIGN1cnJlbnROb2RlLndhbGtUb1Jvb3Qobm9XYWxrKSkge1xuICAgICAgICBpZiAobm9kZSA9PT0gc2VsZi5faW5pdGlhbE5vZGUpIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGlmIChub2RlLnNldFByb3BlcnR5VmFsdWUobmFtZSwgdmFsdWUsIGNhblNldFByaXZhdGUpKSB7XG4gICAgICAgICAgICBzZXREb25lID0gdHJ1ZTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhblNldFByaXZhdGUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoIXNldERvbmUpIHtcbiAgICAgICAgY3VycmVudE5vZGUuY3JlYXRlUHJvcGVydHlXaXRoVmFsdWUobmFtZSwgdmFsdWUpO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5kZWxldGVQcm9wZXJ0eSA9IGZ1bmN0aW9uIChjdXJyZW50Tm9kZSwgbmFtZSwgbm9XYWxrKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIGxldCBjYW5EZWxldGVQcml2YXRlID0gdHJ1ZTtcbiAgICBsZXQgZGVsZXRlRG9uZSA9IGZhbHNlO1xuICAgIGZvciAobGV0IG5vZGUgb2YgY3VycmVudE5vZGUud2Fsa1RvUm9vdChub1dhbGspKSB7XG4gICAgICAgIGlmIChub2RlID09PSBzZWxmLl9pbml0aWFsTm9kZSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGUuZGVsZXRlUHJvcGVydHkobmFtZSwgY2FuRGVsZXRlUHJpdmF0ZSkpIHtcbiAgICAgICAgICAgIGRlbGV0ZURvbmUgPSB0cnVlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FuRGVsZXRlUHJpdmF0ZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiBkZWxldGVEb25lO1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5lbnVtZXJhdGVQcm9wZXJ0eU5hbWVzID0gZnVuY3Rpb24qIChjdXJyZW50Tm9kZSwgbm9XYWxrKSB7XG4gICAgbGV0IGNhbkVudW1lcmF0ZVByaXZhdGUgPSB0cnVlO1xuICAgIGxldCBub2RlID0gY3VycmVudE5vZGU7XG4gICAgZG9cbiAgICB7XG4gICAgICAgIHlpZWxkIFwiJHBhcmVudFwiO1xuICAgICAgICB5aWVsZCBcIiRhY3Rpdml0eVwiO1xuICAgICAgICBpZiAobm9kZS51c2VySWQpIHtcbiAgICAgICAgICAgIHlpZWxkIG5vZGUudXNlcklkO1xuICAgICAgICB9XG4gICAgICAgIHlpZWxkKiBub2RlLmVudW1lcmF0ZVByb3BlcnR5TmFtZXMoY2FuRW51bWVyYXRlUHJpdmF0ZSk7XG4gICAgICAgIGNhbkVudW1lcmF0ZVByaXZhdGUgPSBmYWxzZTtcblxuICAgICAgICBpZiAobm9XYWxrKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIG5vZGUgPSBub2RlLnBhcmVudDtcbiAgICB9XG4gICAgd2hpbGUgKG5vZGUpO1xufTtcbi8qIFBST1hZICovXG5cbi8qIFdBTEsgKi9cblNjb3BlVHJlZS5wcm90b3R5cGUubmV4dCA9IGZ1bmN0aW9uIChub2RlSW5zdGFuY2VJZCwgY2hpbGRJbnN0YW5jZUlkLCBzY29wZVBhcnQsIGNoaWxkVXNlcklkKSB7XG4gICAgbGV0IGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChub2RlSW5zdGFuY2VJZCk7XG4gICAgbGV0IG5leHROb2RlID0gbmV3IFNjb3BlTm9kZShjaGlsZEluc3RhbmNlSWQsIHNjb3BlUGFydCwgY2hpbGRVc2VySWQpO1xuICAgIGN1cnJlbnROb2RlLmFkZENoaWxkKG5leHROb2RlKTtcbiAgICB0aGlzLl9ub2Rlcy5zZXQoY2hpbGRJbnN0YW5jZUlkLCBuZXh0Tm9kZSk7XG4gICAgcmV0dXJuIHNjb3BlLmNyZWF0ZSh0aGlzLCBuZXh0Tm9kZSk7XG59O1xuXG5TY29wZVRyZWUucHJvdG90eXBlLmJhY2sgPSBmdW5jdGlvbiAobm9kZUlkLCBrZWVwSXRlbSkge1xuICAgIGxldCBjdXJyZW50Tm9kZSA9IHRoaXMuX2dldE5vZGVCeUV4dGVybmFsSWQobm9kZUlkKTtcbiAgICBpZiAoY3VycmVudE5vZGUgPT09IHRoaXMuX2luaXRpYWxOb2RlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBnbyBiYWNrIGJlY2F1c2UgY3VycmVudCBzY29wZSBpcyB0aGUgaW5pdGlhbCBzY29wZS5cIik7XG4gICAgfVxuICAgIGxldCB0b1JlbW92ZSA9IGN1cnJlbnROb2RlO1xuICAgIGxldCBnb1RvID0gdG9SZW1vdmUucGFyZW50O1xuICAgIGN1cnJlbnROb2RlID0gZ29UbztcbiAgICBpZiAoIWtlZXBJdGVtKSB7XG4gICAgICAgIGdvVG8ucmVtb3ZlQ2hpbGQodG9SZW1vdmUpO1xuICAgICAgICB0aGlzLl9ub2Rlcy5kZWxldGUodG9SZW1vdmUuaW5zdGFuY2VJZCk7XG4gICAgfVxuICAgIHJldHVybiBzY29wZS5jcmVhdGUodGhpcywgY3VycmVudE5vZGUpO1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5maW5kID0gZnVuY3Rpb24gKG5vZGVJZCkge1xuICAgIGxldCBjdXJyZW50Tm9kZSA9IHRoaXMuX2dldE5vZGVCeUV4dGVybmFsSWQobm9kZUlkKTtcbiAgICByZXR1cm4gc2NvcGUuY3JlYXRlKHRoaXMsIGN1cnJlbnROb2RlKTtcbn07XG5cblNjb3BlVHJlZS5wcm90b3R5cGUuZmluZFBhcnQgPSBmdW5jdGlvbiAobm9kZUlkKSB7XG4gICAgbGV0IGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChub2RlSWQpO1xuICAgIGlmIChjdXJyZW50Tm9kZSAhPT0gdGhpcy5faW5pdGlhbE5vZGUpIHtcbiAgICAgICAgcmV0dXJuIGN1cnJlbnROb2RlLnNjb3BlUGFydDtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59O1xuLyogV0FMSyAqL1xuXG5TY29wZVRyZWUucHJvdG90eXBlLl9nZXROb2RlQnlFeHRlcm5hbElkID0gZnVuY3Rpb24gKGlkKSB7XG4gICAgaWYgKGlkID09PSBudWxsKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pbml0aWFsTm9kZTtcbiAgICB9XG4gICAgbGV0IG5vZGUgPSB0aGlzLl9ub2Rlcy5nZXQoaWQpO1xuICAgIGlmICghbm9kZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJTY29wZSBub2RlIGZvciBhY3Rpdml0eSBpZCAnXCIgKyBpZCArIFwiJyBpcyBub3QgZm91bmQuXCIpO1xuICAgIH1cbiAgICByZXR1cm4gbm9kZTtcbn07XG5cblNjb3BlVHJlZS5wcm90b3R5cGUuZGVsZXRlU2NvcGVQYXJ0ID0gZnVuY3Rpb24gKGN1cnJlbnROb2RlSWQsIGlkKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIGxldCBjdXJyZW50Tm9kZSA9IHRoaXMuX2dldE5vZGVCeUV4dGVybmFsSWQoY3VycmVudE5vZGVJZCk7XG4gICAgbGV0IGRlbE5vZGUgPSBzZWxmLl9ub2Rlcy5nZXQoaWQpO1xuICAgIGlmIChkZWxOb2RlKSB7XG4gICAgICAgIGlmIChkZWxOb2RlID09PSBzZWxmLl9pbml0aWFsTm9kZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGRlbGV0ZSB0aGUgaW5pdGlhbCBzY29wZS5cIik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgICAgIGZvciAobGV0IG5vZGUgb2YgZGVsTm9kZS53YWxrVG9Sb290KCkpIHtcbiAgICAgICAgICAgIGlmIChub2RlID09PSBjdXJyZW50Tm9kZSkge1xuICAgICAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIWZvdW5kKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgZGVsZXRlIHNjb3BlLCBiZWNhdXNlIGN1cnJlbnQgYWN0aXZlIHNjb3BlIGlzIGluc2lkZSBpbiBpdC5cIik7XG4gICAgICAgIH1cbiAgICAgICAgZGVsTm9kZS5wYXJlbnQucmVtb3ZlQ2hpbGQoZGVsTm9kZSk7XG4gICAgICAgIHNlbGYuX3JlbW92ZUFsbE5vZGVzKGRlbE5vZGUpO1xuICAgIH1cbn07XG5cblNjb3BlVHJlZS5wcm90b3R5cGUuX3JlbW92ZUFsbE5vZGVzID0gZnVuY3Rpb24gKG5vZGUpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG5cbiAgICBzZWxmLl9ub2Rlcy5kZWxldGUobm9kZS5pbnN0YW5jZUlkKTtcbiAgICBmb3IgKGxldCBjIG9mIG5vZGUuY2hpbGRyZW4oKSkge1xuICAgICAgICBzZWxmLl9yZW1vdmVBbGxOb2RlcyhjKTtcbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFNjb3BlVHJlZTsiXX0=
