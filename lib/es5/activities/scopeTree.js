"use strict";
var ScopeNode = require("./scopeNode");
var guids = require("../common/guids");
var StrMap = require("backpack-node").collections.StrMap;
var StrSet = require("backpack-node").collections.StrSet;
var _ = require("lodash");
var specStrings = require("../common/specStrings");
var errors = require("../common/errors");
var is = require("../common/is");
var scope = require("./scope");
var fast = require("fast.js");
function ScopeTree(initialScope, getActivityByIdFunc) {
  this._initialNode = new ScopeNode(guids.ids.initialScope, initialScope);
  this._nodes = new StrMap();
  this._nodes.add(this._initialNode.id, this._initialNode);
  this._getActivityById = getActivityByIdFunc;
}
ScopeTree.prototype.getState = function(getPromotions) {
  var self = this;
  var state = [];
  var promotedProperties = getPromotions ? new StrMap() : null;
  self._nodes.forEachValue(function(node) {
    if (node.id === guids.ids.initialScope)
      return ;
    var item = {
      id: node.id,
      parentId: node.parent ? node.parent.id : null,
      parts: []
    };
    var activity = self._getActivityById(node.id);
    node.forEachProperty(function(propertyName, propertyValue) {
      if (!activity.nonSerializedProperties.exists(propertyName)) {
        if (_.isArray(propertyValue)) {
          var iPart = {
            name: propertyName,
            value: []
          };
          item.parts.push(iPart);
          propertyValue.forEach(function(pv) {
            if (is.activity(pv)) {
              iPart.value.push(specStrings.hosting.createActivityInstancePart(pv.id));
            } else {
              iPart.value.push(pv);
            }
          });
        } else if (is.activity(propertyValue)) {
          item.parts.push({
            name: propertyName,
            value: specStrings.hosting.createActivityInstancePart(propertyValue.id)
          });
        } else if (_.isFunction(propertyValue) && !activity.hasOwnProperty(propertyName) && _.isFunction(activity[propertyName])) {
          item.parts.push(specStrings.hosting.createActivityPropertyPart(propertyName));
        } else if (_.isObject(propertyValue) && propertyValue === activity[propertyName]) {
          item.parts.push(specStrings.hosting.createActivityPropertyPart(propertyName));
        } else {
          item.parts.push({
            name: propertyName,
            value: propertyValue
          });
        }
      }
    });
    state.push(item);
    if (promotedProperties && activity.promotedProperties) {
      activity.promotedProperties.forEach(function(promotedPropName) {
        var pv = node.getPropertyValue(promotedPropName, true);
        if (is.defined(pv) && !(is.activity(pv))) {
          var promotedEntry = promotedProperties.get(promotedPropName);
          if (is.undefined(promotedEntry) || node.id > promotedEntry.level) {
            promotedProperties.add(promotedPropName, {
              level: node.id,
              value: pv
            });
          }
        }
      });
    }
  });
  var actualPromotions = null;
  if (promotedProperties) {
    var actualPromotions = {};
    if (promotedProperties.count) {
      promotedProperties.forEach(function(kvp) {
        actualPromotions[kvp.key] = kvp.value.value;
      });
    }
  }
  return {
    state: state,
    promotedProperties: actualPromotions
  };
};
ScopeTree.prototype.setState = function(json) {
  var self = this;
  if (!_.isArray(json))
    throw new TypeError("Array argument expected.");
  if (self._nodes.count != 1) {
    self._nodes.forEachKey(function(key) {
      if (key === guids.ids.initialScope)
        return ;
      self._nodes.remove(key);
    });
    self._initialNode.clearChildren();
  }
  var e = fast.try(function() {
    json.forEach(function(item) {
      var scopePart = {};
      var activity = self._getActivityById(item.id);
      item.parts.forEach(function(part) {
        var activityProperty = specStrings.hosting.getActivityPropertyName(part);
        if (activityProperty) {
          if (_.isUndefined(scopePart[activityProperty] = activity[activityProperty]))
            throw new Error("Activity has no property '" + part + "'.");
        } else {
          var activityId = specStrings.hosting.getActivityId(part.value);
          if (activityId) {
            scopePart[part.name] = self._getActivityById(activityId);
          } else if (_.isArray(part.value)) {
            var scopePartValue = [];
            scopePart[part.name] = scopePartValue;
            part.value.forEach(function(pv) {
              activityId = specStrings.hosting.getActivityId(pv);
              if (activityId) {
                scopePartValue.push(self._getActivityById(activityId));
              } else {
                scopePartValue.push(pv);
              }
            });
          } else {
            scopePart[part.name] = part.value;
          }
        }
      });
      var node = new ScopeNode(item.id, scopePart);
      self._nodes.add(item.id, node);
    });
    json.forEach(function(item) {
      self._nodes.get(item.id).parent = self._nodes.get(item.parentId);
    });
  });
  if (e instanceof Error)
    throw new errors.WorkflowError("Cannot restore state tree, because data is corrupt. Inner error: " + e.stack);
};
ScopeTree.prototype.hasProperty = function(currentNode, name) {
  var found = false;
  currentNode.forEachToRoot(function(node) {
    if (node.isPropertyExists(name)) {
      found = true;
      return false;
    }
  });
  return found;
};
ScopeTree.prototype.getValue = function(currentNode, name) {
  var canReturnPrivate = true;
  var value;
  currentNode.forEachToRoot(function(node) {
    if (is.defined(value = node.getPropertyValue(name, canReturnPrivate)))
      return false;
    canReturnPrivate = false;
  });
  return value;
};
ScopeTree.prototype.setValue = function(currentNode, name, value) {
  if (this.isOnInitial)
    throw new Error("Cannot set property of the initial scope.");
  var self = this;
  var canSetPrivate = true;
  var setDone = false;
  currentNode.forEachToRoot(function(node) {
    if (node === self._initialNode)
      return false;
    if (node.setPropertyValue(name, value, canSetPrivate)) {
      setDone = true;
      return false;
    }
    canSetPrivate = false;
  });
  if (!setDone)
    currentNode.createPropertyWithValue(name, value);
  return true;
};
ScopeTree.prototype.deleteProperty = function(currentNode, name) {
  var self = this;
  var canDeletePrivate = true;
  var deleteDone = false;
  currentNode.forEachToRoot(function(node) {
    if (node === self._initialNode)
      return false;
    if (node.deleteProperty(name, canDeletePrivate)) {
      deleteDone = true;
      return false;
    }
    canDeletePrivate = false;
  });
  return deleteDone;
};
ScopeTree.prototype.enumeratePropertyNames = $traceurRuntime.initGeneratorFunction(function $__0(currentNode) {
  var canEnumeratePrivate,
      node,
      $__1,
      $__2;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          canEnumeratePrivate = true;
          node = currentNode;
          $ctx.state = 17;
          break;
        case 17:
          $__1 = $ctx.wrapYieldStar(node.enumeratePropertyNames(canEnumeratePrivate)[Symbol.iterator]());
          $ctx.sent = void 0;
          $ctx.action = 'next';
          $ctx.state = 12;
          break;
        case 12:
          $__2 = $__1[$ctx.action]($ctx.sentIgnoreThrow);
          $ctx.state = 9;
          break;
        case 9:
          $ctx.state = ($__2.done) ? 3 : 2;
          break;
        case 3:
          $ctx.sent = $__2.value;
          $ctx.state = 10;
          break;
        case 2:
          $ctx.state = 12;
          return $__2.value;
        case 10:
          canEnumeratePrivate = false;
          node = node.parent;
          $ctx.state = 14;
          break;
        case 14:
          $ctx.state = (node) ? 17 : -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__0, this);
});
ScopeTree.prototype.next = function(nodeId, childId, scopePart) {
  var currentNode = this._getNodeByExternalId(nodeId);
  var nextNode = new ScopeNode(childId, scopePart);
  currentNode.addChild(nextNode);
  this._nodes.add(childId, nextNode);
  return scope.create(this, nextNode);
};
ScopeTree.prototype.back = function(nodeId, keepItem) {
  var currentNode = this._getNodeByExternalId(nodeId);
  if (currentNode === this._initialNode)
    throw new Error("Cannot go back because current scope is the initial scope.");
  var toRemove = currentNode;
  var goTo = toRemove.parent;
  currentNode = goTo;
  if (!keepItem) {
    goTo.removeChild(toRemove);
    this._nodes.remove(toRemove.id);
  }
  return scope.create(this, currentNode);
};
ScopeTree.prototype.find = function(nodeId) {
  var currentNode = this._getNodeByExternalId(nodeId);
  return scope.create(this, currentNode);
};
ScopeTree.prototype._getNodeByExternalId = function(id) {
  if (id === null)
    return this._initialNode;
  var node = this._nodes.get(id);
  if (!node) {
    throw new Error("Scope node for activity id '" + id + "' is not found.");
  }
  return node;
};
ScopeTree.prototype.deleteScopePart = function(currentNodeId, id) {
  var self = this;
  var currentNode = this._getNodeByExternalId(currentNodeId);
  var delNode = self._nodes.get(id);
  if (delNode) {
    if (delNode === self._initialNode)
      throw new Error("Cannot delete the initial scope.");
    var found = false;
    delNode.forEachToRoot(function(node) {
      if (node === currentNode) {
        found = true;
        return false;
      }
    });
    if (!found)
      throw new Error("Cannot delete scope, because current active scope is inside in it.");
    delNode.parent.removeChild(delNode);
    self._removeAllNodes(delNode);
  }
};
ScopeTree.prototype._removeAllNodes = function(node) {
  var self = this;
  self._nodes.remove(node.id);
  node.forEachChild(function(c) {
    self._removeAllNodes(c);
  });
};
module.exports = ScopeTree;
//# sourceMappingURL=data:application/json;base64,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QU8sQUFBQyxDQUFDLElBQUcsR0FBRyxDQUFDLENBQUM7QUFDM0IsS0FBRyxhQUFhLEFBQUMsQ0FBQyxTQUFVLENBQUEsQ0FBRztBQUMzQixPQUFHLGdCQUFnQixBQUFDLENBQUMsQ0FBQSxDQUFDLENBQUM7RUFDM0IsQ0FBQyxDQUFDO0FBQ04sQ0FBQTtBQUVBLEtBQUssUUFBUSxFQUFJLFVBQVEsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvc2NvcGVUcmVlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgU2NvcGVOb2RlID0gcmVxdWlyZShcIi4vc2NvcGVOb2RlXCIpO1xyXG52YXIgZ3VpZHMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2d1aWRzXCIpO1xyXG52YXIgU3RyTWFwID0gcmVxdWlyZShcImJhY2twYWNrLW5vZGVcIikuY29sbGVjdGlvbnMuU3RyTWFwO1xyXG52YXIgU3RyU2V0ID0gcmVxdWlyZShcImJhY2twYWNrLW5vZGVcIikuY29sbGVjdGlvbnMuU3RyU2V0O1xyXG52YXIgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XHJcbnZhciBzcGVjU3RyaW5ncyA9IHJlcXVpcmUoXCIuLi9jb21tb24vc3BlY1N0cmluZ3NcIik7XHJcbnZhciBlcnJvcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2Vycm9yc1wiKTtcclxudmFyIGlzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9pc1wiKTtcclxudmFyIHNjb3BlID0gcmVxdWlyZShcIi4vc2NvcGVcIik7XHJcbnZhciBmYXN0ID0gcmVxdWlyZShcImZhc3QuanNcIik7XHJcblxyXG5mdW5jdGlvbiBTY29wZVRyZWUoaW5pdGlhbFNjb3BlLCBnZXRBY3Rpdml0eUJ5SWRGdW5jKSB7XHJcbiAgICB0aGlzLl9pbml0aWFsTm9kZSA9IG5ldyBTY29wZU5vZGUoZ3VpZHMuaWRzLmluaXRpYWxTY29wZSwgaW5pdGlhbFNjb3BlKTtcclxuICAgIHRoaXMuX25vZGVzID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgdGhpcy5fbm9kZXMuYWRkKHRoaXMuX2luaXRpYWxOb2RlLmlkLCB0aGlzLl9pbml0aWFsTm9kZSk7XHJcbiAgICB0aGlzLl9nZXRBY3Rpdml0eUJ5SWQgPSBnZXRBY3Rpdml0eUJ5SWRGdW5jO1xyXG59XHJcblxyXG4vKiBTRVJJQUxJWkFUSU9OICovXHJcblNjb3BlVHJlZS5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoZ2V0UHJvbW90aW9ucykge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgdmFyIHN0YXRlID0gW107XHJcbiAgICB2YXIgcHJvbW90ZWRQcm9wZXJ0aWVzID0gZ2V0UHJvbW90aW9ucyA/IG5ldyBTdHJNYXAoKSA6IG51bGw7XHJcblxyXG4gICAgc2VsZi5fbm9kZXMuZm9yRWFjaFZhbHVlKFxyXG4gICAgICAgIGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgIGlmIChub2RlLmlkID09PSBndWlkcy5pZHMuaW5pdGlhbFNjb3BlKSByZXR1cm47XHJcblxyXG4gICAgICAgICAgICB2YXIgaXRlbSA9IHtcclxuICAgICAgICAgICAgICAgIGlkOiBub2RlLmlkLFxyXG4gICAgICAgICAgICAgICAgcGFyZW50SWQ6IG5vZGUucGFyZW50ID8gbm9kZS5wYXJlbnQuaWQgOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgcGFydHM6IFtdXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB2YXIgYWN0aXZpdHkgPSBzZWxmLl9nZXRBY3Rpdml0eUJ5SWQobm9kZS5pZCk7XHJcblxyXG4gICAgICAgICAgICBub2RlLmZvckVhY2hQcm9wZXJ0eShcclxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChwcm9wZXJ0eU5hbWUsIHByb3BlcnR5VmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWFjdGl2aXR5Lm5vblNlcmlhbGl6ZWRQcm9wZXJ0aWVzLmV4aXN0cyhwcm9wZXJ0eU5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfLmlzQXJyYXkocHJvcGVydHlWYWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpUGFydCA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBwcm9wZXJ0eU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFtdXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5wYXJ0cy5wdXNoKGlQYXJ0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5VmFsdWUuZm9yRWFjaChmdW5jdGlvbiAocHYpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXMuYWN0aXZpdHkocHYpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlQYXJ0LnZhbHVlLnB1c2goc3BlY1N0cmluZ3MuaG9zdGluZy5jcmVhdGVBY3Rpdml0eUluc3RhbmNlUGFydChwdi5pZCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaVBhcnQudmFsdWUucHVzaChwdik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaXMuYWN0aXZpdHkocHJvcGVydHlWYWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ucGFydHMucHVzaChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHByb3BlcnR5TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHNwZWNTdHJpbmdzLmhvc3RpbmcuY3JlYXRlQWN0aXZpdHlJbnN0YW5jZVBhcnQocHJvcGVydHlWYWx1ZS5pZClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChfLmlzRnVuY3Rpb24ocHJvcGVydHlWYWx1ZSkgJiYgIWFjdGl2aXR5Lmhhc093blByb3BlcnR5KHByb3BlcnR5TmFtZSkgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNGdW5jdGlvbihhY3Rpdml0eVtwcm9wZXJ0eU5hbWVdKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5wYXJ0cy5wdXNoKHNwZWNTdHJpbmdzLmhvc3RpbmcuY3JlYXRlQWN0aXZpdHlQcm9wZXJ0eVBhcnQocHJvcGVydHlOYW1lKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoXy5pc09iamVjdChwcm9wZXJ0eVZhbHVlKSAmJiBwcm9wZXJ0eVZhbHVlID09PSBhY3Rpdml0eVtwcm9wZXJ0eU5hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnBhcnRzLnB1c2goc3BlY1N0cmluZ3MuaG9zdGluZy5jcmVhdGVBY3Rpdml0eVByb3BlcnR5UGFydChwcm9wZXJ0eU5hbWUpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ucGFydHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogcHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcm9wZXJ0eVZhbHVlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBzdGF0ZS5wdXNoKGl0ZW0pO1xyXG5cclxuICAgICAgICAgICAgLy8gUHJvbW90aW9uczpcclxuICAgICAgICAgICAgaWYgKHByb21vdGVkUHJvcGVydGllcyAmJiBhY3Rpdml0eS5wcm9tb3RlZFByb3BlcnRpZXMpIHtcclxuICAgICAgICAgICAgICAgIGFjdGl2aXR5LnByb21vdGVkUHJvcGVydGllcy5mb3JFYWNoKFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChwcm9tb3RlZFByb3BOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwdiA9IG5vZGUuZ2V0UHJvcGVydHlWYWx1ZShwcm9tb3RlZFByb3BOYW1lLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzLmRlZmluZWQocHYpICYmICEoaXMuYWN0aXZpdHkocHYpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb21vdGVkRW50cnkgPSBwcm9tb3RlZFByb3BlcnRpZXMuZ2V0KHByb21vdGVkUHJvcE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgYW4gQWN0aXZpdHkgSWQgZ3JlYXRlciB0aGFuIG90aGVyLCB0aGVuIHdlIGNhbiBzdXJlIHRoYXQgb3RoZXIgYmVsb3cgb3IgYWZ0ZXIgaW4gdGhlIHRyZWUuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXMudW5kZWZpbmVkKHByb21vdGVkRW50cnkpIHx8IG5vZGUuaWQgPiBwcm9tb3RlZEVudHJ5LmxldmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbW90ZWRQcm9wZXJ0aWVzLmFkZChwcm9tb3RlZFByb3BOYW1lLCB7bGV2ZWw6IG5vZGUuaWQsIHZhbHVlOiBwdn0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICB2YXIgYWN0dWFsUHJvbW90aW9ucyA9IG51bGw7XHJcbiAgICBpZiAocHJvbW90ZWRQcm9wZXJ0aWVzKSB7XHJcbiAgICAgICAgdmFyIGFjdHVhbFByb21vdGlvbnMgPSB7fTtcclxuICAgICAgICBpZiAocHJvbW90ZWRQcm9wZXJ0aWVzLmNvdW50KSB7XHJcbiAgICAgICAgICAgIHByb21vdGVkUHJvcGVydGllcy5mb3JFYWNoKFxyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKGt2cCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFjdHVhbFByb21vdGlvbnNba3ZwLmtleV0gPSBrdnAudmFsdWUudmFsdWU7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0ZTogc3RhdGUsXHJcbiAgICAgICAgcHJvbW90ZWRQcm9wZXJ0aWVzOiBhY3R1YWxQcm9tb3Rpb25zXHJcbiAgICB9O1xyXG59XHJcblxyXG5TY29wZVRyZWUucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKGpzb24pIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICBpZiAoIV8uaXNBcnJheShqc29uKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFycmF5IGFyZ3VtZW50IGV4cGVjdGVkLlwiKTtcclxuXHJcbiAgICBpZiAoc2VsZi5fbm9kZXMuY291bnQgIT0gMSkge1xyXG4gICAgICAgIC8vIFRoZXJlIGFyZSBoaWRkZW4gaWRsZSBzdGF0ZTpcclxuICAgICAgICBzZWxmLl9ub2Rlcy5mb3JFYWNoS2V5KFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoa2V5KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSBndWlkcy5pZHMuaW5pdGlhbFNjb3BlKSByZXR1cm47XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9ub2Rlcy5yZW1vdmUoa2V5KTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHNlbGYuX2luaXRpYWxOb2RlLmNsZWFyQ2hpbGRyZW4oKTtcclxuICAgIH1cclxuXHJcbiAgICB2YXIgZSA9IGZhc3QudHJ5KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBqc29uLmZvckVhY2goXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc2NvcGVQYXJ0ID0ge307XHJcbiAgICAgICAgICAgICAgICB2YXIgYWN0aXZpdHkgPSBzZWxmLl9nZXRBY3Rpdml0eUJ5SWQoaXRlbS5pZCk7XHJcbiAgICAgICAgICAgICAgICBpdGVtLnBhcnRzLmZvckVhY2goXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKHBhcnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGl2aXR5UHJvcGVydHkgPSBzcGVjU3RyaW5ncy5ob3N0aW5nLmdldEFjdGl2aXR5UHJvcGVydHlOYW1lKHBhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZpdHlQcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQoc2NvcGVQYXJ0W2FjdGl2aXR5UHJvcGVydHldID0gYWN0aXZpdHlbYWN0aXZpdHlQcm9wZXJ0eV0pKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFjdGl2aXR5IGhhcyBubyBwcm9wZXJ0eSAnXCIgKyBwYXJ0ICsgXCInLlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpdml0eUlkID0gc3BlY1N0cmluZ3MuaG9zdGluZy5nZXRBY3Rpdml0eUlkKHBhcnQudmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2aXR5SWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVBhcnRbcGFydC5uYW1lXSA9IHNlbGYuX2dldEFjdGl2aXR5QnlJZChhY3Rpdml0eUlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF8uaXNBcnJheShwYXJ0LnZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY29wZVBhcnRWYWx1ZSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlUGFydFtwYXJ0Lm5hbWVdID0gc2NvcGVQYXJ0VmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydC52YWx1ZS5mb3JFYWNoKGZ1bmN0aW9uIChwdikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eUlkID0gc3BlY1N0cmluZ3MuaG9zdGluZy5nZXRBY3Rpdml0eUlkKHB2KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2aXR5SWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlUGFydFZhbHVlLnB1c2goc2VsZi5fZ2V0QWN0aXZpdHlCeUlkKGFjdGl2aXR5SWQpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlUGFydFZhbHVlLnB1c2gocHYpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVBhcnRbcGFydC5uYW1lXSA9IHBhcnQudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHZhciBub2RlID0gbmV3IFNjb3BlTm9kZShpdGVtLmlkLCBzY29wZVBhcnQpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fbm9kZXMuYWRkKGl0ZW0uaWQsIG5vZGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAganNvbi5mb3JFYWNoKFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fbm9kZXMuZ2V0KGl0ZW0uaWQpLnBhcmVudCA9IHNlbGYuX25vZGVzLmdldChpdGVtLnBhcmVudElkKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoZSBpbnN0YW5jZW9mIEVycm9yKSB0aHJvdyBuZXcgZXJyb3JzLldvcmtmbG93RXJyb3IoXCJDYW5ub3QgcmVzdG9yZSBzdGF0ZSB0cmVlLCBiZWNhdXNlIGRhdGEgaXMgY29ycnVwdC4gSW5uZXIgZXJyb3I6IFwiICsgZS5zdGFjayk7XHJcbn1cclxuLyogU0VSSUFMSVpBVElPTiAqL1xyXG5cclxuLyogUFJPWFkgKi9cclxuU2NvcGVUcmVlLnByb3RvdHlwZS5oYXNQcm9wZXJ0eSA9IGZ1bmN0aW9uIChjdXJyZW50Tm9kZSwgbmFtZSkge1xyXG4gICAgdmFyIGZvdW5kID0gZmFsc2U7XHJcbiAgICBjdXJyZW50Tm9kZS5mb3JFYWNoVG9Sb290KGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgaWYgKG5vZGUuaXNQcm9wZXJ0eUV4aXN0cyhuYW1lKSkge1xyXG4gICAgICAgICAgICBmb3VuZCA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBmb3VuZDtcclxufVxyXG5cclxuU2NvcGVUcmVlLnByb3RvdHlwZS5nZXRWYWx1ZSA9IGZ1bmN0aW9uIChjdXJyZW50Tm9kZSwgbmFtZSkge1xyXG4gICAgdmFyIGNhblJldHVyblByaXZhdGUgPSB0cnVlO1xyXG4gICAgdmFyIHZhbHVlO1xyXG4gICAgY3VycmVudE5vZGUuZm9yRWFjaFRvUm9vdChmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgIGlmIChpcy5kZWZpbmVkKHZhbHVlID0gbm9kZS5nZXRQcm9wZXJ0eVZhbHVlKG5hbWUsIGNhblJldHVyblByaXZhdGUpKSkgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIGNhblJldHVyblByaXZhdGUgPSBmYWxzZTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHZhbHVlO1xyXG59XHJcblxyXG5TY29wZVRyZWUucHJvdG90eXBlLnNldFZhbHVlID0gZnVuY3Rpb24gKGN1cnJlbnROb2RlLCBuYW1lLCB2YWx1ZSkge1xyXG4gICAgaWYgKHRoaXMuaXNPbkluaXRpYWwpIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBzZXQgcHJvcGVydHkgb2YgdGhlIGluaXRpYWwgc2NvcGUuXCIpO1xyXG5cclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHZhciBjYW5TZXRQcml2YXRlID0gdHJ1ZTtcclxuICAgIHZhciBzZXREb25lID0gZmFsc2U7XHJcbiAgICBjdXJyZW50Tm9kZS5mb3JFYWNoVG9Sb290KGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgaWYgKG5vZGUgPT09IHNlbGYuX2luaXRpYWxOb2RlKSByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgaWYgKG5vZGUuc2V0UHJvcGVydHlWYWx1ZShuYW1lLCB2YWx1ZSwgY2FuU2V0UHJpdmF0ZSkpIHtcclxuICAgICAgICAgICAgc2V0RG9uZSA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FuU2V0UHJpdmF0ZSA9IGZhbHNlO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKCFzZXREb25lKSBjdXJyZW50Tm9kZS5jcmVhdGVQcm9wZXJ0eVdpdGhWYWx1ZShuYW1lLCB2YWx1ZSk7XHJcblxyXG4gICAgcmV0dXJuIHRydWU7XHJcbn1cclxuXHJcblNjb3BlVHJlZS5wcm90b3R5cGUuZGVsZXRlUHJvcGVydHkgPSBmdW5jdGlvbiAoY3VycmVudE5vZGUsIG5hbWUpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHZhciBjYW5EZWxldGVQcml2YXRlID0gdHJ1ZTtcclxuICAgIHZhciBkZWxldGVEb25lID0gZmFsc2U7XHJcbiAgICBjdXJyZW50Tm9kZS5mb3JFYWNoVG9Sb290KGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgaWYgKG5vZGUgPT09IHNlbGYuX2luaXRpYWxOb2RlKSByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgaWYgKG5vZGUuZGVsZXRlUHJvcGVydHkobmFtZSwgY2FuRGVsZXRlUHJpdmF0ZSkpIHtcclxuICAgICAgICAgICAgZGVsZXRlRG9uZSA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FuRGVsZXRlUHJpdmF0ZSA9IGZhbHNlO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGRlbGV0ZURvbmU7XHJcbn1cclxuXHJcblNjb3BlVHJlZS5wcm90b3R5cGUuZW51bWVyYXRlUHJvcGVydHlOYW1lcyA9IGZ1bmN0aW9uKiAoY3VycmVudE5vZGUpIHtcclxuICAgIHZhciBjYW5FbnVtZXJhdGVQcml2YXRlID0gdHJ1ZTtcclxuICAgIHZhciBub2RlID0gY3VycmVudE5vZGU7XHJcbiAgICBkb1xyXG4gICAge1xyXG4gICAgICAgIHlpZWxkKiBub2RlLmVudW1lcmF0ZVByb3BlcnR5TmFtZXMoY2FuRW51bWVyYXRlUHJpdmF0ZSk7XHJcbiAgICAgICAgY2FuRW51bWVyYXRlUHJpdmF0ZSA9IGZhbHNlO1xyXG4gICAgICAgIG5vZGUgPSBub2RlLnBhcmVudDtcclxuICAgIH1cclxuICAgIHdoaWxlIChub2RlKTtcclxufVxyXG4vKiBQUk9YWSAqL1xyXG5cclxuLyogV0FMSyAqL1xyXG5TY29wZVRyZWUucHJvdG90eXBlLm5leHQgPSBmdW5jdGlvbiAobm9kZUlkLCBjaGlsZElkLCBzY29wZVBhcnQpIHtcclxuICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuX2dldE5vZGVCeUV4dGVybmFsSWQobm9kZUlkKTtcclxuICAgIHZhciBuZXh0Tm9kZSA9IG5ldyBTY29wZU5vZGUoY2hpbGRJZCwgc2NvcGVQYXJ0KTtcclxuICAgIGN1cnJlbnROb2RlLmFkZENoaWxkKG5leHROb2RlKTtcclxuICAgIHRoaXMuX25vZGVzLmFkZChjaGlsZElkLCBuZXh0Tm9kZSk7XHJcbiAgICByZXR1cm4gc2NvcGUuY3JlYXRlKHRoaXMsIG5leHROb2RlKTtcclxufVxyXG5cclxuU2NvcGVUcmVlLnByb3RvdHlwZS5iYWNrID0gZnVuY3Rpb24gKG5vZGVJZCwga2VlcEl0ZW0pIHtcclxuICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuX2dldE5vZGVCeUV4dGVybmFsSWQobm9kZUlkKTtcclxuICAgIGlmIChjdXJyZW50Tm9kZSA9PT0gdGhpcy5faW5pdGlhbE5vZGUpIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBnbyBiYWNrIGJlY2F1c2UgY3VycmVudCBzY29wZSBpcyB0aGUgaW5pdGlhbCBzY29wZS5cIik7XHJcbiAgICB2YXIgdG9SZW1vdmUgPSBjdXJyZW50Tm9kZTtcclxuICAgIHZhciBnb1RvID0gdG9SZW1vdmUucGFyZW50O1xyXG4gICAgY3VycmVudE5vZGUgPSBnb1RvO1xyXG4gICAgaWYgKCFrZWVwSXRlbSkge1xyXG4gICAgICAgIGdvVG8ucmVtb3ZlQ2hpbGQodG9SZW1vdmUpO1xyXG4gICAgICAgIHRoaXMuX25vZGVzLnJlbW92ZSh0b1JlbW92ZS5pZCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc2NvcGUuY3JlYXRlKHRoaXMsIGN1cnJlbnROb2RlKTtcclxufVxyXG5cclxuU2NvcGVUcmVlLnByb3RvdHlwZS5maW5kID0gZnVuY3Rpb24gKG5vZGVJZCkge1xyXG4gICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChub2RlSWQpO1xyXG4gICAgcmV0dXJuIHNjb3BlLmNyZWF0ZSh0aGlzLCBjdXJyZW50Tm9kZSk7XHJcbn1cclxuLyogV0FMSyAqL1xyXG5cclxuU2NvcGVUcmVlLnByb3RvdHlwZS5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZCA9IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgaWYgKGlkID09PSBudWxsKSByZXR1cm4gdGhpcy5faW5pdGlhbE5vZGU7XHJcbiAgICB2YXIgbm9kZSA9IHRoaXMuX25vZGVzLmdldChpZCk7XHJcbiAgICBpZiAoIW5vZGUpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJTY29wZSBub2RlIGZvciBhY3Rpdml0eSBpZCAnXCIgKyBpZCArIFwiJyBpcyBub3QgZm91bmQuXCIpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5vZGU7XHJcbn1cclxuXHJcblNjb3BlVHJlZS5wcm90b3R5cGUuZGVsZXRlU2NvcGVQYXJ0ID0gZnVuY3Rpb24gKGN1cnJlbnROb2RlSWQsIGlkKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICB2YXIgY3VycmVudE5vZGUgPSB0aGlzLl9nZXROb2RlQnlFeHRlcm5hbElkKGN1cnJlbnROb2RlSWQpO1xyXG4gICAgdmFyIGRlbE5vZGUgPSBzZWxmLl9ub2Rlcy5nZXQoaWQpO1xyXG4gICAgaWYgKGRlbE5vZGUpIHtcclxuICAgICAgICBpZiAoZGVsTm9kZSA9PT0gc2VsZi5faW5pdGlhbE5vZGUpIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBkZWxldGUgdGhlIGluaXRpYWwgc2NvcGUuXCIpO1xyXG4gICAgICAgIHZhciBmb3VuZCA9IGZhbHNlO1xyXG4gICAgICAgIGRlbE5vZGUuZm9yRWFjaFRvUm9vdChcclxuICAgICAgICAgICAgZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBjdXJyZW50Tm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIGlmICghZm91bmQpIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBkZWxldGUgc2NvcGUsIGJlY2F1c2UgY3VycmVudCBhY3RpdmUgc2NvcGUgaXMgaW5zaWRlIGluIGl0LlwiKTtcclxuICAgICAgICBkZWxOb2RlLnBhcmVudC5yZW1vdmVDaGlsZChkZWxOb2RlKTtcclxuICAgICAgICBzZWxmLl9yZW1vdmVBbGxOb2RlcyhkZWxOb2RlKTtcclxuICAgIH1cclxufVxyXG5cclxuU2NvcGVUcmVlLnByb3RvdHlwZS5fcmVtb3ZlQWxsTm9kZXMgPSBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIHNlbGYuX25vZGVzLnJlbW92ZShub2RlLmlkKTtcclxuICAgIG5vZGUuZm9yRWFjaENoaWxkKGZ1bmN0aW9uIChjKSB7XHJcbiAgICAgICAgc2VsZi5fcmVtb3ZlQWxsTm9kZXMoYyk7XHJcbiAgICB9KTtcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBTY29wZVRyZWU7Il19
