"use strict";
"use strict";
var ScopeNode = require("./scopeNode");
var guids = require("../common/guids");
var StrMap = require("backpack-node").collections.StrMap;
var StrSet = require("backpack-node").collections.StrSet;
var _ = require("lodash");
var specStrings = require("../common/specStrings");
var errors = require("../common/errors");
var is = require("../common/is");
var scope = require("./scope");
var fast = require("fast.js");
function ScopeTree(initialScope, getActivityByIdFunc) {
  this._initialNode = new ScopeNode(guids.ids.initialScope, initialScope);
  this._nodes = new StrMap();
  this._nodes.add(this._initialNode.id, this._initialNode);
  this._getActivityById = getActivityByIdFunc;
}
ScopeTree.prototype.getState = function(getPromotions) {
  var self = this;
  var state = [];
  var promotedProperties = getPromotions ? new StrMap() : null;
  self._nodes.forEachValue(function(node) {
    if (node.id === guids.ids.initialScope) {
      return ;
    }
    var item = {
      id: node.id,
      parentId: node.parent ? node.parent.id : null,
      parts: []
    };
    var activity = self._getActivityById(node.id);
    node.forEachProperty(function(propertyName, propertyValue) {
      if (!activity.nonSerializedProperties.exists(propertyName)) {
        if (_.isArray(propertyValue)) {
          var iPart = {
            name: propertyName,
            value: []
          };
          item.parts.push(iPart);
          propertyValue.forEach(function(pv) {
            if (is.activity(pv)) {
              iPart.value.push(specStrings.hosting.createActivityInstancePart(pv.id));
            } else {
              iPart.value.push(pv);
            }
          });
        } else if (is.activity(propertyValue)) {
          item.parts.push({
            name: propertyName,
            value: specStrings.hosting.createActivityInstancePart(propertyValue.id)
          });
        } else if (_.isFunction(propertyValue) && !activity.hasOwnProperty(propertyName) && _.isFunction(activity[propertyName])) {
          item.parts.push(specStrings.hosting.createActivityPropertyPart(propertyName));
        } else if (_.isObject(propertyValue) && propertyValue === activity[propertyName]) {
          item.parts.push(specStrings.hosting.createActivityPropertyPart(propertyName));
        } else {
          item.parts.push({
            name: propertyName,
            value: propertyValue
          });
        }
      }
    });
    state.push(item);
    if (promotedProperties && activity.promotedProperties) {
      activity.promotedProperties.forEach(function(promotedPropName) {
        var pv = node.getPropertyValue(promotedPropName, true);
        if (is.defined(pv) && !(is.activity(pv))) {
          var promotedEntry = promotedProperties.get(promotedPropName);
          if (is.undefined(promotedEntry) || node.id > promotedEntry.level) {
            promotedProperties.add(promotedPropName, {
              level: node.id,
              value: pv
            });
          }
        }
      });
    }
  });
  var actualPromotions = null;
  if (promotedProperties) {
    actualPromotions = {};
    if (promotedProperties.count) {
      promotedProperties.forEach(function(kvp) {
        actualPromotions[kvp.key] = kvp.value.value;
      });
    }
  }
  return {
    state: state,
    promotedProperties: actualPromotions
  };
};
ScopeTree.prototype.setState = function(json) {
  var self = this;
  if (!_.isArray(json)) {
    throw new TypeError("Array argument expected.");
  }
  if (self._nodes.count !== 1) {
    self._nodes.forEachKey(function(key) {
      if (key === guids.ids.initialScope) {
        return ;
      }
      self._nodes.remove(key);
    });
    self._initialNode.clearChildren();
  }
  try {
    var $__17 = true;
    var $__18 = false;
    var $__19 = undefined;
    try {
      for (var $__15 = void 0,
          $__14 = (json)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__17 = ($__15 = $__14.next()).done); $__17 = true) {
        var item = $__15.value;
        {
          var scopePart = {};
          var activity = self._getActivityById(item.id);
          var $__10 = true;
          var $__11 = false;
          var $__12 = undefined;
          try {
            for (var $__8 = void 0,
                $__7 = (item.parts)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__10 = ($__8 = $__7.next()).done); $__10 = true) {
              var part = $__8.value;
              {
                var activityProperty = specStrings.hosting.getActivityPropertyName(part);
                if (activityProperty) {
                  if (_.isUndefined(scopePart[activityProperty] = activity[activityProperty])) {
                    throw new Error("Activity has no property '" + part + "'.");
                  }
                } else {
                  var activityId = specStrings.hosting.getActivityId(part.value);
                  if (activityId) {
                    scopePart[part.name] = self._getActivityById(activityId);
                  } else if (_.isArray(part.value)) {
                    var scopePartValue = [];
                    scopePart[part.name] = scopePartValue;
                    var $__3 = true;
                    var $__4 = false;
                    var $__5 = undefined;
                    try {
                      for (var $__1 = void 0,
                          $__0 = (part.value)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
                        var pv = $__1.value;
                        {
                          activityId = specStrings.hosting.getActivityId(pv);
                          if (activityId) {
                            scopePartValue.push(self._getActivityById(activityId));
                          } else {
                            scopePartValue.push(pv);
                          }
                        }
                      }
                    } catch ($__6) {
                      $__4 = true;
                      $__5 = $__6;
                    } finally {
                      try {
                        if (!$__3 && $__0.return != null) {
                          $__0.return();
                        }
                      } finally {
                        if ($__4) {
                          throw $__5;
                        }
                      }
                    }
                  } else {
                    scopePart[part.name] = part.value;
                  }
                }
              }
            }
          } catch ($__13) {
            $__11 = true;
            $__12 = $__13;
          } finally {
            try {
              if (!$__10 && $__7.return != null) {
                $__7.return();
              }
            } finally {
              if ($__11) {
                throw $__12;
              }
            }
          }
          var node = new ScopeNode(item.id, scopePart);
          self._nodes.add(item.id, node);
        }
      }
    } catch ($__20) {
      $__18 = true;
      $__19 = $__20;
    } finally {
      try {
        if (!$__17 && $__14.return != null) {
          $__14.return();
        }
      } finally {
        if ($__18) {
          throw $__19;
        }
      }
    }
    var $__24 = true;
    var $__25 = false;
    var $__26 = undefined;
    try {
      for (var $__22 = void 0,
          $__21 = (json)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__24 = ($__22 = $__21.next()).done); $__24 = true) {
        var item$__28 = $__22.value;
        {
          self._nodes.get(item$__28.id).parent = self._nodes.get(item$__28.parentId);
        }
      }
    } catch ($__27) {
      $__25 = true;
      $__26 = $__27;
    } finally {
      try {
        if (!$__24 && $__21.return != null) {
          $__21.return();
        }
      } finally {
        if ($__25) {
          throw $__26;
        }
      }
    }
  } catch (e) {
    throw new errors.WorkflowError("Cannot restore state tree, because data is corrupt. Inner error: " + e.stack);
  }
};
ScopeTree.prototype.hasProperty = function(currentNode, name) {
  var found = false;
  currentNode.forEachToRoot(function(node) {
    if (node.isPropertyExists(name)) {
      found = true;
      return false;
    }
  });
  return found;
};
ScopeTree.prototype.getValue = function(currentNode, name) {
  var canReturnPrivate = true;
  var value;
  currentNode.forEachToRoot(function(node) {
    if (is.defined(value = node.getPropertyValue(name, canReturnPrivate))) {
      return false;
    }
    canReturnPrivate = false;
  });
  return value;
};
ScopeTree.prototype.setValue = function(currentNode, name, value) {
  if (this.isOnInitial) {
    throw new Error("Cannot set property of the initial scope.");
  }
  var self = this;
  var canSetPrivate = true;
  var setDone = false;
  currentNode.forEachToRoot(function(node) {
    if (node === self._initialNode) {
      return false;
    }
    if (node.setPropertyValue(name, value, canSetPrivate)) {
      setDone = true;
      return false;
    }
    canSetPrivate = false;
  });
  if (!setDone) {
    currentNode.createPropertyWithValue(name, value);
  }
  return true;
};
ScopeTree.prototype.deleteProperty = function(currentNode, name) {
  var self = this;
  var canDeletePrivate = true;
  var deleteDone = false;
  currentNode.forEachToRoot(function(node) {
    if (node === self._initialNode) {
      return false;
    }
    if (node.deleteProperty(name, canDeletePrivate)) {
      deleteDone = true;
      return false;
    }
    canDeletePrivate = false;
  });
  return deleteDone;
};
ScopeTree.prototype.enumeratePropertyNames = $traceurRuntime.initGeneratorFunction(function $__29(currentNode) {
  var canEnumeratePrivate,
      node,
      $__30,
      $__31;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          canEnumeratePrivate = true;
          node = currentNode;
          $ctx.state = 17;
          break;
        case 17:
          $__30 = $ctx.wrapYieldStar(node.enumeratePropertyNames(canEnumeratePrivate)[Symbol.iterator]());
          $ctx.sent = void 0;
          $ctx.action = 'next';
          $ctx.state = 12;
          break;
        case 12:
          $__31 = $__30[$ctx.action]($ctx.sentIgnoreThrow);
          $ctx.state = 9;
          break;
        case 9:
          $ctx.state = ($__31.done) ? 3 : 2;
          break;
        case 3:
          $ctx.sent = $__31.value;
          $ctx.state = 10;
          break;
        case 2:
          $ctx.state = 12;
          return $__31.value;
        case 10:
          canEnumeratePrivate = false;
          node = node.parent;
          $ctx.state = 14;
          break;
        case 14:
          $ctx.state = (node) ? 17 : -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__29, this);
});
ScopeTree.prototype.next = function(nodeId, childId, scopePart) {
  var currentNode = this._getNodeByExternalId(nodeId);
  var nextNode = new ScopeNode(childId, scopePart);
  currentNode.addChild(nextNode);
  this._nodes.add(childId, nextNode);
  return scope.create(this, nextNode);
};
ScopeTree.prototype.back = function(nodeId, keepItem) {
  var currentNode = this._getNodeByExternalId(nodeId);
  if (currentNode === this._initialNode) {
    throw new Error("Cannot go back because current scope is the initial scope.");
  }
  var toRemove = currentNode;
  var goTo = toRemove.parent;
  currentNode = goTo;
  if (!keepItem) {
    goTo.removeChild(toRemove);
    this._nodes.remove(toRemove.id);
  }
  return scope.create(this, currentNode);
};
ScopeTree.prototype.find = function(nodeId) {
  var currentNode = this._getNodeByExternalId(nodeId);
  return scope.create(this, currentNode);
};
ScopeTree.prototype._getNodeByExternalId = function(id) {
  if (id === null) {
    return this._initialNode;
  }
  var node = this._nodes.get(id);
  if (!node) {
    throw new Error("Scope node for activity id '" + id + "' is not found.");
  }
  return node;
};
ScopeTree.prototype.deleteScopePart = function(currentNodeId, id) {
  var self = this;
  var currentNode = this._getNodeByExternalId(currentNodeId);
  var delNode = self._nodes.get(id);
  if (delNode) {
    if (delNode === self._initialNode) {
      throw new Error("Cannot delete the initial scope.");
    }
    var found = false;
    delNode.forEachToRoot(function(node) {
      if (node === currentNode) {
        found = true;
        return false;
      }
    });
    if (!found) {
      throw new Error("Cannot delete scope, because current active scope is inside in it.");
    }
    delNode.parent.removeChild(delNode);
    self._removeAllNodes(delNode);
  }
};
ScopeTree.prototype._removeAllNodes = function(node) {
  var self = this;
  self._nodes.remove(node.id);
  node.forEachChild(function(c) {
    self._removeAllNodes(c);
  });
};
module.exports = ScopeTree;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNjb3BlVHJlZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLFdBQVcsQ0FBQztBQUVaLEFBQUksRUFBQSxDQUFBLFNBQVEsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGFBQVksQ0FBQyxDQUFDO0FBQ3RDLEFBQUksRUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGlCQUFnQixDQUFDLENBQUM7QUFDdEMsQUFBSSxFQUFBLENBQUEsTUFBSyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsZUFBYyxDQUFDLFlBQVksT0FBTyxDQUFDO0FBQ3hELEFBQUksRUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGVBQWMsQ0FBQyxZQUFZLE9BQU8sQ0FBQztBQUN4RCxBQUFJLEVBQUEsQ0FBQSxDQUFBLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsQ0FBQztBQUN6QixBQUFJLEVBQUEsQ0FBQSxXQUFVLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyx1QkFBc0IsQ0FBQyxDQUFDO0FBQ2xELEFBQUksRUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGtCQUFpQixDQUFDLENBQUM7QUFDeEMsQUFBSSxFQUFBLENBQUEsRUFBQyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsY0FBYSxDQUFDLENBQUM7QUFDaEMsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsU0FBUSxDQUFDLENBQUM7QUFDOUIsQUFBSSxFQUFBLENBQUEsSUFBRyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsU0FBUSxDQUFDLENBQUM7QUFFN0IsT0FBUyxVQUFRLENBQUUsWUFBVyxDQUFHLENBQUEsbUJBQWtCLENBQUc7QUFDbEQsS0FBRyxhQUFhLEVBQUksSUFBSSxVQUFRLEFBQUMsQ0FBQyxLQUFJLElBQUksYUFBYSxDQUFHLGFBQVcsQ0FBQyxDQUFDO0FBQ3ZFLEtBQUcsT0FBTyxFQUFJLElBQUksT0FBSyxBQUFDLEVBQUMsQ0FBQztBQUMxQixLQUFHLE9BQU8sSUFBSSxBQUFDLENBQUMsSUFBRyxhQUFhLEdBQUcsQ0FBRyxDQUFBLElBQUcsYUFBYSxDQUFDLENBQUM7QUFDeEQsS0FBRyxpQkFBaUIsRUFBSSxvQkFBa0IsQ0FBQztBQUMvQztBQUFBLEFBR0EsUUFBUSxVQUFVLFNBQVMsRUFBSSxVQUFVLGFBQVksQ0FBRztBQUNwRCxBQUFJLElBQUEsQ0FBQSxJQUFHLEVBQUksS0FBRyxDQUFDO0FBQ2YsQUFBSSxJQUFBLENBQUEsS0FBSSxFQUFJLEdBQUMsQ0FBQztBQUNkLEFBQUksSUFBQSxDQUFBLGtCQUFpQixFQUFJLENBQUEsYUFBWSxFQUFJLElBQUksT0FBSyxBQUFDLEVBQUMsQ0FBQSxDQUFJLEtBQUcsQ0FBQztBQUU1RCxLQUFHLE9BQU8sYUFBYSxBQUFDLENBQ3BCLFNBQVUsSUFBRyxDQUFHO0FBQ1osT0FBSSxJQUFHLEdBQUcsSUFBTSxDQUFBLEtBQUksSUFBSSxhQUFhLENBQUc7QUFDcEMsYUFBTTtJQUNWO0FBQUEsQUFFSSxNQUFBLENBQUEsSUFBRyxFQUFJO0FBQ1AsT0FBQyxDQUFHLENBQUEsSUFBRyxHQUFHO0FBQ1YsYUFBTyxDQUFHLENBQUEsSUFBRyxPQUFPLEVBQUksQ0FBQSxJQUFHLE9BQU8sR0FBRyxFQUFJLEtBQUc7QUFDNUMsVUFBSSxDQUFHLEdBQUM7QUFBQSxJQUNaLENBQUM7QUFFRCxBQUFJLE1BQUEsQ0FBQSxRQUFPLEVBQUksQ0FBQSxJQUFHLGlCQUFpQixBQUFDLENBQUMsSUFBRyxHQUFHLENBQUMsQ0FBQztBQUU3QyxPQUFHLGdCQUFnQixBQUFDLENBQ2hCLFNBQVUsWUFBVyxDQUFHLENBQUEsYUFBWSxDQUFHO0FBQ25DLFNBQUksQ0FBQyxRQUFPLHdCQUF3QixPQUFPLEFBQUMsQ0FBQyxZQUFXLENBQUMsQ0FBRztBQUN4RCxXQUFJLENBQUEsUUFBUSxBQUFDLENBQUMsYUFBWSxDQUFDLENBQUc7QUFDMUIsQUFBSSxZQUFBLENBQUEsS0FBSSxFQUFJO0FBQ1IsZUFBRyxDQUFHLGFBQVc7QUFDakIsZ0JBQUksQ0FBRyxHQUFDO0FBQUEsVUFDWixDQUFDO0FBQ0QsYUFBRyxNQUFNLEtBQUssQUFBQyxDQUFDLEtBQUksQ0FBQyxDQUFDO0FBQ3RCLHNCQUFZLFFBQVEsQUFBQyxDQUFDLFNBQVUsRUFBQyxDQUFHO0FBQ2hDLGVBQUksRUFBQyxTQUFTLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBRztBQUNqQixrQkFBSSxNQUFNLEtBQUssQUFBQyxDQUFDLFdBQVUsUUFBUSwyQkFBMkIsQUFBQyxDQUFDLEVBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMzRSxLQUNLO0FBQ0Qsa0JBQUksTUFBTSxLQUFLLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztZQUN4QjtBQUFBLFVBQ0osQ0FBQyxDQUFDO1FBQ04sS0FDSyxLQUFJLEVBQUMsU0FBUyxBQUFDLENBQUMsYUFBWSxDQUFDLENBQUc7QUFDakMsYUFBRyxNQUFNLEtBQUssQUFBQyxDQUNYO0FBQ0ksZUFBRyxDQUFHLGFBQVc7QUFDakIsZ0JBQUksQ0FBRyxDQUFBLFdBQVUsUUFBUSwyQkFBMkIsQUFBQyxDQUFDLGFBQVksR0FBRyxDQUFDO0FBQUEsVUFDMUUsQ0FBQyxDQUFDO1FBQ1YsS0FDSyxLQUFJLENBQUEsV0FBVyxBQUFDLENBQUMsYUFBWSxDQUFDLENBQUEsRUFBSyxFQUFDLFFBQU8sZUFBZSxBQUFDLENBQUMsWUFBVyxDQUFDLENBQUEsRUFDekUsQ0FBQSxDQUFBLFdBQVcsQUFBQyxDQUFDLFFBQU8sQ0FBRSxZQUFXLENBQUMsQ0FBQyxDQUFHO0FBQ3RDLGFBQUcsTUFBTSxLQUFLLEFBQUMsQ0FBQyxXQUFVLFFBQVEsMkJBQTJCLEFBQUMsQ0FBQyxZQUFXLENBQUMsQ0FBQyxDQUFDO1FBQ2pGLEtBQ0ssS0FBSSxDQUFBLFNBQVMsQUFBQyxDQUFDLGFBQVksQ0FBQyxDQUFBLEVBQUssQ0FBQSxhQUFZLElBQU0sQ0FBQSxRQUFPLENBQUUsWUFBVyxDQUFDLENBQUc7QUFDNUUsYUFBRyxNQUFNLEtBQUssQUFBQyxDQUFDLFdBQVUsUUFBUSwyQkFBMkIsQUFBQyxDQUFDLFlBQVcsQ0FBQyxDQUFDLENBQUM7UUFDakYsS0FDSztBQUNELGFBQUcsTUFBTSxLQUFLLEFBQUMsQ0FBQztBQUNaLGVBQUcsQ0FBRyxhQUFXO0FBQ2pCLGdCQUFJLENBQUcsY0FBWTtBQUFBLFVBQ3ZCLENBQUMsQ0FBQztRQUNOO0FBQUEsTUFDSjtBQUFBLElBQ0osQ0FBQyxDQUFDO0FBQ04sUUFBSSxLQUFLLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztBQUdoQixPQUFJLGtCQUFpQixHQUFLLENBQUEsUUFBTyxtQkFBbUIsQ0FBRztBQUNuRCxhQUFPLG1CQUFtQixRQUFRLEFBQUMsQ0FDL0IsU0FBVSxnQkFBZSxDQUFHO0FBQ3hCLEFBQUksVUFBQSxDQUFBLEVBQUMsRUFBSSxDQUFBLElBQUcsaUJBQWlCLEFBQUMsQ0FBQyxnQkFBZSxDQUFHLEtBQUcsQ0FBQyxDQUFDO0FBQ3RELFdBQUksRUFBQyxRQUFRLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQSxFQUFLLEVBQUMsQ0FBQyxFQUFDLFNBQVMsQUFBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDLENBQUc7QUFDdEMsQUFBSSxZQUFBLENBQUEsYUFBWSxFQUFJLENBQUEsa0JBQWlCLElBQUksQUFBQyxDQUFDLGdCQUFlLENBQUMsQ0FBQztBQUU1RCxhQUFJLEVBQUMsVUFBVSxBQUFDLENBQUMsYUFBWSxDQUFDLENBQUEsRUFBSyxDQUFBLElBQUcsR0FBRyxFQUFJLENBQUEsYUFBWSxNQUFNLENBQUc7QUFDOUQsNkJBQWlCLElBQUksQUFBQyxDQUFDLGdCQUFlLENBQUc7QUFBRSxrQkFBSSxDQUFHLENBQUEsSUFBRyxHQUFHO0FBQUcsa0JBQUksQ0FBRyxHQUFDO0FBQUEsWUFBRSxDQUFDLENBQUM7VUFDM0U7QUFBQSxRQUNKO0FBQUEsTUFDSixDQUFDLENBQUM7SUFDVjtBQUFBLEVBQ0osQ0FBQyxDQUFDO0FBRU4sQUFBSSxJQUFBLENBQUEsZ0JBQWUsRUFBSSxLQUFHLENBQUM7QUFDM0IsS0FBSSxrQkFBaUIsQ0FBRztBQUNwQixtQkFBZSxFQUFJLEdBQUMsQ0FBQztBQUNyQixPQUFJLGtCQUFpQixNQUFNLENBQUc7QUFDMUIsdUJBQWlCLFFBQVEsQUFBQyxDQUN0QixTQUFVLEdBQUUsQ0FBRztBQUNYLHVCQUFlLENBQUUsR0FBRSxJQUFJLENBQUMsRUFBSSxDQUFBLEdBQUUsTUFBTSxNQUFNLENBQUM7TUFDL0MsQ0FBQyxDQUFDO0lBQ1Y7QUFBQSxFQUNKO0FBQUEsQUFFQSxPQUFPO0FBQ0gsUUFBSSxDQUFHLE1BQUk7QUFDWCxxQkFBaUIsQ0FBRyxpQkFBZTtBQUFBLEVBQ3ZDLENBQUM7QUFDTCxDQUFDO0FBRUQsUUFBUSxVQUFVLFNBQVMsRUFBSSxVQUFVLElBQUc7QUFDeEMsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUVmLEtBQUksQ0FBQyxDQUFBLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFHO0FBQ2xCLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQywwQkFBeUIsQ0FBQyxDQUFDO0VBQ25EO0FBQUEsQUFFQSxLQUFJLElBQUcsT0FBTyxNQUFNLElBQU0sRUFBQSxDQUFHO0FBRXpCLE9BQUcsT0FBTyxXQUFXLEFBQUMsQ0FDbEIsU0FBVSxHQUFFLENBQUc7QUFDWCxTQUFJLEdBQUUsSUFBTSxDQUFBLEtBQUksSUFBSSxhQUFhLENBQUc7QUFDaEMsZUFBTTtNQUNWO0FBQUEsQUFDQSxTQUFHLE9BQU8sT0FBTyxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUM7SUFDM0IsQ0FBQyxDQUFDO0FBRU4sT0FBRyxhQUFhLGNBQWMsQUFBQyxFQUFDLENBQUM7RUFDckM7QUFBQSxBQUVBLElBQUk7QUF0SUEsQUFBSSxNQUFBLFFBQW9CLEtBQUcsQ0FBQztBQUM1QixBQUFJLE1BQUEsUUFBb0IsTUFBSSxDQUFDO0FBQzdCLEFBQUksTUFBQSxRQUFvQixVQUFRLENBQUM7QUFDakMsTUFBSTtBQUhKLFVBQVMsR0FBQSxRQURqQixLQUFLLEVBQUEsQUFDNEI7QUFDaEIsZ0JBQW9CLENBQUEsQ0FzSVosSUFBRyxDQXRJMkIsQ0FDbEMsZUFBYyxXQUFXLEFBQUMsQ0FBQyxNQUFLLFNBQVMsQ0FBQyxDQUFDLEFBQUMsRUFBQyxDQUNyRCxFQUFDLENBQUMsT0FBb0IsQ0FBQSxDQUFDLE9BQW9CLENBQUEsVUFBcUIsQUFBQyxFQUFDLENBQUMsS0FBSyxDQUFDLENBQ3pFLFFBQW9CLEtBQUcsQ0FBRztVQW1JdEIsS0FBRztBQUFXO0FBQ25CLEFBQUksWUFBQSxDQUFBLFNBQVEsRUFBSSxHQUFDLENBQUM7QUFDbEIsQUFBSSxZQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsSUFBRyxpQkFBaUIsQUFBQyxDQUFDLElBQUcsR0FBRyxDQUFDLENBQUM7QUF6SWpELEFBQUksWUFBQSxRQUFvQixLQUFHLENBQUM7QUFDNUIsQUFBSSxZQUFBLFFBQW9CLE1BQUksQ0FBQztBQUM3QixBQUFJLFlBQUEsUUFBb0IsVUFBUSxDQUFDO0FBQ2pDLFlBQUk7QUFISixnQkFBUyxHQUFBLE9BRGpCLEtBQUssRUFBQSxBQUM0QjtBQUNoQixxQkFBb0IsQ0FBQSxDQXlJUixJQUFHLE1BQU0sQ0F6SWlCLENBQ2xDLGVBQWMsV0FBVyxBQUFDLENBQUMsTUFBSyxTQUFTLENBQUMsQ0FBQyxBQUFDLEVBQUMsQ0FDckQsRUFBQyxDQUFDLE9BQW9CLENBQUEsQ0FBQyxNQUFvQixDQUFBLFNBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RSxRQUFvQixLQUFHLENBQUc7Z0JBc0lsQixLQUFHO0FBQWlCO0FBQ3pCLEFBQUksa0JBQUEsQ0FBQSxnQkFBZSxFQUFJLENBQUEsV0FBVSxRQUFRLHdCQUF3QixBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFDeEUsbUJBQUksZ0JBQWUsQ0FBRztBQUNsQixxQkFBSSxDQUFBLFlBQVksQUFBQyxDQUFDLFNBQVEsQ0FBRSxnQkFBZSxDQUFDLEVBQUksQ0FBQSxRQUFPLENBQUUsZ0JBQWUsQ0FBQyxDQUFDLENBQUc7QUFDekUsd0JBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyw0QkFBMkIsRUFBSSxLQUFHLENBQUEsQ0FBSSxLQUFHLENBQUMsQ0FBQztrQkFDL0Q7QUFBQSxnQkFDSixLQUNLO0FBQ0QsQUFBSSxvQkFBQSxDQUFBLFVBQVMsRUFBSSxDQUFBLFdBQVUsUUFBUSxjQUFjLEFBQUMsQ0FBQyxJQUFHLE1BQU0sQ0FBQyxDQUFDO0FBQzlELHFCQUFJLFVBQVMsQ0FBRztBQUNaLDRCQUFRLENBQUUsSUFBRyxLQUFLLENBQUMsRUFBSSxDQUFBLElBQUcsaUJBQWlCLEFBQUMsQ0FBQyxVQUFTLENBQUMsQ0FBQztrQkFDNUQsS0FDSyxLQUFJLENBQUEsUUFBUSxBQUFDLENBQUMsSUFBRyxNQUFNLENBQUMsQ0FBRztBQUM1QixBQUFJLHNCQUFBLENBQUEsY0FBYSxFQUFJLEdBQUMsQ0FBQztBQUN2Qiw0QkFBUSxDQUFFLElBQUcsS0FBSyxDQUFDLEVBQUksZUFBYSxDQUFDO0FBeEpyRCxBQUFJLHNCQUFBLE9BQW9CLEtBQUcsQ0FBQztBQUM1QixBQUFJLHNCQUFBLE9BQW9CLE1BQUksQ0FBQztBQUM3QixBQUFJLHNCQUFBLE9BQW9CLFVBQVEsQ0FBQztBQUNqQyxzQkFBSTtBQUhKLDBCQUFTLEdBQUEsT0FEakIsS0FBSyxFQUFBLEFBQzRCO0FBQ2hCLCtCQUFvQixDQUFBLENBd0pFLElBQUcsTUFBTSxDQXhKTyxDQUNsQyxlQUFjLFdBQVcsQUFBQyxDQUFDLE1BQUssU0FBUyxDQUFDLENBQUMsQUFBQyxFQUFDLENBQ3JELEVBQUMsQ0FBQyxNQUFvQixDQUFBLENBQUMsTUFBb0IsQ0FBQSxTQUFxQixBQUFDLEVBQUMsQ0FBQyxLQUFLLENBQUMsQ0FDekUsT0FBb0IsS0FBRyxDQUFHOzBCQXFKTixHQUFDO0FBQWlCO0FBQ3ZCLG1DQUFTLEVBQUksQ0FBQSxXQUFVLFFBQVEsY0FBYyxBQUFDLENBQUMsRUFBQyxDQUFDLENBQUM7QUFDbEQsNkJBQUksVUFBUyxDQUFHO0FBQ1oseUNBQWEsS0FBSyxBQUFDLENBQUMsSUFBRyxpQkFBaUIsQUFBQyxDQUFDLFVBQVMsQ0FBQyxDQUFDLENBQUM7MEJBQzFELEtBQ0s7QUFDRCx5Q0FBYSxLQUFLLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQzswQkFDM0I7QUFBQSx3QkFDSjtzQkExSmhCO0FBQUEsb0JBRkEsQ0FBRSxZQUEwQjtBQUMxQiwyQkFBb0IsS0FBRyxDQUFDO0FBQ3hCLGdDQUFvQyxDQUFDO29CQUN2QyxDQUFFLE9BQVE7QUFDUix3QkFBSTtBQUNGLDJCQUFJLEtBQWlCLEdBQUssQ0FBQSxXQUF1QixHQUFLLEtBQUcsQ0FBRztBQUMxRCxvQ0FBd0IsQUFBQyxFQUFDLENBQUM7d0JBQzdCO0FBQUEsc0JBQ0YsQ0FBRSxPQUFRO0FBQ1IsZ0NBQXdCO0FBQ3RCLG9DQUF3Qjt3QkFDMUI7QUFBQSxzQkFDRjtBQUFBLG9CQUNGO0FBQUEsa0JBZ0pZLEtBQ0s7QUFDRCw0QkFBUSxDQUFFLElBQUcsS0FBSyxDQUFDLEVBQUksQ0FBQSxJQUFHLE1BQU0sQ0FBQztrQkFDckM7QUFBQSxnQkFDSjtBQUFBLGNBQ0o7WUFoS0o7QUFBQSxVQUZBLENBQUUsYUFBMEI7QUFDMUIsa0JBQW9CLEtBQUcsQ0FBQztBQUN4Qix3QkFBb0MsQ0FBQztVQUN2QyxDQUFFLE9BQVE7QUFDUixjQUFJO0FBQ0YsaUJBQUksTUFBaUIsR0FBSyxDQUFBLFdBQXVCLEdBQUssS0FBRyxDQUFHO0FBQzFELDBCQUF3QixBQUFDLEVBQUMsQ0FBQztjQUM3QjtBQUFBLFlBQ0YsQ0FBRSxPQUFRO0FBQ1IsdUJBQXdCO0FBQ3RCLDJCQUF3QjtjQUMxQjtBQUFBLFlBQ0Y7QUFBQSxVQUNGO0FBQUEsQUFzSlEsWUFBQSxDQUFBLElBQUcsRUFBSSxJQUFJLFVBQVEsQUFBQyxDQUFDLElBQUcsR0FBRyxDQUFHLFVBQVEsQ0FBQyxDQUFDO0FBQzVDLGFBQUcsT0FBTyxJQUFJLEFBQUMsQ0FBQyxJQUFHLEdBQUcsQ0FBRyxLQUFHLENBQUMsQ0FBQztRQUNsQztNQW5LQTtBQUFBLElBRkEsQ0FBRSxhQUEwQjtBQUMxQixZQUFvQixLQUFHLENBQUM7QUFDeEIsa0JBQW9DLENBQUM7SUFDdkMsQ0FBRSxPQUFRO0FBQ1IsUUFBSTtBQUNGLFdBQUksTUFBaUIsR0FBSyxDQUFBLFlBQXVCLEdBQUssS0FBRyxDQUFHO0FBQzFELHFCQUF3QixBQUFDLEVBQUMsQ0FBQztRQUM3QjtBQUFBLE1BQ0YsQ0FBRSxPQUFRO0FBQ1IsaUJBQXdCO0FBQ3RCLHFCQUF3QjtRQUMxQjtBQUFBLE1BQ0Y7QUFBQSxJQUNGO0FBQUEsQUFsQkksTUFBQSxRQUFvQixLQUFHLENBQUM7QUFDNUIsQUFBSSxNQUFBLFFBQW9CLE1BQUksQ0FBQztBQUM3QixBQUFJLE1BQUEsUUFBb0IsVUFBUSxDQUFDO0FBQ2pDLE1BQUk7QUFISixVQUFTLEdBQUEsUUFEakIsS0FBSyxFQUFBLEFBQzRCO0FBQ2hCLGdCQUFvQixDQUFBLENBMktaLElBQUcsQ0EzSzJCLENBQ2xDLGVBQWMsV0FBVyxBQUFDLENBQUMsTUFBSyxTQUFTLENBQUMsQ0FBQyxBQUFDLEVBQUMsQ0FDckQsRUFBQyxDQUFDLE9BQW9CLENBQUEsQ0FBQyxPQUFvQixDQUFBLFVBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RSxRQUFvQixLQUFHLENBQUc7VUF3S3RCLFVBQUc7QUFBVztBQUNuQixhQUFHLE9BQU8sSUFBSSxBQUFDLENBQUMsWUFBTSxDQUFDLE9BQU8sRUFBSSxDQUFBLElBQUcsT0FBTyxJQUFJLEFBQUMsQ0FBQyxrQkFBWSxDQUFDLENBQUM7UUFDcEU7TUF2S0E7QUFBQSxJQUZBLENBQUUsYUFBMEI7QUFDMUIsWUFBb0IsS0FBRyxDQUFDO0FBQ3hCLGtCQUFvQyxDQUFDO0lBQ3ZDLENBQUUsT0FBUTtBQUNSLFFBQUk7QUFDRixXQUFJLE1BQWlCLEdBQUssQ0FBQSxZQUF1QixHQUFLLEtBQUcsQ0FBRztBQUMxRCxxQkFBd0IsQUFBQyxFQUFDLENBQUM7UUFDN0I7QUFBQSxNQUNGLENBQUUsT0FBUTtBQUNSLGlCQUF3QjtBQUN0QixxQkFBd0I7UUFDMUI7QUFBQSxNQUNGO0FBQUEsSUFDRjtBQUFBLEVBNkpKLENBQ0EsT0FBTyxDQUFBLENBQUc7QUFDTixRQUFNLElBQUksQ0FBQSxNQUFLLGNBQWMsQUFBQyxDQUFDLG1FQUFrRSxFQUFJLENBQUEsQ0FBQSxNQUFNLENBQUMsQ0FBQztFQUNqSDtBQUFBLEFBQ0osQ0FBQztBQUlELFFBQVEsVUFBVSxZQUFZLEVBQUksVUFBVSxXQUFVLENBQUcsQ0FBQSxJQUFHLENBQUc7QUFDM0QsQUFBSSxJQUFBLENBQUEsS0FBSSxFQUFJLE1BQUksQ0FBQztBQUNqQixZQUFVLGNBQWMsQUFBQyxDQUFDLFNBQVUsSUFBRyxDQUFHO0FBQ3RDLE9BQUksSUFBRyxpQkFBaUIsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFHO0FBQzdCLFVBQUksRUFBSSxLQUFHLENBQUM7QUFDWixXQUFPLE1BQUksQ0FBQztJQUNoQjtBQUFBLEVBQ0osQ0FBQyxDQUFDO0FBQ0YsT0FBTyxNQUFJLENBQUM7QUFDaEIsQ0FBQztBQUVELFFBQVEsVUFBVSxTQUFTLEVBQUksVUFBVSxXQUFVLENBQUcsQ0FBQSxJQUFHLENBQUc7QUFDeEQsQUFBSSxJQUFBLENBQUEsZ0JBQWUsRUFBSSxLQUFHLENBQUM7QUFDM0IsQUFBSSxJQUFBLENBQUEsS0FBSSxDQUFDO0FBQ1QsWUFBVSxjQUFjLEFBQUMsQ0FBQyxTQUFVLElBQUcsQ0FBRztBQUN0QyxPQUFJLEVBQUMsUUFBUSxBQUFDLENBQUMsS0FBSSxFQUFJLENBQUEsSUFBRyxpQkFBaUIsQUFBQyxDQUFDLElBQUcsQ0FBRyxpQkFBZSxDQUFDLENBQUMsQ0FBRztBQUNuRSxXQUFPLE1BQUksQ0FBQztJQUNoQjtBQUFBLEFBQ0EsbUJBQWUsRUFBSSxNQUFJLENBQUM7RUFDNUIsQ0FBQyxDQUFDO0FBQ0YsT0FBTyxNQUFJLENBQUM7QUFDaEIsQ0FBQztBQUVELFFBQVEsVUFBVSxTQUFTLEVBQUksVUFBVSxXQUFVLENBQUcsQ0FBQSxJQUFHLENBQUcsQ0FBQSxLQUFJLENBQUc7QUFDL0QsS0FBSSxJQUFHLFlBQVksQ0FBRztBQUNsQixRQUFNLElBQUksTUFBSSxBQUFDLENBQUMsMkNBQTBDLENBQUMsQ0FBQztFQUNoRTtBQUFBLEFBRUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixBQUFJLElBQUEsQ0FBQSxhQUFZLEVBQUksS0FBRyxDQUFDO0FBQ3hCLEFBQUksSUFBQSxDQUFBLE9BQU0sRUFBSSxNQUFJLENBQUM7QUFDbkIsWUFBVSxjQUFjLEFBQUMsQ0FBQyxTQUFVLElBQUcsQ0FBRztBQUN0QyxPQUFJLElBQUcsSUFBTSxDQUFBLElBQUcsYUFBYSxDQUFHO0FBQzVCLFdBQU8sTUFBSSxDQUFDO0lBQ2hCO0FBQUEsQUFDQSxPQUFJLElBQUcsaUJBQWlCLEFBQUMsQ0FBQyxJQUFHLENBQUcsTUFBSSxDQUFHLGNBQVksQ0FBQyxDQUFHO0FBQ25ELFlBQU0sRUFBSSxLQUFHLENBQUM7QUFDZCxXQUFPLE1BQUksQ0FBQztJQUNoQjtBQUFBLEFBQ0EsZ0JBQVksRUFBSSxNQUFJLENBQUM7RUFDekIsQ0FBQyxDQUFDO0FBRUYsS0FBSSxDQUFDLE9BQU0sQ0FBRztBQUNWLGNBQVUsd0JBQXdCLEFBQUMsQ0FBQyxJQUFHLENBQUcsTUFBSSxDQUFDLENBQUM7RUFDcEQ7QUFBQSxBQUVBLE9BQU8sS0FBRyxDQUFDO0FBQ2YsQ0FBQztBQUVELFFBQVEsVUFBVSxlQUFlLEVBQUksVUFBVSxXQUFVLENBQUcsQ0FBQSxJQUFHLENBQUc7QUFDOUQsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUNmLEFBQUksSUFBQSxDQUFBLGdCQUFlLEVBQUksS0FBRyxDQUFDO0FBQzNCLEFBQUksSUFBQSxDQUFBLFVBQVMsRUFBSSxNQUFJLENBQUM7QUFDdEIsWUFBVSxjQUFjLEFBQUMsQ0FBQyxTQUFVLElBQUcsQ0FBRztBQUN0QyxPQUFJLElBQUcsSUFBTSxDQUFBLElBQUcsYUFBYSxDQUFHO0FBQzVCLFdBQU8sTUFBSSxDQUFDO0lBQ2hCO0FBQUEsQUFDQSxPQUFJLElBQUcsZUFBZSxBQUFDLENBQUMsSUFBRyxDQUFHLGlCQUFlLENBQUMsQ0FBRztBQUM3QyxlQUFTLEVBQUksS0FBRyxDQUFDO0FBQ2pCLFdBQU8sTUFBSSxDQUFDO0lBQ2hCO0FBQUEsQUFDQSxtQkFBZSxFQUFJLE1BQUksQ0FBQztFQUM1QixDQUFDLENBQUM7QUFFRixPQUFPLFdBQVMsQ0FBQztBQUNyQixDQUFDO0FBRUQsUUFBUSxVQUFVLHVCQUF1QixFQTNQekMsQ0FBQSxlQUFjLHNCQUFzQixBQUFDLENBMlBRLGVBQVcsV0FBVTs7Ozs7QUEzUGxFLE9BQU8sQ0FBUCxlQUFjLHdCQUF3QixBQUFkLENBQXhCLFNBQVMsSUFBRyxDQUFHO0FBQ1QsVUFBTyxJQUFHOzs7OEJBMlBjLEtBQUc7ZUFDbEIsWUFBVTs7OztBQTVQakIsZ0JBQW9CLENBQUEsSUFBRyxjQUFjLEFBQUMsQ0FBQyxBQStQaEMsSUFBRyx1QkFBdUIsQUFBQyxDQUFDLG1CQUFrQixDQUFDLENBL1BHLE1BQUssU0FBUyxDQUFDLEFBQUMsRUFBQyxDQUFDLENBQUM7QUFFNUUsYUFBRyxLQUFLLEVBQUksS0FBSyxFQUFBLENBQUM7QUFFbEIsYUFBRyxPQUFPLEVBQUksT0FBSyxDQUFDOzs7O0FBR2xCLGdCQUFvQixDQUFBLE1BQWtCLElBQUcsT0FBTyxDQUFDLEFBQUMsQ0FBQyxJQUFHLGdCQUFnQixDQUFDLENBQUM7Ozs7QUFSbEYsYUFBRyxNQUFNLEVBQUksQ0FBQSxDQVNDLFVBQXFCLENBVEosUUFBd0MsQ0FBQztBQUNoRSxlQUFJOztBQVNBLGFBQUcsS0FBSyxFQUFJLFlBQXNCLENBQUM7Ozs7O0FBVi9DLGVBYWdCLFlBQXNCLENBYmY7O0FBaVFmLDRCQUFrQixFQUFJLE1BQUksQ0FBQztBQUMzQixhQUFHLEVBQUksQ0FBQSxJQUFHLE9BQU8sQ0FBQzs7OztBQWxRMUIsYUFBRyxNQUFNLEVBQUksQ0FBQSxDQW9RRixJQUFHLENBcFFpQixVQUF3QyxDQUFDO0FBQ2hFLGVBQUk7O0FBRFosZUFBTyxDQUFBLElBQUcsSUFBSSxBQUFDLEVBQUMsQ0FBQTs7QUFDbUIsRUFDL0IsUUFBNkIsS0FBRyxDQUFDLENBQUM7QUFtUXRDLENBclF1RCxBQXFRdkQsQ0FBQztBQUlELFFBQVEsVUFBVSxLQUFLLEVBQUksVUFBVSxNQUFLLENBQUcsQ0FBQSxPQUFNLENBQUcsQ0FBQSxTQUFRLENBQUc7QUFDN0QsQUFBSSxJQUFBLENBQUEsV0FBVSxFQUFJLENBQUEsSUFBRyxxQkFBcUIsQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQ25ELEFBQUksSUFBQSxDQUFBLFFBQU8sRUFBSSxJQUFJLFVBQVEsQUFBQyxDQUFDLE9BQU0sQ0FBRyxVQUFRLENBQUMsQ0FBQztBQUNoRCxZQUFVLFNBQVMsQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0FBQzlCLEtBQUcsT0FBTyxJQUFJLEFBQUMsQ0FBQyxPQUFNLENBQUcsU0FBTyxDQUFDLENBQUM7QUFDbEMsT0FBTyxDQUFBLEtBQUksT0FBTyxBQUFDLENBQUMsSUFBRyxDQUFHLFNBQU8sQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxRQUFRLFVBQVUsS0FBSyxFQUFJLFVBQVUsTUFBSyxDQUFHLENBQUEsUUFBTyxDQUFHO0FBQ25ELEFBQUksSUFBQSxDQUFBLFdBQVUsRUFBSSxDQUFBLElBQUcscUJBQXFCLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQztBQUNuRCxLQUFJLFdBQVUsSUFBTSxDQUFBLElBQUcsYUFBYSxDQUFHO0FBQ25DLFFBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyw0REFBMkQsQ0FBQyxDQUFDO0VBQ2pGO0FBQUEsQUFDSSxJQUFBLENBQUEsUUFBTyxFQUFJLFlBQVUsQ0FBQztBQUMxQixBQUFJLElBQUEsQ0FBQSxJQUFHLEVBQUksQ0FBQSxRQUFPLE9BQU8sQ0FBQztBQUMxQixZQUFVLEVBQUksS0FBRyxDQUFDO0FBQ2xCLEtBQUksQ0FBQyxRQUFPLENBQUc7QUFDWCxPQUFHLFlBQVksQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0FBQzFCLE9BQUcsT0FBTyxPQUFPLEFBQUMsQ0FBQyxRQUFPLEdBQUcsQ0FBQyxDQUFDO0VBQ25DO0FBQUEsQUFDQSxPQUFPLENBQUEsS0FBSSxPQUFPLEFBQUMsQ0FBQyxJQUFHLENBQUcsWUFBVSxDQUFDLENBQUM7QUFDMUMsQ0FBQztBQUVELFFBQVEsVUFBVSxLQUFLLEVBQUksVUFBVSxNQUFLLENBQUc7QUFDekMsQUFBSSxJQUFBLENBQUEsV0FBVSxFQUFJLENBQUEsSUFBRyxxQkFBcUIsQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQ25ELE9BQU8sQ0FBQSxLQUFJLE9BQU8sQUFBQyxDQUFDLElBQUcsQ0FBRyxZQUFVLENBQUMsQ0FBQztBQUMxQyxDQUFDO0FBR0QsUUFBUSxVQUFVLHFCQUFxQixFQUFJLFVBQVUsRUFBQyxDQUFHO0FBQ3JELEtBQUksRUFBQyxJQUFNLEtBQUcsQ0FBRztBQUNiLFNBQU8sQ0FBQSxJQUFHLGFBQWEsQ0FBQztFQUM1QjtBQUFBLEFBQ0ksSUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLElBQUcsT0FBTyxJQUFJLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztBQUM5QixLQUFJLENBQUMsSUFBRyxDQUFHO0FBQ1AsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLDhCQUE2QixFQUFJLEdBQUMsQ0FBQSxDQUFJLGtCQUFnQixDQUFDLENBQUM7RUFDNUU7QUFBQSxBQUNBLE9BQU8sS0FBRyxDQUFDO0FBQ2YsQ0FBQztBQUVELFFBQVEsVUFBVSxnQkFBZ0IsRUFBSSxVQUFVLGFBQVksQ0FBRyxDQUFBLEVBQUMsQ0FBRztBQUMvRCxBQUFJLElBQUEsQ0FBQSxJQUFHLEVBQUksS0FBRyxDQUFDO0FBQ2YsQUFBSSxJQUFBLENBQUEsV0FBVSxFQUFJLENBQUEsSUFBRyxxQkFBcUIsQUFBQyxDQUFDLGFBQVksQ0FBQyxDQUFDO0FBQzFELEFBQUksSUFBQSxDQUFBLE9BQU0sRUFBSSxDQUFBLElBQUcsT0FBTyxJQUFJLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztBQUNqQyxLQUFJLE9BQU0sQ0FBRztBQUNULE9BQUksT0FBTSxJQUFNLENBQUEsSUFBRyxhQUFhLENBQUc7QUFDL0IsVUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLGtDQUFpQyxDQUFDLENBQUM7SUFDdkQ7QUFBQSxBQUNJLE1BQUEsQ0FBQSxLQUFJLEVBQUksTUFBSSxDQUFDO0FBQ2pCLFVBQU0sY0FBYyxBQUFDLENBQ2pCLFNBQVUsSUFBRyxDQUFHO0FBQ1osU0FBSSxJQUFHLElBQU0sWUFBVSxDQUFHO0FBQ3RCLFlBQUksRUFBSSxLQUFHLENBQUM7QUFDWixhQUFPLE1BQUksQ0FBQztNQUNoQjtBQUFBLElBQ0osQ0FBQyxDQUFDO0FBQ04sT0FBSSxDQUFDLEtBQUksQ0FBRztBQUNSLFVBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyxvRUFBbUUsQ0FBQyxDQUFDO0lBQ3pGO0FBQUEsQUFDQSxVQUFNLE9BQU8sWUFBWSxBQUFDLENBQUMsT0FBTSxDQUFDLENBQUM7QUFDbkMsT0FBRyxnQkFBZ0IsQUFBQyxDQUFDLE9BQU0sQ0FBQyxDQUFDO0VBQ2pDO0FBQUEsQUFDSixDQUFDO0FBRUQsUUFBUSxVQUFVLGdCQUFnQixFQUFJLFVBQVUsSUFBRyxDQUFHO0FBQ2xELEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFFZixLQUFHLE9BQU8sT0FBTyxBQUFDLENBQUMsSUFBRyxHQUFHLENBQUMsQ0FBQztBQUMzQixLQUFHLGFBQWEsQUFBQyxDQUFDLFNBQVUsQ0FBQSxDQUFHO0FBQzNCLE9BQUcsZ0JBQWdCLEFBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQztFQUMzQixDQUFDLENBQUM7QUFDTixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksVUFBUSxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9zY29wZVRyZWUuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5sZXQgU2NvcGVOb2RlID0gcmVxdWlyZShcIi4vc2NvcGVOb2RlXCIpO1xubGV0IGd1aWRzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9ndWlkc1wiKTtcbmxldCBTdHJNYXAgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5jb2xsZWN0aW9ucy5TdHJNYXA7XG5sZXQgU3RyU2V0ID0gcmVxdWlyZShcImJhY2twYWNrLW5vZGVcIikuY29sbGVjdGlvbnMuU3RyU2V0O1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IHNwZWNTdHJpbmdzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9zcGVjU3RyaW5nc1wiKTtcbmxldCBlcnJvcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2Vycm9yc1wiKTtcbmxldCBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XG5sZXQgc2NvcGUgPSByZXF1aXJlKFwiLi9zY29wZVwiKTtcbmxldCBmYXN0ID0gcmVxdWlyZShcImZhc3QuanNcIik7XG5cbmZ1bmN0aW9uIFNjb3BlVHJlZShpbml0aWFsU2NvcGUsIGdldEFjdGl2aXR5QnlJZEZ1bmMpIHtcbiAgICB0aGlzLl9pbml0aWFsTm9kZSA9IG5ldyBTY29wZU5vZGUoZ3VpZHMuaWRzLmluaXRpYWxTY29wZSwgaW5pdGlhbFNjb3BlKTtcbiAgICB0aGlzLl9ub2RlcyA9IG5ldyBTdHJNYXAoKTtcbiAgICB0aGlzLl9ub2Rlcy5hZGQodGhpcy5faW5pdGlhbE5vZGUuaWQsIHRoaXMuX2luaXRpYWxOb2RlKTtcbiAgICB0aGlzLl9nZXRBY3Rpdml0eUJ5SWQgPSBnZXRBY3Rpdml0eUJ5SWRGdW5jO1xufVxuXG4vKiBTRVJJQUxJWkFUSU9OICovXG5TY29wZVRyZWUucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKGdldFByb21vdGlvbnMpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IHN0YXRlID0gW107XG4gICAgbGV0IHByb21vdGVkUHJvcGVydGllcyA9IGdldFByb21vdGlvbnMgPyBuZXcgU3RyTWFwKCkgOiBudWxsO1xuXG4gICAgc2VsZi5fbm9kZXMuZm9yRWFjaFZhbHVlKFxuICAgICAgICBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICAgICAgaWYgKG5vZGUuaWQgPT09IGd1aWRzLmlkcy5pbml0aWFsU2NvcGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBpdGVtID0ge1xuICAgICAgICAgICAgICAgIGlkOiBub2RlLmlkLFxuICAgICAgICAgICAgICAgIHBhcmVudElkOiBub2RlLnBhcmVudCA/IG5vZGUucGFyZW50LmlkIDogbnVsbCxcbiAgICAgICAgICAgICAgICBwYXJ0czogW11cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCBhY3Rpdml0eSA9IHNlbGYuX2dldEFjdGl2aXR5QnlJZChub2RlLmlkKTtcblxuICAgICAgICAgICAgbm9kZS5mb3JFYWNoUHJvcGVydHkoXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKHByb3BlcnR5TmFtZSwgcHJvcGVydHlWYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWFjdGl2aXR5Lm5vblNlcmlhbGl6ZWRQcm9wZXJ0aWVzLmV4aXN0cyhwcm9wZXJ0eU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc0FycmF5KHByb3BlcnR5VmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGlQYXJ0ID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBwcm9wZXJ0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBbXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5wYXJ0cy5wdXNoKGlQYXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eVZhbHVlLmZvckVhY2goZnVuY3Rpb24gKHB2KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpcy5hY3Rpdml0eShwdikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlQYXJ0LnZhbHVlLnB1c2goc3BlY1N0cmluZ3MuaG9zdGluZy5jcmVhdGVBY3Rpdml0eUluc3RhbmNlUGFydChwdi5pZCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaVBhcnQudmFsdWUucHVzaChwdik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzLmFjdGl2aXR5KHByb3BlcnR5VmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5wYXJ0cy5wdXNoKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBwcm9wZXJ0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc3BlY1N0cmluZ3MuaG9zdGluZy5jcmVhdGVBY3Rpdml0eUluc3RhbmNlUGFydChwcm9wZXJ0eVZhbHVlLmlkKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF8uaXNGdW5jdGlvbihwcm9wZXJ0eVZhbHVlKSAmJiAhYWN0aXZpdHkuaGFzT3duUHJvcGVydHkocHJvcGVydHlOYW1lKSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNGdW5jdGlvbihhY3Rpdml0eVtwcm9wZXJ0eU5hbWVdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ucGFydHMucHVzaChzcGVjU3RyaW5ncy5ob3N0aW5nLmNyZWF0ZUFjdGl2aXR5UHJvcGVydHlQYXJ0KHByb3BlcnR5TmFtZSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoXy5pc09iamVjdChwcm9wZXJ0eVZhbHVlKSAmJiBwcm9wZXJ0eVZhbHVlID09PSBhY3Rpdml0eVtwcm9wZXJ0eU5hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5wYXJ0cy5wdXNoKHNwZWNTdHJpbmdzLmhvc3RpbmcuY3JlYXRlQWN0aXZpdHlQcm9wZXJ0eVBhcnQocHJvcGVydHlOYW1lKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnBhcnRzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBwcm9wZXJ0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcm9wZXJ0eVZhbHVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHN0YXRlLnB1c2goaXRlbSk7XG5cbiAgICAgICAgICAgIC8vIFByb21vdGlvbnM6XG4gICAgICAgICAgICBpZiAocHJvbW90ZWRQcm9wZXJ0aWVzICYmIGFjdGl2aXR5LnByb21vdGVkUHJvcGVydGllcykge1xuICAgICAgICAgICAgICAgIGFjdGl2aXR5LnByb21vdGVkUHJvcGVydGllcy5mb3JFYWNoKFxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAocHJvbW90ZWRQcm9wTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHB2ID0gbm9kZS5nZXRQcm9wZXJ0eVZhbHVlKHByb21vdGVkUHJvcE5hbWUsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzLmRlZmluZWQocHYpICYmICEoaXMuYWN0aXZpdHkocHYpKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwcm9tb3RlZEVudHJ5ID0gcHJvbW90ZWRQcm9wZXJ0aWVzLmdldChwcm9tb3RlZFByb3BOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBhbiBBY3Rpdml0eSBJZCBncmVhdGVyIHRoYW4gb3RoZXIsIHRoZW4gd2UgY2FuIHN1cmUgdGhhdCBvdGhlciBiZWxvdyBvciBhZnRlciBpbiB0aGUgdHJlZS5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXMudW5kZWZpbmVkKHByb21vdGVkRW50cnkpIHx8IG5vZGUuaWQgPiBwcm9tb3RlZEVudHJ5LmxldmVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21vdGVkUHJvcGVydGllcy5hZGQocHJvbW90ZWRQcm9wTmFtZSwgeyBsZXZlbDogbm9kZS5pZCwgdmFsdWU6IHB2IH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgbGV0IGFjdHVhbFByb21vdGlvbnMgPSBudWxsO1xuICAgIGlmIChwcm9tb3RlZFByb3BlcnRpZXMpIHtcbiAgICAgICAgYWN0dWFsUHJvbW90aW9ucyA9IHt9O1xuICAgICAgICBpZiAocHJvbW90ZWRQcm9wZXJ0aWVzLmNvdW50KSB7XG4gICAgICAgICAgICBwcm9tb3RlZFByb3BlcnRpZXMuZm9yRWFjaChcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoa3ZwKSB7XG4gICAgICAgICAgICAgICAgICAgIGFjdHVhbFByb21vdGlvbnNba3ZwLmtleV0gPSBrdnAudmFsdWUudmFsdWU7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBzdGF0ZTogc3RhdGUsXG4gICAgICAgIHByb21vdGVkUHJvcGVydGllczogYWN0dWFsUHJvbW90aW9uc1xuICAgIH07XG59O1xuXG5TY29wZVRyZWUucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKGpzb24pIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG5cbiAgICBpZiAoIV8uaXNBcnJheShqc29uKSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJyYXkgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xuICAgIH1cblxuICAgIGlmIChzZWxmLl9ub2Rlcy5jb3VudCAhPT0gMSkge1xuICAgICAgICAvLyBUaGVyZSBhcmUgaGlkZGVuIGlkbGUgc3RhdGU6XG4gICAgICAgIHNlbGYuX25vZGVzLmZvckVhY2hLZXkoXG4gICAgICAgICAgICBmdW5jdGlvbiAoa2V5KSB7XG4gICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gZ3VpZHMuaWRzLmluaXRpYWxTY29wZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNlbGYuX25vZGVzLnJlbW92ZShrZXkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgc2VsZi5faW5pdGlhbE5vZGUuY2xlYXJDaGlsZHJlbigpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAgIGZvciAobGV0IGl0ZW0gb2YganNvbikge1xuICAgICAgICAgICAgbGV0IHNjb3BlUGFydCA9IHt9O1xuICAgICAgICAgICAgbGV0IGFjdGl2aXR5ID0gc2VsZi5fZ2V0QWN0aXZpdHlCeUlkKGl0ZW0uaWQpO1xuICAgICAgICAgICAgZm9yIChsZXQgcGFydCBvZiBpdGVtLnBhcnRzKSB7XG4gICAgICAgICAgICAgICAgbGV0IGFjdGl2aXR5UHJvcGVydHkgPSBzcGVjU3RyaW5ncy5ob3N0aW5nLmdldEFjdGl2aXR5UHJvcGVydHlOYW1lKHBhcnQpO1xuICAgICAgICAgICAgICAgIGlmIChhY3Rpdml0eVByb3BlcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKHNjb3BlUGFydFthY3Rpdml0eVByb3BlcnR5XSA9IGFjdGl2aXR5W2FjdGl2aXR5UHJvcGVydHldKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQWN0aXZpdHkgaGFzIG5vIHByb3BlcnR5ICdcIiArIHBhcnQgKyBcIicuXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aXZpdHlJZCA9IHNwZWNTdHJpbmdzLmhvc3RpbmcuZ2V0QWN0aXZpdHlJZChwYXJ0LnZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2aXR5SWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlUGFydFtwYXJ0Lm5hbWVdID0gc2VsZi5fZ2V0QWN0aXZpdHlCeUlkKGFjdGl2aXR5SWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF8uaXNBcnJheShwYXJ0LnZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNjb3BlUGFydFZhbHVlID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBzY29wZVBhcnRbcGFydC5uYW1lXSA9IHNjb3BlUGFydFZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgcHYgb2YgcGFydC52YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5SWQgPSBzcGVjU3RyaW5ncy5ob3N0aW5nLmdldEFjdGl2aXR5SWQocHYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpdml0eUlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlUGFydFZhbHVlLnB1c2goc2VsZi5fZ2V0QWN0aXZpdHlCeUlkKGFjdGl2aXR5SWQpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlUGFydFZhbHVlLnB1c2gocHYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlUGFydFtwYXJ0Lm5hbWVdID0gcGFydC52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBub2RlID0gbmV3IFNjb3BlTm9kZShpdGVtLmlkLCBzY29wZVBhcnQpO1xuICAgICAgICAgICAgc2VsZi5fbm9kZXMuYWRkKGl0ZW0uaWQsIG5vZGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgaXRlbSBvZiBqc29uKSB7XG4gICAgICAgICAgICBzZWxmLl9ub2Rlcy5nZXQoaXRlbS5pZCkucGFyZW50ID0gc2VsZi5fbm9kZXMuZ2V0KGl0ZW0ucGFyZW50SWQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuV29ya2Zsb3dFcnJvcihcIkNhbm5vdCByZXN0b3JlIHN0YXRlIHRyZWUsIGJlY2F1c2UgZGF0YSBpcyBjb3JydXB0LiBJbm5lciBlcnJvcjogXCIgKyBlLnN0YWNrKTtcbiAgICB9XG59O1xuLyogU0VSSUFMSVpBVElPTiAqL1xuXG4vKiBQUk9YWSAqL1xuU2NvcGVUcmVlLnByb3RvdHlwZS5oYXNQcm9wZXJ0eSA9IGZ1bmN0aW9uIChjdXJyZW50Tm9kZSwgbmFtZSkge1xuICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgIGN1cnJlbnROb2RlLmZvckVhY2hUb1Jvb3QoZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgICAgaWYgKG5vZGUuaXNQcm9wZXJ0eUV4aXN0cyhuYW1lKSkge1xuICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGZvdW5kO1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5nZXRWYWx1ZSA9IGZ1bmN0aW9uIChjdXJyZW50Tm9kZSwgbmFtZSkge1xuICAgIGxldCBjYW5SZXR1cm5Qcml2YXRlID0gdHJ1ZTtcbiAgICBsZXQgdmFsdWU7XG4gICAgY3VycmVudE5vZGUuZm9yRWFjaFRvUm9vdChmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICBpZiAoaXMuZGVmaW5lZCh2YWx1ZSA9IG5vZGUuZ2V0UHJvcGVydHlWYWx1ZShuYW1lLCBjYW5SZXR1cm5Qcml2YXRlKSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjYW5SZXR1cm5Qcml2YXRlID0gZmFsc2U7XG4gICAgfSk7XG4gICAgcmV0dXJuIHZhbHVlO1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5zZXRWYWx1ZSA9IGZ1bmN0aW9uIChjdXJyZW50Tm9kZSwgbmFtZSwgdmFsdWUpIHtcbiAgICBpZiAodGhpcy5pc09uSW5pdGlhbCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3Qgc2V0IHByb3BlcnR5IG9mIHRoZSBpbml0aWFsIHNjb3BlLlwiKTtcbiAgICB9XG5cbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGNhblNldFByaXZhdGUgPSB0cnVlO1xuICAgIGxldCBzZXREb25lID0gZmFsc2U7XG4gICAgY3VycmVudE5vZGUuZm9yRWFjaFRvUm9vdChmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICBpZiAobm9kZSA9PT0gc2VsZi5faW5pdGlhbE5vZGUpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobm9kZS5zZXRQcm9wZXJ0eVZhbHVlKG5hbWUsIHZhbHVlLCBjYW5TZXRQcml2YXRlKSkge1xuICAgICAgICAgICAgc2V0RG9uZSA9IHRydWU7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY2FuU2V0UHJpdmF0ZSA9IGZhbHNlO1xuICAgIH0pO1xuXG4gICAgaWYgKCFzZXREb25lKSB7XG4gICAgICAgIGN1cnJlbnROb2RlLmNyZWF0ZVByb3BlcnR5V2l0aFZhbHVlKG5hbWUsIHZhbHVlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbn07XG5cblNjb3BlVHJlZS5wcm90b3R5cGUuZGVsZXRlUHJvcGVydHkgPSBmdW5jdGlvbiAoY3VycmVudE5vZGUsIG5hbWUpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGNhbkRlbGV0ZVByaXZhdGUgPSB0cnVlO1xuICAgIGxldCBkZWxldGVEb25lID0gZmFsc2U7XG4gICAgY3VycmVudE5vZGUuZm9yRWFjaFRvUm9vdChmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICBpZiAobm9kZSA9PT0gc2VsZi5faW5pdGlhbE5vZGUpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobm9kZS5kZWxldGVQcm9wZXJ0eShuYW1lLCBjYW5EZWxldGVQcml2YXRlKSkge1xuICAgICAgICAgICAgZGVsZXRlRG9uZSA9IHRydWU7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY2FuRGVsZXRlUHJpdmF0ZSA9IGZhbHNlO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGRlbGV0ZURvbmU7XG59O1xuXG5TY29wZVRyZWUucHJvdG90eXBlLmVudW1lcmF0ZVByb3BlcnR5TmFtZXMgPSBmdW5jdGlvbiogKGN1cnJlbnROb2RlKSB7XG4gICAgbGV0IGNhbkVudW1lcmF0ZVByaXZhdGUgPSB0cnVlO1xuICAgIGxldCBub2RlID0gY3VycmVudE5vZGU7XG4gICAgZG9cbiAgICB7XG4gICAgICAgIHlpZWxkKiBub2RlLmVudW1lcmF0ZVByb3BlcnR5TmFtZXMoY2FuRW51bWVyYXRlUHJpdmF0ZSk7XG4gICAgICAgIGNhbkVudW1lcmF0ZVByaXZhdGUgPSBmYWxzZTtcbiAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50O1xuICAgIH1cbiAgICB3aGlsZSAobm9kZSk7XG59O1xuLyogUFJPWFkgKi9cblxuLyogV0FMSyAqL1xuU2NvcGVUcmVlLnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gKG5vZGVJZCwgY2hpbGRJZCwgc2NvcGVQYXJ0KSB7XG4gICAgbGV0IGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChub2RlSWQpO1xuICAgIGxldCBuZXh0Tm9kZSA9IG5ldyBTY29wZU5vZGUoY2hpbGRJZCwgc2NvcGVQYXJ0KTtcbiAgICBjdXJyZW50Tm9kZS5hZGRDaGlsZChuZXh0Tm9kZSk7XG4gICAgdGhpcy5fbm9kZXMuYWRkKGNoaWxkSWQsIG5leHROb2RlKTtcbiAgICByZXR1cm4gc2NvcGUuY3JlYXRlKHRoaXMsIG5leHROb2RlKTtcbn07XG5cblNjb3BlVHJlZS5wcm90b3R5cGUuYmFjayA9IGZ1bmN0aW9uIChub2RlSWQsIGtlZXBJdGVtKSB7XG4gICAgbGV0IGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChub2RlSWQpO1xuICAgIGlmIChjdXJyZW50Tm9kZSA9PT0gdGhpcy5faW5pdGlhbE5vZGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGdvIGJhY2sgYmVjYXVzZSBjdXJyZW50IHNjb3BlIGlzIHRoZSBpbml0aWFsIHNjb3BlLlwiKTtcbiAgICB9XG4gICAgbGV0IHRvUmVtb3ZlID0gY3VycmVudE5vZGU7XG4gICAgbGV0IGdvVG8gPSB0b1JlbW92ZS5wYXJlbnQ7XG4gICAgY3VycmVudE5vZGUgPSBnb1RvO1xuICAgIGlmICgha2VlcEl0ZW0pIHtcbiAgICAgICAgZ29Uby5yZW1vdmVDaGlsZCh0b1JlbW92ZSk7XG4gICAgICAgIHRoaXMuX25vZGVzLnJlbW92ZSh0b1JlbW92ZS5pZCk7XG4gICAgfVxuICAgIHJldHVybiBzY29wZS5jcmVhdGUodGhpcywgY3VycmVudE5vZGUpO1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5maW5kID0gZnVuY3Rpb24gKG5vZGVJZCkge1xuICAgIGxldCBjdXJyZW50Tm9kZSA9IHRoaXMuX2dldE5vZGVCeUV4dGVybmFsSWQobm9kZUlkKTtcbiAgICByZXR1cm4gc2NvcGUuY3JlYXRlKHRoaXMsIGN1cnJlbnROb2RlKTtcbn07XG4vKiBXQUxLICovXG5cblNjb3BlVHJlZS5wcm90b3R5cGUuX2dldE5vZGVCeUV4dGVybmFsSWQgPSBmdW5jdGlvbiAoaWQpIHtcbiAgICBpZiAoaWQgPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2luaXRpYWxOb2RlO1xuICAgIH1cbiAgICBsZXQgbm9kZSA9IHRoaXMuX25vZGVzLmdldChpZCk7XG4gICAgaWYgKCFub2RlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlNjb3BlIG5vZGUgZm9yIGFjdGl2aXR5IGlkICdcIiArIGlkICsgXCInIGlzIG5vdCBmb3VuZC5cIik7XG4gICAgfVxuICAgIHJldHVybiBub2RlO1xufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5kZWxldGVTY29wZVBhcnQgPSBmdW5jdGlvbiAoY3VycmVudE5vZGVJZCwgaWQpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChjdXJyZW50Tm9kZUlkKTtcbiAgICBsZXQgZGVsTm9kZSA9IHNlbGYuX25vZGVzLmdldChpZCk7XG4gICAgaWYgKGRlbE5vZGUpIHtcbiAgICAgICAgaWYgKGRlbE5vZGUgPT09IHNlbGYuX2luaXRpYWxOb2RlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgZGVsZXRlIHRoZSBpbml0aWFsIHNjb3BlLlwiKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICAgICAgZGVsTm9kZS5mb3JFYWNoVG9Sb290KFxuICAgICAgICAgICAgZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gY3VycmVudE5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBkZWxldGUgc2NvcGUsIGJlY2F1c2UgY3VycmVudCBhY3RpdmUgc2NvcGUgaXMgaW5zaWRlIGluIGl0LlwiKTtcbiAgICAgICAgfVxuICAgICAgICBkZWxOb2RlLnBhcmVudC5yZW1vdmVDaGlsZChkZWxOb2RlKTtcbiAgICAgICAgc2VsZi5fcmVtb3ZlQWxsTm9kZXMoZGVsTm9kZSk7XG4gICAgfVxufTtcblxuU2NvcGVUcmVlLnByb3RvdHlwZS5fcmVtb3ZlQWxsTm9kZXMgPSBmdW5jdGlvbiAobm9kZSkge1xuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIHNlbGYuX25vZGVzLnJlbW92ZShub2RlLmlkKTtcbiAgICBub2RlLmZvckVhY2hDaGlsZChmdW5jdGlvbiAoYykge1xuICAgICAgICBzZWxmLl9yZW1vdmVBbGxOb2RlcyhjKTtcbiAgICB9KTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gU2NvcGVUcmVlOyJdfQ==
