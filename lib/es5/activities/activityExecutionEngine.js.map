{"version":3,"sources":["activities/activityExecutionEngine.js"],"names":[],"mappings":"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","file":"activities/activityExecutionEngine.js","sourcesContent":["\"use strict\";\n\nlet Activity = require(\"./activity\");\nlet ActivityExecutionContext = require(\"./activityExecutionContext\");\nlet ActivityExecutionState = require(\"./activityExecutionState\");\nlet CallContext = require(\"./callContext\");\nlet EventEmitter = require('events').EventEmitter;\nlet util = require(\"util\");\nlet errors = require(\"../common/errors\");\nlet _ = require(\"lodash\");\nlet ActivityStateTracker = require(\"./activityStateTracker\");\nlet enums = require(\"../common/enums\");\nlet Bluebird = require(\"bluebird\");\nlet asyncHelpers = require(\"../common/asyncHelpers\");\nlet async = asyncHelpers.async;\nlet activityMarkup = require(\"./activityMarkup\");\n\nfunction ActivityExecutionEngine(contextOrActivity, instance) {\n    EventEmitter.call(this);\n    \n    if (contextOrActivity instanceof Activity) {\n        this.rootActivity = contextOrActivity;\n        this.context = new ActivityExecutionContext(this);\n        this._isInitialized = false;\n    }\n    else if (contextOrActivity instanceof ActivityExecutionContext) {\n        this.rootActivity = contextOrActivity.rootActivity;\n        this.context = contextOrActivity;\n        this.context.engine = this;\n        this._isInitialized = true;\n    }\n    else if (_.isPlainObject(contextOrActivity)) {\n        this.rootActivity = activityMarkup.parse(contextOrActivity);\n        this.context = new ActivityExecutionContext(this);\n        this._isInitialized = false;\n    }\n    else {\n        throw new TypeError(\"Argument 'contextOrActivity' is not an activity, context or a markup.\");\n    }\n    \n    this._rootState = null;\n    this._trackers = [];\n    this._hookContext();\n    this.updatedOn = null;\n    this.instance = instance || null;\n}\n\nutil.inherits(ActivityExecutionEngine, EventEmitter);\n\nObject.defineProperties(ActivityExecutionEngine.prototype, {\n    execState: {\n        get: function () {\n            if (this._rootState) {\n                return this._rootState.execState;\n            }\n            else {\n                return null;\n            }\n        }\n    },\n    version: {\n        get: function () {\n            return this.rootActivity.version;\n        }\n    }\n});\n\nActivityExecutionEngine.prototype._idle = {\n    toString: function () {\n        return enums.activityStates.idle;\n    }\n};\n\nActivityExecutionEngine.prototype.isIdle = function (result) {\n    return result === this._idle;\n};\n\nActivityExecutionEngine.prototype._initialize = function () {\n    if (!this._isInitialized) {\n        this.context.initialize(this.rootActivity);\n        this._isInitialized = true;\n    }\n};\n\nActivityExecutionEngine.prototype._setRootState = function (state) {\n    let self = this;\n    if (!self._rootState) {\n        self._rootState = state;\n        self._rootState.on(\n            Activity.states.cancel, function (args) {\n                self.emit(Activity.states.cancel, args);\n            });\n        self._rootState.on(\n            Activity.states.complete, function (args) {\n                self.emit(Activity.states.complete, args);\n            });\n        self._rootState.on(\n            Activity.states.end, function (args) {\n                self.updatedOn = new Date();\n                self.emit(Activity.states.end, args);\n            });\n        self._rootState.on(\n            Activity.states.fail, function (args) {\n                self.emit(Activity.states.fail, args);\n            });\n        self._rootState.on(\n            Activity.states.run, function (args) {\n                self.emit(Activity.states.run, args);\n            });\n        self._rootState.on(\n            Activity.states.idle, function (args) {\n                self.emit(Activity.states.idle, args);\n            });\n    }\n};\n\nActivityExecutionEngine.prototype._hookContext = function () {\n    let self = this;\n    self.context.on(\n        Activity.states.run,\n        function (args) {\n            for (let t of self._trackers) {\n                t.activityStateChanged(args);\n            }\n        });\n    self.context.on(\n        Activity.states.end,\n        function (args) {\n            for (let t of self._trackers) {\n                t.activityStateChanged(args);\n            }\n        });\n    self.context.on(\n        enums.events.workflowEvent,\n        function(args) {\n            self.emit(enums.events.workflowEvent, args);\n        }\n    );\n};\n\nActivityExecutionEngine.prototype.addTracker = function (tracker) {\n    if (!_.isObject(tracker)) {\n        throw new TypeError(\"Parameter is not an object.\");\n    }\n    this._trackers.push(new ActivityStateTracker(tracker));\n};\n\nActivityExecutionEngine.prototype.removeTracker = function (tracker) {\n    let idx = -1;\n    for (let i = 0; i < this._trackers.length; i++) {\n        let t = this._trackers[i];\n        if (t._impl === tracker) {\n            idx = i;\n            break;\n        }\n    }\n    if (idx !== -1) {\n        this._trackers.splice(idx, 1);\n    }\n};\n\nActivityExecutionEngine.prototype.start = async(function* () {\n    this._verifyNotStarted();\n\n    this._initialize();\n\n    let args = [new CallContext(this.context)];\n    for (let a of arguments) {\n        args.push(a);\n    }\n\n    this._setRootState(yield this.rootActivity.start.apply(this.rootActivity, args));\n});\n\nActivityExecutionEngine.prototype.invoke = function () {\n    let self = this;\n\n    self._verifyNotStarted();\n\n    self._initialize();\n\n    let args = [];\n    for (let a of arguments) {\n        args.push(a);\n    }\n\n    args.unshift(new CallContext(self.context));\n\n    return new Bluebird(function (resolve, reject) {\n        try {\n            self._setRootState(self.context.getExecutionState(self.rootActivity));\n            self.once(\n                Activity.states.end, function (eArgs) {\n                    let reason = eArgs.reason;\n                    let result = eArgs.result;\n                    switch (reason) {\n                        case Activity.states.complete:\n                            resolve(result);\n                            break;\n                        case Activity.states.cancel:\n                            reject(new errors.Cancelled());\n                            break;\n                        case Activity.states.idle:\n                            resolve(self._idle);\n                            break;\n                        default :\n                            result = result || new errors.ActivityRuntimeError(\"Unknown error.\");\n                            reject(result);\n                            break;\n                    }\n                });\n\n            self.rootActivity.start.apply(self.rootActivity, args);\n        }\n        catch (e) {\n            reject(e);\n        }\n    });\n};\n\nActivityExecutionEngine.prototype._verifyNotStarted = function () {\n    if (!(!this.execState || this.execState === enums.activityStates.complete)) {\n        throw new errors.ActivityStateExceptionError(\"Workflow has been already started.\");\n    }\n};\n\nActivityExecutionEngine.prototype.resumeBookmark = function (name, reason, result) {\n    let self = this;\n    self._initialize();\n    return new Bluebird(function (resolve, reject) {\n        try {\n            self._setRootState(self.context.getExecutionState(self.rootActivity));\n\n            if (self.execState === enums.activityStates.idle) {\n                let bmTimestamp = self.context.getBookmarkTimestamp(name);\n                self.once(\n                    Activity.states.end,\n                    function (args) {\n                        let _reason = args.reason;\n                        let _result = args.result;\n                        try {\n                            if (_reason === enums.activityStates.complete || _reason === enums.activityStates.idle) {\n                                let endBmTimestamp = self.context.getBookmarkTimestamp(name);\n                                if (endBmTimestamp && endBmTimestamp === bmTimestamp) {\n                                    if (_reason === enums.activityStates.complete) {\n                                        reject(new errors.ActivityRuntimeError(\"Workflow has been completed before bookmark '\" + name + \"' reached.\"));\n                                    }\n                                    else {\n                                        reject(new errors.Idle(\"Workflow has been gone to idle before bookmark '\" + name + \"' reached.\"));\n                                    }\n                                }\n                                else {\n                                    resolve();\n                                }\n                            }\n                            else if (_reason === enums.activityStates.cancel) {\n                                reject(new errors.ActivityRuntimeError(\"Workflow has been cancelled before bookmark '\" + name + \"' reached.\"));\n                            }\n                            else if (_reason === enums.activityStates.fail) {\n                                reject(_result);\n                            }\n                        }\n                        catch (e) {\n                            reject(e);\n                        }\n                    });\n                self.context.resumeBookmarkExternal(name, reason, result);\n            }\n            else {\n                reject(new errors.ActivityRuntimeError(\"Cannot resume bookmark, while the workflow is not in the idle state.\"));\n            }\n        }\n        catch (e) {\n            reject(e);\n        }\n    });\n};\n\n/* SERIALIZATION */\nActivityExecutionEngine.prototype.getStateAndPromotions = function (serializer, enablePromotions) {\n    if (serializer && !_.isObject(serializer)) {\n        throw new Error(\"Argument 'serializer' is not an object.\");\n    }\n\n    this._initialize();\n    return this.context.getStateAndPromotions(serializer, enablePromotions);\n};\n\nActivityExecutionEngine.prototype.setState = function (serializer, json) {\n    if (serializer && !_.isObject(serializer)) {\n        throw new Error(\"Argument 'serializer' is not an object.\");\n    }\n    if (!_.isObject(json)) {\n        throw new TypeError(\"Argument 'json' is not an object.\");\n    }\n\n    this._initialize();\n    this.updatedOn = new Date();\n    this.context.setState(serializer, json);\n};\n/* SERIALIZATION */\n\nmodule.exports = ActivityExecutionEngine;"],"sourceRoot":"/source/"}