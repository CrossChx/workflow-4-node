{"version":3,"sources":["activities/declarator.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;AAEb,IAAI,QAAQ,GAAG,OAAO,CAAC,YAAY,CAAC,CAAC;AACrC,IAAI,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAC3B,IAAI,EAAE,GAAG,OAAO,CAAC,cAAc,CAAC,CAAC;AACjC,IAAI,CAAC,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;;AAE1B,SAAS,UAAU,GAAG;AAClB,YAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AACpB,QAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;AACnD,QAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;AACzC,QAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;AACnD,QAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;AACzC,QAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,cAAc,CAAC;;;AAAC,AAG7C,QAAI,CAAC,kBAAkB,GAAG,IAAI,GAAG,EAAE;;;AAAC,AAGpC,QAAI,CAAC,kBAAkB,GAAG,IAAI,GAAG,EAAE,CAAC;CACvC;;AAED,IAAI,CAAC,QAAQ,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC;;AAEpC,UAAU,CAAC,SAAS,CAAC,QAAQ,GAAG,UAAU,IAAI,EAAE,KAAK,EAAE;AACnD,QAAI,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE;AACnC,cAAM,IAAI,KAAK,CAAC,YAAY,GAAG,IAAI,GAAG,6CAA6C,CAAC,CAAC;KACxF;AACD,QAAI,CAAC,CAAC,CAAC,WAAW,CAAC,KAAK,CAAC,EAAE;AACvB,YAAI,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC;KACtB;AACD,QAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;CACrC,CAAC;;AAEF,UAAU,CAAC,SAAS,CAAC,QAAQ,GAAG,UAAU,IAAI,EAAE,KAAK,EAAE;AACnD,QAAI,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE;AACnC,cAAM,IAAI,KAAK,CAAC,YAAY,GAAG,IAAI,GAAG,6CAA6C,CAAC,CAAC;KACxF;AACD,QAAI,CAAC,CAAC,CAAC,WAAW,CAAC,KAAK,CAAC,EAAE;AACvB,YAAI,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC;KACtB;AACD,QAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;CACrC,CAAC;;AAEF,UAAU,CAAC,SAAS,CAAC,GAAG,GAAG,UAAU,WAAW,EAAE,IAAI,EAAE;AACpD,QAAI,iBAAiB,GAAG,EAAE,CAAC;AAC3B,QAAI,2BAA2B,GAAG,EAAE,CAAC;AACrC,QAAI,CAAC,2BAA2B,GAAG,2BAA2B,CAAC;AAC/D,QAAI,QAAQ,GAAG,WAAW,CAAC,QAAQ,CAAC,kBAAkB,CAAC;;;;;;AACvD,6BAAsB,WAAW,CAAC,QAAQ,CAAC,aAAa,EAAE,8HAAE;gBAAnD,SAAS;;AACd,gBAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE;AAC1B,oBAAI,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC;AACjC,oBAAI,UAAU,YAAY,QAAQ,EAAE;AAChC,qCAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;AACnC,+CAA2B,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;iBAC/C;aACJ;SACJ;;;;;;;;;;;;;;;;AAED,QAAI,iBAAiB,CAAC,MAAM,EAAE;AAC1B,YAAI,CAAC,UAAU,GAAG,IAAI,CAAC;AACvB,mBAAW,CAAC,QAAQ,CAAC,iBAAiB,EAAE,UAAU,CAAC,CAAC;KACvD,MACI;AACD,YAAI,CAAC,MAAM,CAAC,6BAA6B,CAAC,CAAC;AAC3C,mBAAW,CAAC,QAAQ,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE,WAAW,EAAE,IAAI,CAAC,CAAC;KACnE;CACJ,CAAC;;AAEF,UAAU,CAAC,SAAS,CAAC,QAAQ,GAAG,UAAU,WAAW,EAAE,MAAM,EAAE,MAAM,EAAE;AACnE,QAAI,MAAM,KAAK,QAAQ,CAAC,MAAM,CAAC,QAAQ,EAAE;AACrC,YAAI,GAAG,GAAG,CAAC,CAAC;;;;;;AACZ,kCAAsB,IAAI,CAAC,2BAA2B,mIAAE;oBAA/C,SAAS;;AACd,oBAAI,CAAC,SAAS,CAAC,GAAG,MAAM,CAAC,GAAG,EAAE,CAAC,CAAC;aACnC;;;;;;;;;;;;;;;;AACD,YAAI,IAAI,GAAG,IAAI,CAAC,UAAU,CAAC;AAC3B,YAAI,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;AAC1B,YAAI,CAAC,MAAM,CAAC,6BAA6B,CAAC,CAAC;AAC3C,mBAAW,CAAC,QAAQ,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE,WAAW,EAAE,IAAI,CAAC,CAAC;KACnE,MACI;AACD,mBAAW,CAAC,GAAG,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;KACnC;CACJ,CAAC;;AAEF,MAAM,CAAC,OAAO,GAAG,UAAU,CAAC","file":"activities/declarator.js","sourcesContent":["\"use strict\";\n\nlet Activity = require(\"./activity\");\nlet util = require(\"util\");\nlet is = require(\"../common/is\");\nlet _ = require(\"lodash\");\n\nfunction Declarator() {\n    Activity.call(this);\n    this.nonScopedProperties.add(\"reservedProperties\");\n    this.nonScopedProperties.add(\"reserved\");\n    this.nonScopedProperties.add(\"promotedProperties\");\n    this.nonScopedProperties.add(\"promoted\");\n    this.nonScopedProperties.add(\"varsDeclared\");\n\n    // Properties those cannot be declared freely\n    this.reservedProperties = new Set();\n\n    // Properties those will be promoted during serialization\n    this.promotedProperties = new Set();\n}\n\nutil.inherits(Declarator, Activity);\n\nDeclarator.prototype.reserved = function (name, value) {\n    if (this.promotedProperties.has(name)) {\n        throw new Error(\"Property '\" + name + \"' cannot be reserved because it's promoted.\");\n    }\n    if (!_.isUndefined(value)) {\n        this[name] = value;\n    }\n    this.reservedProperties.add(name);\n};\n\nDeclarator.prototype.promoted = function (name, value) {\n    if (this.reservedProperties.has(name)) {\n        throw new Error(\"Property '\" + name + \"' cannot be promoted because it's reserved.\");\n    }\n    if (!_.isUndefined(value)) {\n        this[name] = value;\n    }\n    this.promotedProperties.add(name);\n};\n\nDeclarator.prototype.run = function (callContext, args) {\n    let activityVariables = [];\n    let _activityVariableFieldNames = [];\n    this._activityVariableFieldNames = _activityVariableFieldNames;\n    let resProps = callContext.activity.reservedProperties;\n    for (let fieldName of callContext.activity._getScopeKeys()) {\n        if (!resProps.has(fieldName)) {\n            let fieldValue = this[fieldName];\n            if (fieldValue instanceof Activity) {\n                activityVariables.push(fieldValue);\n                _activityVariableFieldNames.push(fieldName);\n            }\n        }\n    }\n\n    if (activityVariables.length) {\n        this._savedArgs = args;\n        callContext.schedule(activityVariables, \"_varsGot\");\n    }\n    else {\n        this.delete(\"_activityVariableFieldNames\");\n        callContext.activity.varsDeclared.call(this, callContext, args);\n    }\n};\n\nDeclarator.prototype._varsGot = function (callContext, reason, result) {\n    if (reason === Activity.states.complete) {\n        let idx = 0;\n        for (let fieldName of this._activityVariableFieldNames) {\n            this[fieldName] = result[idx++];\n        }\n        let args = this._savedArgs;\n        this.delete(\"_savedArgs\");\n        this.delete(\"_activityVariableFieldNames\");\n        callContext.activity.varsDeclared.call(this, callContext, args);\n    }\n    else {\n        callContext.end(reason, result);\n    }\n};\n\nmodule.exports = Declarator;"],"sourceRoot":"/source/"}