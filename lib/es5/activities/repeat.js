"use strict";
var Activity = require("./activity");
var Composite = require("./composite");
var util = require("util");
var _ = require("lodash");
require("date-utils");
var timespan = require("timespan");
var TimeSpan = timespan.TimeSpan;
var debug = require("debug")("wf4node:Repeat");
function Repeat() {
  Composite.call(this);
  this.startOn = null;
  this.intervalType = null;
  this.intervalValue = null;
  this.nextPropName = "next";
}
Repeat.intervalTypes = {
  secondly: "secondly",
  minutely: "minutely",
  hourly: "hourly",
  daily: "daily",
  weekly: "weekly"
};
util.inherits(Repeat, Composite);
Repeat.prototype.createImplementation = function(execContext) {
  var args = this.args;
  this.args = null;
  return {"@block": {
      startOn: "= this.$parent.startOn || (new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()))",
      intervalType: ("= this.$parent.intervalType || '" + Repeat.intervalTypes.daily + "'"),
      intervalValue: "= this.$parent.intervalValue || 1",
      next: null,
      args: [{"@assign": {
          to: "next",
          value: "= this.startOn"
        }}, {"@while": {
          condition: true,
          args: [function() {
            debug("Delaying to: %s", this.next);
          }, {"@delayTo": {to: "= this.next"}}, function() {
            debug("Delayed to: %s. Running arguments.", new Date());
          }, {"@block": args}, {"@assign": {
              to: "next",
              value: function() {
                var self = this;
                var now = new Date();
                var next = this.next;
                debug("Calculating next's value from: %s. intervalType: %s, intervalValue: %d", next.getTime(), self.intervalType, self.intervalValue);
                var value = self.intervalValue;
                switch (self.intervalType) {
                  case "secondly":
                    next = next.add({milliseconds: value * 1000});
                    break;
                  case "minutely":
                    next = next.add({minutes: value});
                    break;
                  case "hourly":
                    next = next.add({hours: value});
                    break;
                  case "weekly":
                    next = next.add({weeks: value});
                    break;
                  default:
                    next = next.add({days: value});
                    break;
                }
                debug("New next is: %s", next.getTime());
                if (next.getTime() > now.getTime()) {
                  debug("That's a future value, returning.");
                  return next;
                } else {
                  debug("That's a past value, calculating future value by adding periods.");
                  var dSec = (now - next) / 1000.0;
                  debug("Total distance in seconds: %d", dSec);
                  var interval;
                  switch (self.intervalType) {
                    case "secondly":
                      interval = timespan.fromSeconds(self.intervalValue);
                      break;
                    case "minutely":
                      interval = timespan.fromMinutes(self.intervalValue);
                      break;
                    case "hourly":
                      interval = timespan.fromHours(self.intervalValue);
                      break;
                    case "weekly":
                      interval = timespan.fromDays(self.intervalValue * 7);
                      break;
                    default:
                      interval = timespan.fromDays(self.intervalValue);
                      break;
                  }
                  interval = interval.totalSeconds();
                  debug("Interval in seconds: %d", interval);
                  var mod = dSec % interval;
                  debug("Remainder is: %d", mod);
                  var toAdd = interval - mod;
                  debug("To add to now is: %d", toAdd);
                  var result = now.add({seconds: toAdd});
                  debug("Result is: %s", result.getTime());
                  return result;
                }
              }
            }}]
        }}]
    }};
};
module.exports = Repeat;
//# sourceMappingURL=data:application/json;base64,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QyxDQUFDO0FBQzFDLEFBQUksb0JBQUEsQ0FBQSxHQUFFLEVBQUksQ0FBQSxJQUFHLEVBQUksU0FBTyxDQUFDO0FBQ3pCLHNCQUFJLEFBQUMsQ0FBQyxrQkFBaUIsQ0FBRyxJQUFFLENBQUMsQ0FBQztBQUM5QixBQUFJLG9CQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsUUFBTyxFQUFJLElBQUUsQ0FBQztBQUMxQixzQkFBSSxBQUFDLENBQUMsc0JBQXFCLENBQUcsTUFBSSxDQUFDLENBQUM7QUFDcEMsQUFBSSxvQkFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLEdBQUUsSUFBSSxBQUFDLENBQUMsQ0FBRSxPQUFNLENBQUcsTUFBSSxDQUFFLENBQUMsQ0FBQztBQUN4QyxzQkFBSSxBQUFDLENBQUMsZUFBYyxDQUFHLENBQUEsTUFBSyxRQUFRLEFBQUMsRUFBQyxDQUFDLENBQUM7QUFDeEMsdUJBQU8sT0FBSyxDQUFDO2dCQUNqQjtBQUFBLGNBQ0o7QUFBQSxZQUNKLENBQ0osQ0FDSjtBQUFBLFFBQ0osQ0FDSixDQUNKO0FBQUEsSUFDSixDQUNKLENBQUM7QUFDTCxDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksT0FBSyxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9yZXBlYXQuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5sZXQgQWN0aXZpdHkgPSByZXF1aXJlKFwiLi9hY3Rpdml0eVwiKTtcclxubGV0IENvbXBvc2l0ZSA9IHJlcXVpcmUoXCIuL2NvbXBvc2l0ZVwiKTtcclxubGV0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcclxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG5yZXF1aXJlKFwiZGF0ZS11dGlsc1wiKTtcclxubGV0IHRpbWVzcGFuID0gcmVxdWlyZShcInRpbWVzcGFuXCIpO1xyXG5sZXQgVGltZVNwYW4gPSB0aW1lc3Bhbi5UaW1lU3BhbjtcclxubGV0IGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpKFwid2Y0bm9kZTpSZXBlYXRcIik7XHJcblxyXG5mdW5jdGlvbiBSZXBlYXQoKSB7XHJcbiAgICBDb21wb3NpdGUuY2FsbCh0aGlzKTtcclxuXHJcbiAgICB0aGlzLnN0YXJ0T24gPSBudWxsO1xyXG4gICAgdGhpcy5pbnRlcnZhbFR5cGUgPSBudWxsO1xyXG4gICAgdGhpcy5pbnRlcnZhbFZhbHVlID0gbnVsbDtcclxuICAgIHRoaXMubmV4dFByb3BOYW1lID0gXCJuZXh0XCI7XHJcbn1cclxuXHJcblJlcGVhdC5pbnRlcnZhbFR5cGVzID0ge1xyXG4gICAgc2Vjb25kbHk6IFwic2Vjb25kbHlcIixcclxuICAgIG1pbnV0ZWx5OiBcIm1pbnV0ZWx5XCIsXHJcbiAgICBob3VybHk6IFwiaG91cmx5XCIsXHJcbiAgICBkYWlseTogXCJkYWlseVwiLFxyXG4gICAgd2Vla2x5OiBcIndlZWtseVwiXHJcbn07XHJcblxyXG51dGlsLmluaGVyaXRzKFJlcGVhdCwgQ29tcG9zaXRlKTtcclxuXHJcblJlcGVhdC5wcm90b3R5cGUuY3JlYXRlSW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbiAoZXhlY0NvbnRleHQpIHtcclxuICAgIGxldCBhcmdzID0gdGhpcy5hcmdzO1xyXG4gICAgdGhpcy5hcmdzID0gbnVsbDtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgXCJAYmxvY2tcIjoge1xyXG4gICAgICAgICAgICBzdGFydE9uOiBcIj0gdGhpcy4kcGFyZW50LnN0YXJ0T24gfHwgKG5ldyBEYXRlKG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSwgbmV3IERhdGUoKS5nZXRNb250aCgpLCBuZXcgRGF0ZSgpLmdldERhdGUoKSkpXCIsXHJcbiAgICAgICAgICAgIGludGVydmFsVHlwZTogYD0gdGhpcy4kcGFyZW50LmludGVydmFsVHlwZSB8fCAnJHtSZXBlYXQuaW50ZXJ2YWxUeXBlcy5kYWlseX0nYCxcclxuICAgICAgICAgICAgaW50ZXJ2YWxWYWx1ZTogXCI9IHRoaXMuJHBhcmVudC5pbnRlcnZhbFZhbHVlIHx8IDFcIixcclxuICAgICAgICAgICAgbmV4dDogbnVsbCxcclxuICAgICAgICAgICAgYXJnczogW1xyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIFwiQGFzc2lnblwiOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvOiBcIm5leHRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFwiPSB0aGlzLnN0YXJ0T25cIlxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgXCJAd2hpbGVcIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb246IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhcIkRlbGF5aW5nIHRvOiAlc1wiLCB0aGlzLm5leHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBkZWxheVRvXCI6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IFwiPSB0aGlzLm5leHRcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoXCJEZWxheWVkIHRvOiAlcy4gUnVubmluZyBhcmd1bWVudHMuXCIsIG5ldyBEYXRlKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBibG9ja1wiOiBhcmdzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGFzc2lnblwiOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiBcIm5leHRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzZWxmID0gdGhpcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5leHQgPSB0aGlzLm5leHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhcIkNhbGN1bGF0aW5nIG5leHQncyB2YWx1ZSBmcm9tOiAlcy4gaW50ZXJ2YWxUeXBlOiAlcywgaW50ZXJ2YWxWYWx1ZTogJWRcIiwgbmV4dC5nZXRUaW1lKCksIHNlbGYuaW50ZXJ2YWxUeXBlLCBzZWxmLmludGVydmFsVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gc2VsZi5pbnRlcnZhbFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChzZWxmLmludGVydmFsVHlwZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJzZWNvbmRseVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ID0gbmV4dC5hZGQoeyBtaWxsaXNlY29uZHM6IHZhbHVlICogMTAwMCB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1pbnV0ZWx5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSBuZXh0LmFkZCh7IG1pbnV0ZXM6IHZhbHVlIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwiaG91cmx5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSBuZXh0LmFkZCh7IGhvdXJzOiB2YWx1ZSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIndlZWtseVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ID0gbmV4dC5hZGQoeyB3ZWVrczogdmFsdWUgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSBuZXh0LmFkZCh7IGRheXM6IHZhbHVlIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKFwiTmV3IG5leHQgaXM6ICVzXCIsIG5leHQuZ2V0VGltZSgpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0LmdldFRpbWUoKSA+IG5vdy5nZXRUaW1lKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhcIlRoYXQncyBhIGZ1dHVyZSB2YWx1ZSwgcmV0dXJuaW5nLlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGlzIGlzIGluIHRoZSBmdXR1cmUsIHRoZW4gd2UncmUgZG9uZTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKFwiVGhhdCdzIGEgcGFzdCB2YWx1ZSwgY2FsY3VsYXRpbmcgZnV0dXJlIHZhbHVlIGJ5IGFkZGluZyBwZXJpb2RzLlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZFNlYyA9IChub3cgLSBuZXh0KSAvIDEwMDAuMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhcIlRvdGFsIGRpc3RhbmNlIGluIHNlY29uZHM6ICVkXCIsIGRTZWMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnRlcnZhbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHNlbGYuaW50ZXJ2YWxUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJzZWNvbmRseVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwgPSB0aW1lc3Bhbi5mcm9tU2Vjb25kcyhzZWxmLmludGVydmFsVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtaW51dGVseVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwgPSB0aW1lc3Bhbi5mcm9tTWludXRlcyhzZWxmLmludGVydmFsVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJob3VybHlcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVydmFsID0gdGltZXNwYW4uZnJvbUhvdXJzKHNlbGYuaW50ZXJ2YWxWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIndlZWtseVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwgPSB0aW1lc3Bhbi5mcm9tRGF5cyhzZWxmLmludGVydmFsVmFsdWUgKiA3KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwgPSB0aW1lc3Bhbi5mcm9tRGF5cyhzZWxmLmludGVydmFsVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVydmFsID0gaW50ZXJ2YWwudG90YWxTZWNvbmRzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoXCJJbnRlcnZhbCBpbiBzZWNvbmRzOiAlZFwiLCBpbnRlcnZhbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1vZCA9IGRTZWMgJSBpbnRlcnZhbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhcIlJlbWFpbmRlciBpczogJWRcIiwgbW9kKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgdG9BZGQgPSBpbnRlcnZhbCAtIG1vZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhcIlRvIGFkZCB0byBub3cgaXM6ICVkXCIsIHRvQWRkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gbm93LmFkZCh7IHNlY29uZHM6IHRvQWRkIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKFwiUmVzdWx0IGlzOiAlc1wiLCByZXN1bHQuZ2V0VGltZSgpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBdXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gUmVwZWF0OyJdfQ==
