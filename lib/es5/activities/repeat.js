"use strict";
var Activity = require("./activity");
var Composite = require("./composite");
var util = require("util");
var _ = require("lodash");
require("date-utils");
var TimeSpan = require("timespan").TimeSpan;
function Repeat() {
  Composite.call(this);
  this.start = null;
  this.intervalType = null;
  this.intervalValue = null;
  this.nextPropName = "next";
}
Repeat.intervalTypes = {
  secondly: "secondly",
  minutely: "minutely",
  hourly: "hourly",
  daily: "daily",
  weekly: "weekly"
};
util.inherits(Repeat, Composite);
Repeat.prototype.createImplementation = function(execContext) {
  var tmpl = {"@block": {
      start: "= this.$parent.start || (new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDay()))",
      intervalType: ("= this.$parent.intervalType || '" + Repeat.intervalTypes.daily + "'"),
      intervalValue: "= this.$parent.intervalValue || 1",
      "`pArgs": "= this.$parent.args",
      "_next_": null,
      args: [{"@assign": {
          to: "_next_",
          value: "= this.start"
        }}, {while: {
          condition: true,
          args: [{"@delayTo": {to: "= this._next_"}}, {"@block": ["= this.pArgs"]}, {"@assign": {
              to: "_next_",
              value: function() {
                var self = this;
                var now = new Date();
                var next = this._next_;
                var value = self.intervalValue;
                switch (self.intervalType) {
                  case "secondly":
                    next = next.add({seconds: value});
                    break;
                  case "minutely":
                    next = next.add({minutes: value});
                    break;
                  case "hourly":
                    next = next.add({hours: value});
                    break;
                  case "weekly":
                    next = next.add({weeks: value});
                    break;
                  default:
                    next = next.add({days: value});
                    break;
                }
                if (next.getTime() > now.getTime()) {
                  return next;
                } else {
                  var dSec = (now - next) / 1000.0;
                  var interval;
                  switch (self.intervalType) {
                    case "secondly":
                      interval = TimeSpan.fromSeconds(self.intervalValue);
                      break;
                    case "minutely":
                      interval = TimeSpan.fromMinutes(self.intervalValue);
                      break;
                    case "hourly":
                      interval = TimeSpan.fromHours(self.intervalValue);
                      break;
                    case "weekly":
                      interval = TimeSpan.fromDays(self.intervalValue * 7);
                      break;
                    default:
                      interval = TimeSpan.fromDays(self.intervalValue);
                      break;
                  }
                  interval = interval.totalSeconds();
                  var mod = dSec % interval;
                  var toAdd = interval - mod;
                  return now.add({seconds: toAdd});
                }
              }
            }}]
        }}]
    }};
  if (this.nextPropName !== "next") {
    var str = JSON.stringify(tmpl);
    str = str.replace(/_next_/g, this.nextPropName);
    tmpl = JSON.parse(str);
  }
  return tmpl;
};
module.exports = Repeat;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlcGVhdC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBLEFBQUksRUFBQSxDQUFBLFFBQU8sRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFlBQVcsQ0FBQyxDQUFDO0FBQ3BDLEFBQUksRUFBQSxDQUFBLFNBQVEsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGFBQVksQ0FBQyxDQUFDO0FBQ3RDLEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLENBQUEsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0FBQ3pCLE1BQU0sQUFBQyxDQUFDLFlBQVcsQ0FBQyxDQUFDO0FBQ3JCLEFBQUksRUFBQSxDQUFBLFFBQU8sRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFVBQVMsQ0FBQyxTQUFTLENBQUM7QUFFM0MsT0FBUyxPQUFLLENBQUUsQUFBRCxDQUFHO0FBQ2QsVUFBUSxLQUFLLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztBQUVwQixLQUFHLE1BQU0sRUFBSSxLQUFHLENBQUM7QUFDakIsS0FBRyxhQUFhLEVBQUksS0FBRyxDQUFDO0FBQ3hCLEtBQUcsY0FBYyxFQUFJLEtBQUcsQ0FBQztBQUN6QixLQUFHLGFBQWEsRUFBSSxPQUFLLENBQUM7QUFDOUI7QUFBQSxBQUVBLEtBQUssY0FBYyxFQUFJO0FBQ25CLFNBQU8sQ0FBRyxXQUFTO0FBQ25CLFNBQU8sQ0FBRyxXQUFTO0FBQ25CLE9BQUssQ0FBRyxTQUFPO0FBQ2YsTUFBSSxDQUFHLFFBQU07QUFDYixPQUFLLENBQUcsU0FBTztBQUFBLEFBQ25CLENBQUM7QUFFRCxHQUFHLFNBQVMsQUFBQyxDQUFDLE1BQUssQ0FBRyxVQUFRLENBQUMsQ0FBQztBQUVoQyxLQUFLLFVBQVUscUJBQXFCLEVBQUksVUFBVSxXQUFVLENBQUc7QUFDM0QsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEVBQ1AsUUFBTyxDQUFHO0FBQ04sVUFBSSxDQUFHLDJHQUF5RztBQUNoSCxpQkFBVyxHQUFHLGtDQUFrQyxFQUFDLENBQUEsTUFBSyxjQUFjLE1BQU0sRUFBQyxJQUFFLENBQUE7QUFDN0Usa0JBQVksQ0FBRyxvQ0FBa0M7QUFDakQsYUFBTyxDQUFHLHNCQUFvQjtBQUM5QixhQUFPLENBQUcsS0FBRztBQUNiLFNBQUcsQ0FBRyxFQUNGLENBQ0ksU0FBUSxDQUFHO0FBQ1AsV0FBQyxDQUFHLFNBQU87QUFDWCxjQUFJLENBQUcsZUFBYTtBQUFBLFFBQ3hCLENBQ0osQ0FDQSxFQUNJLEtBQUksQ0FBRztBQUNILGtCQUFRLENBQUcsS0FBRztBQUNkLGFBQUcsQ0FBRyxFQUNGLENBQ0ksVUFBUyxDQUFHLEVBQ1IsRUFBQyxDQUFHLGdCQUFjLENBQ3RCLENBQ0osQ0FDQSxFQUNJLFFBQU8sQ0FBRyxFQUFDLGNBQWEsQ0FBQyxDQUM3QixDQUNBLEVBQ0ksU0FBUSxDQUFHO0FBQ1AsZUFBQyxDQUFHLFNBQU87QUFDWCxrQkFBSSxDQUFHLFVBQVUsQUFBRCxDQUFHO0FBQ2YsQUFBSSxrQkFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixBQUFJLGtCQUFBLENBQUEsR0FBRSxFQUFJLElBQUksS0FBRyxBQUFDLEVBQUMsQ0FBQztBQUNwQixBQUFJLGtCQUFBLENBQUEsSUFBRyxFQUFJLENBQUEsSUFBRyxPQUFPLENBQUM7QUFDdEIsQUFBSSxrQkFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsY0FBYyxDQUFDO0FBQzlCLHVCQUFRLElBQUcsYUFBYTtBQUNwQixxQkFBSyxXQUFTO0FBQ1YsdUJBQUcsRUFBSSxDQUFBLElBQUcsSUFBSSxBQUFDLENBQUMsQ0FBRSxPQUFNLENBQUcsTUFBSSxDQUFFLENBQUMsQ0FBQztBQUNuQyx5QkFBSztBQUFBLEFBQ1QscUJBQUssV0FBUztBQUNWLHVCQUFHLEVBQUksQ0FBQSxJQUFHLElBQUksQUFBQyxDQUFDLENBQUUsT0FBTSxDQUFHLE1BQUksQ0FBRSxDQUFDLENBQUM7QUFDbkMseUJBQUs7QUFBQSxBQUNULHFCQUFLLFNBQU87QUFDUix1QkFBRyxFQUFJLENBQUEsSUFBRyxJQUFJLEFBQUMsQ0FBQyxDQUFFLEtBQUksQ0FBRyxNQUFJLENBQUUsQ0FBQyxDQUFDO0FBQ2pDLHlCQUFLO0FBQUEsQUFDVCxxQkFBSyxTQUFPO0FBQ1IsdUJBQUcsRUFBSSxDQUFBLElBQUcsSUFBSSxBQUFDLENBQUMsQ0FBRSxLQUFJLENBQUcsTUFBSSxDQUFFLENBQUMsQ0FBQztBQUNqQyx5QkFBSztBQUFBLEFBQ1Q7QUFDSSx1QkFBRyxFQUFJLENBQUEsSUFBRyxJQUFJLEFBQUMsQ0FBQyxDQUFFLElBQUcsQ0FBRyxNQUFJLENBQUUsQ0FBQyxDQUFDO0FBQ2hDLHlCQUFLO0FBRkYsZ0JBR1g7QUFDQSxtQkFBSSxJQUFHLFFBQVEsQUFBQyxFQUFDLENBQUEsQ0FBSSxDQUFBLEdBQUUsUUFBUSxBQUFDLEVBQUMsQ0FBRztBQUVoQyx1QkFBTyxLQUFHLENBQUM7Z0JBQ2YsS0FDSztBQUNELEFBQUksb0JBQUEsQ0FBQSxJQUFHLEVBQUksQ0FBQSxDQUFDLEdBQUUsRUFBSSxLQUFHLENBQUMsRUFBSSxPQUFLLENBQUM7QUFDaEMsQUFBSSxvQkFBQSxDQUFBLFFBQU8sQ0FBQztBQUNaLHlCQUFRLElBQUcsYUFBYTtBQUNwQix1QkFBSyxXQUFTO0FBQ1YsNkJBQU8sRUFBSSxDQUFBLFFBQU8sWUFBWSxBQUFDLENBQUMsSUFBRyxjQUFjLENBQUMsQ0FBQztBQUNuRCwyQkFBSztBQUFBLEFBQ1QsdUJBQUssV0FBUztBQUNWLDZCQUFPLEVBQUksQ0FBQSxRQUFPLFlBQVksQUFBQyxDQUFDLElBQUcsY0FBYyxDQUFDLENBQUM7QUFDbkQsMkJBQUs7QUFBQSxBQUNULHVCQUFLLFNBQU87QUFDUiw2QkFBTyxFQUFJLENBQUEsUUFBTyxVQUFVLEFBQUMsQ0FBQyxJQUFHLGNBQWMsQ0FBQyxDQUFDO0FBQ2pELDJCQUFLO0FBQUEsQUFDVCx1QkFBSyxTQUFPO0FBQ1IsNkJBQU8sRUFBSSxDQUFBLFFBQU8sU0FBUyxBQUFDLENBQUMsSUFBRyxjQUFjLEVBQUksRUFBQSxDQUFDLENBQUM7QUFDcEQsMkJBQUs7QUFBQSxBQUNUO0FBQ0ksNkJBQU8sRUFBSSxDQUFBLFFBQU8sU0FBUyxBQUFDLENBQUMsSUFBRyxjQUFjLENBQUMsQ0FBQztBQUNoRCwyQkFBSztBQUZGLGtCQUdYO0FBQ0EseUJBQU8sRUFBSSxDQUFBLFFBQU8sYUFBYSxBQUFDLEVBQUMsQ0FBQztBQUNsQyxBQUFJLG9CQUFBLENBQUEsR0FBRSxFQUFJLENBQUEsSUFBRyxFQUFJLFNBQU8sQ0FBQztBQUN6QixBQUFJLG9CQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsUUFBTyxFQUFJLElBQUUsQ0FBQztBQUMxQix1QkFBTyxDQUFBLEdBQUUsSUFBSSxBQUFDLENBQUMsQ0FBRSxPQUFNLENBQUcsTUFBSSxDQUFFLENBQUMsQ0FBQztnQkFDdEM7QUFBQSxjQUNKO0FBQUEsWUFDSixDQUNKLENBQ0o7QUFBQSxRQUNKLENBQ0osQ0FDSjtBQUFBLElBQ0osQ0FDSixDQUFDO0FBRUQsS0FBSSxJQUFHLGFBQWEsSUFBTSxPQUFLLENBQUc7QUFDOUIsQUFBSSxNQUFBLENBQUEsR0FBRSxFQUFJLENBQUEsSUFBRyxVQUFVLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztBQUM5QixNQUFFLEVBQUksQ0FBQSxHQUFFLFFBQVEsQUFBQyxDQUFDLFNBQVEsQ0FBRyxDQUFBLElBQUcsYUFBYSxDQUFDLENBQUM7QUFDL0MsT0FBRyxFQUFJLENBQUEsSUFBRyxNQUFNLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0FBQztFQUMxQjtBQUFBLEFBRUEsT0FBTyxLQUFHLENBQUM7QUFDZixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksT0FBSyxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9yZXBlYXQuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5sZXQgQWN0aXZpdHkgPSByZXF1aXJlKFwiLi9hY3Rpdml0eVwiKTtcclxubGV0IENvbXBvc2l0ZSA9IHJlcXVpcmUoXCIuL2NvbXBvc2l0ZVwiKTtcclxubGV0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcclxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG5yZXF1aXJlKFwiZGF0ZS11dGlsc1wiKTtcclxubGV0IFRpbWVTcGFuID0gcmVxdWlyZShcInRpbWVzcGFuXCIpLlRpbWVTcGFuO1xyXG5cclxuZnVuY3Rpb24gUmVwZWF0KCkge1xyXG4gICAgQ29tcG9zaXRlLmNhbGwodGhpcyk7XHJcblxyXG4gICAgdGhpcy5zdGFydCA9IG51bGw7XHJcbiAgICB0aGlzLmludGVydmFsVHlwZSA9IG51bGw7XHJcbiAgICB0aGlzLmludGVydmFsVmFsdWUgPSBudWxsO1xyXG4gICAgdGhpcy5uZXh0UHJvcE5hbWUgPSBcIm5leHRcIjtcclxufVxyXG5cclxuUmVwZWF0LmludGVydmFsVHlwZXMgPSB7XHJcbiAgICBzZWNvbmRseTogXCJzZWNvbmRseVwiLFxyXG4gICAgbWludXRlbHk6IFwibWludXRlbHlcIixcclxuICAgIGhvdXJseTogXCJob3VybHlcIixcclxuICAgIGRhaWx5OiBcImRhaWx5XCIsXHJcbiAgICB3ZWVrbHk6IFwid2Vla2x5XCJcclxufTtcclxuXHJcbnV0aWwuaW5oZXJpdHMoUmVwZWF0LCBDb21wb3NpdGUpO1xyXG5cclxuUmVwZWF0LnByb3RvdHlwZS5jcmVhdGVJbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uIChleGVjQ29udGV4dCkge1xyXG4gICAgbGV0IHRtcGwgPSB7XHJcbiAgICAgICAgXCJAYmxvY2tcIjoge1xyXG4gICAgICAgICAgICBzdGFydDogXCI9IHRoaXMuJHBhcmVudC5zdGFydCB8fCAobmV3IERhdGUobmV3IERhdGUoKS5nZXRGdWxsWWVhcigpLCBuZXcgRGF0ZSgpLmdldE1vbnRoKCksIG5ldyBEYXRlKCkuZ2V0RGF5KCkpKVwiLFxyXG4gICAgICAgICAgICBpbnRlcnZhbFR5cGU6IGA9IHRoaXMuJHBhcmVudC5pbnRlcnZhbFR5cGUgfHwgJyR7UmVwZWF0LmludGVydmFsVHlwZXMuZGFpbHl9J2AsXHJcbiAgICAgICAgICAgIGludGVydmFsVmFsdWU6IFwiPSB0aGlzLiRwYXJlbnQuaW50ZXJ2YWxWYWx1ZSB8fCAxXCIsXHJcbiAgICAgICAgICAgIFwiYHBBcmdzXCI6IFwiPSB0aGlzLiRwYXJlbnQuYXJnc1wiLFxyXG4gICAgICAgICAgICBcIl9uZXh0X1wiOiBudWxsLFxyXG4gICAgICAgICAgICBhcmdzOiBbXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgXCJAYXNzaWduXCI6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG86IFwiX25leHRfXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBcIj0gdGhpcy5zdGFydFwiXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICB3aGlsZToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb246IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBkZWxheVRvXCI6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IFwiPSB0aGlzLl9uZXh0X1wiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBibG9ja1wiOiBbXCI9IHRoaXMucEFyZ3NcIl1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAYXNzaWduXCI6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IFwiX25leHRfXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbm93ID0gbmV3IERhdGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBuZXh0ID0gdGhpcy5fbmV4dF87XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBzZWxmLmludGVydmFsVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHNlbGYuaW50ZXJ2YWxUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcInNlY29uZGx5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSBuZXh0LmFkZCh7IHNlY29uZHM6IHZhbHVlIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwibWludXRlbHlcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IG5leHQuYWRkKHsgbWludXRlczogdmFsdWUgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJob3VybHlcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IG5leHQuYWRkKHsgaG91cnM6IHZhbHVlIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwid2Vla2x5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSBuZXh0LmFkZCh7IHdlZWtzOiB2YWx1ZSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IG5leHQuYWRkKHsgZGF5czogdmFsdWUgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQuZ2V0VGltZSgpID4gbm93LmdldFRpbWUoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgaXMgaW4gdGhlIGZ1dHVyZSwgdGhlbiB3ZSdyZSBkb25lOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRTZWMgPSAobm93IC0gbmV4dCkgLyAxMDAwLjA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGludGVydmFsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoc2VsZi5pbnRlcnZhbFR5cGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcInNlY29uZGx5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbCA9IFRpbWVTcGFuLmZyb21TZWNvbmRzKHNlbGYuaW50ZXJ2YWxWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1pbnV0ZWx5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbCA9IFRpbWVTcGFuLmZyb21NaW51dGVzKHNlbGYuaW50ZXJ2YWxWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcImhvdXJseVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwgPSBUaW1lU3Bhbi5mcm9tSG91cnMoc2VsZi5pbnRlcnZhbFZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwid2Vla2x5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbCA9IFRpbWVTcGFuLmZyb21EYXlzKHNlbGYuaW50ZXJ2YWxWYWx1ZSAqIDcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbCA9IFRpbWVTcGFuLmZyb21EYXlzKHNlbGYuaW50ZXJ2YWxWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwgPSBpbnRlcnZhbC50b3RhbFNlY29uZHMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbW9kID0gZFNlYyAlIGludGVydmFsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0b0FkZCA9IGludGVydmFsIC0gbW9kO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBub3cuYWRkKHsgc2Vjb25kczogdG9BZGQgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGlmICh0aGlzLm5leHRQcm9wTmFtZSAhPT0gXCJuZXh0XCIpIHtcclxuICAgICAgICBsZXQgc3RyID0gSlNPTi5zdHJpbmdpZnkodG1wbCk7XHJcbiAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoL19uZXh0Xy9nLCB0aGlzLm5leHRQcm9wTmFtZSk7XHJcbiAgICAgICAgdG1wbCA9IEpTT04ucGFyc2Uoc3RyKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdG1wbDtcclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gUmVwZWF0OyJdfQ==
