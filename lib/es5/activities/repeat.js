"use strict";
var Activity = require("./activity");
var Composite = require("./composite");
var util = require("util");
var _ = require("lodash");
require("date-utils");
function Repeat() {
  Composite.call(this);
  this.start = null;
  this.intervalType = null;
  this.intervalValue = null;
  this.nextPropName = "next";
}
Repeat.intervalTypes = {
  secondly: "secondly",
  minutely: "minutely",
  hourly: "hourly",
  daily: "daily",
  weekly: "weekly",
  monthly: "monthly",
  yearly: "yearly"
};
util.inherits(Repeat, Composite);
Repeat.prototype.createImplementation = function(execContext) {
  var tmpl = {"@block": {
      start: "= this.$parent.start || new Date()",
      intervalType: ("= this.$parent.intervalType || '" + Repeat.intervalTypes.daily + "'"),
      intervalValue: "= this.$parent.intervalValue || 1",
      "`pArgs": "= this.$parent.args",
      "_next_": null,
      args: [{"@assign": {
          to: "_next_",
          value: "= this.start"
        }}, {while: {
          condition: true,
          args: [{"@delayTo": {to: "= this._next_"}}, {"@block": ["= this.pArgs"]}, {"@assign": {
              to: "_next_",
              value: function() {
                var next = this._next_;
                var value = this.intervalValue;
                switch (this.intervalType) {
                  case "secondly":
                    return next.add({seconds: value});
                  case "minutely":
                    return next.add({minutes: value});
                  case "hourly":
                    return next.add({hours: value});
                  case "weekly":
                    return next.add({weeks: value});
                  case "monthly":
                    return next.add({months: value});
                  case "yearly":
                    return next.add({years: value});
                  default:
                    return next.add({days: value});
                }
              }
            }}]
        }}]
    }};
  if (this.nextPropName !== "next") {
    tmpl = JSON.stringify(tmpl);
    tmpl = tmpl.replace(/_next_/g, this.nextPropName);
    tmpl = JSON.parse(tmpl);
  }
  return tmpl;
};
module.exports = Repeat;
//# sourceMappingURL=data:application/json;base64,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LEFBQUMsQ0FBQyxDQUFFLEtBQUksQ0FBRyxNQUFJLENBQUUsQ0FBQyxDQUFDO0FBQUEsQUFDckMscUJBQUssVUFBUTtBQUNULHlCQUFPLENBQUEsSUFBRyxJQUFJLEFBQUMsQ0FBQyxDQUFFLE1BQUssQ0FBRyxNQUFJLENBQUUsQ0FBQyxDQUFDO0FBQUEsQUFDdEMscUJBQUssU0FBTztBQUNSLHlCQUFPLENBQUEsSUFBRyxJQUFJLEFBQUMsQ0FBQyxDQUFFLEtBQUksQ0FBSSxNQUFJLENBQUUsQ0FBQyxDQUFDO0FBQUEsQUFDdEM7QUFDSSx5QkFBTyxDQUFBLElBQUcsSUFBSSxBQUFDLENBQUMsQ0FBRSxJQUFHLENBQUcsTUFBSSxDQUFFLENBQUMsQ0FBQztBQUQ3QixnQkFFWDtjQUNKO0FBQUEsWUFDSixDQUNKLENBQ0o7QUFBQSxRQUNKLENBQ0osQ0FDSjtBQUFBLElBQ0osQ0FDSixDQUFDO0FBRUQsS0FBSSxJQUFHLGFBQWEsSUFBTSxPQUFLLENBQUc7QUFDOUIsT0FBRyxFQUFJLENBQUEsSUFBRyxVQUFVLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztBQUMzQixPQUFHLEVBQUksQ0FBQSxJQUFHLFFBQVEsQUFBQyxDQUFDLFNBQVEsQ0FBRyxDQUFBLElBQUcsYUFBYSxDQUFDLENBQUM7QUFDakQsT0FBRyxFQUFJLENBQUEsSUFBRyxNQUFNLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztFQUMzQjtBQUFBLEFBRUEsT0FBTyxLQUFHLENBQUM7QUFDZixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksT0FBSyxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9yZXBlYXQuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5sZXQgQWN0aXZpdHkgPSByZXF1aXJlKFwiLi9hY3Rpdml0eVwiKTtcclxubGV0IENvbXBvc2l0ZSA9IHJlcXVpcmUoXCIuL2NvbXBvc2l0ZVwiKTtcclxubGV0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcclxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG5yZXF1aXJlKFwiZGF0ZS11dGlsc1wiKTtcclxuXHJcbmZ1bmN0aW9uIFJlcGVhdCgpIHtcclxuICAgIENvbXBvc2l0ZS5jYWxsKHRoaXMpO1xyXG5cclxuICAgIHRoaXMuc3RhcnQgPSBudWxsO1xyXG4gICAgdGhpcy5pbnRlcnZhbFR5cGUgPSBudWxsO1xyXG4gICAgdGhpcy5pbnRlcnZhbFZhbHVlID0gbnVsbDtcclxuICAgIHRoaXMubmV4dFByb3BOYW1lID0gXCJuZXh0XCI7XHJcbn1cclxuXHJcblJlcGVhdC5pbnRlcnZhbFR5cGVzID0ge1xyXG4gICAgc2Vjb25kbHk6IFwic2Vjb25kbHlcIixcclxuICAgIG1pbnV0ZWx5OiBcIm1pbnV0ZWx5XCIsXHJcbiAgICBob3VybHk6IFwiaG91cmx5XCIsXHJcbiAgICBkYWlseTogXCJkYWlseVwiLFxyXG4gICAgd2Vla2x5OiBcIndlZWtseVwiLFxyXG4gICAgbW9udGhseTogXCJtb250aGx5XCIsXHJcbiAgICB5ZWFybHk6IFwieWVhcmx5XCJcclxufTtcclxuXHJcbnV0aWwuaW5oZXJpdHMoUmVwZWF0LCBDb21wb3NpdGUpO1xyXG5cclxuUmVwZWF0LnByb3RvdHlwZS5jcmVhdGVJbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uIChleGVjQ29udGV4dCkge1xyXG4gICAgbGV0IHRtcGwgPSB7XHJcbiAgICAgICAgXCJAYmxvY2tcIjoge1xyXG4gICAgICAgICAgICBzdGFydDogXCI9IHRoaXMuJHBhcmVudC5zdGFydCB8fCBuZXcgRGF0ZSgpXCIsXHJcbiAgICAgICAgICAgIGludGVydmFsVHlwZTogYD0gdGhpcy4kcGFyZW50LmludGVydmFsVHlwZSB8fCAnJHtSZXBlYXQuaW50ZXJ2YWxUeXBlcy5kYWlseX0nYCxcclxuICAgICAgICAgICAgaW50ZXJ2YWxWYWx1ZTogXCI9IHRoaXMuJHBhcmVudC5pbnRlcnZhbFZhbHVlIHx8IDFcIixcclxuICAgICAgICAgICAgXCJgcEFyZ3NcIjogXCI9IHRoaXMuJHBhcmVudC5hcmdzXCIsXHJcbiAgICAgICAgICAgIFwiX25leHRfXCI6IG51bGwsXHJcbiAgICAgICAgICAgIGFyZ3M6IFtcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBcIkBhc3NpZ25cIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bzogXCJfbmV4dF9cIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFwiPSB0aGlzLnN0YXJ0XCJcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHdoaWxlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbjogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGRlbGF5VG9cIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzogXCI9IHRoaXMuX25leHRfXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGJsb2NrXCI6IFtcIj0gdGhpcy5wQXJnc1wiXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBhc3NpZ25cIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzogXCJfbmV4dF9cIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBuZXh0ID0gdGhpcy5fbmV4dF87XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmludGVydmFsVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRoaXMuaW50ZXJ2YWxUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcInNlY29uZGx5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0LmFkZCh7IHNlY29uZHM6IHZhbHVlIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtaW51dGVseVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dC5hZGQoeyBtaW51dGVzOiB2YWx1ZSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwiaG91cmx5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0LmFkZCh7IGhvdXJzOiB2YWx1ZSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwid2Vla2x5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0LmFkZCh7IHdlZWtzOiB2YWx1ZSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwibW9udGhseVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dC5hZGQoeyBtb250aHM6IHZhbHVlIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJ5ZWFybHlcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5leHQuYWRkKHsgeWVhcnMgOiB2YWx1ZSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dC5hZGQoeyBkYXlzOiB2YWx1ZSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgaWYgKHRoaXMubmV4dFByb3BOYW1lICE9PSBcIm5leHRcIikge1xyXG4gICAgICAgIHRtcGwgPSBKU09OLnN0cmluZ2lmeSh0bXBsKTtcclxuICAgICAgICB0bXBsID0gdG1wbC5yZXBsYWNlKC9fbmV4dF8vZywgdGhpcy5uZXh0UHJvcE5hbWUpO1xyXG4gICAgICAgIHRtcGwgPSBKU09OLnBhcnNlKHRtcGwpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0bXBsO1xyXG59O1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBSZXBlYXQ7Il19
