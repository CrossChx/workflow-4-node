"use strict";
var ActivityExecutionState = require("./activityExecutionState");
var ResumeBookmarkQueue = require("./resumeBookmarkQueue");
var enums = require("../common/enums");
var errors = require("../common/errors");
var util = require("util");
var EventEmitter = require('events').EventEmitter;
var _ = require("lodash");
var guids = require("../common/guids");
var ScopeTree = require("./scopeTree");
var StrMap = require("backpack-node").collections.StrMap;
var StrSet = require("backpack-node").collections.StrSet;
var is = require("../common/is");
var fast = require("fast.js");
var CallContext = require("./callContext");
function ActivityExecutionContext() {
  this._activityStates = new StrMap();
  this._bookmarks = new StrMap();
  this._resumeBMQueue = new ResumeBookmarkQueue();
  this._rootActivity = null;
  this._knownActivities = new StrMap();
  this._nextActivityId = 0;
  this._scopeTree = this._createScopeTree();
}
util.inherits(ActivityExecutionContext, EventEmitter);
Object.defineProperties(ActivityExecutionContext.prototype, {
  scope: {get: function() {
      return this._scopeTree.currentScope;
    }},
  hasScope: {get: function() {
      return !this._scopeTree.isOnInitial;
    }}
});
ActivityExecutionContext.prototype._createScopeTree = function() {
  var self = this;
  return new ScopeTree({resultCollected: function(context, reason, result, bookmarkName) {
      context.activity.resultCollected.call(context.scope, context, reason, result, bookmarkName);
    }}, function(id) {
    return self._getKnownActivity(id);
  });
};
ActivityExecutionContext.prototype._registerKnownActivity = function(activity) {
  this._knownActivities.add(activity.id, activity);
  if (is.composite(activity))
    activity.ensureImplementationCreated();
};
ActivityExecutionContext.prototype.initialize = function(rootActivity) {
  if (this._rootActivity)
    throw new Error("Context is already initialized.");
  if (!is.activity(rootActivity))
    throw new TypeError("Argument 'rootActivity' value is not an activity.");
  this._rootActivity = rootActivity;
  this._initialize(null, rootActivity, {id: 0});
};
ActivityExecutionContext.prototype.appendToContext = function(args) {
  this._checkInit();
  var self = this;
  var currMax = self._nextActivityId;
  var c = {id: currMax};
  if (_.isArray(args)) {
    var state = self.getState(self._rootActivity.id);
    args.forEach(function(arg) {
      if (is.activity(arg)) {
        self._initialize(self._rootActivity, arg, c);
        state.childActivityIds.add(arg.id);
      }
    });
  } else {
    throw new TypeError("Argument 'args' value is not an array.");
  }
  return {
    fromId: currMax,
    toId: this._nextActivityId
  };
};
ActivityExecutionContext.prototype.removeFromContext = function(removeToken) {
  this._checkInit();
  if (removeToken && is.defined(removeToken.fromId) && is.defined(removeToken.toId)) {
    var state = this.getState(this._rootActivity.id);
    for (var id = removeToken.fromId; id <= removeToken.toId; id++) {
      var sid = id.toString();
      this._knownActivities.remove(sid);
      state.childActivityIds.remove(sid);
    }
  } else {
    throw new TypeError("Argument 'removeToken' value is not a valid remove token object.");
  }
  this._nextActivityId = removeToken.fromId;
};
ActivityExecutionContext.prototype._checkInit = function() {
  if (!this._rootActivity)
    throw new Error("Context is not initialized.");
};
ActivityExecutionContext.prototype._initialize = function(parent, activity, idCounter) {
  var self = this;
  if (activity.id === null) {
    activity.id = (idCounter.id++).toString();
  } else if (activity.id != (idCounter.id++).toString()) {
    throw new Error("Activity " + activity.id + " has been assigned to an other context in a different tree which is not allowed.");
  }
  self._nextActivityId = idCounter.id;
  var state = self.getState(activity.id);
  state.parentActivityId = parent ? parent.id : null;
  self._registerKnownActivity(activity);
  activity.forEachImmediateChild(function(child) {
    self._initialize(activity, child, idCounter);
    state.childActivityIds.add(child.id);
  });
};
ActivityExecutionContext.prototype.getState = function(id) {
  var self = this;
  var state = self._activityStates.get(id);
  if (is.undefined(state)) {
    state = new ActivityExecutionState(id);
    state.on(enums.ActivityStates.run, function() {
      var activity = self._knownActivities.get(id);
      if (!activity)
        activity = {id: id};
      self.emit(enums.ActivityStates.run, activity);
    });
    state.on(enums.ActivityStates.end, function(reason, result) {
      var activity = self._knownActivities.get(id);
      if (!activity)
        activity = {id: id};
      self.emit(enums.ActivityStates.end, activity, reason, result);
    });
    self._activityStates.add(id, state);
  }
  return state;
};
ActivityExecutionContext.prototype._getKnownActivity = function(activityId) {
  var activity = this._knownActivities.get(activityId);
  if (!activity)
    throw new errors.ActivityRuntimeError("Activity by id '" + activityId + "' not found.");
  return activity;
};
ActivityExecutionContext.prototype.createBookmark = function(activityId, name, endCallback) {
  this.registerBookmark({
    name: name,
    activityId: activityId,
    timestamp: new Date().getTime(),
    endCallback: endCallback
  });
  return name;
};
ActivityExecutionContext.prototype.registerBookmark = function(bookmark) {
  if (this._bookmarks.get(bookmark.name))
    throw new errors.ActivityRuntimeError("Bookmark '" + bookmark.name + "' already exists.");
  this._bookmarks.set(bookmark.name, bookmark);
};
ActivityExecutionContext.prototype.isBookmarkExists = function(name) {
  return this._bookmarks.containsKey(name);
};
ActivityExecutionContext.prototype.getBookmarkTimestamp = function(name, throwIfNotFound) {
  var bm = this._bookmarks.get(name);
  if (is.undefined(bm) && throwIfNotFound)
    throw new Error("Bookmark '" + name + "' not found.");
  return bm ? bm.timestamp : null;
};
ActivityExecutionContext.prototype.deleteBookmark = function(name) {
  this._bookmarks.remove(name);
};
ActivityExecutionContext.prototype.resumeBookmarkInScope = function(callContext, name, reason, result) {
  var bm = this._bookmarks.get(name);
  if (is.undefined(bm)) {
    throw new Error("Bookmark '" + name + "' doesn't exists. Cannot continue with reason: " + reason + ".");
  }
  this._doResumeBookmark(callContext, bm, reason, result, reason == enums.ActivityStates.idle);
};
ActivityExecutionContext.prototype.resumeBookmarkInternal = function(callContext, name, reason, result) {
  var bm = this._bookmarks.get(name);
  this._resumeBMQueue.enqueue(name, reason, result);
};
ActivityExecutionContext.prototype.resumeBookmarkExternal = function(name, reason, result) {
  var self = this;
  var bm = self._bookmarks.get(name);
  if (is.undefined(bm))
    throw new errors.ActivityRuntimeError("Internal resume bookmark request cannot be processed because bookmark '" + command.name + "' doesn't exists.");
  self._doResumeBookmark(new CallContext(this, bm.activityId), bm, reason, result);
};
ActivityExecutionContext.prototype.processResumeBookmarkQueue = function() {
  var self = this;
  var command = self._resumeBMQueue.dequeue();
  if (command) {
    var bm = self._bookmarks.get(command.name);
    if (is.undefined(bm))
      throw new errors.ActivityRuntimeError("Internal resume bookmark request cannot be processed because bookmark '" + command.name + "' doesn't exists.");
    self._doResumeBookmark(new CallContext(this, bm.activityId), bm, command.reason, command.result);
    return true;
  }
  return false;
};
ActivityExecutionContext.prototype._doResumeBookmark = function(callContext, bookmark, reason, result, noRemove) {
  var scope = callContext.scope;
  if (!noRemove)
    this._bookmarks.remove(bookmark.name);
  if (is.undefined(scope.get(bookmark.endCallback))) {
    throw new errors.ActivityRuntimeError("Bookmark's '" + bookmark.name + "' callback '" + bookmark.endCallback + "' is not defined on the current scope.");
  }
  scope.get(bookmark.endCallback).call(scope, callContext, reason, result, bookmark);
};
ActivityExecutionContext.prototype.cancelExecution = function(activityIds) {
  var self = this;
  var allIds = new StrSet();
  fast.forEach(activityIds, function(id) {
    self._cancelSubtree(allIds, id);
  });
  self._bookmarks.forEachValue(function(bm) {
    if (allIds.exists(bm.activityId)) {
      self._bookmarks.remove(bm.name);
    }
  });
};
ActivityExecutionContext.prototype._cancelSubtree = function(allIds, activityId) {
  var self = this;
  allIds.add(activityId);
  var state = self.getState(activityId);
  state.childActivityIds.forEach(function(id) {
    self._cancelSubtree(allIds, id);
  });
  state.reportState(enums.ActivityStates.cancel);
};
ActivityExecutionContext.prototype.deleteScopeOfActivity = function(callContext, activityId) {
  this._scopeTree.deleteScopePart(callContext.activityId, activityId);
};
ActivityExecutionContext.prototype.getStateAndPromotions = function(serializer, getPromotions) {
  if (serializer && !_.isFunction(serializer.toJSON))
    throw new Error("Argument 'serializer' is not a serializer.");
  var activityStates = new StrMap();
  this._activityStates.forEachValue(function(s) {
    activityStates.add(s.activityId, s.asJSON());
  });
  var scopeStateAndPromotions = this._scopeTree.getState(getPromotions);
  var serialized;
  if (serializer) {
    serialized = serializer.toJSON({
      activityStates: activityStates,
      bookmarks: this._bookmarks,
      scope: scopeStateAndPromotions.state
    });
  } else {
    serialized = {
      activityStates: activityStates._serializeToJSON(),
      bookmarks: this._bookmarks._serializeToJSON(),
      scope: scopeStateAndPromotions.state
    };
  }
  return {
    state: serialized,
    promotedProperties: scopeStateAndPromotions.promotedProperties
  };
};
ActivityExecutionContext.prototype.setState = function(serializer, json) {
  if (serializer && !_.isFunction(serializer.fromJSON))
    throw new Error("Argument 'serializer' is not a serializer.");
  if (!_.isObject(json))
    throw new TypeError("Argument 'json' is not an object.");
  if (serializer) {
    json = serializer.fromJSON(json);
    if (!(json.activityStates instanceof StrMap))
      throw new TypeError("ActivityStates property value of argument 'json' is not an StrMap instance.");
    if (!(json.bookmarks instanceof StrMap))
      throw new TypeError("Bookmarks property value of argument 'json' is not an StrMap instance.");
  } else {
    if (!json.activityStates)
      throw new TypeError("ActivityStates property value of argument 'json' is not an object.");
    if (!json.bookmarks)
      throw new TypeError("Bookmarks property value of argument 'json' is not an object.");
    var activityStates = new StrMap();
    activityStates._deserializeFromJSON(json.activityStates);
    var bookmarks = new StrMap();
    bookmarks._deserializeFromJSON(json.bookmarks);
    json = {
      activityStates: activityStates,
      bookmarks: bookmarks,
      scope: json.scope
    };
  }
  this._activityStates.forEachValue(function(s) {
    var stored = json.activityStates.get(s.activityId);
    if (_.isUndefined(stored))
      throw new Error("Activity " + a.activityId + " state not found.");
    s.fromJSON(stored);
  });
  this._bookmarks = json.bookmarks;
  this._scopeTree.setState(json.scope);
};
module.exports = ActivityExecutionContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLEFBQUksRUFBQSxDQUFBLHNCQUFxQixFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsMEJBQXlCLENBQUMsQ0FBQztBQUNoRSxBQUFJLEVBQUEsQ0FBQSxtQkFBa0IsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLHVCQUFzQixDQUFDLENBQUM7QUFDMUQsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsaUJBQWdCLENBQUMsQ0FBQztBQUN0QyxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxrQkFBaUIsQ0FBQyxDQUFDO0FBQ3hDLEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLFlBQVcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFFBQU8sQ0FBQyxhQUFhLENBQUM7QUFDakQsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsaUJBQWdCLENBQUMsQ0FBQztBQUN0QyxBQUFJLEVBQUEsQ0FBQSxTQUFRLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxhQUFZLENBQUMsQ0FBQztBQUN0QyxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxlQUFjLENBQUMsWUFBWSxPQUFPLENBQUM7QUFDeEQsQUFBSSxFQUFBLENBQUEsTUFBSyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsZUFBYyxDQUFDLFlBQVksT0FBTyxDQUFDO0FBQ3hELEFBQUksRUFBQSxDQUFBLEVBQUMsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGNBQWEsQ0FBQyxDQUFDO0FBQ2hDLEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFNBQVEsQ0FBQyxDQUFDO0FBQzdCLEFBQUksRUFBQSxDQUFBLFdBQVUsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGVBQWMsQ0FBQyxDQUFDO0FBRTFDLE9BQVMseUJBQXVCLENBQUUsQUFBRCxDQUFHO0FBQ2hDLEtBQUcsZ0JBQWdCLEVBQUksSUFBSSxPQUFLLEFBQUMsRUFBQyxDQUFDO0FBQ25DLEtBQUcsV0FBVyxFQUFJLElBQUksT0FBSyxBQUFDLEVBQUMsQ0FBQztBQUM5QixLQUFHLGVBQWUsRUFBSSxJQUFJLG9CQUFrQixBQUFDLEVBQUMsQ0FBQztBQUMvQyxLQUFHLGNBQWMsRUFBSSxLQUFHLENBQUM7QUFDekIsS0FBRyxpQkFBaUIsRUFBSSxJQUFJLE9BQUssQUFBQyxFQUFDLENBQUM7QUFDcEMsS0FBRyxnQkFBZ0IsRUFBSSxFQUFBLENBQUM7QUFDeEIsS0FBRyxXQUFXLEVBQUksQ0FBQSxJQUFHLGlCQUFpQixBQUFDLEVBQUMsQ0FBQztBQUM3QztBQUFBLEFBRUEsR0FBRyxTQUFTLEFBQUMsQ0FBQyx3QkFBdUIsQ0FBRyxhQUFXLENBQUMsQ0FBQztBQUVyRCxLQUFLLGlCQUFpQixBQUFDLENBQ25CLHdCQUF1QixVQUFVLENBQ2pDO0FBQ0ksTUFBSSxDQUFHLEVBQ0gsR0FBRSxDQUFHLFVBQVUsQUFBRCxDQUFHO0FBQ2IsV0FBTyxDQUFBLElBQUcsV0FBVyxhQUFhLENBQUM7SUFDdkMsQ0FDSjtBQUNBLFNBQU8sQ0FBRyxFQUNOLEdBQUUsQ0FBRyxVQUFVLEFBQUQsQ0FBRztBQUNiLFdBQU8sRUFBQyxJQUFHLFdBQVcsWUFBWSxDQUFDO0lBQ3ZDLENBQ0o7QUFBQSxBQUNKLENBQ0osQ0FBQTtBQUVBLHVCQUF1QixVQUFVLGlCQUFpQixFQUFJLFVBQVUsQUFBRCxDQUFHO0FBQzlELEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixPQUFPLElBQUksVUFBUSxBQUFDLENBQ2hCLENBQ0ksZUFBYyxDQUFHLFVBQVUsT0FBTSxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsWUFBVyxDQUFHO0FBQzlELFlBQU0sU0FBUyxnQkFBZ0IsS0FBSyxBQUFDLENBQUMsT0FBTSxNQUFNLENBQUcsUUFBTSxDQUFHLE9BQUssQ0FBRyxPQUFLLENBQUcsYUFBVyxDQUFDLENBQUM7SUFDL0YsQ0FDSixDQUNBLFVBQVUsRUFBQyxDQUFHO0FBQ1YsU0FBTyxDQUFBLElBQUcsa0JBQWtCLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQTtFQUNwQyxDQUFDLENBQUM7QUFDVixDQUFBO0FBRUEsdUJBQXVCLFVBQVUsdUJBQXVCLEVBQUksVUFBVSxRQUFPLENBQUc7QUFDNUUsS0FBRyxpQkFBaUIsSUFBSSxBQUFDLENBQUMsUUFBTyxHQUFHLENBQUcsU0FBTyxDQUFDLENBQUM7QUFDaEQsS0FBSSxFQUFDLFVBQVUsQUFBQyxDQUFDLFFBQU8sQ0FBQztBQUFHLFdBQU8sNEJBQTRCLEFBQUMsRUFBQyxDQUFDO0FBQUEsQUFDdEUsQ0FBQztBQUVELHVCQUF1QixVQUFVLFdBQVcsRUFBSSxVQUFVLFlBQVcsQ0FBRztBQUNwRSxLQUFJLElBQUcsY0FBYztBQUFHLFFBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyxpQ0FBZ0MsQ0FBQyxDQUFDO0FBQUEsQUFDMUUsS0FBSSxDQUFDLEVBQUMsU0FBUyxBQUFDLENBQUMsWUFBVyxDQUFDO0FBQUcsUUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLG1EQUFrRCxDQUFDLENBQUM7QUFBQSxBQUV4RyxLQUFHLGNBQWMsRUFBSSxhQUFXLENBQUM7QUFDakMsS0FBRyxZQUFZLEFBQUMsQ0FBQyxJQUFHLENBQUcsYUFBVyxDQUFHLEVBQUMsRUFBQyxDQUFHLEVBQUEsQ0FBQyxDQUFDLENBQUM7QUFDakQsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLGdCQUFnQixFQUFJLFVBQVUsSUFBRyxDQUFHO0FBQ2pFLEtBQUcsV0FBVyxBQUFDLEVBQUMsQ0FBQztBQUVqQixBQUFJLElBQUEsQ0FBQSxJQUFHLEVBQUksS0FBRyxDQUFDO0FBRWYsQUFBSSxJQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsSUFBRyxnQkFBZ0IsQ0FBQztBQUNsQyxBQUFJLElBQUEsQ0FBQSxDQUFBLEVBQUksRUFBQyxFQUFDLENBQUcsUUFBTSxDQUFDLENBQUM7QUFFckIsS0FBSSxDQUFBLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFHO0FBQ2pCLEFBQUksTUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsU0FBUyxBQUFDLENBQUMsSUFBRyxjQUFjLEdBQUcsQ0FBQyxDQUFDO0FBQ2hELE9BQUcsUUFBUSxBQUFDLENBQ1IsU0FBVSxHQUFFLENBQUc7QUFDWCxTQUFJLEVBQUMsU0FBUyxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUc7QUFDbEIsV0FBRyxZQUFZLEFBQUMsQ0FBQyxJQUFHLGNBQWMsQ0FBRyxJQUFFLENBQUcsRUFBQSxDQUFDLENBQUM7QUFDNUMsWUFBSSxpQkFBaUIsSUFBSSxBQUFDLENBQUMsR0FBRSxHQUFHLENBQUMsQ0FBQztNQUN0QztBQUFBLElBQ0osQ0FBQyxDQUFDO0VBQ1YsS0FDSztBQUNELFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyx3Q0FBdUMsQ0FBQyxDQUFDO0VBQ2pFO0FBQUEsQUFFQSxPQUFPO0FBQ0gsU0FBSyxDQUFHLFFBQU07QUFDZCxPQUFHLENBQUcsQ0FBQSxJQUFHLGdCQUFnQjtBQUFBLEVBQzdCLENBQUM7QUFDTCxDQUFBO0FBRUEsdUJBQXVCLFVBQVUsa0JBQWtCLEVBQUksVUFBVSxXQUFVLENBQUc7QUFDMUUsS0FBRyxXQUFXLEFBQUMsRUFBQyxDQUFDO0FBRWpCLEtBQUksV0FBVSxHQUFLLENBQUEsRUFBQyxRQUFRLEFBQUMsQ0FBQyxXQUFVLE9BQU8sQ0FBQyxDQUFBLEVBQUssQ0FBQSxFQUFDLFFBQVEsQUFBQyxDQUFDLFdBQVUsS0FBSyxDQUFDLENBQUc7QUFDL0UsQUFBSSxNQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsSUFBRyxTQUFTLEFBQUMsQ0FBQyxJQUFHLGNBQWMsR0FBRyxDQUFDLENBQUM7QUFFaEQsUUFBUyxHQUFBLENBQUEsRUFBQyxFQUFJLENBQUEsV0FBVSxPQUFPLENBQUcsQ0FBQSxFQUFDLEdBQUssQ0FBQSxXQUFVLEtBQUssQ0FBRyxDQUFBLEVBQUMsRUFBRSxDQUFHO0FBQzVELEFBQUksUUFBQSxDQUFBLEdBQUUsRUFBSSxDQUFBLEVBQUMsU0FBUyxBQUFDLEVBQUMsQ0FBQztBQUN2QixTQUFHLGlCQUFpQixPQUFPLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0FBQztBQUNqQyxVQUFJLGlCQUFpQixPQUFPLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0FBQztJQUN0QztBQUFBLEVBQ0osS0FDSztBQUNELFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxrRUFBaUUsQ0FBQyxDQUFDO0VBQzNGO0FBQUEsQUFFQSxLQUFHLGdCQUFnQixFQUFJLENBQUEsV0FBVSxPQUFPLENBQUM7QUFDN0MsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLFdBQVcsRUFBSSxVQUFVLEFBQUQsQ0FBRztBQUN4RCxLQUFJLENBQUMsSUFBRyxjQUFjO0FBQUcsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLDZCQUE0QixDQUFDLENBQUM7QUFBQSxBQUMzRSxDQUFBO0FBRUEsdUJBQXVCLFVBQVUsWUFBWSxFQUFJLFVBQVUsTUFBSyxDQUFHLENBQUEsUUFBTyxDQUFHLENBQUEsU0FBUSxDQUFHO0FBQ3BGLEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFFZixLQUFJLFFBQU8sR0FBRyxJQUFNLEtBQUcsQ0FBRztBQUN0QixXQUFPLEdBQUcsRUFBSSxDQUFBLENBQUMsU0FBUSxHQUFHLEVBQUUsQ0FBQyxTQUFTLEFBQUMsRUFBQyxDQUFDO0VBQzdDLEtBQ0ssS0FBSSxRQUFPLEdBQUcsR0FBSyxDQUFBLENBQUMsU0FBUSxHQUFHLEVBQUUsQ0FBQyxTQUFTLEFBQUMsRUFBQyxDQUFHO0FBQ2pELFFBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyxXQUFVLEVBQUksQ0FBQSxRQUFPLEdBQUcsQ0FBQSxDQUFJLG1GQUFpRixDQUFDLENBQUM7RUFDbkk7QUFBQSxBQUNBLEtBQUcsZ0JBQWdCLEVBQUksQ0FBQSxTQUFRLEdBQUcsQ0FBQztBQUNuQyxBQUFJLElBQUEsQ0FBQSxLQUFJLEVBQUksQ0FBQSxJQUFHLFNBQVMsQUFBQyxDQUFDLFFBQU8sR0FBRyxDQUFDLENBQUM7QUFDdEMsTUFBSSxpQkFBaUIsRUFBSSxDQUFBLE1BQUssRUFBSSxDQUFBLE1BQUssR0FBRyxFQUFJLEtBQUcsQ0FBQztBQUNsRCxLQUFHLHVCQUF1QixBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFFckMsU0FBTyxzQkFBc0IsQUFBQyxDQUMxQixTQUFVLEtBQUksQ0FBRztBQUNiLE9BQUcsWUFBWSxBQUFDLENBQUMsUUFBTyxDQUFHLE1BQUksQ0FBRyxVQUFRLENBQUMsQ0FBQztBQUM1QyxRQUFJLGlCQUFpQixJQUFJLEFBQUMsQ0FBQyxLQUFJLEdBQUcsQ0FBQyxDQUFDO0VBQ3hDLENBQUMsQ0FBQztBQUNWLENBQUE7QUFFQSx1QkFBdUIsVUFBVSxTQUFTLEVBQUksVUFBVSxFQUFDLENBQUc7QUFDeEQsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUVmLEFBQUksSUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsZ0JBQWdCLElBQUksQUFBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDO0FBQ3hDLEtBQUksRUFBQyxVQUFVLEFBQUMsQ0FBQyxLQUFJLENBQUMsQ0FBRztBQUNyQixRQUFJLEVBQUksSUFBSSx1QkFBcUIsQUFBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDO0FBQ3RDLFFBQUksR0FBRyxBQUFDLENBQ0osS0FBSSxlQUFlLElBQUksQ0FBRyxVQUFVLEFBQUQsQ0FBRztBQUNsQyxBQUFJLFFBQUEsQ0FBQSxRQUFPLEVBQUksQ0FBQSxJQUFHLGlCQUFpQixJQUFJLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztBQUM1QyxTQUFJLENBQUMsUUFBTztBQUFHLGVBQU8sRUFBSSxFQUFDLEVBQUMsQ0FBRyxHQUFDLENBQUMsQ0FBQztBQUFBLEFBQ2xDLFNBQUcsS0FBSyxBQUFDLENBQUMsS0FBSSxlQUFlLElBQUksQ0FBRyxTQUFPLENBQUMsQ0FBQztJQUNqRCxDQUFDLENBQUM7QUFDTixRQUFJLEdBQUcsQUFBQyxDQUNKLEtBQUksZUFBZSxJQUFJLENBQUcsVUFBVSxNQUFLLENBQUcsQ0FBQSxNQUFLLENBQUc7QUFDaEQsQUFBSSxRQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsSUFBRyxpQkFBaUIsSUFBSSxBQUFDLENBQUMsRUFBQyxDQUFDLENBQUM7QUFDNUMsU0FBSSxDQUFDLFFBQU87QUFBRyxlQUFPLEVBQUksRUFBQyxFQUFDLENBQUcsR0FBQyxDQUFDLENBQUM7QUFBQSxBQUNsQyxTQUFHLEtBQUssQUFBQyxDQUFDLEtBQUksZUFBZSxJQUFJLENBQUcsU0FBTyxDQUFHLE9BQUssQ0FBRyxPQUFLLENBQUMsQ0FBQztJQUNqRSxDQUFDLENBQUM7QUFDTixPQUFHLGdCQUFnQixJQUFJLEFBQUMsQ0FBQyxFQUFDLENBQUcsTUFBSSxDQUFDLENBQUM7RUFDdkM7QUFBQSxBQUNBLE9BQU8sTUFBSSxDQUFDO0FBQ2hCLENBQUE7QUFFQSx1QkFBdUIsVUFBVSxrQkFBa0IsRUFBSSxVQUFVLFVBQVMsQ0FBRztBQUN6RSxBQUFJLElBQUEsQ0FBQSxRQUFPLEVBQUksQ0FBQSxJQUFHLGlCQUFpQixJQUFJLEFBQUMsQ0FBQyxVQUFTLENBQUMsQ0FBQztBQUNwRCxLQUFJLENBQUMsUUFBTztBQUFHLFFBQU0sSUFBSSxDQUFBLE1BQUsscUJBQXFCLEFBQUMsQ0FBQyxrQkFBaUIsRUFBSSxXQUFTLENBQUEsQ0FBSSxlQUFhLENBQUMsQ0FBQztBQUFBLEFBQ3RHLE9BQU8sU0FBTyxDQUFDO0FBQ25CLENBQUE7QUFFQSx1QkFBdUIsVUFBVSxlQUFlLEVBQUksVUFBVSxVQUFTLENBQUcsQ0FBQSxJQUFHLENBQUcsQ0FBQSxXQUFVLENBQUc7QUFDekYsS0FBRyxpQkFBaUIsQUFBQyxDQUNqQjtBQUNJLE9BQUcsQ0FBRyxLQUFHO0FBQ1QsYUFBUyxDQUFHLFdBQVM7QUFDckIsWUFBUSxDQUFHLENBQUEsR0FBSSxLQUFHLEFBQUMsRUFBQyxRQUFRLEFBQUMsRUFBQztBQUM5QixjQUFVLENBQUcsWUFBVTtBQUFBLEVBQzNCLENBQUMsQ0FBQztBQUNOLE9BQU8sS0FBRyxDQUFDO0FBQ2YsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLGlCQUFpQixFQUFJLFVBQVUsUUFBTyxDQUFHO0FBQ3RFLEtBQUksSUFBRyxXQUFXLElBQUksQUFBQyxDQUFDLFFBQU8sS0FBSyxDQUFDO0FBQUcsUUFBTSxJQUFJLENBQUEsTUFBSyxxQkFBcUIsQUFBQyxDQUFDLFlBQVcsRUFBSSxDQUFBLFFBQU8sS0FBSyxDQUFBLENBQUksb0JBQWtCLENBQUMsQ0FBQztBQUFBLEFBQ2pJLEtBQUcsV0FBVyxJQUFJLEFBQUMsQ0FBQyxRQUFPLEtBQUssQ0FBRyxTQUFPLENBQUMsQ0FBQztBQUNoRCxDQUFBO0FBRUEsdUJBQXVCLFVBQVUsaUJBQWlCLEVBQUksVUFBVSxJQUFHLENBQUc7QUFDbEUsT0FBTyxDQUFBLElBQUcsV0FBVyxZQUFZLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztBQUM1QyxDQUFBO0FBRUEsdUJBQXVCLFVBQVUscUJBQXFCLEVBQUksVUFBVSxJQUFHLENBQUcsQ0FBQSxlQUFjLENBQUc7QUFDdkYsQUFBSSxJQUFBLENBQUEsRUFBQyxFQUFJLENBQUEsSUFBRyxXQUFXLElBQUksQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0FBQ2xDLEtBQUksRUFBQyxVQUFVLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQSxFQUFLLGdCQUFjO0FBQUcsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLFlBQVcsRUFBSSxLQUFHLENBQUEsQ0FBSSxlQUFhLENBQUMsQ0FBQztBQUFBLEFBQzlGLE9BQU8sQ0FBQSxFQUFDLEVBQUksQ0FBQSxFQUFDLFVBQVUsRUFBSSxLQUFHLENBQUM7QUFDbkMsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLGVBQWUsRUFBSSxVQUFVLElBQUcsQ0FBRztBQUNoRSxLQUFHLFdBQVcsT0FBTyxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFDaEMsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLHNCQUFzQixFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsSUFBRyxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQ3BHLEFBQUksSUFBQSxDQUFBLEVBQUMsRUFBSSxDQUFBLElBQUcsV0FBVyxJQUFJLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztBQUNsQyxLQUFJLEVBQUMsVUFBVSxBQUFDLENBQUMsRUFBQyxDQUFDLENBQUc7QUFDbEIsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLFlBQVcsRUFBSSxLQUFHLENBQUEsQ0FBSSxrREFBZ0QsQ0FBQSxDQUFJLE9BQUssQ0FBQSxDQUFJLElBQUUsQ0FBQyxDQUFDO0VBQzNHO0FBQUEsQUFDQSxLQUFHLGtCQUFrQixBQUFDLENBQUMsV0FBVSxDQUFHLEdBQUMsQ0FBRyxPQUFLLENBQUcsT0FBSyxDQUFHLENBQUEsTUFBSyxHQUFLLENBQUEsS0FBSSxlQUFlLEtBQUssQ0FBQyxDQUFDO0FBQ2hHLENBQUE7QUFFQSx1QkFBdUIsVUFBVSx1QkFBdUIsRUFBSSxVQUFVLFdBQVUsQ0FBRyxDQUFBLElBQUcsQ0FBRyxDQUFBLE1BQUssQ0FBRyxDQUFBLE1BQUssQ0FBRztBQUNyRyxBQUFJLElBQUEsQ0FBQSxFQUFDLEVBQUksQ0FBQSxJQUFHLFdBQVcsSUFBSSxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFDbEMsS0FBRyxlQUFlLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBRyxPQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7QUFDckQsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLHVCQUF1QixFQUFJLFVBQVUsSUFBRyxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQ3hGLEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixBQUFJLElBQUEsQ0FBQSxFQUFDLEVBQUksQ0FBQSxJQUFHLFdBQVcsSUFBSSxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFDbEMsS0FBSSxFQUFDLFVBQVUsQUFBQyxDQUFDLEVBQUMsQ0FBQztBQUFHLFFBQU0sSUFBSSxDQUFBLE1BQUsscUJBQXFCLEFBQUMsQ0FBQyx5RUFBd0UsRUFBSSxDQUFBLE9BQU0sS0FBSyxDQUFBLENBQUksb0JBQWtCLENBQUMsQ0FBQztBQUFBLEFBQzNLLEtBQUcsa0JBQWtCLEFBQUMsQ0FBQyxHQUFJLFlBQVUsQUFBQyxDQUFDLElBQUcsQ0FBRyxDQUFBLEVBQUMsV0FBVyxDQUFDLENBQUcsR0FBQyxDQUFHLE9BQUssQ0FBRyxPQUFLLENBQUMsQ0FBQztBQUNwRixDQUFBO0FBRUEsdUJBQXVCLFVBQVUsMkJBQTJCLEVBQUksVUFBVSxBQUFELENBQUc7QUFDeEUsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUNmLEFBQUksSUFBQSxDQUFBLE9BQU0sRUFBSSxDQUFBLElBQUcsZUFBZSxRQUFRLEFBQUMsRUFBQyxDQUFDO0FBQzNDLEtBQUksT0FBTSxDQUFHO0FBQ1QsQUFBSSxNQUFBLENBQUEsRUFBQyxFQUFJLENBQUEsSUFBRyxXQUFXLElBQUksQUFBQyxDQUFDLE9BQU0sS0FBSyxDQUFDLENBQUM7QUFDMUMsT0FBSSxFQUFDLFVBQVUsQUFBQyxDQUFDLEVBQUMsQ0FBQztBQUFHLFVBQU0sSUFBSSxDQUFBLE1BQUsscUJBQXFCLEFBQUMsQ0FBQyx5RUFBd0UsRUFBSSxDQUFBLE9BQU0sS0FBSyxDQUFBLENBQUksb0JBQWtCLENBQUMsQ0FBQztBQUFBLEFBQzNLLE9BQUcsa0JBQWtCLEFBQUMsQ0FBQyxHQUFJLFlBQVUsQUFBQyxDQUFDLElBQUcsQ0FBRyxDQUFBLEVBQUMsV0FBVyxDQUFDLENBQUcsR0FBQyxDQUFHLENBQUEsT0FBTSxPQUFPLENBQUcsQ0FBQSxPQUFNLE9BQU8sQ0FBQyxDQUFDO0FBQ2hHLFNBQU8sS0FBRyxDQUFDO0VBQ2Y7QUFBQSxBQUNBLE9BQU8sTUFBSSxDQUFDO0FBQ2hCLENBQUE7QUFFQSx1QkFBdUIsVUFBVSxrQkFBa0IsRUFBSSxVQUFVLFdBQVUsQ0FBRyxDQUFBLFFBQU8sQ0FBRyxDQUFBLE1BQUssQ0FBRyxDQUFBLE1BQUssQ0FBRyxDQUFBLFFBQU8sQ0FBRztBQUM5RyxBQUFJLElBQUEsQ0FBQSxLQUFJLEVBQUksQ0FBQSxXQUFVLE1BQU0sQ0FBQztBQUM3QixLQUFJLENBQUMsUUFBTztBQUFHLE9BQUcsV0FBVyxPQUFPLEFBQUMsQ0FBQyxRQUFPLEtBQUssQ0FBQyxDQUFDO0FBQUEsQUFDcEQsS0FBSSxFQUFDLFVBQVUsQUFBQyxDQUFDLEtBQUksSUFBSSxBQUFDLENBQUMsUUFBTyxZQUFZLENBQUMsQ0FBQyxDQUFHO0FBQy9DLFFBQU0sSUFBSSxDQUFBLE1BQUsscUJBQXFCLEFBQUMsQ0FBQyxjQUFhLEVBQUksQ0FBQSxRQUFPLEtBQUssQ0FBQSxDQUFJLGVBQWEsQ0FBQSxDQUFJLENBQUEsUUFBTyxZQUFZLENBQUEsQ0FBSSx5Q0FBdUMsQ0FBQyxDQUFDO0VBQzVKO0FBQUEsQUFDQSxNQUFJLElBQUksQUFBQyxDQUFDLFFBQU8sWUFBWSxDQUFDLEtBQUssQUFBQyxDQUFDLEtBQUksQ0FBRyxZQUFVLENBQUcsT0FBSyxDQUFHLE9BQUssQ0FBRyxTQUFPLENBQUMsQ0FBQztBQUN0RixDQUFBO0FBRUEsdUJBQXVCLFVBQVUsZ0JBQWdCLEVBQUksVUFBVSxXQUFVLENBQUc7QUFDeEUsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUNmLEFBQUksSUFBQSxDQUFBLE1BQUssRUFBSSxJQUFJLE9BQUssQUFBQyxFQUFDLENBQUM7QUFDekIsS0FBRyxRQUFRLEFBQUMsQ0FBQyxXQUFVLENBQ25CLFVBQVUsRUFBQyxDQUFHO0FBQ1YsT0FBRyxlQUFlLEFBQUMsQ0FBQyxNQUFLLENBQUcsR0FBQyxDQUFDLENBQUM7RUFDbkMsQ0FBQyxDQUFDO0FBQ04sS0FBRyxXQUFXLGFBQWEsQUFBQyxDQUFDLFNBQVUsRUFBQyxDQUFHO0FBQ3ZDLE9BQUksTUFBSyxPQUFPLEFBQUMsQ0FBQyxFQUFDLFdBQVcsQ0FBQyxDQUFHO0FBQzlCLFNBQUcsV0FBVyxPQUFPLEFBQUMsQ0FBQyxFQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25DO0FBQUEsRUFDSixDQUFDLENBQUM7QUFDTixDQUFBO0FBRUEsdUJBQXVCLFVBQVUsZUFBZSxFQUFJLFVBQVUsTUFBSyxDQUFHLENBQUEsVUFBUyxDQUFHO0FBQzlFLEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixPQUFLLElBQUksQUFBQyxDQUFDLFVBQVMsQ0FBQyxDQUFDO0FBQ3RCLEFBQUksSUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsU0FBUyxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDckMsTUFBSSxpQkFBaUIsUUFBUSxBQUFDLENBQzFCLFNBQVUsRUFBQyxDQUFHO0FBQ1YsT0FBRyxlQUFlLEFBQUMsQ0FBQyxNQUFLLENBQUcsR0FBQyxDQUFDLENBQUM7RUFDbkMsQ0FBQyxDQUFDO0FBQ04sTUFBSSxZQUFZLEFBQUMsQ0FBQyxLQUFJLGVBQWUsT0FBTyxDQUFDLENBQUM7QUFDbEQsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLHNCQUFzQixFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsVUFBUyxDQUFHO0FBQzFGLEtBQUcsV0FBVyxnQkFBZ0IsQUFBQyxDQUFDLFdBQVUsV0FBVyxDQUFHLFdBQVMsQ0FBQyxDQUFDO0FBQ3ZFLENBQUE7QUFHQSx1QkFBdUIsVUFBVSxzQkFBc0IsRUFBSSxVQUFVLFVBQVMsQ0FBRyxDQUFBLGFBQVksQ0FBRztBQUM1RixLQUFJLFVBQVMsR0FBSyxFQUFDLENBQUEsV0FBVyxBQUFDLENBQUMsVUFBUyxPQUFPLENBQUM7QUFBRyxRQUFNLElBQUksTUFBSSxBQUFDLENBQUMsNENBQTJDLENBQUMsQ0FBQztBQUFBLEFBRTdHLElBQUEsQ0FBQSxjQUFhLEVBQUksSUFBSSxPQUFLLEFBQUMsRUFBQyxDQUFDO0FBQ2pDLEtBQUcsZ0JBQWdCLGFBQWEsQUFBQyxDQUFDLFNBQVUsQ0FBQSxDQUFHO0FBQzNDLGlCQUFhLElBQUksQUFBQyxDQUFDLENBQUEsV0FBVyxDQUFHLENBQUEsQ0FBQSxPQUFPLEFBQUMsRUFBQyxDQUFDLENBQUM7RUFDaEQsQ0FBQyxDQUFDO0FBRUYsQUFBSSxJQUFBLENBQUEsdUJBQXNCLEVBQUksQ0FBQSxJQUFHLFdBQVcsU0FBUyxBQUFDLENBQUMsYUFBWSxDQUFDLENBQUM7QUFFckUsQUFBSSxJQUFBLENBQUEsVUFBUyxDQUFDO0FBQ2QsS0FBSSxVQUFTLENBQUc7QUFDWixhQUFTLEVBQUksQ0FBQSxVQUFTLE9BQU8sQUFBQyxDQUFDO0FBQzNCLG1CQUFhLENBQUcsZUFBYTtBQUM3QixjQUFRLENBQUcsQ0FBQSxJQUFHLFdBQVc7QUFDekIsVUFBSSxDQUFHLENBQUEsdUJBQXNCLE1BQU07QUFBQSxJQUN2QyxDQUFDLENBQUM7RUFDTixLQUNLO0FBQ0QsYUFBUyxFQUFJO0FBQ1QsbUJBQWEsQ0FBRyxDQUFBLGNBQWEsaUJBQWlCLEFBQUMsRUFBQztBQUNoRCxjQUFRLENBQUcsQ0FBQSxJQUFHLFdBQVcsaUJBQWlCLEFBQUMsRUFBQztBQUM1QyxVQUFJLENBQUcsQ0FBQSx1QkFBc0IsTUFBTTtBQUFBLElBQ3ZDLENBQUE7RUFDSjtBQUFBLEFBRUEsT0FBTztBQUNILFFBQUksQ0FBRyxXQUFTO0FBQ2hCLHFCQUFpQixDQUFHLENBQUEsdUJBQXNCLG1CQUFtQjtBQUFBLEVBQ2pFLENBQUM7QUFDTCxDQUFBO0FBRUEsdUJBQXVCLFVBQVUsU0FBUyxFQUFJLFVBQVUsVUFBUyxDQUFHLENBQUEsSUFBRyxDQUFHO0FBQ3RFLEtBQUksVUFBUyxHQUFLLEVBQUMsQ0FBQSxXQUFXLEFBQUMsQ0FBQyxVQUFTLFNBQVMsQ0FBQztBQUFHLFFBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyw0Q0FBMkMsQ0FBQyxDQUFDO0FBQUEsQUFDbkgsS0FBSSxDQUFDLENBQUEsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFDO0FBQUcsUUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLG1DQUFrQyxDQUFDLENBQUM7QUFBQSxBQUUvRSxLQUFJLFVBQVMsQ0FBRztBQUNaLE9BQUcsRUFBSSxDQUFBLFVBQVMsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFDaEMsT0FBSSxDQUFDLENBQUMsSUFBRyxlQUFlLFdBQWEsT0FBSyxDQUFDO0FBQUcsVUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLDZFQUE0RSxDQUFDLENBQUM7QUFBQSxBQUNoSixPQUFJLENBQUMsQ0FBQyxJQUFHLFVBQVUsV0FBYSxPQUFLLENBQUM7QUFBRyxVQUFNLElBQUksVUFBUSxBQUFDLENBQUMsd0VBQXVFLENBQUMsQ0FBQztBQUFBLEVBQzFJLEtBQ0s7QUFDRCxPQUFJLENBQUMsSUFBRyxlQUFlO0FBQUcsVUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLG9FQUFtRSxDQUFDLENBQUM7QUFBQSxBQUNuSCxPQUFJLENBQUMsSUFBRyxVQUFVO0FBQUcsVUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLCtEQUE4RCxDQUFDLENBQUM7QUFBQSxBQUVyRyxNQUFBLENBQUEsY0FBYSxFQUFJLElBQUksT0FBSyxBQUFDLEVBQUMsQ0FBQztBQUNqQyxpQkFBYSxxQkFBcUIsQUFBQyxDQUFDLElBQUcsZUFBZSxDQUFDLENBQUM7QUFDeEQsQUFBSSxNQUFBLENBQUEsU0FBUSxFQUFJLElBQUksT0FBSyxBQUFDLEVBQUMsQ0FBQztBQUM1QixZQUFRLHFCQUFxQixBQUFDLENBQUMsSUFBRyxVQUFVLENBQUMsQ0FBQztBQUM5QyxPQUFHLEVBQUk7QUFDSCxtQkFBYSxDQUFHLGVBQWE7QUFDN0IsY0FBUSxDQUFHLFVBQVE7QUFDbkIsVUFBSSxDQUFHLENBQUEsSUFBRyxNQUFNO0FBQUEsSUFDcEIsQ0FBQztFQUNMO0FBQUEsQUFFQSxLQUFHLGdCQUFnQixhQUFhLEFBQUMsQ0FBQyxTQUFVLENBQUEsQ0FBRztBQUMzQyxBQUFJLE1BQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxJQUFHLGVBQWUsSUFBSSxBQUFDLENBQUMsQ0FBQSxXQUFXLENBQUMsQ0FBQztBQUNsRCxPQUFJLENBQUEsWUFBWSxBQUFDLENBQUMsTUFBSyxDQUFDO0FBQUcsVUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLFdBQVUsRUFBSSxDQUFBLENBQUEsV0FBVyxDQUFBLENBQUksb0JBQWtCLENBQUMsQ0FBQztBQUFBLEFBQzVGLElBQUEsU0FBUyxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7RUFDdEIsQ0FBQyxDQUFDO0FBRUYsS0FBRyxXQUFXLEVBQUksQ0FBQSxJQUFHLFVBQVUsQ0FBQztBQUNoQyxLQUFHLFdBQVcsU0FBUyxBQUFDLENBQUMsSUFBRyxNQUFNLENBQUMsQ0FBQztBQUN4QyxDQUFBO0FBR0EsS0FBSyxRQUFRLEVBQUkseUJBQXVCLENBQUM7QUFBQSIsImZpbGUiOiJhY3Rpdml0aWVzL2FjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsidmFyIEFjdGl2aXR5RXhlY3V0aW9uU3RhdGUgPSByZXF1aXJlKFwiLi9hY3Rpdml0eUV4ZWN1dGlvblN0YXRlXCIpO1xyXG52YXIgUmVzdW1lQm9va21hcmtRdWV1ZSA9IHJlcXVpcmUoXCIuL3Jlc3VtZUJvb2ttYXJrUXVldWVcIik7XHJcbnZhciBlbnVtcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZW51bXNcIik7XHJcbnZhciBlcnJvcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2Vycm9yc1wiKTtcclxudmFyIHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcclxudmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjtcclxudmFyIF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG52YXIgZ3VpZHMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2d1aWRzXCIpO1xyXG52YXIgU2NvcGVUcmVlID0gcmVxdWlyZShcIi4vc2NvcGVUcmVlXCIpO1xyXG52YXIgU3RyTWFwID0gcmVxdWlyZShcImJhY2twYWNrLW5vZGVcIikuY29sbGVjdGlvbnMuU3RyTWFwO1xyXG52YXIgU3RyU2V0ID0gcmVxdWlyZShcImJhY2twYWNrLW5vZGVcIikuY29sbGVjdGlvbnMuU3RyU2V0O1xyXG52YXIgaXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2lzXCIpO1xyXG52YXIgZmFzdCA9IHJlcXVpcmUoXCJmYXN0LmpzXCIpO1xyXG52YXIgQ2FsbENvbnRleHQgPSByZXF1aXJlKFwiLi9jYWxsQ29udGV4dFwiKTtcclxuXHJcbmZ1bmN0aW9uIEFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dCgpIHtcclxuICAgIHRoaXMuX2FjdGl2aXR5U3RhdGVzID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgdGhpcy5fYm9va21hcmtzID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgdGhpcy5fcmVzdW1lQk1RdWV1ZSA9IG5ldyBSZXN1bWVCb29rbWFya1F1ZXVlKCk7XHJcbiAgICB0aGlzLl9yb290QWN0aXZpdHkgPSBudWxsO1xyXG4gICAgdGhpcy5fa25vd25BY3Rpdml0aWVzID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgdGhpcy5fbmV4dEFjdGl2aXR5SWQgPSAwO1xyXG4gICAgdGhpcy5fc2NvcGVUcmVlID0gdGhpcy5fY3JlYXRlU2NvcGVUcmVlKCk7XHJcbn1cclxuXHJcbnV0aWwuaW5oZXJpdHMoQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LCBFdmVudEVtaXR0ZXIpO1xyXG5cclxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoXHJcbiAgICBBY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLFxyXG4gICAge1xyXG4gICAgICAgIHNjb3BlOiB7XHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Njb3BlVHJlZS5jdXJyZW50U2NvcGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGhhc1Njb3BlOiB7XHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICF0aGlzLl9zY29wZVRyZWUuaXNPbkluaXRpYWw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbilcclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuX2NyZWF0ZVNjb3BlVHJlZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHJldHVybiBuZXcgU2NvcGVUcmVlKFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgcmVzdWx0Q29sbGVjdGVkOiBmdW5jdGlvbiAoY29udGV4dCwgcmVhc29uLCByZXN1bHQsIGJvb2ttYXJrTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgY29udGV4dC5hY3Rpdml0eS5yZXN1bHRDb2xsZWN0ZWQuY2FsbChjb250ZXh0LnNjb3BlLCBjb250ZXh0LCByZWFzb24sIHJlc3VsdCwgYm9va21hcmtOYW1lKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZnVuY3Rpb24gKGlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzZWxmLl9nZXRLbm93bkFjdGl2aXR5KGlkKVxyXG4gICAgICAgIH0pO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLl9yZWdpc3Rlcktub3duQWN0aXZpdHkgPSBmdW5jdGlvbiAoYWN0aXZpdHkpIHtcclxuICAgIHRoaXMuX2tub3duQWN0aXZpdGllcy5hZGQoYWN0aXZpdHkuaWQsIGFjdGl2aXR5KTtcclxuICAgIGlmIChpcy5jb21wb3NpdGUoYWN0aXZpdHkpKSBhY3Rpdml0eS5lbnN1cmVJbXBsZW1lbnRhdGlvbkNyZWF0ZWQoKTtcclxufTtcclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uIChyb290QWN0aXZpdHkpIHtcclxuICAgIGlmICh0aGlzLl9yb290QWN0aXZpdHkpIHRocm93IG5ldyBFcnJvcihcIkNvbnRleHQgaXMgYWxyZWFkeSBpbml0aWFsaXplZC5cIik7XHJcbiAgICBpZiAoIWlzLmFjdGl2aXR5KHJvb3RBY3Rpdml0eSkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAncm9vdEFjdGl2aXR5JyB2YWx1ZSBpcyBub3QgYW4gYWN0aXZpdHkuXCIpO1xyXG5cclxuICAgIHRoaXMuX3Jvb3RBY3Rpdml0eSA9IHJvb3RBY3Rpdml0eTtcclxuICAgIHRoaXMuX2luaXRpYWxpemUobnVsbCwgcm9vdEFjdGl2aXR5LCB7aWQ6IDB9KTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5hcHBlbmRUb0NvbnRleHQgPSBmdW5jdGlvbiAoYXJncykge1xyXG4gICAgdGhpcy5fY2hlY2tJbml0KCk7XHJcblxyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIHZhciBjdXJyTWF4ID0gc2VsZi5fbmV4dEFjdGl2aXR5SWQ7XHJcbiAgICB2YXIgYyA9IHtpZDogY3Vyck1heH07XHJcblxyXG4gICAgaWYgKF8uaXNBcnJheShhcmdzKSkge1xyXG4gICAgICAgIHZhciBzdGF0ZSA9IHNlbGYuZ2V0U3RhdGUoc2VsZi5fcm9vdEFjdGl2aXR5LmlkKTtcclxuICAgICAgICBhcmdzLmZvckVhY2goXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChhcmcpIHtcclxuICAgICAgICAgICAgICAgIGlmIChpcy5hY3Rpdml0eShhcmcpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5faW5pdGlhbGl6ZShzZWxmLl9yb290QWN0aXZpdHksIGFyZywgYyk7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hpbGRBY3Rpdml0eUlkcy5hZGQoYXJnLmlkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ2FyZ3MnIHZhbHVlIGlzIG5vdCBhbiBhcnJheS5cIik7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBmcm9tSWQ6IGN1cnJNYXgsXHJcbiAgICAgICAgdG9JZDogdGhpcy5fbmV4dEFjdGl2aXR5SWRcclxuICAgIH07XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUucmVtb3ZlRnJvbUNvbnRleHQgPSBmdW5jdGlvbiAocmVtb3ZlVG9rZW4pIHtcclxuICAgIHRoaXMuX2NoZWNrSW5pdCgpO1xyXG5cclxuICAgIGlmIChyZW1vdmVUb2tlbiAmJiBpcy5kZWZpbmVkKHJlbW92ZVRva2VuLmZyb21JZCkgJiYgaXMuZGVmaW5lZChyZW1vdmVUb2tlbi50b0lkKSkge1xyXG4gICAgICAgIHZhciBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGUodGhpcy5fcm9vdEFjdGl2aXR5LmlkKTtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgaWQgPSByZW1vdmVUb2tlbi5mcm9tSWQ7IGlkIDw9IHJlbW92ZVRva2VuLnRvSWQ7IGlkKyspIHtcclxuICAgICAgICAgICAgdmFyIHNpZCA9IGlkLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2tub3duQWN0aXZpdGllcy5yZW1vdmUoc2lkKTtcclxuICAgICAgICAgICAgc3RhdGUuY2hpbGRBY3Rpdml0eUlkcy5yZW1vdmUoc2lkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ3JlbW92ZVRva2VuJyB2YWx1ZSBpcyBub3QgYSB2YWxpZCByZW1vdmUgdG9rZW4gb2JqZWN0LlwiKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLl9uZXh0QWN0aXZpdHlJZCA9IHJlbW92ZVRva2VuLmZyb21JZDtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5fY2hlY2tJbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKCF0aGlzLl9yb290QWN0aXZpdHkpIHRocm93IG5ldyBFcnJvcihcIkNvbnRleHQgaXMgbm90IGluaXRpYWxpemVkLlwiKTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5faW5pdGlhbGl6ZSA9IGZ1bmN0aW9uIChwYXJlbnQsIGFjdGl2aXR5LCBpZENvdW50ZXIpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICBpZiAoYWN0aXZpdHkuaWQgPT09IG51bGwpIHtcclxuICAgICAgICBhY3Rpdml0eS5pZCA9IChpZENvdW50ZXIuaWQrKykudG9TdHJpbmcoKTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKGFjdGl2aXR5LmlkICE9IChpZENvdW50ZXIuaWQrKykudG9TdHJpbmcoKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFjdGl2aXR5IFwiICsgYWN0aXZpdHkuaWQgKyBcIiBoYXMgYmVlbiBhc3NpZ25lZCB0byBhbiBvdGhlciBjb250ZXh0IGluIGEgZGlmZmVyZW50IHRyZWUgd2hpY2ggaXMgbm90IGFsbG93ZWQuXCIpO1xyXG4gICAgfVxyXG4gICAgc2VsZi5fbmV4dEFjdGl2aXR5SWQgPSBpZENvdW50ZXIuaWQ7XHJcbiAgICB2YXIgc3RhdGUgPSBzZWxmLmdldFN0YXRlKGFjdGl2aXR5LmlkKTtcclxuICAgIHN0YXRlLnBhcmVudEFjdGl2aXR5SWQgPSBwYXJlbnQgPyBwYXJlbnQuaWQgOiBudWxsO1xyXG4gICAgc2VsZi5fcmVnaXN0ZXJLbm93bkFjdGl2aXR5KGFjdGl2aXR5KTtcclxuXHJcbiAgICBhY3Rpdml0eS5mb3JFYWNoSW1tZWRpYXRlQ2hpbGQoXHJcbiAgICAgICAgZnVuY3Rpb24gKGNoaWxkKSB7XHJcbiAgICAgICAgICAgIHNlbGYuX2luaXRpYWxpemUoYWN0aXZpdHksIGNoaWxkLCBpZENvdW50ZXIpO1xyXG4gICAgICAgICAgICBzdGF0ZS5jaGlsZEFjdGl2aXR5SWRzLmFkZChjaGlsZC5pZCk7XHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoaWQpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICB2YXIgc3RhdGUgPSBzZWxmLl9hY3Rpdml0eVN0YXRlcy5nZXQoaWQpO1xyXG4gICAgaWYgKGlzLnVuZGVmaW5lZChzdGF0ZSkpIHtcclxuICAgICAgICBzdGF0ZSA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvblN0YXRlKGlkKTtcclxuICAgICAgICBzdGF0ZS5vbihcclxuICAgICAgICAgICAgZW51bXMuQWN0aXZpdHlTdGF0ZXMucnVuLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYWN0aXZpdHkgPSBzZWxmLl9rbm93bkFjdGl2aXRpZXMuZ2V0KGlkKTtcclxuICAgICAgICAgICAgICAgIGlmICghYWN0aXZpdHkpIGFjdGl2aXR5ID0ge2lkOiBpZH07XHJcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoZW51bXMuQWN0aXZpdHlTdGF0ZXMucnVuLCBhY3Rpdml0eSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIHN0YXRlLm9uKFxyXG4gICAgICAgICAgICBlbnVtcy5BY3Rpdml0eVN0YXRlcy5lbmQsIGZ1bmN0aW9uIChyZWFzb24sIHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGFjdGl2aXR5ID0gc2VsZi5fa25vd25BY3Rpdml0aWVzLmdldChpZCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWFjdGl2aXR5KSBhY3Rpdml0eSA9IHtpZDogaWR9O1xyXG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KGVudW1zLkFjdGl2aXR5U3RhdGVzLmVuZCwgYWN0aXZpdHksIHJlYXNvbiwgcmVzdWx0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgc2VsZi5fYWN0aXZpdHlTdGF0ZXMuYWRkKGlkLCBzdGF0ZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3RhdGU7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuX2dldEtub3duQWN0aXZpdHkgPSBmdW5jdGlvbiAoYWN0aXZpdHlJZCkge1xyXG4gICAgdmFyIGFjdGl2aXR5ID0gdGhpcy5fa25vd25BY3Rpdml0aWVzLmdldChhY3Rpdml0eUlkKTtcclxuICAgIGlmICghYWN0aXZpdHkpIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJBY3Rpdml0eSBieSBpZCAnXCIgKyBhY3Rpdml0eUlkICsgXCInIG5vdCBmb3VuZC5cIik7XHJcbiAgICByZXR1cm4gYWN0aXZpdHk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuY3JlYXRlQm9va21hcmsgPSBmdW5jdGlvbiAoYWN0aXZpdHlJZCwgbmFtZSwgZW5kQ2FsbGJhY2spIHtcclxuICAgIHRoaXMucmVnaXN0ZXJCb29rbWFyayhcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXHJcbiAgICAgICAgICAgIGFjdGl2aXR5SWQ6IGFjdGl2aXR5SWQsXHJcbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCksXHJcbiAgICAgICAgICAgIGVuZENhbGxiYWNrOiBlbmRDYWxsYmFja1xyXG4gICAgICAgIH0pO1xyXG4gICAgcmV0dXJuIG5hbWU7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUucmVnaXN0ZXJCb29rbWFyayA9IGZ1bmN0aW9uIChib29rbWFyaykge1xyXG4gICAgaWYgKHRoaXMuX2Jvb2ttYXJrcy5nZXQoYm9va21hcmsubmFtZSkpIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJCb29rbWFyayAnXCIgKyBib29rbWFyay5uYW1lICsgXCInIGFscmVhZHkgZXhpc3RzLlwiKTtcclxuICAgIHRoaXMuX2Jvb2ttYXJrcy5zZXQoYm9va21hcmsubmFtZSwgYm9va21hcmspO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLmlzQm9va21hcmtFeGlzdHMgPSBmdW5jdGlvbiAobmFtZSkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2Jvb2ttYXJrcy5jb250YWluc0tleShuYW1lKTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5nZXRCb29rbWFya1RpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lLCB0aHJvd0lmTm90Rm91bmQpIHtcclxuICAgIHZhciBibSA9IHRoaXMuX2Jvb2ttYXJrcy5nZXQobmFtZSk7XHJcbiAgICBpZiAoaXMudW5kZWZpbmVkKGJtKSAmJiB0aHJvd0lmTm90Rm91bmQpIHRocm93IG5ldyBFcnJvcihcIkJvb2ttYXJrICdcIiArIG5hbWUgKyBcIicgbm90IGZvdW5kLlwiKTtcclxuICAgIHJldHVybiBibSA/IGJtLnRpbWVzdGFtcCA6IG51bGw7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuZGVsZXRlQm9va21hcmsgPSBmdW5jdGlvbiAobmFtZSkge1xyXG4gICAgdGhpcy5fYm9va21hcmtzLnJlbW92ZShuYW1lKTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5yZXN1bWVCb29rbWFya0luU2NvcGUgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIG5hbWUsIHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICB2YXIgYm0gPSB0aGlzLl9ib29rbWFya3MuZ2V0KG5hbWUpO1xyXG4gICAgaWYgKGlzLnVuZGVmaW5lZChibSkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCb29rbWFyayAnXCIgKyBuYW1lICsgXCInIGRvZXNuJ3QgZXhpc3RzLiBDYW5ub3QgY29udGludWUgd2l0aCByZWFzb246IFwiICsgcmVhc29uICsgXCIuXCIpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fZG9SZXN1bWVCb29rbWFyayhjYWxsQ29udGV4dCwgYm0sIHJlYXNvbiwgcmVzdWx0LCByZWFzb24gPT0gZW51bXMuQWN0aXZpdHlTdGF0ZXMuaWRsZSk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUucmVzdW1lQm9va21hcmtJbnRlcm5hbCA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgbmFtZSwgcmVhc29uLCByZXN1bHQpIHtcclxuICAgIHZhciBibSA9IHRoaXMuX2Jvb2ttYXJrcy5nZXQobmFtZSk7XHJcbiAgICB0aGlzLl9yZXN1bWVCTVF1ZXVlLmVucXVldWUobmFtZSwgcmVhc29uLCByZXN1bHQpO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLnJlc3VtZUJvb2ttYXJrRXh0ZXJuYWwgPSBmdW5jdGlvbiAobmFtZSwgcmVhc29uLCByZXN1bHQpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHZhciBibSA9IHNlbGYuX2Jvb2ttYXJrcy5nZXQobmFtZSk7XHJcbiAgICBpZiAoaXMudW5kZWZpbmVkKGJtKSkgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eVJ1bnRpbWVFcnJvcihcIkludGVybmFsIHJlc3VtZSBib29rbWFyayByZXF1ZXN0IGNhbm5vdCBiZSBwcm9jZXNzZWQgYmVjYXVzZSBib29rbWFyayAnXCIgKyBjb21tYW5kLm5hbWUgKyBcIicgZG9lc24ndCBleGlzdHMuXCIpO1xyXG4gICAgc2VsZi5fZG9SZXN1bWVCb29rbWFyayhuZXcgQ2FsbENvbnRleHQodGhpcywgYm0uYWN0aXZpdHlJZCksIGJtLCByZWFzb24sIHJlc3VsdCk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUucHJvY2Vzc1Jlc3VtZUJvb2ttYXJrUXVldWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICB2YXIgY29tbWFuZCA9IHNlbGYuX3Jlc3VtZUJNUXVldWUuZGVxdWV1ZSgpO1xyXG4gICAgaWYgKGNvbW1hbmQpIHtcclxuICAgICAgICB2YXIgYm0gPSBzZWxmLl9ib29rbWFya3MuZ2V0KGNvbW1hbmQubmFtZSk7XHJcbiAgICAgICAgaWYgKGlzLnVuZGVmaW5lZChibSkpIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJJbnRlcm5hbCByZXN1bWUgYm9va21hcmsgcmVxdWVzdCBjYW5ub3QgYmUgcHJvY2Vzc2VkIGJlY2F1c2UgYm9va21hcmsgJ1wiICsgY29tbWFuZC5uYW1lICsgXCInIGRvZXNuJ3QgZXhpc3RzLlwiKTtcclxuICAgICAgICBzZWxmLl9kb1Jlc3VtZUJvb2ttYXJrKG5ldyBDYWxsQ29udGV4dCh0aGlzLCBibS5hY3Rpdml0eUlkKSwgYm0sIGNvbW1hbmQucmVhc29uLCBjb21tYW5kLnJlc3VsdCk7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuX2RvUmVzdW1lQm9va21hcmsgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIGJvb2ttYXJrLCByZWFzb24sIHJlc3VsdCwgbm9SZW1vdmUpIHtcclxuICAgIHZhciBzY29wZSA9IGNhbGxDb250ZXh0LnNjb3BlO1xyXG4gICAgaWYgKCFub1JlbW92ZSkgdGhpcy5fYm9va21hcmtzLnJlbW92ZShib29rbWFyay5uYW1lKTtcclxuICAgIGlmIChpcy51bmRlZmluZWQoc2NvcGUuZ2V0KGJvb2ttYXJrLmVuZENhbGxiYWNrKSkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiQm9va21hcmsncyAnXCIgKyBib29rbWFyay5uYW1lICsgXCInIGNhbGxiYWNrICdcIiArIGJvb2ttYXJrLmVuZENhbGxiYWNrICsgXCInIGlzIG5vdCBkZWZpbmVkIG9uIHRoZSBjdXJyZW50IHNjb3BlLlwiKTtcclxuICAgIH1cclxuICAgIHNjb3BlLmdldChib29rbWFyay5lbmRDYWxsYmFjaykuY2FsbChzY29wZSwgY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0LCBib29rbWFyayk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuY2FuY2VsRXhlY3V0aW9uID0gZnVuY3Rpb24gKGFjdGl2aXR5SWRzKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICB2YXIgYWxsSWRzID0gbmV3IFN0clNldCgpO1xyXG4gICAgZmFzdC5mb3JFYWNoKGFjdGl2aXR5SWRzLFxyXG4gICAgICAgIGZ1bmN0aW9uIChpZCkge1xyXG4gICAgICAgICAgICBzZWxmLl9jYW5jZWxTdWJ0cmVlKGFsbElkcywgaWQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgc2VsZi5fYm9va21hcmtzLmZvckVhY2hWYWx1ZShmdW5jdGlvbiAoYm0pIHtcclxuICAgICAgICBpZiAoYWxsSWRzLmV4aXN0cyhibS5hY3Rpdml0eUlkKSkge1xyXG4gICAgICAgICAgICBzZWxmLl9ib29rbWFya3MucmVtb3ZlKGJtLm5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLl9jYW5jZWxTdWJ0cmVlID0gZnVuY3Rpb24gKGFsbElkcywgYWN0aXZpdHlJZCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgYWxsSWRzLmFkZChhY3Rpdml0eUlkKTtcclxuICAgIHZhciBzdGF0ZSA9IHNlbGYuZ2V0U3RhdGUoYWN0aXZpdHlJZCk7XHJcbiAgICBzdGF0ZS5jaGlsZEFjdGl2aXR5SWRzLmZvckVhY2goXHJcbiAgICAgICAgZnVuY3Rpb24gKGlkKSB7XHJcbiAgICAgICAgICAgIHNlbGYuX2NhbmNlbFN1YnRyZWUoYWxsSWRzLCBpZCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICBzdGF0ZS5yZXBvcnRTdGF0ZShlbnVtcy5BY3Rpdml0eVN0YXRlcy5jYW5jZWwpO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLmRlbGV0ZVNjb3BlT2ZBY3Rpdml0eSA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgYWN0aXZpdHlJZCkge1xyXG4gICAgdGhpcy5fc2NvcGVUcmVlLmRlbGV0ZVNjb3BlUGFydChjYWxsQ29udGV4dC5hY3Rpdml0eUlkLCBhY3Rpdml0eUlkKTtcclxufVxyXG5cclxuLyogU0VSSUFMSVpBVElPTiAqL1xyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLmdldFN0YXRlQW5kUHJvbW90aW9ucyA9IGZ1bmN0aW9uIChzZXJpYWxpemVyLCBnZXRQcm9tb3Rpb25zKSB7XHJcbiAgICBpZiAoc2VyaWFsaXplciAmJiAhXy5pc0Z1bmN0aW9uKHNlcmlhbGl6ZXIudG9KU09OKSkgdGhyb3cgbmV3IEVycm9yKFwiQXJndW1lbnQgJ3NlcmlhbGl6ZXInIGlzIG5vdCBhIHNlcmlhbGl6ZXIuXCIpO1xyXG5cclxuICAgIHZhciBhY3Rpdml0eVN0YXRlcyA9IG5ldyBTdHJNYXAoKTtcclxuICAgIHRoaXMuX2FjdGl2aXR5U3RhdGVzLmZvckVhY2hWYWx1ZShmdW5jdGlvbiAocykge1xyXG4gICAgICAgIGFjdGl2aXR5U3RhdGVzLmFkZChzLmFjdGl2aXR5SWQsIHMuYXNKU09OKCkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdmFyIHNjb3BlU3RhdGVBbmRQcm9tb3Rpb25zID0gdGhpcy5fc2NvcGVUcmVlLmdldFN0YXRlKGdldFByb21vdGlvbnMpO1xyXG5cclxuICAgIHZhciBzZXJpYWxpemVkO1xyXG4gICAgaWYgKHNlcmlhbGl6ZXIpIHtcclxuICAgICAgICBzZXJpYWxpemVkID0gc2VyaWFsaXplci50b0pTT04oe1xyXG4gICAgICAgICAgICBhY3Rpdml0eVN0YXRlczogYWN0aXZpdHlTdGF0ZXMsXHJcbiAgICAgICAgICAgIGJvb2ttYXJrczogdGhpcy5fYm9va21hcmtzLFxyXG4gICAgICAgICAgICBzY29wZTogc2NvcGVTdGF0ZUFuZFByb21vdGlvbnMuc3RhdGVcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHNlcmlhbGl6ZWQgPSB7XHJcbiAgICAgICAgICAgIGFjdGl2aXR5U3RhdGVzOiBhY3Rpdml0eVN0YXRlcy5fc2VyaWFsaXplVG9KU09OKCksXHJcbiAgICAgICAgICAgIGJvb2ttYXJrczogdGhpcy5fYm9va21hcmtzLl9zZXJpYWxpemVUb0pTT04oKSxcclxuICAgICAgICAgICAgc2NvcGU6IHNjb3BlU3RhdGVBbmRQcm9tb3Rpb25zLnN0YXRlXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgc3RhdGU6IHNlcmlhbGl6ZWQsXHJcbiAgICAgICAgcHJvbW90ZWRQcm9wZXJ0aWVzOiBzY29wZVN0YXRlQW5kUHJvbW90aW9ucy5wcm9tb3RlZFByb3BlcnRpZXNcclxuICAgIH07XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbiAoc2VyaWFsaXplciwganNvbikge1xyXG4gICAgaWYgKHNlcmlhbGl6ZXIgJiYgIV8uaXNGdW5jdGlvbihzZXJpYWxpemVyLmZyb21KU09OKSkgdGhyb3cgbmV3IEVycm9yKFwiQXJndW1lbnQgJ3NlcmlhbGl6ZXInIGlzIG5vdCBhIHNlcmlhbGl6ZXIuXCIpO1xyXG4gICAgaWYgKCFfLmlzT2JqZWN0KGpzb24pKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ2pzb24nIGlzIG5vdCBhbiBvYmplY3QuXCIpO1xyXG5cclxuICAgIGlmIChzZXJpYWxpemVyKSB7XHJcbiAgICAgICAganNvbiA9IHNlcmlhbGl6ZXIuZnJvbUpTT04oanNvbik7XHJcbiAgICAgICAgaWYgKCEoanNvbi5hY3Rpdml0eVN0YXRlcyBpbnN0YW5jZW9mIFN0ck1hcCkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBY3Rpdml0eVN0YXRlcyBwcm9wZXJ0eSB2YWx1ZSBvZiBhcmd1bWVudCAnanNvbicgaXMgbm90IGFuIFN0ck1hcCBpbnN0YW5jZS5cIik7XHJcbiAgICAgICAgaWYgKCEoanNvbi5ib29rbWFya3MgaW5zdGFuY2VvZiBTdHJNYXApKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQm9va21hcmtzIHByb3BlcnR5IHZhbHVlIG9mIGFyZ3VtZW50ICdqc29uJyBpcyBub3QgYW4gU3RyTWFwIGluc3RhbmNlLlwiKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIGlmICghanNvbi5hY3Rpdml0eVN0YXRlcykgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFjdGl2aXR5U3RhdGVzIHByb3BlcnR5IHZhbHVlIG9mIGFyZ3VtZW50ICdqc29uJyBpcyBub3QgYW4gb2JqZWN0LlwiKTtcclxuICAgICAgICBpZiAoIWpzb24uYm9va21hcmtzKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQm9va21hcmtzIHByb3BlcnR5IHZhbHVlIG9mIGFyZ3VtZW50ICdqc29uJyBpcyBub3QgYW4gb2JqZWN0LlwiKTtcclxuXHJcbiAgICAgICAgdmFyIGFjdGl2aXR5U3RhdGVzID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgICAgIGFjdGl2aXR5U3RhdGVzLl9kZXNlcmlhbGl6ZUZyb21KU09OKGpzb24uYWN0aXZpdHlTdGF0ZXMpO1xyXG4gICAgICAgIHZhciBib29rbWFya3MgPSBuZXcgU3RyTWFwKCk7XHJcbiAgICAgICAgYm9va21hcmtzLl9kZXNlcmlhbGl6ZUZyb21KU09OKGpzb24uYm9va21hcmtzKTtcclxuICAgICAgICBqc29uID0ge1xyXG4gICAgICAgICAgICBhY3Rpdml0eVN0YXRlczogYWN0aXZpdHlTdGF0ZXMsXHJcbiAgICAgICAgICAgIGJvb2ttYXJrczogYm9va21hcmtzLFxyXG4gICAgICAgICAgICBzY29wZToganNvbi5zY29wZVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fYWN0aXZpdHlTdGF0ZXMuZm9yRWFjaFZhbHVlKGZ1bmN0aW9uIChzKSB7XHJcbiAgICAgICAgdmFyIHN0b3JlZCA9IGpzb24uYWN0aXZpdHlTdGF0ZXMuZ2V0KHMuYWN0aXZpdHlJZCk7XHJcbiAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQoc3RvcmVkKSkgdGhyb3cgbmV3IEVycm9yKFwiQWN0aXZpdHkgXCIgKyBhLmFjdGl2aXR5SWQgKyBcIiBzdGF0ZSBub3QgZm91bmQuXCIpO1xyXG4gICAgICAgIHMuZnJvbUpTT04oc3RvcmVkKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuX2Jvb2ttYXJrcyA9IGpzb24uYm9va21hcmtzO1xyXG4gICAgdGhpcy5fc2NvcGVUcmVlLnNldFN0YXRlKGpzb24uc2NvcGUpO1xyXG59XHJcbi8qIFNFUklBTElaQVRJT04gKi9cclxuXHJcbm1vZHVsZS5leHBvcnRzID0gQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0OyJdfQ==
