"use strict";
"use strict";
var ActivityExecutionState = require("./activityExecutionState");
var ResumeBookmarkQueue = require("./resumeBookmarkQueue");
var enums = require("../common/enums");
var errors = require("../common/errors");
var util = require("util");
var EventEmitter = require('events').EventEmitter;
var _ = require("lodash");
var guids = require("../common/guids");
var ScopeTree = require("./scopeTree");
var StrMap = require("backpack-node").collections.StrMap;
var StrSet = require("backpack-node").collections.StrSet;
var is = require("../common/is");
var fast = require("fast.js");
var CallContext = require("./callContext");
function ActivityExecutionContext() {
  this._activityStates = new StrMap();
  this._bookmarks = new StrMap();
  this._resumeBMQueue = new ResumeBookmarkQueue();
  this._rootActivity = null;
  this._knownActivities = new StrMap();
  this._nextActivityId = 0;
  this._scopeTree = this._createScopeTree();
}
util.inherits(ActivityExecutionContext, EventEmitter);
Object.defineProperties(ActivityExecutionContext.prototype, {
  scope: {get: function() {
      return this._scopeTree.currentScope;
    }},
  hasScope: {get: function() {
      return !this._scopeTree.isOnInitial;
    }}
});
ActivityExecutionContext.prototype._createScopeTree = function() {
  var self = this;
  return new ScopeTree({resultCollected: function(context, reason, result, bookmarkName) {
      context.activity.resultCollected.call(context.scope, context, reason, result, bookmarkName);
    }}, function(id) {
    return self._getKnownActivity(id);
  });
};
ActivityExecutionContext.prototype._registerKnownActivity = function(activity) {
  this._knownActivities.add(activity.id, activity);
  if (is.composite(activity)) {
    activity.ensureImplementationCreated();
  }
};
ActivityExecutionContext.prototype.initialize = function(rootActivity) {
  if (this._rootActivity) {
    throw new Error("Context is already initialized.");
  }
  if (!is.activity(rootActivity)) {
    throw new TypeError("Argument 'rootActivity' value is not an activity.");
  }
  this._rootActivity = rootActivity;
  this._initialize(null, rootActivity, {id: 0});
};
ActivityExecutionContext.prototype.appendToContext = function(args) {
  this._checkInit();
  var self = this;
  var currMax = self._nextActivityId;
  var c = {id: currMax};
  if (_.isArray(args)) {
    var state = self.getState(self._rootActivity.id);
    args.forEach(function(arg) {
      if (is.activity(arg)) {
        self._initialize(self._rootActivity, arg, c);
        state.childActivityIds.add(arg.id);
      }
    });
  } else {
    throw new TypeError("Argument 'args' value is not an array.");
  }
  return {
    fromId: currMax,
    toId: this._nextActivityId
  };
};
ActivityExecutionContext.prototype.removeFromContext = function(removeToken) {
  this._checkInit();
  if (removeToken && is.defined(removeToken.fromId) && is.defined(removeToken.toId)) {
    var state = this.getState(this._rootActivity.id);
    for (var id = removeToken.fromId; id <= removeToken.toId; id++) {
      var sid = id.toString();
      this._knownActivities.remove(sid);
      state.childActivityIds.remove(sid);
    }
  } else {
    throw new TypeError("Argument 'removeToken' value is not a valid remove token object.");
  }
  this._nextActivityId = removeToken.fromId;
};
ActivityExecutionContext.prototype._checkInit = function() {
  if (!this._rootActivity) {
    throw new Error("Context is not initialized.");
  }
};
ActivityExecutionContext.prototype._initialize = function(parent, activity, idCounter) {
  var self = this;
  if (activity.id === null) {
    activity.id = (idCounter.id++).toString();
  } else if (activity.id !== (idCounter.id++).toString()) {
    throw new Error("Activity " + activity.id + " has been assigned to an other context in a different tree which is not allowed.");
  }
  self._nextActivityId = idCounter.id;
  var state = self.getState(activity.id);
  state.parentActivityId = parent ? parent.id : null;
  self._registerKnownActivity(activity);
  activity.forEachImmediateChild(function(child) {
    self._initialize(activity, child, idCounter);
    state.childActivityIds.add(child.id);
  });
};
ActivityExecutionContext.prototype.getState = function(id) {
  var self = this;
  var state = self._activityStates.get(id);
  if (is.undefined(state)) {
    state = new ActivityExecutionState(id);
    state.on(enums.ActivityStates.run, function() {
      var activity = self._knownActivities.get(id);
      if (!activity) {
        activity = {id: id};
      }
      self.emit(enums.ActivityStates.run, activity);
    });
    state.on(enums.ActivityStates.end, function(reason, result) {
      var activity = self._knownActivities.get(id);
      if (!activity) {
        activity = {id: id};
      }
      self.emit(enums.ActivityStates.end, activity, reason, result);
    });
    self._activityStates.add(id, state);
  }
  return state;
};
ActivityExecutionContext.prototype._getKnownActivity = function(activityId) {
  var activity = this._knownActivities.get(activityId);
  if (!activity) {
    throw new errors.ActivityRuntimeError("Activity by id '" + activityId + "' not found.");
  }
  return activity;
};
ActivityExecutionContext.prototype.createBookmark = function(activityId, name, endCallback) {
  this.registerBookmark({
    name: name,
    activityId: activityId,
    timestamp: new Date().getTime(),
    endCallback: endCallback
  });
  return name;
};
ActivityExecutionContext.prototype.registerBookmark = function(bookmark) {
  if (this._bookmarks.get(bookmark.name)) {
    throw new errors.ActivityRuntimeError("Bookmark '" + bookmark.name + "' already exists.");
  }
  this._bookmarks.set(bookmark.name, bookmark);
};
ActivityExecutionContext.prototype.isBookmarkExists = function(name) {
  return this._bookmarks.containsKey(name);
};
ActivityExecutionContext.prototype.getBookmarkTimestamp = function(name, throwIfNotFound) {
  var bm = this._bookmarks.get(name);
  if (is.undefined(bm) && throwIfNotFound) {
    throw new Error("Bookmark '" + name + "' not found.");
  }
  return bm ? bm.timestamp : null;
};
ActivityExecutionContext.prototype.deleteBookmark = function(name) {
  this._bookmarks.remove(name);
};
ActivityExecutionContext.prototype.resumeBookmarkInScope = function(callContext, name, reason, result) {
  var bm = this._bookmarks.get(name);
  if (is.undefined(bm)) {
    throw new Error("Bookmark '" + name + "' doesn't exists. Cannot continue with reason: " + reason + ".");
  }
  this._doResumeBookmark(callContext, bm, reason, result, reason === enums.ActivityStates.idle);
};
ActivityExecutionContext.prototype.resumeBookmarkInternal = function(callContext, name, reason, result) {
  var bm = this._bookmarks.get(name);
  this._resumeBMQueue.enqueue(name, reason, result);
};
ActivityExecutionContext.prototype.resumeBookmarkExternal = function(name, reason, result) {
  var self = this;
  var bm = self._bookmarks.get(name);
  if (is.undefined(bm)) {
    throw new errors.ActivityRuntimeError("Internal resume bookmark request cannot be processed because bookmark '" + name + "' doesn't exists.");
  }
  self._doResumeBookmark(new CallContext(this, bm.activityId), bm, reason, result);
};
ActivityExecutionContext.prototype.processResumeBookmarkQueue = function() {
  var self = this;
  var command = self._resumeBMQueue.dequeue();
  if (command) {
    var bm = self._bookmarks.get(command.name);
    if (is.undefined(bm)) {
      throw new errors.ActivityRuntimeError("Internal resume bookmark request cannot be processed because bookmark '" + command.name + "' doesn't exists.");
    }
    self._doResumeBookmark(new CallContext(this, bm.activityId), bm, command.reason, command.result);
    return true;
  }
  return false;
};
ActivityExecutionContext.prototype._doResumeBookmark = function(callContext, bookmark, reason, result, noRemove) {
  var scope = callContext.scope;
  if (!noRemove) {
    this._bookmarks.remove(bookmark.name);
  }
  var cb = null;
  if (bookmark.endCallback) {
    cb = scope.get(bookmark.endCallback);
    if (!_.isFunction(cb)) {
      cb = null;
    }
  }
  if (!cb) {
    throw new errors.ActivityRuntimeError("Bookmark's '" + bookmark.name + "' callback '" + bookmark.endCallback + "' is not defined on the current scope.");
  }
  cb.call(scope, callContext, reason, result, bookmark);
};
ActivityExecutionContext.prototype.cancelExecution = function(activityIds) {
  var self = this;
  var allIds = new StrSet();
  fast.forEach(activityIds, function(id) {
    self._cancelSubtree(allIds, id);
  });
  self._bookmarks.forEachValue(function(bm) {
    if (allIds.exists(bm.activityId)) {
      self._bookmarks.remove(bm.name);
    }
  });
};
ActivityExecutionContext.prototype._cancelSubtree = function(allIds, activityId) {
  var self = this;
  allIds.add(activityId);
  var state = self.getState(activityId);
  state.childActivityIds.forEach(function(id) {
    self._cancelSubtree(allIds, id);
  });
  state.reportState(enums.ActivityStates.cancel);
};
ActivityExecutionContext.prototype.deleteScopeOfActivity = function(callContext, activityId) {
  this._scopeTree.deleteScopePart(callContext.activityId, activityId);
};
ActivityExecutionContext.prototype.getStateAndPromotions = function(serializer, getPromotions) {
  if (serializer && !_.isFunction(serializer.toJSON)) {
    throw new Error("Argument 'serializer' is not a serializer.");
  }
  var activityStates = new StrMap();
  this._activityStates.forEachValue(function(s) {
    activityStates.add(s.activityId, s.asJSON());
  });
  var scopeStateAndPromotions = this._scopeTree.getState(getPromotions);
  var serialized;
  if (serializer) {
    serialized = serializer.toJSON({
      activityStates: activityStates,
      bookmarks: this._bookmarks,
      scope: scopeStateAndPromotions.state
    });
  } else {
    serialized = {
      activityStates: activityStates._serializeToJSON(),
      bookmarks: this._bookmarks._serializeToJSON(),
      scope: scopeStateAndPromotions.state
    };
  }
  return {
    state: serialized,
    promotedProperties: scopeStateAndPromotions.promotedProperties
  };
};
ActivityExecutionContext.prototype.setState = function(serializer, json) {
  if (serializer && !_.isFunction(serializer.fromJSON)) {
    throw new Error("Argument 'serializer' is not a serializer.");
  }
  if (!_.isObject(json)) {
    throw new TypeError("Argument 'json' is not an object.");
  }
  if (serializer) {
    json = serializer.fromJSON(json);
    if (!(json.activityStates instanceof StrMap)) {
      throw new TypeError("ActivityStates property value of argument 'json' is not an StrMap instance.");
    }
    if (!(json.bookmarks instanceof StrMap)) {
      throw new TypeError("Bookmarks property value of argument 'json' is not an StrMap instance.");
    }
  } else {
    if (!json.activityStates) {
      throw new TypeError("ActivityStates property value of argument 'json' is not an object.");
    }
    if (!json.bookmarks) {
      throw new TypeError("Bookmarks property value of argument 'json' is not an object.");
    }
    var activityStates = new StrMap();
    activityStates._deserializeFromJSON(json.activityStates);
    var bookmarks = new StrMap();
    bookmarks._deserializeFromJSON(json.bookmarks);
    json = {
      activityStates: activityStates,
      bookmarks: bookmarks,
      scope: json.scope
    };
  }
  this._activityStates.forEachValue(function(s) {
    var stored = json.activityStates.get(s.activityId);
    if (_.isUndefined(stored)) {
      throw new Error("Activity's of '" + s.activityId + "' state not found.");
    }
    s.fromJSON(stored);
  });
  this._bookmarks = json.bookmarks;
  this._scopeTree.setState(json.scope);
};
module.exports = ActivityExecutionContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLFdBQVcsQ0FBQztBQUVaLEFBQUksRUFBQSxDQUFBLHNCQUFxQixFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsMEJBQXlCLENBQUMsQ0FBQztBQUNoRSxBQUFJLEVBQUEsQ0FBQSxtQkFBa0IsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLHVCQUFzQixDQUFDLENBQUM7QUFDMUQsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsaUJBQWdCLENBQUMsQ0FBQztBQUN0QyxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxrQkFBaUIsQ0FBQyxDQUFDO0FBQ3hDLEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLFlBQVcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFFBQU8sQ0FBQyxhQUFhLENBQUM7QUFDakQsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsaUJBQWdCLENBQUMsQ0FBQztBQUN0QyxBQUFJLEVBQUEsQ0FBQSxTQUFRLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxhQUFZLENBQUMsQ0FBQztBQUN0QyxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxlQUFjLENBQUMsWUFBWSxPQUFPLENBQUM7QUFDeEQsQUFBSSxFQUFBLENBQUEsTUFBSyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsZUFBYyxDQUFDLFlBQVksT0FBTyxDQUFDO0FBQ3hELEFBQUksRUFBQSxDQUFBLEVBQUMsRUFBSSxDQUFBLE9B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O0FBQ3hELEFBQUksTUFBQSxDQUFBLFNBQVEsRUFBSSxJQUFJLE9BQUssQUFBQyxFQUFDLENBQUM7QUFDNUIsWUFBUSxxQkFBcUIsQUFBQyxDQUFDLElBQUcsVUFBVSxDQUFDLENBQUM7QUFDOUMsT0FBRyxFQUFJO0FBQ0gsbUJBQWEsQ0FBRyxlQUFhO0FBQzdCLGNBQVEsQ0FBRyxVQUFRO0FBQ25CLFVBQUksQ0FBRyxDQUFBLElBQUcsTUFBTTtBQUFBLElBQ3BCLENBQUM7RUFDTDtBQUFBLEFBRUEsS0FBRyxnQkFBZ0IsYUFBYSxBQUFDLENBQUMsU0FBVSxDQUFBLENBQUc7QUFDM0MsQUFBSSxNQUFBLENBQUEsTUFBSyxFQUFJLENBQUEsSUFBRyxlQUFlLElBQUksQUFBQyxDQUFDLENBQUEsV0FBVyxDQUFDLENBQUM7QUFDbEQsT0FBSSxDQUFBLFlBQVksQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFHO0FBQ3ZCLFVBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyxpQkFBZ0IsRUFBSSxDQUFBLENBQUEsV0FBVyxDQUFBLENBQUkscUJBQW1CLENBQUMsQ0FBQztJQUM1RTtBQUFBLEFBQ0EsSUFBQSxTQUFTLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQztFQUN0QixDQUFDLENBQUM7QUFFRixLQUFHLFdBQVcsRUFBSSxDQUFBLElBQUcsVUFBVSxDQUFDO0FBQ2hDLEtBQUcsV0FBVyxTQUFTLEFBQUMsQ0FBQyxJQUFHLE1BQU0sQ0FBQyxDQUFDO0FBQ3hDLENBQUM7QUFHRCxLQUFLLFFBQVEsRUFBSSx5QkFBdUIsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvYWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IEFjdGl2aXR5RXhlY3V0aW9uU3RhdGUgPSByZXF1aXJlKFwiLi9hY3Rpdml0eUV4ZWN1dGlvblN0YXRlXCIpO1xubGV0IFJlc3VtZUJvb2ttYXJrUXVldWUgPSByZXF1aXJlKFwiLi9yZXN1bWVCb29rbWFya1F1ZXVlXCIpO1xubGV0IGVudW1zID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lbnVtc1wiKTtcbmxldCBlcnJvcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2Vycm9yc1wiKTtcbmxldCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5sZXQgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyO1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IGd1aWRzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9ndWlkc1wiKTtcbmxldCBTY29wZVRyZWUgPSByZXF1aXJlKFwiLi9zY29wZVRyZWVcIik7XG5sZXQgU3RyTWFwID0gcmVxdWlyZShcImJhY2twYWNrLW5vZGVcIikuY29sbGVjdGlvbnMuU3RyTWFwO1xubGV0IFN0clNldCA9IHJlcXVpcmUoXCJiYWNrcGFjay1ub2RlXCIpLmNvbGxlY3Rpb25zLlN0clNldDtcbmxldCBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XG5sZXQgZmFzdCA9IHJlcXVpcmUoXCJmYXN0LmpzXCIpO1xubGV0IENhbGxDb250ZXh0ID0gcmVxdWlyZShcIi4vY2FsbENvbnRleHRcIik7XG5cbmZ1bmN0aW9uIEFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dCgpIHtcbiAgICB0aGlzLl9hY3Rpdml0eVN0YXRlcyA9IG5ldyBTdHJNYXAoKTtcbiAgICB0aGlzLl9ib29rbWFya3MgPSBuZXcgU3RyTWFwKCk7XG4gICAgdGhpcy5fcmVzdW1lQk1RdWV1ZSA9IG5ldyBSZXN1bWVCb29rbWFya1F1ZXVlKCk7XG4gICAgdGhpcy5fcm9vdEFjdGl2aXR5ID0gbnVsbDtcbiAgICB0aGlzLl9rbm93bkFjdGl2aXRpZXMgPSBuZXcgU3RyTWFwKCk7XG4gICAgdGhpcy5fbmV4dEFjdGl2aXR5SWQgPSAwO1xuICAgIHRoaXMuX3Njb3BlVHJlZSA9IHRoaXMuX2NyZWF0ZVNjb3BlVHJlZSgpO1xufVxuXG51dGlsLmluaGVyaXRzKEFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dCwgRXZlbnRFbWl0dGVyKTtcblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoXG4gICAgQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZSxcbiAgICB7XG4gICAgICAgIHNjb3BlOiB7XG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fc2NvcGVUcmVlLmN1cnJlbnRTY29wZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgaGFzU2NvcGU6IHtcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAhdGhpcy5fc2NvcGVUcmVlLmlzT25Jbml0aWFsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuKTtcblxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5fY3JlYXRlU2NvcGVUcmVlID0gZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gbmV3IFNjb3BlVHJlZShcbiAgICAgICAge1xuICAgICAgICAgICAgcmVzdWx0Q29sbGVjdGVkOiBmdW5jdGlvbiAoY29udGV4dCwgcmVhc29uLCByZXN1bHQsIGJvb2ttYXJrTmFtZSkge1xuICAgICAgICAgICAgICAgIGNvbnRleHQuYWN0aXZpdHkucmVzdWx0Q29sbGVjdGVkLmNhbGwoY29udGV4dC5zY29wZSwgY29udGV4dCwgcmVhc29uLCByZXN1bHQsIGJvb2ttYXJrTmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGZ1bmN0aW9uIChpZCkge1xuICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2dldEtub3duQWN0aXZpdHkoaWQpO1xuICAgICAgICB9KTtcbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuX3JlZ2lzdGVyS25vd25BY3Rpdml0eSA9IGZ1bmN0aW9uIChhY3Rpdml0eSkge1xuICAgIHRoaXMuX2tub3duQWN0aXZpdGllcy5hZGQoYWN0aXZpdHkuaWQsIGFjdGl2aXR5KTtcbiAgICBpZiAoaXMuY29tcG9zaXRlKGFjdGl2aXR5KSkge1xuICAgICAgICBhY3Rpdml0eS5lbnN1cmVJbXBsZW1lbnRhdGlvbkNyZWF0ZWQoKTtcbiAgICB9XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLmluaXRpYWxpemUgPSBmdW5jdGlvbiAocm9vdEFjdGl2aXR5KSB7XG4gICAgaWYgKHRoaXMuX3Jvb3RBY3Rpdml0eSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb250ZXh0IGlzIGFscmVhZHkgaW5pdGlhbGl6ZWQuXCIpO1xuICAgIH1cbiAgICBpZiAoIWlzLmFjdGl2aXR5KHJvb3RBY3Rpdml0eSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFyZ3VtZW50ICdyb290QWN0aXZpdHknIHZhbHVlIGlzIG5vdCBhbiBhY3Rpdml0eS5cIik7XG4gICAgfVxuXG4gICAgdGhpcy5fcm9vdEFjdGl2aXR5ID0gcm9vdEFjdGl2aXR5O1xuICAgIHRoaXMuX2luaXRpYWxpemUobnVsbCwgcm9vdEFjdGl2aXR5LCB7IGlkOiAwIH0pO1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5hcHBlbmRUb0NvbnRleHQgPSBmdW5jdGlvbiAoYXJncykge1xuICAgIHRoaXMuX2NoZWNrSW5pdCgpO1xuXG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuXG4gICAgbGV0IGN1cnJNYXggPSBzZWxmLl9uZXh0QWN0aXZpdHlJZDtcbiAgICBsZXQgYyA9IHsgaWQ6IGN1cnJNYXggfTtcblxuICAgIGlmIChfLmlzQXJyYXkoYXJncykpIHtcbiAgICAgICAgbGV0IHN0YXRlID0gc2VsZi5nZXRTdGF0ZShzZWxmLl9yb290QWN0aXZpdHkuaWQpO1xuICAgICAgICBhcmdzLmZvckVhY2goXG4gICAgICAgICAgICBmdW5jdGlvbiAoYXJnKSB7XG4gICAgICAgICAgICAgICAgaWYgKGlzLmFjdGl2aXR5KGFyZykpIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5faW5pdGlhbGl6ZShzZWxmLl9yb290QWN0aXZpdHksIGFyZywgYyk7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmNoaWxkQWN0aXZpdHlJZHMuYWRkKGFyZy5pZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ2FyZ3MnIHZhbHVlIGlzIG5vdCBhbiBhcnJheS5cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgZnJvbUlkOiBjdXJyTWF4LFxuICAgICAgICB0b0lkOiB0aGlzLl9uZXh0QWN0aXZpdHlJZFxuICAgIH07XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLnJlbW92ZUZyb21Db250ZXh0ID0gZnVuY3Rpb24gKHJlbW92ZVRva2VuKSB7XG4gICAgdGhpcy5fY2hlY2tJbml0KCk7XG5cbiAgICBpZiAocmVtb3ZlVG9rZW4gJiYgaXMuZGVmaW5lZChyZW1vdmVUb2tlbi5mcm9tSWQpICYmIGlzLmRlZmluZWQocmVtb3ZlVG9rZW4udG9JZCkpIHtcbiAgICAgICAgbGV0IHN0YXRlID0gdGhpcy5nZXRTdGF0ZSh0aGlzLl9yb290QWN0aXZpdHkuaWQpO1xuXG4gICAgICAgIGZvciAobGV0IGlkID0gcmVtb3ZlVG9rZW4uZnJvbUlkOyBpZCA8PSByZW1vdmVUb2tlbi50b0lkOyBpZCsrKSB7XG4gICAgICAgICAgICBsZXQgc2lkID0gaWQudG9TdHJpbmcoKTtcbiAgICAgICAgICAgIHRoaXMuX2tub3duQWN0aXZpdGllcy5yZW1vdmUoc2lkKTtcbiAgICAgICAgICAgIHN0YXRlLmNoaWxkQWN0aXZpdHlJZHMucmVtb3ZlKHNpZCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAncmVtb3ZlVG9rZW4nIHZhbHVlIGlzIG5vdCBhIHZhbGlkIHJlbW92ZSB0b2tlbiBvYmplY3QuXCIpO1xuICAgIH1cblxuICAgIHRoaXMuX25leHRBY3Rpdml0eUlkID0gcmVtb3ZlVG9rZW4uZnJvbUlkO1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5fY2hlY2tJbml0ID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICghdGhpcy5fcm9vdEFjdGl2aXR5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNvbnRleHQgaXMgbm90IGluaXRpYWxpemVkLlwiKTtcbiAgICB9XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLl9pbml0aWFsaXplID0gZnVuY3Rpb24gKHBhcmVudCwgYWN0aXZpdHksIGlkQ291bnRlcikge1xuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIGlmIChhY3Rpdml0eS5pZCA9PT0gbnVsbCkge1xuICAgICAgICBhY3Rpdml0eS5pZCA9IChpZENvdW50ZXIuaWQrKykudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoYWN0aXZpdHkuaWQgIT09IChpZENvdW50ZXIuaWQrKykudG9TdHJpbmcoKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBY3Rpdml0eSBcIiArIGFjdGl2aXR5LmlkICsgXCIgaGFzIGJlZW4gYXNzaWduZWQgdG8gYW4gb3RoZXIgY29udGV4dCBpbiBhIGRpZmZlcmVudCB0cmVlIHdoaWNoIGlzIG5vdCBhbGxvd2VkLlwiKTtcbiAgICB9XG4gICAgc2VsZi5fbmV4dEFjdGl2aXR5SWQgPSBpZENvdW50ZXIuaWQ7XG4gICAgbGV0IHN0YXRlID0gc2VsZi5nZXRTdGF0ZShhY3Rpdml0eS5pZCk7XG4gICAgc3RhdGUucGFyZW50QWN0aXZpdHlJZCA9IHBhcmVudCA/IHBhcmVudC5pZCA6IG51bGw7XG4gICAgc2VsZi5fcmVnaXN0ZXJLbm93bkFjdGl2aXR5KGFjdGl2aXR5KTtcblxuICAgIGFjdGl2aXR5LmZvckVhY2hJbW1lZGlhdGVDaGlsZChcbiAgICAgICAgZnVuY3Rpb24gKGNoaWxkKSB7XG4gICAgICAgICAgICBzZWxmLl9pbml0aWFsaXplKGFjdGl2aXR5LCBjaGlsZCwgaWRDb3VudGVyKTtcbiAgICAgICAgICAgIHN0YXRlLmNoaWxkQWN0aXZpdHlJZHMuYWRkKGNoaWxkLmlkKTtcbiAgICAgICAgfSk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKGlkKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuXG4gICAgbGV0IHN0YXRlID0gc2VsZi5fYWN0aXZpdHlTdGF0ZXMuZ2V0KGlkKTtcbiAgICBpZiAoaXMudW5kZWZpbmVkKHN0YXRlKSkge1xuICAgICAgICBzdGF0ZSA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvblN0YXRlKGlkKTtcbiAgICAgICAgc3RhdGUub24oXG4gICAgICAgICAgICBlbnVtcy5BY3Rpdml0eVN0YXRlcy5ydW4sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBsZXQgYWN0aXZpdHkgPSBzZWxmLl9rbm93bkFjdGl2aXRpZXMuZ2V0KGlkKTtcbiAgICAgICAgICAgICAgICBpZiAoIWFjdGl2aXR5KSB7XG4gICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5ID0geyBpZDogaWQgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KGVudW1zLkFjdGl2aXR5U3RhdGVzLnJ1biwgYWN0aXZpdHkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIHN0YXRlLm9uKFxuICAgICAgICAgICAgZW51bXMuQWN0aXZpdHlTdGF0ZXMuZW5kLCBmdW5jdGlvbiAocmVhc29uLCByZXN1bHQpIHtcbiAgICAgICAgICAgICAgICBsZXQgYWN0aXZpdHkgPSBzZWxmLl9rbm93bkFjdGl2aXRpZXMuZ2V0KGlkKTtcbiAgICAgICAgICAgICAgICBpZiAoIWFjdGl2aXR5KSB7XG4gICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5ID0geyBpZDogaWQgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KGVudW1zLkFjdGl2aXR5U3RhdGVzLmVuZCwgYWN0aXZpdHksIHJlYXNvbiwgcmVzdWx0KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBzZWxmLl9hY3Rpdml0eVN0YXRlcy5hZGQoaWQsIHN0YXRlKTtcbiAgICB9XG4gICAgcmV0dXJuIHN0YXRlO1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5fZ2V0S25vd25BY3Rpdml0eSA9IGZ1bmN0aW9uIChhY3Rpdml0eUlkKSB7XG4gICAgbGV0IGFjdGl2aXR5ID0gdGhpcy5fa25vd25BY3Rpdml0aWVzLmdldChhY3Rpdml0eUlkKTtcbiAgICBpZiAoIWFjdGl2aXR5KSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJBY3Rpdml0eSBieSBpZCAnXCIgKyBhY3Rpdml0eUlkICsgXCInIG5vdCBmb3VuZC5cIik7XG4gICAgfVxuICAgIHJldHVybiBhY3Rpdml0eTtcbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuY3JlYXRlQm9va21hcmsgPSBmdW5jdGlvbiAoYWN0aXZpdHlJZCwgbmFtZSwgZW5kQ2FsbGJhY2spIHtcbiAgICB0aGlzLnJlZ2lzdGVyQm9va21hcmsoXG4gICAgICAgIHtcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICBhY3Rpdml0eUlkOiBhY3Rpdml0eUlkLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSxcbiAgICAgICAgICAgIGVuZENhbGxiYWNrOiBlbmRDYWxsYmFja1xuICAgICAgICB9KTtcbiAgICByZXR1cm4gbmFtZTtcbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUucmVnaXN0ZXJCb29rbWFyayA9IGZ1bmN0aW9uIChib29rbWFyaykge1xuICAgIGlmICh0aGlzLl9ib29rbWFya3MuZ2V0KGJvb2ttYXJrLm5hbWUpKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJCb29rbWFyayAnXCIgKyBib29rbWFyay5uYW1lICsgXCInIGFscmVhZHkgZXhpc3RzLlwiKTtcbiAgICB9XG4gICAgdGhpcy5fYm9va21hcmtzLnNldChib29rbWFyay5uYW1lLCBib29rbWFyayk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLmlzQm9va21hcmtFeGlzdHMgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIHJldHVybiB0aGlzLl9ib29rbWFya3MuY29udGFpbnNLZXkobmFtZSk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLmdldEJvb2ttYXJrVGltZXN0YW1wID0gZnVuY3Rpb24gKG5hbWUsIHRocm93SWZOb3RGb3VuZCkge1xuICAgIGxldCBibSA9IHRoaXMuX2Jvb2ttYXJrcy5nZXQobmFtZSk7XG4gICAgaWYgKGlzLnVuZGVmaW5lZChibSkgJiYgdGhyb3dJZk5vdEZvdW5kKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkJvb2ttYXJrICdcIiArIG5hbWUgKyBcIicgbm90IGZvdW5kLlwiKTtcbiAgICB9XG4gICAgcmV0dXJuIGJtID8gYm0udGltZXN0YW1wIDogbnVsbDtcbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuZGVsZXRlQm9va21hcmsgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIHRoaXMuX2Jvb2ttYXJrcy5yZW1vdmUobmFtZSk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLnJlc3VtZUJvb2ttYXJrSW5TY29wZSA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgbmFtZSwgcmVhc29uLCByZXN1bHQpIHtcbiAgICBsZXQgYm0gPSB0aGlzLl9ib29rbWFya3MuZ2V0KG5hbWUpO1xuICAgIGlmIChpcy51bmRlZmluZWQoYm0pKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkJvb2ttYXJrICdcIiArIG5hbWUgKyBcIicgZG9lc24ndCBleGlzdHMuIENhbm5vdCBjb250aW51ZSB3aXRoIHJlYXNvbjogXCIgKyByZWFzb24gKyBcIi5cIik7XG4gICAgfVxuICAgIHRoaXMuX2RvUmVzdW1lQm9va21hcmsoY2FsbENvbnRleHQsIGJtLCByZWFzb24sIHJlc3VsdCwgcmVhc29uID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5pZGxlKTtcbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUucmVzdW1lQm9va21hcmtJbnRlcm5hbCA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgbmFtZSwgcmVhc29uLCByZXN1bHQpIHtcbiAgICBsZXQgYm0gPSB0aGlzLl9ib29rbWFya3MuZ2V0KG5hbWUpO1xuICAgIHRoaXMuX3Jlc3VtZUJNUXVldWUuZW5xdWV1ZShuYW1lLCByZWFzb24sIHJlc3VsdCk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLnJlc3VtZUJvb2ttYXJrRXh0ZXJuYWwgPSBmdW5jdGlvbiAobmFtZSwgcmVhc29uLCByZXN1bHQpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGJtID0gc2VsZi5fYm9va21hcmtzLmdldChuYW1lKTtcbiAgICBpZiAoaXMudW5kZWZpbmVkKGJtKSkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiSW50ZXJuYWwgcmVzdW1lIGJvb2ttYXJrIHJlcXVlc3QgY2Fubm90IGJlIHByb2Nlc3NlZCBiZWNhdXNlIGJvb2ttYXJrICdcIiArIG5hbWUgKyBcIicgZG9lc24ndCBleGlzdHMuXCIpO1xuICAgIH1cbiAgICBzZWxmLl9kb1Jlc3VtZUJvb2ttYXJrKG5ldyBDYWxsQ29udGV4dCh0aGlzLCBibS5hY3Rpdml0eUlkKSwgYm0sIHJlYXNvbiwgcmVzdWx0KTtcbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUucHJvY2Vzc1Jlc3VtZUJvb2ttYXJrUXVldWUgPSBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIGxldCBjb21tYW5kID0gc2VsZi5fcmVzdW1lQk1RdWV1ZS5kZXF1ZXVlKCk7XG4gICAgaWYgKGNvbW1hbmQpIHtcbiAgICAgICAgbGV0IGJtID0gc2VsZi5fYm9va21hcmtzLmdldChjb21tYW5kLm5hbWUpO1xuICAgICAgICBpZiAoaXMudW5kZWZpbmVkKGJtKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eVJ1bnRpbWVFcnJvcihcIkludGVybmFsIHJlc3VtZSBib29rbWFyayByZXF1ZXN0IGNhbm5vdCBiZSBwcm9jZXNzZWQgYmVjYXVzZSBib29rbWFyayAnXCIgKyBjb21tYW5kLm5hbWUgKyBcIicgZG9lc24ndCBleGlzdHMuXCIpO1xuICAgICAgICB9XG4gICAgICAgIHNlbGYuX2RvUmVzdW1lQm9va21hcmsobmV3IENhbGxDb250ZXh0KHRoaXMsIGJtLmFjdGl2aXR5SWQpLCBibSwgY29tbWFuZC5yZWFzb24sIGNvbW1hbmQucmVzdWx0KTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuX2RvUmVzdW1lQm9va21hcmsgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIGJvb2ttYXJrLCByZWFzb24sIHJlc3VsdCwgbm9SZW1vdmUpIHtcbiAgICBsZXQgc2NvcGUgPSBjYWxsQ29udGV4dC5zY29wZTtcbiAgICBpZiAoIW5vUmVtb3ZlKSB7XG4gICAgICAgIHRoaXMuX2Jvb2ttYXJrcy5yZW1vdmUoYm9va21hcmsubmFtZSk7XG4gICAgfVxuICAgIGxldCBjYiA9IG51bGw7XG4gICAgaWYgKGJvb2ttYXJrLmVuZENhbGxiYWNrKSB7XG4gICAgICAgIGNiID0gc2NvcGUuZ2V0KGJvb2ttYXJrLmVuZENhbGxiYWNrKTtcbiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24oY2IpKSB7XG4gICAgICAgICAgICBjYiA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFjYikge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiQm9va21hcmsncyAnXCIgKyBib29rbWFyay5uYW1lICsgXCInIGNhbGxiYWNrICdcIiArIGJvb2ttYXJrLmVuZENhbGxiYWNrICsgXCInIGlzIG5vdCBkZWZpbmVkIG9uIHRoZSBjdXJyZW50IHNjb3BlLlwiKTtcbiAgICB9XG4gICAgY2IuY2FsbChzY29wZSwgY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0LCBib29rbWFyayk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLmNhbmNlbEV4ZWN1dGlvbiA9IGZ1bmN0aW9uIChhY3Rpdml0eUlkcykge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBsZXQgYWxsSWRzID0gbmV3IFN0clNldCgpO1xuICAgIGZhc3QuZm9yRWFjaChhY3Rpdml0eUlkcyxcbiAgICAgICAgZnVuY3Rpb24gKGlkKSB7XG4gICAgICAgICAgICBzZWxmLl9jYW5jZWxTdWJ0cmVlKGFsbElkcywgaWQpO1xuICAgICAgICB9KTtcbiAgICBzZWxmLl9ib29rbWFya3MuZm9yRWFjaFZhbHVlKGZ1bmN0aW9uIChibSkge1xuICAgICAgICBpZiAoYWxsSWRzLmV4aXN0cyhibS5hY3Rpdml0eUlkKSkge1xuICAgICAgICAgICAgc2VsZi5fYm9va21hcmtzLnJlbW92ZShibS5uYW1lKTtcbiAgICAgICAgfVxuICAgIH0pO1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5fY2FuY2VsU3VidHJlZSA9IGZ1bmN0aW9uIChhbGxJZHMsIGFjdGl2aXR5SWQpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgYWxsSWRzLmFkZChhY3Rpdml0eUlkKTtcbiAgICBsZXQgc3RhdGUgPSBzZWxmLmdldFN0YXRlKGFjdGl2aXR5SWQpO1xuICAgIHN0YXRlLmNoaWxkQWN0aXZpdHlJZHMuZm9yRWFjaChcbiAgICAgICAgZnVuY3Rpb24gKGlkKSB7XG4gICAgICAgICAgICBzZWxmLl9jYW5jZWxTdWJ0cmVlKGFsbElkcywgaWQpO1xuICAgICAgICB9KTtcbiAgICBzdGF0ZS5yZXBvcnRTdGF0ZShlbnVtcy5BY3Rpdml0eVN0YXRlcy5jYW5jZWwpO1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5kZWxldGVTY29wZU9mQWN0aXZpdHkgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIGFjdGl2aXR5SWQpIHtcbiAgICB0aGlzLl9zY29wZVRyZWUuZGVsZXRlU2NvcGVQYXJ0KGNhbGxDb250ZXh0LmFjdGl2aXR5SWQsIGFjdGl2aXR5SWQpO1xufTtcblxuLyogU0VSSUFMSVpBVElPTiAqL1xuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5nZXRTdGF0ZUFuZFByb21vdGlvbnMgPSBmdW5jdGlvbiAoc2VyaWFsaXplciwgZ2V0UHJvbW90aW9ucykge1xuICAgIGlmIChzZXJpYWxpemVyICYmICFfLmlzRnVuY3Rpb24oc2VyaWFsaXplci50b0pTT04pKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFyZ3VtZW50ICdzZXJpYWxpemVyJyBpcyBub3QgYSBzZXJpYWxpemVyLlwiKTtcbiAgICB9XG5cbiAgICBsZXQgYWN0aXZpdHlTdGF0ZXMgPSBuZXcgU3RyTWFwKCk7XG4gICAgdGhpcy5fYWN0aXZpdHlTdGF0ZXMuZm9yRWFjaFZhbHVlKGZ1bmN0aW9uIChzKSB7XG4gICAgICAgIGFjdGl2aXR5U3RhdGVzLmFkZChzLmFjdGl2aXR5SWQsIHMuYXNKU09OKCkpO1xuICAgIH0pO1xuXG4gICAgbGV0IHNjb3BlU3RhdGVBbmRQcm9tb3Rpb25zID0gdGhpcy5fc2NvcGVUcmVlLmdldFN0YXRlKGdldFByb21vdGlvbnMpO1xuXG4gICAgbGV0IHNlcmlhbGl6ZWQ7XG4gICAgaWYgKHNlcmlhbGl6ZXIpIHtcbiAgICAgICAgc2VyaWFsaXplZCA9IHNlcmlhbGl6ZXIudG9KU09OKHtcbiAgICAgICAgICAgIGFjdGl2aXR5U3RhdGVzOiBhY3Rpdml0eVN0YXRlcyxcbiAgICAgICAgICAgIGJvb2ttYXJrczogdGhpcy5fYm9va21hcmtzLFxuICAgICAgICAgICAgc2NvcGU6IHNjb3BlU3RhdGVBbmRQcm9tb3Rpb25zLnN0YXRlXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgc2VyaWFsaXplZCA9IHtcbiAgICAgICAgICAgIGFjdGl2aXR5U3RhdGVzOiBhY3Rpdml0eVN0YXRlcy5fc2VyaWFsaXplVG9KU09OKCksXG4gICAgICAgICAgICBib29rbWFya3M6IHRoaXMuX2Jvb2ttYXJrcy5fc2VyaWFsaXplVG9KU09OKCksXG4gICAgICAgICAgICBzY29wZTogc2NvcGVTdGF0ZUFuZFByb21vdGlvbnMuc3RhdGVcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBzdGF0ZTogc2VyaWFsaXplZCxcbiAgICAgICAgcHJvbW90ZWRQcm9wZXJ0aWVzOiBzY29wZVN0YXRlQW5kUHJvbW90aW9ucy5wcm9tb3RlZFByb3BlcnRpZXNcbiAgICB9O1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uIChzZXJpYWxpemVyLCBqc29uKSB7XG4gICAgaWYgKHNlcmlhbGl6ZXIgJiYgIV8uaXNGdW5jdGlvbihzZXJpYWxpemVyLmZyb21KU09OKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBcmd1bWVudCAnc2VyaWFsaXplcicgaXMgbm90IGEgc2VyaWFsaXplci5cIik7XG4gICAgfVxuICAgIGlmICghXy5pc09iamVjdChqc29uKSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ2pzb24nIGlzIG5vdCBhbiBvYmplY3QuXCIpO1xuICAgIH1cblxuICAgIGlmIChzZXJpYWxpemVyKSB7XG4gICAgICAgIGpzb24gPSBzZXJpYWxpemVyLmZyb21KU09OKGpzb24pO1xuICAgICAgICBpZiAoIShqc29uLmFjdGl2aXR5U3RhdGVzIGluc3RhbmNlb2YgU3RyTWFwKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFjdGl2aXR5U3RhdGVzIHByb3BlcnR5IHZhbHVlIG9mIGFyZ3VtZW50ICdqc29uJyBpcyBub3QgYW4gU3RyTWFwIGluc3RhbmNlLlwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIShqc29uLmJvb2ttYXJrcyBpbnN0YW5jZW9mIFN0ck1hcCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJCb29rbWFya3MgcHJvcGVydHkgdmFsdWUgb2YgYXJndW1lbnQgJ2pzb24nIGlzIG5vdCBhbiBTdHJNYXAgaW5zdGFuY2UuXCIpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBpZiAoIWpzb24uYWN0aXZpdHlTdGF0ZXMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBY3Rpdml0eVN0YXRlcyBwcm9wZXJ0eSB2YWx1ZSBvZiBhcmd1bWVudCAnanNvbicgaXMgbm90IGFuIG9iamVjdC5cIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFqc29uLmJvb2ttYXJrcykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkJvb2ttYXJrcyBwcm9wZXJ0eSB2YWx1ZSBvZiBhcmd1bWVudCAnanNvbicgaXMgbm90IGFuIG9iamVjdC5cIik7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYWN0aXZpdHlTdGF0ZXMgPSBuZXcgU3RyTWFwKCk7XG4gICAgICAgIGFjdGl2aXR5U3RhdGVzLl9kZXNlcmlhbGl6ZUZyb21KU09OKGpzb24uYWN0aXZpdHlTdGF0ZXMpO1xuICAgICAgICBsZXQgYm9va21hcmtzID0gbmV3IFN0ck1hcCgpO1xuICAgICAgICBib29rbWFya3MuX2Rlc2VyaWFsaXplRnJvbUpTT04oanNvbi5ib29rbWFya3MpO1xuICAgICAgICBqc29uID0ge1xuICAgICAgICAgICAgYWN0aXZpdHlTdGF0ZXM6IGFjdGl2aXR5U3RhdGVzLFxuICAgICAgICAgICAgYm9va21hcmtzOiBib29rbWFya3MsXG4gICAgICAgICAgICBzY29wZToganNvbi5zY29wZVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHRoaXMuX2FjdGl2aXR5U3RhdGVzLmZvckVhY2hWYWx1ZShmdW5jdGlvbiAocykge1xuICAgICAgICBsZXQgc3RvcmVkID0ganNvbi5hY3Rpdml0eVN0YXRlcy5nZXQocy5hY3Rpdml0eUlkKTtcbiAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQoc3RvcmVkKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQWN0aXZpdHkncyBvZiAnXCIgKyBzLmFjdGl2aXR5SWQgKyBcIicgc3RhdGUgbm90IGZvdW5kLlwiKTtcbiAgICAgICAgfVxuICAgICAgICBzLmZyb21KU09OKHN0b3JlZCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLl9ib29rbWFya3MgPSBqc29uLmJvb2ttYXJrcztcbiAgICB0aGlzLl9zY29wZVRyZWUuc2V0U3RhdGUoanNvbi5zY29wZSk7XG59O1xuLyogU0VSSUFMSVpBVElPTiAqL1xuXG5tb2R1bGUuZXhwb3J0cyA9IEFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dDsiXX0=
