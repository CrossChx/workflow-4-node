"use strict";
"use strict";
var util = require("util");
var _ = require("lodash");
var StrMap = require("backpack-node").collections.StrMap;
var is = require("../common/is");
function ScopeNode(id, scopePart) {
  this.id = id;
  this._parent = null;
  this._children = new StrMap();
  this._scopePart = scopePart;
  this._keys = [];
  for (var key in scopePart) {
    this._keys.push(key);
  }
}
Object.defineProperties(ScopeNode.prototype, {
  _keys: {
    value: null,
    writable: true,
    enumerable: false
  },
  parent: {
    get: function() {
      return this._parent;
    },
    set: function(value) {
      if (value !== null && !(value instanceof ScopeNode)) {
        throw new TypeError("Node argument expected.");
      }
      if (this._parent !== null) {
        throw new Error("Parent already defined.");
      }
      value.addChild(this);
    }
  }
});
ScopeNode.prototype.forEachToRoot = function(f) {
  var current = this;
  while (current) {
    if (f.call(this, current) === false) {
      return ;
    }
    current = current._parent;
  }
};
ScopeNode.prototype.forEachChild = function(f) {
  this._children.forEachValue(f);
};
ScopeNode.prototype.addChild = function(childItem) {
  if (!(childItem instanceof ScopeNode)) {
    throw new TypeError("Node argument expected.");
  }
  if (childItem._parent) {
    throw new Error("Item has been already ha a parent node.");
  }
  childItem._parent = this;
  this._children.add(childItem.id, childItem);
};
ScopeNode.prototype.removeChild = function(childItem) {
  if (!(childItem instanceof ScopeNode)) {
    throw new TypeError("Node argument expected.");
  }
  if (childItem._parent !== this) {
    throw new Error("Item is not a current node's child.");
  }
  childItem._parent = null;
  this._children.remove(childItem.id);
};
ScopeNode.prototype.clearChildren = function() {
  this._children.clear();
};
ScopeNode.prototype.isPropertyExists = function(name) {
  return is.defined(this._scopePart[name]);
};
ScopeNode.prototype.getPropertyValue = function(name, canReturnPrivate) {
  if (canReturnPrivate) {
    return this._scopePart[name];
  } else if (!this._isPrivate(name)) {
    return this._scopePart[name];
  }
};
ScopeNode.prototype.setPropertyValue = function(name, value, canSetPrivate) {
  if (this._isPrivate(name)) {
    if (canSetPrivate) {
      if (!is.defined(this._scopePart[name])) {
        this._keys.push(name);
      }
      this._scopePart[name] = value;
      return true;
    }
  } else if (is.defined(this._scopePart[name])) {
    this._scopePart[name] = value;
    return true;
  }
  return false;
};
ScopeNode.prototype.createPropertyWithValue = function(name, value) {
  if (!is.defined(this._scopePart[name])) {
    this._keys.push(name);
  }
  this._scopePart[name] = value;
};
ScopeNode.prototype.deleteProperty = function(name, canDeletePrivate) {
  if (is.defined(this._scopePart[name])) {
    if (this._isPrivate(name)) {
      if (canDeletePrivate) {
        this._keys.splice(_.indexOf(this._keys, name), 1);
        delete this._scopePart[name];
        return true;
      }
    } else {
      this._keys.splice(_.indexOf(this._keys, name), 1);
      delete this._scopePart[name];
      return true;
    }
  }
  return false;
};
ScopeNode.prototype.enumeratePropertyNames = $traceurRuntime.initGeneratorFunction(function $__8(canEnumeratePrivate) {
  var i,
      i$__7,
      key;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          $ctx.state = (canEnumeratePrivate) ? 6 : 16;
          break;
        case 6:
          i = 0;
          $ctx.state = 7;
          break;
        case 7:
          $ctx.state = (i < this._keys.length) ? 1 : -2;
          break;
        case 4:
          i++;
          $ctx.state = 7;
          break;
        case 1:
          $ctx.state = 2;
          return this._keys[i];
        case 2:
          $ctx.maybeThrow();
          $ctx.state = 4;
          break;
        case 16:
          i$__7 = 0;
          $ctx.state = 17;
          break;
        case 17:
          $ctx.state = (i$__7 < this._keys.length) ? 13 : -2;
          break;
        case 11:
          i$__7++;
          $ctx.state = 17;
          break;
        case 13:
          key = this._keys[i$__7];
          $ctx.state = 14;
          break;
        case 14:
          $ctx.state = (!this._isPrivate(key)) ? 8 : 11;
          break;
        case 8:
          $ctx.state = 9;
          return key;
        case 9:
          $ctx.maybeThrow();
          $ctx.state = 11;
          break;
        default:
          return $ctx.end();
      }
  }, $__8, this);
});
ScopeNode.prototype.forEachProperty = function(f) {
  var self = this;
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (self._keys)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var fn = $__1.value;
      {
        f(fn, self._scopePart[fn]);
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
};
ScopeNode.prototype._isPrivate = function(key) {
  return key[0] === "_";
};
module.exports = ScopeNode;
//# sourceMappingURL=data:application/json;base64,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QW9DLENBQUM7RUFDdkMsQ0FBRSxPQUFRO0FBQ1IsTUFBSTtBQUNGLFNBQUksS0FBaUIsR0FBSyxDQUFBLFdBQXVCLEdBQUssS0FBRyxDQUFHO0FBQzFELGtCQUF3QixBQUFDLEVBQUMsQ0FBQztNQUM3QjtBQUFBLElBQ0YsQ0FBRSxPQUFRO0FBQ1IsY0FBd0I7QUFDdEIsa0JBQXdCO01BQzFCO0FBQUEsSUFDRjtBQUFBLEVBQ0Y7QUFBQSxBQXlJUixDQUFDO0FBRUQsUUFBUSxVQUFVLFdBQVcsRUFBSSxVQUFVLEdBQUUsQ0FBRztBQUM1QyxPQUFPLENBQUEsR0FBRSxDQUFFLENBQUEsQ0FBQyxJQUFNLElBQUUsQ0FBQztBQUN6QixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksVUFBUSxDQUFDO0FBQzFCIiwiZmlsZSI6ImFjdGl2aXRpZXMvc2NvcGVOb2RlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcbmxldCBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbmxldCBTdHJNYXAgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5jb2xsZWN0aW9ucy5TdHJNYXA7XG5sZXQgaXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2lzXCIpO1xuXG5mdW5jdGlvbiBTY29wZU5vZGUoaWQsIHNjb3BlUGFydCkge1xuICAgIHRoaXMuaWQgPSBpZDtcbiAgICB0aGlzLl9wYXJlbnQgPSBudWxsO1xuICAgIHRoaXMuX2NoaWxkcmVuID0gbmV3IFN0ck1hcCgpO1xuICAgIHRoaXMuX3Njb3BlUGFydCA9IHNjb3BlUGFydDtcbiAgICB0aGlzLl9rZXlzID0gW107XG4gICAgZm9yIChsZXQga2V5IGluIHNjb3BlUGFydCkge1xuICAgICAgICB0aGlzLl9rZXlzLnB1c2goa2V5KTtcbiAgICB9XG59XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFNjb3BlTm9kZS5wcm90b3R5cGUsIHtcbiAgICBfa2V5czoge1xuICAgICAgICB2YWx1ZTogbnVsbCxcbiAgICAgICAgd3JpdGFibGU6IHRydWUsXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlXG4gICAgfSxcbiAgICBwYXJlbnQ6IHtcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyZW50O1xuICAgICAgICB9LFxuICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmICEodmFsdWUgaW5zdGFuY2VvZiBTY29wZU5vZGUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIk5vZGUgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuX3BhcmVudCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhcmVudCBhbHJlYWR5IGRlZmluZWQuXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFsdWUuYWRkQ2hpbGQodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG59KTtcblxuU2NvcGVOb2RlLnByb3RvdHlwZS5mb3JFYWNoVG9Sb290ID0gZnVuY3Rpb24gKGYpIHtcbiAgICBsZXQgY3VycmVudCA9IHRoaXM7XG4gICAgd2hpbGUgKGN1cnJlbnQpIHtcbiAgICAgICAgaWYgKGYuY2FsbCh0aGlzLCBjdXJyZW50KSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjdXJyZW50ID0gY3VycmVudC5fcGFyZW50O1xuICAgIH1cbn07XG5cblNjb3BlTm9kZS5wcm90b3R5cGUuZm9yRWFjaENoaWxkID0gZnVuY3Rpb24gKGYpIHtcbiAgICB0aGlzLl9jaGlsZHJlbi5mb3JFYWNoVmFsdWUoZik7XG59O1xuXG5TY29wZU5vZGUucHJvdG90eXBlLmFkZENoaWxkID0gZnVuY3Rpb24gKGNoaWxkSXRlbSkge1xuICAgIGlmICghKGNoaWxkSXRlbSBpbnN0YW5jZW9mIFNjb3BlTm9kZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIk5vZGUgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xuICAgIH1cbiAgICBpZiAoY2hpbGRJdGVtLl9wYXJlbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSXRlbSBoYXMgYmVlbiBhbHJlYWR5IGhhIGEgcGFyZW50IG5vZGUuXCIpO1xuICAgIH1cbiAgICBjaGlsZEl0ZW0uX3BhcmVudCA9IHRoaXM7XG4gICAgdGhpcy5fY2hpbGRyZW4uYWRkKGNoaWxkSXRlbS5pZCwgY2hpbGRJdGVtKTtcbn07XG5cblNjb3BlTm9kZS5wcm90b3R5cGUucmVtb3ZlQ2hpbGQgPSBmdW5jdGlvbiAoY2hpbGRJdGVtKSB7XG4gICAgaWYgKCEoY2hpbGRJdGVtIGluc3RhbmNlb2YgU2NvcGVOb2RlKSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiTm9kZSBhcmd1bWVudCBleHBlY3RlZC5cIik7XG4gICAgfVxuICAgIGlmIChjaGlsZEl0ZW0uX3BhcmVudCAhPT0gdGhpcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJdGVtIGlzIG5vdCBhIGN1cnJlbnQgbm9kZSdzIGNoaWxkLlwiKTtcbiAgICB9XG4gICAgY2hpbGRJdGVtLl9wYXJlbnQgPSBudWxsO1xuICAgIHRoaXMuX2NoaWxkcmVuLnJlbW92ZShjaGlsZEl0ZW0uaWQpO1xufTtcblxuU2NvcGVOb2RlLnByb3RvdHlwZS5jbGVhckNoaWxkcmVuID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuX2NoaWxkcmVuLmNsZWFyKCk7XG59O1xuXG5TY29wZU5vZGUucHJvdG90eXBlLmlzUHJvcGVydHlFeGlzdHMgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIHJldHVybiBpcy5kZWZpbmVkKHRoaXMuX3Njb3BlUGFydFtuYW1lXSk7XG59O1xuXG5TY29wZU5vZGUucHJvdG90eXBlLmdldFByb3BlcnR5VmFsdWUgPSBmdW5jdGlvbiAobmFtZSwgY2FuUmV0dXJuUHJpdmF0ZSkge1xuICAgIGlmIChjYW5SZXR1cm5Qcml2YXRlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zY29wZVBhcnRbbmFtZV07XG4gICAgfVxuICAgIGVsc2UgaWYgKCF0aGlzLl9pc1ByaXZhdGUobmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Njb3BlUGFydFtuYW1lXTtcbiAgICB9XG59O1xuXG5TY29wZU5vZGUucHJvdG90eXBlLnNldFByb3BlcnR5VmFsdWUgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUsIGNhblNldFByaXZhdGUpIHtcbiAgICBpZiAodGhpcy5faXNQcml2YXRlKG5hbWUpKSB7XG4gICAgICAgIGlmIChjYW5TZXRQcml2YXRlKSB7XG4gICAgICAgICAgICBpZiAoIWlzLmRlZmluZWQodGhpcy5fc2NvcGVQYXJ0W25hbWVdKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2tleXMucHVzaChuYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX3Njb3BlUGFydFtuYW1lXSA9IHZhbHVlO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSBpZiAoaXMuZGVmaW5lZCh0aGlzLl9zY29wZVBhcnRbbmFtZV0pKSB7XG4gICAgICAgIHRoaXMuX3Njb3BlUGFydFtuYW1lXSA9IHZhbHVlO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufTtcblxuU2NvcGVOb2RlLnByb3RvdHlwZS5jcmVhdGVQcm9wZXJ0eVdpdGhWYWx1ZSA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkge1xuICAgIGlmICghaXMuZGVmaW5lZCh0aGlzLl9zY29wZVBhcnRbbmFtZV0pKSB7XG4gICAgICAgIHRoaXMuX2tleXMucHVzaChuYW1lKTtcbiAgICB9XG4gICAgdGhpcy5fc2NvcGVQYXJ0W25hbWVdID0gdmFsdWU7XG59O1xuXG5TY29wZU5vZGUucHJvdG90eXBlLmRlbGV0ZVByb3BlcnR5ID0gZnVuY3Rpb24gKG5hbWUsIGNhbkRlbGV0ZVByaXZhdGUpIHtcbiAgICBpZiAoaXMuZGVmaW5lZCh0aGlzLl9zY29wZVBhcnRbbmFtZV0pKSB7XG4gICAgICAgIGlmICh0aGlzLl9pc1ByaXZhdGUobmFtZSkpIHtcbiAgICAgICAgICAgIGlmIChjYW5EZWxldGVQcml2YXRlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fa2V5cy5zcGxpY2UoXy5pbmRleE9mKHRoaXMuX2tleXMsIG5hbWUpLCAxKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fc2NvcGVQYXJ0W25hbWVdO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fa2V5cy5zcGxpY2UoXy5pbmRleE9mKHRoaXMuX2tleXMsIG5hbWUpLCAxKTtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zY29wZVBhcnRbbmFtZV07XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59O1xuXG5TY29wZU5vZGUucHJvdG90eXBlLmVudW1lcmF0ZVByb3BlcnR5TmFtZXMgPSBmdW5jdGlvbiogKGNhbkVudW1lcmF0ZVByaXZhdGUpIHtcbiAgICBpZiAoY2FuRW51bWVyYXRlUHJpdmF0ZSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2tleXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHlpZWxkIHRoaXMuX2tleXNbaV07XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fa2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbGV0IGtleSA9IHRoaXMuX2tleXNbaV07XG4gICAgICAgICAgICBpZiAoIXRoaXMuX2lzUHJpdmF0ZShrZXkpKSB7XG4gICAgICAgICAgICAgICAgeWllbGQga2V5O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcblxuU2NvcGVOb2RlLnByb3RvdHlwZS5mb3JFYWNoUHJvcGVydHkgPSBmdW5jdGlvbiAoZikge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBmb3IgKGxldCBmbiBvZiBzZWxmLl9rZXlzKSB7XG4gICAgICAgIGYoZm4sIHNlbGYuX3Njb3BlUGFydFtmbl0pO1xuICAgIH1cbn07XG5cblNjb3BlTm9kZS5wcm90b3R5cGUuX2lzUHJpdmF0ZSA9IGZ1bmN0aW9uIChrZXkpIHtcbiAgICByZXR1cm4ga2V5WzBdID09PSBcIl9cIjtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gU2NvcGVOb2RlO1xuIl19
