"use strict";
"use strict";
var util = require("util");
var _ = require("lodash");
var is = require("../common/is");
var assert = require("assert");
function ScopeNode(instanceId, scopePart, userId) {
  assert(instanceId);
  assert(scopePart);
  this.instanceId = instanceId;
  this.userId = userId;
  this._parent = null;
  this._children = new Map();
  this._scopePart = scopePart;
  this._keys = [];
  for (var key in scopePart) {
    this._keys.push(key);
  }
}
Object.defineProperties(ScopeNode.prototype, {
  _keys: {
    value: null,
    writable: true,
    enumerable: false
  },
  scopePart: {get: function() {
      return this._scopePart;
    }},
  parent: {
    get: function() {
      return this._parent;
    },
    set: function(value) {
      if (value !== null && !(value instanceof ScopeNode)) {
        throw new TypeError("Node argument expected.");
      }
      if (this._parent !== null) {
        throw new Error("Parent already defined.");
      }
      value.addChild(this);
    }
  }
});
ScopeNode.prototype.forEachToRoot = function(f, noWalk) {
  var current = this;
  while (current) {
    if (f.call(this, current) === false) {
      return ;
    }
    if (noWalk) {
      break;
    }
    current = current._parent;
  }
};
ScopeNode.prototype.forEachChild = function(f) {
  this._children.forEach(f);
};
ScopeNode.prototype.addChild = function(childItem) {
  if (!(childItem instanceof ScopeNode)) {
    throw new TypeError("Node argument expected.");
  }
  if (childItem._parent) {
    throw new Error("Item has been already ha a parent node.");
  }
  childItem._parent = this;
  this._children.set(childItem.instanceId, childItem);
};
ScopeNode.prototype.removeChild = function(childItem) {
  if (!(childItem instanceof ScopeNode)) {
    throw new TypeError("Node argument expected.");
  }
  if (childItem._parent !== this) {
    throw new Error("Item is not a current node's child.");
  }
  childItem._parent = null;
  this._children.delete(childItem.instanceId);
};
ScopeNode.prototype.clearChildren = function() {
  this._children.clear();
};
ScopeNode.prototype.isPropertyExists = function(name) {
  return is.defined(this._scopePart[name]);
};
ScopeNode.prototype.getPropertyValue = function(name, canReturnPrivate) {
  if (canReturnPrivate) {
    return this._scopePart[name];
  } else if (!this._isPrivate(name)) {
    return this._scopePart[name];
  }
};
ScopeNode.prototype.setPropertyValue = function(name, value, canSetPrivate) {
  if (this._isPrivate(name)) {
    if (canSetPrivate) {
      if (!is.defined(this._scopePart[name])) {
        this._keys.push(name);
      }
      this._scopePart[name] = value;
      return true;
    }
  } else if (is.defined(this._scopePart[name])) {
    this._scopePart[name] = value;
    return true;
  }
  return false;
};
ScopeNode.prototype.createPropertyWithValue = function(name, value) {
  if (!is.defined(this._scopePart[name])) {
    this._keys.push(name);
  }
  this._scopePart[name] = value;
};
ScopeNode.prototype.deleteProperty = function(name, canDeletePrivate) {
  if (is.defined(this._scopePart[name])) {
    if (this._isPrivate(name)) {
      if (canDeletePrivate) {
        this._keys.splice(_.indexOf(this._keys, name), 1);
        delete this._scopePart[name];
        return true;
      }
    } else {
      this._keys.splice(_.indexOf(this._keys, name), 1);
      delete this._scopePart[name];
      return true;
    }
  }
  return false;
};
ScopeNode.prototype.enumeratePropertyNames = $traceurRuntime.initGeneratorFunction(function $__8(canEnumeratePrivate) {
  var i,
      i$__7,
      key;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          $ctx.state = (canEnumeratePrivate) ? 6 : 16;
          break;
        case 6:
          i = 0;
          $ctx.state = 7;
          break;
        case 7:
          $ctx.state = (i < this._keys.length) ? 1 : -2;
          break;
        case 4:
          i++;
          $ctx.state = 7;
          break;
        case 1:
          $ctx.state = 2;
          return this._keys[i];
        case 2:
          $ctx.maybeThrow();
          $ctx.state = 4;
          break;
        case 16:
          i$__7 = 0;
          $ctx.state = 17;
          break;
        case 17:
          $ctx.state = (i$__7 < this._keys.length) ? 13 : -2;
          break;
        case 11:
          i$__7++;
          $ctx.state = 17;
          break;
        case 13:
          key = this._keys[i$__7];
          $ctx.state = 14;
          break;
        case 14:
          $ctx.state = (!this._isPrivate(key)) ? 8 : 11;
          break;
        case 8:
          $ctx.state = 9;
          return key;
        case 9:
          $ctx.maybeThrow();
          $ctx.state = 11;
          break;
        default:
          return $ctx.end();
      }
  }, $__8, this);
});
ScopeNode.prototype.forEachProperty = function(f) {
  var self = this;
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (self._keys)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var fn = $__1.value;
      {
        f(fn, self._scopePart[fn]);
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
};
ScopeNode.prototype._isPrivate = function(key) {
  return key[0] === "_";
};
module.exports = ScopeNode;
//# sourceMappingURL=data:application/json;base64,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QyxDQUNyRCxFQUFDLENBQUMsTUFBb0IsQ0FBQSxDQUFDLE1BQW9CLENBQUEsU0FBcUIsQUFBQyxFQUFDLENBQUMsS0FBSyxDQUFDLENBQ3pFLE9BQW9CLEtBQUcsQ0FBRztRQStKMUIsR0FBQztBQUFpQjtBQUN2QixRQUFBLEFBQUMsQ0FBQyxFQUFDLENBQUcsQ0FBQSxJQUFHLFdBQVcsQ0FBRSxFQUFDLENBQUMsQ0FBQyxDQUFDO01BQzlCO0lBOUpJO0FBQUEsRUFGQSxDQUFFLFlBQTBCO0FBQzFCLFNBQW9CLEtBQUcsQ0FBQztBQUN4QixjQUFvQyxDQUFDO0VBQ3ZDLENBQUUsT0FBUTtBQUNSLE1BQUk7QUFDRixTQUFJLEtBQWlCLEdBQUssQ0FBQSxXQUF1QixHQUFLLEtBQUcsQ0FBRztBQUMxRCxrQkFBd0IsQUFBQyxFQUFDLENBQUM7TUFDN0I7QUFBQSxJQUNGLENBQUUsT0FBUTtBQUNSLGNBQXdCO0FBQ3RCLGtCQUF3QjtNQUMxQjtBQUFBLElBQ0Y7QUFBQSxFQUNGO0FBQUEsQUFvSlIsQ0FBQztBQUVELFFBQVEsVUFBVSxXQUFXLEVBQUksVUFBVSxHQUFFLENBQUc7QUFDNUMsT0FBTyxDQUFBLEdBQUUsQ0FBRSxDQUFBLENBQUMsSUFBTSxJQUFFLENBQUM7QUFDekIsQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLFVBQVEsQ0FBQztBQUMxQiIsImZpbGUiOiJhY3Rpdml0aWVzL3Njb3BlTm9kZS5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgaXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2lzXCIpO1xubGV0IGFzc2VydCA9IHJlcXVpcmUoXCJhc3NlcnRcIik7XG5cbmZ1bmN0aW9uIFNjb3BlTm9kZShpbnN0YW5jZUlkLCBzY29wZVBhcnQsIHVzZXJJZCkge1xuICAgIGFzc2VydChpbnN0YW5jZUlkKTtcbiAgICBhc3NlcnQoc2NvcGVQYXJ0KTtcbiAgICB0aGlzLmluc3RhbmNlSWQgPSBpbnN0YW5jZUlkO1xuICAgIHRoaXMudXNlcklkID0gdXNlcklkO1xuICAgIHRoaXMuX3BhcmVudCA9IG51bGw7XG4gICAgdGhpcy5fY2hpbGRyZW4gPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5fc2NvcGVQYXJ0ID0gc2NvcGVQYXJ0O1xuICAgIHRoaXMuX2tleXMgPSBbXTtcbiAgICBmb3IgKGxldCBrZXkgaW4gc2NvcGVQYXJ0KSB7XG4gICAgICAgIHRoaXMuX2tleXMucHVzaChrZXkpO1xuICAgIH1cbn1cblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoU2NvcGVOb2RlLnByb3RvdHlwZSwge1xuICAgIF9rZXlzOiB7XG4gICAgICAgIHZhbHVlOiBudWxsLFxuICAgICAgICB3cml0YWJsZTogdHJ1ZSxcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2VcbiAgICB9LFxuICAgIHNjb3BlUGFydDoge1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Njb3BlUGFydDtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgcGFyZW50OiB7XG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcmVudDtcbiAgICAgICAgfSxcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiAhKHZhbHVlIGluc3RhbmNlb2YgU2NvcGVOb2RlKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJOb2RlIGFyZ3VtZW50IGV4cGVjdGVkLlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJlbnQgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQYXJlbnQgYWxyZWFkeSBkZWZpbmVkLlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhbHVlLmFkZENoaWxkKHRoaXMpO1xuICAgICAgICB9XG4gICAgfVxufSk7XG5cblNjb3BlTm9kZS5wcm90b3R5cGUuZm9yRWFjaFRvUm9vdCA9IGZ1bmN0aW9uIChmLCBub1dhbGspIHtcbiAgICBsZXQgY3VycmVudCA9IHRoaXM7XG4gICAgd2hpbGUgKGN1cnJlbnQpIHtcbiAgICAgICAgaWYgKGYuY2FsbCh0aGlzLCBjdXJyZW50KSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAobm9XYWxrKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjdXJyZW50ID0gY3VycmVudC5fcGFyZW50O1xuICAgIH1cbn07XG5cblNjb3BlTm9kZS5wcm90b3R5cGUuZm9yRWFjaENoaWxkID0gZnVuY3Rpb24gKGYpIHtcbiAgICB0aGlzLl9jaGlsZHJlbi5mb3JFYWNoKGYpO1xufTtcblxuU2NvcGVOb2RlLnByb3RvdHlwZS5hZGRDaGlsZCA9IGZ1bmN0aW9uIChjaGlsZEl0ZW0pIHtcbiAgICBpZiAoIShjaGlsZEl0ZW0gaW5zdGFuY2VvZiBTY29wZU5vZGUpKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJOb2RlIGFyZ3VtZW50IGV4cGVjdGVkLlwiKTtcbiAgICB9XG4gICAgaWYgKGNoaWxkSXRlbS5fcGFyZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkl0ZW0gaGFzIGJlZW4gYWxyZWFkeSBoYSBhIHBhcmVudCBub2RlLlwiKTtcbiAgICB9XG4gICAgY2hpbGRJdGVtLl9wYXJlbnQgPSB0aGlzO1xuICAgIHRoaXMuX2NoaWxkcmVuLnNldChjaGlsZEl0ZW0uaW5zdGFuY2VJZCwgY2hpbGRJdGVtKTtcbn07XG5cblNjb3BlTm9kZS5wcm90b3R5cGUucmVtb3ZlQ2hpbGQgPSBmdW5jdGlvbiAoY2hpbGRJdGVtKSB7XG4gICAgaWYgKCEoY2hpbGRJdGVtIGluc3RhbmNlb2YgU2NvcGVOb2RlKSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiTm9kZSBhcmd1bWVudCBleHBlY3RlZC5cIik7XG4gICAgfVxuICAgIGlmIChjaGlsZEl0ZW0uX3BhcmVudCAhPT0gdGhpcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJdGVtIGlzIG5vdCBhIGN1cnJlbnQgbm9kZSdzIGNoaWxkLlwiKTtcbiAgICB9XG4gICAgY2hpbGRJdGVtLl9wYXJlbnQgPSBudWxsO1xuICAgIHRoaXMuX2NoaWxkcmVuLmRlbGV0ZShjaGlsZEl0ZW0uaW5zdGFuY2VJZCk7XG59O1xuXG5TY29wZU5vZGUucHJvdG90eXBlLmNsZWFyQ2hpbGRyZW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5fY2hpbGRyZW4uY2xlYXIoKTtcbn07XG5cblNjb3BlTm9kZS5wcm90b3R5cGUuaXNQcm9wZXJ0eUV4aXN0cyA9IGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgcmV0dXJuIGlzLmRlZmluZWQodGhpcy5fc2NvcGVQYXJ0W25hbWVdKTtcbn07XG5cblNjb3BlTm9kZS5wcm90b3R5cGUuZ2V0UHJvcGVydHlWYWx1ZSA9IGZ1bmN0aW9uIChuYW1lLCBjYW5SZXR1cm5Qcml2YXRlKSB7XG4gICAgaWYgKGNhblJldHVyblByaXZhdGUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Njb3BlUGFydFtuYW1lXTtcbiAgICB9XG4gICAgZWxzZSBpZiAoIXRoaXMuX2lzUHJpdmF0ZShuYW1lKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2NvcGVQYXJ0W25hbWVdO1xuICAgIH1cbn07XG5cblNjb3BlTm9kZS5wcm90b3R5cGUuc2V0UHJvcGVydHlWYWx1ZSA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSwgY2FuU2V0UHJpdmF0ZSkge1xuICAgIGlmICh0aGlzLl9pc1ByaXZhdGUobmFtZSkpIHtcbiAgICAgICAgaWYgKGNhblNldFByaXZhdGUpIHtcbiAgICAgICAgICAgIGlmICghaXMuZGVmaW5lZCh0aGlzLl9zY29wZVBhcnRbbmFtZV0pKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fa2V5cy5wdXNoKG5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fc2NvcGVQYXJ0W25hbWVdID0gdmFsdWU7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIGlmIChpcy5kZWZpbmVkKHRoaXMuX3Njb3BlUGFydFtuYW1lXSkpIHtcbiAgICAgICAgdGhpcy5fc2NvcGVQYXJ0W25hbWVdID0gdmFsdWU7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59O1xuXG5TY29wZU5vZGUucHJvdG90eXBlLmNyZWF0ZVByb3BlcnR5V2l0aFZhbHVlID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7XG4gICAgaWYgKCFpcy5kZWZpbmVkKHRoaXMuX3Njb3BlUGFydFtuYW1lXSkpIHtcbiAgICAgICAgdGhpcy5fa2V5cy5wdXNoKG5hbWUpO1xuICAgIH1cbiAgICB0aGlzLl9zY29wZVBhcnRbbmFtZV0gPSB2YWx1ZTtcbn07XG5cblNjb3BlTm9kZS5wcm90b3R5cGUuZGVsZXRlUHJvcGVydHkgPSBmdW5jdGlvbiAobmFtZSwgY2FuRGVsZXRlUHJpdmF0ZSkge1xuICAgIGlmIChpcy5kZWZpbmVkKHRoaXMuX3Njb3BlUGFydFtuYW1lXSkpIHtcbiAgICAgICAgaWYgKHRoaXMuX2lzUHJpdmF0ZShuYW1lKSkge1xuICAgICAgICAgICAgaWYgKGNhbkRlbGV0ZVByaXZhdGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9rZXlzLnNwbGljZShfLmluZGV4T2YodGhpcy5fa2V5cywgbmFtZSksIDEpO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zY29wZVBhcnRbbmFtZV07XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9rZXlzLnNwbGljZShfLmluZGV4T2YodGhpcy5fa2V5cywgbmFtZSksIDEpO1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3Njb3BlUGFydFtuYW1lXTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn07XG5cblNjb3BlTm9kZS5wcm90b3R5cGUuZW51bWVyYXRlUHJvcGVydHlOYW1lcyA9IGZ1bmN0aW9uKiAoY2FuRW51bWVyYXRlUHJpdmF0ZSkge1xuICAgIGlmIChjYW5FbnVtZXJhdGVQcml2YXRlKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fa2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgeWllbGQgdGhpcy5fa2V5c1tpXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9rZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBsZXQga2V5ID0gdGhpcy5fa2V5c1tpXTtcbiAgICAgICAgICAgIGlmICghdGhpcy5faXNQcml2YXRlKGtleSkpIHtcbiAgICAgICAgICAgICAgICB5aWVsZCBrZXk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG5TY29wZU5vZGUucHJvdG90eXBlLmZvckVhY2hQcm9wZXJ0eSA9IGZ1bmN0aW9uIChmKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIGZvciAobGV0IGZuIG9mIHNlbGYuX2tleXMpIHtcbiAgICAgICAgZihmbiwgc2VsZi5fc2NvcGVQYXJ0W2ZuXSk7XG4gICAgfVxufTtcblxuU2NvcGVOb2RlLnByb3RvdHlwZS5faXNQcml2YXRlID0gZnVuY3Rpb24gKGtleSkge1xuICAgIHJldHVybiBrZXlbMF0gPT09IFwiX1wiO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBTY29wZU5vZGU7XG4iXX0=
