"use strict";
var util = require("util");
var _ = require("lodash");
var StrMap = require("backpack-node").collections.StrMap;
var is = require("../common/is");
var fast = require("fast.js");
function ScopeNode(id, scopePart) {
  this.id = id;
  this._parent = null;
  this._children = new StrMap();
  this._scopePart = scopePart;
  this._keys = [];
  for (var key in scopePart)
    this._keys.push(key);
}
Object.defineProperties(ScopeNode.prototype, {
  _keys: {
    value: null,
    writable: true,
    enumerable: false
  },
  parent: {
    get: function() {
      return this._parent;
    },
    set: function(value) {
      if (value !== null && !(value instanceof ScopeNode))
        throw new TypeError("Node argument expected.");
      if (this._parent !== null)
        throw new Error("Parent already defined.");
      value.addChild(this);
    }
  }
});
ScopeNode.prototype.forEachToRoot = function(f) {
  var current = this;
  while (current) {
    if (f.call(this, current) === false)
      return ;
    current = current._parent;
  }
};
ScopeNode.prototype.forEachChild = function(f) {
  this._children.forEachValue(f);
};
ScopeNode.prototype.addChild = function(childItem) {
  if (!(childItem instanceof ScopeNode))
    throw new TypeError("Node argument expected.");
  if (childItem._parent)
    throw new Error("Item has been already ha a parent node.");
  childItem._parent = this;
  this._children.add(childItem.id, childItem);
};
ScopeNode.prototype.removeChild = function(childItem) {
  if (!(childItem instanceof ScopeNode))
    throw new TypeError("Node argument expected.");
  if (childItem._parent !== this)
    throw new Error("Item is not a current node's child.");
  childItem._parent = null;
  this._children.remove(childItem.id);
};
ScopeNode.prototype.clearChildren = function() {
  this._children.clear();
};
ScopeNode.prototype.isPropertyExists = function(name) {
  return is.defined(this._scopePart[name]);
};
ScopeNode.prototype.getPropertyValue = function(name, canReturnPrivate) {
  if (canReturnPrivate) {
    return this._scopePart[name];
  } else if (!this._isPrivate(name)) {
    return this._scopePart[name];
  }
};
ScopeNode.prototype.setPropertyValue = function(name, value, canSetPrivate) {
  if (this._isPrivate(name)) {
    if (canSetPrivate) {
      if (!is.defined(this._scopePart[name]))
        this._keys.push(name);
      this._scopePart[name] = value;
      return true;
    }
  } else if (is.defined(this._scopePart[name])) {
    this._scopePart[name] = value;
    return true;
  }
  return false;
};
ScopeNode.prototype.createPropertyWithValue = function(name, value) {
  if (!is.defined(this._scopePart[name]))
    this._keys.push(name);
  this._scopePart[name] = value;
};
ScopeNode.prototype.deleteProperty = function(name, canDeletePrivate) {
  if (is.defined(this._scopePart[name])) {
    if (this._isPrivate(name)) {
      if (canDeletePrivate) {
        this._keys.splice(fast.indexOf(this._keys, name), 1);
        delete this._scopePart[name];
        return true;
      }
    } else {
      this._keys.splice(fast.indexOf(this._keys, name), 1);
      delete this._scopePart[name];
      return true;
    }
  }
  return false;
};
ScopeNode.prototype.enumeratePropertyNames = $traceurRuntime.initGeneratorFunction(function $__0(canEnumeratePrivate) {
  var i,
      key;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          $ctx.state = (canEnumeratePrivate) ? 6 : 16;
          break;
        case 6:
          i = 0;
          $ctx.state = 7;
          break;
        case 7:
          $ctx.state = (i < this._keys.length) ? 1 : -2;
          break;
        case 4:
          i++;
          $ctx.state = 7;
          break;
        case 1:
          $ctx.state = 2;
          return this._keys[i];
        case 2:
          $ctx.maybeThrow();
          $ctx.state = 4;
          break;
        case 16:
          i = 0;
          $ctx.state = 17;
          break;
        case 17:
          $ctx.state = (i < this._keys.length) ? 13 : -2;
          break;
        case 11:
          i++;
          $ctx.state = 17;
          break;
        case 13:
          key = this._keys[i];
          $ctx.state = 14;
          break;
        case 14:
          $ctx.state = (!this._isPrivate(key)) ? 8 : 11;
          break;
        case 8:
          $ctx.state = 9;
          return key;
        case 9:
          $ctx.maybeThrow();
          $ctx.state = 11;
          break;
        default:
          return $ctx.end();
      }
  }, $__0, this);
});
ScopeNode.prototype.forEachProperty = function(f) {
  var self = this;
  fast.forEach(self._keys, function(fn) {
    f(fn, self._scopePart[fn]);
  });
};
ScopeNode.prototype._isPrivate = function(key) {
  return key[0] === "_";
};
module.exports = ScopeNode;
//# sourceMappingURL=data:application/json;base64,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QXdIbUMsVUFBQSxFQUFFOzs7O2NBQzNCLENBQUEsSUFBRyxNQUFNLENBQUUsQ0FBQSxDQUFDOzs7O0FBMUhsQyxhQUFHLE1BQU0sRUFBSSxDQUFBLENBMkhHLENBQUMsSUFBRyxXQUFXLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0EzSEwsU0FBd0MsQ0FBQztBQUNoRSxlQUFJOzs7QUFEWixlQTJINkMsSUFBRSxDQTNIeEI7O0FBQXZCLGFBQUcsV0FBVyxBQUFDLEVBQUMsQ0FBQTs7OztBQUFoQixlQUFPLENBQUEsSUFBRyxJQUFJLEFBQUMsRUFBQyxDQUFBOztBQUNtQixFQUMvQixPQUE2QixLQUFHLENBQUMsQ0FBQztBQTRIdEMsQ0E5SHVELEFBOEh2RCxDQUFBO0FBRUEsUUFBUSxVQUFVLGdCQUFnQixFQUFJLFVBQVUsQ0FBQSxDQUFHO0FBQy9DLEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixLQUFHLFFBQVEsQUFBQyxDQUFDLElBQUcsTUFBTSxDQUFHLFVBQVUsRUFBQyxDQUFHO0FBQ25DLElBQUEsQUFBQyxDQUFDLEVBQUMsQ0FBRyxDQUFBLElBQUcsV0FBVyxDQUFFLEVBQUMsQ0FBQyxDQUFDLENBQUM7RUFDOUIsQ0FBQyxDQUFDO0FBQ04sQ0FBQTtBQUVBLFFBQVEsVUFBVSxXQUFXLEVBQUksVUFBVSxHQUFFLENBQUc7QUFDNUMsT0FBTyxDQUFBLEdBQUUsQ0FBRSxDQUFBLENBQUMsSUFBTSxJQUFFLENBQUM7QUFDekIsQ0FBQTtBQUVBLEtBQUssUUFBUSxFQUFJLFVBQVEsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvc2NvcGVOb2RlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xyXG52YXIgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XHJcbnZhciBTdHJNYXAgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5jb2xsZWN0aW9ucy5TdHJNYXA7XHJcbnZhciBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XHJcbnZhciBmYXN0ID0gcmVxdWlyZShcImZhc3QuanNcIik7XHJcblxyXG5mdW5jdGlvbiBTY29wZU5vZGUoaWQsIHNjb3BlUGFydCkge1xyXG4gICAgdGhpcy5pZCA9IGlkO1xyXG4gICAgdGhpcy5fcGFyZW50ID0gbnVsbDtcclxuICAgIHRoaXMuX2NoaWxkcmVuID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgdGhpcy5fc2NvcGVQYXJ0ID0gc2NvcGVQYXJ0O1xyXG4gICAgdGhpcy5fa2V5cyA9IFtdO1xyXG4gICAgZm9yICh2YXIga2V5IGluIHNjb3BlUGFydCkgdGhpcy5fa2V5cy5wdXNoKGtleSk7XHJcbn1cclxuXHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFNjb3BlTm9kZS5wcm90b3R5cGUsIHtcclxuICAgIF9rZXlzOiB7XHJcbiAgICAgICAgdmFsdWU6IG51bGwsXHJcbiAgICAgICAgd3JpdGFibGU6IHRydWUsXHJcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2VcclxuICAgIH0sXHJcbiAgICBwYXJlbnQ6IHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcmVudDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiAhKHZhbHVlIGluc3RhbmNlb2YgU2NvcGVOb2RlKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIk5vZGUgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fcGFyZW50ICE9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoXCJQYXJlbnQgYWxyZWFkeSBkZWZpbmVkLlwiKTtcclxuICAgICAgICAgICAgdmFsdWUuYWRkQ2hpbGQodGhpcyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59KTtcclxuXHJcblNjb3BlTm9kZS5wcm90b3R5cGUuZm9yRWFjaFRvUm9vdCA9IGZ1bmN0aW9uIChmKSB7XHJcbiAgICB2YXIgY3VycmVudCA9IHRoaXM7XHJcbiAgICB3aGlsZSAoY3VycmVudCkge1xyXG4gICAgICAgIGlmIChmLmNhbGwodGhpcywgY3VycmVudCkgPT09IGZhbHNlKSByZXR1cm47XHJcbiAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuX3BhcmVudDtcclxuICAgIH1cclxufVxyXG5cclxuU2NvcGVOb2RlLnByb3RvdHlwZS5mb3JFYWNoQ2hpbGQgPSBmdW5jdGlvbiAoZikge1xyXG4gICAgdGhpcy5fY2hpbGRyZW4uZm9yRWFjaFZhbHVlKGYpO1xyXG59XHJcblxyXG5TY29wZU5vZGUucHJvdG90eXBlLmFkZENoaWxkID0gZnVuY3Rpb24gKGNoaWxkSXRlbSkge1xyXG4gICAgaWYgKCEoY2hpbGRJdGVtIGluc3RhbmNlb2YgU2NvcGVOb2RlKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIk5vZGUgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xyXG4gICAgaWYgKGNoaWxkSXRlbS5fcGFyZW50KSB0aHJvdyBuZXcgRXJyb3IoXCJJdGVtIGhhcyBiZWVuIGFscmVhZHkgaGEgYSBwYXJlbnQgbm9kZS5cIik7XHJcbiAgICBjaGlsZEl0ZW0uX3BhcmVudCA9IHRoaXM7XHJcbiAgICB0aGlzLl9jaGlsZHJlbi5hZGQoY2hpbGRJdGVtLmlkLCBjaGlsZEl0ZW0pO1xyXG59XHJcblxyXG5TY29wZU5vZGUucHJvdG90eXBlLnJlbW92ZUNoaWxkID0gZnVuY3Rpb24gKGNoaWxkSXRlbSkge1xyXG4gICAgaWYgKCEoY2hpbGRJdGVtIGluc3RhbmNlb2YgU2NvcGVOb2RlKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIk5vZGUgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xyXG4gICAgaWYgKGNoaWxkSXRlbS5fcGFyZW50ICE9PSB0aGlzKSB0aHJvdyBuZXcgRXJyb3IoXCJJdGVtIGlzIG5vdCBhIGN1cnJlbnQgbm9kZSdzIGNoaWxkLlwiKTtcclxuICAgIGNoaWxkSXRlbS5fcGFyZW50ID0gbnVsbDtcclxuICAgIHRoaXMuX2NoaWxkcmVuLnJlbW92ZShjaGlsZEl0ZW0uaWQpO1xyXG59XHJcblxyXG5TY29wZU5vZGUucHJvdG90eXBlLmNsZWFyQ2hpbGRyZW4gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB0aGlzLl9jaGlsZHJlbi5jbGVhcigpO1xyXG59XHJcblxyXG5TY29wZU5vZGUucHJvdG90eXBlLmlzUHJvcGVydHlFeGlzdHMgPSBmdW5jdGlvbiAobmFtZSkge1xyXG4gICAgcmV0dXJuIGlzLmRlZmluZWQodGhpcy5fc2NvcGVQYXJ0W25hbWVdKTtcclxufVxyXG5cclxuU2NvcGVOb2RlLnByb3RvdHlwZS5nZXRQcm9wZXJ0eVZhbHVlID0gZnVuY3Rpb24gKG5hbWUsIGNhblJldHVyblByaXZhdGUpIHtcclxuICAgIGlmIChjYW5SZXR1cm5Qcml2YXRlKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Njb3BlUGFydFtuYW1lXTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKCF0aGlzLl9pc1ByaXZhdGUobmFtZSkpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc2NvcGVQYXJ0W25hbWVdO1xyXG4gICAgfVxyXG59XHJcblxyXG5TY29wZU5vZGUucHJvdG90eXBlLnNldFByb3BlcnR5VmFsdWUgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUsIGNhblNldFByaXZhdGUpIHtcclxuICAgIGlmICh0aGlzLl9pc1ByaXZhdGUobmFtZSkpIHtcclxuICAgICAgICBpZiAoY2FuU2V0UHJpdmF0ZSkge1xyXG4gICAgICAgICAgICBpZiAoIWlzLmRlZmluZWQodGhpcy5fc2NvcGVQYXJ0W25hbWVdKSkgdGhpcy5fa2V5cy5wdXNoKG5hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLl9zY29wZVBhcnRbbmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoaXMuZGVmaW5lZCh0aGlzLl9zY29wZVBhcnRbbmFtZV0pKSB7XHJcbiAgICAgICAgdGhpcy5fc2NvcGVQYXJ0W25hbWVdID0gdmFsdWU7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbn1cclxuXHJcblNjb3BlTm9kZS5wcm90b3R5cGUuY3JlYXRlUHJvcGVydHlXaXRoVmFsdWUgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHtcclxuICAgIGlmICghaXMuZGVmaW5lZCh0aGlzLl9zY29wZVBhcnRbbmFtZV0pKSB0aGlzLl9rZXlzLnB1c2gobmFtZSk7XHJcbiAgICB0aGlzLl9zY29wZVBhcnRbbmFtZV0gPSB2YWx1ZTtcclxufVxyXG5cclxuU2NvcGVOb2RlLnByb3RvdHlwZS5kZWxldGVQcm9wZXJ0eSA9IGZ1bmN0aW9uIChuYW1lLCBjYW5EZWxldGVQcml2YXRlKSB7XHJcbiAgICBpZiAoaXMuZGVmaW5lZCh0aGlzLl9zY29wZVBhcnRbbmFtZV0pKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2lzUHJpdmF0ZShuYW1lKSkge1xyXG4gICAgICAgICAgICBpZiAoY2FuRGVsZXRlUHJpdmF0ZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fa2V5cy5zcGxpY2UoZmFzdC5pbmRleE9mKHRoaXMuX2tleXMsIG5hbWUpLCAxKTtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zY29wZVBhcnRbbmFtZV07XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5fa2V5cy5zcGxpY2UoZmFzdC5pbmRleE9mKHRoaXMuX2tleXMsIG5hbWUpLCAxKTtcclxuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3Njb3BlUGFydFtuYW1lXTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG5TY29wZU5vZGUucHJvdG90eXBlLmVudW1lcmF0ZVByb3BlcnR5TmFtZXMgPSBmdW5jdGlvbiogKGNhbkVudW1lcmF0ZVByaXZhdGUpIHtcclxuICAgIGlmIChjYW5FbnVtZXJhdGVQcml2YXRlKSB7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9rZXlzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRoaXMuX2tleXNbaV07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9rZXlzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBrZXkgPSB0aGlzLl9rZXlzW2ldO1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuX2lzUHJpdmF0ZShrZXkpKSB5aWVsZCBrZXk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5TY29wZU5vZGUucHJvdG90eXBlLmZvckVhY2hQcm9wZXJ0eSA9IGZ1bmN0aW9uIChmKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICBmYXN0LmZvckVhY2goc2VsZi5fa2V5cywgZnVuY3Rpb24gKGZuKSB7XHJcbiAgICAgICAgZihmbiwgc2VsZi5fc2NvcGVQYXJ0W2ZuXSk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuU2NvcGVOb2RlLnByb3RvdHlwZS5faXNQcml2YXRlID0gZnVuY3Rpb24gKGtleSkge1xyXG4gICAgcmV0dXJuIGtleVswXSA9PT0gXCJfXCI7XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0gU2NvcGVOb2RlOyJdfQ==
