"use strict";
var Activity = require("./activity");
var util = require("util");
var guids = require("../common/guids");
var Declarator = require("./declarator");
var is = require("../common/is");
var _ = require("lodash");
var activityMarkup = require("./activityMarkup");
function Composite() {
  Declarator.call(this);
  this[guids.types.composite] = true;
  this.reservedProperties.add("_implementation");
  this.nonSerializedProperties.add("_implementation");
  this.nonScopedProperties.add("createImplementation");
  this.nonScopedProperties.add("ensureImplementationCreated");
  this.nonScopedProperties.add(guids.types.composite);
}
util.inherits(Composite, Declarator);
Composite.prototype.forEachImmediateChild = function(f) {
  this.ensureImplementationCreated();
  Declarator.prototype.forEachImmediateChild.call(this, f);
};
Composite.prototype._forEach = function(f, visited, except) {
  this.ensureImplementationCreated();
  Declarator.prototype._forEach.call(this, f, visited, except);
};
Composite.prototype.createImplementation = function() {
  throw new Error("Method 'createImplementation' not implemented.");
};
Composite.prototype.ensureImplementationCreated = function() {
  if (is.undefined(this._implementation)) {
    this._implementation = this.createImplementation();
    if (_.isPlainObject(this._implementation))
      this._implementation = activityMarkup.parse(this._implementation);
    if (!(this._implementation instanceof Activity))
      throw new Error("Method 'createImplementation' must return an activity.");
  }
};
Composite.prototype.run = function(callContext, args) {
  if (!(this.get("_implementation") instanceof Activity))
    throw new Error("Composite activity's implementation is not available.");
  Declarator.prototype.run.call(this, callContext, args);
};
Composite.prototype.varsDeclared = function(callContext, args) {
  callContext.schedule(this.get("_implementation"), "_implInvoked");
};
Composite.prototype._implInvoked = function(callContext, reason, result) {
  callContext.end(reason, result);
};
module.exports = Composite;
//# sourceMappingURL=data:application/json;base64,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QUFBLEFBQ0osQ0FBQTtBQUVBLFFBQVEsVUFBVSxJQUFJLEVBQUksVUFBVSxXQUFVLENBQUcsQ0FBQSxJQUFHLENBQUc7QUFDbkQsS0FBSSxDQUFDLENBQUMsSUFBRyxJQUFJLEFBQUMsQ0FBQyxpQkFBZ0IsQ0FBQyxDQUFBLFVBQWEsU0FBTyxDQUFDO0FBQUcsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLHVEQUFzRCxDQUFDLENBQUM7QUFBQSxBQUNoSSxXQUFTLFVBQVUsSUFBSSxLQUFLLEFBQUMsQ0FBQyxJQUFHLENBQUcsWUFBVSxDQUFHLEtBQUcsQ0FBQyxDQUFDO0FBQzFELENBQUE7QUFFQSxRQUFRLFVBQVUsYUFBYSxFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsSUFBRyxDQUFHO0FBQzVELFlBQVUsU0FBUyxBQUFDLENBQUMsSUFBRyxJQUFJLEFBQUMsQ0FBQyxpQkFBZ0IsQ0FBQyxDQUFHLGVBQWEsQ0FBQyxDQUFDO0FBQ3JFLENBQUE7QUFFQSxRQUFRLFVBQVUsYUFBYSxFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQ3RFLFlBQVUsSUFBSSxBQUFDLENBQUMsTUFBSyxDQUFHLE9BQUssQ0FBQyxDQUFDO0FBQ25DLENBQUE7QUFFQSxLQUFLLFFBQVEsRUFBSSxVQUFRLENBQUM7QUFBQSIsImZpbGUiOiJhY3Rpdml0aWVzL2NvbXBvc2l0ZS5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsidmFyIEFjdGl2aXR5ID0gcmVxdWlyZShcIi4vYWN0aXZpdHlcIik7XG52YXIgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xudmFyIGd1aWRzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9ndWlkc1wiKTtcbnZhciBEZWNsYXJhdG9yID0gcmVxdWlyZShcIi4vZGVjbGFyYXRvclwiKTtcbnZhciBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XG52YXIgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG52YXIgYWN0aXZpdHlNYXJrdXAgPSByZXF1aXJlKFwiLi9hY3Rpdml0eU1hcmt1cFwiKTtcblxuZnVuY3Rpb24gQ29tcG9zaXRlKCkge1xuICAgIERlY2xhcmF0b3IuY2FsbCh0aGlzKTtcbiAgICB0aGlzW2d1aWRzLnR5cGVzLmNvbXBvc2l0ZV0gPSB0cnVlO1xuICAgIHRoaXMucmVzZXJ2ZWRQcm9wZXJ0aWVzLmFkZChcIl9pbXBsZW1lbnRhdGlvblwiKTtcbiAgICB0aGlzLm5vblNlcmlhbGl6ZWRQcm9wZXJ0aWVzLmFkZChcIl9pbXBsZW1lbnRhdGlvblwiKTtcbiAgICB0aGlzLm5vblNjb3BlZFByb3BlcnRpZXMuYWRkKFwiY3JlYXRlSW1wbGVtZW50YXRpb25cIik7XG4gICAgdGhpcy5ub25TY29wZWRQcm9wZXJ0aWVzLmFkZChcImVuc3VyZUltcGxlbWVudGF0aW9uQ3JlYXRlZFwiKTtcbiAgICB0aGlzLm5vblNjb3BlZFByb3BlcnRpZXMuYWRkKGd1aWRzLnR5cGVzLmNvbXBvc2l0ZSk7XG59XG5cbnV0aWwuaW5oZXJpdHMoQ29tcG9zaXRlLCBEZWNsYXJhdG9yKTtcblxuQ29tcG9zaXRlLnByb3RvdHlwZS5mb3JFYWNoSW1tZWRpYXRlQ2hpbGQgPSBmdW5jdGlvbiAoZikge1xuICAgIHRoaXMuZW5zdXJlSW1wbGVtZW50YXRpb25DcmVhdGVkKCk7XG4gICAgRGVjbGFyYXRvci5wcm90b3R5cGUuZm9yRWFjaEltbWVkaWF0ZUNoaWxkLmNhbGwodGhpcywgZik7XG59XG5cbkNvbXBvc2l0ZS5wcm90b3R5cGUuX2ZvckVhY2ggPSBmdW5jdGlvbiAoZiwgdmlzaXRlZCwgZXhjZXB0KSB7XG4gICAgdGhpcy5lbnN1cmVJbXBsZW1lbnRhdGlvbkNyZWF0ZWQoKTtcbiAgICBEZWNsYXJhdG9yLnByb3RvdHlwZS5fZm9yRWFjaC5jYWxsKHRoaXMsIGYsIHZpc2l0ZWQsIGV4Y2VwdCk7XG59XG5cbkNvbXBvc2l0ZS5wcm90b3R5cGUuY3JlYXRlSW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kICdjcmVhdGVJbXBsZW1lbnRhdGlvbicgbm90IGltcGxlbWVudGVkLlwiKTtcbn1cblxuQ29tcG9zaXRlLnByb3RvdHlwZS5lbnN1cmVJbXBsZW1lbnRhdGlvbkNyZWF0ZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKGlzLnVuZGVmaW5lZCh0aGlzLl9pbXBsZW1lbnRhdGlvbikpIHtcbiAgICAgICAgdGhpcy5faW1wbGVtZW50YXRpb24gPSB0aGlzLmNyZWF0ZUltcGxlbWVudGF0aW9uKCk7XG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QodGhpcy5faW1wbGVtZW50YXRpb24pKSB0aGlzLl9pbXBsZW1lbnRhdGlvbiA9IGFjdGl2aXR5TWFya3VwLnBhcnNlKHRoaXMuX2ltcGxlbWVudGF0aW9uKTtcbiAgICAgICAgaWYgKCEodGhpcy5faW1wbGVtZW50YXRpb24gaW5zdGFuY2VvZiBBY3Rpdml0eSkpIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCAnY3JlYXRlSW1wbGVtZW50YXRpb24nIG11c3QgcmV0dXJuIGFuIGFjdGl2aXR5LlwiKTtcbiAgICB9XG59XG5cbkNvbXBvc2l0ZS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBhcmdzKSB7XG4gICAgaWYgKCEodGhpcy5nZXQoXCJfaW1wbGVtZW50YXRpb25cIikgaW5zdGFuY2VvZiBBY3Rpdml0eSkpIHRocm93IG5ldyBFcnJvcihcIkNvbXBvc2l0ZSBhY3Rpdml0eSdzIGltcGxlbWVudGF0aW9uIGlzIG5vdCBhdmFpbGFibGUuXCIpO1xuICAgIERlY2xhcmF0b3IucHJvdG90eXBlLnJ1bi5jYWxsKHRoaXMsIGNhbGxDb250ZXh0LCBhcmdzKTtcbn1cblxuQ29tcG9zaXRlLnByb3RvdHlwZS52YXJzRGVjbGFyZWQgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIGFyZ3MpIHtcbiAgICBjYWxsQ29udGV4dC5zY2hlZHVsZSh0aGlzLmdldChcIl9pbXBsZW1lbnRhdGlvblwiKSwgXCJfaW1wbEludm9rZWRcIik7XG59XG5cbkNvbXBvc2l0ZS5wcm90b3R5cGUuX2ltcGxJbnZva2VkID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCByZWFzb24sIHJlc3VsdCkge1xuICAgIGNhbGxDb250ZXh0LmVuZChyZWFzb24sIHJlc3VsdCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ29tcG9zaXRlOyJdfQ==
