"use strict";
"use strict";
var Activity = require("./activity");
var util = require("util");
var _ = require("lodash");
var WithBody = require("./withBody");
function For() {
  WithBody.call(this);
  this.from = null;
  this.to = null;
  this.step = 1;
  this.varName = "i";
  this.nonScopedProperties.add("_doStep");
}
util.inherits(For, WithBody);
For.prototype.run = function(callContext, args) {
  var varName = this.get("varName");
  var from = this.get("from");
  var to = this.get("to");
  var step = this.get("step");
  if (!_.isNull(from) && !_.isNull(to) && !_.isNull(step)) {
    this.set(varName, null);
    callContext.schedule([from, to, step], "_valuesGot");
  } else {
    callContext.complete();
  }
};
For.prototype._valuesGot = function(callContext, reason, result) {
  if (reason === Activity.states.complete) {
    this.set("_from", result[0]);
    this.set("_to", result[1]);
    this.set("_step", result[2]);
    callContext.activity._doStep.call(this, callContext);
  } else {
    callContext.to(reason, result);
  }
};
For.prototype._doStep = function(callContext, lastResult) {
  var varName = this.get("varName");
  var from = this.get("_from");
  var to = this.get("_to");
  var step = this.get("_step");
  if (!_.isNumber(from)) {
    callContext.fail(new TypeError(("\"For activity's from value '" + from + "' is not a number.")));
    return ;
  }
  if (!_.isNumber(to)) {
    callContext.fail(new TypeError(("\"For activity's to value '" + to + "' is not a number.")));
    return ;
  }
  if (!_.isNumber(step)) {
    callContext.fail(new TypeError(("\"For activity's from value '" + step + "' is not a number.")));
    return ;
  }
  var current;
  if (_.isNull(this.get(varName))) {
    current = this.set(varName, from);
  } else {
    current = this.set(varName, this.get(varName) + step);
  }
  if (step >= 0 && current >= to) {
    callContext.complete(lastResult);
  } else if (step < 0 && current <= to) {
    callContext.complete(lastResult);
  } else {
    WithBody.prototype.run.call(this, callContext);
  }
};
For.prototype.bodyCompleted = function(callContext, reason, result) {
  if (reason === Activity.states.complete) {
    callContext.activity._doStep.call(this, callContext, result);
  } else {
    callContext.end(reason, result);
  }
};
module.exports = For;
//# sourceMappingURL=data:application/json;base64,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QyxDQUFHO0FBQzdCLFVBQU0sRUFBSSxDQUFBLElBQUcsSUFBSSxBQUFDLENBQUMsT0FBTSxDQUFHLEtBQUcsQ0FBQyxDQUFDO0VBQ3JDLEtBQ0s7QUFDRCxVQUFNLEVBQUksQ0FBQSxJQUFHLElBQUksQUFBQyxDQUFDLE9BQU0sQ0FBRyxDQUFBLElBQUcsSUFBSSxBQUFDLENBQUMsT0FBTSxDQUFDLENBQUEsQ0FBSSxLQUFHLENBQUMsQ0FBQztFQUN6RDtBQUFBLEFBQ0EsS0FBSSxJQUFHLEdBQUssRUFBQSxDQUFBLEVBQUssQ0FBQSxPQUFNLEdBQUssR0FBQyxDQUFHO0FBQzVCLGNBQVUsU0FBUyxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7RUFDcEMsS0FDSyxLQUFJLElBQUcsRUFBSSxFQUFBLENBQUEsRUFBSyxDQUFBLE9BQU0sR0FBSyxHQUFDLENBQUc7QUFDaEMsY0FBVSxTQUFTLEFBQUMsQ0FBQyxVQUFTLENBQUMsQ0FBQztFQUNwQyxLQUNLO0FBQ0QsV0FBTyxVQUFVLElBQUksS0FBSyxBQUFDLENBQUMsSUFBRyxDQUFHLFlBQVUsQ0FBQyxDQUFDO0VBQ2xEO0FBQUEsQUFDSixDQUFDO0FBRUQsRUFBRSxVQUFVLGNBQWMsRUFBSSxVQUFVLFdBQVUsQ0FBRyxDQUFBLE1BQUssQ0FBRyxDQUFBLE1BQUssQ0FBRztBQUNqRSxLQUFJLE1BQUssSUFBTSxDQUFBLFFBQU8sT0FBTyxTQUFTLENBQUc7QUFDckMsY0FBVSxTQUFTLFFBQVEsS0FBSyxBQUFDLENBQUMsSUFBRyxDQUFHLFlBQVUsQ0FBRyxPQUFLLENBQUMsQ0FBQztFQUNoRSxLQUNLO0FBQ0QsY0FBVSxJQUFJLEFBQUMsQ0FBQyxNQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7RUFDbkM7QUFBQSxBQUNKLENBQUM7QUFFRCxLQUFLLFFBQVEsRUFBSSxJQUFFLENBQUM7QUFBQSIsImZpbGUiOiJhY3Rpdml0aWVzL2Zvci5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCBBY3Rpdml0eSA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5XCIpO1xubGV0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcbmxldCBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbmxldCBXaXRoQm9keSA9IHJlcXVpcmUoXCIuL3dpdGhCb2R5XCIpO1xuXG5mdW5jdGlvbiBGb3IoKSB7XG4gICAgV2l0aEJvZHkuY2FsbCh0aGlzKTtcblxuICAgIHRoaXMuZnJvbSA9IG51bGw7XG4gICAgdGhpcy50byA9IG51bGw7XG4gICAgdGhpcy5zdGVwID0gMTtcbiAgICB0aGlzLnZhck5hbWUgPSBcImlcIjtcblxuICAgIHRoaXMubm9uU2NvcGVkUHJvcGVydGllcy5hZGQoXCJfZG9TdGVwXCIpO1xufVxuXG51dGlsLmluaGVyaXRzKEZvciwgV2l0aEJvZHkpO1xuXG5Gb3IucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgYXJncykge1xuICAgIGNvbnN0IHZhck5hbWUgPSB0aGlzLmdldChcInZhck5hbWVcIik7XG4gICAgbGV0IGZyb20gPSB0aGlzLmdldChcImZyb21cIik7XG4gICAgbGV0IHRvID0gdGhpcy5nZXQoXCJ0b1wiKTtcbiAgICBsZXQgc3RlcCA9IHRoaXMuZ2V0KFwic3RlcFwiKTtcbiAgICBpZiAoIV8uaXNOdWxsKGZyb20pICYmICFfLmlzTnVsbCh0bykgJiYgIV8uaXNOdWxsKHN0ZXApKSB7XG4gICAgICAgIHRoaXMuc2V0KHZhck5hbWUsIG51bGwpO1xuICAgICAgICBjYWxsQ29udGV4dC5zY2hlZHVsZShbZnJvbSwgdG8sIHN0ZXBdLCBcIl92YWx1ZXNHb3RcIik7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYWxsQ29udGV4dC5jb21wbGV0ZSgpO1xuICAgIH1cbn07XG5cbkZvci5wcm90b3R5cGUuX3ZhbHVlc0dvdCA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgcmVhc29uLCByZXN1bHQpIHtcbiAgICBpZiAocmVhc29uID09PSBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUpIHtcbiAgICAgICAgdGhpcy5zZXQoXCJfZnJvbVwiLCByZXN1bHRbMF0pO1xuICAgICAgICB0aGlzLnNldChcIl90b1wiLCByZXN1bHRbMV0pO1xuICAgICAgICB0aGlzLnNldChcIl9zdGVwXCIsIHJlc3VsdFsyXSk7XG4gICAgICAgIGNhbGxDb250ZXh0LmFjdGl2aXR5Ll9kb1N0ZXAuY2FsbCh0aGlzLCBjYWxsQ29udGV4dCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYWxsQ29udGV4dC50byhyZWFzb24sIHJlc3VsdCk7XG4gICAgfVxufTtcblxuRm9yLnByb3RvdHlwZS5fZG9TdGVwID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBsYXN0UmVzdWx0KSB7XG4gICAgY29uc3QgdmFyTmFtZSA9IHRoaXMuZ2V0KFwidmFyTmFtZVwiKTtcbiAgICBsZXQgZnJvbSA9IHRoaXMuZ2V0KFwiX2Zyb21cIik7XG4gICAgbGV0IHRvID0gdGhpcy5nZXQoXCJfdG9cIik7XG4gICAgbGV0IHN0ZXAgPSB0aGlzLmdldChcIl9zdGVwXCIpO1xuICAgIGlmICghXy5pc051bWJlcihmcm9tKSkge1xuICAgICAgICBjYWxsQ29udGV4dC5mYWlsKG5ldyBUeXBlRXJyb3IoYFwiRm9yIGFjdGl2aXR5J3MgZnJvbSB2YWx1ZSAnJHtmcm9tfScgaXMgbm90IGEgbnVtYmVyLmApKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIV8uaXNOdW1iZXIodG8pKSB7XG4gICAgICAgIGNhbGxDb250ZXh0LmZhaWwobmV3IFR5cGVFcnJvcihgXCJGb3IgYWN0aXZpdHkncyB0byB2YWx1ZSAnJHt0b30nIGlzIG5vdCBhIG51bWJlci5gKSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCFfLmlzTnVtYmVyKHN0ZXApKSB7XG4gICAgICAgIGNhbGxDb250ZXh0LmZhaWwobmV3IFR5cGVFcnJvcihgXCJGb3IgYWN0aXZpdHkncyBmcm9tIHZhbHVlICcke3N0ZXB9JyBpcyBub3QgYSBudW1iZXIuYCkpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBjdXJyZW50O1xuICAgIGlmIChfLmlzTnVsbCh0aGlzLmdldCh2YXJOYW1lKSkpIHtcbiAgICAgICAgY3VycmVudCA9IHRoaXMuc2V0KHZhck5hbWUsIGZyb20pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY3VycmVudCA9IHRoaXMuc2V0KHZhck5hbWUsIHRoaXMuZ2V0KHZhck5hbWUpICsgc3RlcCk7XG4gICAgfVxuICAgIGlmIChzdGVwID49IDAgJiYgY3VycmVudCA+PSB0bykge1xuICAgICAgICBjYWxsQ29udGV4dC5jb21wbGV0ZShsYXN0UmVzdWx0KTtcbiAgICB9XG4gICAgZWxzZSBpZiAoc3RlcCA8IDAgJiYgY3VycmVudCA8PSB0bykge1xuICAgICAgICBjYWxsQ29udGV4dC5jb21wbGV0ZShsYXN0UmVzdWx0KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIFdpdGhCb2R5LnByb3RvdHlwZS5ydW4uY2FsbCh0aGlzLCBjYWxsQ29udGV4dCk7XG4gICAgfVxufTtcblxuRm9yLnByb3RvdHlwZS5ib2R5Q29tcGxldGVkID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCByZWFzb24sIHJlc3VsdCkge1xuICAgIGlmIChyZWFzb24gPT09IEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZSkge1xuICAgICAgICBjYWxsQ29udGV4dC5hY3Rpdml0eS5fZG9TdGVwLmNhbGwodGhpcywgY2FsbENvbnRleHQsIHJlc3VsdCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gRm9yOyJdfQ==
