"use strict";
"use strict";
var Activity = require("./activity");
var util = require("util");
var _ = require("lodash");
function For() {
  Activity.call(this);
  this.from = null;
  this.to = null;
  this.step = 1;
  this.body = null;
  this.varName = "i";
  this.nonScopedProperties.add("_doStep");
}
util.inherits(For, Activity);
For.prototype.run = function(callContext, args) {
  var varName = this.get("varName");
  var from = this.get("from");
  var to = this.get("to");
  var step = this.get("step");
  if (!_.isNull(from) && !_.isNull(to) && !_.isNull(step)) {
    this.set(varName, null);
    callContext.schedule([from, to, step], "_valuesGot");
  } else {
    callContext.complete();
  }
};
For.prototype._valuesGot = function(callContext, reason, result) {
  if (reason === Activity.states.complete) {
    this.set("_from", result[0]);
    this.set("_to", result[1]);
    this.set("_step", result[2]);
    callContext.activity._doStep.call(this, callContext);
  } else {
    callContext.to(reason, result);
  }
};
For.prototype._doStep = function(callContext, lastResult) {
  var varName = this.get("varName");
  var from = this.get("_from");
  var to = this.get("_to");
  var step = this.get("_step");
  if (!_.isNumber(from)) {
    callContext.fail(new TypeError(("\"For activity's from value '" + from + "' is not a number.")));
    return ;
  }
  if (!_.isNumber(to)) {
    callContext.fail(new TypeError(("\"For activity's to value '" + to + "' is not a number.")));
    return ;
  }
  if (!_.isNumber(step)) {
    callContext.fail(new TypeError(("\"For activity's from value '" + step + "' is not a number.")));
    return ;
  }
  var current;
  if (_.isNull(this.get(varName))) {
    current = this.set(varName, from);
  } else {
    current = this.set(varName, this.get(varName) + step);
  }
  if (step >= 0 && current >= to) {
    callContext.complete(lastResult);
  } else if (step < 0 && current <= to) {
    callContext.complete(lastResult);
  } else {
    callContext.schedule(this.get("body"), "_bodyFinished");
  }
};
For.prototype._bodyFinished = function(callContext, reason, result) {
  if (reason === Activity.states.complete) {
    callContext.activity._doStep.call(this, callContext, result);
  } else {
    callContext.end(reason, result);
  }
};
module.exports = For;
//# sourceMappingURL=data:application/json;base64,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QUksQUFBQyxDQUFDLE9BQU0sQ0FBRyxLQUFHLENBQUMsQ0FBQztFQUNyQyxLQUNLO0FBQ0QsVUFBTSxFQUFJLENBQUEsSUFBRyxJQUFJLEFBQUMsQ0FBQyxPQUFNLENBQUcsQ0FBQSxJQUFHLElBQUksQUFBQyxDQUFDLE9BQU0sQ0FBQyxDQUFBLENBQUksS0FBRyxDQUFDLENBQUM7RUFDekQ7QUFBQSxBQUNBLEtBQUksSUFBRyxHQUFLLEVBQUEsQ0FBQSxFQUFLLENBQUEsT0FBTSxHQUFLLEdBQUMsQ0FBRztBQUM1QixjQUFVLFNBQVMsQUFBQyxDQUFDLFVBQVMsQ0FBQyxDQUFDO0VBQ3BDLEtBQ0ssS0FBSSxJQUFHLEVBQUksRUFBQSxDQUFBLEVBQUssQ0FBQSxPQUFNLEdBQUssR0FBQyxDQUFHO0FBQ2hDLGNBQVUsU0FBUyxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7RUFDcEMsS0FDSztBQUNELGNBQVUsU0FBUyxBQUFDLENBQUMsSUFBRyxJQUFJLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBRyxnQkFBYyxDQUFDLENBQUM7RUFDM0Q7QUFBQSxBQUNKLENBQUM7QUFFRCxFQUFFLFVBQVUsY0FBYyxFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQ2pFLEtBQUksTUFBSyxJQUFNLENBQUEsUUFBTyxPQUFPLFNBQVMsQ0FBRztBQUNyQyxjQUFVLFNBQVMsUUFBUSxLQUFLLEFBQUMsQ0FBQyxJQUFHLENBQUcsWUFBVSxDQUFHLE9BQUssQ0FBQyxDQUFDO0VBQ2hFLEtBQ0s7QUFDRCxjQUFVLElBQUksQUFBQyxDQUFDLE1BQUssQ0FBRyxPQUFLLENBQUMsQ0FBQztFQUNuQztBQUFBLEFBQ0osQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLElBQUUsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvZm9yLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IEFjdGl2aXR5ID0gcmVxdWlyZShcIi4vYWN0aXZpdHlcIik7XG5sZXQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xuXG5mdW5jdGlvbiBGb3IoKSB7XG4gICAgQWN0aXZpdHkuY2FsbCh0aGlzKTtcblxuICAgIHRoaXMuZnJvbSA9IG51bGw7XG4gICAgdGhpcy50byA9IG51bGw7XG4gICAgdGhpcy5zdGVwID0gMTtcbiAgICB0aGlzLmJvZHkgPSBudWxsO1xuICAgIHRoaXMudmFyTmFtZSA9IFwiaVwiO1xuXG4gICAgdGhpcy5ub25TY29wZWRQcm9wZXJ0aWVzLmFkZChcIl9kb1N0ZXBcIik7XG59XG5cbnV0aWwuaW5oZXJpdHMoRm9yLCBBY3Rpdml0eSk7XG5cbkZvci5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBhcmdzKSB7XG4gICAgY29uc3QgdmFyTmFtZSA9IHRoaXMuZ2V0KFwidmFyTmFtZVwiKTtcbiAgICBsZXQgZnJvbSA9IHRoaXMuZ2V0KFwiZnJvbVwiKTtcbiAgICBsZXQgdG8gPSB0aGlzLmdldChcInRvXCIpO1xuICAgIGxldCBzdGVwID0gdGhpcy5nZXQoXCJzdGVwXCIpO1xuICAgIGlmICghXy5pc051bGwoZnJvbSkgJiYgIV8uaXNOdWxsKHRvKSAmJiAhXy5pc051bGwoc3RlcCkpIHtcbiAgICAgICAgdGhpcy5zZXQodmFyTmFtZSwgbnVsbCk7XG4gICAgICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKFtmcm9tLCB0bywgc3RlcF0sIFwiX3ZhbHVlc0dvdFwiKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNhbGxDb250ZXh0LmNvbXBsZXRlKCk7XG4gICAgfVxufTtcblxuRm9yLnByb3RvdHlwZS5fdmFsdWVzR290ID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCByZWFzb24sIHJlc3VsdCkge1xuICAgIGlmIChyZWFzb24gPT09IEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZSkge1xuICAgICAgICB0aGlzLnNldChcIl9mcm9tXCIsIHJlc3VsdFswXSk7XG4gICAgICAgIHRoaXMuc2V0KFwiX3RvXCIsIHJlc3VsdFsxXSk7XG4gICAgICAgIHRoaXMuc2V0KFwiX3N0ZXBcIiwgcmVzdWx0WzJdKTtcbiAgICAgICAgY2FsbENvbnRleHQuYWN0aXZpdHkuX2RvU3RlcC5jYWxsKHRoaXMsIGNhbGxDb250ZXh0KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNhbGxDb250ZXh0LnRvKHJlYXNvbiwgcmVzdWx0KTtcbiAgICB9XG59O1xuXG5Gb3IucHJvdG90eXBlLl9kb1N0ZXAgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIGxhc3RSZXN1bHQpIHtcbiAgICBjb25zdCB2YXJOYW1lID0gdGhpcy5nZXQoXCJ2YXJOYW1lXCIpO1xuICAgIGxldCBmcm9tID0gdGhpcy5nZXQoXCJfZnJvbVwiKTtcbiAgICBsZXQgdG8gPSB0aGlzLmdldChcIl90b1wiKTtcbiAgICBsZXQgc3RlcCA9IHRoaXMuZ2V0KFwiX3N0ZXBcIik7XG4gICAgaWYgKCFfLmlzTnVtYmVyKGZyb20pKSB7XG4gICAgICAgIGNhbGxDb250ZXh0LmZhaWwobmV3IFR5cGVFcnJvcihgXCJGb3IgYWN0aXZpdHkncyBmcm9tIHZhbHVlICcke2Zyb219JyBpcyBub3QgYSBudW1iZXIuYCkpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghXy5pc051bWJlcih0bykpIHtcbiAgICAgICAgY2FsbENvbnRleHQuZmFpbChuZXcgVHlwZUVycm9yKGBcIkZvciBhY3Rpdml0eSdzIHRvIHZhbHVlICcke3RvfScgaXMgbm90IGEgbnVtYmVyLmApKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIV8uaXNOdW1iZXIoc3RlcCkpIHtcbiAgICAgICAgY2FsbENvbnRleHQuZmFpbChuZXcgVHlwZUVycm9yKGBcIkZvciBhY3Rpdml0eSdzIGZyb20gdmFsdWUgJyR7c3RlcH0nIGlzIG5vdCBhIG51bWJlci5gKSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IGN1cnJlbnQ7XG4gICAgaWYgKF8uaXNOdWxsKHRoaXMuZ2V0KHZhck5hbWUpKSkge1xuICAgICAgICBjdXJyZW50ID0gdGhpcy5zZXQodmFyTmFtZSwgZnJvbSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjdXJyZW50ID0gdGhpcy5zZXQodmFyTmFtZSwgdGhpcy5nZXQodmFyTmFtZSkgKyBzdGVwKTtcbiAgICB9XG4gICAgaWYgKHN0ZXAgPj0gMCAmJiBjdXJyZW50ID49IHRvKSB7XG4gICAgICAgIGNhbGxDb250ZXh0LmNvbXBsZXRlKGxhc3RSZXN1bHQpO1xuICAgIH1cbiAgICBlbHNlIGlmIChzdGVwIDwgMCAmJiBjdXJyZW50IDw9IHRvKSB7XG4gICAgICAgIGNhbGxDb250ZXh0LmNvbXBsZXRlKGxhc3RSZXN1bHQpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY2FsbENvbnRleHQuc2NoZWR1bGUodGhpcy5nZXQoXCJib2R5XCIpLCBcIl9ib2R5RmluaXNoZWRcIik7XG4gICAgfVxufTtcblxuRm9yLnByb3RvdHlwZS5fYm9keUZpbmlzaGVkID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCByZWFzb24sIHJlc3VsdCkge1xuICAgIGlmIChyZWFzb24gPT09IEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZSkge1xuICAgICAgICBjYWxsQ29udGV4dC5hY3Rpdml0eS5fZG9TdGVwLmNhbGwodGhpcywgY2FsbENvbnRleHQsIHJlc3VsdCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gRm9yOyJdfQ==
