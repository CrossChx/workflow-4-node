"use strict";
var Activity = require("./activity");
var ActivityExecutionContext = require("./activityExecutionContext");
var ActivityExecutionState = require("./activityExecutionState");
var CallContext = require("./callContext");
var EventEmitter = require('events').EventEmitter;
var util = require("util");
var errors = require("../common/errors");
var _ = require("lodash");
var ActivityStateTracker = require("./activityStateTracker");
var enums = require("../common/enums");
var Bluebird = require("bluebird");
var asyncHelpers = require("../common/asyncHelpers");
var async = asyncHelpers.async;
var activityMarkup = require("./activityMarkup");
function ActivityExecutionEngine(rootActivity, instance) {
  EventEmitter.call(this);
  if (!(rootActivity instanceof Activity)) {
    if (_.isPlainObject(rootActivity)) {
      rootActivity = activityMarkup.parse(rootActivity);
    } else {
      throw new TypeError("Argument 'rootActivity' is not an activity or a markup.");
    }
  }
  this.rootActivity = rootActivity;
  this._context = new ActivityExecutionContext(this);
  this._isInitialized = false;
  this._rootState = null;
  this._trackers = [];
  this._hookContext();
  this._timestamp = null;
  this.instance = instance || null;
}
util.inherits(ActivityExecutionEngine, EventEmitter);
Object.defineProperties(ActivityExecutionEngine.prototype, {
  execState: {get: function() {
      if (this._rootState) {
        return this._rootState.execState;
      } else {
        return null;
      }
    }},
  version: {get: function() {
      return this.rootActivity.version;
    }},
  updatedOn: {get: function() {
      return this._timestamp;
    }}
});
ActivityExecutionEngine.prototype._idle = {toString: function() {
    return enums.activityStates.idle;
  }};
ActivityExecutionEngine.prototype.isIdle = function(result) {
  return result === this._idle;
};
ActivityExecutionEngine.prototype._initialize = function() {
  if (!this._isInitialized) {
    this._context.initialize(this.rootActivity);
    this._isInitialized = true;
  }
};
ActivityExecutionEngine.prototype._setRootState = function(state) {
  var self = this;
  if (!self._rootState) {
    self._rootState = state;
    self._rootState.on(Activity.states.cancel, function(args) {
      self.emit(Activity.states.cancel, args);
    });
    self._rootState.on(Activity.states.complete, function(args) {
      self.emit(Activity.states.complete, args);
    });
    self._rootState.on(Activity.states.end, function(args) {
      self._timestamp = new Date();
      self.emit(Activity.states.end, args);
    });
    self._rootState.on(Activity.states.fail, function(args) {
      self.emit(Activity.states.fail, args);
    });
    self._rootState.on(Activity.states.run, function(args) {
      self.emit(Activity.states.run, args);
    });
    self._rootState.on(Activity.states.idle, function(args) {
      self.emit(Activity.states.idle, args);
    });
  }
};
ActivityExecutionEngine.prototype._hookContext = function() {
  var self = this;
  self._context.on(Activity.states.run, function(args) {
    var $__5 = true;
    var $__6 = false;
    var $__7 = undefined;
    try {
      for (var $__3 = void 0,
          $__2 = (self._trackers)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
        var t = $__3.value;
        {
          t.activityStateChanged(args);
        }
      }
    } catch ($__8) {
      $__6 = true;
      $__7 = $__8;
    } finally {
      try {
        if (!$__5 && $__2.return != null) {
          $__2.return();
        }
      } finally {
        if ($__6) {
          throw $__7;
        }
      }
    }
  });
  self._context.on(Activity.states.end, function(args) {
    var $__5 = true;
    var $__6 = false;
    var $__7 = undefined;
    try {
      for (var $__3 = void 0,
          $__2 = (self._trackers)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
        var t = $__3.value;
        {
          t.activityStateChanged(args);
        }
      }
    } catch ($__8) {
      $__6 = true;
      $__7 = $__8;
    } finally {
      try {
        if (!$__5 && $__2.return != null) {
          $__2.return();
        }
      } finally {
        if ($__6) {
          throw $__7;
        }
      }
    }
  });
  self._context.on(enums.events.workflowEvent, function(args) {
    self.emit(enums.events.workflowEvent, args);
  });
};
ActivityExecutionEngine.prototype.addTracker = function(tracker) {
  if (!_.isObject(tracker)) {
    throw new TypeError("Parameter is not an object.");
  }
  this._trackers.push(new ActivityStateTracker(tracker));
};
ActivityExecutionEngine.prototype.removeTracker = function(tracker) {
  var idx = -1;
  for (var i = 0; i < this._trackers.length; i++) {
    var t = this._trackers[i];
    if (t._impl === tracker) {
      idx = i;
      break;
    }
  }
  if (idx !== -1) {
    this._trackers.splice(idx, 1);
  }
};
ActivityExecutionEngine.prototype.start = async($traceurRuntime.initGeneratorFunction(function $__9() {
  var args,
      $__5,
      $__6,
      $__7,
      $__3,
      $__2,
      a,
      $__10,
      $__11,
      $__12,
      $__13,
      $__14,
      $__15,
      $__16,
      $__17;
  var $arguments = arguments;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyNotStarted();
          this._initialize();
          args = [new CallContext(this._context)];
          $__5 = true;
          $__6 = false;
          $__7 = undefined;
          try {
            for ($__3 = void 0, $__2 = ($arguments)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
              a = $__3.value;
              {
                args.push(a);
              }
            }
          } catch ($__8) {
            $__6 = true;
            $__7 = $__8;
          } finally {
            try {
              if (!$__5 && $__2.return != null) {
                $__2.return();
              }
            } finally {
              if ($__6) {
                throw $__7;
              }
            }
          }
          $ctx.state = 10;
          break;
        case 10:
          $__10 = this._setRootState;
          $__11 = this.rootActivity;
          $__12 = $__11.start;
          $__13 = $__12.apply;
          $__14 = this.rootActivity;
          $__15 = $__13.call($__12, $__14, args);
          $ctx.state = 6;
          break;
        case 6:
          $ctx.state = 2;
          return $__15;
        case 2:
          $__16 = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          $__17 = $__10.call(this, $__16);
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__9, this);
}));
ActivityExecutionEngine.prototype.invoke = function() {
  var self = this;
  self._verifyNotStarted();
  self._initialize();
  var argRemoveToken = null;
  var args = [];
  var $__5 = true;
  var $__6 = false;
  var $__7 = undefined;
  try {
    for (var $__3 = void 0,
        $__2 = (arguments)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
      var a = $__3.value;
      {
        args.push(a);
      }
    }
  } catch ($__8) {
    $__6 = true;
    $__7 = $__8;
  } finally {
    try {
      if (!$__5 && $__2.return != null) {
        $__2.return();
      }
    } finally {
      if ($__6) {
        throw $__7;
      }
    }
  }
  if (args.length) {
    argRemoveToken = self._context.appendToContext(args);
  }
  args.unshift(new CallContext(self._context));
  return new Bluebird(function(resolve, reject) {
    try {
      self._setRootState(self._context.getExecutionState(self.rootActivity));
      self.once(Activity.states.end, function(eArgs) {
        var reason = eArgs.reason;
        var result = eArgs.result;
        try {
          switch (reason) {
            case Activity.states.complete:
              resolve(result);
              break;
            case Activity.states.cancel:
              reject(new errors.Cancelled());
              break;
            case Activity.states.idle:
              resolve(self._idle);
              break;
            default:
              result = result || new errors.ActivityRuntimeError("Unknown error.");
              reject(result);
              break;
          }
        } finally {
          if (argRemoveToken) {
            self._context.removeFromContext(argRemoveToken);
            argRemoveToken = null;
          }
        }
      });
      self.rootActivity.start.apply(self.rootActivity, args);
    } catch (e) {
      reject(e);
      if (argRemoveToken) {
        self._context.removeFromContext(argRemoveToken);
        argRemoveToken = null;
      }
    }
  });
};
ActivityExecutionEngine.prototype._verifyNotStarted = function() {
  if (!(!this.execState || this.execState === enums.activityStates.complete)) {
    throw new errors.ActivityStateExceptionError("Workflow has been already started.");
  }
};
ActivityExecutionEngine.prototype.resumeBookmark = function(name, reason, result) {
  var self = this;
  self._initialize();
  return new Bluebird(function(resolve, reject) {
    try {
      self._setRootState(self._context.getExecutionState(self.rootActivity));
      if (self.execState === enums.activityStates.idle) {
        var bmTimestamp = self._context.getBookmarkTimestamp(name);
        self.once(Activity.states.end, function(args) {
          var _reason = args.reason;
          var _result = args.result;
          try {
            if (_reason === enums.activityStates.complete || _reason === enums.activityStates.idle) {
              var endBmTimestamp = self._context.getBookmarkTimestamp(name);
              if (endBmTimestamp && endBmTimestamp === bmTimestamp) {
                if (_reason === enums.activityStates.complete) {
                  reject(new errors.ActivityRuntimeError("Workflow has been completed before bookmark '" + name + "' reached."));
                } else {
                  reject(new errors.Idle("Workflow has been gone to idle before bookmark '" + name + "' reached."));
                }
              } else {
                resolve();
              }
            } else if (_reason === enums.activityStates.cancel) {
              reject(new errors.ActivityRuntimeError("Workflow has been cancelled before bookmark '" + name + "' reached."));
            } else if (_reason === enums.activityStates.fail) {
              reject(_result);
            }
          } catch (e) {
            reject(e);
          }
        });
        self._context.resumeBookmarkExternal(name, reason, result);
      } else {
        reject(new errors.ActivityRuntimeError("Cannot resume bookmark, while the workflow is not in the idle state."));
      }
    } catch (e) {
      reject(e);
    }
  });
};
ActivityExecutionEngine.prototype.getStateAndPromotions = function(serializer, enablePromotions) {
  if (serializer && !_.isObject(serializer)) {
    throw new Error("Argument 'serializer' is not an object.");
  }
  this._initialize();
  return this._context.getStateAndPromotions(serializer, enablePromotions);
};
ActivityExecutionEngine.prototype.setState = function(serializer, json) {
  if (serializer && !_.isObject(serializer)) {
    throw new Error("Argument 'serializer' is not an object.");
  }
  if (!_.isObject(json)) {
    throw new TypeError("Argument 'json' is not an object.");
  }
  this._initialize();
  this._timestamp = new Date();
  this._context.setState(serializer, json);
};
module.exports = ActivityExecutionEngine;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBRUEsQUFBSSxFQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsWUFBVyxDQUFDLENBQUM7QUFDcEMsQUFBSSxFQUFBLENBQUEsd0JBQXVCLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyw0QkFBMkIsQ0FBQyxDQUFDO0FBQ3BFLEFBQUksRUFBQSxDQUFBLHNCQUFxQixFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsMEJBQXlCLENBQUMsQ0FBQztBQUNoRSxBQUFJLEVBQUEsQ0FBQSxXQUFVLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxlQUFjLENBQUMsQ0FBQztBQUMxQyxBQUFJLEVBQUEsQ0FBQSxZQUFXLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsYUFBYSxDQUFDO0FBQ2pELEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGtCQUFpQixDQUFDLENBQUM7QUFDeEMsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsb0JBQW1CLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyx3QkFBdUIsQ0FBQyxDQUFDO0FBQzVELEFBQUksRUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGlCQUFnQixDQUFDLENBQUM7QUFDdEMsQUFBSSxFQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDbEMsQUFBSSxFQUFBLENBQUEsWUFBVyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsd0JBQXVCLENBQUMsQ0FBQztBQUNw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QyxJQUFHLENBQUMsQ0FBRztBQUNuQixRQUFNLElBQUksVUFBUSxBQUFDLENBQUMsbUNBQWtDLENBQUMsQ0FBQztFQUM1RDtBQUFBLEFBRUEsS0FBRyxZQUFZLEFBQUMsRUFBQyxDQUFDO0FBQ2xCLEtBQUcsV0FBVyxFQUFJLElBQUksS0FBRyxBQUFDLEVBQUMsQ0FBQztBQUM1QixLQUFHLFNBQVMsU0FBUyxBQUFDLENBQUMsVUFBUyxDQUFHLEtBQUcsQ0FBQyxDQUFDO0FBQzVDLENBQUM7QUFHRCxLQUFLLFFBQVEsRUFBSSx3QkFBc0IsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvYWN0aXZpdHlFeGVjdXRpb25FbmdpbmUuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5sZXQgQWN0aXZpdHkgPSByZXF1aXJlKFwiLi9hY3Rpdml0eVwiKTtcbmxldCBBY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQgPSByZXF1aXJlKFwiLi9hY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHRcIik7XG5sZXQgQWN0aXZpdHlFeGVjdXRpb25TdGF0ZSA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5RXhlY3V0aW9uU3RhdGVcIik7XG5sZXQgQ2FsbENvbnRleHQgPSByZXF1aXJlKFwiLi9jYWxsQ29udGV4dFwiKTtcbmxldCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7XG5sZXQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xubGV0IGVycm9ycyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZXJyb3JzXCIpO1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IEFjdGl2aXR5U3RhdGVUcmFja2VyID0gcmVxdWlyZShcIi4vYWN0aXZpdHlTdGF0ZVRyYWNrZXJcIik7XG5sZXQgZW51bXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2VudW1zXCIpO1xubGV0IEJsdWViaXJkID0gcmVxdWlyZShcImJsdWViaXJkXCIpO1xubGV0IGFzeW5jSGVscGVycyA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXN5bmNIZWxwZXJzXCIpO1xubGV0IGFzeW5jID0gYXN5bmNIZWxwZXJzLmFzeW5jO1xubGV0IGFjdGl2aXR5TWFya3VwID0gcmVxdWlyZShcIi4vYWN0aXZpdHlNYXJrdXBcIik7XG5cbmZ1bmN0aW9uIEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKHJvb3RBY3Rpdml0eSwgaW5zdGFuY2UpIHtcbiAgICBFdmVudEVtaXR0ZXIuY2FsbCh0aGlzKTtcblxuICAgIGlmICghKHJvb3RBY3Rpdml0eSBpbnN0YW5jZW9mIEFjdGl2aXR5KSkge1xuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHJvb3RBY3Rpdml0eSkpIHtcbiAgICAgICAgICAgIHJvb3RBY3Rpdml0eSA9IGFjdGl2aXR5TWFya3VwLnBhcnNlKHJvb3RBY3Rpdml0eSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ3Jvb3RBY3Rpdml0eScgaXMgbm90IGFuIGFjdGl2aXR5IG9yIGEgbWFya3VwLlwiKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnJvb3RBY3Rpdml0eSA9IHJvb3RBY3Rpdml0eTtcbiAgICB0aGlzLl9jb250ZXh0ID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dCh0aGlzKTtcbiAgICB0aGlzLl9pc0luaXRpYWxpemVkID0gZmFsc2U7XG4gICAgdGhpcy5fcm9vdFN0YXRlID0gbnVsbDtcbiAgICB0aGlzLl90cmFja2VycyA9IFtdO1xuICAgIHRoaXMuX2hvb2tDb250ZXh0KCk7XG4gICAgdGhpcy5fdGltZXN0YW1wID0gbnVsbDtcbiAgICB0aGlzLmluc3RhbmNlID0gaW5zdGFuY2UgfHwgbnVsbDtcbn1cblxudXRpbC5pbmhlcml0cyhBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZSwgRXZlbnRFbWl0dGVyKTtcblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLCB7XG4gICAgZXhlY1N0YXRlOiB7XG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHRoaXMuX3Jvb3RTdGF0ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9yb290U3RhdGUuZXhlY1N0YXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9LFxuICAgIHZlcnNpb246IHtcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yb290QWN0aXZpdHkudmVyc2lvbjtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgdXBkYXRlZE9uOiB7XG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RpbWVzdGFtcDtcbiAgICAgICAgfVxuICAgIH1cbn0pO1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuX2lkbGUgPSB7XG4gICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIGVudW1zLmFjdGl2aXR5U3RhdGVzLmlkbGU7XG4gICAgfVxufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLmlzSWRsZSA9IGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICByZXR1cm4gcmVzdWx0ID09PSB0aGlzLl9pZGxlO1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLl9pbml0aWFsaXplID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICghdGhpcy5faXNJbml0aWFsaXplZCkge1xuICAgICAgICB0aGlzLl9jb250ZXh0LmluaXRpYWxpemUodGhpcy5yb290QWN0aXZpdHkpO1xuICAgICAgICB0aGlzLl9pc0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICB9XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuX3NldFJvb3RTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBpZiAoIXNlbGYuX3Jvb3RTdGF0ZSkge1xuICAgICAgICBzZWxmLl9yb290U3RhdGUgPSBzdGF0ZTtcbiAgICAgICAgc2VsZi5fcm9vdFN0YXRlLm9uKFxuICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmNhbmNlbCwgZnVuY3Rpb24gKGFyZ3MpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLmNhbmNlbCwgYXJncyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgc2VsZi5fcm9vdFN0YXRlLm9uKFxuICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlLCBmdW5jdGlvbiAoYXJncykge1xuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUsIGFyZ3MpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZS5vbihcbiAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5lbmQsIGZ1bmN0aW9uIChhcmdzKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5fdGltZXN0YW1wID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLmVuZCwgYXJncyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgc2VsZi5fcm9vdFN0YXRlLm9uKFxuICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmZhaWwsIGZ1bmN0aW9uIChhcmdzKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KEFjdGl2aXR5LnN0YXRlcy5mYWlsLCBhcmdzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMucnVuLCBmdW5jdGlvbiAoYXJncykge1xuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChBY3Rpdml0eS5zdGF0ZXMucnVuLCBhcmdzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuaWRsZSwgZnVuY3Rpb24gKGFyZ3MpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLmlkbGUsIGFyZ3MpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLl9ob29rQ29udGV4dCA9IGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgc2VsZi5fY29udGV4dC5vbihcbiAgICAgICAgQWN0aXZpdHkuc3RhdGVzLnJ1bixcbiAgICAgICAgZnVuY3Rpb24gKGFyZ3MpIHtcbiAgICAgICAgICAgIGZvciAobGV0IHQgb2Ygc2VsZi5fdHJhY2tlcnMpIHtcbiAgICAgICAgICAgICAgICB0LmFjdGl2aXR5U3RhdGVDaGFuZ2VkKGFyZ3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICBzZWxmLl9jb250ZXh0Lm9uKFxuICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuZW5kLFxuICAgICAgICBmdW5jdGlvbiAoYXJncykge1xuICAgICAgICAgICAgZm9yIChsZXQgdCBvZiBzZWxmLl90cmFja2Vycykge1xuICAgICAgICAgICAgICAgIHQuYWN0aXZpdHlTdGF0ZUNoYW5nZWQoYXJncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIHNlbGYuX2NvbnRleHQub24oXG4gICAgICAgIGVudW1zLmV2ZW50cy53b3JrZmxvd0V2ZW50LFxuICAgICAgICBmdW5jdGlvbihhcmdzKSB7XG4gICAgICAgICAgICBzZWxmLmVtaXQoZW51bXMuZXZlbnRzLndvcmtmbG93RXZlbnQsIGFyZ3MpO1xuICAgICAgICB9XG4gICAgKTtcbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5hZGRUcmFja2VyID0gZnVuY3Rpb24gKHRyYWNrZXIpIHtcbiAgICBpZiAoIV8uaXNPYmplY3QodHJhY2tlcikpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlBhcmFtZXRlciBpcyBub3QgYW4gb2JqZWN0LlwiKTtcbiAgICB9XG4gICAgdGhpcy5fdHJhY2tlcnMucHVzaChuZXcgQWN0aXZpdHlTdGF0ZVRyYWNrZXIodHJhY2tlcikpO1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLnJlbW92ZVRyYWNrZXIgPSBmdW5jdGlvbiAodHJhY2tlcikge1xuICAgIGxldCBpZHggPSAtMTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3RyYWNrZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGxldCB0ID0gdGhpcy5fdHJhY2tlcnNbaV07XG4gICAgICAgIGlmICh0Ll9pbXBsID09PSB0cmFja2VyKSB7XG4gICAgICAgICAgICBpZHggPSBpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGlkeCAhPT0gLTEpIHtcbiAgICAgICAgdGhpcy5fdHJhY2tlcnMuc3BsaWNlKGlkeCwgMSk7XG4gICAgfVxufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLnN0YXJ0ID0gYXN5bmMoZnVuY3Rpb24qICgpIHtcbiAgICB0aGlzLl92ZXJpZnlOb3RTdGFydGVkKCk7XG5cbiAgICB0aGlzLl9pbml0aWFsaXplKCk7XG5cbiAgICBsZXQgYXJncyA9IFtuZXcgQ2FsbENvbnRleHQodGhpcy5fY29udGV4dCldO1xuICAgIGZvciAobGV0IGEgb2YgYXJndW1lbnRzKSB7XG4gICAgICAgIGFyZ3MucHVzaChhKTtcbiAgICB9XG5cbiAgICB0aGlzLl9zZXRSb290U3RhdGUoeWllbGQgdGhpcy5yb290QWN0aXZpdHkuc3RhcnQuYXBwbHkodGhpcy5yb290QWN0aXZpdHksIGFyZ3MpKTtcbn0pO1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuaW52b2tlID0gZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIHNlbGYuX3ZlcmlmeU5vdFN0YXJ0ZWQoKTtcblxuICAgIHNlbGYuX2luaXRpYWxpemUoKTtcblxuICAgIGxldCBhcmdSZW1vdmVUb2tlbiA9IG51bGw7XG4gICAgbGV0IGFyZ3MgPSBbXTtcbiAgICBmb3IgKGxldCBhIG9mIGFyZ3VtZW50cykge1xuICAgICAgICBhcmdzLnB1c2goYSk7XG4gICAgfVxuXG4gICAgaWYgKGFyZ3MubGVuZ3RoKSB7XG4gICAgICAgIGFyZ1JlbW92ZVRva2VuID0gc2VsZi5fY29udGV4dC5hcHBlbmRUb0NvbnRleHQoYXJncyk7XG4gICAgfVxuXG4gICAgYXJncy51bnNoaWZ0KG5ldyBDYWxsQ29udGV4dChzZWxmLl9jb250ZXh0KSk7XG5cbiAgICByZXR1cm4gbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHNlbGYuX3NldFJvb3RTdGF0ZShzZWxmLl9jb250ZXh0LmdldEV4ZWN1dGlvblN0YXRlKHNlbGYucm9vdEFjdGl2aXR5KSk7XG4gICAgICAgICAgICBzZWxmLm9uY2UoXG4gICAgICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmVuZCwgZnVuY3Rpb24gKGVBcmdzKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByZWFzb24gPSBlQXJncy5yZWFzb247XG4gICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBlQXJncy5yZXN1bHQ7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHJlYXNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQWN0aXZpdHkuc3RhdGVzLmNhbmNlbDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuQ2FuY2VsbGVkKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEFjdGl2aXR5LnN0YXRlcy5pZGxlOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHNlbGYuX2lkbGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0IDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gcmVzdWx0IHx8IG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJVbmtub3duIGVycm9yLlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZpbmFsbHkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ1JlbW92ZVRva2VuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY29udGV4dC5yZW1vdmVGcm9tQ29udGV4dChhcmdSZW1vdmVUb2tlbik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnUmVtb3ZlVG9rZW4gPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHNlbGYucm9vdEFjdGl2aXR5LnN0YXJ0LmFwcGx5KHNlbGYucm9vdEFjdGl2aXR5LCBhcmdzKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgcmVqZWN0KGUpO1xuXG4gICAgICAgICAgICBpZiAoYXJnUmVtb3ZlVG9rZW4pIHtcbiAgICAgICAgICAgICAgICBzZWxmLl9jb250ZXh0LnJlbW92ZUZyb21Db250ZXh0KGFyZ1JlbW92ZVRva2VuKTtcbiAgICAgICAgICAgICAgICBhcmdSZW1vdmVUb2tlbiA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5fdmVyaWZ5Tm90U3RhcnRlZCA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAoISghdGhpcy5leGVjU3RhdGUgfHwgdGhpcy5leGVjU3RhdGUgPT09IGVudW1zLmFjdGl2aXR5U3RhdGVzLmNvbXBsZXRlKSkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLkFjdGl2aXR5U3RhdGVFeGNlcHRpb25FcnJvcihcIldvcmtmbG93IGhhcyBiZWVuIGFscmVhZHkgc3RhcnRlZC5cIik7XG4gICAgfVxufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLnJlc3VtZUJvb2ttYXJrID0gZnVuY3Rpb24gKG5hbWUsIHJlYXNvbiwgcmVzdWx0KSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIHNlbGYuX2luaXRpYWxpemUoKTtcbiAgICByZXR1cm4gbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHNlbGYuX3NldFJvb3RTdGF0ZShzZWxmLl9jb250ZXh0LmdldEV4ZWN1dGlvblN0YXRlKHNlbGYucm9vdEFjdGl2aXR5KSk7XG5cbiAgICAgICAgICAgIGlmIChzZWxmLmV4ZWNTdGF0ZSA9PT0gZW51bXMuYWN0aXZpdHlTdGF0ZXMuaWRsZSkge1xuICAgICAgICAgICAgICAgIGxldCBibVRpbWVzdGFtcCA9IHNlbGYuX2NvbnRleHQuZ2V0Qm9va21hcmtUaW1lc3RhbXAobmFtZSk7XG4gICAgICAgICAgICAgICAgc2VsZi5vbmNlKFxuICAgICAgICAgICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuZW5kLFxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYXJncykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IF9yZWFzb24gPSBhcmdzLnJlYXNvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBfcmVzdWx0ID0gYXJncy5yZXN1bHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfcmVhc29uID09PSBlbnVtcy5hY3Rpdml0eVN0YXRlcy5jb21wbGV0ZSB8fCBfcmVhc29uID09PSBlbnVtcy5hY3Rpdml0eVN0YXRlcy5pZGxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlbmRCbVRpbWVzdGFtcCA9IHNlbGYuX2NvbnRleHQuZ2V0Qm9va21hcmtUaW1lc3RhbXAobmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbmRCbVRpbWVzdGFtcCAmJiBlbmRCbVRpbWVzdGFtcCA9PT0gYm1UaW1lc3RhbXApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfcmVhc29uID09PSBlbnVtcy5hY3Rpdml0eVN0YXRlcy5jb21wbGV0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiV29ya2Zsb3cgaGFzIGJlZW4gY29tcGxldGVkIGJlZm9yZSBib29rbWFyayAnXCIgKyBuYW1lICsgXCInIHJlYWNoZWQuXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgZXJyb3JzLklkbGUoXCJXb3JrZmxvdyBoYXMgYmVlbiBnb25lIHRvIGlkbGUgYmVmb3JlIGJvb2ttYXJrICdcIiArIG5hbWUgKyBcIicgcmVhY2hlZC5cIikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9yZWFzb24gPT09IGVudW1zLmFjdGl2aXR5U3RhdGVzLmNhbmNlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IGVycm9ycy5BY3Rpdml0eVJ1bnRpbWVFcnJvcihcIldvcmtmbG93IGhhcyBiZWVuIGNhbmNlbGxlZCBiZWZvcmUgYm9va21hcmsgJ1wiICsgbmFtZSArIFwiJyByZWFjaGVkLlwiKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9yZWFzb24gPT09IGVudW1zLmFjdGl2aXR5U3RhdGVzLmZhaWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KF9yZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBzZWxmLl9jb250ZXh0LnJlc3VtZUJvb2ttYXJrRXh0ZXJuYWwobmFtZSwgcmVhc29uLCByZXN1bHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJDYW5ub3QgcmVzdW1lIGJvb2ttYXJrLCB3aGlsZSB0aGUgd29ya2Zsb3cgaXMgbm90IGluIHRoZSBpZGxlIHN0YXRlLlwiKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgfVxuICAgIH0pO1xufTtcblxuLyogU0VSSUFMSVpBVElPTiAqL1xuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLmdldFN0YXRlQW5kUHJvbW90aW9ucyA9IGZ1bmN0aW9uIChzZXJpYWxpemVyLCBlbmFibGVQcm9tb3Rpb25zKSB7XG4gICAgaWYgKHNlcmlhbGl6ZXIgJiYgIV8uaXNPYmplY3Qoc2VyaWFsaXplcikpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQXJndW1lbnQgJ3NlcmlhbGl6ZXInIGlzIG5vdCBhbiBvYmplY3QuXCIpO1xuICAgIH1cblxuICAgIHRoaXMuX2luaXRpYWxpemUoKTtcbiAgICByZXR1cm4gdGhpcy5fY29udGV4dC5nZXRTdGF0ZUFuZFByb21vdGlvbnMoc2VyaWFsaXplciwgZW5hYmxlUHJvbW90aW9ucyk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbiAoc2VyaWFsaXplciwganNvbikge1xuICAgIGlmIChzZXJpYWxpemVyICYmICFfLmlzT2JqZWN0KHNlcmlhbGl6ZXIpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFyZ3VtZW50ICdzZXJpYWxpemVyJyBpcyBub3QgYW4gb2JqZWN0LlwiKTtcbiAgICB9XG4gICAgaWYgKCFfLmlzT2JqZWN0KGpzb24pKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAnanNvbicgaXMgbm90IGFuIG9iamVjdC5cIik7XG4gICAgfVxuXG4gICAgdGhpcy5faW5pdGlhbGl6ZSgpO1xuICAgIHRoaXMuX3RpbWVzdGFtcCA9IG5ldyBEYXRlKCk7XG4gICAgdGhpcy5fY29udGV4dC5zZXRTdGF0ZShzZXJpYWxpemVyLCBqc29uKTtcbn07XG4vKiBTRVJJQUxJWkFUSU9OICovXG5cbm1vZHVsZS5leHBvcnRzID0gQWN0aXZpdHlFeGVjdXRpb25FbmdpbmU7Il19
