"use strict";
var Activity = require("./activity");
var ActivityExecutionContext = require("./activityExecutionContext");
var ActivityExecutionState = require("./activityExecutionState");
var CallContext = require("./callContext");
var EventEmitter = require('events').EventEmitter;
var util = require("util");
var errors = require("../common/errors");
var _ = require("lodash");
var ActivityStateTracker = require("./activityStateTracker");
var enums = require("../common/enums");
var Bluebird = require("bluebird");
var asyncHelpers = require("../common/asyncHelpers");
var async = asyncHelpers.async;
var activityMarkup = require("./activityMarkup");
function ActivityExecutionEngine(rootActivity, instance) {
  EventEmitter.call(this);
  if (!(rootActivity instanceof Activity)) {
    if (_.isPlainObject(rootActivity)) {
      rootActivity = activityMarkup.parse(rootActivity);
    } else {
      throw new TypeError("Argument 'rootActivity' is not an activity or a markup.");
    }
  }
  this.rootActivity = rootActivity;
  this._context = new ActivityExecutionContext(this);
  this._isInitialized = false;
  this._rootState = null;
  this._trackers = [];
  this._hookContext();
  this._timestamp = null;
  this.instance = instance || null;
}
util.inherits(ActivityExecutionEngine, EventEmitter);
Object.defineProperties(ActivityExecutionEngine.prototype, {
  execState: {get: function() {
      if (this._rootState) {
        return this._rootState.execState;
      } else {
        return null;
      }
    }},
  version: {get: function() {
      return this.rootActivity.version;
    }},
  updatedOn: {get: function() {
      return this._timestamp;
    }}
});
ActivityExecutionEngine.prototype._idle = {toString: function() {
    return enums.ActivityStates.idle;
  }};
ActivityExecutionEngine.prototype.isIdle = function(result) {
  return result === this._idle;
};
ActivityExecutionEngine.prototype._initialize = function() {
  if (!this._isInitialized) {
    this._context.initialize(this.rootActivity);
    this._isInitialized = true;
  }
};
ActivityExecutionEngine.prototype._setRootState = function(state) {
  var self = this;
  if (!self._rootState) {
    self._rootState = state;
    self._rootState.on(Activity.states.cancel, function(args) {
      self.emit(Activity.states.cancel, args);
    });
    self._rootState.on(Activity.states.complete, function(args) {
      self.emit(Activity.states.complete, args);
    });
    self._rootState.on(Activity.states.end, function(args) {
      self._timestamp = new Date();
      self.emit(Activity.states.end, args);
    });
    self._rootState.on(Activity.states.fail, function(args) {
      self.emit(Activity.states.fail, args);
    });
    self._rootState.on(Activity.states.run, function(args) {
      self.emit(Activity.states.run, args);
    });
    self._rootState.on(Activity.states.idle, function(args) {
      self.emit(Activity.states.idle, args);
    });
  }
};
ActivityExecutionEngine.prototype._hookContext = function() {
  var self = this;
  self._context.on(Activity.states.run, function(args) {
    var $__5 = true;
    var $__6 = false;
    var $__7 = undefined;
    try {
      for (var $__3 = void 0,
          $__2 = (self._trackers)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
        var t = $__3.value;
        {
          t.activityStateChanged(args);
        }
      }
    } catch ($__8) {
      $__6 = true;
      $__7 = $__8;
    } finally {
      try {
        if (!$__5 && $__2.return != null) {
          $__2.return();
        }
      } finally {
        if ($__6) {
          throw $__7;
        }
      }
    }
  });
  self._context.on(Activity.states.end, function(args) {
    var $__5 = true;
    var $__6 = false;
    var $__7 = undefined;
    try {
      for (var $__3 = void 0,
          $__2 = (self._trackers)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
        var t = $__3.value;
        {
          t.activityStateChanged(args);
        }
      }
    } catch ($__8) {
      $__6 = true;
      $__7 = $__8;
    } finally {
      try {
        if (!$__5 && $__2.return != null) {
          $__2.return();
        }
      } finally {
        if ($__6) {
          throw $__7;
        }
      }
    }
  });
};
ActivityExecutionEngine.prototype.addTracker = function(tracker) {
  if (!_.isObject(tracker)) {
    throw new TypeError("Parameter is not an object.");
  }
  this._trackers.push(new ActivityStateTracker(tracker));
};
ActivityExecutionEngine.prototype.removeTracker = function(tracker) {
  var idx = -1;
  for (var i = 0; i < this._trackers.length; i++) {
    var t = this._trackers[i];
    if (t._impl === tracker) {
      idx = i;
      break;
    }
  }
  if (idx !== -1) {
    this._trackers.splice(idx, 1);
  }
};
ActivityExecutionEngine.prototype.start = async($traceurRuntime.initGeneratorFunction(function $__9() {
  var args,
      $__5,
      $__6,
      $__7,
      $__3,
      $__2,
      a,
      $__10,
      $__11,
      $__12,
      $__13,
      $__14,
      $__15,
      $__16,
      $__17;
  var $arguments = arguments;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyNotStarted();
          this._initialize();
          args = [new CallContext(this._context)];
          $__5 = true;
          $__6 = false;
          $__7 = undefined;
          try {
            for ($__3 = void 0, $__2 = ($arguments)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
              a = $__3.value;
              {
                args.push(a);
              }
            }
          } catch ($__8) {
            $__6 = true;
            $__7 = $__8;
          } finally {
            try {
              if (!$__5 && $__2.return != null) {
                $__2.return();
              }
            } finally {
              if ($__6) {
                throw $__7;
              }
            }
          }
          $ctx.state = 10;
          break;
        case 10:
          $__10 = this._setRootState;
          $__11 = this.rootActivity;
          $__12 = $__11.start;
          $__13 = $__12.apply;
          $__14 = this.rootActivity;
          $__15 = $__13.call($__12, $__14, args);
          $ctx.state = 6;
          break;
        case 6:
          $ctx.state = 2;
          return $__15;
        case 2:
          $__16 = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          $__17 = $__10.call(this, $__16);
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__9, this);
}));
ActivityExecutionEngine.prototype.invoke = function() {
  var self = this;
  self._verifyNotStarted();
  self._initialize();
  var argRemoveToken = null;
  var args = [];
  var $__5 = true;
  var $__6 = false;
  var $__7 = undefined;
  try {
    for (var $__3 = void 0,
        $__2 = (arguments)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
      var a = $__3.value;
      {
        args.push(a);
      }
    }
  } catch ($__8) {
    $__6 = true;
    $__7 = $__8;
  } finally {
    try {
      if (!$__5 && $__2.return != null) {
        $__2.return();
      }
    } finally {
      if ($__6) {
        throw $__7;
      }
    }
  }
  if (args.length) {
    argRemoveToken = self._context.appendToContext(args);
  }
  args.unshift(new CallContext(self._context));
  return new Bluebird(function(resolve, reject) {
    try {
      self._setRootState(self._context.getExecutionState(self.rootActivity));
      self.once(Activity.states.end, function(eArgs) {
        var reason = eArgs.reason;
        var result = eArgs.result;
        try {
          switch (reason) {
            case Activity.states.complete:
              resolve(result);
              break;
            case Activity.states.cancel:
              reject(new errors.Cancelled());
              break;
            case Activity.states.idle:
              resolve(self._idle);
              break;
            default:
              result = result || new errors.ActivityRuntimeError("Unknown error.");
              reject(result);
              break;
          }
        } finally {
          if (argRemoveToken) {
            self._context.removeFromContext(argRemoveToken);
            argRemoveToken = null;
          }
        }
      });
      self.rootActivity.start.apply(self.rootActivity, args);
    } catch (e) {
      reject(e);
      if (argRemoveToken) {
        self._context.removeFromContext(argRemoveToken);
        argRemoveToken = null;
      }
    }
  });
};
ActivityExecutionEngine.prototype._verifyNotStarted = function() {
  if (!(!this.execState || this.execState === enums.ActivityStates.complete)) {
    throw new errors.ActivityStateExceptionError("Workflow has been already started.");
  }
};
ActivityExecutionEngine.prototype.resumeBookmark = function(name, reason, result) {
  var self = this;
  self._initialize();
  return new Bluebird(function(resolve, reject) {
    try {
      self._setRootState(self._context.getExecutionState(self.rootActivity));
      if (self.execState === enums.ActivityStates.idle) {
        var bmTimestamp = self._context.getBookmarkTimestamp(name);
        self.once(Activity.states.end, function(args) {
          var _reason = args.reason;
          var _result = args.result;
          try {
            if (_reason === enums.ActivityStates.complete || _reason === enums.ActivityStates.idle) {
              var endBmTimestamp = self._context.getBookmarkTimestamp(name);
              if (endBmTimestamp && endBmTimestamp === bmTimestamp) {
                if (_reason === enums.ActivityStates.complete) {
                  reject(new errors.ActivityRuntimeError("Workflow has been completed before bookmark '" + name + "' reached."));
                } else {
                  reject(new errors.Idle("Workflow has been gone to idle before bookmark '" + name + "' reached."));
                }
              } else {
                resolve();
              }
            } else if (_reason === enums.ActivityStates.cancel) {
              reject(new errors.ActivityRuntimeError("Workflow has been cancelled before bookmark '" + name + "' reached."));
            } else if (_reason === enums.ActivityStates.fail) {
              reject(_result);
            }
          } catch (e) {
            reject(e);
          }
        });
        self._context.resumeBookmarkExternal(name, reason, result);
      } else {
        reject(new errors.ActivityRuntimeError("Cannot resume bookmark, while the workflow is not in the idle state."));
      }
    } catch (e) {
      reject(e);
    }
  });
};
ActivityExecutionEngine.prototype.getStateAndPromotions = function(serializer, enablePromotions) {
  if (serializer && !_.isObject(serializer)) {
    throw new Error("Argument 'serializer' is not an object.");
  }
  this._initialize();
  return this._context.getStateAndPromotions(serializer, enablePromotions);
};
ActivityExecutionEngine.prototype.setState = function(serializer, json) {
  if (serializer && !_.isObject(serializer)) {
    throw new Error("Argument 'serializer' is not an object.");
  }
  if (!_.isObject(json)) {
    throw new TypeError("Argument 'json' is not an object.");
  }
  this._initialize();
  this._timestamp = new Date();
  this._context.setState(serializer, json);
};
module.exports = ActivityExecutionEngine;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBRUEsQUFBSSxFQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsWUFBVyxDQUFDLENBQUM7QUFDcEMsQUFBSSxFQUFBLENBQUEsd0JBQXVCLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyw0QkFBMkIsQ0FBQyxDQUFDO0FBQ3BFLEFBQUksRUFBQSxDQUFBLHNCQUFxQixFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsMEJBQXlCLENBQUMsQ0FBQztBQUNoRSxBQUFJLEVBQUEsQ0FBQSxXQUFVLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxlQUFjLENBQUMsQ0FBQztBQUMxQyxBQUFJLEVBQUEsQ0FBQSxZQUFXLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsYUFBYSxDQUFDO0FBQ2pELEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGtCQUFpQixDQUFDLENBQUM7QUFDeEMsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsb0JBQW1CLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyx3QkFBdUIsQ0FBQyxDQUFDO0FBQzVELEFBQUksRUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGlCQUFnQixDQUFDLENBQUM7QUFDdEMsQUFBSSxFQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDbEMsQUFBSSxFQUFBLENBQUEsWUFBVyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsd0JBQXVCLENBQUMsQ0FBQztBQUNw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RUFBQyxDQUFDO0FBQzVCLEtBQUcsU0FBUyxTQUFTLEFBQUMsQ0FBQyxVQUFTLENBQUcsS0FBRyxDQUFDLENBQUM7QUFDNUMsQ0FBQztBQUdELEtBQUssUUFBUSxFQUFJLHdCQUFzQixDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9hY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCBBY3Rpdml0eSA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5XCIpO1xubGV0IEFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dCA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5RXhlY3V0aW9uQ29udGV4dFwiKTtcbmxldCBBY3Rpdml0eUV4ZWN1dGlvblN0YXRlID0gcmVxdWlyZShcIi4vYWN0aXZpdHlFeGVjdXRpb25TdGF0ZVwiKTtcbmxldCBDYWxsQ29udGV4dCA9IHJlcXVpcmUoXCIuL2NhbGxDb250ZXh0XCIpO1xubGV0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjtcbmxldCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5sZXQgZXJyb3JzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lcnJvcnNcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgQWN0aXZpdHlTdGF0ZVRyYWNrZXIgPSByZXF1aXJlKFwiLi9hY3Rpdml0eVN0YXRlVHJhY2tlclwiKTtcbmxldCBlbnVtcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZW51bXNcIik7XG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5sZXQgYXN5bmNIZWxwZXJzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hc3luY0hlbHBlcnNcIik7XG5sZXQgYXN5bmMgPSBhc3luY0hlbHBlcnMuYXN5bmM7XG5sZXQgYWN0aXZpdHlNYXJrdXAgPSByZXF1aXJlKFwiLi9hY3Rpdml0eU1hcmt1cFwiKTtcblxuZnVuY3Rpb24gQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUocm9vdEFjdGl2aXR5LCBpbnN0YW5jZSkge1xuICAgIEV2ZW50RW1pdHRlci5jYWxsKHRoaXMpO1xuXG4gICAgaWYgKCEocm9vdEFjdGl2aXR5IGluc3RhbmNlb2YgQWN0aXZpdHkpKSB7XG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3Qocm9vdEFjdGl2aXR5KSkge1xuICAgICAgICAgICAgcm9vdEFjdGl2aXR5ID0gYWN0aXZpdHlNYXJrdXAucGFyc2Uocm9vdEFjdGl2aXR5KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAncm9vdEFjdGl2aXR5JyBpcyBub3QgYW4gYWN0aXZpdHkgb3IgYSBtYXJrdXAuXCIpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMucm9vdEFjdGl2aXR5ID0gcm9vdEFjdGl2aXR5O1xuICAgIHRoaXMuX2NvbnRleHQgPSBuZXcgQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0KHRoaXMpO1xuICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICB0aGlzLl9yb290U3RhdGUgPSBudWxsO1xuICAgIHRoaXMuX3RyYWNrZXJzID0gW107XG4gICAgdGhpcy5faG9va0NvbnRleHQoKTtcbiAgICB0aGlzLl90aW1lc3RhbXAgPSBudWxsO1xuICAgIHRoaXMuaW5zdGFuY2UgPSBpbnN0YW5jZSB8fCBudWxsO1xufVxuXG51dGlsLmluaGVyaXRzKEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLCBFdmVudEVtaXR0ZXIpO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydGllcyhBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUsIHtcbiAgICBleGVjU3RhdGU6IHtcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fcm9vdFN0YXRlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Jvb3RTdGF0ZS5leGVjU3RhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG4gICAgdmVyc2lvbjoge1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJvb3RBY3Rpdml0eS52ZXJzaW9uO1xuICAgICAgICB9XG4gICAgfSxcbiAgICB1cGRhdGVkT246IHtcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fdGltZXN0YW1wO1xuICAgICAgICB9XG4gICAgfVxufSk7XG5cbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5faWRsZSA9IHtcbiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gZW51bXMuQWN0aXZpdHlTdGF0ZXMuaWRsZTtcbiAgICB9XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuaXNJZGxlID0gZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgIHJldHVybiByZXN1bHQgPT09IHRoaXMuX2lkbGU7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuX2luaXRpYWxpemUgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKCF0aGlzLl9pc0luaXRpYWxpemVkKSB7XG4gICAgICAgIHRoaXMuX2NvbnRleHQuaW5pdGlhbGl6ZSh0aGlzLnJvb3RBY3Rpdml0eSk7XG4gICAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH1cbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5fc2V0Um9vdFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIGlmICghc2VsZi5fcm9vdFN0YXRlKSB7XG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZSA9IHN0YXRlO1xuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuY2FuY2VsLCBmdW5jdGlvbiAoYXJncykge1xuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChBY3Rpdml0eS5zdGF0ZXMuY2FuY2VsLCBhcmdzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUsIGZ1bmN0aW9uIChhcmdzKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZSwgYXJncyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgc2VsZi5fcm9vdFN0YXRlLm9uKFxuICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmVuZCwgZnVuY3Rpb24gKGFyZ3MpIHtcbiAgICAgICAgICAgICAgICBzZWxmLl90aW1lc3RhbXAgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChBY3Rpdml0eS5zdGF0ZXMuZW5kLCBhcmdzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuZmFpbCwgZnVuY3Rpb24gKGFyZ3MpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLmZhaWwsIGFyZ3MpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZS5vbihcbiAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5ydW4sIGZ1bmN0aW9uIChhcmdzKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KEFjdGl2aXR5LnN0YXRlcy5ydW4sIGFyZ3MpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZS5vbihcbiAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5pZGxlLCBmdW5jdGlvbiAoYXJncykge1xuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChBY3Rpdml0eS5zdGF0ZXMuaWRsZSwgYXJncyk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuX2hvb2tDb250ZXh0ID0gZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBzZWxmLl9jb250ZXh0Lm9uKFxuICAgICAgICBBY3Rpdml0eS5zdGF0ZXMucnVuLCBmdW5jdGlvbiAoYXJncykge1xuICAgICAgICAgICAgZm9yIChsZXQgdCBvZiBzZWxmLl90cmFja2Vycykge1xuICAgICAgICAgICAgICAgIHQuYWN0aXZpdHlTdGF0ZUNoYW5nZWQoYXJncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIHNlbGYuX2NvbnRleHQub24oXG4gICAgICAgIEFjdGl2aXR5LnN0YXRlcy5lbmQsIGZ1bmN0aW9uIChhcmdzKSB7XG4gICAgICAgICAgICBmb3IgKGxldCB0IG9mIHNlbGYuX3RyYWNrZXJzKSB7XG4gICAgICAgICAgICAgICAgdC5hY3Rpdml0eVN0YXRlQ2hhbmdlZChhcmdzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuYWRkVHJhY2tlciA9IGZ1bmN0aW9uICh0cmFja2VyKSB7XG4gICAgaWYgKCFfLmlzT2JqZWN0KHRyYWNrZXIpKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJQYXJhbWV0ZXIgaXMgbm90IGFuIG9iamVjdC5cIik7XG4gICAgfVxuICAgIHRoaXMuX3RyYWNrZXJzLnB1c2gobmV3IEFjdGl2aXR5U3RhdGVUcmFja2VyKHRyYWNrZXIpKTtcbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5yZW1vdmVUcmFja2VyID0gZnVuY3Rpb24gKHRyYWNrZXIpIHtcbiAgICBsZXQgaWR4ID0gLTE7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl90cmFja2Vycy5sZW5ndGg7IGkrKykge1xuICAgICAgICBsZXQgdCA9IHRoaXMuX3RyYWNrZXJzW2ldO1xuICAgICAgICBpZiAodC5faW1wbCA9PT0gdHJhY2tlcikge1xuICAgICAgICAgICAgaWR4ID0gaTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChpZHggIT09IC0xKSB7XG4gICAgICAgIHRoaXMuX3RyYWNrZXJzLnNwbGljZShpZHgsIDEpO1xuICAgIH1cbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5zdGFydCA9IGFzeW5jKGZ1bmN0aW9uKiAoKSB7XG4gICAgdGhpcy5fdmVyaWZ5Tm90U3RhcnRlZCgpO1xuXG4gICAgdGhpcy5faW5pdGlhbGl6ZSgpO1xuXG4gICAgbGV0IGFyZ3MgPSBbbmV3IENhbGxDb250ZXh0KHRoaXMuX2NvbnRleHQpXTtcbiAgICBmb3IgKGxldCBhIG9mIGFyZ3VtZW50cykge1xuICAgICAgICBhcmdzLnB1c2goYSk7XG4gICAgfVxuXG4gICAgdGhpcy5fc2V0Um9vdFN0YXRlKHlpZWxkIHRoaXMucm9vdEFjdGl2aXR5LnN0YXJ0LmFwcGx5KHRoaXMucm9vdEFjdGl2aXR5LCBhcmdzKSk7XG59KTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLmludm9rZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG5cbiAgICBzZWxmLl92ZXJpZnlOb3RTdGFydGVkKCk7XG5cbiAgICBzZWxmLl9pbml0aWFsaXplKCk7XG5cbiAgICBsZXQgYXJnUmVtb3ZlVG9rZW4gPSBudWxsO1xuICAgIGxldCBhcmdzID0gW107XG4gICAgZm9yIChsZXQgYSBvZiBhcmd1bWVudHMpIHtcbiAgICAgICAgYXJncy5wdXNoKGEpO1xuICAgIH1cblxuICAgIGlmIChhcmdzLmxlbmd0aCkge1xuICAgICAgICBhcmdSZW1vdmVUb2tlbiA9IHNlbGYuX2NvbnRleHQuYXBwZW5kVG9Db250ZXh0KGFyZ3MpO1xuICAgIH1cblxuICAgIGFyZ3MudW5zaGlmdChuZXcgQ2FsbENvbnRleHQoc2VsZi5fY29udGV4dCkpO1xuXG4gICAgcmV0dXJuIG5ldyBCbHVlYmlyZChmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzZWxmLl9zZXRSb290U3RhdGUoc2VsZi5fY29udGV4dC5nZXRFeGVjdXRpb25TdGF0ZShzZWxmLnJvb3RBY3Rpdml0eSkpO1xuICAgICAgICAgICAgc2VsZi5vbmNlKFxuICAgICAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5lbmQsIGZ1bmN0aW9uIChlQXJncykge1xuICAgICAgICAgICAgICAgICAgICBsZXQgcmVhc29uID0gZUFyZ3MucmVhc29uO1xuICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gZUFyZ3MucmVzdWx0O1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChyZWFzb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEFjdGl2aXR5LnN0YXRlcy5jYW5jZWw6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgZXJyb3JzLkNhbmNlbGxlZCgpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBBY3Rpdml0eS5zdGF0ZXMuaWRsZTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShzZWxmLl9pZGxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdCA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdCB8fCBuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiVW5rbm93biBlcnJvci5cIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChyZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmdSZW1vdmVUb2tlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2NvbnRleHQucmVtb3ZlRnJvbUNvbnRleHQoYXJnUmVtb3ZlVG9rZW4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ1JlbW92ZVRva2VuID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzZWxmLnJvb3RBY3Rpdml0eS5zdGFydC5hcHBseShzZWxmLnJvb3RBY3Rpdml0eSwgYXJncyk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJlamVjdChlKTtcblxuICAgICAgICAgICAgaWYgKGFyZ1JlbW92ZVRva2VuKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5fY29udGV4dC5yZW1vdmVGcm9tQ29udGV4dChhcmdSZW1vdmVUb2tlbik7XG4gICAgICAgICAgICAgICAgYXJnUmVtb3ZlVG9rZW4gPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuX3ZlcmlmeU5vdFN0YXJ0ZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKCEoIXRoaXMuZXhlY1N0YXRlIHx8IHRoaXMuZXhlY1N0YXRlID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5jb21wbGV0ZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eVN0YXRlRXhjZXB0aW9uRXJyb3IoXCJXb3JrZmxvdyBoYXMgYmVlbiBhbHJlYWR5IHN0YXJ0ZWQuXCIpO1xuICAgIH1cbn07XG5cbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5yZXN1bWVCb29rbWFyayA9IGZ1bmN0aW9uIChuYW1lLCByZWFzb24sIHJlc3VsdCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBzZWxmLl9pbml0aWFsaXplKCk7XG4gICAgcmV0dXJuIG5ldyBCbHVlYmlyZChmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzZWxmLl9zZXRSb290U3RhdGUoc2VsZi5fY29udGV4dC5nZXRFeGVjdXRpb25TdGF0ZShzZWxmLnJvb3RBY3Rpdml0eSkpO1xuXG4gICAgICAgICAgICBpZiAoc2VsZi5leGVjU3RhdGUgPT09IGVudW1zLkFjdGl2aXR5U3RhdGVzLmlkbGUpIHtcbiAgICAgICAgICAgICAgICBsZXQgYm1UaW1lc3RhbXAgPSBzZWxmLl9jb250ZXh0LmdldEJvb2ttYXJrVGltZXN0YW1wKG5hbWUpO1xuICAgICAgICAgICAgICAgIHNlbGYub25jZShcbiAgICAgICAgICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmVuZCxcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGFyZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBfcmVhc29uID0gYXJncy5yZWFzb247XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgX3Jlc3VsdCA9IGFyZ3MucmVzdWx0O1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3JlYXNvbiA9PT0gZW51bXMuQWN0aXZpdHlTdGF0ZXMuY29tcGxldGUgfHwgX3JlYXNvbiA9PT0gZW51bXMuQWN0aXZpdHlTdGF0ZXMuaWRsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZW5kQm1UaW1lc3RhbXAgPSBzZWxmLl9jb250ZXh0LmdldEJvb2ttYXJrVGltZXN0YW1wKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kQm1UaW1lc3RhbXAgJiYgZW5kQm1UaW1lc3RhbXAgPT09IGJtVGltZXN0YW1wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3JlYXNvbiA9PT0gZW51bXMuQWN0aXZpdHlTdGF0ZXMuY29tcGxldGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IGVycm9ycy5BY3Rpdml0eVJ1bnRpbWVFcnJvcihcIldvcmtmbG93IGhhcyBiZWVuIGNvbXBsZXRlZCBiZWZvcmUgYm9va21hcmsgJ1wiICsgbmFtZSArIFwiJyByZWFjaGVkLlwiKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IGVycm9ycy5JZGxlKFwiV29ya2Zsb3cgaGFzIGJlZW4gZ29uZSB0byBpZGxlIGJlZm9yZSBib29rbWFyayAnXCIgKyBuYW1lICsgXCInIHJlYWNoZWQuXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChfcmVhc29uID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5jYW5jZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJXb3JrZmxvdyBoYXMgYmVlbiBjYW5jZWxsZWQgYmVmb3JlIGJvb2ttYXJrICdcIiArIG5hbWUgKyBcIicgcmVhY2hlZC5cIikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChfcmVhc29uID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5mYWlsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChfcmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgc2VsZi5fY29udGV4dC5yZXN1bWVCb29rbWFya0V4dGVybmFsKG5hbWUsIHJlYXNvbiwgcmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlamVjdChuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiQ2Fubm90IHJlc3VtZSBib29rbWFyaywgd2hpbGUgdGhlIHdvcmtmbG93IGlzIG5vdCBpbiB0aGUgaWRsZSBzdGF0ZS5cIikpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn07XG5cbi8qIFNFUklBTElaQVRJT04gKi9cbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5nZXRTdGF0ZUFuZFByb21vdGlvbnMgPSBmdW5jdGlvbiAoc2VyaWFsaXplciwgZW5hYmxlUHJvbW90aW9ucykge1xuICAgIGlmIChzZXJpYWxpemVyICYmICFfLmlzT2JqZWN0KHNlcmlhbGl6ZXIpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFyZ3VtZW50ICdzZXJpYWxpemVyJyBpcyBub3QgYW4gb2JqZWN0LlwiKTtcbiAgICB9XG5cbiAgICB0aGlzLl9pbml0aWFsaXplKCk7XG4gICAgcmV0dXJuIHRoaXMuX2NvbnRleHQuZ2V0U3RhdGVBbmRQcm9tb3Rpb25zKHNlcmlhbGl6ZXIsIGVuYWJsZVByb21vdGlvbnMpO1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKHNlcmlhbGl6ZXIsIGpzb24pIHtcbiAgICBpZiAoc2VyaWFsaXplciAmJiAhXy5pc09iamVjdChzZXJpYWxpemVyKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBcmd1bWVudCAnc2VyaWFsaXplcicgaXMgbm90IGFuIG9iamVjdC5cIik7XG4gICAgfVxuICAgIGlmICghXy5pc09iamVjdChqc29uKSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ2pzb24nIGlzIG5vdCBhbiBvYmplY3QuXCIpO1xuICAgIH1cblxuICAgIHRoaXMuX2luaXRpYWxpemUoKTtcbiAgICB0aGlzLl90aW1lc3RhbXAgPSBuZXcgRGF0ZSgpO1xuICAgIHRoaXMuX2NvbnRleHQuc2V0U3RhdGUoc2VyaWFsaXplciwganNvbik7XG59O1xuLyogU0VSSUFMSVpBVElPTiAqL1xuXG5tb2R1bGUuZXhwb3J0cyA9IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lOyJdfQ==
