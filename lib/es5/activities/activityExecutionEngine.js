"use strict";
"use strict";
var Activity = require("./activity");
var ActivityExecutionContext = require("./activityExecutionContext");
var ActivityExecutionState = require("./activityExecutionState");
var CallContext = require("./callContext");
var EventEmitter = require('events').EventEmitter;
var util = require("util");
var errors = require("../common/errors");
var _ = require("lodash");
var ActivityStateTracker = require("./activityStateTracker");
var enums = require("../common/enums");
var Promise = require("bluebird");
var asyncHelpers = require("../common/asyncHelpers");
var async = asyncHelpers.async;
var activityMarkup = require("./activityMarkup");
function ActivityExecutionEngine(rootActivity) {
  if (!(rootActivity instanceof Activity)) {
    if (_.isPlainObject(rootActivity)) {
      rootActivity = activityMarkup.parse(rootActivity);
    } else {
      throw new TypeError("Argument 'rootActivity' is not an activity or a markup.");
    }
  }
  this._rootActivity = rootActivity;
  this._context = new ActivityExecutionContext();
  this._isInitialized = false;
  this._rootState = null;
  this._trackers = [];
  this._hookContext();
  this._timestamp = null;
}
util.inherits(ActivityExecutionEngine, EventEmitter);
Object.defineProperties(ActivityExecutionEngine.prototype, {
  rootActivity: {get: function() {
      return this._rootActivity;
    }},
  execState: {get: function() {
      if (this._rootState) {
        return this._rootState.execState;
      } else {
        return null;
      }
    }},
  version: {get: function() {
      return this._rootActivity.version;
    }},
  updatedOn: {get: function() {
      return this._timestamp;
    }}
});
ActivityExecutionEngine.prototype._idle = {toString: function() {
    return enums.ActivityStates.idle;
  }};
ActivityExecutionEngine.prototype.isIdle = function(result) {
  return result === this._idle;
};
ActivityExecutionEngine.prototype._initialize = function() {
  if (!this._isInitialized) {
    this._context.initialize(this._rootActivity);
    this._isInitialized = true;
  }
};
ActivityExecutionEngine.prototype._setRootState = function(state) {
  var self = this;
  if (!self._rootState) {
    self._rootState = state;
    self._rootState.on(Activity.states.cancel, function() {
      self.emit(Activity.states.cancel);
    });
    self._rootState.on(Activity.states.complete, function(result) {
      self.emit(Activity.states.complete, result);
    });
    self._rootState.on(Activity.states.end, function(reason, result) {
      self._timestamp = new Date();
      self.emit(Activity.states.end, reason, result);
    });
    self._rootState.on(Activity.states.fail, function(e) {
      self.emit(Activity.states.fail, e);
    });
    self._rootState.on(Activity.states.run, function() {
      self.emit(Activity.states.run);
    });
    self._rootState.on(Activity.states.idle, function() {
      self.emit(Activity.states.idle);
    });
  }
};
ActivityExecutionEngine.prototype._hookContext = function() {
  var self = this;
  self._context.on(Activity.states.run, function(activity) {
    var $__3 = true;
    var $__4 = false;
    var $__5 = undefined;
    try {
      for (var $__1 = void 0,
          $__0 = (self._trackers)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
        var t = $__1.value;
        {
          t.activityStateChanged(activity, Activity.states.run);
        }
      }
    } catch ($__6) {
      $__4 = true;
      $__5 = $__6;
    } finally {
      try {
        if (!$__3 && $__0.return != null) {
          $__0.return();
        }
      } finally {
        if ($__4) {
          throw $__5;
        }
      }
    }
  });
  self._context.on(Activity.states.end, function(activity, reason, result) {
    var $__3 = true;
    var $__4 = false;
    var $__5 = undefined;
    try {
      for (var $__1 = void 0,
          $__0 = (self._trackers)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
        var t = $__1.value;
        {
          t.activityStateChanged(activity, reason, result);
        }
      }
    } catch ($__6) {
      $__4 = true;
      $__5 = $__6;
    } finally {
      try {
        if (!$__3 && $__0.return != null) {
          $__0.return();
        }
      } finally {
        if ($__4) {
          throw $__5;
        }
      }
    }
  });
};
ActivityExecutionEngine.prototype.addTracker = function(tracker) {
  if (!_.isObject(tracker)) {
    throw new TypeError("Parameter is not an object.");
  }
  this._trackers.push(new ActivityStateTracker(tracker));
};
ActivityExecutionEngine.prototype.removeTracker = function(tracker) {
  var idx = -1;
  for (var i = 0; i < this._trackers.length; i++) {
    var t = this._trackers[i];
    if (t._impl === tracker) {
      idx = i;
      break;
    }
  }
  if (idx !== -1) {
    this._trackers.splice(idx, 1);
  }
};
ActivityExecutionEngine.prototype.start = async($traceurRuntime.initGeneratorFunction(function $__7() {
  var args,
      $__3,
      $__4,
      $__5,
      $__1,
      $__0,
      a,
      $__8,
      $__9,
      $__10,
      $__11,
      $__12,
      $__13,
      $__14,
      $__15;
  var $arguments = arguments;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyNotStarted();
          this._initialize();
          args = [new CallContext(this._context)];
          $__3 = true;
          $__4 = false;
          $__5 = undefined;
          try {
            for ($__1 = void 0, $__0 = ($arguments)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
              a = $__1.value;
              {
                args.push(a);
              }
            }
          } catch ($__6) {
            $__4 = true;
            $__5 = $__6;
          } finally {
            try {
              if (!$__3 && $__0.return != null) {
                $__0.return();
              }
            } finally {
              if ($__4) {
                throw $__5;
              }
            }
          }
          $ctx.state = 10;
          break;
        case 10:
          $__8 = this._setRootState;
          $__9 = this._rootActivity;
          $__10 = $__9.start;
          $__11 = $__10.apply;
          $__12 = this._rootActivity;
          $__13 = $__11.call($__10, $__12, args);
          $ctx.state = 6;
          break;
        case 6:
          $ctx.state = 2;
          return $__13;
        case 2:
          $__14 = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          $__15 = $__8.call(this, $__14);
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__7, this);
}));
ActivityExecutionEngine.prototype.invoke = function() {
  var self = this;
  self._verifyNotStarted();
  self._initialize();
  var argRemoveToken = null;
  var args = [];
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (arguments)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var a = $__1.value;
      {
        args.push(a);
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
  if (args.length) {
    argRemoveToken = self._context.appendToContext(args);
  }
  args.unshift(new CallContext(self._context));
  return new Promise(function(resolve, reject) {
    try {
      self._setRootState(self._context.getState(self._rootActivity.instanceId));
      self.once(Activity.states.end, function(reason, result) {
        try {
          switch (reason) {
            case Activity.states.complete:
              resolve(result);
              break;
            case Activity.states.cancel:
              reject(new errors.Cancelled());
              break;
            case Activity.states.idle:
              resolve(self._idle);
              break;
            default:
              result = result || new errors.ActivityRuntimeError("Unknown error.");
              reject(result);
              break;
          }
        } finally {
          if (argRemoveToken) {
            self._context.removeFromContext(argRemoveToken);
            argRemoveToken = null;
          }
        }
      });
      self._rootActivity.start.apply(self._rootActivity, args);
    } catch (e) {
      reject(e);
      if (argRemoveToken) {
        self._context.removeFromContext(argRemoveToken);
        argRemoveToken = null;
      }
    }
  });
};
ActivityExecutionEngine.prototype._verifyNotStarted = function() {
  if (this.execState) {
    throw new errors.ActivityStateExceptionError("Workflow has been started already.");
  }
};
ActivityExecutionEngine.prototype.resumeBookmark = function(name, reason, result) {
  var self = this;
  self._initialize();
  return new Promise(function(resolve, reject) {
    try {
      self._setRootState(self._context.getState(self._rootActivity.instanceId));
      if (self.execState === enums.ActivityStates.idle) {
        var bmTimestamp = self._context.getBookmarkTimestamp(name);
        self.once(Activity.states.end, function(_reason, _result) {
          try {
            if (_reason === enums.ActivityStates.complete || _reason === enums.ActivityStates.idle) {
              var endBmTimestamp = self._context.getBookmarkTimestamp(name);
              if (endBmTimestamp && endBmTimestamp === bmTimestamp) {
                if (_reason === enums.ActivityStates.complete) {
                  reject(new errors.ActivityRuntimeError("Workflow has been completed before bookmark '" + name + "' reached."));
                } else {
                  reject(new errors.Idle("Workflow has been gone to idle before bookmark '" + name + "' reached."));
                }
              } else {
                resolve();
              }
            } else if (_reason === enums.ActivityStates.cancel) {
              reject(new errors.ActivityRuntimeError("Workflow has been cancelled before bookmark '" + name + "' reached."));
            } else if (_reason === enums.ActivityStates.fail) {
              reject(_result);
            }
          } catch (e) {
            reject(e);
          }
        });
        self._context.resumeBookmarkExternal(name, reason, result);
      } else {
        reject(new errors.ActivityRuntimeError("Cannot resume bookmark, while the workflow is not in the idle state."));
      }
    } catch (e) {
      reject(e);
    }
  });
};
ActivityExecutionEngine.prototype.getStateAndPromotions = function(serializer, getPromotions) {
  if (serializer && !_.isObject(serializer)) {
    throw new Error("Argument 'serializer' is not an object.");
  }
  this._initialize();
  return this._context.getStateAndPromotions(serializer, getPromotions);
};
ActivityExecutionEngine.prototype.setState = function(serializer, json) {
  if (serializer && !_.isObject(serializer)) {
    throw new Error("Argument 'serializer' is not an object.");
  }
  if (!_.isObject(json)) {
    throw new TypeError("Argument 'json' is not an object.");
  }
  this._initialize();
  this._timestamp = new Date();
  this._context.setState(serializer, json);
};
module.exports = ActivityExecutionEngine;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsV0FBVyxDQUFDO0FBRVosQUFBSSxFQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsWUFBVyxDQUFDLENBQUM7QUFDcEMsQUFBSSxFQUFBLENBQUEsd0JBQXVCLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyw0QkFBMkIsQ0FBQyxDQUFDO0FBQ3BFLEFBQUksRUFBQSxDQUFBLHNCQUFxQixFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsMEJBQXlCLENBQUMsQ0FBQztBQUNoRSxBQUFJLEVBQUEsQ0FBQSxXQUFVLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxlQUFjLENBQUMsQ0FBQztBQUMxQyxBQUFJLEVBQUEsQ0FBQSxZQUFXLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsYUFBYSxDQUFDO0FBQ2pELEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGtCQUFpQixDQUFDLENBQUM7QUFDeEMsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsb0JBQW1CLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyx3QkFBdUIsQ0FBQyxDQUFDO0FBQzVELEFBQUksRUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGlCQUFnQixDQUFDLENBQUM7QUFDdEMsQUFBSSxFQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDakMsQUFBSSxFQUFBLENBQUEsWUFBVyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsd0JBQXVCLENBQUMsQ0FBQztBQUNwRCxBQUFJLEVBQUEsQ0FBQSxLQUFJLEVBQUksQ0FBQSxZQUFXLE1BQU0sQ0FBQztBQUM5QixBQUFJLEVBQUEsQ0FBQSxjQUFhLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxrQkFBaUIsQ0FBQyxDQUFDO0FBRWhELE9BQVMsd0JBQXNCLENBQUUsWUFBVyxDQUFHO0FBQzNDLEtBQUksQ0FBQyxDQUFDLFlBQVcsV0FBYSxTQUFPLENBQUMsQ0FBRztBQUNyQyxPQUFJLENBQUEsY0FBYyxBQUFDLENBQUMsWUFBVyxDQUFDLENBQUc7QUFDL0IsaUJBQVcsRUFBSSxDQUFBLGNBQWEsTUFBTSxBQUFDLENBQUMsWUFBVyxDQUFDLENBQUM7SUFDckQsS0FDSztBQUNELFVBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyx5REFBd0QsQ0FBQyxDQUFDO0lBQ2xGO0FBQUEsRUFDSjtBQUFBLEFBQ0EsS0FBRyxjQUFjLEVBQUksYUFBVyxDQUFDO0FBQ2pDLEtBQUcsU0FBUyxFQUFJLElBQUkseUJBQXVCLEFBQUMsRUFBQyxDQUFDO0FBQzlDLEtBQUcsZUFBZSxFQUFJLE1BQUksQ0FBQztBQUMzQixLQUFHLFdBQVcsRUFBSSxLQUFHLENBQUM7QUFDdEIsS0FBRyxVQUFVLEVBQUksR0FBQyxDQUFDO0FBQ25CLEtBQUcsYUFBYSxBQUFDLEVBQUMsQ0FBQztBQUNuQixLQUFHLFdBQVcsRUFBSSxLQUFHLENBQUM7QUFDMUI7QUFBQSxBQUVBLEdBQUcsU0FBUyxBQUFDLENBQUMsdUJBQXNCLENBQUcsYUFBVyxDQUFDLENBQUM7QUFFcEQsS0FBSyxpQkFBaUIsQUFBQyxDQUFDLHVCQUFzQixVQUFVLENBQUc7QUFDdkQsYUFBVyxDQUFHLEVBQ1YsR0FBRSxDQUFHLFVBQVUsQUFBRCxDQUFHO0FBQ2IsV0FBTyxDQUFBLElBQUcsY0FBYyxDQUFDO0lBQzdCLENBQ0o7QUFDQSxVQUFRLENBQUcsRUFDUCxHQUFFLENBQUcsVUFBVSxBQUFELENBQUc7QUFDYixTQUFJLElBQUcsV0FBVyxDQUFHO0FBQ2pCLGFBQU8sQ0FBQSxJQUFHLFdBQVcsVUFBVSxDQUFDO01BQ3BDLEtBQ0s7QUFDRCxhQUFPLEtBQUcsQ0FBQztNQUNmO0FBQUEsSUFDSixDQUNKO0FBQ0EsUUFBTSxDQUFHLEVBQ0wsR0FBRSxDQUFHLFVBQVUsQUFBRCxDQUFHO0FBQ2IsV0FBTyxDQUFBLElBQUcsY0FBYyxRQUFRLENBQUM7SUFDckMsQ0FDSjtBQUNBLFVBQVEsQ0FBRyxFQUNQLEdBQUUsQ0FBRyxVQUFVLEFBQUQsQ0FBRztBQUNiLFdBQU8sQ0FBQSxJQUFHLFdBQVcsQ0FBQztJQUMxQixDQUNKO0FBQUEsQUFDSixDQUFDLENBQUM7QUFFRixzQkFBc0IsVUFBVSxNQUFNLEVBQUksRUFDdEMsUUFBTyxDQUFHLFVBQVUsQUFBRCxDQUFHO0FBQ2xCLFNBQU8sQ0FBQSxLQUFJLGVBQWUsS0FBSyxDQUFDO0VBQ3BDLENBQ0osQ0FBQztBQUVELHNCQUFzQixVQUFVLE9BQU8sRUFBSSxVQUFVLE1BQUssQ0FBRztBQUN6RCxPQUFPLENBQUEsTUFBSyxJQUFNLENBQUEsSUFBRyxNQUFNLENBQUM7QUFDaEMsQ0FBQztBQUVELHNCQUFzQixVQUFVLFlBQVksRUFBSSxVQUFVLEFBQUQsQ0FBRztBQUN4RCxLQUFJLENBQUMsSUFBRyxlQUFlLENBQUc7QUFDdEIsT0FBRyxTQUFTLFdBQVcsQUFBQyxDQUFDLElBQUcsY0FBYyxDQUFDLENBQUM7QUFDNUMsT0FBRyxlQUFlLEVBQUksS0FBRyxDQUFDO0VBQzlCO0FBQUEsQUFDSixDQUFDO0FBRUQsc0JBQXNCLFVBQVUsY0FBYyxFQUFJLFVBQVUsS0FBSSxDQUFHO0FBQy9ELEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixLQUFJLENBQUMsSUFBRyxXQUFXLENBQUc7QUFDbEIsT0FBRyxXQUFXLEVBQUksTUFBSSxDQUFDO0FBQ3ZCLE9BQUcsV0FBVyxHQUFHLEFBQUMsQ0FDZCxRQUFPLE9BQU8sT0FBTyxDQUFHLFVBQVUsQUFBRCxDQUFHO0FBQ2hDLFNBQUcsS0FBSyxBQUFDLENBQUMsUUFBTyxPQUFPLE9BQU8sQ0FBQyxDQUFDO0lBQ3JDLENBQUMsQ0FBQztBQUNOLE9BQUcsV0FBVyxHQUFHLEFBQUMsQ0FDZCxRQUFPLE9BQU8sU0FBUyxDQUFHLFVBQVUsTUFBSyxDQUFHO0FBQ3hDLFNBQUcsS0FBSyxBQUFDLENBQUMsUUFBTyxPQUFPLFNBQVMsQ0FBRyxPQUFLLENBQUMsQ0FBQztJQUMvQyxDQUFDLENBQUM7QUFDTixPQUFHLFdBQVcsR0FBRyxBQUFDLENBQ2QsUUFBTyxPQUFPLElBQUksQ0FBRyxVQUFVLE1BQUssQ0FBRyxDQUFBLE1BQUssQ0FBRztBQUMzQyxTQUFHLFdBQVcsRUFBSSxJQUFJLEtBQUcsQUFBQyxFQUFDLENBQUM7QUFDNUIsU0FBRyxLQUFLLEFBQUMsQ0FBQyxRQUFPLE9BQU8sSUFBSSxDQUFHLE9BQUssQ0FBRyxPQUFLLENBQUMsQ0FBQztJQUNsRCxDQUFDLENBQUM7QUFDTixPQUFHLFdBQVcsR0FBRyxBQUFDLENBQ2QsUUFBTyxPQUFPLEtBQUssQ0FBRyxVQUFVLENBQUEsQ0FBRztBQUMvQixTQUFHLEtBQUssQUFBQyxDQUFDLFFBQU8sT0FBTyxLQUFLLENBQUcsRUFBQSxDQUFDLENBQUM7SUFDdEMsQ0FBQyxDQUFDO0FBQ04sT0FBRyxXQUFXLEdBQUcsQUFBQyxDQUNkLFFBQU8sT0FBTyxJQUFJLENBQUcsVUFBVSxBQUFELENBQUc7QUFDN0IsU0FBRyxLQUFLLEFBQUMsQ0FBQyxRQUFPLE9BQU8sSUFBSSxDQUFDLENBQUM7SUFDbEMsQ0FBQyxDQUFDO0FBQ04sT0FBRyxXQUFXLEdBQUcsQUFBQyxDQUNkLFFBQU8sT0FBTyxLQUFLLENBQUcsVUFBVSxBQUFELENBQUc7QUFDOUIsU0FBRyxLQUFLLEFBQUMsQ0FBQyxRQUFPLE9BQU8sS0FBSyxDQUFDLENBQUM7SUFDbkMsQ0FBQyxDQUFDO0VBQ1Y7QUFBQSxBQUNKLENBQUM7QUFFRCxzQkFBc0IsVUFBVSxhQUFhLEVBQUksVUFBVSxBQUFEO0FBQ3RELEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixLQUFHLFNBQVMsR0FBRyxBQUFDLENBQ1osUUFBTyxPQUFPLElBQUksQ0FBRyxVQUFVLFFBQU87QUFwSHRDLEFBQUksTUFBQSxPQUFvQixLQUFHLENBQUM7QUFDNUIsQUFBSSxNQUFBLE9BQW9CLE1BQUksQ0FBQztBQUM3QixBQUFJLE1BQUEsT0FBb0IsVUFBUSxDQUFDO0FBQ2pDLE1BQUk7QUFISixVQUFTLEdBQUEsT0FEakIsS0FBSyxFQUFBLEFBQzRCO0FBQ2hCLGVBQW9CLENBQUEsQ0FvSFgsSUFBRyxVQUFVLENBcEhnQixDQUNsQyxlQUFjLFdBQVcsQUFBQyxDQUFDLE1BQUssU0FBUyxDQUFDLENBQUMsQUFBQyxFQUFDLENBQ3JELEVBQUMsQ0FBQyxNQUFvQixDQUFBLENBQUMsTUFBb0IsQ0FBQSxTQUFxQixBQUFDLEVBQUMsQ0FBQyxLQUFLLENBQUMsQ0FDekUsT0FBb0IsS0FBRyxDQUFHO1VBaUhsQixFQUFBO0FBQXFCO0FBQzFCLFVBQUEscUJBQXFCLEFBQUMsQ0FBQyxRQUFPLENBQUcsQ0FBQSxRQUFPLE9BQU8sSUFBSSxDQUFDLENBQUM7UUFDekQ7TUFoSEo7QUFBQSxJQUZBLENBQUUsWUFBMEI7QUFDMUIsV0FBb0IsS0FBRyxDQUFDO0FBQ3hCLGdCQUFvQyxDQUFDO0lBQ3ZDLENBQUUsT0FBUTtBQUNSLFFBQUk7QUFDRixXQUFJLEtBQWlCLEdBQUssQ0FBQSxXQUF1QixHQUFLLEtBQUcsQ0FBRztBQUMxRCxvQkFBd0IsQUFBQyxFQUFDLENBQUM7UUFDN0I7QUFBQSxNQUNGLENBQUUsT0FBUTtBQUNSLGdCQUF3QjtBQUN0QixvQkFBd0I7UUFDMUI7QUFBQSxNQUNGO0FBQUEsSUFDRjtBQUFBLEVBc0dBLENBQUMsQ0FBQztBQUNOLEtBQUcsU0FBUyxHQUFHLEFBQUMsQ0FDWixRQUFPLE9BQU8sSUFBSSxDQUFHLFVBQVUsUUFBTyxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSztBQTFIdEQsQUFBSSxNQUFBLE9BQW9CLEtBQUcsQ0FBQztBQUM1QixBQUFJLE1BQUEsT0FBb0IsTUFBSSxDQUFDO0FBQzdCLEFBQUksTUFBQSxPQUFvQixVQUFRLENBQUM7QUFDakMsTUFBSTtBQUhKLFVBQVMsR0FBQSxPQURqQixLQUFLLEVBQUEsQUFDNEI7QUFDaEIsZUFBb0IsQ0FBQSxDQTBIWCxJQUFHLFVBQVUsQ0ExSGdCLENBQ2xDLGVBQWMsV0FBVyxBQUFDLENBQUMsTUFBSyxTQUFTLENBQUMsQ0FBQyxBQUFDLEVBQUMsQ0FDckQsRUFBQyxDQUFDLE1BQW9CLENBQUEsQ0FBQyxNQUFvQixDQUFBLFNBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RSxPQUFvQixLQUFHLENBQUc7VUF1SGxCLEVBQUE7QUFBcUI7QUFDMUIsVUFBQSxxQkFBcUIsQUFBQyxDQUFDLFFBQU8sQ0FBRyxPQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7UUFDcEQ7TUF0SEo7QUFBQSxJQUZBLENBQUUsWUFBMEI7QUFDMUIsV0FBb0IsS0FBRyxDQUFDO0FBQ3hCLGdCQUFvQyxDQUFDO0lBQ3ZDLENBQUUsT0FBUTtBQUNSLFFBQUk7QUFDRixXQUFJLEtBQWlCLEdBQUssQ0FBQSxXQUF1QixHQUFLLEtBQUcsQ0FBRztBQUMxRCxvQkFBd0IsQUFBQyxFQUFDLENBQUM7UUFDN0I7QUFBQSxNQUNGLENBQUUsT0FBUTtBQUNSLGdCQUF3QjtBQUN0QixvQkFBd0I7UUFDMUI7QUFBQSxNQUNGO0FBQUEsSUFDRjtBQUFBLEVBNEdBLENBQUMsQ0FBQztBQUNWLENBQUM7QUFFRCxzQkFBc0IsVUFBVSxXQUFXLEVBQUksVUFBVSxPQUFNLENBQUc7QUFDOUQsS0FBSSxDQUFDLENBQUEsU0FBUyxBQUFDLENBQUMsT0FBTSxDQUFDLENBQUc7QUFDdEIsUUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLDZCQUE0QixDQUFDLENBQUM7RUFDdEQ7QUFBQSxBQUNBLEtBQUcsVUFBVSxLQUFLLEFBQUMsQ0FBQyxHQUFJLHFCQUFtQixBQUFDLENBQUMsT0FBTSxDQUFDLENBQUMsQ0FBQztBQUMxRCxDQUFDO0FBRUQsc0JBQXNCLFVBQVUsY0FBYyxFQUFJLFVBQVUsT0FBTSxDQUFHO0FBQ2pFLEFBQUksSUFBQSxDQUFBLEdBQUUsRUFBSSxFQUFDLENBQUEsQ0FBQztBQUNaLGFBQWEsRUFBQSxDQUFHLENBQUEsQ0FBQSxFQUFJLENBQUEsSUFBRyxVQUFVLE9BQU8sQ0FBRyxDQUFBLENBQUEsRUFBRSxDQUFHO0FBQzVDLEFBQUksTUFBQSxDQUFBLENBQUEsRUFBSSxDQUFBLElBQUcsVUFBVSxDQUFFLENBQUEsQ0FBQyxDQUFDO0FBQ3pCLE9BQUksQ0FBQSxNQUFNLElBQU0sUUFBTSxDQUFHO0FBQ3JCLFFBQUUsRUFBSSxFQUFBLENBQUM7QUFDUCxXQUFLO0lBQ1Q7QUFBQSxFQUNKO0FBQUEsQUFDQSxLQUFJLEdBQUUsSUFBTSxFQUFDLENBQUEsQ0FBRztBQUNaLE9BQUcsVUFBVSxPQUFPLEFBQUMsQ0FBQyxHQUFFLENBQUcsRUFBQSxDQUFDLENBQUM7RUFDakM7QUFBQSxBQUNKLENBQUM7QUFFRCxzQkFBc0IsVUFBVSxNQUFNLEVBQUksQ0FBQSxLQUFJLEFBQUMsQ0F2Si9DLGVBQWMsc0JBQXNCLEFBQUMsQ0F1SlcsY0FBVyxBQUFEOzs7Ozs7Ozs7Ozs7Ozs7O0FBdkoxRCxBQUFJLElBQUEsQ0FBQSxVQUFTLEVBQUksVUFBUSxDQUFDO0FBQTFCLE9BQU8sQ0FBUCxlQUFjLHdCQUF3QixBQUFkLENBQXhCLFNBQVMsSUFBRyxDQUFHO0FBQ1QsVUFBTyxJQUFHOzs7QUF1SlosYUFBRyxrQkFBa0IsQUFBQyxFQUFDLENBQUM7QUFFeEIsYUFBRyxZQUFZLEFBQUMsRUFBQyxDQUFDO2VBRVAsRUFBQyxHQUFJLFlBQVUsQUFBQyxDQUFDLElBQUcsU0FBUyxDQUFDLENBQUM7ZUEzSmQsS0FBRztlQUNILE1BQUk7ZUFDSixVQUFRO0FBQ2hDLFlBQUk7QUFISixzQkFEUixLQUFLLEVBQUEsUUFFZ0MsQ0FBQSxZQUFrQixDQUNsQyxlQUFjLFdBQVcsQUFBQyxDQUFDLE1BQUssU0FBUyxDQUFDLENBQUMsQUFBQyxFQUFDLENBQ3JELEVBQUMsQ0FBQyxNQUFvQixDQUFBLENBQUMsTUFBb0IsQ0FBQSxTQUFxQixBQUFDLEVBQUMsQ0FBQyxLQUFLLENBQUMsQ0FDekUsT0FBb0IsS0FBRyxDQUFHOztBQXdKVjtBQUNyQixtQkFBRyxLQUFLLEFBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQztjQUNoQjtZQXZKSTtBQUFBLFVBRkEsQ0FBRSxZQUEwQjtBQUMxQixpQkFBb0IsS0FBRyxDQUFDO0FBQ3hCLHNCQUFvQyxDQUFDO1VBQ3ZDLENBQUUsT0FBUTtBQUNSLGNBQUk7QUFDRixpQkFBSSxLQUFpQixHQUFLLENBQUEsV0FBdUIsR0FBSyxLQUFHLENBQUc7QUFDMUQsMEJBQXdCLEFBQUMsRUFBQyxDQUFDO2NBQzdCO0FBQUEsWUFDRixDQUFFLE9BQVE7QUFDUixzQkFBd0I7QUFDdEIsMEJBQXdCO2NBQzFCO0FBQUEsWUFDRjtBQUFBLFVBQ0Y7QUFBQTs7O2VBOElKLENBQUEsSUFBRyxjQUFjO2VBQVEsQ0FBQSxJQUFHLGNBQWM7Z0JBQWpCLFdBQXVCO2dCQUF2QixZQUE2QjtnQkFBRSxDQUFBLElBQUcsY0FBYztnQkFBaEQsV0FBOEIsY0FBcUIsS0FBRyxDQUFDOzs7OztBQWpLcEYsc0JBQXVCOztnQkFBdkIsQ0FBQSxJQUFHLEtBQUs7Ozs7Z0JBaUtKLFVBQWtCLENBQWxCLElBQUcsUUFBOEU7Ozs7QUFqS3JGLGVBQU8sQ0FBQSxJQUFHLElBQUksQUFBQyxFQUFDLENBQUE7O0FBQ21CLEVBQy9CLE9BQTZCLEtBQUcsQ0FBQyxDQUFDO0FBZ0t0QyxDQWxLdUQsQ0FrS3RELENBQUM7QUFFRixzQkFBc0IsVUFBVSxPQUFPLEVBQUksVUFBVSxBQUFEO0FBQ2hELEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFFZixLQUFHLGtCQUFrQixBQUFDLEVBQUMsQ0FBQztBQUV4QixLQUFHLFlBQVksQUFBQyxFQUFDLENBQUM7QUFFbEIsQUFBSSxJQUFBLENBQUEsY0FBYSxFQUFJLEtBQUcsQ0FBQztBQUN6QixBQUFJLElBQUEsQ0FBQSxJQUFHLEVBQUksR0FBQyxDQUFDO0FBM0tULEFBQUksSUFBQSxPQUFvQixLQUFHLENBQUM7QUFDNUIsQUFBSSxJQUFBLE9BQW9CLE1BQUksQ0FBQztBQUM3QixBQUFJLElBQUEsT0FBb0IsVUFBUSxDQUFDO0FBQ2pDLElBQUk7QUFISixRQUFTLEdBQUEsT0FEakIsS0FBSyxFQUFBLEFBQzRCO0FBQ2hCLGFBQW9CLENBQUEsQ0EyS25CLFNBQVEsQ0EzSzZCLENBQ2xDLGVBQWMsV0FBVyxBQUFDLENBQUMsTUFBSyxTQUFTLENBQUMsQ0FBQyxBQUFDLEVBQUMsQ0FDckQsRUFBQyxDQUFDLE1BQW9CLENBQUEsQ0FBQyxNQUFvQixDQUFBLFNBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RSxPQUFvQixLQUFHLENBQUc7UUF3SzFCLEVBQUE7QUFBZ0I7QUFDckIsV0FBRyxLQUFLLEFBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQztNQUNoQjtJQXZLSTtBQUFBLEVBRkEsQ0FBRSxZQUEwQjtBQUMxQixTQUFvQixLQUFHLENBQUM7QUFDeEIsY0FBb0MsQ0FBQztFQUN2QyxDQUFFLE9BQVE7QUFDUixNQUFJO0FBQ0YsU0FBSSxLQUFpQixHQUFLLENBQUEsV0FBdUIsR0FBSyxLQUFHLENBQUc7QUFDMUQsa0JBQXdCLEFBQUMsRUFBQyxDQUFDO01BQzdCO0FBQUEsSUFDRixDQUFFLE9BQVE7QUFDUixjQUF3QjtBQUN0QixrQkFBd0I7TUFDMUI7QUFBQSxJQUNGO0FBQUEsRUFDRjtBQUFBLEFBOEpKLEtBQUksSUFBRyxPQUFPLENBQUc7QUFDYixpQkFBYSxFQUFJLENBQUEsSUFBRyxTQUFTLGdCQUFnQixBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7RUFDeEQ7QUFBQSxBQUVBLEtBQUcsUUFBUSxBQUFDLENBQUMsR0FBSSxZQUFVLEFBQUMsQ0FBQyxJQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUM7QUFFNUMsT0FBTyxJQUFJLFFBQU0sQUFBQyxDQUFDLFNBQVUsT0FBTSxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQzFDLE1BQUk7QUFDQSxTQUFHLGNBQWMsQUFBQyxDQUFDLElBQUcsU0FBUyxTQUFTLEFBQUMsQ0FBQyxJQUFHLGNBQWMsV0FBVyxDQUFDLENBQUMsQ0FBQztBQUN6RSxTQUFHLEtBQUssQUFBQyxDQUNMLFFBQU8sT0FBTyxJQUFJLENBQUcsVUFBVSxNQUFLLENBQUcsQ0FBQSxNQUFLLENBQUc7QUFDM0MsVUFBSTtBQUNBLGlCQUFRLE1BQUs7QUFDVCxlQUFLLENBQUEsUUFBTyxPQUFPLFNBQVM7QUFDeEIsb0JBQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQ2YsbUJBQUs7QUFBQSxBQUNULGVBQUssQ0FBQSxRQUFPLE9BQU8sT0FBTztBQUN0QixtQkFBSyxBQUFDLENBQUMsR0FBSSxDQUFBLE1BQUssVUFBVSxBQUFDLEVBQUMsQ0FBQyxDQUFDO0FBQzlCLG1CQUFLO0FBQUEsQUFDVCxlQUFLLENBQUEsUUFBTyxPQUFPLEtBQUs7QUFDcEIsb0JBQU0sQUFBQyxDQUFDLElBQUcsTUFBTSxDQUFDLENBQUM7QUFDbkIsbUJBQUs7QUFBQSxBQUNUO0FBQ0ksbUJBQUssRUFBSSxDQUFBLE1BQUssR0FBSyxJQUFJLENBQUEsTUFBSyxxQkFBcUIsQUFBQyxDQUFDLGdCQUFlLENBQUMsQ0FBQztBQUNwRSxtQkFBSyxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7QUFDZCxtQkFBSztBQUhELFVBSVo7UUFDSixDQUNBLE9BQVE7QUFDSixhQUFJLGNBQWEsQ0FBRztBQUNoQixlQUFHLFNBQVMsa0JBQWtCLEFBQUMsQ0FBQyxjQUFhLENBQUMsQ0FBQztBQUMvQyx5QkFBYSxFQUFJLEtBQUcsQ0FBQztVQUN6QjtBQUFBLFFBQ0o7QUFBQSxNQUNKLENBQUMsQ0FBQztBQUVOLFNBQUcsY0FBYyxNQUFNLE1BQU0sQUFBQyxDQUFDLElBQUcsY0FBYyxDQUFHLEtBQUcsQ0FBQyxDQUFDO0lBQzVELENBQ0EsT0FBTyxDQUFBLENBQUc7QUFDTixXQUFLLEFBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQztBQUVULFNBQUksY0FBYSxDQUFHO0FBQ2hCLFdBQUcsU0FBUyxrQkFBa0IsQUFBQyxDQUFDLGNBQWEsQ0FBQyxDQUFDO0FBQy9DLHFCQUFhLEVBQUksS0FBRyxDQUFDO01BQ3pCO0FBQUEsSUFDSjtBQUFBLEVBQ0osQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQUVELHNCQUFzQixVQUFVLGtCQUFrQixFQUFJLFVBQVUsQUFBRCxDQUFHO0FBQzlELEtBQUksSUFBRyxVQUFVLENBQUc7QUFDaEIsUUFBTSxJQUFJLENBQUEsTUFBSyw0QkFBNEIsQUFBQyxDQUFDLG9DQUFtQyxDQUFDLENBQUM7RUFDdEY7QUFBQSxBQUNKLENBQUM7QUFFRCxzQkFBc0IsVUFBVSxlQUFlLEVBQUksVUFBVSxJQUFHLENBQUcsQ0FBQSxNQUFLLENBQUcsQ0FBQSxNQUFLLENBQUc7QUFDL0UsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUNmLEtBQUcsWUFBWSxBQUFDLEVBQUMsQ0FBQztBQUNsQixPQUFPLElBQUksUUFBTSxBQUFDLENBQUMsU0FBVSxPQUFNLENBQUcsQ0FBQSxNQUFLLENBQUc7QUFDMUMsTUFBSTtBQUNBLFNBQUcsY0FBYyxBQUFDLENBQUMsSUFBRyxTQUFTLFNBQVMsQUFBQyxDQUFDLElBQUcsY0FBYyxXQUFXLENBQUMsQ0FBQyxDQUFDO0FBRXpFLFNBQUksSUFBRyxVQUFVLElBQU0sQ0FBQSxLQUFJLGVBQWUsS0FBSyxDQUFHO0FBQzlDLEFBQUksVUFBQSxDQUFBLFdBQVUsRUFBSSxDQUFBLElBQUcsU0FBUyxxQkFBcUIsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0FBQzFELFdBQUcsS0FBSyxBQUFDLENBQ0wsUUFBTyxPQUFPLElBQUksQ0FBRyxVQUFVLE9BQU0sQ0FBRyxDQUFBLE9BQU0sQ0FBRztBQUM3QyxZQUFJO0FBQ0EsZUFBSSxPQUFNLElBQU0sQ0FBQSxLQUFJLGVBQWUsU0FBUyxDQUFBLEVBQUssQ0FBQSxPQUFNLElBQU0sQ0FBQSxLQUFJLGVBQWUsS0FBSyxDQUFHO0FBQ3BGLEFBQUksZ0JBQUEsQ0FBQSxjQUFhLEVBQUksQ0FBQSxJQUFHLFNBQVMscUJBQXFCLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztBQUM3RCxpQkFBSSxjQUFhLEdBQUssQ0FBQSxjQUFhLElBQU0sWUFBVSxDQUFHO0FBQ2xELG1CQUFJLE9BQU0sSUFBTSxDQUFBLEtBQUksZUFBZSxTQUFTLENBQUc7QUFDM0MsdUJBQUssQUFBQyxDQUFDLEdBQUksQ0FBQSxNQUFLLHFCQUFxQixBQUFDLENBQUMsK0NBQThDLEVBQUksS0FBRyxDQUFBLENBQUksYUFBVyxDQUFDLENBQUMsQ0FBQztnQkFDbEgsS0FDSztBQUNELHVCQUFLLEFBQUMsQ0FBQyxHQUFJLENBQUEsTUFBSyxLQUFLLEFBQUMsQ0FBQyxrREFBaUQsRUFBSSxLQUFHLENBQUEsQ0FBSSxhQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNyRztBQUFBLGNBQ0osS0FDSztBQUNELHNCQUFNLEFBQUMsRUFBQyxDQUFDO2NBQ2I7QUFBQSxZQUNKLEtBQ0ssS0FBSSxPQUFNLElBQU0sQ0FBQSxLQUFJLGVBQWUsT0FBTyxDQUFHO0FBQzlDLG1CQUFLLEFBQUMsQ0FBQyxHQUFJLENBQUEsTUFBSyxxQkFBcUIsQUFBQyxDQUFDLCtDQUE4QyxFQUFJLEtBQUcsQ0FBQSxDQUFJLGFBQVcsQ0FBQyxDQUFDLENBQUM7WUFDbEgsS0FDSyxLQUFJLE9BQU0sSUFBTSxDQUFBLEtBQUksZUFBZSxLQUFLLENBQUc7QUFDNUMsbUJBQUssQUFBQyxDQUFDLE9BQU0sQ0FBQyxDQUFDO1lBQ25CO0FBQUEsVUFDSixDQUNBLE9BQU8sQ0FBQSxDQUFHO0FBQ04saUJBQUssQUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDO1VBQ2I7QUFBQSxRQUNKLENBQUMsQ0FBQztBQUNOLFdBQUcsU0FBUyx1QkFBdUIsQUFBQyxDQUFDLElBQUcsQ0FBRyxPQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7TUFDOUQsS0FDSztBQUNELGFBQUssQUFBQyxDQUFDLEdBQUksQ0FBQSxNQUFLLHFCQUFxQixBQUFDLENBQUMsc0VBQXFFLENBQUMsQ0FBQyxDQUFDO01BQ25IO0FBQUEsSUFDSixDQUNBLE9BQU8sQ0FBQSxDQUFHO0FBQ04sV0FBSyxBQUFDLENBQUMsQ0FBQSxDQUFDLENBQUM7SUFDYjtBQUFBLEVBQ0osQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQUdELHNCQUFzQixVQUFVLHNCQUFzQixFQUFJLFVBQVUsVUFBUyxDQUFHLENBQUEsYUFBWSxDQUFHO0FBQzNGLEtBQUksVUFBUyxHQUFLLEVBQUMsQ0FBQSxTQUFTLEFBQUMsQ0FBQyxVQUFTLENBQUMsQ0FBRztBQUN2QyxRQUFNLElBQUksTUFBSSxBQUFDLENBQUMseUNBQXdDLENBQUMsQ0FBQztFQUM5RDtBQUFBLEFBRUEsS0FBRyxZQUFZLEFBQUMsRUFBQyxDQUFDO0FBQ2xCLE9BQU8sQ0FBQSxJQUFHLFNBQVMsc0JBQXNCLEFBQUMsQ0FBQyxVQUFTLENBQUcsY0FBWSxDQUFDLENBQUM7QUFDekUsQ0FBQztBQUVELHNCQUFzQixVQUFVLFNBQVMsRUFBSSxVQUFVLFVBQVMsQ0FBRyxDQUFBLElBQUcsQ0FBRztBQUNyRSxLQUFJLFVBQVMsR0FBSyxFQUFDLENBQUEsU0FBUyxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUc7QUFDdkMsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLHlDQUF3QyxDQUFDLENBQUM7RUFDOUQ7QUFBQSxBQUNBLEtBQUksQ0FBQyxDQUFBLFNBQVMsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFHO0FBQ25CLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxtQ0FBa0MsQ0FBQyxDQUFDO0VBQzVEO0FBQUEsQUFFQSxLQUFHLFlBQVksQUFBQyxFQUFDLENBQUM7QUFDbEIsS0FBRyxXQUFXLEVBQUksSUFBSSxLQUFHLEFBQUMsRUFBQyxDQUFDO0FBQzVCLEtBQUcsU0FBUyxTQUFTLEFBQUMsQ0FBQyxVQUFTLENBQUcsS0FBRyxDQUFDLENBQUM7QUFDNUMsQ0FBQztBQUdELEtBQUssUUFBUSxFQUFJLHdCQUFzQixDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9hY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCBBY3Rpdml0eSA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5XCIpO1xubGV0IEFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dCA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5RXhlY3V0aW9uQ29udGV4dFwiKTtcbmxldCBBY3Rpdml0eUV4ZWN1dGlvblN0YXRlID0gcmVxdWlyZShcIi4vYWN0aXZpdHlFeGVjdXRpb25TdGF0ZVwiKTtcbmxldCBDYWxsQ29udGV4dCA9IHJlcXVpcmUoXCIuL2NhbGxDb250ZXh0XCIpO1xubGV0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjtcbmxldCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5sZXQgZXJyb3JzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lcnJvcnNcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgQWN0aXZpdHlTdGF0ZVRyYWNrZXIgPSByZXF1aXJlKFwiLi9hY3Rpdml0eVN0YXRlVHJhY2tlclwiKTtcbmxldCBlbnVtcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZW51bXNcIik7XG5sZXQgUHJvbWlzZSA9IHJlcXVpcmUoXCJibHVlYmlyZFwiKTtcbmxldCBhc3luY0hlbHBlcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2FzeW5jSGVscGVyc1wiKTtcbmxldCBhc3luYyA9IGFzeW5jSGVscGVycy5hc3luYztcbmxldCBhY3Rpdml0eU1hcmt1cCA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5TWFya3VwXCIpO1xuXG5mdW5jdGlvbiBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZShyb290QWN0aXZpdHkpIHtcbiAgICBpZiAoIShyb290QWN0aXZpdHkgaW5zdGFuY2VvZiBBY3Rpdml0eSkpIHtcbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChyb290QWN0aXZpdHkpKSB7XG4gICAgICAgICAgICByb290QWN0aXZpdHkgPSBhY3Rpdml0eU1hcmt1cC5wYXJzZShyb290QWN0aXZpdHkpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFyZ3VtZW50ICdyb290QWN0aXZpdHknIGlzIG5vdCBhbiBhY3Rpdml0eSBvciBhIG1hcmt1cC5cIik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fcm9vdEFjdGl2aXR5ID0gcm9vdEFjdGl2aXR5O1xuICAgIHRoaXMuX2NvbnRleHQgPSBuZXcgQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0KCk7XG4gICAgdGhpcy5faXNJbml0aWFsaXplZCA9IGZhbHNlO1xuICAgIHRoaXMuX3Jvb3RTdGF0ZSA9IG51bGw7XG4gICAgdGhpcy5fdHJhY2tlcnMgPSBbXTtcbiAgICB0aGlzLl9ob29rQ29udGV4dCgpO1xuICAgIHRoaXMuX3RpbWVzdGFtcCA9IG51bGw7XG59XG5cbnV0aWwuaW5oZXJpdHMoQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUsIEV2ZW50RW1pdHRlcik7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZSwge1xuICAgIHJvb3RBY3Rpdml0eToge1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yb290QWN0aXZpdHk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIGV4ZWNTdGF0ZToge1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9yb290U3RhdGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcm9vdFN0YXRlLmV4ZWNTdGF0ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcbiAgICB2ZXJzaW9uOiB7XG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Jvb3RBY3Rpdml0eS52ZXJzaW9uO1xuICAgICAgICB9XG4gICAgfSxcbiAgICB1cGRhdGVkT246IHtcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fdGltZXN0YW1wO1xuICAgICAgICB9XG4gICAgfVxufSk7XG5cbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5faWRsZSA9IHtcbiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gZW51bXMuQWN0aXZpdHlTdGF0ZXMuaWRsZTtcbiAgICB9XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuaXNJZGxlID0gZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgIHJldHVybiByZXN1bHQgPT09IHRoaXMuX2lkbGU7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuX2luaXRpYWxpemUgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKCF0aGlzLl9pc0luaXRpYWxpemVkKSB7XG4gICAgICAgIHRoaXMuX2NvbnRleHQuaW5pdGlhbGl6ZSh0aGlzLl9yb290QWN0aXZpdHkpO1xuICAgICAgICB0aGlzLl9pc0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICB9XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuX3NldFJvb3RTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBpZiAoIXNlbGYuX3Jvb3RTdGF0ZSkge1xuICAgICAgICBzZWxmLl9yb290U3RhdGUgPSBzdGF0ZTtcbiAgICAgICAgc2VsZi5fcm9vdFN0YXRlLm9uKFxuICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmNhbmNlbCwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChBY3Rpdml0eS5zdGF0ZXMuY2FuY2VsKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUsIGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlLCByZXN1bHQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZS5vbihcbiAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5lbmQsIGZ1bmN0aW9uIChyZWFzb24sIHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIHNlbGYuX3RpbWVzdGFtcCA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KEFjdGl2aXR5LnN0YXRlcy5lbmQsIHJlYXNvbiwgcmVzdWx0KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuZmFpbCwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLmZhaWwsIGUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZS5vbihcbiAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5ydW4sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLnJ1bik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgc2VsZi5fcm9vdFN0YXRlLm9uKFxuICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmlkbGUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLmlkbGUpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLl9ob29rQ29udGV4dCA9IGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgc2VsZi5fY29udGV4dC5vbihcbiAgICAgICAgQWN0aXZpdHkuc3RhdGVzLnJ1biwgZnVuY3Rpb24gKGFjdGl2aXR5KSB7XG4gICAgICAgICAgICBmb3IgKGxldCB0IG9mIHNlbGYuX3RyYWNrZXJzKSB7XG4gICAgICAgICAgICAgICAgdC5hY3Rpdml0eVN0YXRlQ2hhbmdlZChhY3Rpdml0eSwgQWN0aXZpdHkuc3RhdGVzLnJ1bik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIHNlbGYuX2NvbnRleHQub24oXG4gICAgICAgIEFjdGl2aXR5LnN0YXRlcy5lbmQsIGZ1bmN0aW9uIChhY3Rpdml0eSwgcmVhc29uLCByZXN1bHQpIHtcbiAgICAgICAgICAgIGZvciAobGV0IHQgb2Ygc2VsZi5fdHJhY2tlcnMpIHtcbiAgICAgICAgICAgICAgICB0LmFjdGl2aXR5U3RhdGVDaGFuZ2VkKGFjdGl2aXR5LCByZWFzb24sIHJlc3VsdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLmFkZFRyYWNrZXIgPSBmdW5jdGlvbiAodHJhY2tlcikge1xuICAgIGlmICghXy5pc09iamVjdCh0cmFja2VyKSkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiUGFyYW1ldGVyIGlzIG5vdCBhbiBvYmplY3QuXCIpO1xuICAgIH1cbiAgICB0aGlzLl90cmFja2Vycy5wdXNoKG5ldyBBY3Rpdml0eVN0YXRlVHJhY2tlcih0cmFja2VyKSk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUucmVtb3ZlVHJhY2tlciA9IGZ1bmN0aW9uICh0cmFja2VyKSB7XG4gICAgbGV0IGlkeCA9IC0xO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fdHJhY2tlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgbGV0IHQgPSB0aGlzLl90cmFja2Vyc1tpXTtcbiAgICAgICAgaWYgKHQuX2ltcGwgPT09IHRyYWNrZXIpIHtcbiAgICAgICAgICAgIGlkeCA9IGk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoaWR4ICE9PSAtMSkge1xuICAgICAgICB0aGlzLl90cmFja2Vycy5zcGxpY2UoaWR4LCAxKTtcbiAgICB9XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuc3RhcnQgPSBhc3luYyhmdW5jdGlvbiogKCkge1xuICAgIHRoaXMuX3ZlcmlmeU5vdFN0YXJ0ZWQoKTtcblxuICAgIHRoaXMuX2luaXRpYWxpemUoKTtcblxuICAgIGxldCBhcmdzID0gW25ldyBDYWxsQ29udGV4dCh0aGlzLl9jb250ZXh0KV07XG4gICAgZm9yIChsZXQgYSBvZiBhcmd1bWVudHMpIHtcbiAgICAgICAgYXJncy5wdXNoKGEpO1xuICAgIH1cblxuICAgIHRoaXMuX3NldFJvb3RTdGF0ZSh5aWVsZCB0aGlzLl9yb290QWN0aXZpdHkuc3RhcnQuYXBwbHkodGhpcy5fcm9vdEFjdGl2aXR5LCBhcmdzKSk7XG59KTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLmludm9rZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG5cbiAgICBzZWxmLl92ZXJpZnlOb3RTdGFydGVkKCk7XG5cbiAgICBzZWxmLl9pbml0aWFsaXplKCk7XG5cbiAgICBsZXQgYXJnUmVtb3ZlVG9rZW4gPSBudWxsO1xuICAgIGxldCBhcmdzID0gW107XG4gICAgZm9yIChsZXQgYSBvZiBhcmd1bWVudHMpIHtcbiAgICAgICAgYXJncy5wdXNoKGEpO1xuICAgIH1cblxuICAgIGlmIChhcmdzLmxlbmd0aCkge1xuICAgICAgICBhcmdSZW1vdmVUb2tlbiA9IHNlbGYuX2NvbnRleHQuYXBwZW5kVG9Db250ZXh0KGFyZ3MpO1xuICAgIH1cblxuICAgIGFyZ3MudW5zaGlmdChuZXcgQ2FsbENvbnRleHQoc2VsZi5fY29udGV4dCkpO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHNlbGYuX3NldFJvb3RTdGF0ZShzZWxmLl9jb250ZXh0LmdldFN0YXRlKHNlbGYuX3Jvb3RBY3Rpdml0eS5pbnN0YW5jZUlkKSk7XG4gICAgICAgICAgICBzZWxmLm9uY2UoXG4gICAgICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmVuZCwgZnVuY3Rpb24gKHJlYXNvbiwgcmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHJlYXNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQWN0aXZpdHkuc3RhdGVzLmNhbmNlbDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuQ2FuY2VsbGVkKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEFjdGl2aXR5LnN0YXRlcy5pZGxlOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHNlbGYuX2lkbGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0IDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gcmVzdWx0IHx8IG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJVbmtub3duIGVycm9yLlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZpbmFsbHkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ1JlbW92ZVRva2VuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY29udGV4dC5yZW1vdmVGcm9tQ29udGV4dChhcmdSZW1vdmVUb2tlbik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnUmVtb3ZlVG9rZW4gPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHNlbGYuX3Jvb3RBY3Rpdml0eS5zdGFydC5hcHBseShzZWxmLl9yb290QWN0aXZpdHksIGFyZ3MpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICByZWplY3QoZSk7XG5cbiAgICAgICAgICAgIGlmIChhcmdSZW1vdmVUb2tlbikge1xuICAgICAgICAgICAgICAgIHNlbGYuX2NvbnRleHQucmVtb3ZlRnJvbUNvbnRleHQoYXJnUmVtb3ZlVG9rZW4pO1xuICAgICAgICAgICAgICAgIGFyZ1JlbW92ZVRva2VuID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLl92ZXJpZnlOb3RTdGFydGVkID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICh0aGlzLmV4ZWNTdGF0ZSkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLkFjdGl2aXR5U3RhdGVFeGNlcHRpb25FcnJvcihcIldvcmtmbG93IGhhcyBiZWVuIHN0YXJ0ZWQgYWxyZWFkeS5cIik7XG4gICAgfVxufTtcblxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLnJlc3VtZUJvb2ttYXJrID0gZnVuY3Rpb24gKG5hbWUsIHJlYXNvbiwgcmVzdWx0KSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIHNlbGYuX2luaXRpYWxpemUoKTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgc2VsZi5fc2V0Um9vdFN0YXRlKHNlbGYuX2NvbnRleHQuZ2V0U3RhdGUoc2VsZi5fcm9vdEFjdGl2aXR5Lmluc3RhbmNlSWQpKTtcblxuICAgICAgICAgICAgaWYgKHNlbGYuZXhlY1N0YXRlID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5pZGxlKSB7XG4gICAgICAgICAgICAgICAgbGV0IGJtVGltZXN0YW1wID0gc2VsZi5fY29udGV4dC5nZXRCb29rbWFya1RpbWVzdGFtcChuYW1lKTtcbiAgICAgICAgICAgICAgICBzZWxmLm9uY2UoXG4gICAgICAgICAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5lbmQsIGZ1bmN0aW9uIChfcmVhc29uLCBfcmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfcmVhc29uID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5jb21wbGV0ZSB8fCBfcmVhc29uID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5pZGxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlbmRCbVRpbWVzdGFtcCA9IHNlbGYuX2NvbnRleHQuZ2V0Qm9va21hcmtUaW1lc3RhbXAobmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbmRCbVRpbWVzdGFtcCAmJiBlbmRCbVRpbWVzdGFtcCA9PT0gYm1UaW1lc3RhbXApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfcmVhc29uID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5jb21wbGV0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiV29ya2Zsb3cgaGFzIGJlZW4gY29tcGxldGVkIGJlZm9yZSBib29rbWFyayAnXCIgKyBuYW1lICsgXCInIHJlYWNoZWQuXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgZXJyb3JzLklkbGUoXCJXb3JrZmxvdyBoYXMgYmVlbiBnb25lIHRvIGlkbGUgYmVmb3JlIGJvb2ttYXJrICdcIiArIG5hbWUgKyBcIicgcmVhY2hlZC5cIikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9yZWFzb24gPT09IGVudW1zLkFjdGl2aXR5U3RhdGVzLmNhbmNlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IGVycm9ycy5BY3Rpdml0eVJ1bnRpbWVFcnJvcihcIldvcmtmbG93IGhhcyBiZWVuIGNhbmNlbGxlZCBiZWZvcmUgYm9va21hcmsgJ1wiICsgbmFtZSArIFwiJyByZWFjaGVkLlwiKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9yZWFzb24gPT09IGVudW1zLkFjdGl2aXR5U3RhdGVzLmZhaWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KF9yZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBzZWxmLl9jb250ZXh0LnJlc3VtZUJvb2ttYXJrRXh0ZXJuYWwobmFtZSwgcmVhc29uLCByZXN1bHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJDYW5ub3QgcmVzdW1lIGJvb2ttYXJrLCB3aGlsZSB0aGUgd29ya2Zsb3cgaXMgbm90IGluIHRoZSBpZGxlIHN0YXRlLlwiKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgfVxuICAgIH0pO1xufTtcblxuLyogU0VSSUFMSVpBVElPTiAqL1xuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLmdldFN0YXRlQW5kUHJvbW90aW9ucyA9IGZ1bmN0aW9uIChzZXJpYWxpemVyLCBnZXRQcm9tb3Rpb25zKSB7XG4gICAgaWYgKHNlcmlhbGl6ZXIgJiYgIV8uaXNPYmplY3Qoc2VyaWFsaXplcikpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQXJndW1lbnQgJ3NlcmlhbGl6ZXInIGlzIG5vdCBhbiBvYmplY3QuXCIpO1xuICAgIH1cblxuICAgIHRoaXMuX2luaXRpYWxpemUoKTtcbiAgICByZXR1cm4gdGhpcy5fY29udGV4dC5nZXRTdGF0ZUFuZFByb21vdGlvbnMoc2VyaWFsaXplciwgZ2V0UHJvbW90aW9ucyk7XG59O1xuXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbiAoc2VyaWFsaXplciwganNvbikge1xuICAgIGlmIChzZXJpYWxpemVyICYmICFfLmlzT2JqZWN0KHNlcmlhbGl6ZXIpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFyZ3VtZW50ICdzZXJpYWxpemVyJyBpcyBub3QgYW4gb2JqZWN0LlwiKTtcbiAgICB9XG4gICAgaWYgKCFfLmlzT2JqZWN0KGpzb24pKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAnanNvbicgaXMgbm90IGFuIG9iamVjdC5cIik7XG4gICAgfVxuXG4gICAgdGhpcy5faW5pdGlhbGl6ZSgpO1xuICAgIHRoaXMuX3RpbWVzdGFtcCA9IG5ldyBEYXRlKCk7XG4gICAgdGhpcy5fY29udGV4dC5zZXRTdGF0ZShzZXJpYWxpemVyLCBqc29uKTtcbn07XG4vKiBTRVJJQUxJWkFUSU9OICovXG5cbm1vZHVsZS5leHBvcnRzID0gQWN0aXZpdHlFeGVjdXRpb25FbmdpbmU7Il19
