"use strict";
var Activity = require("./activity");
var ActivityExecutionContext = require("./activityExecutionContext");
var ActivityExecutionState = require("./activityExecutionState");
var CallContext = require("./callContext");
var EventEmitter = require('events').EventEmitter;
var util = require("util");
var errors = require("../common/errors");
var _ = require("lodash");
var ActivityStateTracker = require("./activityStateTracker");
var enums = require("../common/enums");
var Promise = require("bluebird");
var fast = require("fast.js");
var asyncHelpers = require("../common/asyncHelpers");
var async = asyncHelpers.async;
var activityMarkup = require("./activityMarkup");
function ActivityExecutionEngine(rootActivity) {
  if (!(rootActivity instanceof Activity)) {
    if (_.isPlainObject(rootActivity)) {
      rootActivity = activityMarkup.parse(rootActivity);
    } else {
      throw new TypeError("Argument 'rootActivity' is not an activity or a markup.");
    }
  }
  this._rootActivity = rootActivity;
  this._context = new ActivityExecutionContext();
  this._isInitialized = false;
  this._rootState = null;
  this._trackers = [];
  this._hookContext();
  this._timestamp = null;
}
util.inherits(ActivityExecutionEngine, EventEmitter);
Object.defineProperties(ActivityExecutionEngine.prototype, {
  rootActivity: {get: function() {
      return this._rootActivity;
    }},
  execState: {get: function() {
      if (this._rootState) {
        return this._rootState.execState;
      } else {
        return null;
      }
    }},
  version: {get: function() {
      return this._rootActivity.version;
    }},
  updatedOn: {get: function() {
      return this._timestamp;
    }}
});
ActivityExecutionEngine.prototype._idle = {toString: function() {
    return enums.ActivityStates.idle;
  }};
ActivityExecutionEngine.prototype.isIdle = function(result) {
  return result === this._idle;
};
ActivityExecutionEngine.prototype._initialize = function() {
  if (!this._isInitialized) {
    this._context.initialize(this._rootActivity);
    this._isInitialized = true;
  }
};
ActivityExecutionEngine.prototype._setRootState = function(state) {
  var self = this;
  if (!self._rootState) {
    self._rootState = state;
    self._rootState.on(Activity.states.cancel, function() {
      self.emit(Activity.states.cancel);
    });
    self._rootState.on(Activity.states.complete, function(result) {
      self.emit(Activity.states.complete, result);
    });
    self._rootState.on(Activity.states.end, function(reason, result) {
      self._timestamp = new Date();
      self.emit(Activity.states.end, reason, result);
    });
    self._rootState.on(Activity.states.fail, function(e) {
      self.emit(Activity.states.fail, e);
    });
    self._rootState.on(Activity.states.run, function() {
      self.emit(Activity.states.run);
    });
    self._rootState.on(Activity.states.idle, function() {
      self.emit(Activity.states.idle);
    });
  }
};
ActivityExecutionEngine.prototype._hookContext = function() {
  var self = this;
  self._context.on(Activity.states.run, function(activity) {
    fast.forEach(self._trackers, function(t) {
      t.activityStateChanged(activity, Activity.states.run);
    });
  });
  self._context.on(Activity.states.end, function(activity, reason, result) {
    fast.forEach(self._trackers, function(t) {
      t.activityStateChanged(activity, reason, result);
    });
  });
};
ActivityExecutionEngine.prototype.addTracker = function(tracker) {
  if (!_.isObject(tracker))
    throw new TypeError("Parameter is not an object.");
  this._trackers.push(new ActivityStateTracker(tracker));
};
ActivityExecutionEngine.prototype.removeTracker = function(tracker) {
  var idx = -1;
  fast.forEach(this._trackers, function(t, i) {
    if (t._impl === tracker) {
      idx = i;
      return false;
    }
  });
  if (idx != -1)
    this._trackers.splice(idx, 1);
};
ActivityExecutionEngine.prototype.start = async($traceurRuntime.initGeneratorFunction(function $__0() {
  var args,
      $__1,
      $__2,
      $__3,
      $__4,
      $__5,
      $__6,
      $__7,
      $__8;
  var $arguments = arguments;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyNotStarted();
          this._initialize();
          args = [new CallContext(self._context)];
          fast.forEach($arguments, function(a) {
            args.push(a);
          });
          $ctx.state = 10;
          break;
        case 10:
          $__1 = this._setRootState;
          $__2 = this._rootActivity;
          $__3 = $__2.start;
          $__4 = $__3.apply;
          $__5 = this._rootActivity;
          $__6 = $__4.call($__3, $__5, args);
          $ctx.state = 6;
          break;
        case 6:
          $ctx.state = 2;
          return $__6;
        case 2:
          $__7 = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          $__8 = $__1.call(this, $__7);
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__0, this);
}));
ActivityExecutionEngine.prototype.invoke = function() {
  var self = this;
  self._verifyNotStarted();
  self._initialize();
  var argRemoveToken = null;
  var args = [];
  fast.forEach(arguments, function(a) {
    args.push(a);
  });
  if (args.length)
    argRemoveToken = self._context.appendToContext(args);
  args.unshift(new CallContext(self._context));
  return new Promise(function(resolve, reject) {
    try {
      self._setRootState(self._context.getState(self._rootActivity.id));
      self.once(Activity.states.end, function(reason, result) {
        try {
          switch (reason) {
            case Activity.states.complete:
              resolve(result);
              break;
            case Activity.states.cancel:
              reject(new errors.Cancelled());
              break;
            case Activity.states.idle:
              resolve(self._idle);
              break;
            default:
              result = result || new errors.ActivityRuntimeError("Unknown error.");
              reject(result);
              break;
          }
        } finally {
          if (argRemoveToken) {
            self._context.removeFromContext(argRemoveToken);
            argRemoveToken = null;
          }
        }
      });
      self._rootActivity.start.apply(self._rootActivity, args);
    } catch (e) {
      reject(e);
      if (argRemoveToken) {
        self._context.removeFromContext(argRemoveToken);
        argRemoveToken = null;
      }
    }
  });
};
ActivityExecutionEngine.prototype._verifyNotStarted = function() {
  if (this.execState != null)
    throw new errors.ActivityStateExceptionError("Workflow has been started already.");
};
ActivityExecutionEngine.prototype.resumeBookmark = function(name, reason, result) {
  var self = this;
  self._initialize();
  return new Promise(function(resolve, reject) {
    try {
      self._setRootState(self._context.getState(self._rootActivity.id));
      if (self.execState === enums.ActivityStates.idle) {
        var bmTimestamp = self._context.getBookmarkTimestamp(name);
        self.once(Activity.states.end, function(reason, result) {
          try {
            if (reason === enums.ActivityStates.complete || reason === enums.ActivityStates.idle) {
              var endBmTimestamp = self._context.getBookmarkTimestamp(name);
              if (endBmTimestamp && endBmTimestamp === bmTimestamp) {
                if (reason === enums.ActivityStates.complete) {
                  reject(new errors.ActivityRuntimeError("Workflow has been completed before bookmark '" + name + "' reached."));
                } else {
                  reject(new errors.Idle("Workflow has been gone to idle before bookmark '" + name + "' reached."));
                }
              } else {
                resolve();
              }
            } else if (reason === enums.ActivityStates.cancel) {
              reject(new errors.ActivityRuntimeError("Workflow has been cancelled before bookmark '" + name + "' reached."));
            } else if (reason === enums.ActivityStates.fail) {
              reject(result);
            }
          } catch (e) {
            reject(e);
          }
        });
        self._context.resumeBookmarkExternal(name, reason, result);
      } else {
        reject(new errors.ActivityRuntimeError("Cannot resume bookmark, while the workflow is not in the idle state."));
      }
    } catch (e) {
      reject(e);
    }
  });
};
ActivityExecutionEngine.prototype.getStateAndPromotions = function(serializer, getPromotions) {
  if (serializer && !_.isObject(serializer))
    throw new Error("Argument 'serializer' is not an object.");
  this._initialize();
  return this._context.getStateAndPromotions(serializer, getPromotions);
};
ActivityExecutionEngine.prototype.setState = function(serializer, json) {
  if (serializer && !_.isObject(serializer))
    throw new Error("Argument 'serializer' is not an object.");
  if (!_.isObject(json))
    throw new TypeError("Argument 'json' is not an object.");
  this._initialize();
  this._timestamp = new Date();
  this._context.setState(serializer, json);
};
module.exports = ActivityExecutionEngine;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsQUFBSSxFQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsWUFBVyxDQUFDLENBQUM7QUFDcEMsQUFBSSxFQUFBLENBQUEsd0JBQXVCLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyw0QkFBMkIsQ0FBQyxDQUFDO0FBQ3BFLEFBQUksRUFBQSxDQUFBLHNCQUFxQixFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsMEJBQXlCLENBQUMsQ0FBQztBQUNoRSxBQUFJLEVBQUEsQ0FBQSxXQUFVLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxlQUFjLENBQUMsQ0FBQztBQUMxQyxBQUFJLEVBQUEsQ0FBQSxZQUFXLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsYUFBYSxDQUFDO0FBQ2pELEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGtCQUFpQixDQUFDLENBQUM7QUFDeEMsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsb0JBQW1CLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyx3QkFBdUIsQ0FBQyxDQUFDO0FBQzVELEFBQUksRUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGlCQUFnQixDQUFDLENBQUM7QUFDdEMsQUFBSSxFQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDakMsQUFBSSxFQUFBLENBQUEsSUFBRyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsU0FBUSxDQUFDLENBQUM7QUFDN0Is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T0FBTyxDQUFBLElBQUcsU0FBUyxzQkFBc0IsQUFBQyxDQUFDLFVBQVMsQ0FBRyxjQUFZLENBQUMsQ0FBQztBQUN6RSxDQUFBO0FBRUEsc0JBQXNCLFVBQVUsU0FBUyxFQUFJLFVBQVUsVUFBUyxDQUFHLENBQUEsSUFBRyxDQUFHO0FBQ3JFLEtBQUksVUFBUyxHQUFLLEVBQUMsQ0FBQSxTQUFTLEFBQUMsQ0FBQyxVQUFTLENBQUM7QUFBRyxRQUFNLElBQUksTUFBSSxBQUFDLENBQUMseUNBQXdDLENBQUMsQ0FBQztBQUFBLEFBQ3JHLEtBQUksQ0FBQyxDQUFBLFNBQVMsQUFBQyxDQUFDLElBQUcsQ0FBQztBQUFHLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxtQ0FBa0MsQ0FBQyxDQUFDO0FBQUEsQUFFL0UsS0FBRyxZQUFZLEFBQUMsRUFBQyxDQUFDO0FBQ2xCLEtBQUcsV0FBVyxFQUFJLElBQUksS0FBRyxBQUFDLEVBQUMsQ0FBQztBQUM1QixLQUFHLFNBQVMsU0FBUyxBQUFDLENBQUMsVUFBUyxDQUFHLEtBQUcsQ0FBQyxDQUFDO0FBQzVDLENBQUE7QUFHQSxLQUFLLFFBQVEsRUFBSSx3QkFBc0IsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvYWN0aXZpdHlFeGVjdXRpb25FbmdpbmUuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbInZhciBBY3Rpdml0eSA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5XCIpO1xyXG52YXIgQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0ID0gcmVxdWlyZShcIi4vYWN0aXZpdHlFeGVjdXRpb25Db250ZXh0XCIpO1xyXG52YXIgQWN0aXZpdHlFeGVjdXRpb25TdGF0ZSA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5RXhlY3V0aW9uU3RhdGVcIik7XHJcbnZhciBDYWxsQ29udGV4dCA9IHJlcXVpcmUoXCIuL2NhbGxDb250ZXh0XCIpO1xyXG52YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyO1xyXG52YXIgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xyXG52YXIgZXJyb3JzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lcnJvcnNcIik7XHJcbnZhciBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcclxudmFyIEFjdGl2aXR5U3RhdGVUcmFja2VyID0gcmVxdWlyZShcIi4vYWN0aXZpdHlTdGF0ZVRyYWNrZXJcIik7XHJcbnZhciBlbnVtcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZW51bXNcIik7XHJcbnZhciBQcm9taXNlID0gcmVxdWlyZShcImJsdWViaXJkXCIpO1xyXG52YXIgZmFzdCA9IHJlcXVpcmUoXCJmYXN0LmpzXCIpO1xyXG52YXIgYXN5bmNIZWxwZXJzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hc3luY0hlbHBlcnNcIik7XHJcbnZhciBhc3luYyA9IGFzeW5jSGVscGVycy5hc3luYztcclxudmFyIGFjdGl2aXR5TWFya3VwID0gcmVxdWlyZShcIi4vYWN0aXZpdHlNYXJrdXBcIik7XHJcblxyXG5mdW5jdGlvbiBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZShyb290QWN0aXZpdHkpIHtcclxuICAgIGlmICghKHJvb3RBY3Rpdml0eSBpbnN0YW5jZW9mIEFjdGl2aXR5KSkge1xyXG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3Qocm9vdEFjdGl2aXR5KSkge1xyXG4gICAgICAgICAgICByb290QWN0aXZpdHkgPSBhY3Rpdml0eU1hcmt1cC5wYXJzZShyb290QWN0aXZpdHkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFyZ3VtZW50ICdyb290QWN0aXZpdHknIGlzIG5vdCBhbiBhY3Rpdml0eSBvciBhIG1hcmt1cC5cIik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdGhpcy5fcm9vdEFjdGl2aXR5ID0gcm9vdEFjdGl2aXR5O1xyXG4gICAgdGhpcy5fY29udGV4dCA9IG5ldyBBY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQoKTtcclxuICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICAgIHRoaXMuX3Jvb3RTdGF0ZSA9IG51bGw7XHJcbiAgICB0aGlzLl90cmFja2VycyA9IFtdO1xyXG4gICAgdGhpcy5faG9va0NvbnRleHQoKTtcclxuICAgIHRoaXMuX3RpbWVzdGFtcCA9IG51bGw7XHJcbn1cclxuXHJcbnV0aWwuaW5oZXJpdHMoQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUsIEV2ZW50RW1pdHRlcik7XHJcblxyXG5PYmplY3QuZGVmaW5lUHJvcGVydGllcyhBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUsIHtcclxuICAgIHJvb3RBY3Rpdml0eToge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fcm9vdEFjdGl2aXR5O1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICBleGVjU3RhdGU6IHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX3Jvb3RTdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Jvb3RTdGF0ZS5leGVjU3RhdGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICB2ZXJzaW9uOiB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yb290QWN0aXZpdHkudmVyc2lvbjtcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG4gICAgdXBkYXRlZE9uOiB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl90aW1lc3RhbXA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59KVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLl9pZGxlID0ge1xyXG4gICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gZW51bXMuQWN0aXZpdHlTdGF0ZXMuaWRsZTtcclxuICAgIH1cclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLmlzSWRsZSA9IGZ1bmN0aW9uIChyZXN1bHQpIHtcclxuICAgIHJldHVybiByZXN1bHQgPT09IHRoaXMuX2lkbGU7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5faW5pdGlhbGl6ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmICghdGhpcy5faXNJbml0aWFsaXplZCkge1xyXG4gICAgICAgIHRoaXMuX2NvbnRleHQuaW5pdGlhbGl6ZSh0aGlzLl9yb290QWN0aXZpdHkpO1xyXG4gICAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgfVxyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuX3NldFJvb3RTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgaWYgKCFzZWxmLl9yb290U3RhdGUpIHtcclxuICAgICAgICBzZWxmLl9yb290U3RhdGUgPSBzdGF0ZTtcclxuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXHJcbiAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5jYW5jZWwsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChBY3Rpdml0eS5zdGF0ZXMuY2FuY2VsKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgc2VsZi5fcm9vdFN0YXRlLm9uKFxyXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUsIGZ1bmN0aW9uIChyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUsIHJlc3VsdCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZS5vbihcclxuICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmVuZCwgZnVuY3Rpb24gKHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl90aW1lc3RhbXAgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KEFjdGl2aXR5LnN0YXRlcy5lbmQsIHJlYXNvbiwgcmVzdWx0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgc2VsZi5fcm9vdFN0YXRlLm9uKFxyXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuZmFpbCwgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChBY3Rpdml0eS5zdGF0ZXMuZmFpbCwgZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZS5vbihcclxuICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLnJ1biwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KEFjdGl2aXR5LnN0YXRlcy5ydW4pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXHJcbiAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5pZGxlLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLmlkbGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLl9ob29rQ29udGV4dCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHNlbGYuX2NvbnRleHQub24oXHJcbiAgICAgICAgQWN0aXZpdHkuc3RhdGVzLnJ1biwgZnVuY3Rpb24gKGFjdGl2aXR5KSB7XHJcbiAgICAgICAgICAgIGZhc3QuZm9yRWFjaChzZWxmLl90cmFja2VycyxcclxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uICh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdC5hY3Rpdml0eVN0YXRlQ2hhbmdlZChhY3Rpdml0eSwgQWN0aXZpdHkuc3RhdGVzLnJ1bik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIHNlbGYuX2NvbnRleHQub24oXHJcbiAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmVuZCwgZnVuY3Rpb24gKGFjdGl2aXR5LCByZWFzb24sIHJlc3VsdCkge1xyXG4gICAgICAgICAgICBmYXN0LmZvckVhY2goc2VsZi5fdHJhY2tlcnMsXHJcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAodCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHQuYWN0aXZpdHlTdGF0ZUNoYW5nZWQoYWN0aXZpdHksIHJlYXNvbiwgcmVzdWx0KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuYWRkVHJhY2tlciA9IGZ1bmN0aW9uICh0cmFja2VyKSB7XHJcbiAgICBpZiAoIV8uaXNPYmplY3QodHJhY2tlcikpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJQYXJhbWV0ZXIgaXMgbm90IGFuIG9iamVjdC5cIik7XHJcbiAgICB0aGlzLl90cmFja2Vycy5wdXNoKG5ldyBBY3Rpdml0eVN0YXRlVHJhY2tlcih0cmFja2VyKSk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5yZW1vdmVUcmFja2VyID0gZnVuY3Rpb24gKHRyYWNrZXIpIHtcclxuICAgIHZhciBpZHggPSAtMTtcclxuICAgIGZhc3QuZm9yRWFjaCh0aGlzLl90cmFja2VycyxcclxuICAgICAgICBmdW5jdGlvbiAodCwgaSkge1xyXG4gICAgICAgICAgICBpZiAodC5faW1wbCA9PT0gdHJhY2tlcikge1xyXG4gICAgICAgICAgICAgICAgaWR4ID0gaTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgaWYgKGlkeCAhPSAtMSkgdGhpcy5fdHJhY2tlcnMuc3BsaWNlKGlkeCwgMSk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5zdGFydCA9IGFzeW5jKGZ1bmN0aW9uKiAoKSB7XHJcbiAgICB0aGlzLl92ZXJpZnlOb3RTdGFydGVkKCk7XHJcblxyXG4gICAgdGhpcy5faW5pdGlhbGl6ZSgpO1xyXG5cclxuICAgIHZhciBhcmdzID0gW25ldyBDYWxsQ29udGV4dChzZWxmLl9jb250ZXh0KV07XHJcbiAgICBmYXN0LmZvckVhY2goXHJcbiAgICAgICAgYXJndW1lbnRzLCBmdW5jdGlvbiAoYSkge1xyXG4gICAgICAgICAgICBhcmdzLnB1c2goYSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgdGhpcy5fc2V0Um9vdFN0YXRlKHlpZWxkIHRoaXMuX3Jvb3RBY3Rpdml0eS5zdGFydC5hcHBseSh0aGlzLl9yb290QWN0aXZpdHksIGFyZ3MpKTtcclxufSk7XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuaW52b2tlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIHNlbGYuX3ZlcmlmeU5vdFN0YXJ0ZWQoKTtcclxuXHJcbiAgICBzZWxmLl9pbml0aWFsaXplKCk7XHJcblxyXG4gICAgdmFyIGFyZ1JlbW92ZVRva2VuID0gbnVsbDtcclxuICAgIHZhciBhcmdzID0gW107XHJcbiAgICBmYXN0LmZvckVhY2goXHJcbiAgICAgICAgYXJndW1lbnRzLCBmdW5jdGlvbiAoYSkge1xyXG4gICAgICAgICAgICBhcmdzLnB1c2goYSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICBpZiAoYXJncy5sZW5ndGgpIGFyZ1JlbW92ZVRva2VuID0gc2VsZi5fY29udGV4dC5hcHBlbmRUb0NvbnRleHQoYXJncyk7XHJcbiAgICBhcmdzLnVuc2hpZnQobmV3IENhbGxDb250ZXh0KHNlbGYuX2NvbnRleHQpKTtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHNlbGYuX3NldFJvb3RTdGF0ZShzZWxmLl9jb250ZXh0LmdldFN0YXRlKHNlbGYuX3Jvb3RBY3Rpdml0eS5pZCkpO1xyXG4gICAgICAgICAgICBzZWxmLm9uY2UoXHJcbiAgICAgICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuZW5kLCBmdW5jdGlvbiAocmVhc29uLCByZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHJlYXNvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBBY3Rpdml0eS5zdGF0ZXMuY2FuY2VsOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgZXJyb3JzLkNhbmNlbGxlZCgpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQWN0aXZpdHkuc3RhdGVzLmlkbGU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShzZWxmLl9pZGxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdCB8fCBuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiVW5rbm93biBlcnJvci5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZmluYWxseSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmdSZW1vdmVUb2tlbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY29udGV4dC5yZW1vdmVGcm9tQ29udGV4dChhcmdSZW1vdmVUb2tlbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdSZW1vdmVUb2tlbiA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHNlbGYuX3Jvb3RBY3Rpdml0eS5zdGFydC5hcHBseShzZWxmLl9yb290QWN0aXZpdHksIGFyZ3MpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICByZWplY3QoZSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoYXJnUmVtb3ZlVG9rZW4pIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX2NvbnRleHQucmVtb3ZlRnJvbUNvbnRleHQoYXJnUmVtb3ZlVG9rZW4pO1xyXG4gICAgICAgICAgICAgICAgYXJnUmVtb3ZlVG9rZW4gPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5fdmVyaWZ5Tm90U3RhcnRlZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmICh0aGlzLmV4ZWNTdGF0ZSAhPSBudWxsKSB0aHJvdyBuZXcgZXJyb3JzLkFjdGl2aXR5U3RhdGVFeGNlcHRpb25FcnJvcihcIldvcmtmbG93IGhhcyBiZWVuIHN0YXJ0ZWQgYWxyZWFkeS5cIik7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5yZXN1bWVCb29rbWFyayA9IGZ1bmN0aW9uIChuYW1lLCByZWFzb24sIHJlc3VsdCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgc2VsZi5faW5pdGlhbGl6ZSgpO1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBzZWxmLl9zZXRSb290U3RhdGUoc2VsZi5fY29udGV4dC5nZXRTdGF0ZShzZWxmLl9yb290QWN0aXZpdHkuaWQpKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChzZWxmLmV4ZWNTdGF0ZSA9PT0gZW51bXMuQWN0aXZpdHlTdGF0ZXMuaWRsZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGJtVGltZXN0YW1wID0gc2VsZi5fY29udGV4dC5nZXRCb29rbWFya1RpbWVzdGFtcChuYW1lKTtcclxuICAgICAgICAgICAgICAgIHNlbGYub25jZShcclxuICAgICAgICAgICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuZW5kLCBmdW5jdGlvbiAocmVhc29uLCByZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWFzb24gPT09IGVudW1zLkFjdGl2aXR5U3RhdGVzLmNvbXBsZXRlIHx8IHJlYXNvbiA9PT0gZW51bXMuQWN0aXZpdHlTdGF0ZXMuaWRsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbmRCbVRpbWVzdGFtcCA9IHNlbGYuX2NvbnRleHQuZ2V0Qm9va21hcmtUaW1lc3RhbXAobmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVuZEJtVGltZXN0YW1wICYmIGVuZEJtVGltZXN0YW1wID09PSBibVRpbWVzdGFtcCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVhc29uID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5jb21wbGV0ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJXb3JrZmxvdyBoYXMgYmVlbiBjb21wbGV0ZWQgYmVmb3JlIGJvb2ttYXJrICdcIiArIG5hbWUgKyBcIicgcmVhY2hlZC5cIikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuSWRsZShcIldvcmtmbG93IGhhcyBiZWVuIGdvbmUgdG8gaWRsZSBiZWZvcmUgYm9va21hcmsgJ1wiICsgbmFtZSArIFwiJyByZWFjaGVkLlwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChyZWFzb24gPT09IGVudW1zLkFjdGl2aXR5U3RhdGVzLmNhbmNlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiV29ya2Zsb3cgaGFzIGJlZW4gY2FuY2VsbGVkIGJlZm9yZSBib29rbWFyayAnXCIgKyBuYW1lICsgXCInIHJlYWNoZWQuXCIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJlYXNvbiA9PT0gZW51bXMuQWN0aXZpdHlTdGF0ZXMuZmFpbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChyZXN1bHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHNlbGYuX2NvbnRleHQucmVzdW1lQm9va21hcmtFeHRlcm5hbChuYW1lLCByZWFzb24sIHJlc3VsdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IGVycm9ycy5BY3Rpdml0eVJ1bnRpbWVFcnJvcihcIkNhbm5vdCByZXN1bWUgYm9va21hcmssIHdoaWxlIHRoZSB3b3JrZmxvdyBpcyBub3QgaW4gdGhlIGlkbGUgc3RhdGUuXCIpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICByZWplY3QoZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbi8qIFNFUklBTElaQVRJT04gKi9cclxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLmdldFN0YXRlQW5kUHJvbW90aW9ucyA9IGZ1bmN0aW9uIChzZXJpYWxpemVyLCBnZXRQcm9tb3Rpb25zKSB7XHJcbiAgICBpZiAoc2VyaWFsaXplciAmJiAhXy5pc09iamVjdChzZXJpYWxpemVyKSkgdGhyb3cgbmV3IEVycm9yKFwiQXJndW1lbnQgJ3NlcmlhbGl6ZXInIGlzIG5vdCBhbiBvYmplY3QuXCIpO1xyXG5cclxuICAgIHRoaXMuX2luaXRpYWxpemUoKTtcclxuICAgIHJldHVybiB0aGlzLl9jb250ZXh0LmdldFN0YXRlQW5kUHJvbW90aW9ucyhzZXJpYWxpemVyLCBnZXRQcm9tb3Rpb25zKTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKHNlcmlhbGl6ZXIsIGpzb24pIHtcclxuICAgIGlmIChzZXJpYWxpemVyICYmICFfLmlzT2JqZWN0KHNlcmlhbGl6ZXIpKSB0aHJvdyBuZXcgRXJyb3IoXCJBcmd1bWVudCAnc2VyaWFsaXplcicgaXMgbm90IGFuIG9iamVjdC5cIik7XHJcbiAgICBpZiAoIV8uaXNPYmplY3QoanNvbikpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAnanNvbicgaXMgbm90IGFuIG9iamVjdC5cIik7XHJcblxyXG4gICAgdGhpcy5faW5pdGlhbGl6ZSgpO1xyXG4gICAgdGhpcy5fdGltZXN0YW1wID0gbmV3IERhdGUoKTtcclxuICAgIHRoaXMuX2NvbnRleHQuc2V0U3RhdGUoc2VyaWFsaXplciwganNvbik7XHJcbn1cclxuLyogU0VSSUFMSVpBVElPTiAqL1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZTsiXX0=
