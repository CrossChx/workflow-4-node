"use strict";
"use strict";
var _ = require("lodash");
var errors = require("../common/errors");
var Activity = require("./activity");
var is = require("../common/is");
var path = require("path");
var fs = require("fs");
var Reflection = require("backpack-node").system.Reflection;
var templateHelpers = require('./templateHelpers');
var activityTypeNameRex = /^\@([a-zA-Z_]+[0-9a-zA-Z_]*)$/;
function getActivityTypeName(str) {
  if (_.isString(str)) {
    var result = activityTypeNameRex.exec(str);
    if (result && result.length === 2) {
      return result[1];
    }
  }
  return null;
}
function requireFromRoot(resource) {
  var pPos = resource.indexOf("/");
  if (pPos === -1) {
    return require(resource);
  }
  var module = resource.substr(0, pPos);
  if (!module) {
    return require(resource);
  }
  try {
    module = require(module);
    var obj = module;
    var $__3 = true;
    var $__4 = false;
    var $__5 = undefined;
    try {
      for (var $__1 = void 0,
          $__0 = (resource.substr(pPos + 1).split("/"))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
        var key = $__1.value;
        {
          obj = obj[key];
        }
      }
    } catch ($__6) {
      $__4 = true;
      $__5 = $__6;
    } finally {
      try {
        if (!$__3 && $__0.return != null) {
          $__0.return();
        }
      } finally {
        if ($__4) {
          throw $__5;
        }
      }
    }
    return obj;
  } catch (e) {
    return require(resource);
  }
}
function ActivityMarkup() {
  this._systemTypes = new Map();
  this._registerSystemTypes();
}
ActivityMarkup.prototype._registerSystemTypes = function() {
  this._registerTypes(__dirname);
};
ActivityMarkup.prototype._registerTypes = function(sourcePath) {
  this._registerTypesTo(this._systemTypes, sourcePath);
};
ActivityMarkup.prototype._registerTypesTo = function(types, sourcePath) {
  var self = this;
  var obj = requireFromRoot(sourcePath);
  Reflection.visitObject(obj, function(inObj) {
    var alias = self._getAlias(inObj);
    if (alias && !types.has(alias)) {
      types.set(alias, inObj);
    }
    return alias === null;
  });
};
ActivityMarkup.prototype._getAlias = function(type) {
  if (_.isFunction(type) && is.defined(type.super_)) {
    var alias = this._toCamelCase(type.name);
    do {
      if (type.super_ === Activity) {
        return alias;
      }
      type = type.super_;
    } while (type);
  }
  return null;
};
ActivityMarkup.prototype._toCamelCase = function(id) {
  return id[0].toLowerCase() + id.substr(1);
};
ActivityMarkup.prototype.parse = function(markup) {
  if (!markup) {
    throw new TypeError("Parameter 'markup' expected.");
  }
  if (_.isString(markup)) {
    markup = JSON.parse(markup);
  }
  if (!_.isPlainObject(markup)) {
    throw new TypeError("Parameter 'markup' is not a plain object.");
  }
  var types = new Map();
  this._systemTypes.forEach(function(value, key) {
    types.set(key, value);
  });
  var req = markup["@require"];
  if (req) {
    this._require(types, req);
  }
  var activity = this._createActivity(types, markup);
  if (req) {
    activity["@require"] = req;
  }
  return activity;
};
ActivityMarkup.prototype._createActivity = function(types, markup) {
  var filedNames = _.filter(_.keys(markup), function(k) {
    return k !== "@require";
  });
  if (filedNames.length !== 1) {
    throw new errors.ActivityMarkupError("There should be one field." + this._errorHint(markup));
  }
  var activityAlias = getActivityTypeName(filedNames[0]);
  if (activityAlias) {
    return this._createAndInitActivityInstance(types, activityAlias, markup);
  } else {
    throw new errors.ActivityMarkupError("Root entry is not an activity type name '" + filedNames[0] + "'." + this._errorHint(markup));
  }
};
ActivityMarkup.prototype._createAndInitActivityInstance = function(types, typeName, markup) {
  var activity = this._createActivityInstance(types, typeName);
  if (!activity) {
    throw new errors.ActivityMarkupError("Unknown activity type name '" + typeName + "'." + this._errorHint(markup));
  }
  var activityRef = {
    name: typeName,
    value: activity
  };
  var pars = markup["@" + typeName];
  if (pars) {
    this._setupActivity(types, activityRef, pars);
  }
  return activityRef.value;
};
ActivityMarkup.prototype._createActivityInstance = function(types, alias) {
  var Constructor = types.get(alias);
  if (is.undefined(Constructor)) {
    return null;
  }
  return new Constructor();
};
ActivityMarkup.prototype._setupActivity = function(types, activityRef, pars) {
  var self = this;
  var activity = activityRef.value;
  function noFunction(fieldName) {
    return activity.codeProperties.has(fieldName);
  }
  if (_.isArray(pars)) {
    activity.args = [];
    pars.forEach(function(obj) {
      activity.args.push(self._createValue(types, obj, false, is.template(activity)));
    });
  } else if (_.isObject(pars)) {
    var to = null;
    for (var fieldName in pars) {
      if (fieldName === "args") {
        var v = self._createValue(types, pars[fieldName], true, is.template(activity));
        if (!_.isArray(v)) {
          v = [v];
        }
        activity.args = v;
      } else if (fieldName === "@to") {
        if (to) {
          throw new errors.ActivityMarkupError("Multiple to defined in activity '" + activityRef.name + "." + this._errorHint(pars));
        }
        to = pars[fieldName];
      } else if (fieldName[0] === "!") {
        if (!activity.promotedProperties || !_.isFunction(activity.promoted)) {
          throw new errors.ActivityMarkupError("Activity '" + activityRef.name + " cannot have promoted properties." + this._errorHint(pars));
        }
        activity.promoted(fieldName.substr(1), self._createValue(types, pars[fieldName], true, is.template(activity)));
      } else if (fieldName === "@require") {
        self._require(types, pars[fieldName]);
      } else {
        activity[fieldName] = self._createValue(types, pars[fieldName], false, is.template(activity), noFunction(fieldName));
      }
    }
    if (to) {
      var current = activity;
      var assign = activityRef.value = this._createActivityInstance(types, "assign");
      assign.value = current;
      assign.to = to;
    }
  } else {
    activity.args = [self._createValue(types, pars, false, is.template(activity))];
  }
};
ActivityMarkup.prototype._require = function(types, markup) {
  var self = this;
  if (_.isArray(markup)) {
    markup.forEach(function(item) {
      self._require(types, item);
    });
  } else if (_.isString(markup)) {
    self._registerTypesTo(types, markup);
  } else {
    throw new errors.ActivityMarkupError("Cannot register '" + markup + "'." + self._errorHint(markup));
  }
};
ActivityMarkup.prototype._createValue = function(types, markup, canBeArray, noTemplate, noFunction) {
  var self = this;
  function templatize(_markup) {
    var template = self._createActivityInstance(types, "template");
    template.declare = _markup;
    return template;
  }
  function funcletize(f) {
    var func = self._createActivityInstance(types, "func");
    func.code = f;
    return func;
  }
  function expressionize(str) {
    var expr = self._createActivityInstance(types, "expression");
    expr.expr = str;
    return expr;
  }
  if (_.isArray(markup)) {
    if (canBeArray) {
      var result = [];
      markup.forEach(function(v) {
        result.push(self._createValue(types, v));
      });
      return result;
    } else if (!noTemplate && templateHelpers.isTemplate(markup)) {
      return templatize(markup);
    }
  } else if (_.isPlainObject(markup)) {
    var filedNames = _.keys(markup);
    if (filedNames.length === 1) {
      var fieldName = filedNames[0];
      var fieldValue = markup[fieldName];
      if (fieldName === "_") {
        return fieldValue;
      }
      var activityTypeName = getActivityTypeName(fieldName);
      if (activityTypeName) {
        return self._createAndInitActivityInstance(types, activityTypeName, markup);
      }
    }
    if (!noTemplate && templateHelpers.isTemplate(markup)) {
      return templatize(markup);
    }
  } else if (_.isString(markup)) {
    var str = markup.trim();
    if (templateHelpers.isFunctionString(str)) {
      var f;
      eval("f = function(_){return (" + str + ");}");
      f = f(_);
      if (!noFunction) {
        return funcletize(f);
      } else {
        return f;
      }
    } else if (str.length > 1) {
      if (str[0] === "#") {
        return expressionize(str.substr(1));
      } else if (str[0] === "=") {
        return expressionize(templateHelpers.asGet(str.substr(1)));
      }
    }
  } else if (_.isFunction(markup)) {
    if (!noFunction) {
      return funcletize(markup);
    }
  }
  return markup;
};
ActivityMarkup.prototype._errorHint = function(markup) {
  var len = 20;
  var json = JSON.stringify(markup);
  if (json.length > len) {
    json = json.substr(0, len) + " ...";
  }
  return "\nSee error near:\n" + json;
};
ActivityMarkup.prototype.stringify = function(obj) {
  if (_.isString(obj)) {
    return obj;
  }
  if (is.activity(obj)) {
    obj = this.toMarkup(obj);
  }
  if (!_.isPlainObject(obj)) {
    throw new TypeError("Parameter 'obj' is not a plain object.");
  }
  var cloned = _.cloneDeep(obj);
  this._functionsToString(cloned);
  return JSON.stringify(cloned);
};
ActivityMarkup.prototype._functionsToString = function(obj) {
  var self = this;
  for (var fieldName in obj) {
    var fieldValue = obj[fieldName];
    if (_.isFunction(fieldValue)) {
      obj[fieldName] = fieldValue.toString();
    } else if (_.isObject(fieldValue)) {
      self._functionsToString(fieldValue);
    } else if (_.isArray(fieldValue)) {
      var $__3 = true;
      var $__4 = false;
      var $__5 = undefined;
      try {
        for (var $__1 = void 0,
            $__0 = (fieldValue)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
          var v = $__1.value;
          {
            self._functionsToString(v);
          }
        }
      } catch ($__6) {
        $__4 = true;
        $__5 = $__6;
      } finally {
        try {
          if (!$__3 && $__0.return != null) {
            $__0.return();
          }
        } finally {
          if ($__4) {
            throw $__5;
          }
        }
      }
    }
  }
};
ActivityMarkup.prototype.toMarkup = function(activity) {
  throw new Error("Not supported yet!");
};
var activityMarkup = null;
module.exports = {
  parse: function(markup) {
    return (activityMarkup = (activityMarkup || new ActivityMarkup())).parse(markup);
  },
  toMarkup: function(activity) {
    return (activityMarkup = (activityMarkup || new ActivityMarkup())).toMarkup(activity);
  },
  stringify: function(obj) {
    return (activityMarkup = (activityMarkup || new ActivityMarkup())).stringify(obj);
  }
};
//# sourceMappingURL=data:application/json;base64,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Q0FBQztBQUN6QyxDQUFDO0FBSUQsQUFBSSxFQUFBLENBQUEsY0FBYSxFQUFJLEtBQUcsQ0FBQztBQUV6QixLQUFLLFFBQVEsRUFBSTtBQUNiLE1BQUksQ0FBRyxVQUFVLE1BQUssQ0FBRztBQUNyQixTQUFPLENBQUEsQ0FBQyxjQUFhLEVBQUksRUFBQyxjQUFhLEdBQUssSUFBSSxlQUFhLEFBQUMsRUFBQyxDQUFDLENBQUMsTUFBTSxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7RUFDcEY7QUFFQSxTQUFPLENBQUcsVUFBVSxRQUFPLENBQUc7QUFDMUIsU0FBTyxDQUFBLENBQUMsY0FBYSxFQUFJLEVBQUMsY0FBYSxHQUFLLElBQUksZUFBYSxBQUFDLEVBQUMsQ0FBQyxDQUFDLFNBQVMsQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0VBQ3pGO0FBRUEsVUFBUSxDQUFHLFVBQVUsR0FBRSxDQUFHO0FBQ3RCLFNBQU8sQ0FBQSxDQUFDLGNBQWEsRUFBSSxFQUFDLGNBQWEsR0FBSyxJQUFJLGVBQWEsQUFBQyxFQUFDLENBQUMsQ0FBQyxVQUFVLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0FBQztFQUNyRjtBQUFBLEFBQ0osQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvYWN0aXZpdHlNYXJrdXAuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKiBqc2hpbnQgLVcwNjEgKi9cblxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IGVycm9ycyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZXJyb3JzXCIpO1xubGV0IEFjdGl2aXR5ID0gcmVxdWlyZShcIi4vYWN0aXZpdHlcIik7XG5sZXQgaXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2lzXCIpO1xubGV0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmxldCBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcbmxldCBSZWZsZWN0aW9uID0gcmVxdWlyZShcImJhY2twYWNrLW5vZGVcIikuc3lzdGVtLlJlZmxlY3Rpb247XG5sZXQgdGVtcGxhdGVIZWxwZXJzID0gcmVxdWlyZSgnLi90ZW1wbGF0ZUhlbHBlcnMnKTtcblxuY29uc3QgYWN0aXZpdHlUeXBlTmFtZVJleCA9IC9eXFxAKFthLXpBLVpfXStbMC05YS16QS1aX10qKSQvO1xuZnVuY3Rpb24gZ2V0QWN0aXZpdHlUeXBlTmFtZShzdHIpIHtcbiAgICBpZiAoXy5pc1N0cmluZyhzdHIpKSB7XG4gICAgICAgIGxldCByZXN1bHQgPSBhY3Rpdml0eVR5cGVOYW1lUmV4LmV4ZWMoc3RyKTtcbiAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0WzFdO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiByZXF1aXJlRnJvbVJvb3QocmVzb3VyY2UpIHtcbiAgICBsZXQgcFBvcyA9IHJlc291cmNlLmluZGV4T2YoXCIvXCIpO1xuICAgIGlmIChwUG9zID09PSAtMSkge1xuICAgICAgICByZXR1cm4gcmVxdWlyZShyZXNvdXJjZSk7XG4gICAgfVxuICAgIGxldCBtb2R1bGUgPSByZXNvdXJjZS5zdWJzdHIoMCwgcFBvcyk7XG4gICAgaWYgKCFtb2R1bGUpIHtcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUocmVzb3VyY2UpO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgICBtb2R1bGUgPSByZXF1aXJlKG1vZHVsZSk7XG4gICAgICAgIGxldCBvYmogPSBtb2R1bGU7XG4gICAgICAgIGZvciAobGV0IGtleSBvZiByZXNvdXJjZS5zdWJzdHIocFBvcyArIDEpLnNwbGl0KFwiL1wiKSkge1xuICAgICAgICAgICAgb2JqID0gb2JqW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG9iajtcbiAgICB9XG4gICAgY2F0Y2goZSkge1xuICAgICAgICByZXR1cm4gcmVxdWlyZShyZXNvdXJjZSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBBY3Rpdml0eU1hcmt1cCgpIHtcbiAgICB0aGlzLl9zeXN0ZW1UeXBlcyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLl9yZWdpc3RlclN5c3RlbVR5cGVzKCk7XG59XG5cbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS5fcmVnaXN0ZXJTeXN0ZW1UeXBlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLl9yZWdpc3RlclR5cGVzKF9fZGlybmFtZSk7XG59O1xuXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX3JlZ2lzdGVyVHlwZXMgPSBmdW5jdGlvbiAoc291cmNlUGF0aCkge1xuICAgIHRoaXMuX3JlZ2lzdGVyVHlwZXNUbyh0aGlzLl9zeXN0ZW1UeXBlcywgc291cmNlUGF0aCk7XG59O1xuXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX3JlZ2lzdGVyVHlwZXNUbyA9IGZ1bmN0aW9uICh0eXBlcywgc291cmNlUGF0aCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBsZXQgb2JqID0gcmVxdWlyZUZyb21Sb290KHNvdXJjZVBhdGgpO1xuICAgIFJlZmxlY3Rpb24udmlzaXRPYmplY3Qob2JqLCBmdW5jdGlvbiAoaW5PYmopIHtcbiAgICAgICAgbGV0IGFsaWFzID0gc2VsZi5fZ2V0QWxpYXMoaW5PYmopO1xuICAgICAgICBpZiAoYWxpYXMgJiYgIXR5cGVzLmhhcyhhbGlhcykpIHtcbiAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYWN0aXZpdHkgdHlwZVxuICAgICAgICAgICAgdHlwZXMuc2V0KGFsaWFzLCBpbk9iaik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFsaWFzID09PSBudWxsO1xuICAgIH0pO1xufTtcblxuQWN0aXZpdHlNYXJrdXAucHJvdG90eXBlLl9nZXRBbGlhcyA9IGZ1bmN0aW9uICh0eXBlKSB7XG4gICAgaWYgKF8uaXNGdW5jdGlvbih0eXBlKSAmJiBpcy5kZWZpbmVkKHR5cGUuc3VwZXJfKSkge1xuICAgICAgICBsZXQgYWxpYXMgPSB0aGlzLl90b0NhbWVsQ2FzZSh0eXBlLm5hbWUpO1xuICAgICAgICBkb1xuICAgICAgICB7XG4gICAgICAgICAgICBpZiAodHlwZS5zdXBlcl8gPT09IEFjdGl2aXR5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFsaWFzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdHlwZSA9IHR5cGUuc3VwZXJfO1xuICAgICAgICB9XG4gICAgICAgIHdoaWxlICh0eXBlKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59O1xuXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX3RvQ2FtZWxDYXNlID0gZnVuY3Rpb24gKGlkKSB7XG4gICAgcmV0dXJuIGlkWzBdLnRvTG93ZXJDYXNlKCkgKyBpZC5zdWJzdHIoMSk7XG59O1xuXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbiAobWFya3VwKSB7XG4gICAgaWYgKCFtYXJrdXApIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlBhcmFtZXRlciAnbWFya3VwJyBleHBlY3RlZC5cIik7XG4gICAgfVxuICAgIGlmIChfLmlzU3RyaW5nKG1hcmt1cCkpIHtcbiAgICAgICAgbWFya3VwID0gSlNPTi5wYXJzZShtYXJrdXApO1xuICAgIH1cbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChtYXJrdXApKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJQYXJhbWV0ZXIgJ21hcmt1cCcgaXMgbm90IGEgcGxhaW4gb2JqZWN0LlwiKTtcbiAgICB9XG5cbiAgICBsZXQgdHlwZXMgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5fc3lzdGVtVHlwZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkge1xuICAgICAgICB0eXBlcy5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgfSk7XG4gICAgbGV0IHJlcSA9IG1hcmt1cFtcIkByZXF1aXJlXCJdO1xuICAgIGlmIChyZXEpIHtcbiAgICAgICAgdGhpcy5fcmVxdWlyZSh0eXBlcywgcmVxKTtcbiAgICB9XG4gICAgbGV0IGFjdGl2aXR5ID0gdGhpcy5fY3JlYXRlQWN0aXZpdHkodHlwZXMsIG1hcmt1cCk7XG4gICAgaWYgKHJlcSkge1xuICAgICAgICBhY3Rpdml0eVtcIkByZXF1aXJlXCJdID0gcmVxO1xuICAgIH1cbiAgICByZXR1cm4gYWN0aXZpdHk7XG59O1xuXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX2NyZWF0ZUFjdGl2aXR5ID0gZnVuY3Rpb24gKHR5cGVzLCBtYXJrdXApIHtcbiAgICBsZXQgZmlsZWROYW1lcyA9IF8uZmlsdGVyKF8ua2V5cyhtYXJrdXApLCBmdW5jdGlvbiAoaykgeyByZXR1cm4gayAhPT0gXCJAcmVxdWlyZVwiOyB9KTtcbiAgICBpZiAoZmlsZWROYW1lcy5sZW5ndGggIT09IDEpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eU1hcmt1cEVycm9yKFwiVGhlcmUgc2hvdWxkIGJlIG9uZSBmaWVsZC5cIiArIHRoaXMuX2Vycm9ySGludChtYXJrdXApKTtcbiAgICB9XG5cbiAgICBsZXQgYWN0aXZpdHlBbGlhcyA9IGdldEFjdGl2aXR5VHlwZU5hbWUoZmlsZWROYW1lc1swXSk7XG4gICAgaWYgKGFjdGl2aXR5QWxpYXMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWF0ZUFuZEluaXRBY3Rpdml0eUluc3RhbmNlKHR5cGVzLCBhY3Rpdml0eUFsaWFzLCBtYXJrdXApO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eU1hcmt1cEVycm9yKFwiUm9vdCBlbnRyeSBpcyBub3QgYW4gYWN0aXZpdHkgdHlwZSBuYW1lICdcIiArIGZpbGVkTmFtZXNbMF0gKyBcIicuXCIgKyB0aGlzLl9lcnJvckhpbnQobWFya3VwKSk7XG4gICAgfVxufTtcblxuQWN0aXZpdHlNYXJrdXAucHJvdG90eXBlLl9jcmVhdGVBbmRJbml0QWN0aXZpdHlJbnN0YW5jZSA9IGZ1bmN0aW9uICh0eXBlcywgdHlwZU5hbWUsIG1hcmt1cCkge1xuICAgIGxldCBhY3Rpdml0eSA9IHRoaXMuX2NyZWF0ZUFjdGl2aXR5SW5zdGFuY2UodHlwZXMsIHR5cGVOYW1lKTtcbiAgICBpZiAoIWFjdGl2aXR5KSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlNYXJrdXBFcnJvcihcIlVua25vd24gYWN0aXZpdHkgdHlwZSBuYW1lICdcIiArIHR5cGVOYW1lICsgXCInLlwiICsgdGhpcy5fZXJyb3JIaW50KG1hcmt1cCkpO1xuICAgIH1cbiAgICBsZXQgYWN0aXZpdHlSZWYgPSB7XG4gICAgICAgIG5hbWU6IHR5cGVOYW1lLFxuICAgICAgICB2YWx1ZTogYWN0aXZpdHlcbiAgICB9O1xuICAgIGxldCBwYXJzID0gbWFya3VwW1wiQFwiICsgdHlwZU5hbWVdO1xuICAgIGlmIChwYXJzKSB7XG4gICAgICAgIHRoaXMuX3NldHVwQWN0aXZpdHkodHlwZXMsIGFjdGl2aXR5UmVmLCBwYXJzKTtcbiAgICB9XG4gICAgcmV0dXJuIGFjdGl2aXR5UmVmLnZhbHVlO1xufTtcblxuQWN0aXZpdHlNYXJrdXAucHJvdG90eXBlLl9jcmVhdGVBY3Rpdml0eUluc3RhbmNlID0gZnVuY3Rpb24gKHR5cGVzLCBhbGlhcykge1xuICAgIGxldCBDb25zdHJ1Y3RvciA9IHR5cGVzLmdldChhbGlhcyk7XG4gICAgaWYgKGlzLnVuZGVmaW5lZChDb25zdHJ1Y3RvcikpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiBuZXcgQ29uc3RydWN0b3IoKTtcbn07XG5cbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS5fc2V0dXBBY3Rpdml0eSA9IGZ1bmN0aW9uICh0eXBlcywgYWN0aXZpdHlSZWYsIHBhcnMpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGFjdGl2aXR5ID0gYWN0aXZpdHlSZWYudmFsdWU7XG5cbiAgICBmdW5jdGlvbiBub0Z1bmN0aW9uKGZpZWxkTmFtZSkge1xuICAgICAgICByZXR1cm4gYWN0aXZpdHkuY29kZVByb3BlcnRpZXMuaGFzKGZpZWxkTmFtZSk7XG4gICAgfVxuXG4gICAgaWYgKF8uaXNBcnJheShwYXJzKSkge1xuICAgICAgICAvLyBhcmdzXG4gICAgICAgIGFjdGl2aXR5LmFyZ3MgPSBbXTtcbiAgICAgICAgcGFycy5mb3JFYWNoKFxuICAgICAgICAgICAgZnVuY3Rpb24gKG9iaikge1xuICAgICAgICAgICAgICAgIGFjdGl2aXR5LmFyZ3MucHVzaChzZWxmLl9jcmVhdGVWYWx1ZSh0eXBlcywgb2JqLCBmYWxzZSwgaXMudGVtcGxhdGUoYWN0aXZpdHkpKSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSBpZiAoXy5pc09iamVjdChwYXJzKSkge1xuICAgICAgICBsZXQgdG8gPSBudWxsO1xuICAgICAgICAvLyB2YWx1ZXNcbiAgICAgICAgZm9yIChsZXQgZmllbGROYW1lIGluIHBhcnMpIHtcbiAgICAgICAgICAgIGlmIChmaWVsZE5hbWUgPT09IFwiYXJnc1wiKSB7XG4gICAgICAgICAgICAgICAgbGV0IHYgPSBzZWxmLl9jcmVhdGVWYWx1ZSh0eXBlcywgcGFyc1tmaWVsZE5hbWVdLCB0cnVlLCBpcy50ZW1wbGF0ZShhY3Rpdml0eSkpO1xuICAgICAgICAgICAgICAgIGlmICghXy5pc0FycmF5KHYpKSB7XG4gICAgICAgICAgICAgICAgICAgIHYgPSBbdl07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGFjdGl2aXR5LmFyZ3MgPSB2O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoZmllbGROYW1lID09PSBcIkB0b1wiKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRvKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlNYXJrdXBFcnJvcihcIk11bHRpcGxlIHRvIGRlZmluZWQgaW4gYWN0aXZpdHkgJ1wiICsgYWN0aXZpdHlSZWYubmFtZSArIFwiLlwiICsgdGhpcy5fZXJyb3JIaW50KHBhcnMpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdG8gPSBwYXJzW2ZpZWxkTmFtZV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChmaWVsZE5hbWVbMF0gPT09IFwiIVwiKSB7XG4gICAgICAgICAgICAgICAgLy8gUHJvbW90ZWQ6XG4gICAgICAgICAgICAgICAgaWYgKCFhY3Rpdml0eS5wcm9tb3RlZFByb3BlcnRpZXMgfHwgIV8uaXNGdW5jdGlvbihhY3Rpdml0eS5wcm9tb3RlZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eU1hcmt1cEVycm9yKFwiQWN0aXZpdHkgJ1wiICsgYWN0aXZpdHlSZWYubmFtZSArIFwiIGNhbm5vdCBoYXZlIHByb21vdGVkIHByb3BlcnRpZXMuXCIgKyB0aGlzLl9lcnJvckhpbnQocGFycykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhY3Rpdml0eS5wcm9tb3RlZChmaWVsZE5hbWUuc3Vic3RyKDEpLCBzZWxmLl9jcmVhdGVWYWx1ZSh0eXBlcywgcGFyc1tmaWVsZE5hbWVdLCB0cnVlLCBpcy50ZW1wbGF0ZShhY3Rpdml0eSkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGZpZWxkTmFtZSA9PT0gXCJAcmVxdWlyZVwiKSB7XG4gICAgICAgICAgICAgICAgLy8gUmVxdWlyZTpcbiAgICAgICAgICAgICAgICBzZWxmLl9yZXF1aXJlKHR5cGVzLCBwYXJzW2ZpZWxkTmFtZV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgYWN0aXZpdHlbZmllbGROYW1lXSA9IHNlbGYuX2NyZWF0ZVZhbHVlKHR5cGVzLCBwYXJzW2ZpZWxkTmFtZV0sIGZhbHNlLCBpcy50ZW1wbGF0ZShhY3Rpdml0eSksIG5vRnVuY3Rpb24oZmllbGROYW1lKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRvKSB7XG4gICAgICAgICAgICBsZXQgY3VycmVudCA9IGFjdGl2aXR5O1xuICAgICAgICAgICAgbGV0IGFzc2lnbiA9IGFjdGl2aXR5UmVmLnZhbHVlID0gdGhpcy5fY3JlYXRlQWN0aXZpdHlJbnN0YW5jZSh0eXBlcywgXCJhc3NpZ25cIik7XG4gICAgICAgICAgICBhc3NpZ24udmFsdWUgPSBjdXJyZW50O1xuICAgICAgICAgICAgYXNzaWduLnRvID0gdG87XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIC8vIDEgYXJnXG4gICAgICAgIGFjdGl2aXR5LmFyZ3MgPSBbc2VsZi5fY3JlYXRlVmFsdWUodHlwZXMsIHBhcnMsIGZhbHNlLCBpcy50ZW1wbGF0ZShhY3Rpdml0eSkpXTtcbiAgICB9XG59O1xuXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX3JlcXVpcmUgPSBmdW5jdGlvbiAodHlwZXMsIG1hcmt1cCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIGlmIChfLmlzQXJyYXkobWFya3VwKSkge1xuICAgICAgICBtYXJrdXAuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgICAgICAgc2VsZi5fcmVxdWlyZSh0eXBlcywgaXRlbSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIGlmIChfLmlzU3RyaW5nKG1hcmt1cCkpIHtcbiAgICAgICAgc2VsZi5fcmVnaXN0ZXJUeXBlc1RvKHR5cGVzLCBtYXJrdXApO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eU1hcmt1cEVycm9yKFwiQ2Fubm90IHJlZ2lzdGVyICdcIiArIG1hcmt1cCArIFwiJy5cIiArIHNlbGYuX2Vycm9ySGludChtYXJrdXApKTtcbiAgICB9XG59O1xuXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX2NyZWF0ZVZhbHVlID0gZnVuY3Rpb24gKHR5cGVzLCBtYXJrdXAsIGNhbkJlQXJyYXksIG5vVGVtcGxhdGUsIG5vRnVuY3Rpb24pIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG5cbiAgICAvLyBIZWxwZXJzXG4gICAgZnVuY3Rpb24gdGVtcGxhdGl6ZShfbWFya3VwKSB7XG4gICAgICAgIGxldCB0ZW1wbGF0ZSA9IHNlbGYuX2NyZWF0ZUFjdGl2aXR5SW5zdGFuY2UodHlwZXMsIFwidGVtcGxhdGVcIik7XG4gICAgICAgIHRlbXBsYXRlLmRlY2xhcmUgPSBfbWFya3VwO1xuICAgICAgICByZXR1cm4gdGVtcGxhdGU7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZnVuY2xldGl6ZShmKSB7XG4gICAgICAgIGxldCBmdW5jID0gc2VsZi5fY3JlYXRlQWN0aXZpdHlJbnN0YW5jZSh0eXBlcywgXCJmdW5jXCIpO1xuICAgICAgICBmdW5jLmNvZGUgPSBmO1xuICAgICAgICByZXR1cm4gZnVuYztcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBleHByZXNzaW9uaXplKHN0cikge1xuICAgICAgICBsZXQgZXhwciA9IHNlbGYuX2NyZWF0ZUFjdGl2aXR5SW5zdGFuY2UodHlwZXMsIFwiZXhwcmVzc2lvblwiKTtcbiAgICAgICAgZXhwci5leHByID0gc3RyO1xuICAgICAgICByZXR1cm4gZXhwcjtcbiAgICB9XG5cbiAgICBpZiAoXy5pc0FycmF5KG1hcmt1cCkpIHtcbiAgICAgICAgaWYgKGNhbkJlQXJyYXkpIHtcbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICAgICAgICAgIG1hcmt1cC5mb3JFYWNoKGZ1bmN0aW9uICh2KSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goc2VsZi5fY3JlYXRlVmFsdWUodHlwZXMsIHYpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICghbm9UZW1wbGF0ZSAmJiB0ZW1wbGF0ZUhlbHBlcnMuaXNUZW1wbGF0ZShtYXJrdXApKSB7XG4gICAgICAgICAgICByZXR1cm4gdGVtcGxhdGl6ZShtYXJrdXApO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVsc2UgaWYgKF8uaXNQbGFpbk9iamVjdChtYXJrdXApKSB7XG4gICAgICAgIGxldCBmaWxlZE5hbWVzID0gXy5rZXlzKG1hcmt1cCk7XG4gICAgICAgIGlmIChmaWxlZE5hbWVzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgbGV0IGZpZWxkTmFtZSA9IGZpbGVkTmFtZXNbMF07XG4gICAgICAgICAgICBsZXQgZmllbGRWYWx1ZSA9IG1hcmt1cFtmaWVsZE5hbWVdO1xuXG4gICAgICAgICAgICBpZiAoZmllbGROYW1lID09PSBcIl9cIikge1xuICAgICAgICAgICAgICAgIC8vIEVzY2FwZTpcbiAgICAgICAgICAgICAgICByZXR1cm4gZmllbGRWYWx1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGFjdGl2aXR5VHlwZU5hbWUgPSBnZXRBY3Rpdml0eVR5cGVOYW1lKGZpZWxkTmFtZSk7XG4gICAgICAgICAgICBpZiAoYWN0aXZpdHlUeXBlTmFtZSkge1xuICAgICAgICAgICAgICAgIC8vIEFjdGl2aXR5OlxuICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVBbmRJbml0QWN0aXZpdHlJbnN0YW5jZSh0eXBlcywgYWN0aXZpdHlUeXBlTmFtZSwgbWFya3VwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFBsYWluIG9iamVjdDpcbiAgICAgICAgaWYgKCFub1RlbXBsYXRlICYmIHRlbXBsYXRlSGVscGVycy5pc1RlbXBsYXRlKG1hcmt1cCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0aXplKG1hcmt1cCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSBpZiAoXy5pc1N0cmluZyhtYXJrdXApKSB7XG4gICAgICAgIGxldCBzdHIgPSBtYXJrdXAudHJpbSgpO1xuICAgICAgICBpZiAodGVtcGxhdGVIZWxwZXJzLmlzRnVuY3Rpb25TdHJpbmcoc3RyKSkge1xuICAgICAgICAgICAgbGV0IGY7XG4gICAgICAgICAgICBldmFsKFwiZiA9IGZ1bmN0aW9uKF8pe3JldHVybiAoXCIgKyBzdHIgKyBcIik7fVwiKTtcbiAgICAgICAgICAgIGYgPSBmKF8pO1xuICAgICAgICAgICAgaWYgKCFub0Z1bmN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmNsZXRpemUoZik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZjsgLy8gYWthIHdoZW4gZnVuYy5jb2RlXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoc3RyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIGlmIChzdHJbMF0gPT09IFwiI1wiKSB7XG4gICAgICAgICAgICAgICAgLy8gRXhwcmVzc2lvblxuICAgICAgICAgICAgICAgIHJldHVybiBleHByZXNzaW9uaXplKHN0ci5zdWJzdHIoMSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoc3RyWzBdID09PSBcIj1cIikge1xuICAgICAgICAgICAgICAgIC8vIEdldFxuICAgICAgICAgICAgICAgIHJldHVybiBleHByZXNzaW9uaXplKHRlbXBsYXRlSGVscGVycy5hc0dldChzdHIuc3Vic3RyKDEpKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSBpZiAoXy5pc0Z1bmN0aW9uKG1hcmt1cCkpIHtcbiAgICAgICAgaWYgKCFub0Z1bmN0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY2xldGl6ZShtYXJrdXApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG1hcmt1cDtcbn07XG5cbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS5fZXJyb3JIaW50ID0gZnVuY3Rpb24gKG1hcmt1cCkge1xuICAgIGxldCBsZW4gPSAyMDtcbiAgICBsZXQganNvbiA9IEpTT04uc3RyaW5naWZ5KG1hcmt1cCk7XG4gICAgaWYgKGpzb24ubGVuZ3RoID4gbGVuKSB7XG4gICAgICAgIGpzb24gPSBqc29uLnN1YnN0cigwLCBsZW4pICsgXCIgLi4uXCI7XG4gICAgfVxuICAgIHJldHVybiBcIlxcblNlZSBlcnJvciBuZWFyOlxcblwiICsganNvbjtcbn07XG5cbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS5zdHJpbmdpZnkgPSBmdW5jdGlvbiAob2JqKSB7XG4gICAgaWYgKF8uaXNTdHJpbmcob2JqKSkge1xuICAgICAgICByZXR1cm4gb2JqO1xuICAgIH1cbiAgICBpZiAoaXMuYWN0aXZpdHkob2JqKSkge1xuICAgICAgICBvYmogPSB0aGlzLnRvTWFya3VwKG9iaik7XG4gICAgfVxuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG9iaikpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlBhcmFtZXRlciAnb2JqJyBpcyBub3QgYSBwbGFpbiBvYmplY3QuXCIpO1xuICAgIH1cbiAgICBsZXQgY2xvbmVkID0gXy5jbG9uZURlZXAob2JqKTtcbiAgICB0aGlzLl9mdW5jdGlvbnNUb1N0cmluZyhjbG9uZWQpO1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShjbG9uZWQpO1xufTtcblxuQWN0aXZpdHlNYXJrdXAucHJvdG90eXBlLl9mdW5jdGlvbnNUb1N0cmluZyA9IGZ1bmN0aW9uIChvYmopIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgZm9yIChsZXQgZmllbGROYW1lIGluIG9iaikge1xuICAgICAgICBsZXQgZmllbGRWYWx1ZSA9IG9ialtmaWVsZE5hbWVdO1xuICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKGZpZWxkVmFsdWUpKSB7XG4gICAgICAgICAgICBvYmpbZmllbGROYW1lXSA9IGZpZWxkVmFsdWUudG9TdHJpbmcoKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChfLmlzT2JqZWN0KGZpZWxkVmFsdWUpKSB7XG4gICAgICAgICAgICBzZWxmLl9mdW5jdGlvbnNUb1N0cmluZyhmaWVsZFZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChfLmlzQXJyYXkoZmllbGRWYWx1ZSkpIHtcbiAgICAgICAgICAgIGZvciAobGV0IHYgb2YgZmllbGRWYWx1ZSkge1xuICAgICAgICAgICAgICAgIHNlbGYuX2Z1bmN0aW9uc1RvU3RyaW5nKHYpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcblxuLy8gVG8gTWFya3VwOlxuXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUudG9NYXJrdXAgPSBmdW5jdGlvbiAoYWN0aXZpdHkpIHtcbiAgICAvKmlmICghaXMuYWN0aXZpdHkoYWN0aXZpdHkpKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCBpcyBub3QgYW4gYWN0aXZpdHkgaW5zdGFuY2UuXCIpO1xuICAgIH1cbiAgICBsZXQgbWFya3VwID0ge307XG4gICAgbGV0IGFsaWFzID0gdGhpcy5fZ2V0QWxpYXMoYWN0aXZpdHkuY29uc3RydWN0b3IpO1xuICAgIGxldCBhY3Rpdml0eU1hcmt1cCA9IHRoaXMuX2NyZWF0ZU1hcmt1cE9mQWN0aXZpdHkoYWN0aXZpdHkpOyovXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTm90IHN1cHBvcnRlZCB5ZXQhXCIpO1xufTtcblxuLy8gRXhwb3J0czpcblxubGV0IGFjdGl2aXR5TWFya3VwID0gbnVsbDtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgcGFyc2U6IGZ1bmN0aW9uIChtYXJrdXApIHtcbiAgICAgICAgcmV0dXJuIChhY3Rpdml0eU1hcmt1cCA9IChhY3Rpdml0eU1hcmt1cCB8fCBuZXcgQWN0aXZpdHlNYXJrdXAoKSkpLnBhcnNlKG1hcmt1cCk7XG4gICAgfSxcblxuICAgIHRvTWFya3VwOiBmdW5jdGlvbiAoYWN0aXZpdHkpIHtcbiAgICAgICAgcmV0dXJuIChhY3Rpdml0eU1hcmt1cCA9IChhY3Rpdml0eU1hcmt1cCB8fCBuZXcgQWN0aXZpdHlNYXJrdXAoKSkpLnRvTWFya3VwKGFjdGl2aXR5KTtcbiAgICB9LFxuXG4gICAgc3RyaW5naWZ5OiBmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgIHJldHVybiAoYWN0aXZpdHlNYXJrdXAgPSAoYWN0aXZpdHlNYXJrdXAgfHwgbmV3IEFjdGl2aXR5TWFya3VwKCkpKS5zdHJpbmdpZnkob2JqKTtcbiAgICB9XG59OyJdfQ==
