"use strict";
var Activity = require("./activity");
var util = require("util");
var errors = require("../common/errors");
var Block = require("./block");
function CancellationScope() {
  Activity.call(this);
  this.cancelled = null;
  this.arrayProperties.add("cancelled");
}
util.inherits(CancellationScope, Activity);
CancellationScope.prototype.initializeStructure = function() {
  this._body = new Block();
  this._body.args = this.args;
  this.args = null;
  if (this.cancelled) {
    var prev = this.cancelled;
    this.cancelled = new Block();
    this.cancelled.args = prev;
  }
};
CancellationScope.prototype.run = function(callContext, args) {
  callContext.schedule(this._body, "_bodyFinished");
};
CancellationScope.prototype._bodyFinished = function(callContext, reason, result) {
  if (this.cancelled && (reason === Activity.states.cancel || (reason === Activity.states.fail && result instanceof errors.Cancelled))) {
    callContext.schedule(this.cancelled);
  } else {
    callContext.end(reason, result);
  }
};
module.exports = CancellationScope;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhbmNlbGxhdGlvblNjb3BlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBRUEsQUFBSSxFQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsWUFBVyxDQUFDLENBQUM7QUFDcEMsQUFBSSxFQUFBLENBQUEsSUFBRyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7QUFDMUIsQUFBSSxFQUFBLENBQUEsTUFBSyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsa0JBQWlCLENBQUMsQ0FBQztBQUN4QyxBQUFJLEVBQUEsQ0FBQSxLQUFJLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxTQUFRLENBQUMsQ0FBQztBQUU5QixPQUFTLGtCQUFnQixDQUFFLEFBQUQsQ0FBRztBQUN6QixTQUFPLEtBQUssQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0FBRW5CLEtBQUcsVUFBVSxFQUFJLEtBQUcsQ0FBQztBQUNyQixLQUFHLGdCQUFnQixJQUFJLEFBQUMsQ0FBQyxXQUFVLENBQUMsQ0FBQztBQUN6QztBQUFBLEFBRUEsR0FBRyxTQUFTLEFBQUMsQ0FBQyxpQkFBZ0IsQ0FBRyxTQUFPLENBQUMsQ0FBQztBQUUxQyxnQkFBZ0IsVUFBVSxvQkFBb0IsRUFBSSxVQUFVLEFBQUQsQ0FBRztBQUMxRCxLQUFHLE1BQU0sRUFBSSxJQUFJLE1BQUksQUFBQyxFQUFDLENBQUM7QUFDeEIsS0FBRyxNQUFNLEtBQUssRUFBSSxDQUFBLElBQUcsS0FBSyxDQUFDO0FBQzNCLEtBQUcsS0FBSyxFQUFJLEtBQUcsQ0FBQztBQUNoQixLQUFJLElBQUcsVUFBVSxDQUFHO0FBQ2hCLEFBQUksTUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLElBQUcsVUFBVSxDQUFDO0FBQ3pCLE9BQUcsVUFBVSxFQUFJLElBQUksTUFBSSxBQUFDLEVBQUMsQ0FBQztBQUM1QixPQUFHLFVBQVUsS0FBSyxFQUFJLEtBQUcsQ0FBQztFQUM5QjtBQUFBLEFBQ0osQ0FBQztBQUVELGdCQUFnQixVQUFVLElBQUksRUFBSSxVQUFVLFdBQVUsQ0FBRyxDQUFBLElBQUcsQ0FBRztBQUMzRCxZQUFVLFNBQVMsQUFBQyxDQUFDLElBQUcsTUFBTSxDQUFHLGdCQUFjLENBQUMsQ0FBQztBQUNyRCxDQUFDO0FBRUQsZ0JBQWdCLFVBQVUsY0FBYyxFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQy9FLEtBQUksSUFBRyxVQUFVLEdBQ2IsRUFBQyxNQUFLLElBQU0sQ0FBQSxRQUFPLE9BQU8sT0FBTyxDQUFBLEVBQ2hDLEVBQUMsTUFBSyxJQUFNLENBQUEsUUFBTyxPQUFPLEtBQUssQ0FBQSxFQUFLLENBQUEsTUFBSyxXQUFhLENBQUEsTUFBSyxVQUFVLENBQUMsQ0FBQyxDQUFHO0FBQzNFLGNBQVUsU0FBUyxBQUFDLENBQUMsSUFBRyxVQUFVLENBQUMsQ0FBQztFQUN4QyxLQUNLO0FBQ0QsY0FBVSxJQUFJLEFBQUMsQ0FBQyxNQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7RUFDbkM7QUFBQSxBQUNKLENBQUM7QUFFRCxLQUFLLFFBQVEsRUFBSSxrQkFBZ0IsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvY2FuY2VsbGF0aW9uU2NvcGUuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5cclxubGV0IEFjdGl2aXR5ID0gcmVxdWlyZShcIi4vYWN0aXZpdHlcIik7XHJcbmxldCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XHJcbmxldCBlcnJvcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2Vycm9yc1wiKTtcclxubGV0IEJsb2NrID0gcmVxdWlyZShcIi4vYmxvY2tcIik7XHJcblxyXG5mdW5jdGlvbiBDYW5jZWxsYXRpb25TY29wZSgpIHtcclxuICAgIEFjdGl2aXR5LmNhbGwodGhpcyk7XHJcblxyXG4gICAgdGhpcy5jYW5jZWxsZWQgPSBudWxsO1xyXG4gICAgdGhpcy5hcnJheVByb3BlcnRpZXMuYWRkKFwiY2FuY2VsbGVkXCIpO1xyXG59XHJcblxyXG51dGlsLmluaGVyaXRzKENhbmNlbGxhdGlvblNjb3BlLCBBY3Rpdml0eSk7XHJcblxyXG5DYW5jZWxsYXRpb25TY29wZS5wcm90b3R5cGUuaW5pdGlhbGl6ZVN0cnVjdHVyZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHRoaXMuX2JvZHkgPSBuZXcgQmxvY2soKTtcclxuICAgIHRoaXMuX2JvZHkuYXJncyA9IHRoaXMuYXJncztcclxuICAgIHRoaXMuYXJncyA9IG51bGw7XHJcbiAgICBpZiAodGhpcy5jYW5jZWxsZWQpIHtcclxuICAgICAgICBsZXQgcHJldiA9IHRoaXMuY2FuY2VsbGVkO1xyXG4gICAgICAgIHRoaXMuY2FuY2VsbGVkID0gbmV3IEJsb2NrKCk7XHJcbiAgICAgICAgdGhpcy5jYW5jZWxsZWQuYXJncyA9IHByZXY7XHJcbiAgICB9XHJcbn07XHJcblxyXG5DYW5jZWxsYXRpb25TY29wZS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBhcmdzKSB7XHJcbiAgICBjYWxsQ29udGV4dC5zY2hlZHVsZSh0aGlzLl9ib2R5LCBcIl9ib2R5RmluaXNoZWRcIik7XHJcbn07XHJcblxyXG5DYW5jZWxsYXRpb25TY29wZS5wcm90b3R5cGUuX2JvZHlGaW5pc2hlZCA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgcmVhc29uLCByZXN1bHQpIHtcclxuICAgIGlmICh0aGlzLmNhbmNlbGxlZCAmJlxyXG4gICAgICAgIChyZWFzb24gPT09IEFjdGl2aXR5LnN0YXRlcy5jYW5jZWwgfHxcclxuICAgICAgICAgKHJlYXNvbiA9PT0gQWN0aXZpdHkuc3RhdGVzLmZhaWwgJiYgcmVzdWx0IGluc3RhbmNlb2YgZXJyb3JzLkNhbmNlbGxlZCkpKSB7XHJcbiAgICAgICAgY2FsbENvbnRleHQuc2NoZWR1bGUodGhpcy5jYW5jZWxsZWQpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgY2FsbENvbnRleHQuZW5kKHJlYXNvbiwgcmVzdWx0KTtcclxuICAgIH1cclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gQ2FuY2VsbGF0aW9uU2NvcGU7Il19
