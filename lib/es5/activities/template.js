"use strict";
var Activity = require('./activity');
var util = require('util');
var _ = require('lodash');
var activityMarkup = require('./activityMarkup');
var fast = require('fast.js');
var is = require('../common/is');
var templateHelpers = require('./templateHelpers');
var guids = require('../common/guids');
function Template() {
  Activity.call(this);
  this[guids.types.template] = true;
  this.nonScopedProperties.add(guids.types.template);
  this.declare = null;
  this.nonScopedProperties.add('_visitActivities');
  this.nonScopedProperties.add('_getInternalActivities');
}
util.inherits(Template, Activity);
Template.prototype._getInternalActivities = function() {
  var self = this;
  if (!self.args) {
    self.args = [];
    templateHelpers.visitActivities(self.declare, function(markup, parent, key) {
      self.args.push(activityMarkup.parse(markup));
    });
  }
  return self.args;
};
Template.prototype.forEachImmediateChild = function(f) {
  Activity.prototype.forEachImmediateChild.call(this, f);
  fast.forEach(this._getInternalActivities(), function(activity) {
    f(activity);
  });
};
Template.prototype._forEach = function(f, visited, except) {
  Activity.prototype._forEach.call(this, f, visited, except);
  fast.forEach(this._getInternalActivities(), function(activity) {
    activity._forEach(f, visited, except);
  });
};
Template.prototype.run = function(callContext, args) {
  if (_.isArray(args)) {
    callContext.schedule(args, '_activitiesGot');
  } else {
    callContext.complete();
  }
};
Template.prototype._activitiesGot = function(callContext, reason, result) {
  if (reason == Activity.states.complete) {
    if (_.isArray(result) && result.length) {
      var idx = 0;
      var declare = _.cloneDeep(this.get("declare"));
      var setupTasks = [];
      templateHelpers.visitActivities(declare, function(markup, parent, key) {
        setupTasks.push(function() {
          parent[key] = result[idx++];
        });
      });
      fast.forEach(setupTasks, function(t) {
        t();
      });
      callContext.complete(declare);
    }
  } else {
    callContext.end(reason, result);
  }
};
module.exports = Template;
//# sourceMappingURL=data:application/json;base64,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LEFBQUMsQ0FBQyxVQUFTLENBQUcsVUFBUyxDQUFBLENBQUc7QUFBRSxRQUFBLEFBQUMsRUFBQyxDQUFDO01BQUUsQ0FBQyxDQUFDO0FBQzlDLGdCQUFVLFNBQVMsQUFBQyxDQUFDLE9BQU0sQ0FBQyxDQUFDO0lBQ2pDO0FBQUEsRUFDSixLQUNLO0FBQ0QsY0FBVSxJQUFJLEFBQUMsQ0FBQyxNQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7RUFDbkM7QUFBQSxBQUNKLENBQUE7QUFFQSxLQUFLLFFBQVEsRUFBSSxTQUFPLENBQUM7QUFBQSIsImZpbGUiOiJhY3Rpdml0aWVzL3RlbXBsYXRlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgQWN0aXZpdHkgPSByZXF1aXJlKCcuL2FjdGl2aXR5Jyk7XG52YXIgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgYWN0aXZpdHlNYXJrdXAgPSByZXF1aXJlKCcuL2FjdGl2aXR5TWFya3VwJyk7XG52YXIgZmFzdCA9IHJlcXVpcmUoJ2Zhc3QuanMnKTtcbnZhciBpcyA9IHJlcXVpcmUoJy4uL2NvbW1vbi9pcycpO1xudmFyIHRlbXBsYXRlSGVscGVycyA9IHJlcXVpcmUoJy4vdGVtcGxhdGVIZWxwZXJzJyk7XG52YXIgZ3VpZHMgPSByZXF1aXJlKCcuLi9jb21tb24vZ3VpZHMnKTtcblxuZnVuY3Rpb24gVGVtcGxhdGUoKSB7XG4gICAgQWN0aXZpdHkuY2FsbCh0aGlzKTtcblxuICAgIHRoaXNbZ3VpZHMudHlwZXMudGVtcGxhdGVdID0gdHJ1ZTtcbiAgICB0aGlzLm5vblNjb3BlZFByb3BlcnRpZXMuYWRkKGd1aWRzLnR5cGVzLnRlbXBsYXRlKTtcblxuICAgIHRoaXMuZGVjbGFyZSA9IG51bGw7XG5cbiAgICB0aGlzLm5vblNjb3BlZFByb3BlcnRpZXMuYWRkKCdfdmlzaXRBY3Rpdml0aWVzJyk7XG4gICAgdGhpcy5ub25TY29wZWRQcm9wZXJ0aWVzLmFkZCgnX2dldEludGVybmFsQWN0aXZpdGllcycpO1xufVxuXG51dGlsLmluaGVyaXRzKFRlbXBsYXRlLCBBY3Rpdml0eSk7XG5cblRlbXBsYXRlLnByb3RvdHlwZS5fZ2V0SW50ZXJuYWxBY3Rpdml0aWVzID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIGlmICghc2VsZi5hcmdzKSB7XG4gICAgICAgIHNlbGYuYXJncyA9IFtdO1xuICAgICAgICB0ZW1wbGF0ZUhlbHBlcnMudmlzaXRBY3Rpdml0aWVzKHNlbGYuZGVjbGFyZSxcbiAgICAgICAgICAgIGZ1bmN0aW9uKG1hcmt1cCwgcGFyZW50LCBrZXkpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmFyZ3MucHVzaChhY3Rpdml0eU1hcmt1cC5wYXJzZShtYXJrdXApKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gc2VsZi5hcmdzO1xufVxuXG5UZW1wbGF0ZS5wcm90b3R5cGUuZm9yRWFjaEltbWVkaWF0ZUNoaWxkID0gZnVuY3Rpb24gKGYpIHtcbiAgICBBY3Rpdml0eS5wcm90b3R5cGUuZm9yRWFjaEltbWVkaWF0ZUNoaWxkLmNhbGwodGhpcywgZik7XG4gICAgZmFzdC5mb3JFYWNoKHRoaXMuX2dldEludGVybmFsQWN0aXZpdGllcygpLCBmdW5jdGlvbihhY3Rpdml0eSkge1xuICAgICAgICBmKGFjdGl2aXR5KTtcbiAgICB9KTtcbn1cblxuVGVtcGxhdGUucHJvdG90eXBlLl9mb3JFYWNoID0gZnVuY3Rpb24gKGYsIHZpc2l0ZWQsIGV4Y2VwdCkge1xuICAgIEFjdGl2aXR5LnByb3RvdHlwZS5fZm9yRWFjaC5jYWxsKHRoaXMsIGYsIHZpc2l0ZWQsIGV4Y2VwdCk7XG4gICAgZmFzdC5mb3JFYWNoKHRoaXMuX2dldEludGVybmFsQWN0aXZpdGllcygpLCBmdW5jdGlvbihhY3Rpdml0eSkge1xuICAgICAgICBhY3Rpdml0eS5fZm9yRWFjaChmLCB2aXNpdGVkLCBleGNlcHQpO1xuICAgIH0pO1xufVxuXG5UZW1wbGF0ZS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24oY2FsbENvbnRleHQsIGFyZ3MpIHtcbiAgICBpZiAoXy5pc0FycmF5KGFyZ3MpKSB7XG4gICAgICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKGFyZ3MsICdfYWN0aXZpdGllc0dvdCcpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY2FsbENvbnRleHQuY29tcGxldGUoKTtcbiAgICB9XG59XG5cblRlbXBsYXRlLnByb3RvdHlwZS5fYWN0aXZpdGllc0dvdCA9IGZ1bmN0aW9uKGNhbGxDb250ZXh0LCByZWFzb24sIHJlc3VsdCkge1xuICAgIGlmIChyZWFzb24gPT0gQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlKSB7XG4gICAgICAgIGlmIChfLmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgaWR4ID0gMDtcbiAgICAgICAgICAgIHZhciBkZWNsYXJlID0gXy5jbG9uZURlZXAodGhpcy5nZXQoXCJkZWNsYXJlXCIpKTtcbiAgICAgICAgICAgIHZhciBzZXR1cFRhc2tzID0gW107XG4gICAgICAgICAgICB0ZW1wbGF0ZUhlbHBlcnMudmlzaXRBY3Rpdml0aWVzKGRlY2xhcmUsIGZ1bmN0aW9uKG1hcmt1cCwgcGFyZW50LCBrZXkpIHtcbiAgICAgICAgICAgICAgICBzZXR1cFRhc2tzLnB1c2goZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmVudFtrZXldID0gcmVzdWx0W2lkeCsrXTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZmFzdC5mb3JFYWNoKHNldHVwVGFza3MsIGZ1bmN0aW9uKHQpIHsgdCgpOyB9KTtcbiAgICAgICAgICAgIGNhbGxDb250ZXh0LmNvbXBsZXRlKGRlY2xhcmUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBUZW1wbGF0ZTsiXX0=
