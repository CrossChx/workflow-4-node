"use strict";
"use strict";
var Activity = require('./activity');
var util = require('util');
var _ = require('lodash');
var activityMarkup = require('./activityMarkup');
var is = require('../common/is');
var templateHelpers = require('./templateHelpers');
var guids = require('../common/guids');
function Template() {
  Activity.call(this);
  this[guids.types.template] = true;
  this.nonScopedProperties.add(guids.types.template);
  this.declare = null;
  this.nonScopedProperties.add('_visitActivities');
  this.nonScopedProperties.add('_getInternalActivities');
}
util.inherits(Template, Activity);
Template.prototype._getInternalActivities = function(require) {
  var self = this;
  if (!self.args) {
    self.args = [];
    templateHelpers.visitActivities(self.declare, function(markup, parent, key) {
      if (require) {
        markup = _.cloneDeep(markup);
        markup["@require"] = require;
      }
      self.args.push(activityMarkup.parse(markup));
    });
  }
  return self.args;
};
Template.prototype.forEachImmediateChild = function(f, execContext) {
  Activity.prototype.forEachImmediateChild.call(this, f);
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (this._getInternalActivities(execContext.rootActivity["@require"]))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var activity = $__1.value;
      {
        f(activity);
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
};
Template.prototype._doForEach = function(f, visited, except) {
  Activity.prototype._doForEach.call(this, f, visited, except);
  var $__3 = true;
  var $__4 = false;
  var $__5 = undefined;
  try {
    for (var $__1 = void 0,
        $__0 = (this._getInternalActivities())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
      var activity = $__1.value;
      {
        activity._doForEach(f, visited, except);
      }
    }
  } catch ($__6) {
    $__4 = true;
    $__5 = $__6;
  } finally {
    try {
      if (!$__3 && $__0.return != null) {
        $__0.return();
      }
    } finally {
      if ($__4) {
        throw $__5;
      }
    }
  }
};
Template.prototype.run = function(callContext, args) {
  if (_.isArray(args)) {
    callContext.schedule(args, '_activitiesGot');
  } else {
    callContext.complete();
  }
};
Template.prototype._activitiesGot = function(callContext, reason, result) {
  if (reason === Activity.states.complete) {
    if (_.isArray(result) && result.length) {
      var idx = 0;
      var declare = _.cloneDeep(this.get("declare"));
      var setupTasks = [];
      templateHelpers.visitActivities(declare, function(markup, parent, key) {
        setupTasks.push(function() {
          parent[key] = result[idx++];
        });
      });
      var $__3 = true;
      var $__4 = false;
      var $__5 = undefined;
      try {
        for (var $__1 = void 0,
            $__0 = (setupTasks)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
          var t = $__1.value;
          {
            t();
          }
        }
      } catch ($__6) {
        $__4 = true;
        $__5 = $__6;
      } finally {
        try {
          if (!$__3 && $__0.return != null) {
            $__0.return();
          }
        } finally {
          if ($__4) {
            throw $__5;
          }
        }
      }
      callContext.complete(declare);
    }
  } else {
    callContext.end(reason, result);
  }
};
module.exports = Template;
//# sourceMappingURL=data:application/json;base64,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MERJLGdCQUFVLFNBQVMsQUFBQyxDQUFDLE9BQU0sQ0FBQyxDQUFDO0lBQ2pDO0FBQUEsRUFDSixLQUNLO0FBQ0QsY0FBVSxJQUFJLEFBQUMsQ0FBQyxNQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7RUFDbkM7QUFBQSxBQUNKLENBQUM7QUFFRCxLQUFLLFFBQVEsRUFBSSxTQUFPLENBQUM7QUFBQSIsImZpbGUiOiJhY3Rpdml0aWVzL3RlbXBsYXRlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IEFjdGl2aXR5ID0gcmVxdWlyZSgnLi9hY3Rpdml0eScpO1xubGV0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5sZXQgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xubGV0IGFjdGl2aXR5TWFya3VwID0gcmVxdWlyZSgnLi9hY3Rpdml0eU1hcmt1cCcpO1xubGV0IGlzID0gcmVxdWlyZSgnLi4vY29tbW9uL2lzJyk7XG5sZXQgdGVtcGxhdGVIZWxwZXJzID0gcmVxdWlyZSgnLi90ZW1wbGF0ZUhlbHBlcnMnKTtcbmxldCBndWlkcyA9IHJlcXVpcmUoJy4uL2NvbW1vbi9ndWlkcycpO1xuXG5mdW5jdGlvbiBUZW1wbGF0ZSgpIHtcbiAgICBBY3Rpdml0eS5jYWxsKHRoaXMpO1xuXG4gICAgdGhpc1tndWlkcy50eXBlcy50ZW1wbGF0ZV0gPSB0cnVlO1xuICAgIHRoaXMubm9uU2NvcGVkUHJvcGVydGllcy5hZGQoZ3VpZHMudHlwZXMudGVtcGxhdGUpO1xuXG4gICAgdGhpcy5kZWNsYXJlID0gbnVsbDtcblxuICAgIHRoaXMubm9uU2NvcGVkUHJvcGVydGllcy5hZGQoJ192aXNpdEFjdGl2aXRpZXMnKTtcbiAgICB0aGlzLm5vblNjb3BlZFByb3BlcnRpZXMuYWRkKCdfZ2V0SW50ZXJuYWxBY3Rpdml0aWVzJyk7XG59XG5cbnV0aWwuaW5oZXJpdHMoVGVtcGxhdGUsIEFjdGl2aXR5KTtcblxuVGVtcGxhdGUucHJvdG90eXBlLl9nZXRJbnRlcm5hbEFjdGl2aXRpZXMgPSBmdW5jdGlvbihyZXF1aXJlKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIGlmICghc2VsZi5hcmdzKSB7XG4gICAgICAgIHNlbGYuYXJncyA9IFtdO1xuICAgICAgICB0ZW1wbGF0ZUhlbHBlcnMudmlzaXRBY3Rpdml0aWVzKHNlbGYuZGVjbGFyZSxcbiAgICAgICAgICAgIGZ1bmN0aW9uKG1hcmt1cCwgcGFyZW50LCBrZXkpIHtcbiAgICAgICAgICAgICAgICBpZiAocmVxdWlyZSkge1xuICAgICAgICAgICAgICAgICAgICBtYXJrdXAgPSBfLmNsb25lRGVlcChtYXJrdXApO1xuICAgICAgICAgICAgICAgICAgICBtYXJrdXBbXCJAcmVxdWlyZVwiXSA9IHJlcXVpcmU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNlbGYuYXJncy5wdXNoKGFjdGl2aXR5TWFya3VwLnBhcnNlKG1hcmt1cCkpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBzZWxmLmFyZ3M7XG59O1xuXG5UZW1wbGF0ZS5wcm90b3R5cGUuZm9yRWFjaEltbWVkaWF0ZUNoaWxkID0gZnVuY3Rpb24gKGYsIGV4ZWNDb250ZXh0KSB7XG4gICAgQWN0aXZpdHkucHJvdG90eXBlLmZvckVhY2hJbW1lZGlhdGVDaGlsZC5jYWxsKHRoaXMsIGYpO1xuICAgIGZvciAobGV0IGFjdGl2aXR5IG9mIHRoaXMuX2dldEludGVybmFsQWN0aXZpdGllcyhleGVjQ29udGV4dC5yb290QWN0aXZpdHlbXCJAcmVxdWlyZVwiXSkpIHtcbiAgICAgICAgZihhY3Rpdml0eSk7XG4gICAgfVxufTtcblxuVGVtcGxhdGUucHJvdG90eXBlLl9kb0ZvckVhY2ggPSBmdW5jdGlvbiAoZiwgdmlzaXRlZCwgZXhjZXB0KSB7XG4gICAgQWN0aXZpdHkucHJvdG90eXBlLl9kb0ZvckVhY2guY2FsbCh0aGlzLCBmLCB2aXNpdGVkLCBleGNlcHQpO1xuICAgIGZvciAobGV0IGFjdGl2aXR5IG9mIHRoaXMuX2dldEludGVybmFsQWN0aXZpdGllcygpKSB7XG4gICAgICAgIGFjdGl2aXR5Ll9kb0ZvckVhY2goZiwgdmlzaXRlZCwgZXhjZXB0KTtcbiAgICB9XG59O1xuXG5UZW1wbGF0ZS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24oY2FsbENvbnRleHQsIGFyZ3MpIHtcbiAgICBpZiAoXy5pc0FycmF5KGFyZ3MpKSB7XG4gICAgICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKGFyZ3MsICdfYWN0aXZpdGllc0dvdCcpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY2FsbENvbnRleHQuY29tcGxldGUoKTtcbiAgICB9XG59O1xuXG5UZW1wbGF0ZS5wcm90b3R5cGUuX2FjdGl2aXRpZXNHb3QgPSBmdW5jdGlvbihjYWxsQ29udGV4dCwgcmVhc29uLCByZXN1bHQpIHtcbiAgICBpZiAocmVhc29uID09PSBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUpIHtcbiAgICAgICAgaWYgKF8uaXNBcnJheShyZXN1bHQpICYmIHJlc3VsdC5sZW5ndGgpIHtcbiAgICAgICAgICAgIGxldCBpZHggPSAwO1xuICAgICAgICAgICAgbGV0IGRlY2xhcmUgPSBfLmNsb25lRGVlcCh0aGlzLmdldChcImRlY2xhcmVcIikpO1xuICAgICAgICAgICAgbGV0IHNldHVwVGFza3MgPSBbXTtcbiAgICAgICAgICAgIHRlbXBsYXRlSGVscGVycy52aXNpdEFjdGl2aXRpZXMoZGVjbGFyZSwgZnVuY3Rpb24obWFya3VwLCBwYXJlbnQsIGtleSkge1xuICAgICAgICAgICAgICAgIHNldHVwVGFza3MucHVzaChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50W2tleV0gPSByZXN1bHRbaWR4KytdO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBmb3IgKGxldCB0IG9mIHNldHVwVGFza3MpIHtcbiAgICAgICAgICAgICAgICB0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYWxsQ29udGV4dC5jb21wbGV0ZShkZWNsYXJlKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY2FsbENvbnRleHQuZW5kKHJlYXNvbiwgcmVzdWx0KTtcbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFRlbXBsYXRlOyJdfQ==
