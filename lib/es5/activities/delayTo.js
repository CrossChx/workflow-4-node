"use strict";
var Activity = require("./activity");
var Composite = require("./composite");
var util = require("util");
var _ = require("lodash");
var specStrings = require("../common/specStrings");
var errors = require("../common/errors");
var assert = require("assert");
var Bluebird = require("bluebird");
function DelayTo() {
  Composite.call(this);
  this.to = null;
  this._inHost = false;
}
util.inherits(DelayTo, Composite);
DelayTo.prototype.createImplementation = function(execContext) {
  assert(!!execContext);
  var methodName = specStrings.hosting.createDelayToMethodName(this.getInstanceId(execContext));
  return {"@block": {
      inHost: "= this.$parent._inHost",
      delayTo: "= this.$parent.to",
      args: {"@if": {
          condition: "= this.inHost",
          then: {"@block": {
              v: null,
              done: false,
              args: [{"@if": {
                  condition: "= _.isDate(this.delayTo)",
                  then: [{"@while": {
                      condition: "= !this.done",
                      args: [{"@beginMethod": {
                          methodName: methodName,
                          instanceIdPath: "[0]",
                          "@to": "v"
                        }}, {"@if": {
                          condition: "= this.v[1].getTime() === this.delayTo.getTime()",
                          then: {"@assign": {
                              to: "done",
                              value: true
                            }}
                        }}, {"@endMethod": {methodName: methodName}}]
                    }}]
                }}]
            }},
          else: function() {
            if (this.delayTo && _.isDate(this.delayTo)) {
              var ms = this.delayTo - new Date();
              if (ms < 0) {
                ms = 0;
              }
              if (ms) {
                return Bluebird.delay(ms);
              }
            }
          }
        }}
    }};
};
DelayTo.prototype.run = function(callContext, args) {
  this._inHost = !!callContext.executionContext.engine.instance;
  Composite.prototype.run.call(this, callContext, args);
};
module.exports = DelayTo;
//# sourceMappingURL=data:application/json;base64,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QyxFQUFJLENBQUEsSUFBRyxRQUFRLEVBQUksSUFBSSxLQUFHLEFBQUMsRUFBQyxDQUFDO0FBQ2xDLGlCQUFJLEVBQUMsRUFBSSxFQUFBLENBQUc7QUFDUixpQkFBQyxFQUFJLEVBQUEsQ0FBQztjQUNWO0FBQUEsQUFDQSxpQkFBSSxFQUFDLENBQUc7QUFDSixxQkFBTyxDQUFBLFFBQU8sTUFBTSxBQUFDLENBQUMsRUFBQyxDQUFDLENBQUM7Y0FDN0I7QUFBQSxZQUNKO0FBQUEsVUFDSjtBQUFBLFFBQ0osQ0FDSjtBQUFBLElBQ0osQ0FDSixDQUFDO0FBQ0wsQ0FBQztBQUVELE1BQU0sVUFBVSxJQUFJLEVBQUksVUFBUyxXQUFVLENBQUcsQ0FBQSxJQUFHLENBQUc7QUFDaEQsS0FBRyxRQUFRLEVBQUksRUFBQyxDQUFDLFdBQVUsaUJBQWlCLE9BQU8sU0FBUyxDQUFDO0FBQzdELFVBQVEsVUFBVSxJQUFJLEtBQUssQUFBQyxDQUFDLElBQUcsQ0FBRyxZQUFVLENBQUcsS0FBRyxDQUFDLENBQUM7QUFDekQsQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLFFBQU0sQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvZGVsYXlUby5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCBBY3Rpdml0eSA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5XCIpO1xubGV0IENvbXBvc2l0ZSA9IHJlcXVpcmUoXCIuL2NvbXBvc2l0ZVwiKTtcbmxldCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgc3BlY1N0cmluZ3MgPSByZXF1aXJlKFwiLi4vY29tbW9uL3NwZWNTdHJpbmdzXCIpO1xubGV0IGVycm9ycyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZXJyb3JzXCIpO1xubGV0IGFzc2VydCA9IHJlcXVpcmUoXCJhc3NlcnRcIik7XG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5cbmZ1bmN0aW9uIERlbGF5VG8oKSB7XG4gICAgQ29tcG9zaXRlLmNhbGwodGhpcyk7XG5cbiAgICB0aGlzLnRvID0gbnVsbDtcbiAgICB0aGlzLl9pbkhvc3QgPSBmYWxzZTtcbn1cblxudXRpbC5pbmhlcml0cyhEZWxheVRvLCBDb21wb3NpdGUpO1xuXG5EZWxheVRvLnByb3RvdHlwZS5jcmVhdGVJbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uIChleGVjQ29udGV4dCkge1xuICAgIGFzc2VydCghIWV4ZWNDb250ZXh0KTtcbiAgICBsZXQgbWV0aG9kTmFtZSA9IHNwZWNTdHJpbmdzLmhvc3RpbmcuY3JlYXRlRGVsYXlUb01ldGhvZE5hbWUodGhpcy5nZXRJbnN0YW5jZUlkKGV4ZWNDb250ZXh0KSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgXCJAYmxvY2tcIjoge1xuICAgICAgICAgICAgaW5Ib3N0OiBcIj0gdGhpcy4kcGFyZW50Ll9pbkhvc3RcIixcbiAgICAgICAgICAgIGRlbGF5VG86IFwiPSB0aGlzLiRwYXJlbnQudG9cIixcbiAgICAgICAgICAgIGFyZ3M6IHtcbiAgICAgICAgICAgICAgICBcIkBpZlwiOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbjogXCI9IHRoaXMuaW5Ib3N0XCIsXG4gICAgICAgICAgICAgICAgICAgIHRoZW46IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiQGJsb2NrXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2OiBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbmU6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAaWZcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbjogXCI9IF8uaXNEYXRlKHRoaXMuZGVsYXlUbylcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQHdoaWxlXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb246IFwiPSAhdGhpcy5kb25lXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBiZWdpbk1ldGhvZFwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kTmFtZTogbWV0aG9kTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZUlkUGF0aDogXCJbMF1cIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkB0b1wiOiBcInZcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBpZlwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uOiBcIj0gdGhpcy52WzFdLmdldFRpbWUoKSA9PT0gdGhpcy5kZWxheVRvLmdldFRpbWUoKVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW46IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAYXNzaWduXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiBcImRvbmVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGVuZE1ldGhvZFwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kTmFtZTogbWV0aG9kTmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBlbHNlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlbGF5VG8gJiYgXy5pc0RhdGUodGhpcy5kZWxheVRvKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtcyA9IHRoaXMuZGVsYXlUbyAtIG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1zIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtcyA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gQmx1ZWJpcmQuZGVsYXkobXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG59O1xuXG5EZWxheVRvLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbihjYWxsQ29udGV4dCwgYXJncykge1xuICAgIHRoaXMuX2luSG9zdCA9ICEhY2FsbENvbnRleHQuZXhlY3V0aW9uQ29udGV4dC5lbmdpbmUuaW5zdGFuY2U7XG4gICAgQ29tcG9zaXRlLnByb3RvdHlwZS5ydW4uY2FsbCh0aGlzLCBjYWxsQ29udGV4dCwgYXJncyk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IERlbGF5VG87Il19
