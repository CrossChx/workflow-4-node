"use strict";
var Activity = require("./activity");
var Composite = require("./composite");
var util = require("util");
var _ = require("lodash");
var specStrings = require("../common/specStrings");
var errors = require("../common/errors");
var assert = require("assert");
var Bluebird = require("bluebird");
function DelayTo() {
  Composite.call(this);
  this.to = null;
  this._inHost = false;
}
util.inherits(DelayTo, Composite);
DelayTo.prototype.createImplementation = function(execContext) {
  assert(!!execContext);
  var methodName = specStrings.hosting.createDelayToMethodName(this.getInstanceId(execContext));
  return {"@block": {
      inHost: "= this.$parent._inHost",
      delayTo: "= this.$parent.to",
      args: {"@if": {
          condition: "= this.inHost",
          then: {"@block": {
              v: null,
              done: false,
              args: [{"@if": {
                  condition: "= _.isDate(this.delayTo)",
                  then: [{"@while": {
                      condition: "= !this.done",
                      args: [{"@beginMethod": {
                          methodName: methodName,
                          instanceIdPath: "[0]",
                          "@to": "v"
                        }}, {"@if": {
                          condition: "= this.v[1].getTime() === this.delayTo.getTime()",
                          then: {"@assign": {
                              to: "done",
                              value: true
                            }}
                        }}, {"@endMethod": {methodName: methodName}}]
                    }}]
                }}]
            }},
          else: function() {
            if (this.delayTo && _.isDate(this.delayTo)) {
              var ms = this.delayTo - new Date();
              if (ms < 0) {
                ms = 0;
              }
              if (ms) {
                return Bluebird.delay(ms);
              }
            }
          }
        }}
    }};
};
DelayTo.prototype.run = function(callContext, args) {
  this._inHost = callContext.executionContext.engine.instance !== null;
  Composite.prototype.run.call(this, callContext, args);
};
module.exports = DelayTo;
//# sourceMappingURL=data:application/json;base64,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QyxFQUFJLENBQUEsSUFBRyxRQUFRLEVBQUksSUFBSSxLQUFHLEFBQUMsRUFBQyxDQUFDO0FBQ2xDLGlCQUFJLEVBQUMsRUFBSSxFQUFBLENBQUc7QUFDUixpQkFBQyxFQUFJLEVBQUEsQ0FBQztjQUNWO0FBQUEsQUFDQSxpQkFBSSxFQUFDLENBQUc7QUFDSixxQkFBTyxDQUFBLFFBQU8sTUFBTSxBQUFDLENBQUMsRUFBQyxDQUFDLENBQUM7Y0FDN0I7QUFBQSxZQUNKO0FBQUEsVUFDSjtBQUFBLFFBQ0osQ0FDSjtBQUFBLElBQ0osQ0FDSixDQUFDO0FBQ0wsQ0FBQztBQUVELE1BQU0sVUFBVSxJQUFJLEVBQUksVUFBUyxXQUFVLENBQUcsQ0FBQSxJQUFHLENBQUc7QUFDaEQsS0FBRyxRQUFRLEVBQUksQ0FBQSxXQUFVLGlCQUFpQixPQUFPLFNBQVMsSUFBTSxLQUFHLENBQUM7QUFDcEUsVUFBUSxVQUFVLElBQUksS0FBSyxBQUFDLENBQUMsSUFBRyxDQUFHLFlBQVUsQ0FBRyxLQUFHLENBQUMsQ0FBQztBQUN6RCxDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksUUFBTSxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9kZWxheVRvLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IEFjdGl2aXR5ID0gcmVxdWlyZShcIi4vYWN0aXZpdHlcIik7XG5sZXQgQ29tcG9zaXRlID0gcmVxdWlyZShcIi4vY29tcG9zaXRlXCIpO1xubGV0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcbmxldCBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbmxldCBzcGVjU3RyaW5ncyA9IHJlcXVpcmUoXCIuLi9jb21tb24vc3BlY1N0cmluZ3NcIik7XG5sZXQgZXJyb3JzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lcnJvcnNcIik7XG5sZXQgYXNzZXJ0ID0gcmVxdWlyZShcImFzc2VydFwiKTtcbmxldCBCbHVlYmlyZCA9IHJlcXVpcmUoXCJibHVlYmlyZFwiKTtcblxuZnVuY3Rpb24gRGVsYXlUbygpIHtcbiAgICBDb21wb3NpdGUuY2FsbCh0aGlzKTtcblxuICAgIHRoaXMudG8gPSBudWxsO1xuICAgIHRoaXMuX2luSG9zdCA9IGZhbHNlO1xufVxuXG51dGlsLmluaGVyaXRzKERlbGF5VG8sIENvbXBvc2l0ZSk7XG5cbkRlbGF5VG8ucHJvdG90eXBlLmNyZWF0ZUltcGxlbWVudGF0aW9uID0gZnVuY3Rpb24gKGV4ZWNDb250ZXh0KSB7XG4gICAgYXNzZXJ0KCEhZXhlY0NvbnRleHQpO1xuICAgIGxldCBtZXRob2ROYW1lID0gc3BlY1N0cmluZ3MuaG9zdGluZy5jcmVhdGVEZWxheVRvTWV0aG9kTmFtZSh0aGlzLmdldEluc3RhbmNlSWQoZXhlY0NvbnRleHQpKTtcbiAgICByZXR1cm4ge1xuICAgICAgICBcIkBibG9ja1wiOiB7XG4gICAgICAgICAgICBpbkhvc3Q6IFwiPSB0aGlzLiRwYXJlbnQuX2luSG9zdFwiLFxuICAgICAgICAgICAgZGVsYXlUbzogXCI9IHRoaXMuJHBhcmVudC50b1wiLFxuICAgICAgICAgICAgYXJnczoge1xuICAgICAgICAgICAgICAgIFwiQGlmXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uOiBcIj0gdGhpcy5pbkhvc3RcIixcbiAgICAgICAgICAgICAgICAgICAgdGhlbjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJAYmxvY2tcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHY6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBpZlwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uOiBcIj0gXy5pc0RhdGUodGhpcy5kZWxheVRvKVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW46IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAd2hpbGVcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbjogXCI9ICF0aGlzLmRvbmVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGJlZ2luTWV0aG9kXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2ROYW1lOiBtZXRob2ROYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWRQYXRoOiBcIlswXVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQHRvXCI6IFwidlwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGlmXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb246IFwiPSB0aGlzLnZbMV0uZ2V0VGltZSgpID09PSB0aGlzLmRlbGF5VG8uZ2V0VGltZSgpXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlbjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBhc3NpZ25cIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IFwiZG9uZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZW5kTWV0aG9kXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2ROYW1lOiBtZXRob2ROYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGVsc2U6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVsYXlUbyAmJiBfLmlzRGF0ZSh0aGlzLmRlbGF5VG8pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1zID0gdGhpcy5kZWxheVRvIC0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXMgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBCbHVlYmlyZC5kZWxheShtcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbn07XG5cbkRlbGF5VG8ucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uKGNhbGxDb250ZXh0LCBhcmdzKSB7XG4gICAgdGhpcy5faW5Ib3N0ID0gY2FsbENvbnRleHQuZXhlY3V0aW9uQ29udGV4dC5lbmdpbmUuaW5zdGFuY2UgIT09IG51bGw7XG4gICAgQ29tcG9zaXRlLnByb3RvdHlwZS5ydW4uY2FsbCh0aGlzLCBjYWxsQ29udGV4dCwgYXJncyk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IERlbGF5VG87Il19
