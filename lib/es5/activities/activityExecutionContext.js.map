{"version":3,"sources":["activities/activityExecutionContext.js"],"names":[],"mappings":"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","file":"activities/activityExecutionContext.js","sourcesContent":["\"use strict\";\n\nlet ActivityExecutionState = require(\"./activityExecutionState\");\nlet ResumeBookmarkQueue = require(\"./resumeBookmarkQueue\");\nlet enums = require(\"../common/enums\");\nlet errors = require(\"../common/errors\");\nlet util = require(\"util\");\nlet EventEmitter = require(\"events\").EventEmitter;\nlet _ = require(\"lodash\");\nlet constants = require(\"../common/constants\");\nlet ScopeTree = require(\"./scopeTree\");\nlet is = require(\"../common/is\");\nlet CallContext = require(\"./callContext\");\nlet assert = require(\"better-assert\");\nlet Bluebird = require(\"bluebird\");\nlet converters = require(\"../common/converters\");\n\nfunction ActivityExecutionContext(engine) {\n    EventEmitter.call(this);\n\n    this._activityStates = new Map();\n    this._bookmarks = new Map();\n    this._resumeBMQueue = new ResumeBookmarkQueue();\n    this.rootActivity = null;\n    this._knownActivities = new Map();\n    this._scopeTree = this._createScopeTree();\n    this.engine = engine; // Could be null in special cases, see workflowRegistry.js\n}\n\nutil.inherits(ActivityExecutionContext, EventEmitter);\n\nObject.defineProperties(\n    ActivityExecutionContext.prototype,\n    {\n        scope: {\n            get: function () {\n                return this._scopeTree.currentScope;\n            }\n        },\n        hasScope: {\n            get: function () {\n                return !this._scopeTree.isOnInitial;\n            }\n        }\n    }\n);\n\nActivityExecutionContext.prototype._createScopeTree = function () {\n    let self = this;\n    return new ScopeTree(\n        {\n            resultCollected: function (context, reason, result, bookmarkName) {\n                context.activity.resultCollected.call(context.scope, context, reason, result, bookmarkName);\n            }\n        },\n        function (id) {\n            return self._getKnownActivity(id);\n        });\n};\n\nActivityExecutionContext.prototype.initialize = function (rootActivity) {\n    if (this.rootActivity) {\n        throw new Error(\"Context is already initialized.\");\n    }\n    if (!is.activity(rootActivity)) {\n        throw new TypeError(\"Argument 'rootActivity' value is not an activity.\");\n    }\n\n    this.rootActivity = rootActivity;\n    this._initialize(null, rootActivity, { instanceId: 0 });\n};\n\nActivityExecutionContext.prototype._checkInit = function () {\n    if (!this.rootActivity) {\n        throw new Error(\"Context is not initialized.\");\n    }\n};\n\nActivityExecutionContext.prototype._initialize = function (parent, activity, idCounter) {\n    let activityId = activity._instanceId;\n    let nextId = (idCounter.instanceId++).toString();\n    if (!activityId) {\n        activityId = nextId;\n        activity.instanceId = activityId;\n    }\n    else if (activityId !== nextId) {\n        throw new errors.ActivityRuntimeError(\"Activity \" + activity + \" has been assigned to an other position.\");\n    }\n\n    let state = this.getExecutionState(activityId);\n    state.parentInstanceId = parent ? parent.instanceId : null;\n    this._knownActivities.set(activityId, activity);\n\n    for (let child of activity.immediateChildren(this)) {\n        this._initialize(activity, child, idCounter);\n        state.childInstanceIds.add(child.instanceId);\n    }\n};\n\nActivityExecutionContext.prototype.getExecutionState = function (idOrActivity) {\n    let self = this;\n\n    let id;\n    if (_.isString(idOrActivity)) {\n        id = idOrActivity;\n    }\n    else if (is.activity(idOrActivity)) {\n        id = idOrActivity.instanceId;\n    }\n    else {\n        throw new TypeError(\"Cannot get state of \" + idOrActivity);\n    }\n    let state = self._activityStates.get(id);\n    if (_.isUndefined(state)) {\n        state = new ActivityExecutionState(id);\n        state.on(\n            enums.activityStates.run,\n            function (args) {\n                self.emit(enums.activityStates.run, args);\n            });\n        state.on(\n            enums.activityStates.end,\n            function (args) {\n                self.emit(enums.activityStates.end, args);\n            });\n        self._activityStates.set(id, state);\n    }\n    return state;\n};\n\nActivityExecutionContext.prototype._getKnownActivity = function (activityId) {\n    let activity = this._knownActivities.get(activityId);\n    if (!activity) {\n        throw new errors.ActivityRuntimeError(\"Activity by id '\" + activityId + \"' not found.\");\n    }\n    return activity;\n};\n\nActivityExecutionContext.prototype.createBookmark = function (activityId, name, endCallback) {\n    this.registerBookmark(\n        {\n            name: name,\n            instanceId: activityId,\n            timestamp: new Date().getTime(),\n            endCallback: endCallback\n        });\n    return name;\n};\n\nActivityExecutionContext.prototype.registerBookmark = function (bookmark) {\n    let bm = this._bookmarks.get(bookmark.name);\n    if (bm) {\n        throw new errors.ActivityRuntimeError(\"Bookmark '\" + bookmark.name + \"' already exists.\");\n    }\n    this._bookmarks.set(bookmark.name, bookmark);\n};\n\nActivityExecutionContext.prototype.isBookmarkExists = function (name) {\n    return this._bookmarks.has(name);\n};\n\nActivityExecutionContext.prototype.getBookmarkTimestamp = function (name, throwIfNotFound) {\n    let bm = this._bookmarks.get(name);\n    if (_.isUndefined(bm) && throwIfNotFound) {\n        throw new Error(\"Bookmark '\" + name + \"' not found.\");\n    }\n    return bm ? bm.timestamp : null;\n};\n\nActivityExecutionContext.prototype.deleteBookmark = function (name) {\n    this._bookmarks.delete(name);\n};\n\nActivityExecutionContext.prototype.noopCallbacks = function (bookmarkNames) {\n    for (let name of bookmarkNames) {\n        let bm = this._bookmarks.get(name);\n        if (bm) {\n            bm.endCallback = _.noop;\n        }\n    }\n};\n\nActivityExecutionContext.prototype.resumeBookmarkInScope = function (callContext, name, reason, result) {\n    let bm = this._bookmarks.get(name);\n    if (_.isUndefined(bm)) {\n        throw new Error(\"Bookmark '\" + name + \"' doesn't exists. Cannot continue with reason: \" + reason + \".\");\n    }\n    let self = this;\n    return new Bluebird(function (resolve, reject) {\n        setImmediate(function () {\n            try {\n                bm = self._bookmarks.get(name);\n                if (bm) {\n                    // If bm is still exists.\n                    self._doResumeBookmark(callContext, bm, reason, result, reason === enums.activityStates.idle);\n                    resolve(true);\n                }\n                resolve(false);\n            }\n            catch (e) {\n                reject(e);\n            }\n        });\n    });\n};\n\nActivityExecutionContext.prototype.resumeBookmarkInternal = function (callContext, name, reason, result) {\n    let bm = this._bookmarks.get(name);\n    this._resumeBMQueue.enqueue(name, reason, result);\n};\n\nActivityExecutionContext.prototype.resumeBookmarkExternal = function (name, reason, result) {\n    let self = this;\n    let bm = self._bookmarks.get(name);\n    if (!bm) {\n        throw new errors.BookmarkNotFoundError(\"Internal resume bookmark request cannot be processed because bookmark '\" + name + \"' doesn't exists.\");\n    }\n    self._doResumeBookmark(new CallContext(this, bm.instanceId), bm, reason, result);\n};\n\nActivityExecutionContext.prototype.processResumeBookmarkQueue = function () {\n    let self = this;\n    let command = self._resumeBMQueue.dequeue();\n    if (command) {\n        let bm = self._bookmarks.get(command.name);\n        if (!bm) {\n            throw new errors.BookmarkNotFoundError(\"Internal resume bookmark request cannot be processed because bookmark '\" + command.name + \"' doesn't exists.\");\n        }\n        self._doResumeBookmark(new CallContext(this, bm.instanceId), bm, command.reason, command.result);\n        return true;\n    }\n    return false;\n};\n\nActivityExecutionContext.prototype._doResumeBookmark = function (callContext, bookmark, reason, result, noRemove) {\n    let scope = callContext.scope;\n    if (!noRemove) {\n        this._bookmarks.delete(bookmark.name);\n    }\n    let cb = bookmark.endCallback;\n    if (_.isString(cb)) {\n        cb = scope[bookmark.endCallback];\n        if (!_.isFunction(cb)) {\n            cb = null;\n        }\n    }\n\n    if (!cb) {\n        throw new errors.ActivityRuntimeError(\"Bookmark's '\" + bookmark.name + \"' callback '\" + bookmark.endCallback + \"' is not defined on the current scope.\");\n    }\n\n    // TODO: if it fails, resume on default callback with the error!\n    cb.call(scope, callContext, reason, result, bookmark);\n};\n\nActivityExecutionContext.prototype.cancelExecution = function (scope, activityIds) {\n    let self = this;\n    let allIds = new Set();\n    for (let id of activityIds) {\n        self._cancelSubtree(scope, allIds, id);\n    }\n    for (let bm of self._bookmarks.values()) {\n        if (allIds.has(bm.instanceId)) {\n            self._bookmarks.delete(bm.name);\n        }\n    }\n};\n\nActivityExecutionContext.prototype._cancelSubtree = function (scope, allIds, activityId) {\n    let self = this;\n    allIds.add(activityId);\n    let state = self.getExecutionState(activityId);\n    for (let id of state.childInstanceIds.values()) {\n        self._cancelSubtree(scope, allIds, id);\n    }\n    state.reportState(enums.activityStates.cancel, null, scope);\n};\n\nActivityExecutionContext.prototype.deleteScopeOfActivity = function (callContext, activityId) {\n    this._scopeTree.deleteScopePart(callContext.instanceId, activityId);\n};\n\nActivityExecutionContext.prototype.emitWorkflowEvent = function (args) {\n    this.emit(enums.events.workflowEvent, args);\n};\n\n/* SERIALIZATION */\n\nActivityExecutionContext.prototype.getStateAndPromotions = function (serializer, enablePromotions) {\n    if (serializer && !_.isFunction(serializer.toJSON)) {\n        throw new TypeError(\"Argument 'serializer' is not a serializer.\");\n    }\n\n    let activityStates = new Map();\n    for (let s of this._activityStates.values()) {\n        activityStates.set(s.instanceId, s.asJSON());\n    }\n\n    let scopeStateAndPromotions = this._scopeTree.getExecutionState(this, enablePromotions, serializer);\n\n    let serialized;\n    if (serializer) {\n        serialized = serializer.toJSON({\n            activityStates: activityStates,\n            bookmarks: this._bookmarks,\n            scope: scopeStateAndPromotions.state\n        });\n    }\n    else {\n        serialized = {\n            activityStates: converters.mapToArray(activityStates),\n            bookmarks: converters.mapToArray(this._bookmarks),\n            scope: scopeStateAndPromotions.state\n        };\n    }\n\n    return {\n        state: serialized,\n        promotedProperties: scopeStateAndPromotions.promotedProperties\n    };\n};\n\nActivityExecutionContext.prototype.setState = function (serializer, json) {\n    if (serializer && !_.isFunction(serializer.fromJSON)) {\n        throw new TypeError(\"Argument 'serializer' is not a serializer.\");\n    }\n    if (!_.isObject(json)) {\n        throw new TypeError(\"Argument 'json' is not an object.\");\n    }\n\n    if (serializer) {\n        json = serializer.fromJSON(json);\n        if (!(json.activityStates instanceof Map)) {\n            throw new TypeError(\"activityStates property value of argument 'json' is not an Map instance.\");\n        }\n        if (!(json.bookmarks instanceof Map)) {\n            throw new TypeError(\"Bookmarks property value of argument 'json' is not an Map instance.\");\n        }\n    }\n    else {\n        if (!json.activityStates) {\n            throw new TypeError(\"activityStates property value of argument 'json' is not an object.\");\n        }\n        if (!json.bookmarks) {\n            throw new TypeError(\"Bookmarks property value of argument 'json' is not an object.\");\n        }\n\n        json = {\n            activityStates: converters.arrayToMap(json.activityStates),\n            bookmarks: converters.arrayToMap(json.bookmarks),\n            scope: json.scope\n        };\n    }\n\n    for (let s of this._activityStates.values()) {\n        let stored = json.activityStates.get(s.instanceId);\n        if (_.isUndefined(stored)) {\n            throw new Error(\"Activity's of '\" + s.instanceId + \"' state not found.\");\n        }\n        s.fromJSON(stored);\n    }\n\n    this._bookmarks = json.bookmarks;\n    this._scopeTree.setState(json.scope, serializer);\n};\n/* SERIALIZATION */\n\nmodule.exports = ActivityExecutionContext;"],"sourceRoot":"/source/"}