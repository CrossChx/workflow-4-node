"use strict";
var _ = require("lodash");
var Reflection = require("backpack-node").system.Reflection;
var maxDepth = 10;
var templateHelpers = {
  isFunctionString: function(str) {
    return _.isString(str) && str.match(/^\s*function\s*\w*\s*\((?:\w+,)*(?:\w+)?\)\s*\{/);
  },
  isTemplate: function(obj) {
    var activityCount = 0;
    templateHelpers.visitActivities(obj, function() {
      activityCount++;
    });
    return activityCount > 0;
  },
  visitActivities: function(obj, f) {
    if (!_.isPlainObject(obj) && !_.isArray(obj)) {
      return;
    }
    Reflection.visitObject(obj, function(subObj, parent, pkey) {
      if (_.isString(subObj)) {
        var str = subObj.trim();
        if (str.length > 1) {
          if (str[0] === "=") {
            var markup = {"@expression": {expr: str.substr(1)}};
            f(markup, parent, pkey);
            return false;
          }
          if (templateHelpers.isFunctionString(str)) {
            var markup$__3 = {"@func": {code: str}};
            f(markup$__3, parent, pkey);
            return false;
          }
        }
      } else if (_.isPlainObject(subObj)) {
        var keys = _.keys(subObj);
        if (keys.length === 1) {
          var key = keys[0];
          if (key[0] === "@" && key.length > 1) {
            var markup$__4 = {};
            markup$__4[key] = subObj[key];
            f(markup$__4, parent, pkey);
            return false;
          }
        } else if (keys.length === 2) {
          var key1 = keys[0];
          var key2 = keys[1];
          if (key1 === "@require" && key2[0] === "@" && key2.length > 1) {
            var markup$__5 = {};
            markup$__5[key1] = subObj[key1];
            markup$__5[key2] = subObj[key2];
            f(markup$__5, parent, pkey);
            return false;
          } else if (key2 === "@require" && key1[0] === "@" && key1.length > 1) {
            var markup$__6 = {};
            markup$__6[key2] = subObj[key2];
            markup$__6[key1] = subObj[key1];
            f(markup$__6, parent, pkey);
            return false;
          }
        }
      } else if (_.isFunction(subObj)) {
        var markup$__7 = {"@func": {code: subObj}};
        f(markup$__7, parent, pkey);
        return false;
      }
      return true;
    }, maxDepth);
  }
};
module.exports = templateHelpers;
//# sourceMappingURL=data:application/json;base64,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LElBQUcsQ0FBQyxDQUFDO0FBQzNCLFlBQUEsQUFBQyxZQUFTLE9BQUssQ0FBRyxLQUFHLENBQUMsQ0FBQztBQUN2QixpQkFBTyxNQUFJLENBQUM7VUFDaEI7QUFBQSxRQUNKO0FBQUEsTUFDSixLQUNLLEtBQUksQ0FBQSxXQUFXLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBRztBQUMzQixBQUFJLFVBQUEsQ0FBQSxVQUFLLEVBQUksRUFDVCxPQUFNLENBQUcsRUFDTCxJQUFHLENBQUcsT0FBSyxDQUNmLENBQ0osQ0FBQztBQUNELFFBQUEsQUFBQyxZQUFTLE9BQUssQ0FBRyxLQUFHLENBQUMsQ0FBQztBQUN2QixhQUFPLE1BQUksQ0FBQztNQUNoQjtBQUFBLEFBQ0EsV0FBTyxLQUFHLENBQUM7SUFDZixDQUNBLFNBQU8sQ0FBQyxDQUFDO0VBQ2pCO0FBQUEsQUFDSixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksZ0JBQWMsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvdGVtcGxhdGVIZWxwZXJzLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IFJlZmxlY3Rpb24gPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5zeXN0ZW0uUmVmbGVjdGlvbjtcblxubGV0IG1heERlcHRoID0gMTA7XG5cbmxldCB0ZW1wbGF0ZUhlbHBlcnMgPSB7XG5cbiAgICBpc0Z1bmN0aW9uU3RyaW5nOiBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgIHJldHVybiBfLmlzU3RyaW5nKHN0cikgJiYgc3RyLm1hdGNoKC9eXFxzKmZ1bmN0aW9uXFxzKlxcdypcXHMqXFwoKD86XFx3KywpKig/OlxcdyspP1xcKVxccypcXHsvKTtcbiAgICB9LFxuICAgIGlzVGVtcGxhdGU6IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgbGV0IGFjdGl2aXR5Q291bnQgPSAwO1xuICAgICAgICB0ZW1wbGF0ZUhlbHBlcnMudmlzaXRBY3Rpdml0aWVzKG9iaiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgYWN0aXZpdHlDb3VudCsrO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGFjdGl2aXR5Q291bnQgPiAwO1xuICAgIH0sXG4gICAgdmlzaXRBY3Rpdml0aWVzOiBmdW5jdGlvbiAob2JqLCBmKSB7XG4gICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG9iaikgJiYgIV8uaXNBcnJheShvYmopKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgUmVmbGVjdGlvbi52aXNpdE9iamVjdChvYmosXG4gICAgICAgICAgICBmdW5jdGlvbiAoc3ViT2JqLCBwYXJlbnQsIHBrZXkpIHtcbiAgICAgICAgICAgICAgICBpZiAoXy5pc1N0cmluZyhzdWJPYmopKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdHIgPSBzdWJPYmoudHJpbSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHJbMF0gPT09IFwiPVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1hcmt1cCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZXhwcmVzc2lvblwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHByOiBzdHIuc3Vic3RyKDEpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYobWFya3VwLCBwYXJlbnQsIHBrZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZUhlbHBlcnMuaXNGdW5jdGlvblN0cmluZyhzdHIpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1hcmt1cCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJAZnVuY1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBzdHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZihtYXJrdXAsIHBhcmVudCwgcGtleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKF8uaXNQbGFpbk9iamVjdChzdWJPYmopKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBrZXlzID0gXy5rZXlzKHN1Yk9iaik7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQga2V5ID0ga2V5c1swXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlbMF0gPT09IFwiQFwiICYmIGtleS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1hcmt1cCA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmt1cFtrZXldID0gc3ViT2JqW2tleV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZihtYXJrdXAsIHBhcmVudCwgcGtleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGtleXMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQga2V5MSA9IGtleXNbMF07XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQga2V5MiA9IGtleXNbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5MSA9PT0gXCJAcmVxdWlyZVwiICYmIGtleTJbMF0gPT09IFwiQFwiICYmIGtleTIubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtYXJrdXAgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrdXBba2V5MV0gPSBzdWJPYmpba2V5MV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya3VwW2tleTJdID0gc3ViT2JqW2tleTJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYobWFya3VwLCBwYXJlbnQsIHBrZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGtleTIgPT09IFwiQHJlcXVpcmVcIiAmJiBrZXkxWzBdID09PSBcIkBcIiAmJiBrZXkxLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbWFya3VwID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya3VwW2tleTJdID0gc3ViT2JqW2tleTJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmt1cFtrZXkxXSA9IHN1Yk9ialtrZXkxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmKG1hcmt1cCwgcGFyZW50LCBwa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoXy5pc0Z1bmN0aW9uKHN1Yk9iaikpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG1hcmt1cCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZ1bmNcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IHN1Yk9ialxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBmKG1hcmt1cCwgcGFyZW50LCBwa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBtYXhEZXB0aCk7XG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSB0ZW1wbGF0ZUhlbHBlcnM7Il19
