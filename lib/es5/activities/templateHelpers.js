"use strict";
"use strict";
var _ = require("lodash");
var Reflection = require("backpack-node").system.Reflection;
var maxDepth = 10;
var templateHelpers = {
  asGet: function(expr) {
    var parts = expr.split(".");
    var result;
    var $__3 = true;
    var $__4 = false;
    var $__5 = undefined;
    try {
      for (var $__1 = void 0,
          $__0 = (parts)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
        var part = $__1.value;
        {
          if (!result) {
            result = "(function() { var v = this.get('" + part.trim() + "');";
          } else {
            result += "v = _.isFunction(v.get) ? v.get('" + part.trim() + "') : v." + part.trim() + ";";
          }
        }
      }
    } catch ($__6) {
      $__4 = true;
      $__5 = $__6;
    } finally {
      try {
        if (!$__3 && $__0.return != null) {
          $__0.return();
        }
      } finally {
        if ($__4) {
          throw $__5;
        }
      }
    }
    result += "return v;}).bind(this)()";
    return result;
  },
  isFunctionString: function(str) {
    return _.isString(str) && str.match(/^\s*function\s*\w*\s*\((?:\w+,)*(?:\w+)?\)\s*\{/);
  },
  isTemplate: function(obj) {
    var activityCount = 0;
    templateHelpers.visitActivities(obj, function() {
      activityCount++;
    });
    return activityCount > 0;
  },
  visitActivities: function(obj, f) {
    if (!_.isPlainObject(obj) && !_.isArray(obj)) {
      return ;
    }
    Reflection.visitObject(obj, function(subObj, parent, pkey) {
      if (_.isString(subObj)) {
        var str = subObj.trim();
        if (str.length > 1) {
          if (str[0] === "#") {
            var markup = {"@expression": {expr: str.substr(1)}};
            f(markup, parent, pkey);
            return false;
          }
          if (str[0] === "=") {
            var markup$__7 = {"@expression": {expr: templateHelpers.asGet(str.substr(1))}};
            f(markup$__7, parent, pkey);
            return false;
          }
          if (templateHelpers.isFunctionString(str)) {
            var markup$__8 = {"@func": {code: str}};
            f(markup$__8, parent, pkey);
            return false;
          }
        }
      } else if (_.isPlainObject(subObj)) {
        var keys = _.keys(subObj);
        if (keys.length === 1) {
          var key = keys[0];
          if (key[0] === "@" && key.length > 1) {
            var markup$__9 = {};
            markup$__9[key] = subObj[key];
            f(markup$__9, parent, pkey);
            return false;
          }
        } else if (keys.length === 2) {
          var key1 = keys[0];
          var key2 = keys[1];
          if (key1 === "@require" && key2[0] === "@" && key2.length > 1) {
            var markup$__10 = {};
            markup$__10[key1] = subObj[key1];
            markup$__10[key2] = subObj[key2];
            f(markup$__10, parent, pkey);
            return false;
          } else if (key2 === "@require" && key1[0] === "@" && key1.length > 1) {
            var markup$__11 = {};
            markup$__11[key2] = subObj[key2];
            markup$__11[key1] = subObj[key1];
            f(markup$__11, parent, pkey);
            return false;
          }
        }
      } else if (_.isFunction(subObj)) {
        var markup$__12 = {"@func": {code: subObj}};
        f(markup$__12, parent, pkey);
        return false;
      }
      return true;
    }, maxDepth);
  }
};
module.exports = templateHelpers;
//# sourceMappingURL=data:application/json;base64,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QUFBLE1BQUssQ0FBRSxJQUFHLENBQUMsQ0FBQztBQUMzQix1QkFBTyxJQUFHLENBQUMsRUFBSSxDQUFBLE1BQUssQ0FBRSxJQUFHLENBQUMsQ0FBQztBQUMzQixZQUFBLEFBQUMsYUFBUyxPQUFLLENBQUcsS0FBRyxDQUFDLENBQUM7QUFDdkIsaUJBQU8sTUFBSSxDQUFDO1VBQ2hCLEtBQ0ssS0FBSSxJQUFHLElBQU0sV0FBUyxDQUFBLEVBQUssQ0FBQSxJQUFHLENBQUUsQ0FBQSxDQUFDLElBQU0sSUFBRSxDQUFBLEVBQUssQ0FBQSxJQUFHLE9BQU8sRUFBSSxFQUFBLENBQUc7QUFDaEUsQUFBSSxjQUFBLENBQUEsV0FBSyxFQUFJLEdBQUMsQ0FBQztBQUNmLHVCQUFPLElBQUcsQ0FBQyxFQUFJLENBQUEsTUFBSyxDQUFFLElBQUcsQ0FBQyxDQUFDO0FBQzNCLHVCQUFPLElBQUcsQ0FBQyxFQUFJLENBQUEsTUFBSyxDQUFFLElBQUcsQ0FBQyxDQUFDO0FBQzNCLFlBQUEsQUFBQyxhQUFTLE9BQUssQ0FBRyxLQUFHLENBQUMsQ0FBQztBQUN2QixpQkFBTyxNQUFJLENBQUM7VUFDaEI7QUFBQSxRQUNKO0FBQUEsTUFDSixLQUNLLEtBQUksQ0FBQSxXQUFXLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBRztBQUMzQixBQUFJLFVBQUEsQ0FBQSxXQUFLLEVBQUksRUFDVCxPQUFNLENBQUcsRUFDTCxJQUFHLENBQUcsT0FBSyxDQUNmLENBQ0osQ0FBQztBQUNELFFBQUEsQUFBQyxhQUFTLE9BQUssQ0FBRyxLQUFHLENBQUMsQ0FBQztBQUN2QixhQUFPLE1BQUksQ0FBQztNQUNoQjtBQUFBLEFBQ0EsV0FBTyxLQUFHLENBQUM7SUFDZixDQUNBLFNBQU8sQ0FBQyxDQUFDO0VBQ2pCO0FBQUEsQUFDSixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksZ0JBQWMsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvdGVtcGxhdGVIZWxwZXJzLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IFJlZmxlY3Rpb24gPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5zeXN0ZW0uUmVmbGVjdGlvbjtcblxubGV0IG1heERlcHRoID0gMTA7XG5cbmxldCB0ZW1wbGF0ZUhlbHBlcnMgPSB7XG5cbiAgICBhc0dldDogZnVuY3Rpb24gKGV4cHIpIHtcbiAgICAgICAgbGV0IHBhcnRzID0gZXhwci5zcGxpdChcIi5cIik7XG4gICAgICAgIGxldCByZXN1bHQ7XG4gICAgICAgIGZvciAobGV0IHBhcnQgb2YgcGFydHMpIHtcbiAgICAgICAgICAgIGlmICghcmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gXCIoZnVuY3Rpb24oKSB7IHZhciB2ID0gdGhpcy5nZXQoJ1wiICsgcGFydC50cmltKCkgKyBcIicpO1wiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ICs9IFwidiA9IF8uaXNGdW5jdGlvbih2LmdldCkgPyB2LmdldCgnXCIgKyBwYXJ0LnRyaW0oKSArIFwiJykgOiB2LlwiICsgcGFydC50cmltKCkgKyBcIjtcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXN1bHQgKz0gXCJyZXR1cm4gdjt9KS5iaW5kKHRoaXMpKClcIjtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LFxuICAgIGlzRnVuY3Rpb25TdHJpbmc6IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgcmV0dXJuIF8uaXNTdHJpbmcoc3RyKSAmJiBzdHIubWF0Y2goL15cXHMqZnVuY3Rpb25cXHMqXFx3KlxccypcXCgoPzpcXHcrLCkqKD86XFx3Kyk/XFwpXFxzKlxcey8pO1xuICAgIH0sXG4gICAgaXNUZW1wbGF0ZTogZnVuY3Rpb24gKG9iaikge1xuICAgICAgICBsZXQgYWN0aXZpdHlDb3VudCA9IDA7XG4gICAgICAgIHRlbXBsYXRlSGVscGVycy52aXNpdEFjdGl2aXRpZXMob2JqLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBhY3Rpdml0eUNvdW50Kys7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gYWN0aXZpdHlDb3VudCA+IDA7XG4gICAgfSxcbiAgICB2aXNpdEFjdGl2aXRpZXM6IGZ1bmN0aW9uIChvYmosIGYpIHtcbiAgICAgICAgaWYgKCFfLmlzUGxhaW5PYmplY3Qob2JqKSAmJiAhXy5pc0FycmF5KG9iaikpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBSZWZsZWN0aW9uLnZpc2l0T2JqZWN0KG9iaixcbiAgICAgICAgICAgIGZ1bmN0aW9uIChzdWJPYmosIHBhcmVudCwgcGtleSkge1xuICAgICAgICAgICAgICAgIGlmIChfLmlzU3RyaW5nKHN1Yk9iaikpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN0ciA9IHN1Yk9iai50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdHIubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0clswXSA9PT0gXCIjXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbWFya3VwID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBleHByZXNzaW9uXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cHI6IHN0ci5zdWJzdHIoMSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZihtYXJrdXAsIHBhcmVudCwgcGtleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0clswXSA9PT0gXCI9XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbWFya3VwID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkBleHByZXNzaW9uXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cHI6IHRlbXBsYXRlSGVscGVycy5hc0dldChzdHIuc3Vic3RyKDEpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmKG1hcmt1cCwgcGFyZW50LCBwa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVtcGxhdGVIZWxwZXJzLmlzRnVuY3Rpb25TdHJpbmcoc3RyKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtYXJrdXAgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQGZ1bmNcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogc3RyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYobWFya3VwLCBwYXJlbnQsIHBrZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChfLmlzUGxhaW5PYmplY3Qoc3ViT2JqKSkge1xuICAgICAgICAgICAgICAgICAgICBsZXQga2V5cyA9IF8ua2V5cyhzdWJPYmopO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGtleSA9IGtleXNbMF07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5WzBdID09PSBcIkBcIiAmJiBrZXkubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtYXJrdXAgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrdXBba2V5XSA9IHN1Yk9ialtrZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYobWFya3VwLCBwYXJlbnQsIHBrZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXlzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGtleTEgPSBrZXlzWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGtleTIgPSBrZXlzWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleTEgPT09IFwiQHJlcXVpcmVcIiAmJiBrZXkyWzBdID09PSBcIkBcIiAmJiBrZXkyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbWFya3VwID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya3VwW2tleTFdID0gc3ViT2JqW2tleTFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmt1cFtrZXkyXSA9IHN1Yk9ialtrZXkyXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmKG1hcmt1cCwgcGFyZW50LCBwa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkyID09PSBcIkByZXF1aXJlXCIgJiYga2V5MVswXSA9PT0gXCJAXCIgJiYga2V5MS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1hcmt1cCA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmt1cFtrZXkyXSA9IHN1Yk9ialtrZXkyXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrdXBba2V5MV0gPSBzdWJPYmpba2V5MV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZihtYXJrdXAsIHBhcmVudCwgcGtleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKF8uaXNGdW5jdGlvbihzdWJPYmopKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBtYXJrdXAgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcIkBmdW5jXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBzdWJPYmpcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgZihtYXJrdXAsIHBhcmVudCwgcGtleSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbWF4RGVwdGgpO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gdGVtcGxhdGVIZWxwZXJzOyJdfQ==
