"use strict";
var Activity = require("./activity");
var util = require("util");
var _ = require("lodash");
var is = require("../common/is");
var Block = require("./block");
var WithBody = require("./withBody");
function ForEach() {
  WithBody.call(this);
  this.items = null;
  this.varName = "item";
  this.parallel = false;
  this._bodies = null;
}
util.inherits(ForEach, WithBody);
ForEach.prototype.initializeStructure = function() {
  if (this.parallel) {
    var numCPUs = require("os").cpus().length;
    this._bodies = [];
    if (this.args && this.args.length) {
      for (var i = 0; i < Math.min(process.env.UV_THREADPOOL_SIZE || 100000, numCPUs); i++) {
        var newArgs = [];
        var $__4 = true;
        var $__5 = false;
        var $__6 = undefined;
        try {
          for (var $__2 = void 0,
              $__1 = (this.args)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__4 = ($__2 = $__1.next()).done); $__4 = true) {
            var arg = $__2.value;
            {
              if (arg instanceof Activity) {
                newArgs.push(arg.clone());
              } else {
                newArgs.push(arg);
              }
            }
          }
        } catch ($__7) {
          $__5 = true;
          $__6 = $__7;
        } finally {
          try {
            if (!$__4 && $__1.return != null) {
              $__1.return();
            }
          } finally {
            if ($__5) {
              throw $__6;
            }
          }
        }
        var newBody = new Block();
        newBody.args = newArgs;
        this._bodies.push(newBody);
      }
    }
    this.args = null;
  } else {
    WithBody.prototype.initializeStructure.call(this);
  }
};
ForEach.prototype.run = function(callContext, args) {
  var varName = this.varName;
  var items = this.items;
  if (!_.isNull(items)) {
    this[varName] = null;
    callContext.schedule(items, "_itemsGot");
  } else {
    callContext.complete();
  }
};
ForEach.prototype._itemsGot = function(callContext, reason, result) {
  if (reason === Activity.states.complete && !_.isUndefined(result)) {
    this._todo = _.isArray(result) ? result : [result];
    callContext.activity._doStep.call(this, callContext);
  } else {
    callContext.end(reason, result);
  }
};
ForEach.prototype._doStep = function(callContext, lastResult) {
  var varName = this.varName;
  var todo = this._todo;
  if (todo && todo.length) {
    if (this.parallel) {
      var bodies = this._bodies;
      var pack = [];
      var idx = 0;
      while (todo.length && idx < bodies.length) {
        var item = todo[0];
        todo.splice(0, 1);
        var variables = {};
        variables[varName] = item;
        pack.push({
          variables: variables,
          activity: bodies[idx++]
        });
      }
      callContext.schedule(pack, "_bodyFinished");
    } else {
      var item$__8 = todo[0];
      todo.splice(0, 1);
      var variables$__9 = {};
      variables$__9[varName] = item$__8;
      callContext.schedule({
        activity: this._body,
        variables: variables$__9
      }, "_bodyFinished");
    }
  } else {
    callContext.complete(lastResult);
  }
};
ForEach.prototype._bodyFinished = function(callContext, reason, result) {
  if (reason === Activity.states.complete) {
    callContext.activity._doStep.call(this, callContext, result);
  } else {
    callContext.end(reason, result);
  }
};
module.exports = ForEach;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZvckVhY2guanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFFQSxBQUFJLEVBQUEsQ0FBQSxRQUFPLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxZQUFXLENBQUMsQ0FBQztBQUNwQyxBQUFJLEVBQUEsQ0FBQSxJQUFHLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQztBQUMxQixBQUFJLEVBQUEsQ0FBQSxDQUFBLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsQ0FBQztBQUN6QixBQUFJLEVBQUEsQ0FBQSxFQUFDLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxjQUFhLENBQUMsQ0FBQztBQUNoQyxBQUFJLEVBQUEsQ0FBQSxLQUFJLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxTQUFRLENBQUMsQ0FBQztBQUM5QixBQUFJLEVBQUEsQ0FBQSxRQUFPLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxZQUFXLENBQUMsQ0FBQztBQUVwQyxPQUFTLFFBQU0sQ0FBRSxBQUFELENBQUc7QUFDZixTQUFPLEtBQUssQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0FBRW5CLEtBQUcsTUFBTSxFQUFJLEtBQUcsQ0FBQztBQUNqQixLQUFHLFFBQVEsRUFBSSxPQUFLLENBQUM7QUFDckIsS0FBRyxTQUFTLEVBQUksTUFBSSxDQUFDO0FBQ3JCLEtBQUcsUUFBUSxFQUFJLEtBQUcsQ0FBQztBQUN2QjtBQUFBLEFBRUEsR0FBRyxTQUFTLEFBQUMsQ0FBQyxPQUFNLENBQUcsU0FBTyxDQUFDLENBQUM7QUFFaEMsTUFBTSxVQUFVLG9CQUFvQixFQUFJLFVBQVMsQUFBRDtBQUM1QyxLQUFJLElBQUcsU0FBUyxDQUFHO0FBQ2YsQUFBSSxNQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsSUFBRyxDQUFDLEtBQUssQUFBQyxFQUFDLE9BQU8sQ0FBQztBQUN6QyxPQUFHLFFBQVEsRUFBSSxHQUFDLENBQUM7QUFDakIsT0FBSSxJQUFHLEtBQUssR0FBSyxDQUFBLElBQUcsS0FBSyxPQUFPLENBQUc7QUFDL0IsaUJBQWEsRUFBQSxDQUFHLENBQUEsQ0FBQSxFQUFJLENBQUEsSUFBRyxJQUFJLEFBQUMsQ0FBQyxPQUFNLElBQUksbUJBQW1CLEdBQUssT0FBSyxDQUFHLFFBQU0sQ0FBQyxDQUFHLENBQUEsQ0FBQSxFQUFFLENBQUc7QUFDbEYsQUFBSSxVQUFBLENBQUEsT0FBTSxFQUFJLEdBQUMsQ0FBQztBQXpCeEIsQUFBSSxVQUFBLE9BQW9CLEtBQUcsQ0FBQztBQUM1QixBQUFJLFVBQUEsT0FBb0IsTUFBSSxDQUFDO0FBQzdCLEFBQUksVUFBQSxPQUFvQixVQUFRLENBQUM7QUFDakMsVUFBSTtBQUhKLGNBQVMsR0FBQSxPQURqQixLQUFLLEVBQUEsQUFDNEI7QUFDaEIsbUJBQW9CLENBQUEsQ0F5QkwsSUFBRyxLQUFLLENBekJlLENBQ2xDLGVBQWMsV0FBVyxBQUFDLENBQUMsTUFBSyxTQUFTLENBQUMsQ0FBQyxBQUFDLEVBQUMsQ0FDckQsRUFBQyxDQUFDLE1BQW9CLENBQUEsQ0FBQyxNQUFvQixDQUFBLFNBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RSxPQUFvQixLQUFHLENBQUc7Y0FzQmQsSUFBRTtBQUFnQjtBQUN2QixpQkFBSSxHQUFFLFdBQWEsU0FBTyxDQUFHO0FBQ3pCLHNCQUFNLEtBQUssQUFBQyxDQUFDLEdBQUUsTUFBTSxBQUFDLEVBQUMsQ0FBQyxDQUFDO2NBQzdCLEtBQ0s7QUFDRCxzQkFBTSxLQUFLLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0FBQztjQUNyQjtBQUFBLFlBQ0o7VUExQlI7QUFBQSxRQUZBLENBQUUsWUFBMEI7QUFDMUIsZUFBb0IsS0FBRyxDQUFDO0FBQ3hCLG9CQUFvQyxDQUFDO1FBQ3ZDLENBQUUsT0FBUTtBQUNSLFlBQUk7QUFDRixlQUFJLEtBQWlCLEdBQUssQ0FBQSxXQUF1QixHQUFLLEtBQUcsQ0FBRztBQUMxRCx3QkFBd0IsQUFBQyxFQUFDLENBQUM7WUFDN0I7QUFBQSxVQUNGLENBQUUsT0FBUTtBQUNSLG9CQUF3QjtBQUN0Qix3QkFBd0I7WUFDMUI7QUFBQSxVQUNGO0FBQUEsUUFDRjtBQUFBLEFBZ0JZLFVBQUEsQ0FBQSxPQUFNLEVBQUksSUFBSSxNQUFJLEFBQUMsRUFBQyxDQUFDO0FBQ3pCLGNBQU0sS0FBSyxFQUFJLFFBQU0sQ0FBQztBQUN0QixXQUFHLFFBQVEsS0FBSyxBQUFDLENBQUMsT0FBTSxDQUFDLENBQUM7TUFDOUI7QUFBQSxJQUNKO0FBQUEsQUFDQSxPQUFHLEtBQUssRUFBSSxLQUFHLENBQUM7RUFDcEIsS0FDSztBQUNELFdBQU8sVUFBVSxvQkFBb0IsS0FBSyxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7RUFDckQ7QUFBQSxBQUNKLENBQUM7QUFFRCxNQUFNLFVBQVUsSUFBSSxFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsSUFBRyxDQUFHO0FBQ2pELEFBQU0sSUFBQSxDQUFBLE9BQU0sRUFBSSxDQUFBLElBQUcsUUFBUSxDQUFDO0FBQzVCLEFBQUksSUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsTUFBTSxDQUFDO0FBQ3RCLEtBQUksQ0FBQyxDQUFBLE9BQU8sQUFBQyxDQUFDLEtBQUksQ0FBQyxDQUFHO0FBQ2xCLE9BQUcsQ0FBRSxPQUFNLENBQUMsRUFBSSxLQUFHLENBQUM7QUFDcEIsY0FBVSxTQUFTLEFBQUMsQ0FBQyxLQUFJLENBQUcsWUFBVSxDQUFDLENBQUM7RUFDNUMsS0FDSztBQUNELGNBQVUsU0FBUyxBQUFDLEVBQUMsQ0FBQztFQUMxQjtBQUFBLEFBQ0osQ0FBQztBQUVELE1BQU0sVUFBVSxVQUFVLEVBQUksVUFBVSxXQUFVLENBQUcsQ0FBQSxNQUFLLENBQUcsQ0FBQSxNQUFLLENBQUc7QUFDakUsS0FBSSxNQUFLLElBQU0sQ0FBQSxRQUFPLE9BQU8sU0FBUyxDQUFBLEVBQUssRUFBQyxDQUFBLFlBQVksQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFHO0FBQy9ELE9BQUcsTUFBTSxFQUFJLENBQUEsQ0FBQSxRQUFRLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQSxDQUFJLE9BQUssRUFBSSxFQUFFLE1BQUssQ0FBRSxDQUFDO0FBQ3BELGNBQVUsU0FBUyxRQUFRLEtBQUssQUFBQyxDQUFDLElBQUcsQ0FBRyxZQUFVLENBQUMsQ0FBQztFQUN4RCxLQUNLO0FBQ0QsY0FBVSxJQUFJLEFBQUMsQ0FBQyxNQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7RUFDbkM7QUFBQSxBQUNKLENBQUM7QUFFRCxNQUFNLFVBQVUsUUFBUSxFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsVUFBUyxDQUFHO0FBQzNELEFBQU0sSUFBQSxDQUFBLE9BQU0sRUFBSSxDQUFBLElBQUcsUUFBUSxDQUFDO0FBQzVCLEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLElBQUcsTUFBTSxDQUFDO0FBQ3JCLEtBQUksSUFBRyxHQUFLLENBQUEsSUFBRyxPQUFPLENBQUc7QUFDckIsT0FBSSxJQUFHLFNBQVMsQ0FBRztBQUNmLEFBQUksUUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLElBQUcsUUFBUSxDQUFDO0FBQ3pCLEFBQUksUUFBQSxDQUFBLElBQUcsRUFBSSxHQUFDLENBQUM7QUFDYixBQUFJLFFBQUEsQ0FBQSxHQUFFLEVBQUksRUFBQSxDQUFDO0FBQ1gsWUFBTyxJQUFHLE9BQU8sR0FBSyxDQUFBLEdBQUUsRUFBSSxDQUFBLE1BQUssT0FBTyxDQUFHO0FBQ3ZDLEFBQUksVUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLElBQUcsQ0FBRSxDQUFBLENBQUMsQ0FBQztBQUNsQixXQUFHLE9BQU8sQUFBQyxDQUFDLENBQUEsQ0FBRyxFQUFBLENBQUMsQ0FBQztBQUNqQixBQUFJLFVBQUEsQ0FBQSxTQUFRLEVBQUksR0FBQyxDQUFDO0FBQ2xCLGdCQUFRLENBQUUsT0FBTSxDQUFDLEVBQUksS0FBRyxDQUFDO0FBQ3pCLFdBQUcsS0FBSyxBQUFDLENBQUM7QUFDTixrQkFBUSxDQUFHLFVBQVE7QUFDbkIsaUJBQU8sQ0FBRyxDQUFBLE1BQUssQ0FBRSxHQUFFLEVBQUUsQ0FBQztBQUFBLFFBQzFCLENBQUMsQ0FBQztNQUNOO0FBQUEsQUFDQSxnQkFBVSxTQUFTLEFBQUMsQ0FBQyxJQUFHLENBQUcsZ0JBQWMsQ0FBQyxDQUFDO0lBQy9DLEtBQ0s7QUFDRCxBQUFJLFFBQUEsQ0FBQSxRQUFHLEVBQUksQ0FBQSxJQUFHLENBQUUsQ0FBQSxDQUFDLENBQUM7QUFDbEIsU0FBRyxPQUFPLEFBQUMsQ0FBQyxDQUFBLENBQUcsRUFBQSxDQUFDLENBQUM7QUFDakIsQUFBSSxRQUFBLENBQUEsYUFBUSxFQUFJLEdBQUMsQ0FBQztBQUNsQixtQkFBVSxPQUFNLENBQUMsV0FBTyxDQUFDO0FBQ3pCLGdCQUFVLFNBQVMsQUFBQyxDQUFDO0FBQUUsZUFBTyxDQUFHLENBQUEsSUFBRyxNQUFNO0FBQUcsZ0JBQVEsZUFBVztNQUFFLENBQUcsZ0JBQWMsQ0FBQyxDQUFDO0lBQ3pGO0FBQUEsRUFDSixLQUNLO0FBQ0QsY0FBVSxTQUFTLEFBQUMsQ0FBQyxVQUFTLENBQUMsQ0FBQztFQUNwQztBQUFBLEFBQ0osQ0FBQztBQUVELE1BQU0sVUFBVSxjQUFjLEVBQUksVUFBVSxXQUFVLENBQUcsQ0FBQSxNQUFLLENBQUcsQ0FBQSxNQUFLLENBQUc7QUFDckUsS0FBSSxNQUFLLElBQU0sQ0FBQSxRQUFPLE9BQU8sU0FBUyxDQUFHO0FBQ3JDLGNBQVUsU0FBUyxRQUFRLEtBQUssQUFBQyxDQUFDLElBQUcsQ0FBRyxZQUFVLENBQUcsT0FBSyxDQUFDLENBQUM7RUFDaEUsS0FDSztBQUNELGNBQVUsSUFBSSxBQUFDLENBQUMsTUFBSyxDQUFHLE9BQUssQ0FBQyxDQUFDO0VBQ25DO0FBQUEsQUFDSixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksUUFBTSxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9mb3JFYWNoLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IEFjdGl2aXR5ID0gcmVxdWlyZShcIi4vYWN0aXZpdHlcIik7XG5sZXQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IGlzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9pc1wiKTtcbmxldCBCbG9jayA9IHJlcXVpcmUoXCIuL2Jsb2NrXCIpO1xubGV0IFdpdGhCb2R5ID0gcmVxdWlyZShcIi4vd2l0aEJvZHlcIik7XG5cbmZ1bmN0aW9uIEZvckVhY2goKSB7XG4gICAgV2l0aEJvZHkuY2FsbCh0aGlzKTtcblxuICAgIHRoaXMuaXRlbXMgPSBudWxsO1xuICAgIHRoaXMudmFyTmFtZSA9IFwiaXRlbVwiO1xuICAgIHRoaXMucGFyYWxsZWwgPSBmYWxzZTtcbiAgICB0aGlzLl9ib2RpZXMgPSBudWxsO1xufVxuXG51dGlsLmluaGVyaXRzKEZvckVhY2gsIFdpdGhCb2R5KTtcblxuRm9yRWFjaC5wcm90b3R5cGUuaW5pdGlhbGl6ZVN0cnVjdHVyZSA9IGZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLnBhcmFsbGVsKSB7XG4gICAgICAgIGxldCBudW1DUFVzID0gcmVxdWlyZShcIm9zXCIpLmNwdXMoKS5sZW5ndGg7XG4gICAgICAgIHRoaXMuX2JvZGllcyA9IFtdO1xuICAgICAgICBpZiAodGhpcy5hcmdzICYmIHRoaXMuYXJncy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTWF0aC5taW4ocHJvY2Vzcy5lbnYuVVZfVEhSRUFEUE9PTF9TSVpFIHx8IDEwMDAwMCwgbnVtQ1BVcyk7IGkrKykge1xuICAgICAgICAgICAgICAgIGxldCBuZXdBcmdzID0gW107XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgYXJnIG9mIHRoaXMuYXJncykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXJnIGluc3RhbmNlb2YgQWN0aXZpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FyZ3MucHVzaChhcmcuY2xvbmUoKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdBcmdzLnB1c2goYXJnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBsZXQgbmV3Qm9keSA9IG5ldyBCbG9jaygpO1xuICAgICAgICAgICAgICAgIG5ld0JvZHkuYXJncyA9IG5ld0FyZ3M7XG4gICAgICAgICAgICAgICAgdGhpcy5fYm9kaWVzLnB1c2gobmV3Qm9keSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5hcmdzID0gbnVsbDtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIFdpdGhCb2R5LnByb3RvdHlwZS5pbml0aWFsaXplU3RydWN0dXJlLmNhbGwodGhpcyk7XG4gICAgfVxufTtcblxuRm9yRWFjaC5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBhcmdzKSB7XG4gICAgY29uc3QgdmFyTmFtZSA9IHRoaXMudmFyTmFtZTtcbiAgICBsZXQgaXRlbXMgPSB0aGlzLml0ZW1zO1xuICAgIGlmICghXy5pc051bGwoaXRlbXMpKSB7XG4gICAgICAgIHRoaXNbdmFyTmFtZV0gPSBudWxsO1xuICAgICAgICBjYWxsQ29udGV4dC5zY2hlZHVsZShpdGVtcywgXCJfaXRlbXNHb3RcIik7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjYWxsQ29udGV4dC5jb21wbGV0ZSgpO1xuICAgIH1cbn07XG5cbkZvckVhY2gucHJvdG90eXBlLl9pdGVtc0dvdCA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgcmVhc29uLCByZXN1bHQpIHtcbiAgICBpZiAocmVhc29uID09PSBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUgJiYgIV8uaXNVbmRlZmluZWQocmVzdWx0KSkge1xuICAgICAgICB0aGlzLl90b2RvID0gXy5pc0FycmF5KHJlc3VsdCkgPyByZXN1bHQgOiBbIHJlc3VsdCBdO1xuICAgICAgICBjYWxsQ29udGV4dC5hY3Rpdml0eS5fZG9TdGVwLmNhbGwodGhpcywgY2FsbENvbnRleHQpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY2FsbENvbnRleHQuZW5kKHJlYXNvbiwgcmVzdWx0KTtcbiAgICB9XG59O1xuXG5Gb3JFYWNoLnByb3RvdHlwZS5fZG9TdGVwID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBsYXN0UmVzdWx0KSB7XG4gICAgY29uc3QgdmFyTmFtZSA9IHRoaXMudmFyTmFtZTtcbiAgICBsZXQgdG9kbyA9IHRoaXMuX3RvZG87XG4gICAgaWYgKHRvZG8gJiYgdG9kby5sZW5ndGgpIHtcbiAgICAgICAgaWYgKHRoaXMucGFyYWxsZWwpIHtcbiAgICAgICAgICAgIGxldCBib2RpZXMgPSB0aGlzLl9ib2RpZXM7XG4gICAgICAgICAgICBsZXQgcGFjayA9IFtdO1xuICAgICAgICAgICAgbGV0IGlkeCA9IDA7XG4gICAgICAgICAgICB3aGlsZSAodG9kby5sZW5ndGggJiYgaWR4IDwgYm9kaWVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGxldCBpdGVtID0gdG9kb1swXTtcbiAgICAgICAgICAgICAgICB0b2RvLnNwbGljZSgwLCAxKTtcbiAgICAgICAgICAgICAgICBsZXQgdmFyaWFibGVzID0ge307XG4gICAgICAgICAgICAgICAgdmFyaWFibGVzW3Zhck5hbWVdID0gaXRlbTtcbiAgICAgICAgICAgICAgICBwYWNrLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZXM6IHZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHk6IGJvZGllc1tpZHgrK11cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKHBhY2ssIFwiX2JvZHlGaW5pc2hlZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGxldCBpdGVtID0gdG9kb1swXTtcbiAgICAgICAgICAgIHRvZG8uc3BsaWNlKDAsIDEpO1xuICAgICAgICAgICAgbGV0IHZhcmlhYmxlcyA9IHt9O1xuICAgICAgICAgICAgdmFyaWFibGVzW3Zhck5hbWVdID0gaXRlbTtcbiAgICAgICAgICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKHsgYWN0aXZpdHk6IHRoaXMuX2JvZHksIHZhcmlhYmxlczogdmFyaWFibGVzIH0sIFwiX2JvZHlGaW5pc2hlZFwiKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY2FsbENvbnRleHQuY29tcGxldGUobGFzdFJlc3VsdCk7XG4gICAgfVxufTtcblxuRm9yRWFjaC5wcm90b3R5cGUuX2JvZHlGaW5pc2hlZCA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgcmVhc29uLCByZXN1bHQpIHtcbiAgICBpZiAocmVhc29uID09PSBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUpIHtcbiAgICAgICAgY2FsbENvbnRleHQuYWN0aXZpdHkuX2RvU3RlcC5jYWxsKHRoaXMsIGNhbGxDb250ZXh0LCByZXN1bHQpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY2FsbENvbnRleHQuZW5kKHJlYXNvbiwgcmVzdWx0KTtcbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IEZvckVhY2g7Il19
