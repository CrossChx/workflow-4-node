{"version":3,"sources":["hosting/wakeUp.js"],"names":[],"mappings":"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","file":"hosting/wakeUp.js","sourcesContent":["\"use strict\";\n\nlet EventEmitter = require(\"events\").EventEmitter;\nlet Bluebird = require(\"bluebird\");\nlet async = require(\"../common\").asyncHelpers.async;\nlet debug = require(\"debug\")(\"wf4node:WakeUp\");\nlet util = require(\"util\");\n\nfunction WakeUp(knownInstaStore, persistence, options) {\n    EventEmitter.call(this);\n\n    this.knownInstaStore = knownInstaStore;\n    this.persistence = persistence;\n    this.options = options || {};\n    this._working = false;\n    this._timeout = null;\n    this._batchSize = this.options.batchSize || 10;\n}\n\nutil.inherits(WakeUp, EventEmitter);\n\nWakeUp.prototype.start = function () {\n    if (!this._timeout) {\n        debug(\"Start.\");\n        let self = this;\n        this._timeout = setTimeout(function () { self._step(); }, this.options.interval || 5000);\n    }\n};\n\nWakeUp.prototype.stop = function () {\n    if (this._timeout) {\n        debug(\"Stop.\");\n        clearTimeout(this._timeout);\n        this._timeout = null;\n    }\n};\n\nWakeUp.prototype._step = async(function*() {\n    let self = this;\n    try {\n        if (this._working) {\n            debug(\"Skipping current step because work in progress.\");\n            return;\n        }\n        debug(\"Starting next step.\");\n        this._working = true;\n        try {\n            let wakeupables = yield this._getNextWakeupables();\n            if (wakeupables && wakeupables.length) {\n                debug(\"%d selected to wake up.\", wakeupables.length);\n                let tasks = [];\n                let count = 0;\n                for (let wakeupable of wakeupables) {\n                    tasks.push(async(function*() {\n                        if (count >= self._batchSize) {\n                            return;\n                        }\n                        debug(\"Waking up workflow %s, id: %s\", wakeupable.workflowName, wakeupable.instanceId);\n                        wakeupable.result = {};\n                        let promise = new Bluebird(function (resolve, reject) {\n                            wakeupable.result.resolve = resolve;\n                            wakeupable.result.reject = reject;\n                        });\n                        self.emit(\"continue\", wakeupable);\n                        try {\n                            yield promise;\n                            count++;\n                            debug(\"Processing delay completed.\");\n                        }\n                        catch (e) {\n                            debug(\"Processing delay error: %s\", e.stack);\n                            self.emit(\"error\", e);\n                        }\n                    })());\n                }\n\n                let results = yield Bluebird.settle(tasks);\n                for (let result of results) {\n                    if (result.isRejected()) {\n                        throw result.reason();\n                    }\n                }\n            }\n            else {\n                debug(\"There is no instance to wake up.\");\n            }\n        }\n        catch (e) {\n            this.emit(\"error\", e);\n        }\n        finally {\n            debug(\"Next step completed.\");\n            this._working = false;\n        }\n    }\n    finally {\n        if (this._timeout) {\n            this._timeout = setTimeout(function () { self._step(); }, this.options.interval || 5000);\n        }\n    }\n});\n\nWakeUp.prototype._getNextWakeupables = async(function* () {\n    if (this.persistence) {\n        return yield this.persistence.getNextWakeupables(this._batchSize * 1.5);\n    }\n    else {\n        return this.knownInstaStore.getNextWakeupables(this._batchSize * 1.5);\n    }\n});\n\nmodule.exports = WakeUp;"],"sourceRoot":"/source/"}