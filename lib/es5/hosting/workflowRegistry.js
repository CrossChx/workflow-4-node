"use strict";
"use strict";
var Workflow = require("../activities/workflow");
var _ = require("lodash");
var BeginMethod = require("../activities/beginMethod");
var EndMethod = require("../activities/endMethod");
var is = require("../common/is");
function WorkflowRegistry() {
  this._workflows = new Map();
}
WorkflowRegistry.prototype.register = function(workflow) {
  if (workflow instanceof Workflow) {
    if (!_(workflow.name).isString()) {
      throw new TypeError("Workflow name is not a string.");
    }
    var name = workflow.name.trim();
    if (!name) {
      throw new TypeError("Workflow name is empty.");
    }
    if (!_(workflow.version).isNumber()) {
      throw new TypeError("Workflow version is not a number.");
    }
    var version = workflow.version.toString();
    var entry = this._workflows.get(name);
    if (entry) {
      var desc = entry.get(version);
      if (desc) {
        throw new Error("Workflow " + name + " " + version + " already registered.");
      } else {
        entry.set(version, this._createDesc(workflow, name, workflow.version));
      }
    } else {
      entry = new Map();
      entry.set(version, this._createDesc(workflow, name, workflow.version));
      this._workflows.set(name, entry);
    }
  } else {
    throw new TypeError("Workflow instance argument expected.");
  }
};
WorkflowRegistry.prototype.getDesc = function(name, version) {
  var entry = this._workflows.get(name);
  if (entry) {
    if (is.defined(version)) {
      version = version.toString();
      var desc = entry.get(version);
      if (desc) {
        return desc;
      }
      throw new Error("Workflow " + name + " " + version + " has not been registered.");
    } else {
      var maxV = -10000000;
      var desc$__7 = null;
      var $__3 = true;
      var $__4 = false;
      var $__5 = undefined;
      try {
        for (var $__1 = void 0,
            $__0 = (entry.values())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
          var d = $__1.value;
          {
            if (d.version > maxV) {
              desc$__7 = d;
              break;
            }
          }
        }
      } catch ($__6) {
        $__4 = true;
        $__5 = $__6;
      } finally {
        try {
          if (!$__3 && $__0.return != null) {
            $__0.return();
          }
        } finally {
          if ($__4) {
            throw $__5;
          }
        }
      }
      if (desc$__7) {
        return desc$__7;
      }
      throw new Error("Workflow " + name + " has not been registered.");
    }
  }
};
WorkflowRegistry.prototype._createDesc = function(workflow, name, version) {
  return {
    workflow: workflow,
    name: name,
    version: version,
    methods: this._collectMethodInfos(workflow)
  };
};
WorkflowRegistry.prototype._collectMethodInfos = function(workflow) {
  var self = this;
  var infos = new Map();
  workflow.forEachChild(function(child) {
    var isBM = child instanceof BeginMethod;
    var isEM = child instanceof EndMethod;
    if (isBM || isEM) {
      var methodName = _(child.methodName).isString() ? child.methodName.trim() : null;
      var instanceIdPath = _(child.instanceIdPath).isString() ? child.instanceIdPath.trim() : null;
      if (methodName) {
        var info = infos.get(methodName);
        if (!info) {
          info = {
            workflow: workflow,
            canCreateInstance: false,
            instanceIdPath: null
          };
          infos.set(methodName, info);
        }
        if (isBM && child.canCreateInstance) {
          info.canCreateInstance = true;
        }
        if (instanceIdPath) {
          if (info.instanceIdPath) {
            if (info.instanceIdPath !== instanceIdPath) {
              throw new Error("Method '" + methodName + "' in workflow '" + workflow.name + "' has multiple different instanceIdPath value which is not supported.");
            }
          } else {
            info.instanceIdPath = instanceIdPath;
          }
        }
      }
    }
  });
  var result = new Map();
  infos.forEach(function(value, key) {
    if (value.instanceIdPath) {
      result.set(key, value);
    }
  });
  return result;
};
WorkflowRegistry.prototype.forEachMethodInfo = function(workflowName, methodName, f) {
  var entry = this._workflows.get(workflowName);
  if (entry) {
    var $__3 = true;
    var $__4 = false;
    var $__5 = undefined;
    try {
      for (var $__1 = void 0,
          $__0 = (entry.values())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
        var desc = $__1.value;
        {
          var info = desc.methods.get(methodName);
          if (info) {
            f(info);
          }
        }
      }
    } catch ($__6) {
      $__4 = true;
      $__5 = $__6;
    } finally {
      try {
        if (!$__3 && $__0.return != null) {
          $__0.return();
        }
      } finally {
        if ($__4) {
          throw $__5;
        }
      }
    }
  }
};
module.exports = WorkflowRegistry;
//# sourceMappingURL=data:application/json;base64,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Q0FBRztVQWdJdEIsS0FBRztBQUFxQjtBQUM3QixBQUFJLFlBQUEsQ0FBQSxJQUFHLEVBQUksQ0FBQSxJQUFHLFFBQVEsSUFBSSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDdkMsYUFBSSxJQUFHLENBQUc7QUFDTixZQUFBLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztVQUNYO0FBQUEsUUFDSjtNQWxJQTtBQUFBLElBRkEsQ0FBRSxZQUEwQjtBQUMxQixXQUFvQixLQUFHLENBQUM7QUFDeEIsZ0JBQW9DLENBQUM7SUFDdkMsQ0FBRSxPQUFRO0FBQ1IsUUFBSTtBQUNGLFdBQUksS0FBaUIsR0FBSyxDQUFBLFdBQXVCLEdBQUssS0FBRyxDQUFHO0FBQzFELG9CQUF3QixBQUFDLEVBQUMsQ0FBQztRQUM3QjtBQUFBLE1BQ0YsQ0FBRSxPQUFRO0FBQ1IsZ0JBQXdCO0FBQ3RCLG9CQUF3QjtRQUMxQjtBQUFBLE1BQ0Y7QUFBQSxJQUNGO0FBQUEsRUF3SEo7QUFBQSxBQUNKLENBQUM7QUFFRCxLQUFLLFFBQVEsRUFBSSxpQkFBZSxDQUFDO0FBQ2pDIiwiZmlsZSI6Imhvc3Rpbmcvd29ya2Zsb3dSZWdpc3RyeS5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCBXb3JrZmxvdyA9IHJlcXVpcmUoXCIuLi9hY3Rpdml0aWVzL3dvcmtmbG93XCIpO1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IEJlZ2luTWV0aG9kID0gcmVxdWlyZShcIi4uL2FjdGl2aXRpZXMvYmVnaW5NZXRob2RcIik7XG5sZXQgRW5kTWV0aG9kID0gcmVxdWlyZShcIi4uL2FjdGl2aXRpZXMvZW5kTWV0aG9kXCIpO1xubGV0IGlzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9pc1wiKTtcblxuZnVuY3Rpb24gV29ya2Zsb3dSZWdpc3RyeSgpIHtcbiAgICB0aGlzLl93b3JrZmxvd3MgPSBuZXcgTWFwKCk7XG59XG5cbldvcmtmbG93UmVnaXN0cnkucHJvdG90eXBlLnJlZ2lzdGVyID0gZnVuY3Rpb24gKHdvcmtmbG93KSB7XG4gICAgaWYgKHdvcmtmbG93IGluc3RhbmNlb2YgV29ya2Zsb3cpIHtcbiAgICAgICAgaWYgKCFfKHdvcmtmbG93Lm5hbWUpLmlzU3RyaW5nKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJXb3JrZmxvdyBuYW1lIGlzIG5vdCBhIHN0cmluZy5cIik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IG5hbWUgPSB3b3JrZmxvdy5uYW1lLnRyaW0oKTtcbiAgICAgICAgaWYgKCFuYW1lKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiV29ya2Zsb3cgbmFtZSBpcyBlbXB0eS5cIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFfKHdvcmtmbG93LnZlcnNpb24pLmlzTnVtYmVyKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJXb3JrZmxvdyB2ZXJzaW9uIGlzIG5vdCBhIG51bWJlci5cIik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHZlcnNpb24gPSB3b3JrZmxvdy52ZXJzaW9uLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgbGV0IGVudHJ5ID0gdGhpcy5fd29ya2Zsb3dzLmdldChuYW1lKTtcbiAgICAgICAgaWYgKGVudHJ5KSB7XG4gICAgICAgICAgICBsZXQgZGVzYyA9IGVudHJ5LmdldCh2ZXJzaW9uKTtcbiAgICAgICAgICAgIGlmIChkZXNjKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV29ya2Zsb3cgXCIgKyBuYW1lICsgXCIgXCIgKyB2ZXJzaW9uICsgXCIgYWxyZWFkeSByZWdpc3RlcmVkLlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGVudHJ5LnNldCh2ZXJzaW9uLCB0aGlzLl9jcmVhdGVEZXNjKHdvcmtmbG93LCBuYW1lLCB3b3JrZmxvdy52ZXJzaW9uKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBlbnRyeSA9IG5ldyBNYXAoKTtcbiAgICAgICAgICAgIGVudHJ5LnNldCh2ZXJzaW9uLCB0aGlzLl9jcmVhdGVEZXNjKHdvcmtmbG93LCBuYW1lLCB3b3JrZmxvdy52ZXJzaW9uKSk7XG4gICAgICAgICAgICB0aGlzLl93b3JrZmxvd3Muc2V0KG5hbWUsIGVudHJ5KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIldvcmtmbG93IGluc3RhbmNlIGFyZ3VtZW50IGV4cGVjdGVkLlwiKTtcbiAgICB9XG59O1xuXG5Xb3JrZmxvd1JlZ2lzdHJ5LnByb3RvdHlwZS5nZXREZXNjID0gZnVuY3Rpb24gKG5hbWUsIHZlcnNpb24pIHtcbiAgICBsZXQgZW50cnkgPSB0aGlzLl93b3JrZmxvd3MuZ2V0KG5hbWUpO1xuICAgIGlmIChlbnRyeSkge1xuICAgICAgICBpZiAoaXMuZGVmaW5lZCh2ZXJzaW9uKSkge1xuICAgICAgICAgICAgdmVyc2lvbiA9IHZlcnNpb24udG9TdHJpbmcoKTtcbiAgICAgICAgICAgIGxldCBkZXNjID0gZW50cnkuZ2V0KHZlcnNpb24pO1xuICAgICAgICAgICAgaWYgKGRlc2MpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZGVzYztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIldvcmtmbG93IFwiICsgbmFtZSArIFwiIFwiICsgdmVyc2lvbiArIFwiIGhhcyBub3QgYmVlbiByZWdpc3RlcmVkLlwiKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIEdldCB0b3AgdmVyc2lvblxuICAgICAgICAgICAgbGV0IG1heFYgPSAtMTAwMDAwMDA7XG4gICAgICAgICAgICBsZXQgZGVzYyA9IG51bGw7XG4gICAgICAgICAgICBmb3IgKGxldCBkIG9mIGVudHJ5LnZhbHVlcygpKSB7XG4gICAgICAgICAgICAgICAgaWYgKGQudmVyc2lvbiA+IG1heFYpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVzYyA9IGQ7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkZXNjKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRlc2M7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJXb3JrZmxvdyBcIiArIG5hbWUgKyBcIiBoYXMgbm90IGJlZW4gcmVnaXN0ZXJlZC5cIik7XG4gICAgICAgIH1cbiAgICB9XG5cbn07XG5cbldvcmtmbG93UmVnaXN0cnkucHJvdG90eXBlLl9jcmVhdGVEZXNjID0gZnVuY3Rpb24gKHdvcmtmbG93LCBuYW1lLCB2ZXJzaW9uKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgd29ya2Zsb3c6IHdvcmtmbG93LFxuICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICB2ZXJzaW9uOiB2ZXJzaW9uLFxuICAgICAgICBtZXRob2RzOiB0aGlzLl9jb2xsZWN0TWV0aG9kSW5mb3Mod29ya2Zsb3cpXG4gICAgfTtcbn07XG5cbldvcmtmbG93UmVnaXN0cnkucHJvdG90eXBlLl9jb2xsZWN0TWV0aG9kSW5mb3MgPSBmdW5jdGlvbiAod29ya2Zsb3cpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGluZm9zID0gbmV3IE1hcCgpO1xuICAgIHdvcmtmbG93LmZvckVhY2hDaGlsZChmdW5jdGlvbiAoY2hpbGQpIHtcbiAgICAgICAgbGV0IGlzQk0gPSBjaGlsZCBpbnN0YW5jZW9mIEJlZ2luTWV0aG9kO1xuICAgICAgICBsZXQgaXNFTSA9IGNoaWxkIGluc3RhbmNlb2YgRW5kTWV0aG9kO1xuICAgICAgICBpZiAoaXNCTSB8fCBpc0VNKSB7XG4gICAgICAgICAgICBsZXQgbWV0aG9kTmFtZSA9IF8oY2hpbGQubWV0aG9kTmFtZSkuaXNTdHJpbmcoKSA/IGNoaWxkLm1ldGhvZE5hbWUudHJpbSgpIDogbnVsbDtcbiAgICAgICAgICAgIGxldCBpbnN0YW5jZUlkUGF0aCA9IF8oY2hpbGQuaW5zdGFuY2VJZFBhdGgpLmlzU3RyaW5nKCkgPyBjaGlsZC5pbnN0YW5jZUlkUGF0aC50cmltKCkgOiBudWxsO1xuICAgICAgICAgICAgaWYgKG1ldGhvZE5hbWUpIHtcbiAgICAgICAgICAgICAgICBsZXQgaW5mbyA9IGluZm9zLmdldChtZXRob2ROYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgaW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93OiB3b3JrZmxvdyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbkNyZWF0ZUluc3RhbmNlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWRQYXRoOiBudWxsXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGluZm9zLnNldChtZXRob2ROYW1lLCBpbmZvKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGlzQk0gJiYgY2hpbGQuY2FuQ3JlYXRlSW5zdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5mby5jYW5DcmVhdGVJbnN0YW5jZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZUlkUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5mby5pbnN0YW5jZUlkUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZm8uaW5zdGFuY2VJZFBhdGggIT09IGluc3RhbmNlSWRQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kICdcIiArIG1ldGhvZE5hbWUgKyBcIicgaW4gd29ya2Zsb3cgJ1wiICsgd29ya2Zsb3cubmFtZSArIFwiJyBoYXMgbXVsdGlwbGUgZGlmZmVyZW50IGluc3RhbmNlSWRQYXRoIHZhbHVlIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQuXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5mby5pbnN0YW5jZUlkUGF0aCA9IGluc3RhbmNlSWRQYXRoO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG4gICAgbGV0IHJlc3VsdCA9IG5ldyBNYXAoKTtcbiAgICBpbmZvcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7XG4gICAgICAgIGlmICh2YWx1ZS5pbnN0YW5jZUlkUGF0aCkge1xuICAgICAgICAgICAgcmVzdWx0LnNldChrZXksIHZhbHVlKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByZXN1bHQ7XG59O1xuXG5Xb3JrZmxvd1JlZ2lzdHJ5LnByb3RvdHlwZS5mb3JFYWNoTWV0aG9kSW5mbyA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIG1ldGhvZE5hbWUsIGYpIHtcbiAgICBsZXQgZW50cnkgPSB0aGlzLl93b3JrZmxvd3MuZ2V0KHdvcmtmbG93TmFtZSk7XG4gICAgaWYgKGVudHJ5KSB7XG4gICAgICAgIGZvciAobGV0IGRlc2Mgb2YgZW50cnkudmFsdWVzKCkpIHtcbiAgICAgICAgICAgIGxldCBpbmZvID0gZGVzYy5tZXRob2RzLmdldChtZXRob2ROYW1lKTtcbiAgICAgICAgICAgIGlmIChpbmZvKSB7XG4gICAgICAgICAgICAgICAgZihpbmZvKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gV29ya2Zsb3dSZWdpc3RyeTtcbiJdfQ==
