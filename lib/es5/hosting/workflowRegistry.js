"use strict";
var Workflow = require("../activities/workflow");
var _ = require("lodash");
var BeginMethod = require("../activities/beginMethod");
var EndMethod = require("../activities/endMethod");
var is = require("../common/is");
var StrMap = require("backpack-node").collections.StrMap;
function WorkflowRegistry() {
  this._workflows = new StrMap();
}
WorkflowRegistry.prototype.register = function(workflow) {
  if (workflow instanceof Workflow) {
    if (!_(workflow.name).isString())
      throw new TypeError("Workflow name is not a string.");
    var name = workflow.name.trim();
    if (!name)
      throw new TypeError("Workflow name is empty.");
    if (!_(workflow.version).isNumber())
      throw new TypeError("Workflow version is not a number.");
    var version = workflow.version.toString();
    var entry = this._workflows.get(name);
    if (entry) {
      var desc = entry.get(version);
      if (desc) {
        throw new Error("Workflow " + name + " " + version + " already registered.");
      } else {
        entry.add(version, this._createDesc(workflow, name, workflow.version));
      }
    } else {
      entry = new StrMap();
      entry.add(version, this._createDesc(workflow, name, workflow.version));
      this._workflows.add(name, entry);
    }
  } else {
    throw new TypeError("Workflow instance argument expected.");
  }
};
WorkflowRegistry.prototype.getDesc = function(name, version) {
  var entry = this._workflows.get(name);
  if (entry) {
    if (is.defined(version)) {
      version = version.toString();
      var desc = entry.get(version);
      if (desc)
        return desc;
      throw new Error("Workflow " + name + " " + version + " has not been registered.");
    } else {
      var maxV = -10000000;
      var desc = null;
      entry.forEachValue(function(d) {
        if (d.version > maxV)
          desc = d;
      });
      if (desc)
        return desc;
      throw new Error("Workflow " + name + " has not been registered.");
    }
  }
};
WorkflowRegistry.prototype._createDesc = function(workflow, name, version) {
  return {
    workflow: workflow,
    name: name,
    version: version,
    methods: this._collectMethodInfos(workflow)
  };
};
WorkflowRegistry.prototype._collectMethodInfos = function(workflow) {
  var self = this;
  var infos = new StrMap();
  workflow.forEachChild(function(child) {
    var isBM = child instanceof BeginMethod;
    var isEM = child instanceof EndMethod;
    if (isBM || isEM) {
      var methodName = _(child.methodName).isString() ? child.methodName.trim() : null;
      var instanceIdPath = _(child.instanceIdPath).isString() ? child.instanceIdPath.trim() : null;
      if (methodName) {
        var info = infos.get(methodName);
        if (!info) {
          info = {
            workflow: workflow,
            canCreateInstance: false,
            instanceIdPath: null
          };
          infos.add(methodName, info);
        }
        if (isBM && child.canCreateInstance)
          info.canCreateInstance = true;
        if (instanceIdPath) {
          if (info.instanceIdPath) {
            if (info.instanceIdPath !== instanceIdPath)
              throw new Error("Method '" + methodName + "' in workflow '" + workflow.name + "' has multiple different instanceIdPath value which is not supported.");
          } else {
            info.instanceIdPath = instanceIdPath;
          }
        }
      }
    }
  });
  var result = new StrMap();
  infos.forEach(function(kvp) {
    if (kvp.value.instanceIdPath)
      result.add(kvp.key, kvp.value);
  });
  return result;
};
WorkflowRegistry.prototype.forEachMethodInfo = function(workflowName, methodName, f) {
  var entry = this._workflows.get(workflowName);
  if (entry) {
    entry.forEachValue(function(desc) {
      var info = desc.methods.get(methodName);
      if (info)
        f(info);
    });
  }
};
module.exports = WorkflowRegistry;
//# sourceMappingURL=data:application/json;base64,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LEFBQUMsQ0FBQyxTQUFVLElBQUcsQ0FBRztBQUMvQixBQUFJLFFBQUEsQ0FBQSxJQUFHLEVBQUksQ0FBQSxJQUFHLFFBQVEsSUFBSSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDdkMsU0FBSSxJQUFHO0FBQUcsUUFBQSxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFBQSxJQUNyQixDQUFDLENBQUM7RUFDTjtBQUFBLEFBQ0osQ0FBQTtBQUVBLEtBQUssUUFBUSxFQUFJLGlCQUFlLENBQUM7QUFDakMiLCJmaWxlIjoiaG9zdGluZy93b3JrZmxvd1JlZ2lzdHJ5LmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgV29ya2Zsb3cgPSByZXF1aXJlKFwiLi4vYWN0aXZpdGllcy93b3JrZmxvd1wiKTtcclxudmFyIF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG52YXIgQmVnaW5NZXRob2QgPSByZXF1aXJlKFwiLi4vYWN0aXZpdGllcy9iZWdpbk1ldGhvZFwiKTtcclxudmFyIEVuZE1ldGhvZCA9IHJlcXVpcmUoXCIuLi9hY3Rpdml0aWVzL2VuZE1ldGhvZFwiKTtcclxudmFyIGlzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9pc1wiKTtcclxudmFyIFN0ck1hcCA9IHJlcXVpcmUoXCJiYWNrcGFjay1ub2RlXCIpLmNvbGxlY3Rpb25zLlN0ck1hcDtcclxuXHJcbmZ1bmN0aW9uIFdvcmtmbG93UmVnaXN0cnkoKSB7XHJcbiAgICB0aGlzLl93b3JrZmxvd3MgPSBuZXcgU3RyTWFwKCk7XHJcbn1cclxuXHJcbldvcmtmbG93UmVnaXN0cnkucHJvdG90eXBlLnJlZ2lzdGVyID0gZnVuY3Rpb24gKHdvcmtmbG93KSB7XHJcbiAgICBpZiAod29ya2Zsb3cgaW5zdGFuY2VvZiBXb3JrZmxvdykge1xyXG4gICAgICAgIGlmICghXyh3b3JrZmxvdy5uYW1lKS5pc1N0cmluZygpKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiV29ya2Zsb3cgbmFtZSBpcyBub3QgYSBzdHJpbmcuXCIpO1xyXG4gICAgICAgIHZhciBuYW1lID0gd29ya2Zsb3cubmFtZS50cmltKCk7XHJcbiAgICAgICAgaWYgKCFuYW1lKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiV29ya2Zsb3cgbmFtZSBpcyBlbXB0eS5cIik7XHJcbiAgICAgICAgaWYgKCFfKHdvcmtmbG93LnZlcnNpb24pLmlzTnVtYmVyKCkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJXb3JrZmxvdyB2ZXJzaW9uIGlzIG5vdCBhIG51bWJlci5cIik7XHJcbiAgICAgICAgdmFyIHZlcnNpb24gPSB3b3JrZmxvdy52ZXJzaW9uLnRvU3RyaW5nKCk7XHJcblxyXG4gICAgICAgIHZhciBlbnRyeSA9IHRoaXMuX3dvcmtmbG93cy5nZXQobmFtZSk7XHJcbiAgICAgICAgaWYgKGVudHJ5KSB7XHJcbiAgICAgICAgICAgIHZhciBkZXNjID0gZW50cnkuZ2V0KHZlcnNpb24pO1xyXG4gICAgICAgICAgICBpZiAoZGVzYykge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV29ya2Zsb3cgXCIgKyBuYW1lICsgXCIgXCIgKyB2ZXJzaW9uICsgXCIgYWxyZWFkeSByZWdpc3RlcmVkLlwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGVudHJ5LmFkZCh2ZXJzaW9uLCB0aGlzLl9jcmVhdGVEZXNjKHdvcmtmbG93LCBuYW1lLCB3b3JrZmxvdy52ZXJzaW9uKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGVudHJ5ID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgICAgICAgICBlbnRyeS5hZGQodmVyc2lvbiwgdGhpcy5fY3JlYXRlRGVzYyh3b3JrZmxvdywgbmFtZSwgd29ya2Zsb3cudmVyc2lvbikpO1xyXG4gICAgICAgICAgICB0aGlzLl93b3JrZmxvd3MuYWRkKG5hbWUsIGVudHJ5KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICB0aHJvdyAgbmV3IFR5cGVFcnJvcihcIldvcmtmbG93IGluc3RhbmNlIGFyZ3VtZW50IGV4cGVjdGVkLlwiKTtcclxuICAgIH1cclxufVxyXG5cclxuV29ya2Zsb3dSZWdpc3RyeS5wcm90b3R5cGUuZ2V0RGVzYyA9IGZ1bmN0aW9uIChuYW1lLCB2ZXJzaW9uKSB7XHJcbiAgICB2YXIgZW50cnkgPSB0aGlzLl93b3JrZmxvd3MuZ2V0KG5hbWUpO1xyXG4gICAgaWYgKGVudHJ5KSB7XHJcbiAgICAgICAgaWYgKGlzLmRlZmluZWQodmVyc2lvbikpIHtcclxuICAgICAgICAgICAgdmVyc2lvbiA9IHZlcnNpb24udG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgdmFyIGRlc2MgPSBlbnRyeS5nZXQodmVyc2lvbik7XHJcbiAgICAgICAgICAgIGlmIChkZXNjKSByZXR1cm4gZGVzYztcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV29ya2Zsb3cgXCIgKyBuYW1lICsgXCIgXCIgKyB2ZXJzaW9uICsgXCIgaGFzIG5vdCBiZWVuIHJlZ2lzdGVyZWQuXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgLy8gR2V0IHRvcCB2ZXJzaW9uXHJcbiAgICAgICAgICAgIHZhciBtYXhWID0gLTEwMDAwMDAwO1xyXG4gICAgICAgICAgICB2YXIgZGVzYyA9IG51bGw7XHJcbiAgICAgICAgICAgIGVudHJ5LmZvckVhY2hWYWx1ZShmdW5jdGlvbiAoZCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGQudmVyc2lvbiA+IG1heFYpIGRlc2MgPSBkO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgaWYgKGRlc2MpIHJldHVybiBkZXNjO1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJXb3JrZmxvdyBcIiArIG5hbWUgKyBcIiBoYXMgbm90IGJlZW4gcmVnaXN0ZXJlZC5cIik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuV29ya2Zsb3dSZWdpc3RyeS5wcm90b3R5cGUuX2NyZWF0ZURlc2MgPSBmdW5jdGlvbiAod29ya2Zsb3csIG5hbWUsIHZlcnNpb24pIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgd29ya2Zsb3c6IHdvcmtmbG93LFxyXG4gICAgICAgIG5hbWU6IG5hbWUsXHJcbiAgICAgICAgdmVyc2lvbjogdmVyc2lvbixcclxuICAgICAgICBtZXRob2RzOiB0aGlzLl9jb2xsZWN0TWV0aG9kSW5mb3Mod29ya2Zsb3cpXHJcbiAgICB9XHJcbn1cclxuXHJcbldvcmtmbG93UmVnaXN0cnkucHJvdG90eXBlLl9jb2xsZWN0TWV0aG9kSW5mb3MgPSBmdW5jdGlvbiAod29ya2Zsb3cpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHZhciBpbmZvcyA9IG5ldyBTdHJNYXAoKTtcclxuICAgIHdvcmtmbG93LmZvckVhY2hDaGlsZChmdW5jdGlvbiAoY2hpbGQpIHtcclxuICAgICAgICB2YXIgaXNCTSA9IGNoaWxkIGluc3RhbmNlb2YgQmVnaW5NZXRob2Q7XHJcbiAgICAgICAgdmFyIGlzRU0gPSBjaGlsZCBpbnN0YW5jZW9mIEVuZE1ldGhvZDtcclxuICAgICAgICBpZiAoaXNCTSB8fCBpc0VNKSB7XHJcbiAgICAgICAgICAgIHZhciBtZXRob2ROYW1lID0gXyhjaGlsZC5tZXRob2ROYW1lKS5pc1N0cmluZygpID8gY2hpbGQubWV0aG9kTmFtZS50cmltKCkgOiBudWxsO1xyXG4gICAgICAgICAgICB2YXIgaW5zdGFuY2VJZFBhdGggPSBfKGNoaWxkLmluc3RhbmNlSWRQYXRoKS5pc1N0cmluZygpID8gY2hpbGQuaW5zdGFuY2VJZFBhdGgudHJpbSgpIDogbnVsbDtcclxuICAgICAgICAgICAgaWYgKG1ldGhvZE5hbWUpIHtcclxuICAgICAgICAgICAgICAgIHZhciBpbmZvID0gaW5mb3MuZ2V0KG1ldGhvZE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFpbmZvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaW5mbyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3c6IHdvcmtmbG93LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW5DcmVhdGVJbnN0YW5jZTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWRQYXRoOiBudWxsXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICBpbmZvcy5hZGQobWV0aG9kTmFtZSwgaW5mbyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNCTSAmJiBjaGlsZC5jYW5DcmVhdGVJbnN0YW5jZSkgaW5mby5jYW5DcmVhdGVJbnN0YW5jZSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2VJZFBhdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaW5mby5pbnN0YW5jZUlkUGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5mby5pbnN0YW5jZUlkUGF0aCAhPT0gaW5zdGFuY2VJZFBhdGgpIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCAnXCIgKyBtZXRob2ROYW1lICsgXCInIGluIHdvcmtmbG93ICdcIiArIHdvcmtmbG93Lm5hbWUgKyBcIicgaGFzIG11bHRpcGxlIGRpZmZlcmVudCBpbnN0YW5jZUlkUGF0aCB2YWx1ZSB3aGljaCBpcyBub3Qgc3VwcG9ydGVkLlwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZm8uaW5zdGFuY2VJZFBhdGggPSBpbnN0YW5jZUlkUGF0aDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHZhciByZXN1bHQgPSBuZXcgU3RyTWFwKCk7XHJcbiAgICBpbmZvcy5mb3JFYWNoKGZ1bmN0aW9uIChrdnApIHtcclxuICAgICAgICBpZiAoa3ZwLnZhbHVlLmluc3RhbmNlSWRQYXRoKSByZXN1bHQuYWRkKGt2cC5rZXksIGt2cC52YWx1ZSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbn1cclxuXHJcbldvcmtmbG93UmVnaXN0cnkucHJvdG90eXBlLmZvckVhY2hNZXRob2RJbmZvID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgbWV0aG9kTmFtZSwgZikge1xyXG4gICAgdmFyIGVudHJ5ID0gdGhpcy5fd29ya2Zsb3dzLmdldCh3b3JrZmxvd05hbWUpO1xyXG4gICAgaWYgKGVudHJ5KSB7XHJcbiAgICAgICAgZW50cnkuZm9yRWFjaFZhbHVlKGZ1bmN0aW9uIChkZXNjKSB7XHJcbiAgICAgICAgICAgIHZhciBpbmZvID0gZGVzYy5tZXRob2RzLmdldChtZXRob2ROYW1lKTtcclxuICAgICAgICAgICAgaWYgKGluZm8pIGYoaW5mbyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0gV29ya2Zsb3dSZWdpc3RyeTtcclxuIl19
