"use strict";
var Workflow = require("../activities/workflow");
var _ = require("lodash");
var BeginMethod = require("../activities/beginMethod");
var EndMethod = require("../activities/endMethod");
var is = require("../common/is");
var ActivityExecutionContext = require("../activities/activityExecutionContext");
function WorkflowRegistry() {
  this._workflows = new Map();
}
WorkflowRegistry.prototype.register = function(workflow) {
  if (workflow instanceof Workflow) {
    if (!_(workflow.name).isString()) {
      throw new TypeError("Workflow name is not a string.");
    }
    var name = workflow.name.trim();
    if (!name) {
      throw new TypeError("Workflow name is empty.");
    }
    if (!_(workflow.version).isNumber()) {
      throw new TypeError("Workflow version is not a number.");
    }
    var version = workflow.version.toString();
    var entry = this._workflows.get(name);
    if (entry) {
      var desc = entry.get(version);
      if (desc) {
        throw new Error("Workflow " + name + " " + version + " already registered.");
      } else {
        entry.set(version, this._createDesc(workflow, name, workflow.version));
      }
    } else {
      entry = new Map();
      entry.set(version, this._createDesc(workflow, name, workflow.version));
      this._workflows.set(name, entry);
    }
  } else {
    throw new TypeError("Workflow instance argument expected.");
  }
};
WorkflowRegistry.prototype.getDesc = function(name, version) {
  var entry = this._workflows.get(name);
  if (entry) {
    if (!_.isUndefined(version)) {
      version = version.toString();
      var desc = entry.get(version);
      if (desc) {
        return desc;
      }
      throw new Error("Workflow " + name + " " + version + " has not been registered.");
    } else {
      var maxV = -10000000;
      var desc$__15 = null;
      var $__4 = true;
      var $__5 = false;
      var $__6 = undefined;
      try {
        for (var $__2 = void 0,
            $__1 = (entry.values())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__4 = ($__2 = $__1.next()).done); $__4 = true) {
          var d = $__2.value;
          {
            if (d.version > maxV) {
              desc$__15 = d;
              break;
            }
          }
        }
      } catch ($__7) {
        $__5 = true;
        $__6 = $__7;
      } finally {
        try {
          if (!$__4 && $__1.return != null) {
            $__1.return();
          }
        } finally {
          if ($__5) {
            throw $__6;
          }
        }
      }
      if (desc$__15) {
        return desc$__15;
      }
      throw new Error("Workflow " + name + " has not been registered.");
    }
  }
};
WorkflowRegistry.prototype._createDesc = function(workflow, name, version) {
  return {
    workflow: workflow,
    name: name,
    version: version,
    methods: this._collectMethodInfos(workflow)
  };
};
WorkflowRegistry.prototype._collectMethodInfos = function(workflow) {
  var self = this;
  var infos = new Map();
  var execContext = new ActivityExecutionContext();
  execContext.initialize(workflow);
  var $__4 = true;
  var $__5 = false;
  var $__6 = undefined;
  try {
    for (var $__2 = void 0,
        $__1 = (workflow.children(execContext))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__4 = ($__2 = $__1.next()).done); $__4 = true) {
      var child = $__2.value;
      {
        var isBM = child instanceof BeginMethod;
        var isEM = child instanceof EndMethod;
        if (isBM || isEM) {
          var methodName = _.isString(child.methodName) ? child.methodName.trim() : null;
          var instanceIdPath = _.isString(child.instanceIdPath) ? child.instanceIdPath.trim() : null;
          if (methodName) {
            var info = infos.get(methodName);
            if (!info) {
              info = {
                workflow: workflow,
                canCreateInstance: false,
                instanceIdPath: null
              };
              infos.set(methodName, info);
            }
            if (isBM && child.canCreateInstance) {
              info.canCreateInstance = true;
            }
            if (instanceIdPath) {
              if (info.instanceIdPath) {
                if (info.instanceIdPath !== instanceIdPath) {
                  throw new Error("Method '" + methodName + "' in workflow '" + workflow.name + "' has multiple different instanceIdPath value which is not supported.");
                }
              } else {
                info.instanceIdPath = instanceIdPath;
              }
            }
          }
        }
      }
    }
  } catch ($__7) {
    $__5 = true;
    $__6 = $__7;
  } finally {
    try {
      if (!$__4 && $__1.return != null) {
        $__1.return();
      }
    } finally {
      if ($__5) {
        throw $__6;
      }
    }
  }
  var result = new Map();
  var $__11 = true;
  var $__12 = false;
  var $__13 = undefined;
  try {
    for (var $__9 = void 0,
        $__8 = (infos.entries())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__11 = ($__9 = $__8.next()).done); $__11 = true) {
      var kvp = $__9.value;
      {
        if (kvp[1].instanceIdPath) {
          result.set(kvp[0], kvp[1]);
        }
      }
    }
  } catch ($__14) {
    $__12 = true;
    $__13 = $__14;
  } finally {
    try {
      if (!$__11 && $__8.return != null) {
        $__8.return();
      }
    } finally {
      if ($__12) {
        throw $__13;
      }
    }
  }
  return result;
};
WorkflowRegistry.prototype.methodInfos = $traceurRuntime.initGeneratorFunction(function $__16(workflowName, methodName) {
  var entry,
      $__4,
      $__5,
      $__6,
      $__2,
      $__1,
      desc,
      info,
      $__7;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          entry = this._workflows.get(workflowName);
          $ctx.state = 30;
          break;
        case 30:
          $ctx.state = (entry) ? 26 : -2;
          break;
        case 26:
          $__4 = true;
          $__5 = false;
          $__6 = undefined;
          $ctx.state = 27;
          break;
        case 27:
          $ctx.pushTry(13, 14);
          $ctx.state = 16;
          break;
        case 16:
          $__2 = void 0, $__1 = (entry.values())[$traceurRuntime.toProperty(Symbol.iterator)]();
          $ctx.state = 12;
          break;
        case 12:
          $ctx.state = (!($__4 = ($__2 = $__1.next()).done)) ? 8 : 10;
          break;
        case 4:
          $__4 = true;
          $ctx.state = 12;
          break;
        case 8:
          desc = $__2.value;
          $ctx.state = 9;
          break;
        case 9:
          info = desc.methods.get(methodName);
          $ctx.state = 7;
          break;
        case 7:
          $ctx.state = (info) ? 1 : 4;
          break;
        case 1:
          $ctx.state = 2;
          return info;
        case 2:
          $ctx.maybeThrow();
          $ctx.state = 4;
          break;
        case 10:
          $ctx.popTry();
          $ctx.state = 14;
          $ctx.finallyFallThrough = -2;
          break;
        case 13:
          $ctx.popTry();
          $ctx.maybeUncatchable();
          $__7 = $ctx.storedException;
          $ctx.state = 19;
          break;
        case 19:
          $__5 = true;
          $__6 = $__7;
          $ctx.state = 14;
          $ctx.finallyFallThrough = -2;
          break;
        case 14:
          $ctx.popTry();
          $ctx.state = 25;
          break;
        case 25:
          try {
            if (!$__4 && $__1.return != null) {
              $__1.return();
            }
          } finally {
            if ($__5) {
              throw $__6;
            }
          }
          $ctx.state = 23;
          break;
        case 23:
          $ctx.state = $ctx.finallyFallThrough;
          break;
        default:
          return $ctx.end();
      }
  }, $__16, this);
});
module.exports = WorkflowRegistry;
//# sourceMappingURL=data:application/json;base64,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QkFBbUIsS0FBb0IsQ0FBQTs7O0FBQTFDLGFBQUcsT0FBTyxBQUFDLEVBQUMsQ0FBQzs7OztBQVVILFlBQUk7QUFDRixlQUFJLEtBQWlCLEdBQUssQ0FBQSxXQUF1QixHQUFLLEtBQUcsQ0FBRztBQUMxRCx3QkFBd0IsQUFBQyxFQUFDLENBQUM7WUFDN0I7QUFBQSxVQUNGLENBQUUsT0FBUTtBQUNSLG9CQUF3QjtBQUN0Qix3QkFBd0I7WUFDMUI7QUFBQSxVQUNGO0FBQUE7OztBQWpCWSxhQUFHLE1BQU0sRUFBSSxDQUFBLElBQUcsbUJBQW1CLENBQUM7QUFDcEMsZUFBSzs7QUFGM0IsZUFBTyxDQUFBLElBQUcsSUFBSSxBQUFDLEVBQUMsQ0FBQTs7QUFDbUIsRUFDL0IsUUFBNkIsS0FBRyxDQUFDLENBQUM7QUE2SXRDLENBL0l1RCxBQStJdkQsQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLGlCQUFlLENBQUM7QUFDakMiLCJmaWxlIjoiaG9zdGluZy93b3JrZmxvd1JlZ2lzdHJ5LmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IFdvcmtmbG93ID0gcmVxdWlyZShcIi4uL2FjdGl2aXRpZXMvd29ya2Zsb3dcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgQmVnaW5NZXRob2QgPSByZXF1aXJlKFwiLi4vYWN0aXZpdGllcy9iZWdpbk1ldGhvZFwiKTtcbmxldCBFbmRNZXRob2QgPSByZXF1aXJlKFwiLi4vYWN0aXZpdGllcy9lbmRNZXRob2RcIik7XG5sZXQgaXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2lzXCIpO1xubGV0IEFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dCA9IHJlcXVpcmUoXCIuLi9hY3Rpdml0aWVzL2FjdGl2aXR5RXhlY3V0aW9uQ29udGV4dFwiKTtcblxuZnVuY3Rpb24gV29ya2Zsb3dSZWdpc3RyeSgpIHtcbiAgICB0aGlzLl93b3JrZmxvd3MgPSBuZXcgTWFwKCk7XG59XG5cbldvcmtmbG93UmVnaXN0cnkucHJvdG90eXBlLnJlZ2lzdGVyID0gZnVuY3Rpb24gKHdvcmtmbG93KSB7XG4gICAgaWYgKHdvcmtmbG93IGluc3RhbmNlb2YgV29ya2Zsb3cpIHtcbiAgICAgICAgaWYgKCFfKHdvcmtmbG93Lm5hbWUpLmlzU3RyaW5nKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJXb3JrZmxvdyBuYW1lIGlzIG5vdCBhIHN0cmluZy5cIik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IG5hbWUgPSB3b3JrZmxvdy5uYW1lLnRyaW0oKTtcbiAgICAgICAgaWYgKCFuYW1lKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiV29ya2Zsb3cgbmFtZSBpcyBlbXB0eS5cIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFfKHdvcmtmbG93LnZlcnNpb24pLmlzTnVtYmVyKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJXb3JrZmxvdyB2ZXJzaW9uIGlzIG5vdCBhIG51bWJlci5cIik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHZlcnNpb24gPSB3b3JrZmxvdy52ZXJzaW9uLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgbGV0IGVudHJ5ID0gdGhpcy5fd29ya2Zsb3dzLmdldChuYW1lKTtcbiAgICAgICAgaWYgKGVudHJ5KSB7XG4gICAgICAgICAgICBsZXQgZGVzYyA9IGVudHJ5LmdldCh2ZXJzaW9uKTtcbiAgICAgICAgICAgIGlmIChkZXNjKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV29ya2Zsb3cgXCIgKyBuYW1lICsgXCIgXCIgKyB2ZXJzaW9uICsgXCIgYWxyZWFkeSByZWdpc3RlcmVkLlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGVudHJ5LnNldCh2ZXJzaW9uLCB0aGlzLl9jcmVhdGVEZXNjKHdvcmtmbG93LCBuYW1lLCB3b3JrZmxvdy52ZXJzaW9uKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBlbnRyeSA9IG5ldyBNYXAoKTtcbiAgICAgICAgICAgIGVudHJ5LnNldCh2ZXJzaW9uLCB0aGlzLl9jcmVhdGVEZXNjKHdvcmtmbG93LCBuYW1lLCB3b3JrZmxvdy52ZXJzaW9uKSk7XG4gICAgICAgICAgICB0aGlzLl93b3JrZmxvd3Muc2V0KG5hbWUsIGVudHJ5KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIldvcmtmbG93IGluc3RhbmNlIGFyZ3VtZW50IGV4cGVjdGVkLlwiKTtcbiAgICB9XG59O1xuXG5Xb3JrZmxvd1JlZ2lzdHJ5LnByb3RvdHlwZS5nZXREZXNjID0gZnVuY3Rpb24gKG5hbWUsIHZlcnNpb24pIHtcbiAgICBsZXQgZW50cnkgPSB0aGlzLl93b3JrZmxvd3MuZ2V0KG5hbWUpO1xuICAgIGlmIChlbnRyeSkge1xuICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQodmVyc2lvbikpIHtcbiAgICAgICAgICAgIHZlcnNpb24gPSB2ZXJzaW9uLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICBsZXQgZGVzYyA9IGVudHJ5LmdldCh2ZXJzaW9uKTtcbiAgICAgICAgICAgIGlmIChkZXNjKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRlc2M7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJXb3JrZmxvdyBcIiArIG5hbWUgKyBcIiBcIiArIHZlcnNpb24gKyBcIiBoYXMgbm90IGJlZW4gcmVnaXN0ZXJlZC5cIik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBHZXQgdG9wIHZlcnNpb25cbiAgICAgICAgICAgIGxldCBtYXhWID0gLTEwMDAwMDAwO1xuICAgICAgICAgICAgbGV0IGRlc2MgPSBudWxsO1xuICAgICAgICAgICAgZm9yIChsZXQgZCBvZiBlbnRyeS52YWx1ZXMoKSkge1xuICAgICAgICAgICAgICAgIGlmIChkLnZlcnNpb24gPiBtYXhWKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlc2MgPSBkO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGVzYykge1xuICAgICAgICAgICAgICAgIHJldHVybiBkZXNjO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV29ya2Zsb3cgXCIgKyBuYW1lICsgXCIgaGFzIG5vdCBiZWVuIHJlZ2lzdGVyZWQuXCIpO1xuICAgICAgICB9XG4gICAgfVxuXG59O1xuXG5Xb3JrZmxvd1JlZ2lzdHJ5LnByb3RvdHlwZS5fY3JlYXRlRGVzYyA9IGZ1bmN0aW9uICh3b3JrZmxvdywgbmFtZSwgdmVyc2lvbikge1xuICAgIHJldHVybiB7XG4gICAgICAgIHdvcmtmbG93OiB3b3JrZmxvdyxcbiAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgdmVyc2lvbjogdmVyc2lvbixcbiAgICAgICAgbWV0aG9kczogdGhpcy5fY29sbGVjdE1ldGhvZEluZm9zKHdvcmtmbG93KVxuICAgIH07XG59O1xuXG5Xb3JrZmxvd1JlZ2lzdHJ5LnByb3RvdHlwZS5fY29sbGVjdE1ldGhvZEluZm9zID0gZnVuY3Rpb24gKHdvcmtmbG93KSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIGxldCBpbmZvcyA9IG5ldyBNYXAoKTtcbiAgICBsZXQgZXhlY0NvbnRleHQgPSBuZXcgQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0KCk7XG4gICAgZXhlY0NvbnRleHQuaW5pdGlhbGl6ZSh3b3JrZmxvdyk7XG4gICAgZm9yIChsZXQgY2hpbGQgb2Ygd29ya2Zsb3cuY2hpbGRyZW4oZXhlY0NvbnRleHQpKSB7XG4gICAgICAgIGxldCBpc0JNID0gY2hpbGQgaW5zdGFuY2VvZiBCZWdpbk1ldGhvZDtcbiAgICAgICAgbGV0IGlzRU0gPSBjaGlsZCBpbnN0YW5jZW9mIEVuZE1ldGhvZDtcbiAgICAgICAgaWYgKGlzQk0gfHwgaXNFTSkge1xuICAgICAgICAgICAgbGV0IG1ldGhvZE5hbWUgPSBfLmlzU3RyaW5nKGNoaWxkLm1ldGhvZE5hbWUpID8gY2hpbGQubWV0aG9kTmFtZS50cmltKCkgOiBudWxsO1xuICAgICAgICAgICAgbGV0IGluc3RhbmNlSWRQYXRoID0gXy5pc1N0cmluZyhjaGlsZC5pbnN0YW5jZUlkUGF0aCkgPyBjaGlsZC5pbnN0YW5jZUlkUGF0aC50cmltKCkgOiBudWxsO1xuICAgICAgICAgICAgaWYgKG1ldGhvZE5hbWUpIHtcbiAgICAgICAgICAgICAgICBsZXQgaW5mbyA9IGluZm9zLmdldChtZXRob2ROYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgaW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93OiB3b3JrZmxvdyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbkNyZWF0ZUluc3RhbmNlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWRQYXRoOiBudWxsXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGluZm9zLnNldChtZXRob2ROYW1lLCBpbmZvKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGlzQk0gJiYgY2hpbGQuY2FuQ3JlYXRlSW5zdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5mby5jYW5DcmVhdGVJbnN0YW5jZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZUlkUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5mby5pbnN0YW5jZUlkUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZm8uaW5zdGFuY2VJZFBhdGggIT09IGluc3RhbmNlSWRQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kICdcIiArIG1ldGhvZE5hbWUgKyBcIicgaW4gd29ya2Zsb3cgJ1wiICsgd29ya2Zsb3cubmFtZSArIFwiJyBoYXMgbXVsdGlwbGUgZGlmZmVyZW50IGluc3RhbmNlSWRQYXRoIHZhbHVlIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQuXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5mby5pbnN0YW5jZUlkUGF0aCA9IGluc3RhbmNlSWRQYXRoO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGxldCByZXN1bHQgPSBuZXcgTWFwKCk7XG4gICAgZm9yIChsZXQga3ZwIG9mIGluZm9zLmVudHJpZXMoKSkge1xuICAgICAgICBpZiAoa3ZwWzFdLmluc3RhbmNlSWRQYXRoKSB7XG4gICAgICAgICAgICByZXN1bHQuc2V0KGt2cFswXSwga3ZwWzFdKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufTtcblxuV29ya2Zsb3dSZWdpc3RyeS5wcm90b3R5cGUubWV0aG9kSW5mb3MgPSBmdW5jdGlvbiogKHdvcmtmbG93TmFtZSwgbWV0aG9kTmFtZSkge1xuICAgIGxldCBlbnRyeSA9IHRoaXMuX3dvcmtmbG93cy5nZXQod29ya2Zsb3dOYW1lKTtcbiAgICBpZiAoZW50cnkpIHtcbiAgICAgICAgZm9yIChsZXQgZGVzYyBvZiBlbnRyeS52YWx1ZXMoKSkge1xuICAgICAgICAgICAgbGV0IGluZm8gPSBkZXNjLm1ldGhvZHMuZ2V0KG1ldGhvZE5hbWUpO1xuICAgICAgICAgICAgaWYgKGluZm8pIHtcbiAgICAgICAgICAgICAgICB5aWVsZCBpbmZvO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBXb3JrZmxvd1JlZ2lzdHJ5O1xuIl19
