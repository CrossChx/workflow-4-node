"use strict";
var Workflow = require("../activities/workflow");
var _ = require("lodash");
var BeginMethod = require("../activities/beginMethod");
var EndMethod = require("../activities/endMethod");
var is = require("../common/is");
var StrMap = require("backpack-node").collections.StrMap;
function WorkflowRegistry() {
  this._workflows = new StrMap();
}
WorkflowRegistry.prototype.register = function(workflow) {
  if (workflow instanceof Workflow) {
    if (!_(workflow.name).isString())
      throw new TypeError("Workflow name is not a string.");
    var name = workflow.name.trim();
    if (!name)
      throw new TypeError("Workflow name is empty.");
    if (!_(workflow.version).isNumber())
      throw new TypeError("Workflow version is not a number.");
    var version = workflow.version.toString();
    var entry = this._workflows.get(name);
    if (entry) {
      var desc = entry.get(version);
      if (desc) {
        throw new Error("Workflow " + name + " " + version + " already registered.");
      } else {
        entry.add(version, this._createDesc(workflow, name, workflow.version));
      }
    } else {
      entry = new StrMap();
      entry.add(version, this._createDesc(workflow, name, workflow.version));
      this._workflows.add(name, entry);
    }
  } else {
    throw new TypeError("Workflow instance argument expected.");
  }
};
WorkflowRegistry.prototype.getDesc = function(name, version) {
  var entry = this._workflows.get(name);
  if (entry) {
    if (is.defined(version)) {
      version = version.toString();
      var desc = entry.get(version);
      if (desc)
        return desc;
      throw new Error("Workflow " + name + " " + version + " has not been registered.");
    } else {
      var maxV = -10000000;
      var desc = null;
      entry.forEachValue(function(d) {
        if (d.version > maxV)
          desc = d;
      });
      if (desc)
        return desc;
      throw new Error("Workflow " + name + " has not been registered.");
    }
  }
};
WorkflowRegistry.prototype._createDesc = function(workflow, name, version) {
  return {
    workflow: workflow,
    name: name,
    version: version,
    methods: this._collectMethodInfos(workflow)
  };
};
WorkflowRegistry.prototype._collectMethodInfos = function(workflow) {
  var self = this;
  var infos = new StrMap();
  workflow.forEachChild(function(child) {
    var isBM = child instanceof BeginMethod;
    var isEM = child instanceof EndMethod;
    if (isBM || isEM) {
      var methodName = _(child.methodName).isString() ? child.methodName.trim() : null;
      var instanceIdPath = _(child.instanceIdPath).isString() ? child.instanceIdPath.trim() : null;
      if (methodName) {
        var info = infos.get(methodName);
        if (!info) {
          info = {
            workflow: workflow,
            canCreateInstance: false,
            instanceIdPath: null
          };
          infos.add(methodName, info);
        }
        if (isBM && child.canCreateInstance)
          info.canCreateInstance = true;
        if (instanceIdPath) {
          if (info.instanceIdPath) {
            if (info.instanceIdPath !== instanceIdPath)
              throw new Error("Method '" + methodName + "' in workflow '" + workflow.name + "' has multiple different instanceIdPath value which is not supported.");
          } else {
            info.instanceIdPath = instanceIdPath;
          }
        }
      }
    }
  });
  var result = new StrMap();
  infos.forEach(function(kvp) {
    if (kvp.value.instanceIdPath)
      result.add(kvp.key, kvp.value);
  });
  return result;
};
WorkflowRegistry.prototype.forEachMethodInfo = function(workflowName, methodName, f) {
  var entry = this._workflows.get(workflowName);
  if (entry) {
    entry.forEachValue(function(desc) {
      var info = desc.methods.get(methodName);
      if (info)
        f(info);
    });
  }
};
module.exports = WorkflowRegistry;
//# sourceMappingURL=data:application/json;base64,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LEFBQUMsQ0FBQyxTQUFVLElBQUcsQ0FBRztBQUMvQixBQUFJLFFBQUEsQ0FBQSxJQUFHLEVBQUksQ0FBQSxJQUFHLFFBQVEsSUFBSSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDdkMsU0FBSSxJQUFHO0FBQUcsUUFBQSxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFBQSxJQUNyQixDQUFDLENBQUM7RUFDTjtBQUFBLEFBQ0osQ0FBQTtBQUVBLEtBQUssUUFBUSxFQUFJLGlCQUFlLENBQUM7QUFDakMiLCJmaWxlIjoiaG9zdGluZy93b3JrZmxvd1JlZ2lzdHJ5LmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgV29ya2Zsb3cgPSByZXF1aXJlKFwiLi4vYWN0aXZpdGllcy93b3JrZmxvd1wiKTtcbnZhciBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbnZhciBCZWdpbk1ldGhvZCA9IHJlcXVpcmUoXCIuLi9hY3Rpdml0aWVzL2JlZ2luTWV0aG9kXCIpO1xudmFyIEVuZE1ldGhvZCA9IHJlcXVpcmUoXCIuLi9hY3Rpdml0aWVzL2VuZE1ldGhvZFwiKTtcbnZhciBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XG52YXIgU3RyTWFwID0gcmVxdWlyZShcImJhY2twYWNrLW5vZGVcIikuY29sbGVjdGlvbnMuU3RyTWFwO1xuXG5mdW5jdGlvbiBXb3JrZmxvd1JlZ2lzdHJ5KCkge1xuICAgIHRoaXMuX3dvcmtmbG93cyA9IG5ldyBTdHJNYXAoKTtcbn1cblxuV29ya2Zsb3dSZWdpc3RyeS5wcm90b3R5cGUucmVnaXN0ZXIgPSBmdW5jdGlvbiAod29ya2Zsb3cpIHtcbiAgICBpZiAod29ya2Zsb3cgaW5zdGFuY2VvZiBXb3JrZmxvdykge1xuICAgICAgICBpZiAoIV8od29ya2Zsb3cubmFtZSkuaXNTdHJpbmcoKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIldvcmtmbG93IG5hbWUgaXMgbm90IGEgc3RyaW5nLlwiKTtcbiAgICAgICAgdmFyIG5hbWUgPSB3b3JrZmxvdy5uYW1lLnRyaW0oKTtcbiAgICAgICAgaWYgKCFuYW1lKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiV29ya2Zsb3cgbmFtZSBpcyBlbXB0eS5cIik7XG4gICAgICAgIGlmICghXyh3b3JrZmxvdy52ZXJzaW9uKS5pc051bWJlcigpKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiV29ya2Zsb3cgdmVyc2lvbiBpcyBub3QgYSBudW1iZXIuXCIpO1xuICAgICAgICB2YXIgdmVyc2lvbiA9IHdvcmtmbG93LnZlcnNpb24udG9TdHJpbmcoKTtcblxuICAgICAgICB2YXIgZW50cnkgPSB0aGlzLl93b3JrZmxvd3MuZ2V0KG5hbWUpO1xuICAgICAgICBpZiAoZW50cnkpIHtcbiAgICAgICAgICAgIHZhciBkZXNjID0gZW50cnkuZ2V0KHZlcnNpb24pO1xuICAgICAgICAgICAgaWYgKGRlc2MpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJXb3JrZmxvdyBcIiArIG5hbWUgKyBcIiBcIiArIHZlcnNpb24gKyBcIiBhbHJlYWR5IHJlZ2lzdGVyZWQuXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZW50cnkuYWRkKHZlcnNpb24sIHRoaXMuX2NyZWF0ZURlc2Mod29ya2Zsb3csIG5hbWUsIHdvcmtmbG93LnZlcnNpb24pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGVudHJ5ID0gbmV3IFN0ck1hcCgpO1xuICAgICAgICAgICAgZW50cnkuYWRkKHZlcnNpb24sIHRoaXMuX2NyZWF0ZURlc2Mod29ya2Zsb3csIG5hbWUsIHdvcmtmbG93LnZlcnNpb24pKTtcbiAgICAgICAgICAgIHRoaXMuX3dvcmtmbG93cy5hZGQobmFtZSwgZW50cnkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICB0aHJvdyAgbmV3IFR5cGVFcnJvcihcIldvcmtmbG93IGluc3RhbmNlIGFyZ3VtZW50IGV4cGVjdGVkLlwiKTtcbiAgICB9XG59XG5cbldvcmtmbG93UmVnaXN0cnkucHJvdG90eXBlLmdldERlc2MgPSBmdW5jdGlvbiAobmFtZSwgdmVyc2lvbikge1xuICAgIHZhciBlbnRyeSA9IHRoaXMuX3dvcmtmbG93cy5nZXQobmFtZSk7XG4gICAgaWYgKGVudHJ5KSB7XG4gICAgICAgIGlmIChpcy5kZWZpbmVkKHZlcnNpb24pKSB7XG4gICAgICAgICAgICB2ZXJzaW9uID0gdmVyc2lvbi50b1N0cmluZygpO1xuICAgICAgICAgICAgdmFyIGRlc2MgPSBlbnRyeS5nZXQodmVyc2lvbik7XG4gICAgICAgICAgICBpZiAoZGVzYykgcmV0dXJuIGRlc2M7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJXb3JrZmxvdyBcIiArIG5hbWUgKyBcIiBcIiArIHZlcnNpb24gKyBcIiBoYXMgbm90IGJlZW4gcmVnaXN0ZXJlZC5cIik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBHZXQgdG9wIHZlcnNpb25cbiAgICAgICAgICAgIHZhciBtYXhWID0gLTEwMDAwMDAwO1xuICAgICAgICAgICAgdmFyIGRlc2MgPSBudWxsO1xuICAgICAgICAgICAgZW50cnkuZm9yRWFjaFZhbHVlKGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICAgICAgaWYgKGQudmVyc2lvbiA+IG1heFYpIGRlc2MgPSBkO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoZGVzYykgcmV0dXJuIGRlc2M7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJXb3JrZmxvdyBcIiArIG5hbWUgKyBcIiBoYXMgbm90IGJlZW4gcmVnaXN0ZXJlZC5cIik7XG4gICAgICAgIH1cbiAgICB9XG5cbn1cblxuV29ya2Zsb3dSZWdpc3RyeS5wcm90b3R5cGUuX2NyZWF0ZURlc2MgPSBmdW5jdGlvbiAod29ya2Zsb3csIG5hbWUsIHZlcnNpb24pIHtcbiAgICByZXR1cm4ge1xuICAgICAgICB3b3JrZmxvdzogd29ya2Zsb3csXG4gICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgIHZlcnNpb246IHZlcnNpb24sXG4gICAgICAgIG1ldGhvZHM6IHRoaXMuX2NvbGxlY3RNZXRob2RJbmZvcyh3b3JrZmxvdylcbiAgICB9XG59XG5cbldvcmtmbG93UmVnaXN0cnkucHJvdG90eXBlLl9jb2xsZWN0TWV0aG9kSW5mb3MgPSBmdW5jdGlvbiAod29ya2Zsb3cpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIGluZm9zID0gbmV3IFN0ck1hcCgpO1xuICAgIHdvcmtmbG93LmZvckVhY2hDaGlsZChmdW5jdGlvbiAoY2hpbGQpIHtcbiAgICAgICAgdmFyIGlzQk0gPSBjaGlsZCBpbnN0YW5jZW9mIEJlZ2luTWV0aG9kO1xuICAgICAgICB2YXIgaXNFTSA9IGNoaWxkIGluc3RhbmNlb2YgRW5kTWV0aG9kO1xuICAgICAgICBpZiAoaXNCTSB8fCBpc0VNKSB7XG4gICAgICAgICAgICB2YXIgbWV0aG9kTmFtZSA9IF8oY2hpbGQubWV0aG9kTmFtZSkuaXNTdHJpbmcoKSA/IGNoaWxkLm1ldGhvZE5hbWUudHJpbSgpIDogbnVsbDtcbiAgICAgICAgICAgIHZhciBpbnN0YW5jZUlkUGF0aCA9IF8oY2hpbGQuaW5zdGFuY2VJZFBhdGgpLmlzU3RyaW5nKCkgPyBjaGlsZC5pbnN0YW5jZUlkUGF0aC50cmltKCkgOiBudWxsO1xuICAgICAgICAgICAgaWYgKG1ldGhvZE5hbWUpIHtcbiAgICAgICAgICAgICAgICB2YXIgaW5mbyA9IGluZm9zLmdldChtZXRob2ROYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgaW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93OiB3b3JrZmxvdyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbkNyZWF0ZUluc3RhbmNlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWRQYXRoOiBudWxsXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGluZm9zLmFkZChtZXRob2ROYW1lLCBpbmZvKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGlzQk0gJiYgY2hpbGQuY2FuQ3JlYXRlSW5zdGFuY2UpIGluZm8uY2FuQ3JlYXRlSW5zdGFuY2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZUlkUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5mby5pbnN0YW5jZUlkUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZm8uaW5zdGFuY2VJZFBhdGggIT09IGluc3RhbmNlSWRQYXRoKSB0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2QgJ1wiICsgbWV0aG9kTmFtZSArIFwiJyBpbiB3b3JrZmxvdyAnXCIgKyB3b3JrZmxvdy5uYW1lICsgXCInIGhhcyBtdWx0aXBsZSBkaWZmZXJlbnQgaW5zdGFuY2VJZFBhdGggdmFsdWUgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC5cIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbmZvLmluc3RhbmNlSWRQYXRoID0gaW5zdGFuY2VJZFBhdGg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICB2YXIgcmVzdWx0ID0gbmV3IFN0ck1hcCgpO1xuICAgIGluZm9zLmZvckVhY2goZnVuY3Rpb24gKGt2cCkge1xuICAgICAgICBpZiAoa3ZwLnZhbHVlLmluc3RhbmNlSWRQYXRoKSByZXN1bHQuYWRkKGt2cC5rZXksIGt2cC52YWx1ZSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cblxuV29ya2Zsb3dSZWdpc3RyeS5wcm90b3R5cGUuZm9yRWFjaE1ldGhvZEluZm8gPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBtZXRob2ROYW1lLCBmKSB7XG4gICAgdmFyIGVudHJ5ID0gdGhpcy5fd29ya2Zsb3dzLmdldCh3b3JrZmxvd05hbWUpO1xuICAgIGlmIChlbnRyeSkge1xuICAgICAgICBlbnRyeS5mb3JFYWNoVmFsdWUoZnVuY3Rpb24gKGRlc2MpIHtcbiAgICAgICAgICAgIHZhciBpbmZvID0gZGVzYy5tZXRob2RzLmdldChtZXRob2ROYW1lKTtcbiAgICAgICAgICAgIGlmIChpbmZvKSBmKGluZm8pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gV29ya2Zsb3dSZWdpc3RyeTtcbiJdfQ==
