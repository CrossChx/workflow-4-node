"use strict";
var uuid = require('node-uuid');
require('date-utils');
var specStrings = require("../common/specStrings");
var InstIdPaths = require("./instIdPaths");
var is = require("../common/is");
var _ = require("lodash");
var debug = require("debug")("wf4node:MemoryPersistence");
var errors = require("../common/errors");
function MemoryPersistence() {
  this._instanceData = new Map();
  this._locksById = new Map();
  this._locksByName = new Map();
}
MemoryPersistence.prototype.clear = function() {
  this._instanceData.clear();
  this._locksById.clear();
  this._locksByName.clear();
};
MemoryPersistence.prototype.enterLock = function(lockName, inLockTimeoutMs) {
  debug("enterLock(%s, %d)", lockName, inLockTimeoutMs);
  var now = new Date();
  debug("Searching for lock by name %s", lockName);
  var cLock = this._locksByName.get(lockName);
  debug("Lock info: %j", cLock);
  if (!cLock || cLock.heldTo.getTime() < now.getTime()) {
    var lockInfo = {
      id: uuid.v4(),
      name: lockName,
      heldTo: now.addMilliseconds(inLockTimeoutMs)
    };
    this._locksById.set(lockInfo.id, lockInfo);
    this._locksByName.set(lockInfo.name, lockInfo);
    debug("LOCKED: %s", lockInfo.name);
    return lockInfo;
  }
  debug("It is already held.");
  return null;
};
MemoryPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  debug("renewLock(%s, %d)", lockId, inLockTimeoutMs);
  var cLock = this._getLockById(lockId);
  cLock.heldTo = new Date().addMilliseconds(inLockTimeoutMs);
  debug("Lock %s extended to %s", lockId, cLock.heldTo);
};
MemoryPersistence.prototype.exitLock = function(lockId) {
  debug("exitLock(%s)", lockId);
  var cLock = this._getLockById(lockId);
  this._locksById.delete(cLock.id);
  this._locksByName.delete(cLock.name);
  debug("UNLOCKED: %s", cLock.name);
};
MemoryPersistence.prototype._getLockById = function(lockId) {
  var cLock = this._locksById.get(lockId);
  var now = new Date();
  if (!cLock || now.compareTo(cLock.heldTo) > 0) {
    throw new Error("Lock by id '" + lockId + "' doesn't exists.");
  }
  return cLock;
};
MemoryPersistence.prototype.isRunning = function(workflowName, instanceId) {
  debug("isRunning(%s, %s)", workflowName, instanceId);
  return this._instanceData.has(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
MemoryPersistence.prototype.persistState = function(state) {
  debug("persistState(%j)", state);
  state = _.clone(state);
  state.state = JSON.stringify(state.state);
  this._instanceData.set(specStrings.hosting.doubleKeys(state.workflowName, state.instanceId), state);
};
MemoryPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  debug("getRunningInstanceIdHeader(%s, %s)", workflowName, instanceId);
  var state = this._instanceData.get(specStrings.hosting.doubleKeys(workflowName, instanceId));
  if (!state) {
    return null;
  }
  return {
    updatedOn: state.updatedOn,
    workflowName: state.workflowName,
    workflowVersion: state.workflowVersion,
    instanceId: state.instanceId
  };
};
MemoryPersistence.prototype.loadState = function(workflowName, instanceId) {
  debug("loadState(%s, %s)", workflowName, instanceId);
  var state = this._loadState(workflowName, instanceId);
  state = _.clone(state);
  state.state = JSON.parse(state.state);
  return state;
};
MemoryPersistence.prototype.removeState = function(workflowName, instanceId) {
  debug("removeState(%s, %s)", workflowName, instanceId);
  this._instanceData.delete(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
MemoryPersistence.prototype._loadState = function(workflowName, instanceId) {
  var state = this._instanceData.get(specStrings.hosting.doubleKeys(workflowName, instanceId));
  if (!state) {
    throw new errors.WorkflowNotFoundError("Instance data of workflow '" + workflowName + "' by id '" + instanceId + "' is not found.");
  }
  return state;
};
MemoryPersistence.prototype.loadPromotedProperties = function(workflowName, instanceId) {
  debug("loadPromotedProperties(%s, %s)", workflowName, instanceId);
  var state = this._instanceData.get(specStrings.hosting.doubleKeys(workflowName, instanceId));
  return state ? state.promotedProperties : null;
};
MemoryPersistence.prototype.getNextWakeupables = function(count) {
  debug("getNextWakeupables(%d)", count);
  var now = new Date();
  var result = [];
  var $__11 = true;
  var $__12 = false;
  var $__13 = undefined;
  try {
    for (var $__9 = void 0,
        $__8 = (this._instanceData.values())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__11 = ($__9 = $__8.next()).done); $__11 = true) {
      var data = $__9.value;
      {
        if (data.activeDelays) {
          var $__4 = true;
          var $__5 = false;
          var $__6 = undefined;
          try {
            for (var $__2 = void 0,
                $__1 = (data.activeDelays)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__4 = ($__2 = $__1.next()).done); $__4 = true) {
              var ad = $__2.value;
              {
                if (ad.delayTo <= now) {
                  result.push({
                    instanceId: data.instanceId,
                    workflowName: data.workflowName,
                    updatedOn: data.updatedOn,
                    activeDelay: {
                      methodName: ad.methodName,
                      delayTo: ad.delayTo
                    }
                  });
                }
              }
            }
          } catch ($__7) {
            $__5 = true;
            $__6 = $__7;
          } finally {
            try {
              if (!$__4 && $__1.return != null) {
                $__1.return();
              }
            } finally {
              if ($__5) {
                throw $__6;
              }
            }
          }
        }
      }
    }
  } catch ($__14) {
    $__12 = true;
    $__13 = $__14;
  } finally {
    try {
      if (!$__11 && $__8.return != null) {
        $__8.return();
      }
    } finally {
      if ($__12) {
        throw $__13;
      }
    }
  }
  result.sort(function(i1, i2) {
    if (i1.updatedOn < i2.updatedOn) {
      return -1;
    } else if (i1.updatedOn > i2.updatedOn) {
      return 1;
    } else if (i1.activeDelay.delayTo < i2.activeDelay.delayTo) {
      return -1;
    } else if (i1.activeDelay.delayTo > i2.activeDelay.delayTo) {
      return 1;
    }
    return 0;
  });
  return _.take(result, count);
};
MemoryPersistence.prototype.getRunningInstanceHeadersForOtherVersion = function(workflowName, version) {
  var result = [];
  var $__4 = true;
  var $__5 = false;
  var $__6 = undefined;
  try {
    for (var $__2 = void 0,
        $__1 = (this._instanceData.values())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__4 = ($__2 = $__1.next()).done); $__4 = true) {
      var data = $__2.value;
      {
        if (data.workflowName === workflowName && data.version !== version) {
          result.push({
            workflowName: data.workflowName,
            workflowVersion: data.workflowVersion,
            instanceId: data.instanceId
          });
        }
      }
    }
  } catch ($__7) {
    $__5 = true;
    $__6 = $__7;
  } finally {
    try {
      if (!$__4 && $__1.return != null) {
        $__1.return();
      }
    } finally {
      if ($__5) {
        throw $__6;
      }
    }
  }
  return result;
};
module.exports = MemoryPersistence;
//# sourceMappingURL=data:application/json;base64,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QUFDUixNQUFJO0FBQ0YsU0FBSSxLQUFpQixHQUFLLENBQUEsV0FBdUIsR0FBSyxLQUFHLENBQUc7QUFDMUQsa0JBQXdCLEFBQUMsRUFBQyxDQUFDO01BQzdCO0FBQUEsSUFDRixDQUFFLE9BQVE7QUFDUixjQUF3QjtBQUN0QixrQkFBd0I7TUFDMUI7QUFBQSxJQUNGO0FBQUEsRUFDRjtBQUFBLEFBdUtKLE9BQU8sT0FBSyxDQUFDO0FBQ2pCLENBQUM7QUFFRCxLQUFLLFFBQVEsRUFBSSxrQkFBZ0IsQ0FBQztBQUFBIiwiZmlsZSI6Imhvc3RpbmcvbWVtb3J5UGVyc2lzdGVuY2UuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5sZXQgdXVpZCA9IHJlcXVpcmUoJ25vZGUtdXVpZCcpO1xucmVxdWlyZSgnZGF0ZS11dGlscycpO1xubGV0IHNwZWNTdHJpbmdzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9zcGVjU3RyaW5nc1wiKTtcbmxldCBJbnN0SWRQYXRocyA9IHJlcXVpcmUoXCIuL2luc3RJZFBhdGhzXCIpO1xubGV0IGlzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9pc1wiKTtcbmxldCBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbmxldCBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKShcIndmNG5vZGU6TWVtb3J5UGVyc2lzdGVuY2VcIik7XG5sZXQgZXJyb3JzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lcnJvcnNcIik7XG5cbmZ1bmN0aW9uIE1lbW9yeVBlcnNpc3RlbmNlKCkge1xuICAgIHRoaXMuX2luc3RhbmNlRGF0YSA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLl9sb2Nrc0J5SWQgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5fbG9ja3NCeU5hbWUgPSBuZXcgTWFwKCk7XG59XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLl9pbnN0YW5jZURhdGEuY2xlYXIoKTtcbiAgICB0aGlzLl9sb2Nrc0J5SWQuY2xlYXIoKTtcbiAgICB0aGlzLl9sb2Nrc0J5TmFtZS5jbGVhcigpO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLmVudGVyTG9jayA9IGZ1bmN0aW9uIChsb2NrTmFtZSwgaW5Mb2NrVGltZW91dE1zKSB7XG4gICAgZGVidWcoXCJlbnRlckxvY2soJXMsICVkKVwiLCBsb2NrTmFtZSwgaW5Mb2NrVGltZW91dE1zKTtcblxuICAgIGxldCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGRlYnVnKFwiU2VhcmNoaW5nIGZvciBsb2NrIGJ5IG5hbWUgJXNcIiwgbG9ja05hbWUpO1xuICAgIGxldCBjTG9jayA9IHRoaXMuX2xvY2tzQnlOYW1lLmdldChsb2NrTmFtZSk7XG4gICAgZGVidWcoXCJMb2NrIGluZm86ICVqXCIsIGNMb2NrKTtcbiAgICBpZiAoIWNMb2NrIHx8IGNMb2NrLmhlbGRUby5nZXRUaW1lKCkgPCBub3cuZ2V0VGltZSgpKSB7XG4gICAgICAgIGxldCBsb2NrSW5mbyA9IHtcbiAgICAgICAgICAgIGlkOiB1dWlkLnY0KCksXG4gICAgICAgICAgICBuYW1lOiBsb2NrTmFtZSxcbiAgICAgICAgICAgIGhlbGRUbzogbm93LmFkZE1pbGxpc2Vjb25kcyhpbkxvY2tUaW1lb3V0TXMpXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5fbG9ja3NCeUlkLnNldChsb2NrSW5mby5pZCwgbG9ja0luZm8pO1xuICAgICAgICB0aGlzLl9sb2Nrc0J5TmFtZS5zZXQobG9ja0luZm8ubmFtZSwgbG9ja0luZm8pO1xuXG4gICAgICAgIGRlYnVnKFwiTE9DS0VEOiAlc1wiLCBsb2NrSW5mby5uYW1lKTtcblxuICAgICAgICByZXR1cm4gbG9ja0luZm87XG4gICAgfVxuICAgIGRlYnVnKFwiSXQgaXMgYWxyZWFkeSBoZWxkLlwiKTtcbiAgICByZXR1cm4gbnVsbDtcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5yZW5ld0xvY2sgPSBmdW5jdGlvbiAobG9ja0lkLCBpbkxvY2tUaW1lb3V0TXMpIHtcbiAgICBkZWJ1ZyhcInJlbmV3TG9jayglcywgJWQpXCIsIGxvY2tJZCwgaW5Mb2NrVGltZW91dE1zKTtcblxuICAgIGxldCBjTG9jayA9IHRoaXMuX2dldExvY2tCeUlkKGxvY2tJZCk7XG4gICAgY0xvY2suaGVsZFRvID0gbmV3IERhdGUoKS5hZGRNaWxsaXNlY29uZHMoaW5Mb2NrVGltZW91dE1zKTtcbiAgICBkZWJ1ZyhcIkxvY2sgJXMgZXh0ZW5kZWQgdG8gJXNcIiwgbG9ja0lkLCBjTG9jay5oZWxkVG8pO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLmV4aXRMb2NrID0gZnVuY3Rpb24gKGxvY2tJZCkge1xuICAgIGRlYnVnKFwiZXhpdExvY2soJXMpXCIsIGxvY2tJZCk7XG5cbiAgICBsZXQgY0xvY2sgPSB0aGlzLl9nZXRMb2NrQnlJZChsb2NrSWQpO1xuICAgIHRoaXMuX2xvY2tzQnlJZC5kZWxldGUoY0xvY2suaWQpO1xuICAgIHRoaXMuX2xvY2tzQnlOYW1lLmRlbGV0ZShjTG9jay5uYW1lKTtcblxuICAgIGRlYnVnKFwiVU5MT0NLRUQ6ICVzXCIsIGNMb2NrLm5hbWUpO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLl9nZXRMb2NrQnlJZCA9IGZ1bmN0aW9uIChsb2NrSWQpIHtcbiAgICBsZXQgY0xvY2sgPSB0aGlzLl9sb2Nrc0J5SWQuZ2V0KGxvY2tJZCk7XG4gICAgbGV0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgaWYgKCFjTG9jayB8fCBub3cuY29tcGFyZVRvKGNMb2NrLmhlbGRUbykgPiAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkxvY2sgYnkgaWQgJ1wiICsgbG9ja0lkICsgXCInIGRvZXNuJ3QgZXhpc3RzLlwiKTtcbiAgICB9XG4gICAgcmV0dXJuIGNMb2NrO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLmlzUnVubmluZyA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcbiAgICBkZWJ1ZyhcImlzUnVubmluZyglcywgJXMpXCIsIHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCk7XG5cbiAgICByZXR1cm4gdGhpcy5faW5zdGFuY2VEYXRhLmhhcyhzcGVjU3RyaW5ncy5ob3N0aW5nLmRvdWJsZUtleXMod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSk7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUucGVyc2lzdFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgZGVidWcoXCJwZXJzaXN0U3RhdGUoJWopXCIsIHN0YXRlKTtcblxuICAgIHN0YXRlID0gXy5jbG9uZShzdGF0ZSk7XG4gICAgc3RhdGUuc3RhdGUgPSBKU09OLnN0cmluZ2lmeShzdGF0ZS5zdGF0ZSk7XG5cbiAgICB0aGlzLl9pbnN0YW5jZURhdGEuc2V0KHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyhzdGF0ZS53b3JrZmxvd05hbWUsIHN0YXRlLmluc3RhbmNlSWQpLCBzdGF0ZSk7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZ2V0UnVubmluZ0luc3RhbmNlSWRIZWFkZXIgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgZGVidWcoXCJnZXRSdW5uaW5nSW5zdGFuY2VJZEhlYWRlciglcywgJXMpXCIsIHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCk7XG5cbiAgICBsZXQgc3RhdGUgPSB0aGlzLl9pbnN0YW5jZURhdGEuZ2V0KHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcbiAgICBpZiAoIXN0YXRlKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICB1cGRhdGVkT246IHN0YXRlLnVwZGF0ZWRPbixcbiAgICAgICAgd29ya2Zsb3dOYW1lOiBzdGF0ZS53b3JrZmxvd05hbWUsXG4gICAgICAgIHdvcmtmbG93VmVyc2lvbjogc3RhdGUud29ya2Zsb3dWZXJzaW9uLFxuICAgICAgICBpbnN0YW5jZUlkOiBzdGF0ZS5pbnN0YW5jZUlkXG4gICAgfTtcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5sb2FkU3RhdGUgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgZGVidWcoXCJsb2FkU3RhdGUoJXMsICVzKVwiLCB3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpO1xuXG4gICAgbGV0IHN0YXRlID0gdGhpcy5fbG9hZFN0YXRlKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCk7XG4gICAgc3RhdGUgPSBfLmNsb25lKHN0YXRlKTtcbiAgICBzdGF0ZS5zdGF0ZSA9IEpTT04ucGFyc2Uoc3RhdGUuc3RhdGUpO1xuICAgIHJldHVybiBzdGF0ZTtcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5yZW1vdmVTdGF0ZSA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcbiAgICBkZWJ1ZyhcInJlbW92ZVN0YXRlKCVzLCAlcylcIiwgd29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKTtcblxuICAgIHRoaXMuX2luc3RhbmNlRGF0YS5kZWxldGUoc3BlY1N0cmluZ3MuaG9zdGluZy5kb3VibGVLZXlzKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkpO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLl9sb2FkU3RhdGUgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgbGV0IHN0YXRlID0gdGhpcy5faW5zdGFuY2VEYXRhLmdldChzcGVjU3RyaW5ncy5ob3N0aW5nLmRvdWJsZUtleXMod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSk7XG4gICAgaWYgKCFzdGF0ZSkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLldvcmtmbG93Tm90Rm91bmRFcnJvcihcIkluc3RhbmNlIGRhdGEgb2Ygd29ya2Zsb3cgJ1wiICsgd29ya2Zsb3dOYW1lICsgXCInIGJ5IGlkICdcIiArIGluc3RhbmNlSWQgKyBcIicgaXMgbm90IGZvdW5kLlwiKTtcbiAgICB9XG4gICAgcmV0dXJuIHN0YXRlO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLmxvYWRQcm9tb3RlZFByb3BlcnRpZXMgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgZGVidWcoXCJsb2FkUHJvbW90ZWRQcm9wZXJ0aWVzKCVzLCAlcylcIiwgd29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKTtcblxuICAgIGxldCBzdGF0ZSA9IHRoaXMuX2luc3RhbmNlRGF0YS5nZXQoc3BlY1N0cmluZ3MuaG9zdGluZy5kb3VibGVLZXlzKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkpO1xuICAgIHJldHVybiBzdGF0ZSA/IHN0YXRlLnByb21vdGVkUHJvcGVydGllcyA6IG51bGw7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZ2V0TmV4dFdha2V1cGFibGVzID0gZnVuY3Rpb24gKGNvdW50KSB7XG4gICAgZGVidWcoXCJnZXROZXh0V2FrZXVwYWJsZXMoJWQpXCIsIGNvdW50KTtcblxuICAgIGxldCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICBmb3IgKGxldCBkYXRhIG9mIHRoaXMuX2luc3RhbmNlRGF0YS52YWx1ZXMoKSkge1xuICAgICAgICBpZiAoZGF0YS5hY3RpdmVEZWxheXMpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGFkIG9mIGRhdGEuYWN0aXZlRGVsYXlzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGFkLmRlbGF5VG8gPD0gbm93KSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGRhdGEuaW5zdGFuY2VJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93TmFtZTogZGF0YS53b3JrZmxvd05hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkT246IGRhdGEudXBkYXRlZE9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlRGVsYXk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2ROYW1lOiBhZC5tZXRob2ROYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGF5VG86IGFkLmRlbGF5VG9cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJlc3VsdC5zb3J0KGZ1bmN0aW9uIChpMSwgaTIpIHtcbiAgICAgICAgaWYgKGkxLnVwZGF0ZWRPbiA8IGkyLnVwZGF0ZWRPbikge1xuICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGkxLnVwZGF0ZWRPbiA+IGkyLnVwZGF0ZWRPbikge1xuICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoaTEuYWN0aXZlRGVsYXkuZGVsYXlUbyA8IGkyLmFjdGl2ZURlbGF5LmRlbGF5VG8pIHtcbiAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChpMS5hY3RpdmVEZWxheS5kZWxheVRvID4gaTIuYWN0aXZlRGVsYXkuZGVsYXlUbykge1xuICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfSk7XG4gICAgcmV0dXJuIF8udGFrZShyZXN1bHQsIGNvdW50KTtcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5nZXRSdW5uaW5nSW5zdGFuY2VIZWFkZXJzRm9yT3RoZXJWZXJzaW9uID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgdmVyc2lvbikge1xuICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICBmb3IgKGxldCBkYXRhIG9mIHRoaXMuX2luc3RhbmNlRGF0YS52YWx1ZXMoKSkge1xuICAgICAgICBpZiAoZGF0YS53b3JrZmxvd05hbWUgPT09IHdvcmtmbG93TmFtZSAmJiBkYXRhLnZlcnNpb24gIT09IHZlcnNpb24pIHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IGRhdGEud29ya2Zsb3dOYW1lLFxuICAgICAgICAgICAgICAgIHdvcmtmbG93VmVyc2lvbjogZGF0YS53b3JrZmxvd1ZlcnNpb24sXG4gICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogZGF0YS5pbnN0YW5jZUlkXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBNZW1vcnlQZXJzaXN0ZW5jZTsiXX0=
