"use strict";
var StrMap = require("backpack-node").collections.StrMap;
var Guid = require("guid");
require('date-utils');
var specStrings = require("../common/specStrings");
var InstIdPaths = require("./instIdPaths");
var is = require("../common/is");
var fast = require("fast.js");
function MemoryPersistence(log) {
  this._instanceData = new StrMap();
  this._locksById = new StrMap();
  this._locksByName = new StrMap();
  this._log = log === true;
}
MemoryPersistence.prototype.enterLock = function(lockName, inLockTimeoutMs) {
  if (this._log)
    console.log("enterLock(" + lockName + ", " + inLockTimeoutMs + ");\n");
  var now = new Date();
  var cLock = this._locksByName.get(lockName);
  if (is.undefined(cLock) || cLock.heldTo.compareTo(now) === -1) {
    var lockInfo = {
      id: Guid.create().toString(),
      name: lockName,
      heldTo: new Date().addMilliseconds(inLockTimeoutMs)
    };
    this._locksById.set(lockInfo.id, lockInfo);
    this._locksByName.set(lockInfo.name, lockInfo);
    return lockInfo;
  }
  return null;
};
MemoryPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  if (this._log)
    console.log("renewLock(" + lockId + ", " + inLockTimeoutMs + ");\n");
  var cLock = this._getLockById(lockId);
  cLock.heldTo = new Date().addMilliseconds(inLockTimeoutMs);
};
MemoryPersistence.prototype.exitLock = function(lockId) {
  if (this._log)
    console.log("exitLock(" + lockId + ");\n");
  var cLock = this._getLockById(lockId);
  this._locksByName.remove(cLock.name);
  this._locksById.remove(cLock.id);
};
MemoryPersistence.prototype._getLockById = function(lockId) {
  var cLock = this._locksById.get(lockId);
  var now = new Date();
  if (!cLock || now.compareTo(cLock.heldTo) > 0)
    throw new Error("Lock by id '" + lockId + "' doesn't exists.");
  return cLock;
};
MemoryPersistence.prototype.isRunning = function(workflowName, instanceId) {
  if (this._log)
    console.log("isRunning(" + workflowName + ", " + instanceId + ");\n");
  return this._instanceData.containsKey(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
MemoryPersistence.prototype.persistState = function(state) {
  if (this._log)
    console.log("persistState(" + state.workflowName + ", " + state.instanceId + ");\n");
  this._instanceData.set(specStrings.hosting.doubleKeys(state.workflowName, state.instanceId), state);
};
MemoryPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  if (this._log)
    console.log("getRunningInstanceIdHeader(" + workflowName + ", " + instanceId + ");\n");
  var state = this._loadState(workflowName, instanceId);
  return {
    updatedOn: state.updatedOn,
    workflowVersion: state.workflowVersion
  };
};
MemoryPersistence.prototype.loadState = function(workflowName, instanceId) {
  if (this._log)
    console.log("loadState(" + workflowName + ", " + instanceId + ");\n");
  return this._loadState(workflowName, instanceId);
};
MemoryPersistence.prototype.removeState = function(workflowName, instanceId) {
  if (this._log)
    console.log("removeState(" + workflowName + ", " + instanceId + ");\n");
  this._instanceData.remove(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
MemoryPersistence.prototype._loadState = function(workflowName, instanceId) {
  var state = this._instanceData.get(specStrings.hosting.doubleKeys(workflowName, instanceId));
  if (!state)
    throw new Error("Instance data of workflow '" + workflowName + "' by id '" + instanceId + "' is not found.");
  return state;
};
MemoryPersistence.prototype.loadPromotedProperties = function(workflowName, instanceId) {
  if (this._log)
    console.log("loadPromotedProperties(" + workflowName + ", " + instanceId + ");\n");
  var state = this._instanceData.get(specStrings.hosting.doubleKeys(workflowName, instanceId));
  return state ? state.promotedProperties : null;
};
module.exports = MemoryPersistence;
//# sourceMappingURL=data:application/json;base64,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QUcsQ0FBQSxDQUFJLFdBQVMsQ0FBQSxDQUFJLE9BQUssQ0FBQyxDQUFDO0FBQUEsQUFFN0YsSUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsY0FBYyxJQUFJLEFBQUMsQ0FBQyxXQUFVLFFBQVEsV0FBVyxBQUFDLENBQUMsWUFBVyxDQUFHLFdBQVMsQ0FBQyxDQUFDLENBQUM7QUFDNUYsT0FBTyxDQUFBLEtBQUksRUFBSSxDQUFBLEtBQUksbUJBQW1CLEVBQUksS0FBRyxDQUFDO0FBQ2xELENBQUE7QUFFQSxLQUFLLFFBQVEsRUFBSSxrQkFBZ0IsQ0FBQztBQUFBIiwiZmlsZSI6Imhvc3RpbmcvbWVtb3J5UGVyc2lzdGVuY2UuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbInZhciBTdHJNYXAgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5jb2xsZWN0aW9ucy5TdHJNYXA7XHJcbnZhciBHdWlkID0gcmVxdWlyZShcImd1aWRcIik7XHJcbnJlcXVpcmUoJ2RhdGUtdXRpbHMnKTtcclxudmFyIHNwZWNTdHJpbmdzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9zcGVjU3RyaW5nc1wiKTtcclxudmFyIEluc3RJZFBhdGhzID0gcmVxdWlyZShcIi4vaW5zdElkUGF0aHNcIik7XHJcbnZhciBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XHJcbnZhciBmYXN0ID0gcmVxdWlyZShcImZhc3QuanNcIik7XHJcblxyXG5mdW5jdGlvbiBNZW1vcnlQZXJzaXN0ZW5jZShsb2cpIHtcclxuICAgIHRoaXMuX2luc3RhbmNlRGF0YSA9IG5ldyBTdHJNYXAoKTtcclxuICAgIHRoaXMuX2xvY2tzQnlJZCA9IG5ldyBTdHJNYXAoKTtcclxuICAgIHRoaXMuX2xvY2tzQnlOYW1lID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgdGhpcy5fbG9nID0gbG9nID09PSB0cnVlO1xyXG59XHJcblxyXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZW50ZXJMb2NrID0gZnVuY3Rpb24gKGxvY2tOYW1lLCBpbkxvY2tUaW1lb3V0TXMpIHtcclxuICAgIGlmICh0aGlzLl9sb2cpIGNvbnNvbGUubG9nKFwiZW50ZXJMb2NrKFwiICsgbG9ja05hbWUgKyBcIiwgXCIgKyBpbkxvY2tUaW1lb3V0TXMgKyBcIik7XFxuXCIpO1xyXG5cclxuICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgdmFyIGNMb2NrID0gdGhpcy5fbG9ja3NCeU5hbWUuZ2V0KGxvY2tOYW1lKTtcclxuICAgIGlmIChpcy51bmRlZmluZWQoY0xvY2spIHx8IGNMb2NrLmhlbGRUby5jb21wYXJlVG8obm93KSA9PT0gLTEpIHtcclxuICAgICAgICB2YXIgbG9ja0luZm8gPSB7XHJcbiAgICAgICAgICAgIGlkOiBHdWlkLmNyZWF0ZSgpLnRvU3RyaW5nKCksXHJcbiAgICAgICAgICAgIG5hbWU6IGxvY2tOYW1lLFxyXG4gICAgICAgICAgICBoZWxkVG86IG5ldyBEYXRlKCkuYWRkTWlsbGlzZWNvbmRzKGluTG9ja1RpbWVvdXRNcylcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLl9sb2Nrc0J5SWQuc2V0KGxvY2tJbmZvLmlkLCBsb2NrSW5mbyk7XHJcbiAgICAgICAgdGhpcy5fbG9ja3NCeU5hbWUuc2V0KGxvY2tJbmZvLm5hbWUsIGxvY2tJbmZvKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGxvY2tJbmZvO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5yZW5ld0xvY2sgPSBmdW5jdGlvbiAobG9ja0lkLCBpbkxvY2tUaW1lb3V0TXMpIHtcclxuICAgIGlmICh0aGlzLl9sb2cpIGNvbnNvbGUubG9nKFwicmVuZXdMb2NrKFwiICsgbG9ja0lkICsgXCIsIFwiICsgaW5Mb2NrVGltZW91dE1zICsgXCIpO1xcblwiKTtcclxuXHJcbiAgICB2YXIgY0xvY2sgPSB0aGlzLl9nZXRMb2NrQnlJZChsb2NrSWQpO1xyXG4gICAgY0xvY2suaGVsZFRvID0gbmV3IERhdGUoKS5hZGRNaWxsaXNlY29uZHMoaW5Mb2NrVGltZW91dE1zKTtcclxufVxyXG5cclxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLmV4aXRMb2NrID0gZnVuY3Rpb24gKGxvY2tJZCkge1xyXG4gICAgaWYgKHRoaXMuX2xvZykgY29uc29sZS5sb2coXCJleGl0TG9jayhcIiArIGxvY2tJZCArIFwiKTtcXG5cIik7XHJcblxyXG4gICAgdmFyIGNMb2NrID0gdGhpcy5fZ2V0TG9ja0J5SWQobG9ja0lkKTtcclxuICAgIHRoaXMuX2xvY2tzQnlOYW1lLnJlbW92ZShjTG9jay5uYW1lKTtcclxuICAgIHRoaXMuX2xvY2tzQnlJZC5yZW1vdmUoY0xvY2suaWQpO1xyXG59XHJcblxyXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX2dldExvY2tCeUlkID0gZnVuY3Rpb24gKGxvY2tJZCkge1xyXG4gICAgdmFyIGNMb2NrID0gdGhpcy5fbG9ja3NCeUlkLmdldChsb2NrSWQpO1xyXG4gICAgdmFyIG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgICBpZiAoIWNMb2NrIHx8IG5vdy5jb21wYXJlVG8oY0xvY2suaGVsZFRvKSA+IDApIHRocm93IG5ldyBFcnJvcihcIkxvY2sgYnkgaWQgJ1wiICsgbG9ja0lkICsgXCInIGRvZXNuJ3QgZXhpc3RzLlwiKTtcclxuICAgIHJldHVybiBjTG9jaztcclxufVxyXG5cclxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLmlzUnVubmluZyA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgIGlmICh0aGlzLl9sb2cpIGNvbnNvbGUubG9nKFwiaXNSdW5uaW5nKFwiICsgd29ya2Zsb3dOYW1lICsgXCIsIFwiICsgaW5zdGFuY2VJZCArIFwiKTtcXG5cIik7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuX2luc3RhbmNlRGF0YS5jb250YWluc0tleShzcGVjU3RyaW5ncy5ob3N0aW5nLmRvdWJsZUtleXMod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSk7XHJcbn1cclxuXHJcbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5wZXJzaXN0U3RhdGUgPSBmdW5jdGlvbiAoc3RhdGUpIHtcclxuICAgIGlmICh0aGlzLl9sb2cpIGNvbnNvbGUubG9nKFwicGVyc2lzdFN0YXRlKFwiICsgc3RhdGUud29ya2Zsb3dOYW1lICsgXCIsIFwiICsgc3RhdGUuaW5zdGFuY2VJZCArIFwiKTtcXG5cIik7XHJcblxyXG4gICAgdGhpcy5faW5zdGFuY2VEYXRhLnNldChzcGVjU3RyaW5ncy5ob3N0aW5nLmRvdWJsZUtleXMoc3RhdGUud29ya2Zsb3dOYW1lLCBzdGF0ZS5pbnN0YW5jZUlkKSwgc3RhdGUpO1xyXG59XHJcblxyXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZ2V0UnVubmluZ0luc3RhbmNlSWRIZWFkZXIgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XHJcbiAgICBpZiAodGhpcy5fbG9nKSBjb25zb2xlLmxvZyhcImdldFJ1bm5pbmdJbnN0YW5jZUlkSGVhZGVyKFwiICsgd29ya2Zsb3dOYW1lICsgXCIsIFwiICsgaW5zdGFuY2VJZCArIFwiKTtcXG5cIik7XHJcblxyXG4gICAgdmFyIHN0YXRlID0gdGhpcy5fbG9hZFN0YXRlKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHVwZGF0ZWRPbjogc3RhdGUudXBkYXRlZE9uLFxyXG4gICAgICAgIHdvcmtmbG93VmVyc2lvbjogc3RhdGUud29ya2Zsb3dWZXJzaW9uXHJcbiAgICB9O1xyXG59XHJcblxyXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUubG9hZFN0YXRlID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xyXG4gICAgaWYgKHRoaXMuX2xvZykgY29uc29sZS5sb2coXCJsb2FkU3RhdGUoXCIgKyB3b3JrZmxvd05hbWUgKyBcIiwgXCIgKyBpbnN0YW5jZUlkICsgXCIpO1xcblwiKTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5fbG9hZFN0YXRlKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCk7XHJcbn1cclxuXHJcbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5yZW1vdmVTdGF0ZSA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgIGlmICh0aGlzLl9sb2cpIGNvbnNvbGUubG9nKFwicmVtb3ZlU3RhdGUoXCIgKyB3b3JrZmxvd05hbWUgKyBcIiwgXCIgKyBpbnN0YW5jZUlkICsgXCIpO1xcblwiKTtcclxuXHJcbiAgICB0aGlzLl9pbnN0YW5jZURhdGEucmVtb3ZlKHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcclxufVxyXG5cclxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLl9sb2FkU3RhdGUgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XHJcbiAgICB2YXIgc3RhdGUgPSB0aGlzLl9pbnN0YW5jZURhdGEuZ2V0KHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcclxuICAgIGlmICghc3RhdGUpIHRocm93IG5ldyBFcnJvcihcIkluc3RhbmNlIGRhdGEgb2Ygd29ya2Zsb3cgJ1wiICsgd29ya2Zsb3dOYW1lICsgXCInIGJ5IGlkICdcIiArIGluc3RhbmNlSWQgKyBcIicgaXMgbm90IGZvdW5kLlwiKTtcclxuICAgIHJldHVybiBzdGF0ZTtcclxufVxyXG5cclxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLmxvYWRQcm9tb3RlZFByb3BlcnRpZXMgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XHJcbiAgICBpZiAodGhpcy5fbG9nKSBjb25zb2xlLmxvZyhcImxvYWRQcm9tb3RlZFByb3BlcnRpZXMoXCIgKyB3b3JrZmxvd05hbWUgKyBcIiwgXCIgKyBpbnN0YW5jZUlkICsgXCIpO1xcblwiKTtcclxuXHJcbiAgICB2YXIgc3RhdGUgPSB0aGlzLl9pbnN0YW5jZURhdGEuZ2V0KHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcclxuICAgIHJldHVybiBzdGF0ZSA/IHN0YXRlLnByb21vdGVkUHJvcGVydGllcyA6IG51bGw7XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0gTWVtb3J5UGVyc2lzdGVuY2U7Il19
