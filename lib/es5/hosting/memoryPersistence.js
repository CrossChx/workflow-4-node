"use strict";
var uuid = require('node-uuid');
require('date-utils');
var specStrings = require("../common/specStrings");
var InstIdPaths = require("./instIdPaths");
var is = require("../common/is");
var _ = require("lodash");
var debug = require("debug")("wf4node:MemoryPersistence");
function MemoryPersistence() {
  this._instanceData = new Map();
  this._locksById = new Map();
  this._locksByName = new Map();
}
MemoryPersistence.prototype.enterLock = function(lockName, inLockTimeoutMs) {
  debug("enterLock(%s, %d)", lockName, inLockTimeoutMs);
  var now = new Date();
  debug("Searching for lock by name %s", lockName);
  var cLock = this._locksByName.get(lockName);
  debug("Lock info: %j", cLock);
  if (!cLock || cLock.heldTo.getTime() < now.getTime()) {
    var lockInfo = {
      id: uuid.v4(),
      name: lockName,
      heldTo: now.addMilliseconds(inLockTimeoutMs)
    };
    this._locksById.set(lockInfo.id, lockInfo);
    this._locksByName.set(lockInfo.name, lockInfo);
    debug("LOCKED: %s", lockInfo.name);
    return lockInfo;
  }
  debug("It is already held.");
  return null;
};
MemoryPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  debug("renewLock(%s, %d)", lockId, inLockTimeoutMs);
  var cLock = this._getLockById(lockId);
  cLock.heldTo = new Date().addMilliseconds(inLockTimeoutMs);
  debug("Lock %s extended to %s", lockId, cLock.heldTo);
};
MemoryPersistence.prototype.exitLock = function(lockId) {
  debug("exitLock(%s)", lockId);
  var cLock = this._getLockById(lockId);
  this._locksByName.delete(cLock.name);
  this._locksById.delete(cLock.id);
  debug("UNLOCKED: %s", cLock.name);
};
MemoryPersistence.prototype._getLockById = function(lockId) {
  var cLock = this._locksById.get(lockId);
  var now = new Date();
  if (!cLock || now.compareTo(cLock.heldTo) > 0) {
    throw new Error("Lock by id '" + lockId + "' doesn't exists.");
  }
  return cLock;
};
MemoryPersistence.prototype.isRunning = function(workflowName, instanceId) {
  debug("isRunning(%s, %s)", workflowName, instanceId);
  return this._instanceData.has(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
MemoryPersistence.prototype.persistState = function(state) {
  debug("persistState(%j)", state);
  this._instanceData.set(specStrings.hosting.doubleKeys(state.workflowName, state.instanceId), state);
};
MemoryPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  debug("getRunningInstanceIdHeader(%s, %s)", workflowName, instanceId);
  var state = this._loadState(workflowName, instanceId);
  return {
    updatedOn: state.updatedOn,
    workflowVersion: state.workflowVersion
  };
};
MemoryPersistence.prototype.loadState = function(workflowName, instanceId) {
  debug("loadState(%s, %s)", workflowName, instanceId);
  return this._loadState(workflowName, instanceId);
};
MemoryPersistence.prototype.removeState = function(workflowName, instanceId) {
  debug("removeState(%s, %s)", workflowName, instanceId);
  this._instanceData.delete(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
MemoryPersistence.prototype._loadState = function(workflowName, instanceId) {
  var state = this._instanceData.get(specStrings.hosting.doubleKeys(workflowName, instanceId));
  if (!state) {
    throw new errors.WorkflowNotFoundError("Instance data of workflow '" + workflowName + "' by id '" + instanceId + "' is not found.");
  }
  return state;
};
MemoryPersistence.prototype.loadPromotedProperties = function(workflowName, instanceId) {
  debug("loadPromotedProperties(%s, %s)", workflowName, instanceId);
  var state = this._instanceData.get(specStrings.hosting.doubleKeys(workflowName, instanceId));
  return state ? state.promotedProperties : null;
};
MemoryPersistence.prototype.getNextWakeupables = function(count) {
  debug("getNextWakeupables(%d)", count);
  var now = new Date();
  var result = [];
  var $__11 = true;
  var $__12 = false;
  var $__13 = undefined;
  try {
    for (var $__9 = void 0,
        $__8 = (this._instanceData.values())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__11 = ($__9 = $__8.next()).done); $__11 = true) {
      var data = $__9.value;
      {
        if (data.activeDelays) {
          var $__4 = true;
          var $__5 = false;
          var $__6 = undefined;
          try {
            for (var $__2 = void 0,
                $__1 = (data.activeDelays)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__4 = ($__2 = $__1.next()).done); $__4 = true) {
              var ad = $__2.value;
              {
                if (ad.delayTo <= now) {
                  result.push({
                    instanceId: data.instanceId,
                    workflowName: data.workflowName,
                    updatedOn: data.updatedOn,
                    activeDelay: {
                      methodName: ad.methodName,
                      delayTo: ad.delayTo
                    }
                  });
                }
              }
            }
          } catch ($__7) {
            $__5 = true;
            $__6 = $__7;
          } finally {
            try {
              if (!$__4 && $__1.return != null) {
                $__1.return();
              }
            } finally {
              if ($__5) {
                throw $__6;
              }
            }
          }
        }
      }
    }
  } catch ($__14) {
    $__12 = true;
    $__13 = $__14;
  } finally {
    try {
      if (!$__11 && $__8.return != null) {
        $__8.return();
      }
    } finally {
      if ($__12) {
        throw $__13;
      }
    }
  }
  result.sort(function(i1, i2) {
    if (i1.updatedOn < i2.updatedOn) {
      return -1;
    } else if (i1.updatedOn > i2.updatedOn) {
      return 1;
    } else if (i1.activeDelay.delayTo < i2.activeDelay.delayTo) {
      return -1;
    } else if (i1.activeDelay.delayTo > i2.activeDelay.delayTo) {
      return 1;
    }
    return 0;
  });
  return _.take(result, count);
};
module.exports = MemoryPersistence;
//# sourceMappingURL=data:application/json;base64,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QUFDO0lBQ2IsS0FDSyxLQUFJLEVBQUMsVUFBVSxFQUFJLENBQUEsRUFBQyxVQUFVLENBQUc7QUFDbEMsV0FBTyxFQUFBLENBQUM7SUFDWixLQUNLLEtBQUksRUFBQyxZQUFZLFFBQVEsRUFBSSxDQUFBLEVBQUMsWUFBWSxRQUFRLENBQUc7QUFDdEQsV0FBTyxFQUFDLENBQUEsQ0FBQztJQUNiLEtBQ0ssS0FBSSxFQUFDLFlBQVksUUFBUSxFQUFJLENBQUEsRUFBQyxZQUFZLFFBQVEsQ0FBRztBQUN0RCxXQUFPLEVBQUEsQ0FBQztJQUNaO0FBQUEsQUFDQSxTQUFPLEVBQUEsQ0FBQztFQUNaLENBQUMsQ0FBQztBQUNGLE9BQU8sQ0FBQSxDQUFBLEtBQUssQUFBQyxDQUFDLE1BQUssQ0FBRyxNQUFJLENBQUMsQ0FBQztBQUNoQyxDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksa0JBQWdCLENBQUM7QUFBQSIsImZpbGUiOiJob3N0aW5nL21lbW9yeVBlcnNpc3RlbmNlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IHV1aWQgPSByZXF1aXJlKCdub2RlLXV1aWQnKTtcbnJlcXVpcmUoJ2RhdGUtdXRpbHMnKTtcbmxldCBzcGVjU3RyaW5ncyA9IHJlcXVpcmUoXCIuLi9jb21tb24vc3BlY1N0cmluZ3NcIik7XG5sZXQgSW5zdElkUGF0aHMgPSByZXF1aXJlKFwiLi9pbnN0SWRQYXRoc1wiKTtcbmxldCBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgZGVidWcgPSByZXF1aXJlKFwiZGVidWdcIikoXCJ3ZjRub2RlOk1lbW9yeVBlcnNpc3RlbmNlXCIpO1xuXG5mdW5jdGlvbiBNZW1vcnlQZXJzaXN0ZW5jZSgpIHtcbiAgICB0aGlzLl9pbnN0YW5jZURhdGEgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5fbG9ja3NCeUlkID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuX2xvY2tzQnlOYW1lID0gbmV3IE1hcCgpO1xufVxuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZW50ZXJMb2NrID0gZnVuY3Rpb24gKGxvY2tOYW1lLCBpbkxvY2tUaW1lb3V0TXMpIHtcbiAgICBkZWJ1ZyhcImVudGVyTG9jayglcywgJWQpXCIsIGxvY2tOYW1lLCBpbkxvY2tUaW1lb3V0TXMpO1xuXG4gICAgbGV0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgZGVidWcoXCJTZWFyY2hpbmcgZm9yIGxvY2sgYnkgbmFtZSAlc1wiLCBsb2NrTmFtZSk7XG4gICAgbGV0IGNMb2NrID0gdGhpcy5fbG9ja3NCeU5hbWUuZ2V0KGxvY2tOYW1lKTtcbiAgICBkZWJ1ZyhcIkxvY2sgaW5mbzogJWpcIiwgY0xvY2spO1xuICAgIGlmICghY0xvY2sgfHwgY0xvY2suaGVsZFRvLmdldFRpbWUoKSA8IG5vdy5nZXRUaW1lKCkpIHtcbiAgICAgICAgbGV0IGxvY2tJbmZvID0ge1xuICAgICAgICAgICAgaWQ6IHV1aWQudjQoKSxcbiAgICAgICAgICAgIG5hbWU6IGxvY2tOYW1lLFxuICAgICAgICAgICAgaGVsZFRvOiBub3cuYWRkTWlsbGlzZWNvbmRzKGluTG9ja1RpbWVvdXRNcylcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLl9sb2Nrc0J5SWQuc2V0KGxvY2tJbmZvLmlkLCBsb2NrSW5mbyk7XG4gICAgICAgIHRoaXMuX2xvY2tzQnlOYW1lLnNldChsb2NrSW5mby5uYW1lLCBsb2NrSW5mbyk7XG5cbiAgICAgICAgZGVidWcoXCJMT0NLRUQ6ICVzXCIsIGxvY2tJbmZvLm5hbWUpO1xuXG4gICAgICAgIHJldHVybiBsb2NrSW5mbztcbiAgICB9XG4gICAgZGVidWcoXCJJdCBpcyBhbHJlYWR5IGhlbGQuXCIpO1xuICAgIHJldHVybiBudWxsO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLnJlbmV3TG9jayA9IGZ1bmN0aW9uIChsb2NrSWQsIGluTG9ja1RpbWVvdXRNcykge1xuICAgIGRlYnVnKFwicmVuZXdMb2NrKCVzLCAlZClcIiwgbG9ja0lkLCBpbkxvY2tUaW1lb3V0TXMpO1xuXG4gICAgbGV0IGNMb2NrID0gdGhpcy5fZ2V0TG9ja0J5SWQobG9ja0lkKTtcbiAgICBjTG9jay5oZWxkVG8gPSBuZXcgRGF0ZSgpLmFkZE1pbGxpc2Vjb25kcyhpbkxvY2tUaW1lb3V0TXMpO1xuICAgIGRlYnVnKFwiTG9jayAlcyBleHRlbmRlZCB0byAlc1wiLCBsb2NrSWQsIGNMb2NrLmhlbGRUbyk7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZXhpdExvY2sgPSBmdW5jdGlvbiAobG9ja0lkKSB7XG4gICAgZGVidWcoXCJleGl0TG9jayglcylcIiwgbG9ja0lkKTtcblxuICAgIGxldCBjTG9jayA9IHRoaXMuX2dldExvY2tCeUlkKGxvY2tJZCk7XG4gICAgdGhpcy5fbG9ja3NCeU5hbWUuZGVsZXRlKGNMb2NrLm5hbWUpO1xuICAgIHRoaXMuX2xvY2tzQnlJZC5kZWxldGUoY0xvY2suaWQpO1xuXG4gICAgZGVidWcoXCJVTkxPQ0tFRDogJXNcIiwgY0xvY2submFtZSk7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX2dldExvY2tCeUlkID0gZnVuY3Rpb24gKGxvY2tJZCkge1xuICAgIGxldCBjTG9jayA9IHRoaXMuX2xvY2tzQnlJZC5nZXQobG9ja0lkKTtcbiAgICBsZXQgbm93ID0gbmV3IERhdGUoKTtcbiAgICBpZiAoIWNMb2NrIHx8IG5vdy5jb21wYXJlVG8oY0xvY2suaGVsZFRvKSA+IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTG9jayBieSBpZCAnXCIgKyBsb2NrSWQgKyBcIicgZG9lc24ndCBleGlzdHMuXCIpO1xuICAgIH1cbiAgICByZXR1cm4gY0xvY2s7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuaXNSdW5uaW5nID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIGRlYnVnKFwiaXNSdW5uaW5nKCVzLCAlcylcIiwgd29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKTtcblxuICAgIHJldHVybiB0aGlzLl9pbnN0YW5jZURhdGEuaGFzKHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5wZXJzaXN0U3RhdGUgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICBkZWJ1ZyhcInBlcnNpc3RTdGF0ZSglailcIiwgc3RhdGUpO1xuXG4gICAgdGhpcy5faW5zdGFuY2VEYXRhLnNldChzcGVjU3RyaW5ncy5ob3N0aW5nLmRvdWJsZUtleXMoc3RhdGUud29ya2Zsb3dOYW1lLCBzdGF0ZS5pbnN0YW5jZUlkKSwgc3RhdGUpO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLmdldFJ1bm5pbmdJbnN0YW5jZUlkSGVhZGVyID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIGRlYnVnKFwiZ2V0UnVubmluZ0luc3RhbmNlSWRIZWFkZXIoJXMsICVzKVwiLCB3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpO1xuXG4gICAgbGV0IHN0YXRlID0gdGhpcy5fbG9hZFN0YXRlKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdXBkYXRlZE9uOiBzdGF0ZS51cGRhdGVkT24sXG4gICAgICAgIHdvcmtmbG93VmVyc2lvbjogc3RhdGUud29ya2Zsb3dWZXJzaW9uXG4gICAgfTtcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5sb2FkU3RhdGUgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgZGVidWcoXCJsb2FkU3RhdGUoJXMsICVzKVwiLCB3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpO1xuXG4gICAgcmV0dXJuIHRoaXMuX2xvYWRTdGF0ZSh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLnJlbW92ZVN0YXRlID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIGRlYnVnKFwicmVtb3ZlU3RhdGUoJXMsICVzKVwiLCB3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpO1xuXG4gICAgdGhpcy5faW5zdGFuY2VEYXRhLmRlbGV0ZShzcGVjU3RyaW5ncy5ob3N0aW5nLmRvdWJsZUtleXMod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSk7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX2xvYWRTdGF0ZSA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcbiAgICBsZXQgc3RhdGUgPSB0aGlzLl9pbnN0YW5jZURhdGEuZ2V0KHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcbiAgICBpZiAoIXN0YXRlKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuV29ya2Zsb3dOb3RGb3VuZEVycm9yKFwiSW5zdGFuY2UgZGF0YSBvZiB3b3JrZmxvdyAnXCIgKyB3b3JrZmxvd05hbWUgKyBcIicgYnkgaWQgJ1wiICsgaW5zdGFuY2VJZCArIFwiJyBpcyBub3QgZm91bmQuXCIpO1xuICAgIH1cbiAgICByZXR1cm4gc3RhdGU7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUubG9hZFByb21vdGVkUHJvcGVydGllcyA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcbiAgICBkZWJ1ZyhcImxvYWRQcm9tb3RlZFByb3BlcnRpZXMoJXMsICVzKVwiLCB3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpO1xuXG4gICAgbGV0IHN0YXRlID0gdGhpcy5faW5zdGFuY2VEYXRhLmdldChzcGVjU3RyaW5ncy5ob3N0aW5nLmRvdWJsZUtleXMod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSk7XG4gICAgcmV0dXJuIHN0YXRlID8gc3RhdGUucHJvbW90ZWRQcm9wZXJ0aWVzIDogbnVsbDtcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5nZXROZXh0V2FrZXVwYWJsZXMgPSBmdW5jdGlvbiAoY291bnQpIHtcbiAgICBkZWJ1ZyhcImdldE5leHRXYWtldXBhYmxlcyglZClcIiwgY291bnQpO1xuXG4gICAgbGV0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgbGV0IHJlc3VsdCA9IFtdO1xuICAgIGZvciAobGV0IGRhdGEgb2YgdGhpcy5faW5zdGFuY2VEYXRhLnZhbHVlcygpKSB7XG4gICAgICAgIGlmIChkYXRhLmFjdGl2ZURlbGF5cykge1xuICAgICAgICAgICAgZm9yIChsZXQgYWQgb2YgZGF0YS5hY3RpdmVEZWxheXMpIHtcbiAgICAgICAgICAgICAgICBpZiAoYWQuZGVsYXlUbyA8PSBub3cpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogZGF0YS5pbnN0YW5jZUlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiBkYXRhLndvcmtmbG93TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRPbjogZGF0YS51cGRhdGVkT24sXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVEZWxheToge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZE5hbWU6IGFkLm1ldGhvZE5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXlUbzogYWQuZGVsYXlUb1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmVzdWx0LnNvcnQoZnVuY3Rpb24gKGkxLCBpMikge1xuICAgICAgICBpZiAoaTEudXBkYXRlZE9uIDwgaTIudXBkYXRlZE9uKSB7XG4gICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoaTEudXBkYXRlZE9uID4gaTIudXBkYXRlZE9uKSB7XG4gICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChpMS5hY3RpdmVEZWxheS5kZWxheVRvIDwgaTIuYWN0aXZlRGVsYXkuZGVsYXlUbykge1xuICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGkxLmFjdGl2ZURlbGF5LmRlbGF5VG8gPiBpMi5hY3RpdmVEZWxheS5kZWxheVRvKSB7XG4gICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gMDtcbiAgICB9KTtcbiAgICByZXR1cm4gXy50YWtlKHJlc3VsdCwgY291bnQpO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBNZW1vcnlQZXJzaXN0ZW5jZTsiXX0=
