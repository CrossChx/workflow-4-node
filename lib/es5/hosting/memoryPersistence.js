"use strict";
"use strict";
var uuid = require('node-uuid');
require('date-utils');
var specStrings = require("../common/specStrings");
var InstIdPaths = require("./instIdPaths");
var is = require("../common/is");
function MemoryPersistence(log) {
  this._instanceData = new Map();
  this._locksById = new Map();
  this._locksByName = new Map();
  this._log = log === true;
}
MemoryPersistence.prototype.enterLock = function(lockName, inLockTimeoutMs) {
  if (this._log) {
    console.log("enterLock(" + lockName + ", " + inLockTimeoutMs + ");\n");
  }
  var now = new Date();
  var cLock = this._locksByName.get(lockName);
  if (is.undefined(cLock) || cLock.heldTo.compareTo(now) === -1) {
    var lockInfo = {
      id: uuid.v4(),
      name: lockName,
      heldTo: new Date().addMilliseconds(inLockTimeoutMs)
    };
    this._locksById.set(lockInfo.id, lockInfo);
    this._locksByName.set(lockInfo.name, lockInfo);
    return lockInfo;
  }
  return null;
};
MemoryPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  if (this._log) {
    console.log("renewLock(" + lockId + ", " + inLockTimeoutMs + ");\n");
  }
  var cLock = this._getLockById(lockId);
  cLock.heldTo = new Date().addMilliseconds(inLockTimeoutMs);
};
MemoryPersistence.prototype.exitLock = function(lockId) {
  if (this._log) {
    console.log("exitLock(" + lockId + ");\n");
  }
  var cLock = this._getLockById(lockId);
  this._locksByName.delete(cLock.name);
  this._locksById.delete(cLock.id);
};
MemoryPersistence.prototype._getLockById = function(lockId) {
  var cLock = this._locksById.get(lockId);
  var now = new Date();
  if (!cLock || now.compareTo(cLock.heldTo) > 0) {
    throw new Error("Lock by id '" + lockId + "' doesn't exists.");
  }
  return cLock;
};
MemoryPersistence.prototype.isRunning = function(workflowName, instanceId) {
  if (this._log) {
    console.log("isRunning(" + workflowName + ", " + instanceId + ");\n");
  }
  return this._instanceData.has(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
MemoryPersistence.prototype.persistState = function(state) {
  if (this._log) {
    console.log("persistState(" + state.workflowName + ", " + state.instanceId + ");\n");
  }
  this._instanceData.set(specStrings.hosting.doubleKeys(state.workflowName, state.instanceId), state);
};
MemoryPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  if (this._log) {
    console.log("getRunningInstanceIdHeader(" + workflowName + ", " + instanceId + ");\n");
  }
  var state = this._loadState(workflowName, instanceId);
  return {
    updatedOn: state.updatedOn,
    workflowVersion: state.workflowVersion
  };
};
MemoryPersistence.prototype.loadState = function(workflowName, instanceId) {
  if (this._log) {
    console.log("loadState(" + workflowName + ", " + instanceId + ");\n");
  }
  return this._loadState(workflowName, instanceId);
};
MemoryPersistence.prototype.removeState = function(workflowName, instanceId) {
  if (this._log) {
    console.log("removeState(" + workflowName + ", " + instanceId + ");\n");
  }
  this._instanceData.delete(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
MemoryPersistence.prototype._loadState = function(workflowName, instanceId) {
  var state = this._instanceData.get(specStrings.hosting.doubleKeys(workflowName, instanceId));
  if (!state) {
    throw new Error("Instance data of workflow '" + workflowName + "' by id '" + instanceId + "' is not found.");
  }
  return state;
};
MemoryPersistence.prototype.loadPromotedProperties = function(workflowName, instanceId) {
  if (this._log) {
    console.log("loadPromotedProperties(" + workflowName + ", " + instanceId + ");\n");
  }
  var state = this._instanceData.get(specStrings.hosting.doubleKeys(workflowName, instanceId));
  return state ? state.promotedProperties : null;
};
module.exports = MemoryPersistence;
//# sourceMappingURL=data:application/json;base64,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LENBQUM7RUFDdEY7QUFBQSxBQUVJLElBQUEsQ0FBQSxLQUFJLEVBQUksQ0FBQSxJQUFHLGNBQWMsSUFBSSxBQUFDLENBQUMsV0FBVSxRQUFRLFdBQVcsQUFBQyxDQUFDLFlBQVcsQ0FBRyxXQUFTLENBQUMsQ0FBQyxDQUFDO0FBQzVGLE9BQU8sQ0FBQSxLQUFJLEVBQUksQ0FBQSxLQUFJLG1CQUFtQixFQUFJLEtBQUcsQ0FBQztBQUNsRCxDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksa0JBQWdCLENBQUM7QUFBQSIsImZpbGUiOiJob3N0aW5nL21lbW9yeVBlcnNpc3RlbmNlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IHV1aWQgPSByZXF1aXJlKCdub2RlLXV1aWQnKTtcbnJlcXVpcmUoJ2RhdGUtdXRpbHMnKTtcbmxldCBzcGVjU3RyaW5ncyA9IHJlcXVpcmUoXCIuLi9jb21tb24vc3BlY1N0cmluZ3NcIik7XG5sZXQgSW5zdElkUGF0aHMgPSByZXF1aXJlKFwiLi9pbnN0SWRQYXRoc1wiKTtcbmxldCBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XG5cbmZ1bmN0aW9uIE1lbW9yeVBlcnNpc3RlbmNlKGxvZykge1xuICAgIHRoaXMuX2luc3RhbmNlRGF0YSA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLl9sb2Nrc0J5SWQgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5fbG9ja3NCeU5hbWUgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5fbG9nID0gbG9nID09PSB0cnVlO1xufVxuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZW50ZXJMb2NrID0gZnVuY3Rpb24gKGxvY2tOYW1lLCBpbkxvY2tUaW1lb3V0TXMpIHtcbiAgICBpZiAodGhpcy5fbG9nKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiZW50ZXJMb2NrKFwiICsgbG9ja05hbWUgKyBcIiwgXCIgKyBpbkxvY2tUaW1lb3V0TXMgKyBcIik7XFxuXCIpO1xuICAgIH1cblxuICAgIGxldCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGxldCBjTG9jayA9IHRoaXMuX2xvY2tzQnlOYW1lLmdldChsb2NrTmFtZSk7XG4gICAgaWYgKGlzLnVuZGVmaW5lZChjTG9jaykgfHwgY0xvY2suaGVsZFRvLmNvbXBhcmVUbyhub3cpID09PSAtMSkge1xuICAgICAgICBsZXQgbG9ja0luZm8gPSB7XG4gICAgICAgICAgICBpZDogdXVpZC52NCgpLFxuICAgICAgICAgICAgbmFtZTogbG9ja05hbWUsXG4gICAgICAgICAgICBoZWxkVG86IG5ldyBEYXRlKCkuYWRkTWlsbGlzZWNvbmRzKGluTG9ja1RpbWVvdXRNcylcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLl9sb2Nrc0J5SWQuc2V0KGxvY2tJbmZvLmlkLCBsb2NrSW5mbyk7XG4gICAgICAgIHRoaXMuX2xvY2tzQnlOYW1lLnNldChsb2NrSW5mby5uYW1lLCBsb2NrSW5mbyk7XG5cbiAgICAgICAgcmV0dXJuIGxvY2tJbmZvO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5yZW5ld0xvY2sgPSBmdW5jdGlvbiAobG9ja0lkLCBpbkxvY2tUaW1lb3V0TXMpIHtcbiAgICBpZiAodGhpcy5fbG9nKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwicmVuZXdMb2NrKFwiICsgbG9ja0lkICsgXCIsIFwiICsgaW5Mb2NrVGltZW91dE1zICsgXCIpO1xcblwiKTtcbiAgICB9XG5cbiAgICBsZXQgY0xvY2sgPSB0aGlzLl9nZXRMb2NrQnlJZChsb2NrSWQpO1xuICAgIGNMb2NrLmhlbGRUbyA9IG5ldyBEYXRlKCkuYWRkTWlsbGlzZWNvbmRzKGluTG9ja1RpbWVvdXRNcyk7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZXhpdExvY2sgPSBmdW5jdGlvbiAobG9ja0lkKSB7XG4gICAgaWYgKHRoaXMuX2xvZykge1xuICAgICAgICBjb25zb2xlLmxvZyhcImV4aXRMb2NrKFwiICsgbG9ja0lkICsgXCIpO1xcblwiKTtcbiAgICB9XG5cbiAgICBsZXQgY0xvY2sgPSB0aGlzLl9nZXRMb2NrQnlJZChsb2NrSWQpO1xuICAgIHRoaXMuX2xvY2tzQnlOYW1lLmRlbGV0ZShjTG9jay5uYW1lKTtcbiAgICB0aGlzLl9sb2Nrc0J5SWQuZGVsZXRlKGNMb2NrLmlkKTtcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5fZ2V0TG9ja0J5SWQgPSBmdW5jdGlvbiAobG9ja0lkKSB7XG4gICAgbGV0IGNMb2NrID0gdGhpcy5fbG9ja3NCeUlkLmdldChsb2NrSWQpO1xuICAgIGxldCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGlmICghY0xvY2sgfHwgbm93LmNvbXBhcmVUbyhjTG9jay5oZWxkVG8pID4gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJMb2NrIGJ5IGlkICdcIiArIGxvY2tJZCArIFwiJyBkb2Vzbid0IGV4aXN0cy5cIik7XG4gICAgfVxuICAgIHJldHVybiBjTG9jaztcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5pc1J1bm5pbmcgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgaWYgKHRoaXMuX2xvZykge1xuICAgICAgICBjb25zb2xlLmxvZyhcImlzUnVubmluZyhcIiArIHdvcmtmbG93TmFtZSArIFwiLCBcIiArIGluc3RhbmNlSWQgKyBcIik7XFxuXCIpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9pbnN0YW5jZURhdGEuaGFzKHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcbn07XG5cbk1lbW9yeVBlcnNpc3RlbmNlLnByb3RvdHlwZS5wZXJzaXN0U3RhdGUgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICBpZiAodGhpcy5fbG9nKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwicGVyc2lzdFN0YXRlKFwiICsgc3RhdGUud29ya2Zsb3dOYW1lICsgXCIsIFwiICsgc3RhdGUuaW5zdGFuY2VJZCArIFwiKTtcXG5cIik7XG4gICAgfVxuXG4gICAgdGhpcy5faW5zdGFuY2VEYXRhLnNldChzcGVjU3RyaW5ncy5ob3N0aW5nLmRvdWJsZUtleXMoc3RhdGUud29ya2Zsb3dOYW1lLCBzdGF0ZS5pbnN0YW5jZUlkKSwgc3RhdGUpO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLmdldFJ1bm5pbmdJbnN0YW5jZUlkSGVhZGVyID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIGlmICh0aGlzLl9sb2cpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJnZXRSdW5uaW5nSW5zdGFuY2VJZEhlYWRlcihcIiArIHdvcmtmbG93TmFtZSArIFwiLCBcIiArIGluc3RhbmNlSWQgKyBcIik7XFxuXCIpO1xuICAgIH1cblxuICAgIGxldCBzdGF0ZSA9IHRoaXMuX2xvYWRTdGF0ZSh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHVwZGF0ZWRPbjogc3RhdGUudXBkYXRlZE9uLFxuICAgICAgICB3b3JrZmxvd1ZlcnNpb246IHN0YXRlLndvcmtmbG93VmVyc2lvblxuICAgIH07XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUubG9hZFN0YXRlID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIGlmICh0aGlzLl9sb2cpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJsb2FkU3RhdGUoXCIgKyB3b3JrZmxvd05hbWUgKyBcIiwgXCIgKyBpbnN0YW5jZUlkICsgXCIpO1xcblwiKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fbG9hZFN0YXRlKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCk7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUucmVtb3ZlU3RhdGUgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgaWYgKHRoaXMuX2xvZykge1xuICAgICAgICBjb25zb2xlLmxvZyhcInJlbW92ZVN0YXRlKFwiICsgd29ya2Zsb3dOYW1lICsgXCIsIFwiICsgaW5zdGFuY2VJZCArIFwiKTtcXG5cIik7XG4gICAgfVxuXG4gICAgdGhpcy5faW5zdGFuY2VEYXRhLmRlbGV0ZShzcGVjU3RyaW5ncy5ob3N0aW5nLmRvdWJsZUtleXMod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSk7XG59O1xuXG5NZW1vcnlQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX2xvYWRTdGF0ZSA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcbiAgICBsZXQgc3RhdGUgPSB0aGlzLl9pbnN0YW5jZURhdGEuZ2V0KHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcbiAgICBpZiAoIXN0YXRlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkluc3RhbmNlIGRhdGEgb2Ygd29ya2Zsb3cgJ1wiICsgd29ya2Zsb3dOYW1lICsgXCInIGJ5IGlkICdcIiArIGluc3RhbmNlSWQgKyBcIicgaXMgbm90IGZvdW5kLlwiKTtcbiAgICB9XG4gICAgcmV0dXJuIHN0YXRlO1xufTtcblxuTWVtb3J5UGVyc2lzdGVuY2UucHJvdG90eXBlLmxvYWRQcm9tb3RlZFByb3BlcnRpZXMgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgaWYgKHRoaXMuX2xvZykge1xuICAgICAgICBjb25zb2xlLmxvZyhcImxvYWRQcm9tb3RlZFByb3BlcnRpZXMoXCIgKyB3b3JrZmxvd05hbWUgKyBcIiwgXCIgKyBpbnN0YW5jZUlkICsgXCIpO1xcblwiKTtcbiAgICB9XG5cbiAgICBsZXQgc3RhdGUgPSB0aGlzLl9pbnN0YW5jZURhdGEuZ2V0KHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcbiAgICByZXR1cm4gc3RhdGUgPyBzdGF0ZS5wcm9tb3RlZFByb3BlcnRpZXMgOiBudWxsO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBNZW1vcnlQZXJzaXN0ZW5jZTsiXX0=
