"use strict";
var Promise = require("bluebird");
var _ = require("lodash");
var mongodb = require("mongodb");
var MongoClient = mongodb.MongoClient;
var fast = require("fast.js");
function MongoDBPersistence(options) {
  if (!_.isObject(options))
    throw new TypeError("Object argument 'options' expected.");
  if (!_.isString(options.connection))
    throw new Error("Connection expected in the options.");
  this._options = _.extend({
    connectionOptions: {db: {native_parser: false}},
    stateCollectionName: "WFState",
    promotedPropertiesCollectionName: "WFPromotedProperties",
    locksCollectionName: "WFLocks",
    stringifyState: true
  }, options);
  this._db = null;
  this._stateCollection = null;
  this._promotedPropertiesCollection = null;
  this._locksCollection = null;
  this._connectedAndInitialized = false;
}
Object.defineProperties(MongoDBPersistence.prototype, {options: {get: function() {
      return this._options;
    }}});
MongoDBPersistence.prototype._connectAndInit = function() {
  var self = this;
  return new Promise(function(resolve, reject) {
    try {
      if (!self._connectedAndInitialized) {
        MongoClient.connect(self.options.connection, self.options.connectionOptions, function(e, db) {
          if (e) {
            reject(e);
            return ;
          }
          var getColl = function(name) {
            return new Promise(function(gcresolve, gcreject) {
              db.createCollection(name, function(e, coll) {
                if (e)
                  gcreject(e);
                else
                  gcresolve(coll);
              });
            });
          };
          Promise.all([getColl(self.options.stateCollectionName).then(function(coll) {
            self._stateCollection = coll;
          }), getColl(self.options.locksCollectionName).then(function(coll) {
            self._locksCollection = coll;
          }), getColl(self.options.promotedPropertiesCollectionName).then(function(coll) {
            self._promotedPropertiesCollection = coll;
          })]).then(function() {
            return self._ensureIndexes();
          }).then(function() {
            self._db = db;
            self._connectedAndInitialized = true;
            resolve();
          }, function(e) {
            self._stateCollection = self._locksCollection = self._promotedPropertiesCollection = null;
            reject(e || new Error("Index create error."));
          });
        });
      } else {
        resolve();
      }
    } catch (e) {
      reject(e);
    }
  });
};
MongoDBPersistence.prototype._ensureIndexes = function() {
  var self = this;
  return Promise.all([new Promise(function(resolve, reject) {
    self._locksCollection.ensureIndex({name: 1}, {
      w: 1,
      unique: true
    }, function(e) {
      if (e)
        reject(e);
      else
        resolve();
    });
  }), new Promise(function(resolve, reject) {
    self._locksCollection.ensureIndex({heldTo: 1}, {
      w: 1,
      unique: false
    }, function(e) {
      if (e)
        reject(e);
      else
        resolve();
    });
  }), new Promise(function(resolve, reject) {
    self._stateCollection.ensureIndex({
      workflowName: 1,
      instanceId: 1
    }, {
      w: 1,
      unique: true
    }, function(e) {
      if (e)
        reject(e);
      else
        resolve();
    });
  }), new Promise(function(resolve, reject) {
    self._promotedPropertiesCollection.ensureIndex({
      workflowName: 1,
      instanceId: 1
    }, {
      w: 1,
      unique: true
    }, function(e) {
      if (e)
        reject(e);
      else
        resolve();
    });
  })]);
};
MongoDBPersistence.prototype.close = function() {
  var self = this;
  return new Promise(function(resolve, reject) {
    if (self._connectedAndInitialized) {
      try {
        self._db.close(function(err) {
          if (err) {
            reject(err);
            return ;
          }
          self._connectedAndInitialized = false;
          self._db = self._stateCollection = self._locksCollection = self._promotedPropertiesCollection = null;
          resolve();
        });
      } catch (e) {
        reject(e);
      }
    } else {
      resolve();
    }
  });
};
MongoDBPersistence.prototype.enterLock = function(lockName, inLockTimeoutMs) {
  var self = this;
  var now = new Date();
  return self._connectAndInit().then(function() {
    return self._removeOldLocks();
  }).then(function() {
    return new Promise(function(resolve, reject) {
      self._locksCollection.insertOne({
        name: lockName,
        heldTo: now.addMilliseconds(inLockTimeoutMs)
      }, {w: 1}, function(e, result) {
        if (e) {
          if (e.toString().indexOf("E11000") === -1) {
            reject(e);
            return ;
          }
          resolve(null);
          return ;
        }
        if (result.insertedCount == 0) {
          resolve(null);
          return ;
        }
        resolve({
          id: result.ops[0]._id,
          name: result.ops[0].name,
          heldTo: result.ops[0].heldTo
        });
      });
    });
  });
};
MongoDBPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  var self = this;
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      var now = new Date();
      self._locksCollection.update({
        _id: lockId,
        heldTo: {$lte: now}
      }, {$set: {heldTo: now.addMilliseconds(inLockTimeoutMs)}}, {w: 1}, function(e, r) {
        if (e) {
          reject(e);
          return ;
        }
        if (r.nModified === 0) {
          reject(new Error("Lock by id '" + lockId + "' doesn't exists or not held."));
          return ;
        }
        resolve();
      });
    });
  });
};
MongoDBPersistence.prototype.exitLock = function(lockId) {
  var self = this;
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      self._locksCollection.remove({_id: lockId}, {w: 1}, function(e) {
        if (e)
          reject(e);
        else
          resolve();
      });
    });
  });
};
MongoDBPersistence.prototype._removeOldLocks = function() {
  var self = this;
  var now = new Date();
  return new Promise(function(resolve, reject) {
    self._locksCollection.remove({heldTo: {$lt: now}}, {w: 1}, function(e) {
      if (e)
        reject(e);
      else
        resolve();
    });
  });
};
MongoDBPersistence.prototype.isRunning = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      self._stateCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: 1,
        fields: {_id: 1}
      }, function(e, id) {
        if (e) {
          reject(e);
          return ;
        }
        resolve(id ? true : false);
      });
    });
  });
};
MongoDBPersistence.prototype.persistState = function(state) {
  var self = this;
  var instanceId = state.instanceId.toString();
  return self._connectAndInit().then(function() {
    function persistState() {
      return new Promise(function(resolve, reject) {
        self._stateCollection.update({
          workflowName: state.workflowName,
          instanceId: instanceId
        }, {
          workflowName: state.workflowName,
          instanceId: instanceId,
          workflowVersion: state.workflowVersion,
          createdOn: state.createdOn,
          updatedOn: state.updatedOn,
          state: self.options.stringifyState ? JSON.stringify(state.state) : state.state
        }, {
          w: 1,
          upsert: true
        }, function(e) {
          if (e)
            reject(e);
          else
            resolve();
        });
      });
    }
    if (state.promotedProperties) {
      return Promise.all([persistState(), new Promise(function(resolve, reject) {
        self._promotedPropertiesCollection.update({
          workflowName: state.workflowName,
          instanceId: instanceId
        }, {
          workflowName: state.workflowName,
          instanceId: instanceId,
          workflowVersion: state.workflowVersion,
          createdOn: state.createdOn,
          updatedOn: state.updatedOn,
          properties: state.promotedProperties
        }, {
          w: 1,
          upsert: true
        }, function(e) {
          if (e)
            reject(e);
          else
            resolve();
        });
      })]);
    } else {
      return persistState();
    }
  });
};
MongoDBPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      self._stateCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: 1,
        fields: {
          updatedOn: 1,
          workflowVersion: 1
        }
      }, function(e, result) {
        if (e) {
          reject(e);
          return ;
        }
        resolve(result);
      });
    });
  });
};
MongoDBPersistence.prototype.loadState = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      self._stateCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: 1,
        fields: {_id: false}
      }, function(e, r) {
        if (e) {
          reject(e);
          return ;
        }
        if (self.options.stringifyState)
          r.state = JSON.parse(r.state);
        resolve(r);
      });
    });
  });
};
MongoDBPersistence.prototype.removeState = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    function remove() {
      return new Promise(function(resolve, reject) {
        self._stateCollection.remove({
          workflowName: workflowName,
          instanceId: instanceId
        }, {w: 1}, function(e) {
          if (e)
            reject(e);
          else
            resolve();
        });
      });
    }
    if (self.options.enablePromotions) {
      return Promise.all([remove(), new Promise(function(resolve, reject) {
        self._promotedPropertiesCollection.remove({
          workflowName: workflowName,
          instanceId: instanceId
        }, {w: 1}, function(e) {
          if (e)
            reject(e);
          else
            resolve();
        });
      })]);
    } else {
      return remove();
    }
  });
};
MongoDBPersistence.prototype.loadPromotedProperties = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      self._promotedPropertiesCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: 1,
        fields: {properties: 1}
      }, function(e, pp) {
        if (e) {
          reject(e);
          return ;
        }
        resolve(pp ? pp.properties : null);
      });
    });
  });
};
module.exports = MongoDBPersistence;
//# sourceMappingURL=data:application/json;base64,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LENBQUEsTUFBSyxDQUFHO0FBQzFDLFNBQUcsOEJBQThCLFFBQVEsQUFBQyxDQUN0QztBQUNJLG1CQUFXLENBQUcsYUFBVztBQUN6QixpQkFBUyxDQUFHLFdBQVM7QUFBQSxNQUN6QixDQUNBO0FBQ0ksUUFBQSxDQUFHLEVBQUE7QUFDSCxhQUFLLENBQUcsRUFDSixVQUFTLENBQUcsRUFBQSxDQUNoQjtBQUFBLE1BQ0osQ0FDQSxVQUFVLENBQUEsQ0FBRyxDQUFBLEVBQUMsQ0FBRztBQUNiLFdBQUksQ0FBQSxDQUFHO0FBQ0gsZUFBSyxBQUFDLENBQUMsQ0FBQSxDQUFDLENBQUM7QUFDVCxpQkFBTTtRQUNWO0FBQUEsQUFFQSxjQUFNLEFBQUMsQ0FBQyxFQUFDLEVBQUksQ0FBQSxFQUFDLFdBQVcsRUFBSSxLQUFHLENBQUMsQ0FBQztNQUN0QyxDQUFDLENBQUM7SUFDVixDQUFDLENBQUM7RUFDTixDQUFDLENBQUM7QUFDVixDQUFBO0FBRUEsS0FBSyxRQUFRLEVBQUksbUJBQWlCLENBQUM7QUFDbkMiLCJmaWxlIjoiaG9zdGluZy9tb25nb0RCL21vbmdvREJQZXJzaXN0ZW5jZS5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsidmFyIFByb21pc2UgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XHJcbnZhciBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcclxudmFyIG1vbmdvZGIgPSByZXF1aXJlKFwibW9uZ29kYlwiKTtcclxudmFyIE1vbmdvQ2xpZW50ID0gbW9uZ29kYi5Nb25nb0NsaWVudDtcclxudmFyIGZhc3QgPSByZXF1aXJlKFwiZmFzdC5qc1wiKTtcclxuXHJcbmZ1bmN0aW9uIE1vbmdvREJQZXJzaXN0ZW5jZShvcHRpb25zKSB7XHJcbiAgICBpZiAoIV8uaXNPYmplY3Qob3B0aW9ucykpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJPYmplY3QgYXJndW1lbnQgJ29wdGlvbnMnIGV4cGVjdGVkLlwiKTtcclxuICAgIGlmICghXy5pc1N0cmluZyhvcHRpb25zLmNvbm5lY3Rpb24pKSB0aHJvdyBuZXcgRXJyb3IoXCJDb25uZWN0aW9uIGV4cGVjdGVkIGluIHRoZSBvcHRpb25zLlwiKTtcclxuICAgIHRoaXMuX29wdGlvbnMgPSBfLmV4dGVuZChcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGNvbm5lY3Rpb25PcHRpb25zOiB7ZGI6IHtuYXRpdmVfcGFyc2VyOiBmYWxzZX19LFxyXG4gICAgICAgICAgICBzdGF0ZUNvbGxlY3Rpb25OYW1lOiBcIldGU3RhdGVcIixcclxuICAgICAgICAgICAgcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbk5hbWU6IFwiV0ZQcm9tb3RlZFByb3BlcnRpZXNcIixcclxuICAgICAgICAgICAgbG9ja3NDb2xsZWN0aW9uTmFtZTogXCJXRkxvY2tzXCIsXHJcbiAgICAgICAgICAgIHN0cmluZ2lmeVN0YXRlOiB0cnVlXHJcbiAgICAgICAgfSxcclxuICAgICAgICBvcHRpb25zKTtcclxuICAgIHRoaXMuX2RiID0gbnVsbDtcclxuICAgIHRoaXMuX3N0YXRlQ29sbGVjdGlvbiA9IG51bGw7XHJcbiAgICB0aGlzLl9wcm9tb3RlZFByb3BlcnRpZXNDb2xsZWN0aW9uID0gbnVsbDtcclxuICAgIHRoaXMuX2xvY2tzQ29sbGVjdGlvbiA9IG51bGw7XHJcbiAgICB0aGlzLl9jb25uZWN0ZWRBbmRJbml0aWFsaXplZCA9IGZhbHNlO1xyXG59XHJcblxyXG5PYmplY3QuZGVmaW5lUHJvcGVydGllcyhcclxuICAgIE1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUsXHJcbiAgICB7XHJcbiAgICAgICAgb3B0aW9uczoge1xyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9vcHRpb25zO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLl9jb25uZWN0QW5kSW5pdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZShcclxuICAgICAgICBmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXNlbGYuX2Nvbm5lY3RlZEFuZEluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTW9uZ29DbGllbnQuY29ubmVjdChzZWxmLm9wdGlvbnMuY29ubmVjdGlvbiwgc2VsZi5vcHRpb25zLmNvbm5lY3Rpb25PcHRpb25zLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSwgZGIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0Q29sbCA9IGZ1bmN0aW9uIChuYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChnY3Jlc29sdmUsIGdjcmVqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRiLmNyZWF0ZUNvbGxlY3Rpb24obmFtZSwgZnVuY3Rpb24gKGUsIGNvbGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSBnY3JlamVjdChlKTsgZWxzZSBnY3Jlc29sdmUoY29sbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBQcm9taXNlLmFsbChbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0Q29sbChzZWxmLm9wdGlvbnMuc3RhdGVDb2xsZWN0aW9uTmFtZSkudGhlbihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGNvbGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N0YXRlQ29sbGVjdGlvbiA9IGNvbGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldENvbGwoc2VsZi5vcHRpb25zLmxvY2tzQ29sbGVjdGlvbk5hbWUpLnRoZW4oXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChjb2xsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9sb2Nrc0NvbGxlY3Rpb24gPSBjb2xsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRDb2xsKHNlbGYub3B0aW9ucy5wcm9tb3RlZFByb3BlcnRpZXNDb2xsZWN0aW9uTmFtZSkudGhlbihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGNvbGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Byb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb24gPSBjb2xsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbnN1cmVJbmRleGVzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2RiID0gZGI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2Nvbm5lY3RlZEFuZEluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3RhdGVDb2xsZWN0aW9uID0gc2VsZi5fbG9ja3NDb2xsZWN0aW9uID0gc2VsZi5fcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbiA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlIHx8IG5ldyBFcnJvcihcIkluZGV4IGNyZWF0ZSBlcnJvci5cIikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX2Vuc3VyZUluZGV4ZXMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFtcclxuICAgICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgIHNlbGYuX2xvY2tzQ29sbGVjdGlvbi5lbnN1cmVJbmRleCh7bmFtZTogMX0sIHt3OiAxLCB1bmlxdWU6IHRydWV9LCBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUpIHJlamVjdChlKTsgZWxzZSByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgc2VsZi5fbG9ja3NDb2xsZWN0aW9uLmVuc3VyZUluZGV4KHtoZWxkVG86IDF9LCB7dzogMSwgdW5pcXVlOiBmYWxzZX0sIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZSkgcmVqZWN0KGUpOyBlbHNlIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICBzZWxmLl9zdGF0ZUNvbGxlY3Rpb24uZW5zdXJlSW5kZXgoe3dvcmtmbG93TmFtZTogMSwgaW5zdGFuY2VJZDogMX0sIHt3OiAxLCB1bmlxdWU6IHRydWV9LCBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUpIHJlamVjdChlKTsgZWxzZSByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgc2VsZi5fcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbi5lbnN1cmVJbmRleCh7d29ya2Zsb3dOYW1lOiAxLCBpbnN0YW5jZUlkOiAxfSwge1xyXG4gICAgICAgICAgICAgICAgdzogMSxcclxuICAgICAgICAgICAgICAgIHVuaXF1ZTogdHJ1ZVxyXG4gICAgICAgICAgICB9LCBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUpIHJlamVjdChlKTsgZWxzZSByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcbiAgICBdKTtcclxufVxyXG5cclxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5jbG9zZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgaWYgKHNlbGYuX2Nvbm5lY3RlZEFuZEluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9kYi5jbG9zZShmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBzZWxmLl9jb25uZWN0ZWRBbmRJbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuX2RiID0gc2VsZi5fc3RhdGVDb2xsZWN0aW9uID0gc2VsZi5fbG9ja3NDb2xsZWN0aW9uID0gc2VsZi5fcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbiA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIHJlamVjdChlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59XHJcblxyXG4vLyBMT0NLSU5HXHJcbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZW50ZXJMb2NrID0gZnVuY3Rpb24gKGxvY2tOYW1lLCBpbkxvY2tUaW1lb3V0TXMpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpO1xyXG5cclxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXHJcbiAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gc2VsZi5fcmVtb3ZlT2xkTG9ja3MoKTtcclxuICAgICAgICB9KS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX2xvY2tzQ29sbGVjdGlvbi5pbnNlcnRPbmUoXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBsb2NrTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGVsZFRvOiBub3cuYWRkTWlsbGlzZWNvbmRzKGluTG9ja1RpbWVvdXRNcylcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHt3OiAxfSxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSwgcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS50b1N0cmluZygpLmluZGV4T2YoXCJFMTEwMDBcIikgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpOyAvLyBTb21lIE1vbmdvREIgZXJyb3JcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpOyAvLyBJdCdzIGhlbGQuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuaW5zZXJ0ZWRDb3VudCA9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpOyAvLyBJdCdzIGhlbGQuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHJlc3VsdC5vcHNbMF0uX2lkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogcmVzdWx0Lm9wc1swXS5uYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVsZFRvOiByZXN1bHQub3BzWzBdLmhlbGRUb1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUucmVuZXdMb2NrID0gZnVuY3Rpb24gKGxvY2tJZCwgaW5Mb2NrVGltZW91dE1zKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fbG9ja3NDb2xsZWN0aW9uLnVwZGF0ZShcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9pZDogbG9ja0lkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWxkVG86IHskbHRlOiBub3d9XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzZXQ6IHtoZWxkVG86IG5vdy5hZGRNaWxsaXNlY29uZHMoaW5Mb2NrVGltZW91dE1zKX1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHt3OiAxfSxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSwgcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyLm5Nb2RpZmllZCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihcIkxvY2sgYnkgaWQgJ1wiICsgbG9ja0lkICsgXCInIGRvZXNuJ3QgZXhpc3RzIG9yIG5vdCBoZWxkLlwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxufVxyXG5cclxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5leGl0TG9jayA9IGZ1bmN0aW9uIChsb2NrSWQpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX2xvY2tzQ29sbGVjdGlvbi5yZW1vdmUoXHJcbiAgICAgICAgICAgICAgICAgICAge19pZDogbG9ja0lkfSxcclxuICAgICAgICAgICAgICAgICAgICB7dzogMX0sXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHJlamVjdChlKTsgZWxzZSByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG59O1xyXG5cclxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5fcmVtb3ZlT2xkTG9ja3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICB2YXIgbm93ID0gbmV3IERhdGUoKTtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgc2VsZi5fbG9ja3NDb2xsZWN0aW9uLnJlbW92ZShcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgaGVsZFRvOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGx0OiBub3dcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAge3c6IDF9LFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUpIHJlamVjdChlKTsgZWxzZSByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbi8vIFNUQVRFXHJcblxyXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLmlzUnVubmluZyA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICBpbnN0YW5jZUlkID0gaW5zdGFuY2VJZC50b1N0cmluZygpO1xyXG5cclxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXHJcbiAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fc3RhdGVDb2xsZWN0aW9uLmZpbmRPbmUoXHJcbiAgICAgICAgICAgICAgICAgICAge3dvcmtmbG93TmFtZTogd29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkOiBpbnN0YW5jZUlkfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHc6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczoge19pZDogMX1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlLCBpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaWQgPyB0cnVlIDogZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxufVxyXG5cclxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5wZXJzaXN0U3RhdGUgPSBmdW5jdGlvbiAoc3RhdGUpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICB2YXIgaW5zdGFuY2VJZCA9IHN0YXRlLmluc3RhbmNlSWQudG9TdHJpbmcoKTtcclxuXHJcbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgZnVuY3Rpb24gcGVyc2lzdFN0YXRlKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLl9zdGF0ZUNvbGxlY3Rpb24udXBkYXRlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHN0YXRlLndvcmtmbG93TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiBzdGF0ZS53b3JrZmxvd05hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZUlkOiBpbnN0YW5jZUlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dWZXJzaW9uOiBzdGF0ZS53b3JrZmxvd1ZlcnNpb24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkT246IHN0YXRlLmNyZWF0ZWRPbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRPbjogc3RhdGUudXBkYXRlZE9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGU6IHNlbGYub3B0aW9ucy5zdHJpbmdpZnlTdGF0ZSA/IEpTT04uc3RyaW5naWZ5KHN0YXRlLnN0YXRlKSA6IHN0YXRlLnN0YXRlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHc6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cHNlcnQ6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSByZWplY3QoZSk7IGVsc2UgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoc3RhdGUucHJvbW90ZWRQcm9wZXJ0aWVzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoXHJcbiAgICAgICAgICAgICAgICAgICAgW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwZXJzaXN0U3RhdGUoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbi51cGRhdGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHN0YXRlLndvcmtmbG93TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGFuY2VJZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHN0YXRlLndvcmtmbG93TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGFuY2VJZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dWZXJzaW9uOiBzdGF0ZS53b3JrZmxvd1ZlcnNpb24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZWRPbjogc3RhdGUuY3JlYXRlZE9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkT246IHN0YXRlLnVwZGF0ZWRPbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllczogc3RhdGUucHJvbW90ZWRQcm9wZXJ0aWVzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHc6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwc2VydDogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHJlamVjdChlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcGVyc2lzdFN0YXRlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxufVxyXG5cclxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5nZXRSdW5uaW5nSW5zdGFuY2VJZEhlYWRlciA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICBpbnN0YW5jZUlkID0gaW5zdGFuY2VJZC50b1N0cmluZygpO1xyXG5cclxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXHJcbiAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fc3RhdGVDb2xsZWN0aW9uLmZpbmRPbmUoXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHdvcmtmbG93TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGFuY2VJZFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3OiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRPbjogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93VmVyc2lvbjogMVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSwgcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUubG9hZFN0YXRlID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIGluc3RhbmNlSWQgPSBpbnN0YW5jZUlkLnRvU3RyaW5nKCk7XHJcblxyXG4gICAgcmV0dXJuIHNlbGYuX2Nvbm5lY3RBbmRJbml0KCkudGhlbihcclxuICAgICAgICBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9zdGF0ZUNvbGxlY3Rpb24uZmluZE9uZShcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93TmFtZTogd29ya2Zsb3dOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZUlkOiBpbnN0YW5jZUlkXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHc6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczoge19pZDogZmFsc2V9XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSwgcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnN0cmluZ2lmeVN0YXRlKSByLnN0YXRlID0gSlNPTi5wYXJzZShyLnN0YXRlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUucmVtb3ZlU3RhdGUgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgaW5zdGFuY2VJZCA9IGluc3RhbmNlSWQudG9TdHJpbmcoKTtcclxuXHJcbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLl9zdGF0ZUNvbGxlY3Rpb24ucmVtb3ZlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHdvcmtmbG93TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge3c6IDF9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHJlamVjdChlKTsgZWxzZSByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuZW5hYmxlUHJvbW90aW9ucykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFxyXG4gICAgICAgICAgICAgICAgICAgIFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Byb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb24ucmVtb3ZlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiB3b3JrZmxvd05hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHt3OiAxfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSkgcmVqZWN0KGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICBdKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZW1vdmUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG59XHJcblxyXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLmxvYWRQcm9tb3RlZFByb3BlcnRpZXMgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgaW5zdGFuY2VJZCA9IGluc3RhbmNlSWQudG9TdHJpbmcoKTtcclxuXHJcbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX3Byb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb24uZmluZE9uZShcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93TmFtZTogd29ya2Zsb3dOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZUlkOiBpbnN0YW5jZUlkXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHc6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllczogMVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSwgcHApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShwcCA/IHBwLnByb3BlcnRpZXMgOiBudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0gTW9uZ29EQlBlcnNpc3RlbmNlO1xyXG4iXX0=
