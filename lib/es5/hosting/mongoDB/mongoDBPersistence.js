"use strict";
"use strict";
var Bluebird = require("bluebird");
var _ = require("lodash");
var mongodb = require("mongodb");
var MongoClient = mongodb.MongoClient;
function MongoDBPersistence(options) {
  if (!_.isObject(options)) {
    throw new TypeError("Object argument 'options' expected.");
  }
  if (!_.isString(options.connection)) {
    throw new Error("Connection expected in the options.");
  }
  this._options = _.extend({
    connectionOptions: {db: {native_parser: false}},
    stateCollectionName: "WFState",
    promotedPropertiesCollectionName: "WFPromotedProperties",
    locksCollectionName: "WFLocks",
    stringifyState: true
  }, options);
  this._db = null;
  this._stateCollection = null;
  this._promotedPropertiesCollection = null;
  this._locksCollection = null;
  this._connectedAndInitialized = false;
}
Object.defineProperties(MongoDBPersistence.prototype, {options: {get: function() {
      return this._options;
    }}});
MongoDBPersistence.prototype._connectAndInit = function() {
  var self = this;
  return new Bluebird(function(resolve, reject) {
    try {
      if (!self._connectedAndInitialized) {
        MongoClient.connect(self.options.connection, self.options.connectionOptions, function(e, db) {
          if (e) {
            reject(e);
            return ;
          }
          var getColl = function(name) {
            return new Bluebird(function(gcresolve, gcreject) {
              db.createCollection(name, function(gce, gccoll) {
                if (gce) {
                  gcreject(gce);
                } else {
                  gcresolve(gccoll);
                }
              });
            });
          };
          Bluebird.all([getColl(self.options.stateCollectionName).then(function(coll) {
            self._stateCollection = coll;
          }), getColl(self.options.locksCollectionName).then(function(coll) {
            self._locksCollection = coll;
          }), getColl(self.options.promotedPropertiesCollectionName).then(function(coll) {
            self._promotedPropertiesCollection = coll;
          })]).then(function() {
            return self._ensureIndexes();
          }).then(function() {
            self._db = db;
            self._connectedAndInitialized = true;
            resolve();
          }, function(err) {
            self._stateCollection = self._locksCollection = self._promotedPropertiesCollection = null;
            reject(err || new Error("Index create error."));
          });
        });
      } else {
        resolve();
      }
    } catch (e) {
      reject(e);
    }
  });
};
MongoDBPersistence.prototype._ensureIndexes = function() {
  var self = this;
  return Bluebird.all([new Bluebird(function(resolve, reject) {
    self._locksCollection.ensureIndex({name: 1}, {
      w: "majority",
      unique: true
    }, function(e) {
      if (e) {
        reject(e);
      } else {
        resolve();
      }
    });
  }), new Bluebird(function(resolve, reject) {
    self._locksCollection.ensureIndex({heldTo: 1}, {
      w: "majority",
      unique: false
    }, function(e) {
      if (e) {
        reject(e);
      } else {
        resolve();
      }
    });
  }), new Bluebird(function(resolve, reject) {
    self._stateCollection.ensureIndex({
      workflowName: 1,
      instanceId: 1
    }, {
      w: "majority",
      unique: true
    }, function(e) {
      if (e) {
        reject(e);
      } else {
        resolve();
      }
    });
  }), new Bluebird(function(resolve, reject) {
    self._promotedPropertiesCollection.ensureIndex({
      workflowName: 1,
      instanceId: 1
    }, {
      w: "majority",
      unique: true
    }, function(e) {
      if (e) {
        reject(e);
      } else {
        resolve();
      }
    });
  })]);
};
MongoDBPersistence.prototype.close = function() {
  var self = this;
  return new Bluebird(function(resolve, reject) {
    if (self._connectedAndInitialized) {
      try {
        self._db.close(function(err) {
          if (err) {
            reject(err);
            return ;
          }
          self._connectedAndInitialized = false;
          self._db = self._stateCollection = self._locksCollection = self._promotedPropertiesCollection = null;
          resolve();
        });
      } catch (e) {
        reject(e);
      }
    } else {
      resolve();
    }
  });
};
MongoDBPersistence.prototype.enterLock = function(lockName, inLockTimeoutMs) {
  var self = this;
  var now = new Date();
  return self._connectAndInit().then(function() {
    return self._removeOldLocks();
  }).then(function() {
    return new Bluebird(function(resolve, reject) {
      self._locksCollection.insertOne({
        name: lockName,
        heldTo: now.addMilliseconds(inLockTimeoutMs)
      }, {w: "majority"}, function(e, result) {
        if (e) {
          if (e.toString().indexOf("E11000") === -1) {
            reject(e);
            return ;
          }
          resolve(null);
          return ;
        }
        if (result.insertedCount === 0) {
          resolve(null);
          return ;
        }
        resolve({
          id: result.ops[0]._id,
          name: result.ops[0].name,
          heldTo: result.ops[0].heldTo
        });
      });
    });
  });
};
MongoDBPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  var self = this;
  return self._connectAndInit().then(function() {
    return new Bluebird(function(resolve, reject) {
      var now = new Date();
      self._locksCollection.update({
        _id: lockId,
        heldTo: {$lte: now}
      }, {$set: {heldTo: now.addMilliseconds(inLockTimeoutMs)}}, {w: "majority"}, function(e, r) {
        if (e) {
          reject(e);
          return ;
        }
        if (r.nModified === 0) {
          reject(new Error("Lock by id '" + lockId + "' doesn't exists or not held."));
          return ;
        }
        resolve();
      });
    });
  });
};
MongoDBPersistence.prototype.exitLock = function(lockId) {
  var self = this;
  return self._connectAndInit().then(function() {
    return new Bluebird(function(resolve, reject) {
      self._locksCollection.remove({_id: lockId}, {w: "majority"}, function(e) {
        if (e) {
          reject(e);
        } else {
          resolve();
        }
      });
    });
  });
};
MongoDBPersistence.prototype._removeOldLocks = function() {
  var self = this;
  var now = new Date();
  return new Bluebird(function(resolve, reject) {
    self._locksCollection.remove({heldTo: {$lt: now}}, {w: "majority"}, function(e) {
      if (e) {
        reject(e);
      } else {
        resolve();
      }
    });
  });
};
MongoDBPersistence.prototype.isRunning = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Bluebird(function(resolve, reject) {
      self._stateCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: "majority",
        fields: {_id: 1}
      }, function(e, id) {
        if (e) {
          reject(e);
          return ;
        }
        resolve(id ? true : false);
      });
    });
  });
};
MongoDBPersistence.prototype.persistState = function(state) {
  var self = this;
  var instanceId = state.instanceId.toString();
  return self._connectAndInit().then(function() {
    function persistState() {
      return new Bluebird(function(resolve, reject) {
        self._stateCollection.update({
          workflowName: state.workflowName,
          instanceId: instanceId
        }, {
          workflowName: state.workflowName,
          instanceId: instanceId,
          workflowVersion: state.workflowVersion,
          createdOn: state.createdOn,
          updatedOn: state.updatedOn,
          state: self.options.stringifyState ? JSON.stringify(state.state) : state.state
        }, {
          w: "majority",
          upsert: true
        }, function(e) {
          if (e) {
            reject(e);
          } else {
            resolve();
          }
        });
      });
    }
    if (state.promotedProperties) {
      return Bluebird.all([persistState(), new Bluebird(function(resolve, reject) {
        self._promotedPropertiesCollection.update({
          workflowName: state.workflowName,
          instanceId: instanceId
        }, {
          workflowName: state.workflowName,
          instanceId: instanceId,
          workflowVersion: state.workflowVersion,
          createdOn: state.createdOn,
          updatedOn: state.updatedOn,
          properties: state.promotedProperties
        }, {
          w: "majority",
          upsert: true
        }, function(e) {
          if (e) {
            reject(e);
          } else {
            resolve();
          }
        });
      })]);
    } else {
      return persistState();
    }
  });
};
MongoDBPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Bluebird(function(resolve, reject) {
      self._stateCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: "majority",
        fields: {
          updatedOn: 1,
          workflowVersion: 1
        }
      }, function(e, result) {
        if (e) {
          reject(e);
          return ;
        }
        resolve(result);
      });
    });
  });
};
MongoDBPersistence.prototype.loadState = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Bluebird(function(resolve, reject) {
      self._stateCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: "majority",
        fields: {_id: false}
      }, function(e, r) {
        if (e) {
          reject(e);
          return ;
        }
        if (self.options.stringifyState) {
          r.state = JSON.parse(r.state);
        }
        resolve(r);
      });
    });
  });
};
MongoDBPersistence.prototype.removeState = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    function remove() {
      return new Bluebird(function(resolve, reject) {
        self._stateCollection.remove({
          workflowName: workflowName,
          instanceId: instanceId
        }, {w: "majority"}, function(e) {
          if (e) {
            reject(e);
          } else {
            resolve();
          }
        });
      });
    }
    if (self.options.enablePromotions) {
      return Bluebird.all([remove(), new Bluebird(function(resolve, reject) {
        self._promotedPropertiesCollection.remove({
          workflowName: workflowName,
          instanceId: instanceId
        }, {w: "majority"}, function(e) {
          if (e) {
            reject(e);
          } else {
            resolve();
          }
        });
      })]);
    } else {
      return remove();
    }
  });
};
MongoDBPersistence.prototype.loadPromotedProperties = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Bluebird(function(resolve, reject) {
      self._promotedPropertiesCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: "majority",
        fields: {properties: 1}
      }, function(e, pp) {
        if (e) {
          reject(e);
          return ;
        }
        resolve(pp ? pp.properties : null);
      });
    });
  });
};
module.exports = MongoDBPersistence;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vbmdvREJQZXJzaXN0ZW5jZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLFdBQVcsQ0FBQztBQUVaLEFBQUksRUFBQSxDQUFBLFFBQU8sRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFVBQVMsQ0FBQyxDQUFDO0FBQ2xDLEFBQUksRUFBQSxDQUFBLENBQUEsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0FBQ3pCLEFBQUksRUFBQSxDQUFBLE9BQU0sRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFNBQVEsQ0FBQyxDQUFDO0FBQ2hDLEFBQUksRUFBQSxDQUFBLFdBQVUsRUFBSSxDQUFBLE9BQU0sWUFBWSxDQUFDO0FBRXJDLE9BQVMsbUJBQWlCLENBQUUsT0FBTSxDQUFHO0FBQ2pDLEtBQUksQ0FBQyxDQUFBLFNBQVMsQUFBQyxDQUFDLE9BQU0sQ0FBQyxDQUFHO0FBQ3RCLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxxQ0FBb0MsQ0FBQyxDQUFDO0VBQzlEO0FBQUEsQUFDQSxLQUFJLENBQUMsQ0FBQSxTQUFTLEFBQUMsQ0FBQyxPQUFNLFdBQVcsQ0FBQyxDQUFHO0FBQ2pDLFFBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyxxQ0FBb0MsQ0FBQyxDQUFDO0VBQzFEO0FBQUEsQUFDQSxLQUFHLFNBQVMsRUFBSSxDQUFBLENBQUEsT0FBTyxBQUFDLENBQ3BCO0FBQ0ksb0JBQWdCLENBQUcsRUFBRSxFQUFDLENBQUcsRUFBRSxhQUFZLENBQUcsTUFBSSxDQUFFLENBQUU7QUFDbEQsc0JBQWtCLENBQUcsVUFBUTtBQUM3QixtQ0FBK0IsQ0FBRyx1QkFBcUI7QUFDdkQsc0JBQWtCLENBQUcsVUFBUTtBQUM3QixpQkFBYSxDQUFHLEtBQUc7QUFBQSxFQUN2QixDQUNBLFFBQU0sQ0FBQyxDQUFDO0FBQ1osS0FBRyxJQUFJLEVBQUksS0FBRyxDQUFDO0FBQ2YsS0FBRyxpQkFBaUIsRUFBSSxLQUFHLENBQUM7QUFDNUIsS0FB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QUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUVmLFdBQVMsRUFBSSxDQUFBLFVBQVMsU0FBUyxBQUFDLEVBQUMsQ0FBQztBQUVsQyxPQUFPLENBQUEsSUFBRyxnQkFBZ0IsQUFBQyxFQUFDLEtBQUssQUFBQyxDQUM5QixTQUFVLEFBQUQsQ0FBRztBQUNSLFNBQU8sSUFBSSxTQUFPLEFBQUMsQ0FBQyxTQUFVLE9BQU0sQ0FBRyxDQUFBLE1BQUssQ0FBRztBQUMzQyxTQUFHLDhCQUE4QixRQUFRLEFBQUMsQ0FDdEM7QUFDSSxtQkFBVyxDQUFHLGFBQVc7QUFDekIsaUJBQVMsQ0FBRyxXQUFTO0FBQUEsTUFDekIsQ0FDQTtBQUNJLFFBQUEsQ0FBRyxXQUFTO0FBQ1osYUFBSyxDQUFHLEVBQ0osVUFBUyxDQUFHLEVBQUEsQ0FDaEI7QUFBQSxNQUNKLENBQ0EsVUFBVSxDQUFBLENBQUcsQ0FBQSxFQUFDLENBQUc7QUFDYixXQUFJLENBQUEsQ0FBRztBQUNILGVBQUssQUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDO0FBQ1QsaUJBQU07UUFDVjtBQUFBLEFBRUEsY0FBTSxBQUFDLENBQUMsRUFBQyxFQUFJLENBQUEsRUFBQyxXQUFXLEVBQUksS0FBRyxDQUFDLENBQUM7TUFDdEMsQ0FBQyxDQUFDO0lBQ1YsQ0FBQyxDQUFDO0VBQ04sQ0FBQyxDQUFDO0FBQ1YsQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLG1CQUFpQixDQUFDO0FBQ25DIiwiZmlsZSI6Imhvc3RpbmcvbW9uZ29EQi9tb25nb0RCUGVyc2lzdGVuY2UuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgbW9uZ29kYiA9IHJlcXVpcmUoXCJtb25nb2RiXCIpO1xubGV0IE1vbmdvQ2xpZW50ID0gbW9uZ29kYi5Nb25nb0NsaWVudDtcblxuZnVuY3Rpb24gTW9uZ29EQlBlcnNpc3RlbmNlKG9wdGlvbnMpIHtcbiAgICBpZiAoIV8uaXNPYmplY3Qob3B0aW9ucykpIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIk9iamVjdCBhcmd1bWVudCAnb3B0aW9ucycgZXhwZWN0ZWQuXCIpO1xuICAgIH1cbiAgICBpZiAoIV8uaXNTdHJpbmcob3B0aW9ucy5jb25uZWN0aW9uKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb25uZWN0aW9uIGV4cGVjdGVkIGluIHRoZSBvcHRpb25zLlwiKTtcbiAgICB9XG4gICAgdGhpcy5fb3B0aW9ucyA9IF8uZXh0ZW5kKFxuICAgICAgICB7XG4gICAgICAgICAgICBjb25uZWN0aW9uT3B0aW9uczogeyBkYjogeyBuYXRpdmVfcGFyc2VyOiBmYWxzZSB9IH0sXG4gICAgICAgICAgICBzdGF0ZUNvbGxlY3Rpb25OYW1lOiBcIldGU3RhdGVcIixcbiAgICAgICAgICAgIHByb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb25OYW1lOiBcIldGUHJvbW90ZWRQcm9wZXJ0aWVzXCIsXG4gICAgICAgICAgICBsb2Nrc0NvbGxlY3Rpb25OYW1lOiBcIldGTG9ja3NcIixcbiAgICAgICAgICAgIHN0cmluZ2lmeVN0YXRlOiB0cnVlXG4gICAgICAgIH0sXG4gICAgICAgIG9wdGlvbnMpO1xuICAgIHRoaXMuX2RiID0gbnVsbDtcbiAgICB0aGlzLl9zdGF0ZUNvbGxlY3Rpb24gPSBudWxsO1xuICAgIHRoaXMuX3Byb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb24gPSBudWxsO1xuICAgIHRoaXMuX2xvY2tzQ29sbGVjdGlvbiA9IG51bGw7XG4gICAgdGhpcy5fY29ubmVjdGVkQW5kSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbn1cblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoXG4gICAgTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZSxcbiAgICB7XG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9vcHRpb25zO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG5cbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX2Nvbm5lY3RBbmRJbml0ID0gZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gbmV3IEJsdWViaXJkKFxuICAgICAgICBmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGlmICghc2VsZi5fY29ubmVjdGVkQW5kSW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgTW9uZ29DbGllbnQuY29ubmVjdChzZWxmLm9wdGlvbnMuY29ubmVjdGlvbiwgc2VsZi5vcHRpb25zLmNvbm5lY3Rpb25PcHRpb25zLFxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUsIGRiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGdldENvbGwgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChnY3Jlc29sdmUsIGdjcmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYi5jcmVhdGVDb2xsZWN0aW9uKG5hbWUsIGZ1bmN0aW9uIChnY2UsIGdjY29sbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2NyZWplY3QoZ2NlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdjcmVzb2x2ZShnY2NvbGwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgQmx1ZWJpcmQuYWxsKFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0Q29sbChzZWxmLm9wdGlvbnMuc3RhdGVDb2xsZWN0aW9uTmFtZSkudGhlbihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChjb2xsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3RhdGVDb2xsZWN0aW9uID0gY29sbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRDb2xsKHNlbGYub3B0aW9ucy5sb2Nrc0NvbGxlY3Rpb25OYW1lKS50aGVuKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGNvbGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9sb2Nrc0NvbGxlY3Rpb24gPSBjb2xsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldENvbGwoc2VsZi5vcHRpb25zLnByb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb25OYW1lKS50aGVuKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGNvbGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9wcm9tb3RlZFByb3BlcnRpZXNDb2xsZWN0aW9uID0gY29sbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2Vuc3VyZUluZGV4ZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fZGIgPSBkYjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2Nvbm5lY3RlZEFuZEluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3RhdGVDb2xsZWN0aW9uID0gc2VsZi5fbG9ja3NDb2xsZWN0aW9uID0gc2VsZi5fcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbiA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyIHx8IG5ldyBFcnJvcihcIkluZGV4IGNyZWF0ZSBlcnJvci5cIikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbn07XG5cbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX2Vuc3VyZUluZGV4ZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuXG4gICAgcmV0dXJuIEJsdWViaXJkLmFsbChbXG4gICAgICAgIG5ldyBCbHVlYmlyZChmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICBzZWxmLl9sb2Nrc0NvbGxlY3Rpb24uZW5zdXJlSW5kZXgoeyBuYW1lOiAxIH0sIHsgdzogXCJtYWpvcml0eVwiLCB1bmlxdWU6IHRydWUgfSwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoZSkge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pLFxuICAgICAgICBuZXcgQmx1ZWJpcmQoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgc2VsZi5fbG9ja3NDb2xsZWN0aW9uLmVuc3VyZUluZGV4KHsgaGVsZFRvOiAxIH0sIHsgdzogXCJtYWpvcml0eVwiLCB1bmlxdWU6IGZhbHNlIH0sIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KSxcbiAgICAgICAgbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgIHNlbGYuX3N0YXRlQ29sbGVjdGlvbi5lbnN1cmVJbmRleChcbiAgICAgICAgICAgICAgICB7IHdvcmtmbG93TmFtZTogMSwgaW5zdGFuY2VJZDogMSB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdzogXCJtYWpvcml0eVwiLFxuICAgICAgICAgICAgICAgICAgICB1bmlxdWU6IHRydWVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSksXG4gICAgICAgIG5ldyBCbHVlYmlyZChmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICBzZWxmLl9wcm9tb3RlZFByb3BlcnRpZXNDb2xsZWN0aW9uLmVuc3VyZUluZGV4KFxuICAgICAgICAgICAgICAgIHsgd29ya2Zsb3dOYW1lOiAxLCBpbnN0YW5jZUlkOiAxIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB3OiBcIm1ham9yaXR5XCIsXG4gICAgICAgICAgICAgICAgICAgIHVuaXF1ZTogdHJ1ZVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgIF0pO1xufTtcblxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5jbG9zZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgcmV0dXJuIG5ldyBCbHVlYmlyZChmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGlmIChzZWxmLl9jb25uZWN0ZWRBbmRJbml0aWFsaXplZCkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBzZWxmLl9kYi5jbG9zZShmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHNlbGYuX2Nvbm5lY3RlZEFuZEluaXRpYWxpemVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYuX2RiID0gc2VsZi5fc3RhdGVDb2xsZWN0aW9uID0gc2VsZi5fbG9ja3NDb2xsZWN0aW9uID0gc2VsZi5fcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbiA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgfSk7XG59O1xuXG4vLyBMT0NLSU5HXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLmVudGVyTG9jayA9IGZ1bmN0aW9uIChsb2NrTmFtZSwgaW5Mb2NrVGltZW91dE1zKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgIGxldCBub3cgPSBuZXcgRGF0ZSgpO1xuXG4gICAgcmV0dXJuIHNlbGYuX2Nvbm5lY3RBbmRJbml0KCkudGhlbihcbiAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbW92ZU9sZExvY2tzKCk7XG4gICAgICAgIH0pLnRoZW4oXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQmx1ZWJpcmQoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgIHNlbGYuX2xvY2tzQ29sbGVjdGlvbi5pbnNlcnRPbmUoXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGxvY2tOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgaGVsZFRvOiBub3cuYWRkTWlsbGlzZWNvbmRzKGluTG9ja1RpbWVvdXRNcylcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgeyB3OiBcIm1ham9yaXR5XCIgfSxcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUsIHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS50b1N0cmluZygpLmluZGV4T2YoXCJFMTEwMDBcIikgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTsgLy8gU29tZSBNb25nb0RCIGVycm9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShudWxsKTsgLy8gSXQncyBoZWxkLlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5pbnNlcnRlZENvdW50ID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShudWxsKTsgLy8gSXQncyBoZWxkLlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHJlc3VsdC5vcHNbMF0uX2lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHJlc3VsdC5vcHNbMF0ubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxkVG86IHJlc3VsdC5vcHNbMF0uaGVsZFRvXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG59O1xuXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLnJlbmV3TG9jayA9IGZ1bmN0aW9uIChsb2NrSWQsIGluTG9ja1RpbWVvdXRNcykge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxuICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgICAgICBsZXQgbm93ID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgICAgICBzZWxmLl9sb2Nrc0NvbGxlY3Rpb24udXBkYXRlKFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBfaWQ6IGxvY2tJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlbGRUbzogeyAkbHRlOiBub3cgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkc2V0OiB7IGhlbGRUbzogbm93LmFkZE1pbGxpc2Vjb25kcyhpbkxvY2tUaW1lb3V0TXMpIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgeyB3OiBcIm1ham9yaXR5XCIgfSxcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUsIHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyLm5Nb2RpZmllZCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJMb2NrIGJ5IGlkICdcIiArIGxvY2tJZCArIFwiJyBkb2Vzbid0IGV4aXN0cyBvciBub3QgaGVsZC5cIikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG59O1xuXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLmV4aXRMb2NrID0gZnVuY3Rpb24gKGxvY2tJZCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQmx1ZWJpcmQoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgIHNlbGYuX2xvY2tzQ29sbGVjdGlvbi5yZW1vdmUoXG4gICAgICAgICAgICAgICAgICAgIHsgX2lkOiBsb2NrSWQgfSxcbiAgICAgICAgICAgICAgICAgICAgeyB3OiBcIm1ham9yaXR5XCIgfSxcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbn07XG5cbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX3JlbW92ZU9sZExvY2tzID0gZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBsZXQgbm93ID0gbmV3IERhdGUoKTtcbiAgICByZXR1cm4gbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgc2VsZi5fbG9ja3NDb2xsZWN0aW9uLnJlbW92ZShcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBoZWxkVG86IHtcbiAgICAgICAgICAgICAgICAgICAgJGx0OiBub3dcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgeyB3OiBcIm1ham9yaXR5XCIgfSxcbiAgICAgICAgICAgIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH0pO1xufTtcblxuLy8gU1RBVEVcblxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5pc1J1bm5pbmcgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuXG4gICAgaW5zdGFuY2VJZCA9IGluc3RhbmNlSWQudG9TdHJpbmcoKTtcblxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQmx1ZWJpcmQoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgIHNlbGYuX3N0YXRlQ29sbGVjdGlvbi5maW5kT25lKFxuICAgICAgICAgICAgICAgICAgICB7IHdvcmtmbG93TmFtZTogd29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkOiBpbnN0YW5jZUlkIH0sXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHc6IFwibWFqb3JpdHlcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczogeyBfaWQ6IDEgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSwgaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaWQgPyB0cnVlIDogZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbn07XG5cbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUucGVyc2lzdFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuXG4gICAgbGV0IGluc3RhbmNlSWQgPSBzdGF0ZS5pbnN0YW5jZUlkLnRvU3RyaW5nKCk7XG5cbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxuICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBmdW5jdGlvbiBwZXJzaXN0U3RhdGUoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBCbHVlYmlyZChmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYuX3N0YXRlQ29sbGVjdGlvbi51cGRhdGUoXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiBzdGF0ZS53b3JrZmxvd05hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGFuY2VJZFxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHN0YXRlLndvcmtmbG93TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZUlkOiBpbnN0YW5jZUlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93VmVyc2lvbjogc3RhdGUud29ya2Zsb3dWZXJzaW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZWRPbjogc3RhdGUuY3JlYXRlZE9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRPbjogc3RhdGUudXBkYXRlZE9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlOiBzZWxmLm9wdGlvbnMuc3RyaW5naWZ5U3RhdGUgPyBKU09OLnN0cmluZ2lmeShzdGF0ZS5zdGF0ZSkgOiBzdGF0ZS5zdGF0ZVxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3OiBcIm1ham9yaXR5XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBzZXJ0OiB0cnVlXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChzdGF0ZS5wcm9tb3RlZFByb3BlcnRpZXMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gQmx1ZWJpcmQuYWxsKFxuICAgICAgICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgICAgICAgICBwZXJzaXN0U3RhdGUoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBCbHVlYmlyZChmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbi51cGRhdGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93TmFtZTogc3RhdGUud29ya2Zsb3dOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGFuY2VJZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHN0YXRlLndvcmtmbG93TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd1ZlcnNpb246IHN0YXRlLndvcmtmbG93VmVyc2lvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZWRPbjogc3RhdGUuY3JlYXRlZE9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZE9uOiBzdGF0ZS51cGRhdGVkT24sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiBzdGF0ZS5wcm9tb3RlZFByb3BlcnRpZXNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdzogXCJtYWpvcml0eVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBzZXJ0OiB0cnVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICBdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBwZXJzaXN0U3RhdGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG59O1xuXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLmdldFJ1bm5pbmdJbnN0YW5jZUlkSGVhZGVyID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIGluc3RhbmNlSWQgPSBpbnN0YW5jZUlkLnRvU3RyaW5nKCk7XG5cbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxuICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgICAgICBzZWxmLl9zdGF0ZUNvbGxlY3Rpb24uZmluZE9uZShcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiB3b3JrZmxvd05hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZUlkOiBpbnN0YW5jZUlkXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHc6IFwibWFqb3JpdHlcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRPbjogMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd1ZlcnNpb246IDFcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUsIHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xufTtcblxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5sb2FkU3RhdGUgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuXG4gICAgaW5zdGFuY2VJZCA9IGluc3RhbmNlSWQudG9TdHJpbmcoKTtcblxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQmx1ZWJpcmQoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgIHNlbGYuX3N0YXRlQ29sbGVjdGlvbi5maW5kT25lKFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHdvcmtmbG93TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWRcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdzogXCJtYWpvcml0eVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzOiB7IF9pZDogZmFsc2UgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSwgcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnN0cmluZ2lmeVN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgci5zdGF0ZSA9IEpTT04ucGFyc2Uoci5zdGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHIpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbn07XG5cbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUucmVtb3ZlU3RhdGUgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XG4gICAgbGV0IHNlbGYgPSB0aGlzO1xuXG4gICAgaW5zdGFuY2VJZCA9IGluc3RhbmNlSWQudG9TdHJpbmcoKTtcblxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZSgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3RhdGVDb2xsZWN0aW9uLnJlbW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHdvcmtmbG93TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZUlkOiBpbnN0YW5jZUlkXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgeyB3OiBcIm1ham9yaXR5XCIgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmVuYWJsZVByb21vdGlvbnMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gQmx1ZWJpcmQuYWxsKFxuICAgICAgICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdmUoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBCbHVlYmlyZChmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbi5yZW1vdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93TmFtZTogd29ya2Zsb3dOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGFuY2VJZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHc6IFwibWFqb3JpdHlcIiB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVtb3ZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xufTtcblxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5sb2FkUHJvbW90ZWRQcm9wZXJ0aWVzID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIGluc3RhbmNlSWQgPSBpbnN0YW5jZUlkLnRvU3RyaW5nKCk7XG5cbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxuICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgICAgICBzZWxmLl9wcm9tb3RlZFByb3BlcnRpZXNDb2xsZWN0aW9uLmZpbmRPbmUoXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93TmFtZTogd29ya2Zsb3dOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGFuY2VJZFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3OiBcIm1ham9yaXR5XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiAxXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlLCBwcCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHBwID8gcHAucHJvcGVydGllcyA6IG51bGwpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gTW9uZ29EQlBlcnNpc3RlbmNlO1xuIl19
