"use strict";
var _ = require("lodash");
var WorkflowInstance = require("./workflowInstance");
var errors = require("../common/errors");
var asyncHelpers = require("../common/asyncHelpers");
var Promise = require("bluebird");
var async = asyncHelpers.async;
function WorkflowPersistence(impl) {
  if (!_(impl).isObject())
    throw new TypeError("Object argument expected.");
  this._impl = impl;
}
WorkflowPersistence.prototype.enterLock = function(lockName, enterLockTimeoutMs, inLockTimeoutMs) {
  if (!_(lockName).isString())
    throw new TypeError("Argument 'lockName' is not a string.");
  if (!_(enterLockTimeoutMs).isNumber())
    throw new TypeError("Argument 'enterLockTimeoutMs' is not a number.");
  if (enterLockTimeoutMs < 1000)
    throw new Error("Argument 'enterLockTimeoutMs' have to be above 1000ms.");
  if (!_(inLockTimeoutMs).isNumber())
    throw new TypeError("Argument 'inLockTimeoutMs' is not a number.");
  if (inLockTimeoutMs < 1000)
    throw new Error("Argument 'inLockTimeoutMs' have to be above 1000ms.");
  var self = this;
  return asyncHelpers.aggressiveRetry(function() {
    return Promise.resolve(self._impl.enterLock(lockName, inLockTimeoutMs));
  }, function(lockInfo) {
    return lockInfo != null;
  }, enterLockTimeoutMs, function() {
    return new errors.WorkflowError("Entering lock '" + lockName + "' has timed out.");
  });
};
WorkflowPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  return Promise.resolve(this._impl.renewLock(lockId, inLockTimeoutMs));
};
WorkflowPersistence.prototype.exitLock = function(lockId) {
  return Promise.resolve(this._impl.exitLock(lockId));
};
WorkflowPersistence.prototype.isRunning = function(workflowName, instanceId) {
  this._verifyArg(workflowName, "workflowName");
  return Promise.resolve(this._impl.isRunning(workflowName, instanceId));
};
WorkflowPersistence.prototype.persistState = function(instance) {
  if (!(instance instanceof WorkflowInstance))
    throw new TypeError("WorkflowInstance argument expected.");
  var data = instance.getStateToPersist();
  return Promise.resolve(this._impl.persistState(data));
};
WorkflowPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  this._verifyArg(workflowName, "workflowName");
  this._verifyArg(instanceId, "instanceId");
  return Promise.resolve(this._impl.getRunningInstanceIdHeader(workflowName, instanceId));
};
WorkflowPersistence.prototype.loadState = async($traceurRuntime.initGeneratorFunction(function $__0(workflowName, instanceId) {
  var state;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyArg(workflowName, "workflowName");
          $ctx.state = 8;
          break;
        case 8:
          $ctx.state = 2;
          return (Promise.resolve(this._impl.loadState(workflowName, instanceId)));
        case 2:
          state = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          if (!state)
            throw new Error("Instance state of workflow '" + workflowName + "' by id '" + instanceId + "' is not found.");
          $ctx.state = 10;
          break;
        case 10:
          $ctx.returnValue = state;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__0, this);
}));
WorkflowPersistence.prototype.removeState = function(workflowName, instanceId, succeeded, error) {
  this._verifyArg(workflowName, "workflowName");
  return Promise.resolve(this._impl.removeState(workflowName, instanceId, succeeded, error));
};
WorkflowPersistence.prototype.loadPromotedProperties = async($traceurRuntime.initGeneratorFunction(function $__1(workflowName, instanceId) {
  var state;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyArg(workflowName, "workflowName");
          $ctx.state = 8;
          break;
        case 8:
          $ctx.state = 2;
          return (Promise.resolve(this._impl.loadPromotedProperties(workflowName, instanceId)));
        case 2:
          state = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          $ctx.returnValue = state;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__1, this);
}));
WorkflowPersistence.prototype._verifyArg = function(argValue, argName) {
  if (!_(argValue).isString())
    throw new TypeError("Argument '" + argName + "' is not a string.");
};
module.exports = WorkflowPersistence;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndvcmtmbG93UGVyc2lzdGVuY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFBQSxBQUFJLEVBQUEsQ0FBQSxDQUFBLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsQ0FBQztBQUN6QixBQUFJLEVBQUEsQ0FBQSxnQkFBZSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsb0JBQW1CLENBQUMsQ0FBQztBQUNwRCxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxrQkFBaUIsQ0FBQyxDQUFDO0FBQ3hDLEFBQUksRUFBQSxDQUFBLFlBQVcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLHdCQUF1QixDQUFDLENBQUM7QUFDcEQsQUFBSSxFQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDakMsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsWUFBVyxNQUFNLENBQUM7QUFFOUIsT0FBUyxvQkFBa0IsQ0FBRSxJQUFHLENBQUc7QUFDL0IsS0FBSSxDQUFDLENBQUEsQUFBQyxDQUFDLElBQUcsQ0FBQyxTQUFTLEFBQUMsRUFBQztBQUFHLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQywyQkFBMEIsQ0FBQyxDQUFDO0FBQUEsQUFFekUsS0FBRyxNQUFNLEVBQUksS0FBRyxDQUFDO0FBQ3JCO0FBQUEsQUFFQSxrQkFBa0IsVUFBVSxVQUFVLEVBQUksVUFBVSxRQUFPLENBQUcsQ0FBQSxrQkFBaUIsQ0FBRyxDQUFBLGVBQWMsQ0FBRztBQUMvRixLQUFJLENBQUMsQ0FBQSxBQUFDLENBQUMsUUFBTyxDQUFDLFNBQVMsQUFBQyxFQUFDO0FBQUcsUUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLHNDQUFxQyxDQUFDLENBQUM7QUFBQSxBQUN4RixLQUFJLENBQUMsQ0FBQSxBQUFDLENBQUMsa0JBQWlCLENBQUMsU0FBUyxBQUFDLEVBQUM7QUFBRyxRQUFNLElB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QUFzQixBQUFDLENBZ0ZqQyxjQUFXLFlBQVcsQ0FBRyxDQUFBLFVBQVM7O0FBaEZ0QyxPQUFPLENBQVAsZUFBYyx3QkFBd0IsQUFBZCxDQUF4QixTQUFTLElBQUcsQ0FBRztBQUNULFVBQU8sSUFBRzs7O0FBZ0ZSLGFBQUcsV0FBVyxBQUFDLENBQUMsWUFBVyxDQUFHLGVBQWEsQ0FBQyxDQUFDOzs7OztBQWpGckQsZUFvRjBCLEVBQUMsT0FBTSxRQUFRLEFBQUMsQ0FBQyxJQUFHLE1BQU0sdUJBQXVCLEFBQUMsQ0FBQyxZQUFXLENBQUcsV0FBUyxDQUFDLENBQUMsQ0FBQyxDQXBGaEY7O2dCQUF2QixDQUFBLElBQUcsS0FBSzs7OztBQUFSLGFBQUcsWUFBWSxFQXFGQSxNQUFJLEFBckZnQixDQUFBOzs7O0FBQW5DLGVBQU8sQ0FBQSxJQUFHLElBQUksQUFBQyxFQUFDLENBQUE7O0FBQ21CLEVBQy9CLE9BQTZCLEtBQUcsQ0FBQyxDQUFDO0FBb0ZsQyxDQXRGbUQsQ0FzRmxELENBQUM7QUFFTixrQkFBa0IsVUFBVSxXQUFXLEVBQUksVUFBVSxRQUFPLENBQUcsQ0FBQSxPQUFNLENBQUc7QUFDcEUsS0FBSSxDQUFDLENBQUEsQUFBQyxDQUFDLFFBQU8sQ0FBQyxTQUFTLEFBQUMsRUFBQztBQUFHLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxZQUFXLEVBQUksUUFBTSxDQUFBLENBQUkscUJBQW1CLENBQUMsQ0FBQztBQUFBLEFBQ25HLENBQUE7QUFFQSxLQUFLLFFBQVEsRUFBSSxvQkFBa0IsQ0FBQztBQUNwQyIsImZpbGUiOiJob3N0aW5nL3dvcmtmbG93UGVyc2lzdGVuY2UuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbInZhciBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcbnZhciBXb3JrZmxvd0luc3RhbmNlID0gcmVxdWlyZShcIi4vd29ya2Zsb3dJbnN0YW5jZVwiKTtcbnZhciBlcnJvcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2Vycm9yc1wiKTtcbnZhciBhc3luY0hlbHBlcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2FzeW5jSGVscGVyc1wiKTtcbnZhciBQcm9taXNlID0gcmVxdWlyZShcImJsdWViaXJkXCIpO1xudmFyIGFzeW5jID0gYXN5bmNIZWxwZXJzLmFzeW5jO1xuXG5mdW5jdGlvbiBXb3JrZmxvd1BlcnNpc3RlbmNlKGltcGwpIHtcbiAgICBpZiAoIV8oaW1wbCkuaXNPYmplY3QoKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIk9iamVjdCBhcmd1bWVudCBleHBlY3RlZC5cIik7XG5cbiAgICB0aGlzLl9pbXBsID0gaW1wbDtcbn1cblxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZW50ZXJMb2NrID0gZnVuY3Rpb24gKGxvY2tOYW1lLCBlbnRlckxvY2tUaW1lb3V0TXMsIGluTG9ja1RpbWVvdXRNcykge1xuICAgIGlmICghXyhsb2NrTmFtZSkuaXNTdHJpbmcoKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFyZ3VtZW50ICdsb2NrTmFtZScgaXMgbm90IGEgc3RyaW5nLlwiKTtcbiAgICBpZiAoIV8oZW50ZXJMb2NrVGltZW91dE1zKS5pc051bWJlcigpKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ2VudGVyTG9ja1RpbWVvdXRNcycgaXMgbm90IGEgbnVtYmVyLlwiKTtcbiAgICBpZiAoZW50ZXJMb2NrVGltZW91dE1zIDwgMTAwMCkgdGhyb3cgbmV3IEVycm9yKFwiQXJndW1lbnQgJ2VudGVyTG9ja1RpbWVvdXRNcycgaGF2ZSB0byBiZSBhYm92ZSAxMDAwbXMuXCIpO1xuICAgIGlmICghXyhpbkxvY2tUaW1lb3V0TXMpLmlzTnVtYmVyKCkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAnaW5Mb2NrVGltZW91dE1zJyBpcyBub3QgYSBudW1iZXIuXCIpO1xuICAgIGlmIChpbkxvY2tUaW1lb3V0TXMgPCAxMDAwKSB0aHJvdyBuZXcgRXJyb3IoXCJBcmd1bWVudCAnaW5Mb2NrVGltZW91dE1zJyBoYXZlIHRvIGJlIGFib3ZlIDEwMDBtcy5cIik7XG5cbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgcmV0dXJuIGFzeW5jSGVscGVycy5hZ2dyZXNzaXZlUmV0cnkoXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc2VsZi5faW1wbC5lbnRlckxvY2sobG9ja05hbWUsIGluTG9ja1RpbWVvdXRNcykpXG4gICAgICAgIH0sXG4gICAgICAgIGZ1bmN0aW9uIChsb2NrSW5mbykge1xuICAgICAgICAgICAgcmV0dXJuIGxvY2tJbmZvICE9IG51bGw7XG4gICAgICAgIH0sXG4gICAgICAgIGVudGVyTG9ja1RpbWVvdXRNcyxcbiAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBlcnJvcnMuV29ya2Zsb3dFcnJvcihcIkVudGVyaW5nIGxvY2sgJ1wiICsgbG9ja05hbWUgKyBcIicgaGFzIHRpbWVkIG91dC5cIik7XG4gICAgICAgIH1cbiAgICApO1xufVxuXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5yZW5ld0xvY2sgPSBmdW5jdGlvbiAobG9ja0lkLCBpbkxvY2tUaW1lb3V0TXMpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2ltcGwucmVuZXdMb2NrKGxvY2tJZCwgaW5Mb2NrVGltZW91dE1zKSk7XG59XG5cbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLmV4aXRMb2NrID0gZnVuY3Rpb24gKGxvY2tJZCkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5faW1wbC5leGl0TG9jayhsb2NrSWQpKTtcbn1cblxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUuaXNSdW5uaW5nID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIHRoaXMuX3ZlcmlmeUFyZyh3b3JrZmxvd05hbWUsIFwid29ya2Zsb3dOYW1lXCIpO1xuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLl9pbXBsLmlzUnVubmluZyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcbn1cblxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUucGVyc2lzdFN0YXRlID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7XG4gICAgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBXb3JrZmxvd0luc3RhbmNlKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIldvcmtmbG93SW5zdGFuY2UgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xuXG4gICAgdmFyIGRhdGEgPSBpbnN0YW5jZS5nZXRTdGF0ZVRvUGVyc2lzdCgpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5faW1wbC5wZXJzaXN0U3RhdGUoZGF0YSkpO1xufVxuXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5nZXRSdW5uaW5nSW5zdGFuY2VJZEhlYWRlciA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcbiAgICB0aGlzLl92ZXJpZnlBcmcod29ya2Zsb3dOYW1lLCBcIndvcmtmbG93TmFtZVwiKTtcbiAgICB0aGlzLl92ZXJpZnlBcmcoaW5zdGFuY2VJZCwgXCJpbnN0YW5jZUlkXCIpO1xuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLl9pbXBsLmdldFJ1bm5pbmdJbnN0YW5jZUlkSGVhZGVyKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkpO1xufVxuXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5sb2FkU3RhdGUgPSBhc3luYyhcbiAgICBmdW5jdGlvbiogKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgICAgICB0aGlzLl92ZXJpZnlBcmcod29ya2Zsb3dOYW1lLCBcIndvcmtmbG93TmFtZVwiKTtcblxuICAgICAgICAvLyBXaXRob3V0OiBpZGxlTWV0aG9kcywgcHJvbW90ZWRQcm9wZXJ0aWVzXG4gICAgICAgIHZhciBzdGF0ZSA9IHlpZWxkIChQcm9taXNlLnJlc29sdmUodGhpcy5faW1wbC5sb2FkU3RhdGUod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSkpO1xuICAgICAgICBpZiAoIXN0YXRlKSB0aHJvdyBuZXcgRXJyb3IoXCJJbnN0YW5jZSBzdGF0ZSBvZiB3b3JrZmxvdyAnXCIgKyB3b3JrZmxvd05hbWUgKyBcIicgYnkgaWQgJ1wiICsgaW5zdGFuY2VJZCArIFwiJyBpcyBub3QgZm91bmQuXCIpO1xuICAgICAgICByZXR1cm4gc3RhdGU7XG4gICAgfSk7XG5cbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLnJlbW92ZVN0YXRlID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCwgc3VjY2VlZGVkLCBlcnJvcikge1xuICAgIHRoaXMuX3ZlcmlmeUFyZyh3b3JrZmxvd05hbWUsIFwid29ya2Zsb3dOYW1lXCIpO1xuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLl9pbXBsLnJlbW92ZVN0YXRlKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCwgc3VjY2VlZGVkLCBlcnJvcikpO1xufVxuXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5sb2FkUHJvbW90ZWRQcm9wZXJ0aWVzID0gYXN5bmMoXG4gICAgZnVuY3Rpb24qICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcbiAgICAgICAgdGhpcy5fdmVyaWZ5QXJnKHdvcmtmbG93TmFtZSwgXCJ3b3JrZmxvd05hbWVcIik7XG5cbiAgICAgICAgLy8gV2l0aG91dDogaWRsZU1ldGhvZHMsIHByb21vdGVkUHJvcGVydGllc1xuICAgICAgICB2YXIgc3RhdGUgPSB5aWVsZCAoUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2ltcGwubG9hZFByb21vdGVkUHJvcGVydGllcyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKSk7XG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICB9KTtcblxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX3ZlcmlmeUFyZyA9IGZ1bmN0aW9uIChhcmdWYWx1ZSwgYXJnTmFtZSkge1xuICAgIGlmICghXyhhcmdWYWx1ZSkuaXNTdHJpbmcoKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFyZ3VtZW50ICdcIiArIGFyZ05hbWUgKyBcIicgaXMgbm90IGEgc3RyaW5nLlwiKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBXb3JrZmxvd1BlcnNpc3RlbmNlO1xuIl19
