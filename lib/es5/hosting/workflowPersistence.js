"use strict";
var _ = require("lodash");
var WorkflowInstance = require("./workflowInstance");
var errors = require("../common/errors");
var asyncHelpers = require("../common/asyncHelpers");
var Bluebird = require("bluebird");
var async = asyncHelpers.async;
var assert = require("better-assert");
function WorkflowPersistence(impl) {
  assert(_.isObject(impl));
  this._impl = impl;
}
WorkflowPersistence.prototype.enterLock = function(lockName, enterLockTimeoutMs, inLockTimeoutMs) {
  assert(_.isString(lockName));
  assert(_.isNumber(enterLockTimeoutMs));
  assert(enterLockTimeoutMs >= 1000);
  assert(_.isNumber(inLockTimeoutMs));
  assert(inLockTimeoutMs >= 1000);
  var self = this;
  return asyncHelpers.aggressiveRetry(function() {
    return Bluebird.resolve(self._impl.enterLock(lockName, inLockTimeoutMs));
  }, function(lockInfo) {
    return !!lockInfo;
  }, enterLockTimeoutMs, function() {
    return new errors.TimeoutError("Entering lock '" + lockName + "' has timed out.");
  });
};
WorkflowPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  assert(!!lockId);
  assert(inLockTimeoutMs > 0);
  return Bluebird.resolve(this._impl.renewLock(lockId, inLockTimeoutMs));
};
WorkflowPersistence.prototype.exitLock = function(lockId) {
  assert(!!lockId);
  return Bluebird.resolve(this._impl.exitLock(lockId));
};
WorkflowPersistence.prototype.isRunning = function(workflowName, instanceId) {
  assert(_.isString(workflowName));
  assert(!!instanceId);
  return Bluebird.resolve(this._impl.isRunning(workflowName, instanceId));
};
WorkflowPersistence.prototype.persistState = function(instance) {
  assert(instance instanceof WorkflowInstance);
  var data = instance.getStateToPersist();
  return Bluebird.resolve(this._impl.persistState(data));
};
WorkflowPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  assert(_.isString(workflowName));
  assert(!!instanceId);
  return Bluebird.resolve(this._impl.getRunningInstanceIdHeader(workflowName, instanceId));
};
WorkflowPersistence.prototype.loadState = async($traceurRuntime.initGeneratorFunction(function $__0(workflowName, instanceId) {
  var state;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          assert(_.isString(workflowName));
          assert(!!instanceId);
          $ctx.state = 8;
          break;
        case 8:
          $ctx.state = 2;
          return (Bluebird.resolve(this._impl.loadState(workflowName, instanceId)));
        case 2:
          state = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          if (!state) {
            throw new Error("Instance state of workflow '" + workflowName + "' by id '" + instanceId + "' is not found.");
          }
          $ctx.state = 10;
          break;
        case 10:
          $ctx.returnValue = state;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__0, this);
}));
WorkflowPersistence.prototype.removeState = function(workflowName, instanceId, succeeded, error) {
  assert(_.isString(workflowName));
  assert(!!instanceId);
  assert(_.isBoolean(succeeded));
  return Bluebird.resolve(this._impl.removeState(workflowName, instanceId, succeeded, error));
};
WorkflowPersistence.prototype.loadPromotedProperties = function(workflowName, instanceId) {
  assert(_.isString(workflowName));
  assert(!!instanceId);
  return Bluebird.resolve(this._impl.loadPromotedProperties(workflowName, instanceId));
};
WorkflowPersistence.prototype.getNextWakeupables = function(count) {
  assert(count > 0);
  return Bluebird.resolve(this._impl.getNextWakeupables(count));
};
WorkflowPersistence.prototype.getRunningInstanceHeadersForOtherVersion = function(workflowName, version) {
  assert(_.isString(workflowName));
  assert(_.isNumber(version));
  return Bluebird.resolve(this._impl.getRunningInstanceHeadersForOtherVersion(workflowName, version));
};
module.exports = WorkflowPersistence;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndvcmtmbG93UGVyc2lzdGVuY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFFQSxBQUFJLEVBQUEsQ0FBQSxDQUFBLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsQ0FBQztBQUN6QixBQUFJLEVBQUEsQ0FBQSxnQkFBZSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsb0JBQW1CLENBQUMsQ0FBQztBQUNwRCxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxrQkFBaUIsQ0FBQyxDQUFDO0FBQ3hDLEFBQUksRUFBQSxDQUFBLFlBQVcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLHdCQUF1QixDQUFDLENBQUM7QUFDcEQsQUFBSSxFQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDbEMsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsWUFBVyxNQUFNLENBQUM7QUFDOUIsQUFBSSxFQUFBLENBQUEsTUFBSyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsZUFBYyxDQUFDLENBQUM7QUFFckMsT0FBUyxvQkFBa0IsQ0FBRSxJQUFHLENBQUc7QUFDL0IsT0FBSyxBQUFDLENBQUMsQ0FBQSxTQUFTLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQyxDQUFDO0FBRXhCLEtBQUcsTUFBTSxFQUFJLEtBQUcsQ0FBQztBQUNyQjtBQUFBLEFBRUEsa0JBQWtCLFVBQVUsVUFBVSxFQUFJLFVBQVUsUUFBTyxDQUFHLENBQUEsa0JBQWlCLENBQUcsQ0FBQSxlQUFjLENBQUc7QUFDL0YsT0FBSyxBQUFDLENBQUMsQ0FBQSxTQUFTLEFBQUMsQ0FBQyxRQUFPLENBQUMsQ0FBQyxDQUFDO0FBQzVCLE9BQUssQUFBQyxDQUFDLENBQUEsU0FBUyxBQUFDLENBQUMsa0JBQWlCLENBQUMsQ0FBQyxDQUFDO0FBQ3RDLE9BQUssQUFBQyxDQUFDLGtCQUFpQixHQUFLLEtB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b3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgV29ya2Zsb3dJbnN0YW5jZSA9IHJlcXVpcmUoXCIuL3dvcmtmbG93SW5zdGFuY2VcIik7XG5sZXQgZXJyb3JzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lcnJvcnNcIik7XG5sZXQgYXN5bmNIZWxwZXJzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hc3luY0hlbHBlcnNcIik7XG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5sZXQgYXN5bmMgPSBhc3luY0hlbHBlcnMuYXN5bmM7XG5sZXQgYXNzZXJ0ID0gcmVxdWlyZShcImJldHRlci1hc3NlcnRcIik7XG5cbmZ1bmN0aW9uIFdvcmtmbG93UGVyc2lzdGVuY2UoaW1wbCkge1xuICAgIGFzc2VydChfLmlzT2JqZWN0KGltcGwpKTtcblxuICAgIHRoaXMuX2ltcGwgPSBpbXBsO1xufVxuXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5lbnRlckxvY2sgPSBmdW5jdGlvbiAobG9ja05hbWUsIGVudGVyTG9ja1RpbWVvdXRNcywgaW5Mb2NrVGltZW91dE1zKSB7XG4gICAgYXNzZXJ0KF8uaXNTdHJpbmcobG9ja05hbWUpKTtcbiAgICBhc3NlcnQoXy5pc051bWJlcihlbnRlckxvY2tUaW1lb3V0TXMpKTtcbiAgICBhc3NlcnQoZW50ZXJMb2NrVGltZW91dE1zID49IDEwMDApO1xuICAgIGFzc2VydChfLmlzTnVtYmVyKGluTG9ja1RpbWVvdXRNcykpO1xuICAgIGFzc2VydChpbkxvY2tUaW1lb3V0TXMgPj0gMTAwMCk7XG5cbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgcmV0dXJuIGFzeW5jSGVscGVycy5hZ2dyZXNzaXZlUmV0cnkoXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBCbHVlYmlyZC5yZXNvbHZlKHNlbGYuX2ltcGwuZW50ZXJMb2NrKGxvY2tOYW1lLCBpbkxvY2tUaW1lb3V0TXMpKTtcbiAgICAgICAgfSxcbiAgICAgICAgZnVuY3Rpb24gKGxvY2tJbmZvKSB7XG4gICAgICAgICAgICByZXR1cm4gISFsb2NrSW5mbztcbiAgICAgICAgfSxcbiAgICAgICAgZW50ZXJMb2NrVGltZW91dE1zLFxuICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IGVycm9ycy5UaW1lb3V0RXJyb3IoXCJFbnRlcmluZyBsb2NrICdcIiArIGxvY2tOYW1lICsgXCInIGhhcyB0aW1lZCBvdXQuXCIpO1xuICAgICAgICB9XG4gICAgKTtcbn07XG5cbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLnJlbmV3TG9jayA9IGZ1bmN0aW9uIChsb2NrSWQsIGluTG9ja1RpbWVvdXRNcykge1xuICAgIGFzc2VydCghIWxvY2tJZCk7XG4gICAgYXNzZXJ0KGluTG9ja1RpbWVvdXRNcyA+IDApO1xuXG4gICAgcmV0dXJuIEJsdWViaXJkLnJlc29sdmUodGhpcy5faW1wbC5yZW5ld0xvY2sobG9ja0lkLCBpbkxvY2tUaW1lb3V0TXMpKTtcbn07XG5cbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLmV4aXRMb2NrID0gZnVuY3Rpb24gKGxvY2tJZCkge1xuICAgIGFzc2VydCghIWxvY2tJZCk7XG5cbiAgICByZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZSh0aGlzLl9pbXBsLmV4aXRMb2NrKGxvY2tJZCkpO1xufTtcblxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUuaXNSdW5uaW5nID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIGFzc2VydChfLmlzU3RyaW5nKHdvcmtmbG93TmFtZSkpO1xuICAgIGFzc2VydCghIWluc3RhbmNlSWQpO1xuXG4gICAgcmV0dXJuIEJsdWViaXJkLnJlc29sdmUodGhpcy5faW1wbC5pc1J1bm5pbmcod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSk7XG59O1xuXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5wZXJzaXN0U3RhdGUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHtcbiAgICBhc3NlcnQoaW5zdGFuY2UgaW5zdGFuY2VvZiBXb3JrZmxvd0luc3RhbmNlKTtcblxuICAgIGxldCBkYXRhID0gaW5zdGFuY2UuZ2V0U3RhdGVUb1BlcnNpc3QoKTtcbiAgICByZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZSh0aGlzLl9pbXBsLnBlcnNpc3RTdGF0ZShkYXRhKSk7XG59O1xuXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5nZXRSdW5uaW5nSW5zdGFuY2VJZEhlYWRlciA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcbiAgICBhc3NlcnQoXy5pc1N0cmluZyh3b3JrZmxvd05hbWUpKTtcbiAgICBhc3NlcnQoISFpbnN0YW5jZUlkKTtcblxuICAgIHJldHVybiBCbHVlYmlyZC5yZXNvbHZlKHRoaXMuX2ltcGwuZ2V0UnVubmluZ0luc3RhbmNlSWRIZWFkZXIod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSk7XG59O1xuXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5sb2FkU3RhdGUgPSBhc3luYyhmdW5jdGlvbiogKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIGFzc2VydChfLmlzU3RyaW5nKHdvcmtmbG93TmFtZSkpO1xuICAgIGFzc2VydCghIWluc3RhbmNlSWQpO1xuXG4gICAgLy8gV2l0aG91dDogaWRsZU1ldGhvZHMsIHByb21vdGVkUHJvcGVydGllc1xuICAgIGxldCBzdGF0ZSA9IHlpZWxkIChCbHVlYmlyZC5yZXNvbHZlKHRoaXMuX2ltcGwubG9hZFN0YXRlKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkpKTtcbiAgICBpZiAoIXN0YXRlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkluc3RhbmNlIHN0YXRlIG9mIHdvcmtmbG93ICdcIiArIHdvcmtmbG93TmFtZSArIFwiJyBieSBpZCAnXCIgKyBpbnN0YW5jZUlkICsgXCInIGlzIG5vdCBmb3VuZC5cIik7XG4gICAgfVxuICAgIHJldHVybiBzdGF0ZTtcbn0pO1xuXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5yZW1vdmVTdGF0ZSA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQsIHN1Y2NlZWRlZCwgZXJyb3IpIHtcbiAgICBhc3NlcnQoXy5pc1N0cmluZyh3b3JrZmxvd05hbWUpKTtcbiAgICBhc3NlcnQoISFpbnN0YW5jZUlkKTtcbiAgICBhc3NlcnQoXy5pc0Jvb2xlYW4oc3VjY2VlZGVkKSk7XG5cbiAgICByZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZSh0aGlzLl9pbXBsLnJlbW92ZVN0YXRlKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCwgc3VjY2VlZGVkLCBlcnJvcikpO1xufTtcblxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUubG9hZFByb21vdGVkUHJvcGVydGllcyA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcbiAgICBhc3NlcnQoXy5pc1N0cmluZyh3b3JrZmxvd05hbWUpKTtcbiAgICBhc3NlcnQoISFpbnN0YW5jZUlkKTtcblxuICAgIHJldHVybiBCbHVlYmlyZC5yZXNvbHZlKHRoaXMuX2ltcGwubG9hZFByb21vdGVkUHJvcGVydGllcyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcbn07XG5cbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLmdldE5leHRXYWtldXBhYmxlcyA9IGZ1bmN0aW9uIChjb3VudCkge1xuICAgIGFzc2VydChjb3VudCA+IDApO1xuXG4gICAgcmV0dXJuIEJsdWViaXJkLnJlc29sdmUodGhpcy5faW1wbC5nZXROZXh0V2FrZXVwYWJsZXMoY291bnQpKTtcbn07XG5cbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLmdldFJ1bm5pbmdJbnN0YW5jZUhlYWRlcnNGb3JPdGhlclZlcnNpb24gPSBmdW5jdGlvbih3b3JrZmxvd05hbWUsIHZlcnNpb24pIHtcbiAgICBhc3NlcnQoXy5pc1N0cmluZyh3b3JrZmxvd05hbWUpKTtcbiAgICBhc3NlcnQoXy5pc051bWJlcih2ZXJzaW9uKSk7XG5cbiAgICByZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZSh0aGlzLl9pbXBsLmdldFJ1bm5pbmdJbnN0YW5jZUhlYWRlcnNGb3JPdGhlclZlcnNpb24od29ya2Zsb3dOYW1lLCB2ZXJzaW9uKSk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFdvcmtmbG93UGVyc2lzdGVuY2U7XG4iXX0=
