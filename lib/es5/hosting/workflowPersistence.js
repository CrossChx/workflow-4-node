"use strict";
var _ = require("lodash");
var WorkflowInstance = require("./workflowInstance");
var errors = require("../common/errors");
var asyncHelpers = require("../common/asyncHelpers");
var Promise = require("bluebird");
var async = asyncHelpers.async;
function WorkflowPersistence(impl) {
  if (!_(impl).isObject())
    throw new TypeError("Object argument expected.");
  this._impl = impl;
}
WorkflowPersistence.prototype.enterLock = function(lockName, enterLockTimeoutMs, inLockTimeoutMs) {
  if (!_(lockName).isString())
    throw new TypeError("Argument 'lockName' is not a string.");
  if (!_(enterLockTimeoutMs).isNumber())
    throw new TypeError("Argument 'enterLockTimeoutMs' is not a number.");
  if (enterLockTimeoutMs < 1000)
    throw new Error("Argument 'enterLockTimeoutMs' have to be above 1000ms.");
  if (!_(inLockTimeoutMs).isNumber())
    throw new TypeError("Argument 'inLockTimeoutMs' is not a number.");
  if (inLockTimeoutMs < 1000)
    throw new Error("Argument 'inLockTimeoutMs' have to be above 1000ms.");
  var self = this;
  return asyncHelpers.aggressiveRetry(function() {
    return Promise.resolve(self._impl.enterLock(lockName, inLockTimeoutMs));
  }, function(lockInfo) {
    return lockInfo != null;
  }, enterLockTimeoutMs, function() {
    return new errors.WorkflowError("Entering lock '" + lockName + "' has timed out.");
  });
};
WorkflowPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  return Promise.resolve(this._impl.renewLock(lockId, inLockTimeoutMs));
};
WorkflowPersistence.prototype.exitLock = function(lockId) {
  return Promise.resolve(this._impl.exitLock(lockId));
};
WorkflowPersistence.prototype.isRunning = function(workflowName, instanceId) {
  this._verifyArg(workflowName, "workflowName");
  return Promise.resolve(this._impl.isRunning(workflowName, instanceId));
};
WorkflowPersistence.prototype.persistState = function(instance) {
  if (!(instance instanceof WorkflowInstance))
    throw new TypeError("WorkflowInstance argument expected.");
  var data = instance.getStateToPersist();
  return Promise.resolve(this._impl.persistState(data));
};
WorkflowPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  this._verifyArg(workflowName, "workflowName");
  this._verifyArg(instanceId, "instanceId");
  return Promise.resolve(this._impl.getRunningInstanceIdHeader(workflowName, instanceId));
};
WorkflowPersistence.prototype.loadState = async($traceurRuntime.initGeneratorFunction(function $__0(workflowName, instanceId) {
  var state;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyArg(workflowName, "workflowName");
          $ctx.state = 8;
          break;
        case 8:
          $ctx.state = 2;
          return (Promise.resolve(this._impl.loadState(workflowName, instanceId)));
        case 2:
          state = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          if (!state)
            throw new Error("Instance state of workflow '" + workflowName + "' by id '" + instanceId + "' is not found.");
          $ctx.state = 10;
          break;
        case 10:
          $ctx.returnValue = state;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__0, this);
}));
WorkflowPersistence.prototype.removeState = function(workflowName, instanceId, succeeded, error) {
  this._verifyArg(workflowName, "workflowName");
  return Promise.resolve(this._impl.removeState(workflowName, instanceId, succeeded, error));
};
WorkflowPersistence.prototype.loadPromotedProperties = async($traceurRuntime.initGeneratorFunction(function $__1(workflowName, instanceId) {
  var state;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyArg(workflowName, "workflowName");
          $ctx.state = 8;
          break;
        case 8:
          $ctx.state = 2;
          return (Promise.resolve(this._impl.loadPromotedProperties(workflowName, instanceId)));
        case 2:
          state = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          $ctx.returnValue = state;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__1, this);
}));
WorkflowPersistence.prototype._verifyArg = function(argValue, argName) {
  if (!_(argValue).isString())
    throw new TypeError("Argument '" + argName + "' is not a string.");
};
module.exports = WorkflowPersistence;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndvcmtmbG93UGVyc2lzdGVuY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFBQSxBQUFJLEVBQUEsQ0FBQSxDQUFBLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsQ0FBQztBQUN6QixBQUFJLEVBQUEsQ0FBQSxnQkFBZSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsb0JBQW1CLENBQUMsQ0FBQztBQUNwRCxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxrQkFBaUIsQ0FBQyxDQUFDO0FBQ3hDLEFBQUksRUFBQSxDQUFBLFlBQVcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLHdCQUF1QixDQUFDLENBQUM7QUFDcEQsQUFBSSxFQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDakMsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsWUFBVyxNQUFNLENBQUM7QUFFOUIsT0FBUyxvQkFBa0IsQ0FBRSxJQUFHLENBQUc7QUFDL0IsS0FBSSxDQUFDLENBQUEsQUFBQyxDQUFDLElBQUcsQ0FBQyxTQUFTLEFBQUMsRUFBQztBQUFHLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQywyQkFBMEIsQ0FBQyxDQUFDO0FBQUEsQUFFekUsS0FBRyxNQUFNLEVBQUksS0FBRyxDQUFDO0FBQ3JCO0FBQUEsQUFFQSxrQkFBa0IsVUFBVSxVQUFVLEVBQUksVUFBVSxRQUFPLENBQUcsQ0FBQSxrQkFBaUIsQ0FBRyxDQUFBLGVBQWMsQ0FBRztBQUMvRixLQUFJLENBQUMsQ0FBQSxBQUFDLENBQUMsUUFBTyxDQUFDLFNBQVMsQUFBQyxFQUFDO0FBQUcsUUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLHNDQUFxQyxDQUFDLENBQUM7QUFBQSxBQUN4RixLQUFJLENBQUMsQ0FBQSxBQUFDLENBQUMsa0JBQWlCLENBQUMsU0FBUyxBQUFDLEVBQUM7QUFBRyxRQUFNLElB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QUFzQixBQUFDLENBZ0ZqQyxjQUFXLFlBQVcsQ0FBRyxDQUFBLFVBQVM7O0FBaEZ0QyxPQUFPLENBQVAsZUFBYyx3QkFBd0IsQUFBZCxDQUF4QixTQUFTLElBQUcsQ0FBRztBQUNULFVBQU8sSUFBRzs7O0FBZ0ZSLGFBQUcsV0FBVyxBQUFDLENBQUMsWUFBVyxDQUFHLGVBQWEsQ0FBQyxDQUFDOzs7OztBQWpGckQsZUFvRjBCLEVBQUMsT0FBTSxRQUFRLEFBQUMsQ0FBQyxJQUFHLE1BQU0sdUJBQXVCLEFBQUMsQ0FBQyxZQUFXLENBQUcsV0FBUyxDQUFDLENBQUMsQ0FBQyxDQXBGaEY7O2dCQUF2QixDQUFBLElBQUcsS0FBSzs7OztBQUFSLGFBQUcsWUFBWSxFQXFGQSxNQUFJLEFBckZnQixDQUFBOzs7O0FBQW5DLGVBQU8sQ0FBQSxJQUFHLElBQUksQUFBQyxFQUFDLENBQUE7O0FBQ21CLEVBQy9CLE9BQTZCLEtBQUcsQ0FBQyxDQUFDO0FBb0ZsQyxDQXRGbUQsQ0FzRmxELENBQUM7QUFFTixrQkFBa0IsVUFBVSxXQUFXLEVBQUksVUFBVSxRQUFPLENBQUcsQ0FBQSxPQUFNLENBQUc7QUFDcEUsS0FBSSxDQUFDLENBQUEsQUFBQyxDQUFDLFFBQU8sQ0FBQyxTQUFTLEFBQUMsRUFBQztBQUFHLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxZQUFXLEVBQUksUUFBTSxDQUFBLENBQUkscUJBQW1CLENBQUMsQ0FBQztBQUFBLEFBQ25HLENBQUE7QUFFQSxLQUFLLFFBQVEsRUFBSSxvQkFBa0IsQ0FBQztBQUNwQyIsImZpbGUiOiJob3N0aW5nL3dvcmtmbG93UGVyc2lzdGVuY2UuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbInZhciBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcclxudmFyIFdvcmtmbG93SW5zdGFuY2UgPSByZXF1aXJlKFwiLi93b3JrZmxvd0luc3RhbmNlXCIpO1xyXG52YXIgZXJyb3JzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lcnJvcnNcIik7XHJcbnZhciBhc3luY0hlbHBlcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2FzeW5jSGVscGVyc1wiKTtcclxudmFyIFByb21pc2UgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XHJcbnZhciBhc3luYyA9IGFzeW5jSGVscGVycy5hc3luYztcclxuXHJcbmZ1bmN0aW9uIFdvcmtmbG93UGVyc2lzdGVuY2UoaW1wbCkge1xyXG4gICAgaWYgKCFfKGltcGwpLmlzT2JqZWN0KCkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJPYmplY3QgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xyXG5cclxuICAgIHRoaXMuX2ltcGwgPSBpbXBsO1xyXG59XHJcblxyXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5lbnRlckxvY2sgPSBmdW5jdGlvbiAobG9ja05hbWUsIGVudGVyTG9ja1RpbWVvdXRNcywgaW5Mb2NrVGltZW91dE1zKSB7XHJcbiAgICBpZiAoIV8obG9ja05hbWUpLmlzU3RyaW5nKCkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAnbG9ja05hbWUnIGlzIG5vdCBhIHN0cmluZy5cIik7XHJcbiAgICBpZiAoIV8oZW50ZXJMb2NrVGltZW91dE1zKS5pc051bWJlcigpKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ2VudGVyTG9ja1RpbWVvdXRNcycgaXMgbm90IGEgbnVtYmVyLlwiKTtcclxuICAgIGlmIChlbnRlckxvY2tUaW1lb3V0TXMgPCAxMDAwKSB0aHJvdyBuZXcgRXJyb3IoXCJBcmd1bWVudCAnZW50ZXJMb2NrVGltZW91dE1zJyBoYXZlIHRvIGJlIGFib3ZlIDEwMDBtcy5cIik7XHJcbiAgICBpZiAoIV8oaW5Mb2NrVGltZW91dE1zKS5pc051bWJlcigpKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ2luTG9ja1RpbWVvdXRNcycgaXMgbm90IGEgbnVtYmVyLlwiKTtcclxuICAgIGlmIChpbkxvY2tUaW1lb3V0TXMgPCAxMDAwKSB0aHJvdyBuZXcgRXJyb3IoXCJBcmd1bWVudCAnaW5Mb2NrVGltZW91dE1zJyBoYXZlIHRvIGJlIGFib3ZlIDEwMDBtcy5cIik7XHJcblxyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgcmV0dXJuIGFzeW5jSGVscGVycy5hZ2dyZXNzaXZlUmV0cnkoXHJcbiAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHNlbGYuX2ltcGwuZW50ZXJMb2NrKGxvY2tOYW1lLCBpbkxvY2tUaW1lb3V0TXMpKVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZnVuY3Rpb24gKGxvY2tJbmZvKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBsb2NrSW5mbyAhPSBudWxsO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW50ZXJMb2NrVGltZW91dE1zLFxyXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBlcnJvcnMuV29ya2Zsb3dFcnJvcihcIkVudGVyaW5nIGxvY2sgJ1wiICsgbG9ja05hbWUgKyBcIicgaGFzIHRpbWVkIG91dC5cIik7XHJcbiAgICAgICAgfVxyXG4gICAgKTtcclxufVxyXG5cclxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUucmVuZXdMb2NrID0gZnVuY3Rpb24gKGxvY2tJZCwgaW5Mb2NrVGltZW91dE1zKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2ltcGwucmVuZXdMb2NrKGxvY2tJZCwgaW5Mb2NrVGltZW91dE1zKSk7XHJcbn1cclxuXHJcbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLmV4aXRMb2NrID0gZnVuY3Rpb24gKGxvY2tJZCkge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLl9pbXBsLmV4aXRMb2NrKGxvY2tJZCkpO1xyXG59XHJcblxyXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5pc1J1bm5pbmcgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XHJcbiAgICB0aGlzLl92ZXJpZnlBcmcod29ya2Zsb3dOYW1lLCBcIndvcmtmbG93TmFtZVwiKTtcclxuXHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2ltcGwuaXNSdW5uaW5nKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkpO1xyXG59XHJcblxyXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5wZXJzaXN0U3RhdGUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHtcclxuICAgIGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgV29ya2Zsb3dJbnN0YW5jZSkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJXb3JrZmxvd0luc3RhbmNlIGFyZ3VtZW50IGV4cGVjdGVkLlwiKTtcclxuXHJcbiAgICB2YXIgZGF0YSA9IGluc3RhbmNlLmdldFN0YXRlVG9QZXJzaXN0KCk7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2ltcGwucGVyc2lzdFN0YXRlKGRhdGEpKTtcclxufVxyXG5cclxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZ2V0UnVubmluZ0luc3RhbmNlSWRIZWFkZXIgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XHJcbiAgICB0aGlzLl92ZXJpZnlBcmcod29ya2Zsb3dOYW1lLCBcIndvcmtmbG93TmFtZVwiKTtcclxuICAgIHRoaXMuX3ZlcmlmeUFyZyhpbnN0YW5jZUlkLCBcImluc3RhbmNlSWRcIik7XHJcblxyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLl9pbXBsLmdldFJ1bm5pbmdJbnN0YW5jZUlkSGVhZGVyKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkpO1xyXG59XHJcblxyXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5sb2FkU3RhdGUgPSBhc3luYyhcclxuICAgIGZ1bmN0aW9uKiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XHJcbiAgICAgICAgdGhpcy5fdmVyaWZ5QXJnKHdvcmtmbG93TmFtZSwgXCJ3b3JrZmxvd05hbWVcIik7XHJcblxyXG4gICAgICAgIC8vIFdpdGhvdXQ6IGlkbGVNZXRob2RzLCBwcm9tb3RlZFByb3BlcnRpZXNcclxuICAgICAgICB2YXIgc3RhdGUgPSB5aWVsZCAoUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2ltcGwubG9hZFN0YXRlKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkpKTtcclxuICAgICAgICBpZiAoIXN0YXRlKSB0aHJvdyBuZXcgRXJyb3IoXCJJbnN0YW5jZSBzdGF0ZSBvZiB3b3JrZmxvdyAnXCIgKyB3b3JrZmxvd05hbWUgKyBcIicgYnkgaWQgJ1wiICsgaW5zdGFuY2VJZCArIFwiJyBpcyBub3QgZm91bmQuXCIpO1xyXG4gICAgICAgIHJldHVybiBzdGF0ZTtcclxuICAgIH0pO1xyXG5cclxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUucmVtb3ZlU3RhdGUgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkLCBzdWNjZWVkZWQsIGVycm9yKSB7XHJcbiAgICB0aGlzLl92ZXJpZnlBcmcod29ya2Zsb3dOYW1lLCBcIndvcmtmbG93TmFtZVwiKTtcclxuXHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2ltcGwucmVtb3ZlU3RhdGUod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkLCBzdWNjZWVkZWQsIGVycm9yKSk7XHJcbn1cclxuXHJcbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLmxvYWRQcm9tb3RlZFByb3BlcnRpZXMgPSBhc3luYyhcclxuICAgIGZ1bmN0aW9uKiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XHJcbiAgICAgICAgdGhpcy5fdmVyaWZ5QXJnKHdvcmtmbG93TmFtZSwgXCJ3b3JrZmxvd05hbWVcIik7XHJcblxyXG4gICAgICAgIC8vIFdpdGhvdXQ6IGlkbGVNZXRob2RzLCBwcm9tb3RlZFByb3BlcnRpZXNcclxuICAgICAgICB2YXIgc3RhdGUgPSB5aWVsZCAoUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2ltcGwubG9hZFByb21vdGVkUHJvcGVydGllcyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKSk7XHJcbiAgICAgICAgcmV0dXJuIHN0YXRlO1xyXG4gICAgfSk7XHJcblxyXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5fdmVyaWZ5QXJnID0gZnVuY3Rpb24gKGFyZ1ZhbHVlLCBhcmdOYW1lKSB7XHJcbiAgICBpZiAoIV8oYXJnVmFsdWUpLmlzU3RyaW5nKCkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAnXCIgKyBhcmdOYW1lICsgXCInIGlzIG5vdCBhIHN0cmluZy5cIik7XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0gV29ya2Zsb3dQZXJzaXN0ZW5jZTtcclxuIl19
