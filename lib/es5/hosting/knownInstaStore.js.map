{"version":3,"sources":["hosting/knownInstaStore.js"],"names":[],"mappings":"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","file":"hosting/knownInstaStore.js","sourcesContent":["\"use strict\";\n\nlet specStrings = require(\"../common/specStrings\");\nlet InstIdPaths = require(\"./instIdPaths\");\nlet _ = require(\"lodash\");\nlet debug = require(\"debug\")(\"wf4node:KnownInstaStore\");\nlet enums = require(\"../common/enums\");\n\nfunction KnownInstaStore() {\n    this._instances = new Map();\n}\n\nKnownInstaStore.prototype.add = function (workflowName, insta) {\n    this._instances.set(specStrings.hosting.doubleKeys(workflowName, insta.id), insta);\n};\n\nKnownInstaStore.prototype.get = function (workflowName, instanceId) {\n    return this._instances.get(specStrings.hosting.doubleKeys(workflowName, instanceId));\n};\n\nKnownInstaStore.prototype.exists = function (workflowName, instanceId) {\n    return this._instances.has(specStrings.hosting.doubleKeys(workflowName, instanceId));\n};\n\nKnownInstaStore.prototype.remove = function (workflowName, instanceId) {\n    this._instances.delete(specStrings.hosting.doubleKeys(workflowName, instanceId));\n};\n\nKnownInstaStore.prototype.getNextWakeupables = function (count) {\n    let now = new Date();\n    let result = [];\n    for (let insta of this._instances.values()) {\n        if (insta.execState === enums.activityStates.idle && insta.activeDelays) {\n            for (let ad of insta.activeDelays) {\n                if (ad.delayTo <= now) {\n                    result.push({\n                        instanceId: insta.id,\n                        workflowName: insta.workflowName,\n                        activeDelay: {\n                            methodName: ad.methodName,\n                            delayTo: ad.delayTo\n                        }\n                    });\n                }\n            }\n        }\n    }\n    result.sort(function (i1, i2) {\n        if (i1.updatedOn < i2.updatedOn) {\n            return -1;\n        }\n        else if (i1.updatedOn > i2.updatedOn) {\n            return 1;\n        }\n        else if (i1.activeDelay.delayTo < i2.activeDelay.delayTo) {\n            return -1;\n        }\n        else if (i1.activeDelay.delayTo > i2.activeDelay.delayTo) {\n            return 1;\n        }\n        return 0;\n    });\n    return _.take(result, count);\n};\n\nKnownInstaStore.prototype.getRunningInstanceHeadersForOtherVersion = function(workflowName, version) {\n    let result = [];\n    for (let insta of this._instances.values()) {\n        if (insta.workflowName === workflowName && insta.version !== version) {\n            result.push({\n                workflowName: insta.workflowName,\n                workflowVersion: insta.workflowVersion,\n                instanceId: insta.id\n            });\n        }\n    }\n    return result;\n};\n\nKnownInstaStore.prototype.addTracker = function(tracker) {\n    for (let insta of this._instances.values()) {\n        insta.addTracker(tracker);\n    }\n};\n\nmodule.exports = KnownInstaStore;\n"],"sourceRoot":"/source/"}