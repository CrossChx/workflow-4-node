"use strict";
var _ = require("lodash");
var Bluebird = require("bluebird");
function KeepAlive(repeatFunc, repeatPeriod) {
  if (!_.isFunction(repeatFunc))
    throw new TypeError("Function argument expected.");
  this._repeatFunc = repeatFunc;
  this._repeatPeriod = repeatPeriod;
  this._isRunning = true;
  this._toId = null;
  var self = this;
  process.nextTick(function() {
    self._start.call(self);
  });
}
KeepAlive.prototype._start = function() {
  var self = this;
  self._toId = setTimeout(function() {
    if (self._isRunning) {
      Bluebird.resolve(self._repeatFunc()).catch(function(e) {
        console.error("Keep alive failed:\n" + e.stack);
      }).finally(function() {
        if (self._isRunning)
          self._start();
      });
    }
  }, self._repeatPeriod);
};
KeepAlive.prototype.end = function() {
  if (!this._isRunning)
    throw new Error("Keep alive has already ended.");
  this._isRunning = false;
  if (this._toId)
    clearTimeout(this._toId);
};
module.exports = KeepAlive;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImtlZXBBbGl2ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLEFBQUksRUFBQSxDQUFBLENBQUEsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0FBQ3pCLEFBQUksRUFBQSxDQUFBLFFBQU8sRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFVBQVMsQ0FBQyxDQUFDO0FBRWxDLE9BQVMsVUFBUSxDQUFFLFVBQVMsQ0FBRyxDQUFBLFlBQVcsQ0FBRztBQUN6QyxLQUFJLENBQUMsQ0FBQSxXQUFXLEFBQUMsQ0FBQyxVQUFTLENBQUM7QUFBRyxRQUFNLElBQUksVUFBUSxBQUFDLENBQUMsNkJBQTRCLENBQUMsQ0FBQztBQUFBLEFBQ2pGLEtBQUcsWUFBWSxFQUFJLFdBQVMsQ0FBQztBQUM3QixLQUFHLGNBQWMsRUFBSSxhQUFXLENBQUM7QUFDakMsS0FBRyxXQUFXLEVBQUksS0FBRyxDQUFDO0FBQ3RCLEtBQUcsTUFBTSxFQUFJLEtBQUcsQ0FBQztBQUNqQixBQUFJLElBQUEsQ0FBQSxJQUFHLEVBQUksS0FBRyxDQUFDO0FBQ2YsUUFBTSxTQUFTLEFBQUMsQ0FBQyxTQUFVLEFBQUQsQ0FBRztBQUN6QixPQUFHLE9BQU8sS0FBSyxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7RUFDMUIsQ0FBQyxDQUFDO0FBQ047QUFBQSxBQUVBLFFBQVEsVUFBVSxPQUFPLEVBQUksVUFBVSxBQUFELENBQUc7QUFDckMsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUNmLEtBQUcsTUFBTSxFQUFJLENBQUEsVUFBUyxBQUFDLENBQ25CLFNBQVUsQUFBRCxDQUFHO0FBQ1IsT0FBSSxJQUFHLFdBQVcsQ0FBRztBQUNqQixhQUFPLFFBQVEsQUFBQyxDQUFDLElBQUcsWUFBWSxBQUFDLEVBQUMsQ0FBQyxNQUMxQixBQUFDLENBQUMsU0FBVSxDQUFBLENBQUc7QUFDaEIsY0FBTSxNQUFNLEFBQUMsQ0FBQyxzQkFBcUIsRUFBSSxDQUFBLENBQUEsTUFBTSxDQUFDLENBQUM7TUFDbkQsQ0FBQyxRQUNNLEFBQUMsQ0FBQyxTQUFVLEFBQUQsQ0FBRztBQUNqQixXQUFJLElBQUcsV0FBVztBQUFHLGFBQUcsT0FBTyxBQUFDLEVBQUMsQ0FBQztBQUFBLE1BQ3RDLENBQUMsQ0FBQztJQUNWO0FBQUEsRUFDSixDQUNBLENBQUEsSUFBRyxjQUFjLENBQUMsQ0FBQztBQUMzQixDQUFBO0FBRUEsUUFBUSxVQUFVLElBQUksRUFBSSxVQUFVLEFBQUQsQ0FBRztBQUNsQyxLQUFJLENBQUMsSUFBRyxXQUFXO0FBQUcsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLCtCQUE4QixDQUFDLENBQUM7QUFBQSxBQUV0RSxLQUFHLFdBQVcsRUFBSSxNQUFJLENBQUM7QUFDdkIsS0FBSSxJQUFHLE1BQU07QUFBRyxlQUFXLEFBQUMsQ0FBQyxJQUFHLE1BQU0sQ0FBQyxDQUFDO0FBQUEsQUFDNUMsQ0FBQTtBQUVBLEtBQUssUUFBUSxFQUFJLFVBQVEsQ0FBQztBQUFBIiwiZmlsZSI6Imhvc3Rpbmcva2VlcEFsaXZlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG52YXIgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5cbmZ1bmN0aW9uIEtlZXBBbGl2ZShyZXBlYXRGdW5jLCByZXBlYXRQZXJpb2QpIHtcbiAgICBpZiAoIV8uaXNGdW5jdGlvbihyZXBlYXRGdW5jKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkZ1bmN0aW9uIGFyZ3VtZW50IGV4cGVjdGVkLlwiKTtcbiAgICB0aGlzLl9yZXBlYXRGdW5jID0gcmVwZWF0RnVuYztcbiAgICB0aGlzLl9yZXBlYXRQZXJpb2QgPSByZXBlYXRQZXJpb2Q7XG4gICAgdGhpcy5faXNSdW5uaW5nID0gdHJ1ZTtcbiAgICB0aGlzLl90b0lkID0gbnVsbDtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbiAoKSB7XG4gICAgICAgIHNlbGYuX3N0YXJ0LmNhbGwoc2VsZik7XG4gICAgfSk7XG59XG5cbktlZXBBbGl2ZS5wcm90b3R5cGUuX3N0YXJ0ID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBzZWxmLl90b0lkID0gc2V0VGltZW91dChcbiAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHNlbGYuX2lzUnVubmluZykge1xuICAgICAgICAgICAgICAgIEJsdWViaXJkLnJlc29sdmUoc2VsZi5fcmVwZWF0RnVuYygpKVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJLZWVwIGFsaXZlIGZhaWxlZDpcXG5cIiArIGUuc3RhY2spO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAuZmluYWxseShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5faXNSdW5uaW5nKSBzZWxmLl9zdGFydCgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgc2VsZi5fcmVwZWF0UGVyaW9kKTtcbn1cblxuS2VlcEFsaXZlLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKCF0aGlzLl9pc1J1bm5pbmcpIHRocm93IG5ldyBFcnJvcihcIktlZXAgYWxpdmUgaGFzIGFscmVhZHkgZW5kZWQuXCIpO1xuXG4gICAgdGhpcy5faXNSdW5uaW5nID0gZmFsc2U7XG4gICAgaWYgKHRoaXMuX3RvSWQpIGNsZWFyVGltZW91dCh0aGlzLl90b0lkKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBLZWVwQWxpdmU7Il19
