"use strict";
var specStrings = require("../common/specStrings");
var InstIdPaths = require("./instIdPaths");
var _ = require("lodash");
var debug = require("debug")("wf4node:KnownInstaStore");
var enums = require("../common/enums");
function KnownInstaStore() {
  this._instances = new Map();
}
KnownInstaStore.prototype.add = function(workflowName, insta) {
  this._instances.set(specStrings.hosting.doubleKeys(workflowName, insta.id), insta);
};
KnownInstaStore.prototype.get = function(workflowName, instanceId) {
  return this._instances.get(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
KnownInstaStore.prototype.exists = function(workflowName, instanceId) {
  return this._instances.has(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
KnownInstaStore.prototype.remove = function(workflowName, instanceId) {
  this._instances.delete(specStrings.hosting.doubleKeys(workflowName, instanceId));
};
KnownInstaStore.prototype.getNextWakeupables = function(count) {
  var now = new Date();
  var result = [];
  var $__12 = true;
  var $__13 = false;
  var $__14 = undefined;
  try {
    for (var $__10 = void 0,
        $__9 = (this._instances.values())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__12 = ($__10 = $__9.next()).done); $__12 = true) {
      var insta = $__10.value;
      {
        if (insta.execState === enums.activityStates.idle && insta.activeDelays) {
          var $__5 = true;
          var $__6 = false;
          var $__7 = undefined;
          try {
            for (var $__3 = void 0,
                $__2 = (insta.activeDelays)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
              var ad = $__3.value;
              {
                if (ad.delayTo <= now) {
                  result.push({
                    instanceId: insta.id,
                    workflowName: insta.workflowName,
                    activeDelay: {
                      methodName: ad.methodName,
                      delayTo: ad.delayTo
                    }
                  });
                }
              }
            }
          } catch ($__8) {
            $__6 = true;
            $__7 = $__8;
          } finally {
            try {
              if (!$__5 && $__2.return != null) {
                $__2.return();
              }
            } finally {
              if ($__6) {
                throw $__7;
              }
            }
          }
        }
      }
    }
  } catch ($__15) {
    $__13 = true;
    $__14 = $__15;
  } finally {
    try {
      if (!$__12 && $__9.return != null) {
        $__9.return();
      }
    } finally {
      if ($__13) {
        throw $__14;
      }
    }
  }
  result.sort(function(i1, i2) {
    if (i1.updatedOn < i2.updatedOn) {
      return -1;
    } else if (i1.updatedOn > i2.updatedOn) {
      return 1;
    } else if (i1.activeDelay.delayTo < i2.activeDelay.delayTo) {
      return -1;
    } else if (i1.activeDelay.delayTo > i2.activeDelay.delayTo) {
      return 1;
    }
    return 0;
  });
  return _.take(result, count);
};
KnownInstaStore.prototype.getRunningInstanceHeadersForOtherVersion = function(workflowName, version) {
  var result = [];
  var $__5 = true;
  var $__6 = false;
  var $__7 = undefined;
  try {
    for (var $__3 = void 0,
        $__2 = (this._instances.values())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
      var insta = $__3.value;
      {
        if (insta.workflowName === workflowName && insta.version !== version) {
          result.push({
            workflowName: insta.workflowName,
            workflowVersion: insta.workflowVersion,
            instanceId: insta.id
          });
        }
      }
    }
  } catch ($__8) {
    $__6 = true;
    $__7 = $__8;
  } finally {
    try {
      if (!$__5 && $__2.return != null) {
        $__2.return();
      }
    } finally {
      if ($__6) {
        throw $__7;
      }
    }
  }
  return result;
};
KnownInstaStore.prototype.addTracker = function(tracker) {
  var $__5 = true;
  var $__6 = false;
  var $__7 = undefined;
  try {
    for (var $__3 = void 0,
        $__2 = (this._instances.values())[$traceurRuntime.toProperty(Symbol.iterator)](); !($__5 = ($__3 = $__2.next()).done); $__5 = true) {
      var insta = $__3.value;
      {
        insta.addTracker(tracker);
      }
    }
  } catch ($__8) {
    $__6 = true;
    $__7 = $__8;
  } finally {
    try {
      if (!$__5 && $__2.return != null) {
        $__2.return();
      }
    } finally {
      if ($__6) {
        throw $__7;
      }
    }
  }
};
module.exports = KnownInstaStore;
//# sourceMappingURL=data:application/json;base64,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LEFBQzRCO0FBQ2hCLGFBQW9CLENBQUEsQ0E4RWYsSUFBRyxXQUFXLE9BQU8sQUFBQyxFQUFDLENBOUVVLENBQ2xDLGVBQWMsV0FBVyxBQUFDLENBQUMsTUFBSyxTQUFTLENBQUMsQ0FBQyxBQUFDLEVBQUMsQ0FDckQsRUFBQyxDQUFDLE1BQW9CLENBQUEsQ0FBQyxNQUFvQixDQUFBLFNBQXFCLEFBQUMsRUFBQyxDQUFDLEtBQUssQ0FBQyxDQUN6RSxPQUFvQixLQUFHLENBQUc7UUEyRTFCLE1BQUk7QUFBK0I7QUFDeEMsWUFBSSxXQUFXLEFBQUMsQ0FBQyxPQUFNLENBQUMsQ0FBQztNQUM3QjtJQTFFSTtBQUFBLEVBRkEsQ0FBRSxZQUEwQjtBQUMxQixTQUFvQixLQUFHLENBQUM7QUFDeEIsY0FBb0MsQ0FBQztFQUN2QyxDQUFFLE9BQVE7QUFDUixNQUFJO0FBQ0YsU0FBSSxLQUFpQixHQUFLLENBQUEsV0FBdUIsR0FBSyxLQUFHLENBQUc7QUFDMUQsa0JBQXdCLEFBQUMsRUFBQyxDQUFDO01BQzdCO0FBQUEsSUFDRixDQUFFLE9BQVE7QUFDUixjQUF3QjtBQUN0QixrQkFBd0I7TUFDMUI7QUFBQSxJQUNGO0FBQUEsRUFDRjtBQUFBLEFBZ0VSLENBQUM7QUFFRCxLQUFLLFFBQVEsRUFBSSxnQkFBYyxDQUFDO0FBQ2hDIiwiZmlsZSI6Imhvc3Rpbmcva25vd25JbnN0YVN0b3JlLmpzIiwic291cmNlUm9vdCI6ImxpYi9lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubGV0IHNwZWNTdHJpbmdzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9zcGVjU3RyaW5nc1wiKTtcbmxldCBJbnN0SWRQYXRocyA9IHJlcXVpcmUoXCIuL2luc3RJZFBhdGhzXCIpO1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpKFwid2Y0bm9kZTpLbm93bkluc3RhU3RvcmVcIik7XG5sZXQgZW51bXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2VudW1zXCIpO1xuXG5mdW5jdGlvbiBLbm93bkluc3RhU3RvcmUoKSB7XG4gICAgdGhpcy5faW5zdGFuY2VzID0gbmV3IE1hcCgpO1xufVxuXG5Lbm93bkluc3RhU3RvcmUucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhKSB7XG4gICAgdGhpcy5faW5zdGFuY2VzLnNldChzcGVjU3RyaW5ncy5ob3N0aW5nLmRvdWJsZUtleXMod29ya2Zsb3dOYW1lLCBpbnN0YS5pZCksIGluc3RhKTtcbn07XG5cbktub3duSW5zdGFTdG9yZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIHJldHVybiB0aGlzLl9pbnN0YW5jZXMuZ2V0KHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcbn07XG5cbktub3duSW5zdGFTdG9yZS5wcm90b3R5cGUuZXhpc3RzID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIHJldHVybiB0aGlzLl9pbnN0YW5jZXMuaGFzKHNwZWNTdHJpbmdzLmhvc3RpbmcuZG91YmxlS2V5cyh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpKTtcbn07XG5cbktub3duSW5zdGFTdG9yZS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xuICAgIHRoaXMuX2luc3RhbmNlcy5kZWxldGUoc3BlY1N0cmluZ3MuaG9zdGluZy5kb3VibGVLZXlzKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkpO1xufTtcblxuS25vd25JbnN0YVN0b3JlLnByb3RvdHlwZS5nZXROZXh0V2FrZXVwYWJsZXMgPSBmdW5jdGlvbiAoY291bnQpIHtcbiAgICBsZXQgbm93ID0gbmV3IERhdGUoKTtcbiAgICBsZXQgcmVzdWx0ID0gW107XG4gICAgZm9yIChsZXQgaW5zdGEgb2YgdGhpcy5faW5zdGFuY2VzLnZhbHVlcygpKSB7XG4gICAgICAgIGlmIChpbnN0YS5leGVjU3RhdGUgPT09IGVudW1zLmFjdGl2aXR5U3RhdGVzLmlkbGUgJiYgaW5zdGEuYWN0aXZlRGVsYXlzKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBhZCBvZiBpbnN0YS5hY3RpdmVEZWxheXMpIHtcbiAgICAgICAgICAgICAgICBpZiAoYWQuZGVsYXlUbyA8PSBub3cpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGEuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IGluc3RhLndvcmtmbG93TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZURlbGF5OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kTmFtZTogYWQubWV0aG9kTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxheVRvOiBhZC5kZWxheVRvXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXN1bHQuc29ydChmdW5jdGlvbiAoaTEsIGkyKSB7XG4gICAgICAgIGlmIChpMS51cGRhdGVkT24gPCBpMi51cGRhdGVkT24pIHtcbiAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChpMS51cGRhdGVkT24gPiBpMi51cGRhdGVkT24pIHtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGkxLmFjdGl2ZURlbGF5LmRlbGF5VG8gPCBpMi5hY3RpdmVEZWxheS5kZWxheVRvKSB7XG4gICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoaTEuYWN0aXZlRGVsYXkuZGVsYXlUbyA+IGkyLmFjdGl2ZURlbGF5LmRlbGF5VG8pIHtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAwO1xuICAgIH0pO1xuICAgIHJldHVybiBfLnRha2UocmVzdWx0LCBjb3VudCk7XG59O1xuXG5Lbm93bkluc3RhU3RvcmUucHJvdG90eXBlLmdldFJ1bm5pbmdJbnN0YW5jZUhlYWRlcnNGb3JPdGhlclZlcnNpb24gPSBmdW5jdGlvbih3b3JrZmxvd05hbWUsIHZlcnNpb24pIHtcbiAgICBsZXQgcmVzdWx0ID0gW107XG4gICAgZm9yIChsZXQgaW5zdGEgb2YgdGhpcy5faW5zdGFuY2VzLnZhbHVlcygpKSB7XG4gICAgICAgIGlmIChpbnN0YS53b3JrZmxvd05hbWUgPT09IHdvcmtmbG93TmFtZSAmJiBpbnN0YS52ZXJzaW9uICE9PSB2ZXJzaW9uKSB7XG4gICAgICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiBpbnN0YS53b3JrZmxvd05hbWUsXG4gICAgICAgICAgICAgICAgd29ya2Zsb3dWZXJzaW9uOiBpbnN0YS53b3JrZmxvd1ZlcnNpb24sXG4gICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGEuaWRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG59O1xuXG5Lbm93bkluc3RhU3RvcmUucHJvdG90eXBlLmFkZFRyYWNrZXIgPSBmdW5jdGlvbih0cmFja2VyKSB7XG4gICAgZm9yIChsZXQgaW5zdGEgb2YgdGhpcy5faW5zdGFuY2VzLnZhbHVlcygpKSB7XG4gICAgICAgIGluc3RhLmFkZFRyYWNrZXIodHJhY2tlcik7XG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBLbm93bkluc3RhU3RvcmU7XG4iXX0=
