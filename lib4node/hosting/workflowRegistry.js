"use strict";
var Workflow = require("../activities/workflow");
var _ = require("lodash");
var BeginMethod = require("../activities/beginMethod");
var EndMethod = require("../activities/endMethod");
var is = require("../common/is");
var StrMap = require("backpack-node").collections.StrMap;
function WorkflowRegistry() {
  this._workflows = new StrMap();
}
WorkflowRegistry.prototype.register = function(workflow) {
  if (workflow instanceof Workflow) {
    if (!_(workflow.name).isString())
      throw new TypeError("Workflow name is not a string.");
    var name = workflow.name.trim();
    if (!name)
      throw new TypeError("Workflow name is empty.");
    if (!_(workflow.version).isNumber())
      throw new TypeError("Workflow version is not a number.");
    var version = workflow.version.toString();
    var entry = this._workflows.get(name);
    if (entry) {
      var desc = entry.get(version);
      if (desc) {
        throw new Error("Workflow " + name + " " + version + " already registered.");
      } else {
        entry.add(version, this._createDesc(workflow, name, workflow.version));
      }
    } else {
      entry = new StrMap();
      entry.add(version, this._createDesc(workflow, name, workflow.version));
      this._workflows.add(name, entry);
    }
  } else {
    throw new TypeError("Workflow instance argument expected.");
  }
};
WorkflowRegistry.prototype.getDesc = function(name, version) {
  var entry = this._workflows.get(name);
  if (entry) {
    if (is.defined(version)) {
      version = version.toString();
      var desc = entry.get(version);
      if (desc)
        return desc;
      throw new Error("Workflow " + name + " " + version + " has not been registered.");
    } else {
      var maxV = -10000000;
      var desc = null;
      entry.forEachValue(function(d) {
        if (d.version > maxV)
          desc = d;
      });
      if (desc)
        return desc;
      throw new Error("Workflow " + name + " has not been registered.");
    }
  }
};
WorkflowRegistry.prototype._createDesc = function(workflow, name, version) {
  return {
    workflow: workflow,
    name: name,
    version: version,
    methods: this._collectMethodInfos(workflow)
  };
};
WorkflowRegistry.prototype._collectMethodInfos = function(workflow) {
  var self = this;
  var infos = new StrMap();
  workflow.forEachChild(function(child) {
    var isBM = child instanceof BeginMethod;
    var isEM = child instanceof EndMethod;
    if (isBM || isEM) {
      var methodName = _(child.methodName).isString() ? child.methodName.trim() : null;
      var instanceIdPath = _(child.instanceIdPath).isString() ? child.instanceIdPath.trim() : null;
      if (methodName) {
        var info = infos.get(methodName);
        if (!info) {
          info = {
            workflow: workflow,
            canCreateInstance: false,
            instanceIdPath: null
          };
          infos.add(methodName, info);
        }
        if (isBM && child.canCreateInstance)
          info.canCreateInstance = true;
        if (instanceIdPath) {
          if (info.instanceIdPath) {
            if (info.instanceIdPath !== instanceIdPath)
              throw new Error("Method '" + methodName + "' in workflow '" + workflow.name + "' has multiple different instanceIdPath value which is not supported.");
          } else {
            info.instanceIdPath = instanceIdPath;
          }
        }
      }
    }
  });
  var result = new StrMap();
  infos.forEach(function(kvp) {
    if (kvp.value.instanceIdPath)
      result.add(kvp.key, kvp.value);
  });
  return result;
};
WorkflowRegistry.prototype.forEachMethodInfo = function(workflowName, methodName, f) {
  var entry = this._workflows.get(workflowName);
  if (entry) {
    entry.forEachValue(function(desc) {
      var info = desc.methods.get(methodName);
      if (info)
        f(info);
    });
  }
};
module.exports = WorkflowRegistry;
//# sourceMappingURL=data:application/json;base64,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LEFBQUMsQ0FBQyxTQUFVLElBQUcsQ0FBRztBQUMvQixBQUFJLFFBQUEsQ0FBQSxJQUFHLEVBQUksQ0FBQSxJQUFHLFFBQVEsSUFBSSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDdkMsU0FBSSxJQUFHO0FBQUcsUUFBQSxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFBQSxJQUNyQixDQUFDLENBQUM7RUFDTjtBQUFBLEFBQ0osQ0FBQTtBQUVBLEtBQUssUUFBUSxFQUFJLGlCQUFlLENBQUM7QUFDakMiLCJmaWxlIjoiaG9zdGluZy93b3JrZmxvd1JlZ2lzdHJ5LmpzIiwic291cmNlUm9vdCI6IkM6L0dJVC9tb25nby1jcnVuY2gvZGVwcy93b3JrZmxvdy00LW5vZGUvbGliLyIsInNvdXJjZXNDb250ZW50IjpbInZhciBXb3JrZmxvdyA9IHJlcXVpcmUoXCIuLi9hY3Rpdml0aWVzL3dvcmtmbG93XCIpO1xyXG52YXIgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XHJcbnZhciBCZWdpbk1ldGhvZCA9IHJlcXVpcmUoXCIuLi9hY3Rpdml0aWVzL2JlZ2luTWV0aG9kXCIpO1xyXG52YXIgRW5kTWV0aG9kID0gcmVxdWlyZShcIi4uL2FjdGl2aXRpZXMvZW5kTWV0aG9kXCIpO1xyXG52YXIgaXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2lzXCIpO1xyXG52YXIgU3RyTWFwID0gcmVxdWlyZShcImJhY2twYWNrLW5vZGVcIikuY29sbGVjdGlvbnMuU3RyTWFwO1xyXG5cclxuZnVuY3Rpb24gV29ya2Zsb3dSZWdpc3RyeSgpIHtcclxuICAgIHRoaXMuX3dvcmtmbG93cyA9IG5ldyBTdHJNYXAoKTtcclxufVxyXG5cclxuV29ya2Zsb3dSZWdpc3RyeS5wcm90b3R5cGUucmVnaXN0ZXIgPSBmdW5jdGlvbiAod29ya2Zsb3cpIHtcclxuICAgIGlmICh3b3JrZmxvdyBpbnN0YW5jZW9mIFdvcmtmbG93KSB7XHJcbiAgICAgICAgaWYgKCFfKHdvcmtmbG93Lm5hbWUpLmlzU3RyaW5nKCkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJXb3JrZmxvdyBuYW1lIGlzIG5vdCBhIHN0cmluZy5cIik7XHJcbiAgICAgICAgdmFyIG5hbWUgPSB3b3JrZmxvdy5uYW1lLnRyaW0oKTtcclxuICAgICAgICBpZiAoIW5hbWUpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJXb3JrZmxvdyBuYW1lIGlzIGVtcHR5LlwiKTtcclxuICAgICAgICBpZiAoIV8od29ya2Zsb3cudmVyc2lvbikuaXNOdW1iZXIoKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIldvcmtmbG93IHZlcnNpb24gaXMgbm90IGEgbnVtYmVyLlwiKTtcclxuICAgICAgICB2YXIgdmVyc2lvbiA9IHdvcmtmbG93LnZlcnNpb24udG9TdHJpbmcoKTtcclxuXHJcbiAgICAgICAgdmFyIGVudHJ5ID0gdGhpcy5fd29ya2Zsb3dzLmdldChuYW1lKTtcclxuICAgICAgICBpZiAoZW50cnkpIHtcclxuICAgICAgICAgICAgdmFyIGRlc2MgPSBlbnRyeS5nZXQodmVyc2lvbik7XHJcbiAgICAgICAgICAgIGlmIChkZXNjKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJXb3JrZmxvdyBcIiArIG5hbWUgKyBcIiBcIiArIHZlcnNpb24gKyBcIiBhbHJlYWR5IHJlZ2lzdGVyZWQuXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZW50cnkuYWRkKHZlcnNpb24sIHRoaXMuX2NyZWF0ZURlc2Mod29ya2Zsb3csIG5hbWUsIHdvcmtmbG93LnZlcnNpb24pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgZW50cnkgPSBuZXcgU3RyTWFwKCk7XHJcbiAgICAgICAgICAgIGVudHJ5LmFkZCh2ZXJzaW9uLCB0aGlzLl9jcmVhdGVEZXNjKHdvcmtmbG93LCBuYW1lLCB3b3JrZmxvdy52ZXJzaW9uKSk7XHJcbiAgICAgICAgICAgIHRoaXMuX3dvcmtmbG93cy5hZGQobmFtZSwgZW50cnkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHRocm93ICBuZXcgVHlwZUVycm9yKFwiV29ya2Zsb3cgaW5zdGFuY2UgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xyXG4gICAgfVxyXG59XHJcblxyXG5Xb3JrZmxvd1JlZ2lzdHJ5LnByb3RvdHlwZS5nZXREZXNjID0gZnVuY3Rpb24gKG5hbWUsIHZlcnNpb24pIHtcclxuICAgIHZhciBlbnRyeSA9IHRoaXMuX3dvcmtmbG93cy5nZXQobmFtZSk7XHJcbiAgICBpZiAoZW50cnkpIHtcclxuICAgICAgICBpZiAoaXMuZGVmaW5lZCh2ZXJzaW9uKSkge1xyXG4gICAgICAgICAgICB2ZXJzaW9uID0gdmVyc2lvbi50b1N0cmluZygpO1xyXG4gICAgICAgICAgICB2YXIgZGVzYyA9IGVudHJ5LmdldCh2ZXJzaW9uKTtcclxuICAgICAgICAgICAgaWYgKGRlc2MpIHJldHVybiBkZXNjO1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJXb3JrZmxvdyBcIiArIG5hbWUgKyBcIiBcIiArIHZlcnNpb24gKyBcIiBoYXMgbm90IGJlZW4gcmVnaXN0ZXJlZC5cIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBHZXQgdG9wIHZlcnNpb25cclxuICAgICAgICAgICAgdmFyIG1heFYgPSAtMTAwMDAwMDA7XHJcbiAgICAgICAgICAgIHZhciBkZXNjID0gbnVsbDtcclxuICAgICAgICAgICAgZW50cnkuZm9yRWFjaFZhbHVlKGZ1bmN0aW9uIChkKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZC52ZXJzaW9uID4gbWF4VikgZGVzYyA9IGQ7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZiAoZGVzYykgcmV0dXJuIGRlc2M7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIldvcmtmbG93IFwiICsgbmFtZSArIFwiIGhhcyBub3QgYmVlbiByZWdpc3RlcmVkLlwiKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5Xb3JrZmxvd1JlZ2lzdHJ5LnByb3RvdHlwZS5fY3JlYXRlRGVzYyA9IGZ1bmN0aW9uICh3b3JrZmxvdywgbmFtZSwgdmVyc2lvbikge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICB3b3JrZmxvdzogd29ya2Zsb3csXHJcbiAgICAgICAgbmFtZTogbmFtZSxcclxuICAgICAgICB2ZXJzaW9uOiB2ZXJzaW9uLFxyXG4gICAgICAgIG1ldGhvZHM6IHRoaXMuX2NvbGxlY3RNZXRob2RJbmZvcyh3b3JrZmxvdylcclxuICAgIH1cclxufVxyXG5cclxuV29ya2Zsb3dSZWdpc3RyeS5wcm90b3R5cGUuX2NvbGxlY3RNZXRob2RJbmZvcyA9IGZ1bmN0aW9uICh3b3JrZmxvdykge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgdmFyIGluZm9zID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgd29ya2Zsb3cuZm9yRWFjaENoaWxkKGZ1bmN0aW9uIChjaGlsZCkge1xyXG4gICAgICAgIHZhciBpc0JNID0gY2hpbGQgaW5zdGFuY2VvZiBCZWdpbk1ldGhvZDtcclxuICAgICAgICB2YXIgaXNFTSA9IGNoaWxkIGluc3RhbmNlb2YgRW5kTWV0aG9kO1xyXG4gICAgICAgIGlmIChpc0JNIHx8IGlzRU0pIHtcclxuICAgICAgICAgICAgdmFyIG1ldGhvZE5hbWUgPSBfKGNoaWxkLm1ldGhvZE5hbWUpLmlzU3RyaW5nKCkgPyBjaGlsZC5tZXRob2ROYW1lLnRyaW0oKSA6IG51bGw7XHJcbiAgICAgICAgICAgIHZhciBpbnN0YW5jZUlkUGF0aCA9IF8oY2hpbGQuaW5zdGFuY2VJZFBhdGgpLmlzU3RyaW5nKCkgPyBjaGlsZC5pbnN0YW5jZUlkUGF0aC50cmltKCkgOiBudWxsO1xyXG4gICAgICAgICAgICBpZiAobWV0aG9kTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGluZm8gPSBpbmZvcy5nZXQobWV0aG9kTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8pIHtcclxuICAgICAgICAgICAgICAgICAgICBpbmZvID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvdzogd29ya2Zsb3csXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbkNyZWF0ZUluc3RhbmNlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZFBhdGg6IG51bGxcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIGluZm9zLmFkZChtZXRob2ROYW1lLCBpbmZvKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChpc0JNICYmIGNoaWxkLmNhbkNyZWF0ZUluc3RhbmNlKSBpbmZvLmNhbkNyZWF0ZUluc3RhbmNlID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZUlkUGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmZvLmluc3RhbmNlSWRQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmZvLmluc3RhbmNlSWRQYXRoICE9PSBpbnN0YW5jZUlkUGF0aCkgdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kICdcIiArIG1ldGhvZE5hbWUgKyBcIicgaW4gd29ya2Zsb3cgJ1wiICsgd29ya2Zsb3cubmFtZSArIFwiJyBoYXMgbXVsdGlwbGUgZGlmZmVyZW50IGluc3RhbmNlSWRQYXRoIHZhbHVlIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQuXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5mby5pbnN0YW5jZUlkUGF0aCA9IGluc3RhbmNlSWRQYXRoO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgdmFyIHJlc3VsdCA9IG5ldyBTdHJNYXAoKTtcclxuICAgIGluZm9zLmZvckVhY2goZnVuY3Rpb24gKGt2cCkge1xyXG4gICAgICAgIGlmIChrdnAudmFsdWUuaW5zdGFuY2VJZFBhdGgpIHJlc3VsdC5hZGQoa3ZwLmtleSwga3ZwLnZhbHVlKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxufVxyXG5cclxuV29ya2Zsb3dSZWdpc3RyeS5wcm90b3R5cGUuZm9yRWFjaE1ldGhvZEluZm8gPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBtZXRob2ROYW1lLCBmKSB7XHJcbiAgICB2YXIgZW50cnkgPSB0aGlzLl93b3JrZmxvd3MuZ2V0KHdvcmtmbG93TmFtZSk7XHJcbiAgICBpZiAoZW50cnkpIHtcclxuICAgICAgICBlbnRyeS5mb3JFYWNoVmFsdWUoZnVuY3Rpb24gKGRlc2MpIHtcclxuICAgICAgICAgICAgdmFyIGluZm8gPSBkZXNjLm1ldGhvZHMuZ2V0KG1ldGhvZE5hbWUpO1xyXG4gICAgICAgICAgICBpZiAoaW5mbykgZihpbmZvKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBXb3JrZmxvd1JlZ2lzdHJ5O1xyXG4iXX0=
