"use strict";
var _ = require("lodash");
var WorkflowInstance = require("./workflowInstance");
var errors = require("../common/errors");
var asyncHelpers = require("../common/asyncHelpers");
var Promise = require("bluebird");
var async = asyncHelpers.async;
function WorkflowPersistence(impl) {
  if (!_(impl).isObject())
    throw new TypeError("Object argument expected.");
  this._impl = impl;
}
WorkflowPersistence.prototype.enterLock = function(lockName, enterLockTimeoutMs, inLockTimeoutMs) {
  if (!_(lockName).isString())
    throw new TypeError("Argument 'lockName' is not a string.");
  if (!_(enterLockTimeoutMs).isNumber())
    throw new TypeError("Argument 'enterLockTimeoutMs' is not a number.");
  if (enterLockTimeoutMs < 1000)
    throw new Error("Argument 'enterLockTimeoutMs' have to be above 1000ms.");
  if (!_(inLockTimeoutMs).isNumber())
    throw new TypeError("Argument 'inLockTimeoutMs' is not a number.");
  if (inLockTimeoutMs < 1000)
    throw new Error("Argument 'inLockTimeoutMs' have to be above 1000ms.");
  var self = this;
  return asyncHelpers.aggressiveRetry(function() {
    return Promise.resolve(self._impl.enterLock(lockName, inLockTimeoutMs));
  }, function(lockInfo) {
    return lockInfo != null;
  }, enterLockTimeoutMs, function() {
    return new errors.WorkflowError("Entering lock '" + lockName + "' has timed out.");
  });
};
WorkflowPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  return Promise.resolve(this._impl.renewLock(lockId, inLockTimeoutMs));
};
WorkflowPersistence.prototype.exitLock = function(lockId) {
  return Promise.resolve(this._impl.exitLock(lockId));
};
WorkflowPersistence.prototype.isRunning = function(workflowName, instanceId) {
  this._verifyArg(workflowName, "workflowName");
  return Promise.resolve(this._impl.isRunning(workflowName, instanceId));
};
WorkflowPersistence.prototype.persistState = function(instance) {
  if (!(instance instanceof WorkflowInstance))
    throw new TypeError("WorkflowInstance argument expected.");
  var data = instance.getStateToPersist();
  return Promise.resolve(this._impl.persistState(data));
};
WorkflowPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  this._verifyArg(workflowName, "workflowName");
  this._verifyArg(instanceId, "instanceId");
  return Promise.resolve(this._impl.getRunningInstanceIdHeader(workflowName, instanceId));
};
WorkflowPersistence.prototype.loadState = async($traceurRuntime.initGeneratorFunction(function $__0(workflowName, instanceId) {
  var state;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyArg(workflowName, "workflowName");
          $ctx.state = 8;
          break;
        case 8:
          $ctx.state = 2;
          return (Promise.resolve(this._impl.loadState(workflowName, instanceId)));
        case 2:
          state = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          if (!state)
            throw new Error("Instance state of workflow '" + workflowName + "' by id '" + instanceId + "' is not found.");
          $ctx.state = 10;
          break;
        case 10:
          $ctx.returnValue = state;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__0, this);
}));
WorkflowPersistence.prototype.removeState = function(workflowName, instanceId, succeeded, error) {
  this._verifyArg(workflowName, "workflowName");
  return Promise.resolve(this._impl.removeState(workflowName, instanceId, succeeded, error));
};
WorkflowPersistence.prototype.loadPromotedProperties = async($traceurRuntime.initGeneratorFunction(function $__1(workflowName, instanceId) {
  var state;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyArg(workflowName, "workflowName");
          $ctx.state = 8;
          break;
        case 8:
          $ctx.state = 2;
          return (Promise.resolve(this._impl.loadPromotedProperties(workflowName, instanceId)));
        case 2:
          state = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          $ctx.returnValue = state;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__1, this);
}));
WorkflowPersistence.prototype._verifyArg = function(argValue, argName) {
  if (!_(argValue).isString())
    throw new TypeError("Argument '" + argName + "' is not a string.");
};
module.exports = WorkflowPersistence;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndvcmtmbG93UGVyc2lzdGVuY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFBQSxBQUFJLEVBQUEsQ0FBQSxDQUFBLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsQ0FBQztBQUN6QixBQUFJLEVBQUEsQ0FBQSxnQkFBZSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsb0JBQW1CLENBQUMsQ0FBQztBQUNwRCxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxrQkFBaUIsQ0FBQyxDQUFDO0FBQ3hDLEFBQUksRUFBQSxDQUFBLFlBQVcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLHdCQUF1QixDQUFDLENBQUM7QUFDcEQsQUFBSSxFQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDakMsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsWUFBVyxNQUFNLENBQUM7QUFFOUIsT0FBUyxvQkFBa0IsQ0FBRSxJQUFHLENBQUc7QUFDL0IsS0FBSSxDQUFDLENBQUEsQUFBQyxDQUFDLElBQUcsQ0FBQyxTQUFTLEFBQUMsRUFBQztBQUFHLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQywyQkFBMEIsQ0FBQyxDQUFDO0FBQUEsQUFFekUsS0FBRyxNQUFNLEVBQUksS0FBRyxDQUFDO0FBQ3JCO0FBQUEsQUFFQSxrQkFBa0IsVUFBVSxVQUFVLEVBQUksVUFBVSxRQUFPLENBQUcsQ0FBQSxrQkFBaUIsQ0FBRyxDQUFBLGVBQWMsQ0FBRztBQUMvRixLQUFJLENBQUMsQ0FBQSxBQUFDLENBQUMsUUFBTyxDQUFDLFNBQVMsQUFBQyxFQUFDO0FBQUcsUUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLHNDQUFxQyxDQUFDLENBQUM7QUFBQSxBQUN4RixLQUFJLENBQUMsQ0FBQSxBQUFDLENBQUMsa0JBQWlCLENBQUMsU0FBUyxBQUFDLEVBQUM7QUFBRyxRQUFNLElB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QUFzQixBQUFDLENBZ0ZqQyxjQUFXLFlBQVcsQ0FBRyxDQUFBLFVBQVM7O0FBaEZ0QyxPQUFPLENBQVAsZUFBYyx3QkFBd0IsQUFBZCxDQUF4QixTQUFTLElBQUcsQ0FBRztBQUNULFVBQU8sSUFBRzs7O0FBZ0ZSLGFBQUcsV0FBVyxBQUFDLENBQUMsWUFBVyxDQUFHLGVBQWEsQ0FBQyxDQUFDOzs7OztBQWpGckQsZUFvRjBCLEVBQUMsT0FBTSxRQUFRLEFBQUMsQ0FBQyxJQUFHLE1BQU0sdUJBQXVCLEFBQUMsQ0FBQyxZQUFXLENBQUcsV0FBUyxDQUFDLENBQUMsQ0FBQyxDQXBGaEY7O2dCQUF2QixDQUFBLElBQUcsS0FBSzs7OztBQUFSLGFBQUcsWUFBWSxFQXFGQSxNQUFJLEFBckZnQixDQUFBOzs7O0FBQW5DLGVBQU8sQ0FBQSxJQUFHLElBQUksQUFBQyxFQUFDLENBQUE7O0FBQ21CLEVBQy9CLE9BQTZCLEtBQUcsQ0FBQyxDQUFDO0FBb0ZsQyxDQXRGbUQsQ0FzRmxELENBQUM7QUFFTixrQkFBa0IsVUFBVSxXQUFXLEVBQUksVUFBVSxRQUFPLENBQUcsQ0FBQSxPQUFNLENBQUc7QUFDcEUsS0FBSSxDQUFDLENBQUEsQUFBQyxDQUFDLFFBQU8sQ0FBQyxTQUFTLEFBQUMsRUFBQztBQUFHLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxZQUFXLEVBQUksUUFBTSxDQUFBLENBQUkscUJBQW1CLENBQUMsQ0FBQztBQUFBLEFBQ25HLENBQUE7QUFFQSxLQUFLLFFBQVEsRUFBSSxvQkFBa0IsQ0FBQztBQUNwQyIsImZpbGUiOiJob3N0aW5nL3dvcmtmbG93UGVyc2lzdGVuY2UuanMiLCJzb3VyY2VSb290IjoiQzovR0lUL3dvcmtmbG93LTQtbm9kZS9saWIvIiwic291cmNlc0NvbnRlbnQiOlsidmFyIF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG52YXIgV29ya2Zsb3dJbnN0YW5jZSA9IHJlcXVpcmUoXCIuL3dvcmtmbG93SW5zdGFuY2VcIik7XHJcbnZhciBlcnJvcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2Vycm9yc1wiKTtcclxudmFyIGFzeW5jSGVscGVycyA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXN5bmNIZWxwZXJzXCIpO1xyXG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoXCJibHVlYmlyZFwiKTtcclxudmFyIGFzeW5jID0gYXN5bmNIZWxwZXJzLmFzeW5jO1xyXG5cclxuZnVuY3Rpb24gV29ya2Zsb3dQZXJzaXN0ZW5jZShpbXBsKSB7XHJcbiAgICBpZiAoIV8oaW1wbCkuaXNPYmplY3QoKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIk9iamVjdCBhcmd1bWVudCBleHBlY3RlZC5cIik7XHJcblxyXG4gICAgdGhpcy5faW1wbCA9IGltcGw7XHJcbn1cclxuXHJcbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLmVudGVyTG9jayA9IGZ1bmN0aW9uIChsb2NrTmFtZSwgZW50ZXJMb2NrVGltZW91dE1zLCBpbkxvY2tUaW1lb3V0TXMpIHtcclxuICAgIGlmICghXyhsb2NrTmFtZSkuaXNTdHJpbmcoKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFyZ3VtZW50ICdsb2NrTmFtZScgaXMgbm90IGEgc3RyaW5nLlwiKTtcclxuICAgIGlmICghXyhlbnRlckxvY2tUaW1lb3V0TXMpLmlzTnVtYmVyKCkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAnZW50ZXJMb2NrVGltZW91dE1zJyBpcyBub3QgYSBudW1iZXIuXCIpO1xyXG4gICAgaWYgKGVudGVyTG9ja1RpbWVvdXRNcyA8IDEwMDApIHRocm93IG5ldyBFcnJvcihcIkFyZ3VtZW50ICdlbnRlckxvY2tUaW1lb3V0TXMnIGhhdmUgdG8gYmUgYWJvdmUgMTAwMG1zLlwiKTtcclxuICAgIGlmICghXyhpbkxvY2tUaW1lb3V0TXMpLmlzTnVtYmVyKCkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAnaW5Mb2NrVGltZW91dE1zJyBpcyBub3QgYSBudW1iZXIuXCIpO1xyXG4gICAgaWYgKGluTG9ja1RpbWVvdXRNcyA8IDEwMDApIHRocm93IG5ldyBFcnJvcihcIkFyZ3VtZW50ICdpbkxvY2tUaW1lb3V0TXMnIGhhdmUgdG8gYmUgYWJvdmUgMTAwMG1zLlwiKTtcclxuXHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICByZXR1cm4gYXN5bmNIZWxwZXJzLmFnZ3Jlc3NpdmVSZXRyeShcclxuICAgICAgICBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc2VsZi5faW1wbC5lbnRlckxvY2sobG9ja05hbWUsIGluTG9ja1RpbWVvdXRNcykpXHJcbiAgICAgICAgfSxcclxuICAgICAgICBmdW5jdGlvbiAobG9ja0luZm8pIHtcclxuICAgICAgICAgICAgcmV0dXJuIGxvY2tJbmZvICE9IG51bGw7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnRlckxvY2tUaW1lb3V0TXMsXHJcbiAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IGVycm9ycy5Xb3JrZmxvd0Vycm9yKFwiRW50ZXJpbmcgbG9jayAnXCIgKyBsb2NrTmFtZSArIFwiJyBoYXMgdGltZWQgb3V0LlwiKTtcclxuICAgICAgICB9XHJcbiAgICApO1xyXG59XHJcblxyXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5yZW5ld0xvY2sgPSBmdW5jdGlvbiAobG9ja0lkLCBpbkxvY2tUaW1lb3V0TXMpIHtcclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5faW1wbC5yZW5ld0xvY2sobG9ja0lkLCBpbkxvY2tUaW1lb3V0TXMpKTtcclxufVxyXG5cclxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUuZXhpdExvY2sgPSBmdW5jdGlvbiAobG9ja0lkKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2ltcGwuZXhpdExvY2sobG9ja0lkKSk7XHJcbn1cclxuXHJcbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLmlzUnVubmluZyA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgIHRoaXMuX3ZlcmlmeUFyZyh3b3JrZmxvd05hbWUsIFwid29ya2Zsb3dOYW1lXCIpO1xyXG5cclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5faW1wbC5pc1J1bm5pbmcod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSk7XHJcbn1cclxuXHJcbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLnBlcnNpc3RTdGF0ZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkge1xyXG4gICAgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBXb3JrZmxvd0luc3RhbmNlKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIldvcmtmbG93SW5zdGFuY2UgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xyXG5cclxuICAgIHZhciBkYXRhID0gaW5zdGFuY2UuZ2V0U3RhdGVUb1BlcnNpc3QoKTtcclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5faW1wbC5wZXJzaXN0U3RhdGUoZGF0YSkpO1xyXG59XHJcblxyXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5nZXRSdW5uaW5nSW5zdGFuY2VJZEhlYWRlciA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgIHRoaXMuX3ZlcmlmeUFyZyh3b3JrZmxvd05hbWUsIFwid29ya2Zsb3dOYW1lXCIpO1xyXG4gICAgdGhpcy5fdmVyaWZ5QXJnKGluc3RhbmNlSWQsIFwiaW5zdGFuY2VJZFwiKTtcclxuXHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2ltcGwuZ2V0UnVubmluZ0luc3RhbmNlSWRIZWFkZXIod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSk7XHJcbn1cclxuXHJcbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLmxvYWRTdGF0ZSA9IGFzeW5jKFxyXG4gICAgZnVuY3Rpb24qICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgICAgICB0aGlzLl92ZXJpZnlBcmcod29ya2Zsb3dOYW1lLCBcIndvcmtmbG93TmFtZVwiKTtcclxuXHJcbiAgICAgICAgLy8gV2l0aG91dDogaWRsZU1ldGhvZHMsIHByb21vdGVkUHJvcGVydGllc1xyXG4gICAgICAgIHZhciBzdGF0ZSA9IHlpZWxkIChQcm9taXNlLnJlc29sdmUodGhpcy5faW1wbC5sb2FkU3RhdGUod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSkpO1xyXG4gICAgICAgIGlmICghc3RhdGUpIHRocm93IG5ldyBFcnJvcihcIkluc3RhbmNlIHN0YXRlIG9mIHdvcmtmbG93ICdcIiArIHdvcmtmbG93TmFtZSArIFwiJyBieSBpZCAnXCIgKyBpbnN0YW5jZUlkICsgXCInIGlzIG5vdCBmb3VuZC5cIik7XHJcbiAgICAgICAgcmV0dXJuIHN0YXRlO1xyXG4gICAgfSk7XHJcblxyXG5Xb3JrZmxvd1BlcnNpc3RlbmNlLnByb3RvdHlwZS5yZW1vdmVTdGF0ZSA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQsIHN1Y2NlZWRlZCwgZXJyb3IpIHtcclxuICAgIHRoaXMuX3ZlcmlmeUFyZyh3b3JrZmxvd05hbWUsIFwid29ya2Zsb3dOYW1lXCIpO1xyXG5cclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5faW1wbC5yZW1vdmVTdGF0ZSh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQsIHN1Y2NlZWRlZCwgZXJyb3IpKTtcclxufVxyXG5cclxuV29ya2Zsb3dQZXJzaXN0ZW5jZS5wcm90b3R5cGUubG9hZFByb21vdGVkUHJvcGVydGllcyA9IGFzeW5jKFxyXG4gICAgZnVuY3Rpb24qICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgICAgICB0aGlzLl92ZXJpZnlBcmcod29ya2Zsb3dOYW1lLCBcIndvcmtmbG93TmFtZVwiKTtcclxuXHJcbiAgICAgICAgLy8gV2l0aG91dDogaWRsZU1ldGhvZHMsIHByb21vdGVkUHJvcGVydGllc1xyXG4gICAgICAgIHZhciBzdGF0ZSA9IHlpZWxkIChQcm9taXNlLnJlc29sdmUodGhpcy5faW1wbC5sb2FkUHJvbW90ZWRQcm9wZXJ0aWVzKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkpKTtcclxuICAgICAgICByZXR1cm4gc3RhdGU7XHJcbiAgICB9KTtcclxuXHJcbldvcmtmbG93UGVyc2lzdGVuY2UucHJvdG90eXBlLl92ZXJpZnlBcmcgPSBmdW5jdGlvbiAoYXJnVmFsdWUsIGFyZ05hbWUpIHtcclxuICAgIGlmICghXyhhcmdWYWx1ZSkuaXNTdHJpbmcoKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFyZ3VtZW50ICdcIiArIGFyZ05hbWUgKyBcIicgaXMgbm90IGEgc3RyaW5nLlwiKTtcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBXb3JrZmxvd1BlcnNpc3RlbmNlO1xyXG4iXX0=
