"use strict";
var Promise = require("bluebird");
var _ = require("lodash");
var mongodb = require("mongodb");
var MongoClient = mongodb.MongoClient;
var fast = require("fast.js");
function MongoDBPersistence(options) {
  if (!_.isObject(options))
    throw new TypeError("Object argument 'options' expected.");
  if (!_.isString(options.connection))
    throw new Error("Connection expected in the options.");
  this._options = _.extend({
    connectionOptions: {db: {native_parser: false}},
    stateCollectionName: "WFState",
    promotedPropertiesCollectionName: "WFPromotedProperties",
    locksCollectionName: "WFLocks",
    stringifyState: true
  }, options);
  this._db = null;
  this._stateCollection = null;
  this._promotedPropertiesCollection = null;
  this._locksCollection = null;
  this._connectedAndInitialized = false;
}
Object.defineProperties(MongoDBPersistence.prototype, {options: {get: function() {
      return this._options;
    }}});
MongoDBPersistence.prototype._connectAndInit = function() {
  var self = this;
  return new Promise(function(resolve, reject) {
    try {
      if (!self._connectedAndInitialized) {
        MongoClient.connect(self.options.connection, self.options.connectionOptions, function(e, db) {
          if (e) {
            reject(e);
            return ;
          }
          var getColl = function(name) {
            return new Promise(function(gcresolve, gcreject) {
              db.createCollection(name, function(e, coll) {
                if (e)
                  gcreject(e);
                else
                  gcresolve(coll);
              });
            });
          };
          Promise.all([getColl(self.options.stateCollectionName).then(function(coll) {
            self._stateCollection = coll;
          }), getColl(self.options.locksCollectionName).then(function(coll) {
            self._locksCollection = coll;
          }), getColl(self.options.promotedPropertiesCollectionName).then(function(coll) {
            self._promotedPropertiesCollection = coll;
          })]).then(function() {
            return self._ensureIndexes();
          }).then(function() {
            self._db = db;
            self._connectedAndInitialized = true;
            resolve();
          }, function(e) {
            self._stateCollection = self._locksCollection = self._promotedPropertiesCollection = null;
            reject(e || new Error("Index create error."));
          });
        });
      } else {
        resolve();
      }
    } catch (e) {
      reject(e);
    }
  });
};
MongoDBPersistence.prototype._ensureIndexes = function() {
  var self = this;
  return Promise.all([new Promise(function(resolve, reject) {
    self._locksCollection.ensureIndex({name: 1}, {
      w: "majority",
      unique: true
    }, function(e) {
      if (e)
        reject(e);
      else
        resolve();
    });
  }), new Promise(function(resolve, reject) {
    self._locksCollection.ensureIndex({heldTo: 1}, {
      w: "majority",
      unique: false
    }, function(e) {
      if (e)
        reject(e);
      else
        resolve();
    });
  }), new Promise(function(resolve, reject) {
    self._stateCollection.ensureIndex({
      workflowName: 1,
      instanceId: 1
    }, {
      w: "majority",
      unique: true
    }, function(e) {
      if (e)
        reject(e);
      else
        resolve();
    });
  }), new Promise(function(resolve, reject) {
    self._promotedPropertiesCollection.ensureIndex({
      workflowName: 1,
      instanceId: 1
    }, {
      w: "majority",
      unique: true
    }, function(e) {
      if (e)
        reject(e);
      else
        resolve();
    });
  })]);
};
MongoDBPersistence.prototype.close = function() {
  var self = this;
  return new Promise(function(resolve, reject) {
    if (self._connectedAndInitialized) {
      try {
        self._db.close(function(err) {
          if (err) {
            reject(err);
            return ;
          }
          self._connectedAndInitialized = false;
          self._db = self._stateCollection = self._locksCollection = self._promotedPropertiesCollection = null;
          resolve();
        });
      } catch (e) {
        reject(e);
      }
    } else {
      resolve();
    }
  });
};
MongoDBPersistence.prototype.enterLock = function(lockName, inLockTimeoutMs) {
  var self = this;
  var now = new Date();
  return self._connectAndInit().then(function() {
    return self._removeOldLocks();
  }).then(function() {
    return new Promise(function(resolve, reject) {
      self._locksCollection.insertOne({
        name: lockName,
        heldTo: now.addMilliseconds(inLockTimeoutMs)
      }, {w: "majority"}, function(e, result) {
        if (e) {
          if (e.toString().indexOf("E11000") === -1) {
            reject(e);
            return ;
          }
          resolve(null);
          return ;
        }
        if (result.insertedCount == 0) {
          resolve(null);
          return ;
        }
        resolve({
          id: result.ops[0]._id,
          name: result.ops[0].name,
          heldTo: result.ops[0].heldTo
        });
      });
    });
  });
};
MongoDBPersistence.prototype.renewLock = function(lockId, inLockTimeoutMs) {
  var self = this;
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      var now = new Date();
      self._locksCollection.update({
        _id: lockId,
        heldTo: {$lte: now}
      }, {$set: {heldTo: now.addMilliseconds(inLockTimeoutMs)}}, {w: "majority"}, function(e, r) {
        if (e) {
          reject(e);
          return ;
        }
        if (r.nModified === 0) {
          reject(new Error("Lock by id '" + lockId + "' doesn't exists or not held."));
          return ;
        }
        resolve();
      });
    });
  });
};
MongoDBPersistence.prototype.exitLock = function(lockId) {
  var self = this;
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      self._locksCollection.remove({_id: lockId}, {w: "majority"}, function(e) {
        if (e)
          reject(e);
        else
          resolve();
      });
    });
  });
};
MongoDBPersistence.prototype._removeOldLocks = function() {
  var self = this;
  var now = new Date();
  return new Promise(function(resolve, reject) {
    self._locksCollection.remove({heldTo: {$lt: now}}, {w: "majority"}, function(e) {
      if (e)
        reject(e);
      else
        resolve();
    });
  });
};
MongoDBPersistence.prototype.isRunning = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      self._stateCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: "majority",
        fields: {_id: 1}
      }, function(e, id) {
        if (e) {
          reject(e);
          return ;
        }
        resolve(id ? true : false);
      });
    });
  });
};
MongoDBPersistence.prototype.persistState = function(state) {
  var self = this;
  var instanceId = state.instanceId.toString();
  return self._connectAndInit().then(function() {
    function persistState() {
      return new Promise(function(resolve, reject) {
        self._stateCollection.update({
          workflowName: state.workflowName,
          instanceId: instanceId
        }, {
          workflowName: state.workflowName,
          instanceId: instanceId,
          workflowVersion: state.workflowVersion,
          createdOn: state.createdOn,
          updatedOn: state.updatedOn,
          state: self.options.stringifyState ? JSON.stringify(state.state) : state.state
        }, {
          w: "majority",
          upsert: true
        }, function(e) {
          if (e)
            reject(e);
          else
            resolve();
        });
      });
    }
    if (state.promotedProperties) {
      return Promise.all([persistState(), new Promise(function(resolve, reject) {
        self._promotedPropertiesCollection.update({
          workflowName: state.workflowName,
          instanceId: instanceId
        }, {
          workflowName: state.workflowName,
          instanceId: instanceId,
          workflowVersion: state.workflowVersion,
          createdOn: state.createdOn,
          updatedOn: state.updatedOn,
          properties: state.promotedProperties
        }, {
          w: "majority",
          upsert: true
        }, function(e) {
          if (e)
            reject(e);
          else
            resolve();
        });
      })]);
    } else {
      return persistState();
    }
  });
};
MongoDBPersistence.prototype.getRunningInstanceIdHeader = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      self._stateCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: "majority",
        fields: {
          updatedOn: 1,
          workflowVersion: 1
        }
      }, function(e, result) {
        if (e) {
          reject(e);
          return ;
        }
        resolve(result);
      });
    });
  });
};
MongoDBPersistence.prototype.loadState = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      self._stateCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: "majority",
        fields: {_id: false}
      }, function(e, r) {
        if (e) {
          reject(e);
          return ;
        }
        if (self.options.stringifyState)
          r.state = JSON.parse(r.state);
        resolve(r);
      });
    });
  });
};
MongoDBPersistence.prototype.removeState = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    function remove() {
      return new Promise(function(resolve, reject) {
        self._stateCollection.remove({
          workflowName: workflowName,
          instanceId: instanceId
        }, {w: "majority"}, function(e) {
          if (e)
            reject(e);
          else
            resolve();
        });
      });
    }
    if (self.options.enablePromotions) {
      return Promise.all([remove(), new Promise(function(resolve, reject) {
        self._promotedPropertiesCollection.remove({
          workflowName: workflowName,
          instanceId: instanceId
        }, {w: "majority"}, function(e) {
          if (e)
            reject(e);
          else
            resolve();
        });
      })]);
    } else {
      return remove();
    }
  });
};
MongoDBPersistence.prototype.loadPromotedProperties = function(workflowName, instanceId) {
  var self = this;
  instanceId = instanceId.toString();
  return self._connectAndInit().then(function() {
    return new Promise(function(resolve, reject) {
      self._promotedPropertiesCollection.findOne({
        workflowName: workflowName,
        instanceId: instanceId
      }, {
        w: "majority",
        fields: {properties: 1}
      }, function(e, pp) {
        if (e) {
          reject(e);
          return ;
        }
        resolve(pp ? pp.properties : null);
      });
    });
  });
};
module.exports = MongoDBPersistence;
//# sourceMappingURL=data:application/json;base64,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LENBQUEsTUFBSyxDQUFHO0FBQzFDLFNBQUcsOEJBQThCLFFBQVEsQUFBQyxDQUN0QztBQUNJLG1CQUFXLENBQUcsYUFBVztBQUN6QixpQkFBUyxDQUFHLFdBQVM7QUFBQSxNQUN6QixDQUNBO0FBQ0ksUUFBQSxDQUFHLFdBQVM7QUFDWixhQUFLLENBQUcsRUFDSixVQUFTLENBQUcsRUFBQSxDQUNoQjtBQUFBLE1BQ0osQ0FDQSxVQUFVLENBQUEsQ0FBRyxDQUFBLEVBQUMsQ0FBRztBQUNiLFdBQUksQ0FBQSxDQUFHO0FBQ0gsZUFBSyxBQUFDLENBQUMsQ0FBQSxDQUFDLENBQUM7QUFDVCxpQkFBTTtRQUNWO0FBQUEsQUFFQSxjQUFNLEFBQUMsQ0FBQyxFQUFDLEVBQUksQ0FBQSxFQUFDLFdBQVcsRUFBSSxLQUFHLENBQUMsQ0FBQztNQUN0QyxDQUFDLENBQUM7SUFDVixDQUFDLENBQUM7RUFDTixDQUFDLENBQUM7QUFDVixDQUFBO0FBRUEsS0FBSyxRQUFRLEVBQUksbUJBQWlCLENBQUM7QUFDbkMiLCJmaWxlIjoiaG9zdGluZy9tb25nb0RCL21vbmdvREJQZXJzaXN0ZW5jZS5qcyIsInNvdXJjZVJvb3QiOiJDOi9HSVQvbW9uZ28tY3J1bmNoL2RlcHMvd29ya2Zsb3ctNC1ub2RlL2xpYi8iLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgUHJvbWlzZSA9IHJlcXVpcmUoXCJibHVlYmlyZFwiKTtcclxudmFyIF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG52YXIgbW9uZ29kYiA9IHJlcXVpcmUoXCJtb25nb2RiXCIpO1xyXG52YXIgTW9uZ29DbGllbnQgPSBtb25nb2RiLk1vbmdvQ2xpZW50O1xyXG52YXIgZmFzdCA9IHJlcXVpcmUoXCJmYXN0LmpzXCIpO1xyXG5cclxuZnVuY3Rpb24gTW9uZ29EQlBlcnNpc3RlbmNlKG9wdGlvbnMpIHtcclxuICAgIGlmICghXy5pc09iamVjdChvcHRpb25zKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIk9iamVjdCBhcmd1bWVudCAnb3B0aW9ucycgZXhwZWN0ZWQuXCIpO1xyXG4gICAgaWYgKCFfLmlzU3RyaW5nKG9wdGlvbnMuY29ubmVjdGlvbikpIHRocm93IG5ldyBFcnJvcihcIkNvbm5lY3Rpb24gZXhwZWN0ZWQgaW4gdGhlIG9wdGlvbnMuXCIpO1xyXG4gICAgdGhpcy5fb3B0aW9ucyA9IF8uZXh0ZW5kKFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgY29ubmVjdGlvbk9wdGlvbnM6IHtkYjoge25hdGl2ZV9wYXJzZXI6IGZhbHNlfX0sXHJcbiAgICAgICAgICAgIHN0YXRlQ29sbGVjdGlvbk5hbWU6IFwiV0ZTdGF0ZVwiLFxyXG4gICAgICAgICAgICBwcm9tb3RlZFByb3BlcnRpZXNDb2xsZWN0aW9uTmFtZTogXCJXRlByb21vdGVkUHJvcGVydGllc1wiLFxyXG4gICAgICAgICAgICBsb2Nrc0NvbGxlY3Rpb25OYW1lOiBcIldGTG9ja3NcIixcclxuICAgICAgICAgICAgc3RyaW5naWZ5U3RhdGU6IHRydWVcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9wdGlvbnMpO1xyXG4gICAgdGhpcy5fZGIgPSBudWxsO1xyXG4gICAgdGhpcy5fc3RhdGVDb2xsZWN0aW9uID0gbnVsbDtcclxuICAgIHRoaXMuX3Byb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb24gPSBudWxsO1xyXG4gICAgdGhpcy5fbG9ja3NDb2xsZWN0aW9uID0gbnVsbDtcclxuICAgIHRoaXMuX2Nvbm5lY3RlZEFuZEluaXRpYWxpemVkID0gZmFsc2U7XHJcbn1cclxuXHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFxyXG4gICAgTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZSxcclxuICAgIHtcclxuICAgICAgICBvcHRpb25zOiB7XHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29wdGlvbnM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX2Nvbm5lY3RBbmRJbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKFxyXG4gICAgICAgIGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGlmICghc2VsZi5fY29ubmVjdGVkQW5kSW5pdGlhbGl6ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBNb25nb0NsaWVudC5jb25uZWN0KHNlbGYub3B0aW9ucy5jb25uZWN0aW9uLCBzZWxmLm9wdGlvbnMuY29ubmVjdGlvbk9wdGlvbnMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlLCBkYikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBnZXRDb2xsID0gZnVuY3Rpb24gKG5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKGdjcmVzb2x2ZSwgZ2NyZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGIuY3JlYXRlQ29sbGVjdGlvbihuYW1lLCBmdW5jdGlvbiAoZSwgY29sbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIGdjcmVqZWN0KGUpOyBlbHNlIGdjcmVzb2x2ZShjb2xsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRDb2xsKHNlbGYub3B0aW9ucy5zdGF0ZUNvbGxlY3Rpb25OYW1lKS50aGVuKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoY29sbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3RhdGVDb2xsZWN0aW9uID0gY29sbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0Q29sbChzZWxmLm9wdGlvbnMubG9ja3NDb2xsZWN0aW9uTmFtZSkudGhlbihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGNvbGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2xvY2tzQ29sbGVjdGlvbiA9IGNvbGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldENvbGwoc2VsZi5vcHRpb25zLnByb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb25OYW1lKS50aGVuKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoY29sbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbiA9IGNvbGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2Vuc3VyZUluZGV4ZXMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fZGIgPSBkYjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY29ubmVjdGVkQW5kSW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zdGF0ZUNvbGxlY3Rpb24gPSBzZWxmLl9sb2Nrc0NvbGxlY3Rpb24gPSBzZWxmLl9wcm9tb3RlZFByb3BlcnRpZXNDb2xsZWN0aW9uID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUgfHwgbmV3IEVycm9yKFwiSW5kZXggY3JlYXRlIGVycm9yLlwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QoZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxufVxyXG5cclxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5fZW5zdXJlSW5kZXhlcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xyXG4gICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgc2VsZi5fbG9ja3NDb2xsZWN0aW9uLmVuc3VyZUluZGV4KHtuYW1lOiAxfSwge3c6IFwibWFqb3JpdHlcIiwgdW5pcXVlOiB0cnVlfSwgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlKSByZWplY3QoZSk7IGVsc2UgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KSxcclxuICAgICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgIHNlbGYuX2xvY2tzQ29sbGVjdGlvbi5lbnN1cmVJbmRleCh7aGVsZFRvOiAxfSwge3c6IFwibWFqb3JpdHlcIiwgdW5pcXVlOiBmYWxzZX0sIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZSkgcmVqZWN0KGUpOyBlbHNlIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICBzZWxmLl9zdGF0ZUNvbGxlY3Rpb24uZW5zdXJlSW5kZXgoe3dvcmtmbG93TmFtZTogMSwgaW5zdGFuY2VJZDogMX0sIHt3OiBcIm1ham9yaXR5XCIsIHVuaXF1ZTogdHJ1ZX0sIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZSkgcmVqZWN0KGUpOyBlbHNlIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICBzZWxmLl9wcm9tb3RlZFByb3BlcnRpZXNDb2xsZWN0aW9uLmVuc3VyZUluZGV4KHt3b3JrZmxvd05hbWU6IDEsIGluc3RhbmNlSWQ6IDF9LCB7XHJcbiAgICAgICAgICAgICAgICB3OiBcIm1ham9yaXR5XCIsXHJcbiAgICAgICAgICAgICAgICB1bmlxdWU6IHRydWVcclxuICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlKSByZWplY3QoZSk7IGVsc2UgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KVxyXG4gICAgXSk7XHJcbn1cclxuXHJcbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUuY2xvc2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGlmIChzZWxmLl9jb25uZWN0ZWRBbmRJbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fZGIuY2xvc2UoZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY29ubmVjdGVkQW5kSW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLl9kYiA9IHNlbGYuX3N0YXRlQ29sbGVjdGlvbiA9IHNlbGYuX2xvY2tzQ29sbGVjdGlvbiA9IHNlbGYuX3Byb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb24gPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QoZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuLy8gTE9DS0lOR1xyXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLmVudGVyTG9jayA9IGZ1bmN0aW9uIChsb2NrTmFtZSwgaW5Mb2NrVGltZW91dE1zKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICB2YXIgbm93ID0gbmV3IERhdGUoKTtcclxuXHJcbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbW92ZU9sZExvY2tzKCk7XHJcbiAgICAgICAgfSkudGhlbihcclxuICAgICAgICBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9sb2Nrc0NvbGxlY3Rpb24uaW5zZXJ0T25lKFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbG9ja05hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlbGRUbzogbm93LmFkZE1pbGxpc2Vjb25kcyhpbkxvY2tUaW1lb3V0TXMpXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7dzogXCJtYWpvcml0eVwifSxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSwgcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS50b1N0cmluZygpLmluZGV4T2YoXCJFMTEwMDBcIikgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpOyAvLyBTb21lIE1vbmdvREIgZXJyb3JcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpOyAvLyBJdCdzIGhlbGQuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuaW5zZXJ0ZWRDb3VudCA9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpOyAvLyBJdCdzIGhlbGQuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHJlc3VsdC5vcHNbMF0uX2lkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogcmVzdWx0Lm9wc1swXS5uYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVsZFRvOiByZXN1bHQub3BzWzBdLmhlbGRUb1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUucmVuZXdMb2NrID0gZnVuY3Rpb24gKGxvY2tJZCwgaW5Mb2NrVGltZW91dE1zKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fbG9ja3NDb2xsZWN0aW9uLnVwZGF0ZShcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9pZDogbG9ja0lkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWxkVG86IHskbHRlOiBub3d9XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzZXQ6IHtoZWxkVG86IG5vdy5hZGRNaWxsaXNlY29uZHMoaW5Mb2NrVGltZW91dE1zKX1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHt3OiBcIm1ham9yaXR5XCJ9LFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlLCByKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHIubk1vZGlmaWVkID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKFwiTG9jayBieSBpZCAnXCIgKyBsb2NrSWQgKyBcIicgZG9lc24ndCBleGlzdHMgb3Igbm90IGhlbGQuXCIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG59XHJcblxyXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLmV4aXRMb2NrID0gZnVuY3Rpb24gKGxvY2tJZCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXHJcbiAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fbG9ja3NDb2xsZWN0aW9uLnJlbW92ZShcclxuICAgICAgICAgICAgICAgICAgICB7X2lkOiBsb2NrSWR9LFxyXG4gICAgICAgICAgICAgICAgICAgIHt3OiBcIm1ham9yaXR5XCJ9LFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSByZWplY3QoZSk7IGVsc2UgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxufTtcclxuXHJcbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUuX3JlbW92ZU9sZExvY2tzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgdmFyIG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIHNlbGYuX2xvY2tzQ29sbGVjdGlvbi5yZW1vdmUoXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGhlbGRUbzoge1xyXG4gICAgICAgICAgICAgICAgICAgICRsdDogbm93XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHt3OiBcIm1ham9yaXR5XCJ9LFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUpIHJlamVjdChlKTsgZWxzZSByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbi8vIFNUQVRFXHJcblxyXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLmlzUnVubmluZyA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICBpbnN0YW5jZUlkID0gaW5zdGFuY2VJZC50b1N0cmluZygpO1xyXG5cclxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXHJcbiAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fc3RhdGVDb2xsZWN0aW9uLmZpbmRPbmUoXHJcbiAgICAgICAgICAgICAgICAgICAge3dvcmtmbG93TmFtZTogd29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkOiBpbnN0YW5jZUlkfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHc6IFwibWFqb3JpdHlcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzOiB7X2lkOiAxfVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUsIGlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShpZCA/IHRydWUgOiBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG59XHJcblxyXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLnBlcnNpc3RTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIHZhciBpbnN0YW5jZUlkID0gc3RhdGUuaW5zdGFuY2VJZC50b1N0cmluZygpO1xyXG5cclxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXHJcbiAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBmdW5jdGlvbiBwZXJzaXN0U3RhdGUoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuX3N0YXRlQ29sbGVjdGlvbi51cGRhdGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93TmFtZTogc3RhdGUud29ya2Zsb3dOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGFuY2VJZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHN0YXRlLndvcmtmbG93TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd1ZlcnNpb246IHN0YXRlLndvcmtmbG93VmVyc2lvbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZWRPbjogc3RhdGUuY3JlYXRlZE9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZE9uOiBzdGF0ZS51cGRhdGVkT24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZTogc2VsZi5vcHRpb25zLnN0cmluZ2lmeVN0YXRlID8gSlNPTi5zdHJpbmdpZnkoc3RhdGUuc3RhdGUpIDogc3RhdGUuc3RhdGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdzogXCJtYWpvcml0eVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBzZXJ0OiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSkgcmVqZWN0KGUpOyBlbHNlIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHN0YXRlLnByb21vdGVkUHJvcGVydGllcykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFxyXG4gICAgICAgICAgICAgICAgICAgIFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGVyc2lzdFN0YXRlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Byb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb24udXBkYXRlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiBzdGF0ZS53b3JrZmxvd05hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiBzdGF0ZS53b3JrZmxvd05hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtmbG93VmVyc2lvbjogc3RhdGUud29ya2Zsb3dWZXJzaW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkT246IHN0YXRlLmNyZWF0ZWRPbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZE9uOiBzdGF0ZS51cGRhdGVkT24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHN0YXRlLnByb21vdGVkUHJvcGVydGllc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3OiBcIm1ham9yaXR5XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwc2VydDogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHJlamVjdChlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcGVyc2lzdFN0YXRlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxufVxyXG5cclxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5nZXRSdW5uaW5nSW5zdGFuY2VJZEhlYWRlciA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICBpbnN0YW5jZUlkID0gaW5zdGFuY2VJZC50b1N0cmluZygpO1xyXG5cclxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXHJcbiAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fc3RhdGVDb2xsZWN0aW9uLmZpbmRPbmUoXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JrZmxvd05hbWU6IHdvcmtmbG93TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VJZDogaW5zdGFuY2VJZFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3OiBcIm1ham9yaXR5XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkczoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZE9uOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dWZXJzaW9uOiAxXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlLCByZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxufVxyXG5cclxuTW9uZ29EQlBlcnNpc3RlbmNlLnByb3RvdHlwZS5sb2FkU3RhdGUgPSBmdW5jdGlvbiAod29ya2Zsb3dOYW1lLCBpbnN0YW5jZUlkKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgaW5zdGFuY2VJZCA9IGluc3RhbmNlSWQudG9TdHJpbmcoKTtcclxuXHJcbiAgICByZXR1cm4gc2VsZi5fY29ubmVjdEFuZEluaXQoKS50aGVuKFxyXG4gICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX3N0YXRlQ29sbGVjdGlvbi5maW5kT25lKFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiB3b3JrZmxvd05hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWRcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdzogXCJtYWpvcml0eVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IHtfaWQ6IGZhbHNlfVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUsIHIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5zdHJpbmdpZnlTdGF0ZSkgci5zdGF0ZSA9IEpTT04ucGFyc2Uoci5zdGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG59XHJcblxyXG5Nb25nb0RCUGVyc2lzdGVuY2UucHJvdG90eXBlLnJlbW92ZVN0YXRlID0gZnVuY3Rpb24gKHdvcmtmbG93TmFtZSwgaW5zdGFuY2VJZCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIGluc3RhbmNlSWQgPSBpbnN0YW5jZUlkLnRvU3RyaW5nKCk7XHJcblxyXG4gICAgcmV0dXJuIHNlbGYuX2Nvbm5lY3RBbmRJbml0KCkudGhlbihcclxuICAgICAgICBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZSgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3RhdGVDb2xsZWN0aW9uLnJlbW92ZShcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiB3b3JrZmxvd05hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZUlkOiBpbnN0YW5jZUlkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHt3OiBcIm1ham9yaXR5XCJ9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHJlamVjdChlKTsgZWxzZSByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuZW5hYmxlUHJvbW90aW9ucykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFxyXG4gICAgICAgICAgICAgICAgICAgIFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Byb21vdGVkUHJvcGVydGllc0NvbGxlY3Rpb24ucmVtb3ZlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiB3b3JrZmxvd05hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHt3OiBcIm1ham9yaXR5XCJ9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSByZWplY3QoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIF0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlbW92ZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbk1vbmdvREJQZXJzaXN0ZW5jZS5wcm90b3R5cGUubG9hZFByb21vdGVkUHJvcGVydGllcyA9IGZ1bmN0aW9uICh3b3JrZmxvd05hbWUsIGluc3RhbmNlSWQpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICBpbnN0YW5jZUlkID0gaW5zdGFuY2VJZC50b1N0cmluZygpO1xyXG5cclxuICAgIHJldHVybiBzZWxmLl9jb25uZWN0QW5kSW5pdCgpLnRoZW4oXHJcbiAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fcHJvbW90ZWRQcm9wZXJ0aWVzQ29sbGVjdGlvbi5maW5kT25lKFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd29ya2Zsb3dOYW1lOiB3b3JrZmxvd05hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlSWRcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdzogXCJtYWpvcml0eVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IDFcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUsIHBwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocHAgPyBwcC5wcm9wZXJ0aWVzIDogbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IE1vbmdvREJQZXJzaXN0ZW5jZTtcclxuIl19
