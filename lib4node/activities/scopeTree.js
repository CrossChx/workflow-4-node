"use strict";
var ScopeNode = require("./scopeNode");
var guids = require("../common/guids");
var StrMap = require("backpack-node").collections.StrMap;
var StrSet = require("backpack-node").collections.StrSet;
var _ = require("lodash");
var specStrings = require("../common/specStrings");
var errors = require("../common/errors");
var is = require("../common/is");
var scope = require("./scope");
var fast = require("fast.js");
function ScopeTree(initialScope, getActivityByIdFunc) {
  this._initialNode = new ScopeNode(guids.ids.initialScope, initialScope);
  this._nodes = new StrMap();
  this._nodes.add(this._initialNode.id, this._initialNode);
  this._getActivityById = getActivityByIdFunc;
}
ScopeTree.prototype.getState = function(getPromotions) {
  var self = this;
  var state = [];
  var promotedProperties = getPromotions ? new StrMap() : null;
  self._nodes.forEachValue(function(node) {
    if (node.id === guids.ids.initialScope)
      return ;
    var item = {
      id: node.id,
      parentId: node.parent ? node.parent.id : null,
      parts: []
    };
    var activity = self._getActivityById(node.id);
    node.forEachProperty(function(propertyName, propertyValue) {
      if (!activity.nonSerializedProperties.exists(propertyName)) {
        if (_.isArray(propertyValue)) {
          var iPart = {
            name: propertyName,
            value: []
          };
          item.parts.push(iPart);
          propertyValue.forEach(function(pv) {
            if (is.activity(pv)) {
              iPart.value.push(specStrings.hosting.createActivityInstancePart(pv.id));
            } else {
              iPart.value.push(pv);
            }
          });
        } else if (is.activity(propertyValue)) {
          item.parts.push({
            name: propertyName,
            value: specStrings.hosting.createActivityInstancePart(propertyValue.id)
          });
        } else if (_.isFunction(propertyValue) && !activity.hasOwnProperty(propertyName) && _.isFunction(activity[propertyName])) {
          item.parts.push(specStrings.hosting.createActivityPropertyPart(propertyName));
        } else if (_.isObject(propertyValue) && propertyValue === activity[propertyName]) {
          item.parts.push(specStrings.hosting.createActivityPropertyPart(propertyName));
        } else {
          item.parts.push({
            name: propertyName,
            value: propertyValue
          });
        }
      }
    });
    state.push(item);
    if (promotedProperties && activity.promotedProperties) {
      activity.promotedProperties.forEach(function(promotedPropName) {
        var pv = node.getPropertyValue(promotedPropName, true);
        if (is.defined(pv) && !(is.activity(pv))) {
          var promotedEntry = promotedProperties.get(promotedPropName);
          if (is.undefined(promotedEntry) || node.id > promotedEntry.level) {
            promotedProperties.add(promotedPropName, {
              level: node.id,
              value: pv
            });
          }
        }
      });
    }
  });
  var actualPromotions = null;
  if (promotedProperties) {
    var actualPromotions = {};
    if (promotedProperties.count) {
      promotedProperties.forEach(function(kvp) {
        actualPromotions[kvp.key] = kvp.value.value;
      });
    }
  }
  return {
    state: state,
    promotedProperties: actualPromotions
  };
};
ScopeTree.prototype.setState = function(json) {
  var self = this;
  if (!_.isArray(json))
    throw new TypeError("Array argument expected.");
  if (self._nodes.count != 1) {
    self._nodes.forEachKey(function(key) {
      if (key === guids.ids.initialScope)
        return ;
      self._nodes.remove(key);
    });
    self._initialNode.clearChildren();
  }
  var e = fast.try(function() {
    json.forEach(function(item) {
      var scopePart = {};
      var activity = self._getActivityById(item.id);
      item.parts.forEach(function(part) {
        var activityProperty = specStrings.hosting.getActivityPropertyName(part);
        if (activityProperty) {
          if (_.isUndefined(scopePart[activityProperty] = activity[activityProperty]))
            throw new Error("Activity has no property '" + part + "'.");
        } else {
          var activityId = specStrings.hosting.getActivityId(part.value);
          if (activityId) {
            scopePart[part.name] = self._getActivityById(activityId);
          } else if (_.isArray(part.value)) {
            var scopePartValue = [];
            scopePart[part.name] = scopePartValue;
            part.value.forEach(function(pv) {
              activityId = specStrings.hosting.getActivityId(pv);
              if (activityId) {
                scopePartValue.push(self._getActivityById(activityId));
              } else {
                scopePartValue.push(pv);
              }
            });
          } else {
            scopePart[part.name] = part.value;
          }
        }
      });
      var node = new ScopeNode(item.id, scopePart);
      self._nodes.add(item.id, node);
    });
    json.forEach(function(item) {
      self._nodes.get(item.id).parent = self._nodes.get(item.parentId);
    });
  });
  if (e instanceof Error)
    throw new errors.WorkflowError("Cannot restore state tree, because data is corrupt. Inner error: " + e.stack);
};
ScopeTree.prototype.hasProperty = function(currentNode, name) {
  var found = false;
  currentNode.forEachToRoot(function(node) {
    if (node.isPropertyExists(name)) {
      found = true;
      return false;
    }
  });
  return found;
};
ScopeTree.prototype.getValue = function(currentNode, name) {
  var canReturnPrivate = true;
  var value;
  currentNode.forEachToRoot(function(node) {
    if (is.defined(value = node.getPropertyValue(name, canReturnPrivate)))
      return false;
    canReturnPrivate = false;
  });
  return value;
};
ScopeTree.prototype.setValue = function(currentNode, name, value) {
  if (this.isOnInitial)
    throw new Error("Cannot set property of the initial scope.");
  var self = this;
  var canSetPrivate = true;
  var setDone = false;
  currentNode.forEachToRoot(function(node) {
    if (node === self._initialNode)
      return false;
    if (node.setPropertyValue(name, value, canSetPrivate)) {
      setDone = true;
      return false;
    }
    canSetPrivate = false;
  });
  if (!setDone)
    currentNode.createPropertyWithValue(name, value);
  return true;
};
ScopeTree.prototype.deleteProperty = function(currentNode, name) {
  var self = this;
  var canDeletePrivate = true;
  var deleteDone = false;
  currentNode.forEachToRoot(function(node) {
    if (node === self._initialNode)
      return false;
    if (node.deleteProperty(name, canDeletePrivate)) {
      deleteDone = true;
      return false;
    }
    canDeletePrivate = false;
  });
  return deleteDone;
};
ScopeTree.prototype.enumeratePropertyNames = $traceurRuntime.initGeneratorFunction(function $__0(currentNode) {
  var canEnumeratePrivate,
      node,
      $__1,
      $__2;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          canEnumeratePrivate = true;
          node = currentNode;
          $ctx.state = 17;
          break;
        case 17:
          $__1 = $ctx.wrapYieldStar(node.enumeratePropertyNames(canEnumeratePrivate)[Symbol.iterator]());
          $ctx.sent = void 0;
          $ctx.action = 'next';
          $ctx.state = 12;
          break;
        case 12:
          $__2 = $__1[$ctx.action]($ctx.sentIgnoreThrow);
          $ctx.state = 9;
          break;
        case 9:
          $ctx.state = ($__2.done) ? 3 : 2;
          break;
        case 3:
          $ctx.sent = $__2.value;
          $ctx.state = 10;
          break;
        case 2:
          $ctx.state = 12;
          return $__2.value;
        case 10:
          canEnumeratePrivate = false;
          node = node.parent;
          $ctx.state = 14;
          break;
        case 14:
          $ctx.state = (node) ? 17 : -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__0, this);
});
ScopeTree.prototype.next = function(nodeId, childId, scopePart) {
  var currentNode = this._getNodeByExternalId(nodeId);
  var nextNode = new ScopeNode(childId, scopePart);
  currentNode.addChild(nextNode);
  this._nodes.add(childId, nextNode);
  return scope.create(this, nextNode);
};
ScopeTree.prototype.back = function(nodeId, keepItem) {
  var currentNode = this._getNodeByExternalId(nodeId);
  if (currentNode === this._initialNode)
    throw new Error("Cannot go back because current scope is the initial scope.");
  var toRemove = currentNode;
  var goTo = toRemove.parent;
  currentNode = goTo;
  if (!keepItem) {
    goTo.removeChild(toRemove);
    this._nodes.remove(toRemove.id);
  }
  return scope.create(this, currentNode);
};
ScopeTree.prototype.find = function(nodeId) {
  var currentNode = this._getNodeByExternalId(nodeId);
  return scope.create(this, currentNode);
};
ScopeTree.prototype._getNodeByExternalId = function(id) {
  if (id === null)
    return this._initialNode;
  var node = this._nodes.get(id);
  if (!node) {
    throw new Error("Scope node for activity id '" + id + "' is not found.");
  }
  return node;
};
ScopeTree.prototype.deleteScopePart = function(currentNodeId, id) {
  var self = this;
  var currentNode = this._getNodeByExternalId(currentNodeId);
  var delNode = self._nodes.get(id);
  if (delNode) {
    if (delNode === self._initialNode)
      throw new Error("Cannot delete the initial scope.");
    var found = false;
    delNode.forEachToRoot(function(node) {
      if (node === currentNode) {
        found = true;
        return false;
      }
    });
    if (!found)
      throw new Error("Cannot delete scope, because current active scope is inside in it.");
    delNode.parent.removeChild(delNode);
    self._removeAllNodes(delNode);
  }
};
ScopeTree.prototype._removeAllNodes = function(node) {
  var self = this;
  self._nodes.remove(node.id);
  node.forEachChild(function(c) {
    self._removeAllNodes(c);
  });
};
module.exports = ScopeTree;
//# sourceMappingURL=data:application/json;base64,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QU8sQUFBQyxDQUFDLElBQUcsR0FBRyxDQUFDLENBQUM7QUFDM0IsS0FBRyxhQUFhLEFBQUMsQ0FBQyxTQUFVLENBQUEsQ0FBRztBQUMzQixPQUFHLGdCQUFnQixBQUFDLENBQUMsQ0FBQSxDQUFDLENBQUM7RUFDM0IsQ0FBQyxDQUFDO0FBQ04sQ0FBQTtBQUVBLEtBQUssUUFBUSxFQUFJLFVBQVEsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvc2NvcGVUcmVlLmpzIiwic291cmNlUm9vdCI6IkM6L0dJVC9tb25nby1jcnVuY2gvZGVwcy93b3JrZmxvdy00LW5vZGUvbGliLyIsInNvdXJjZXNDb250ZW50IjpbInZhciBTY29wZU5vZGUgPSByZXF1aXJlKFwiLi9zY29wZU5vZGVcIik7XHJcbnZhciBndWlkcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZ3VpZHNcIik7XHJcbnZhciBTdHJNYXAgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5jb2xsZWN0aW9ucy5TdHJNYXA7XHJcbnZhciBTdHJTZXQgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5jb2xsZWN0aW9ucy5TdHJTZXQ7XHJcbnZhciBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcclxudmFyIHNwZWNTdHJpbmdzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9zcGVjU3RyaW5nc1wiKTtcclxudmFyIGVycm9ycyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZXJyb3JzXCIpO1xyXG52YXIgaXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2lzXCIpO1xyXG52YXIgc2NvcGUgPSByZXF1aXJlKFwiLi9zY29wZVwiKTtcclxudmFyIGZhc3QgPSByZXF1aXJlKFwiZmFzdC5qc1wiKTtcclxuXHJcbmZ1bmN0aW9uIFNjb3BlVHJlZShpbml0aWFsU2NvcGUsIGdldEFjdGl2aXR5QnlJZEZ1bmMpIHtcclxuICAgIHRoaXMuX2luaXRpYWxOb2RlID0gbmV3IFNjb3BlTm9kZShndWlkcy5pZHMuaW5pdGlhbFNjb3BlLCBpbml0aWFsU2NvcGUpO1xyXG4gICAgdGhpcy5fbm9kZXMgPSBuZXcgU3RyTWFwKCk7XHJcbiAgICB0aGlzLl9ub2Rlcy5hZGQodGhpcy5faW5pdGlhbE5vZGUuaWQsIHRoaXMuX2luaXRpYWxOb2RlKTtcclxuICAgIHRoaXMuX2dldEFjdGl2aXR5QnlJZCA9IGdldEFjdGl2aXR5QnlJZEZ1bmM7XHJcbn1cclxuXHJcbi8qIFNFUklBTElaQVRJT04gKi9cclxuU2NvcGVUcmVlLnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uIChnZXRQcm9tb3Rpb25zKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICB2YXIgc3RhdGUgPSBbXTtcclxuICAgIHZhciBwcm9tb3RlZFByb3BlcnRpZXMgPSBnZXRQcm9tb3Rpb25zID8gbmV3IFN0ck1hcCgpIDogbnVsbDtcclxuXHJcbiAgICBzZWxmLl9ub2Rlcy5mb3JFYWNoVmFsdWUoXHJcbiAgICAgICAgZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgaWYgKG5vZGUuaWQgPT09IGd1aWRzLmlkcy5pbml0aWFsU2NvcGUpIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIHZhciBpdGVtID0ge1xyXG4gICAgICAgICAgICAgICAgaWQ6IG5vZGUuaWQsXHJcbiAgICAgICAgICAgICAgICBwYXJlbnRJZDogbm9kZS5wYXJlbnQgPyBub2RlLnBhcmVudC5pZCA6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBwYXJ0czogW11cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHZhciBhY3Rpdml0eSA9IHNlbGYuX2dldEFjdGl2aXR5QnlJZChub2RlLmlkKTtcclxuXHJcbiAgICAgICAgICAgIG5vZGUuZm9yRWFjaFByb3BlcnR5KFxyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKHByb3BlcnR5TmFtZSwgcHJvcGVydHlWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghYWN0aXZpdHkubm9uU2VyaWFsaXplZFByb3BlcnRpZXMuZXhpc3RzKHByb3BlcnR5TmFtZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF8uaXNBcnJheShwcm9wZXJ0eVZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlQYXJ0ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHByb3BlcnR5TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogW11cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnBhcnRzLnB1c2goaVBhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlWYWx1ZS5mb3JFYWNoKGZ1bmN0aW9uIChwdikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpcy5hY3Rpdml0eShwdikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaVBhcnQudmFsdWUucHVzaChzcGVjU3RyaW5ncy5ob3N0aW5nLmNyZWF0ZUFjdGl2aXR5SW5zdGFuY2VQYXJ0KHB2LmlkKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpUGFydC52YWx1ZS5wdXNoKHB2KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpcy5hY3Rpdml0eShwcm9wZXJ0eVZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5wYXJ0cy5wdXNoKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogcHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc3BlY1N0cmluZ3MuaG9zdGluZy5jcmVhdGVBY3Rpdml0eUluc3RhbmNlUGFydChwcm9wZXJ0eVZhbHVlLmlkKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF8uaXNGdW5jdGlvbihwcm9wZXJ0eVZhbHVlKSAmJiAhYWN0aXZpdHkuaGFzT3duUHJvcGVydHkocHJvcGVydHlOYW1lKSAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5pc0Z1bmN0aW9uKGFjdGl2aXR5W3Byb3BlcnR5TmFtZV0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnBhcnRzLnB1c2goc3BlY1N0cmluZ3MuaG9zdGluZy5jcmVhdGVBY3Rpdml0eVByb3BlcnR5UGFydChwcm9wZXJ0eU5hbWUpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChfLmlzT2JqZWN0KHByb3BlcnR5VmFsdWUpICYmIHByb3BlcnR5VmFsdWUgPT09IGFjdGl2aXR5W3Byb3BlcnR5TmFtZV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ucGFydHMucHVzaChzcGVjU3RyaW5ncy5ob3N0aW5nLmNyZWF0ZUFjdGl2aXR5UHJvcGVydHlQYXJ0KHByb3BlcnR5TmFtZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5wYXJ0cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBwcm9wZXJ0eU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHByb3BlcnR5VmFsdWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHN0YXRlLnB1c2goaXRlbSk7XHJcblxyXG4gICAgICAgICAgICAvLyBQcm9tb3Rpb25zOlxyXG4gICAgICAgICAgICBpZiAocHJvbW90ZWRQcm9wZXJ0aWVzICYmIGFjdGl2aXR5LnByb21vdGVkUHJvcGVydGllcykge1xyXG4gICAgICAgICAgICAgICAgYWN0aXZpdHkucHJvbW90ZWRQcm9wZXJ0aWVzLmZvckVhY2goXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKHByb21vdGVkUHJvcE5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHB2ID0gbm9kZS5nZXRQcm9wZXJ0eVZhbHVlKHByb21vdGVkUHJvcE5hbWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXMuZGVmaW5lZChwdikgJiYgIShpcy5hY3Rpdml0eShwdikpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvbW90ZWRFbnRyeSA9IHByb21vdGVkUHJvcGVydGllcy5nZXQocHJvbW90ZWRQcm9wTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBhbiBBY3Rpdml0eSBJZCBncmVhdGVyIHRoYW4gb3RoZXIsIHRoZW4gd2UgY2FuIHN1cmUgdGhhdCBvdGhlciBiZWxvdyBvciBhZnRlciBpbiB0aGUgdHJlZS5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpcy51bmRlZmluZWQocHJvbW90ZWRFbnRyeSkgfHwgbm9kZS5pZCA+IHByb21vdGVkRW50cnkubGV2ZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9tb3RlZFByb3BlcnRpZXMuYWRkKHByb21vdGVkUHJvcE5hbWUsIHtsZXZlbDogbm9kZS5pZCwgdmFsdWU6IHB2fSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIHZhciBhY3R1YWxQcm9tb3Rpb25zID0gbnVsbDtcclxuICAgIGlmIChwcm9tb3RlZFByb3BlcnRpZXMpIHtcclxuICAgICAgICB2YXIgYWN0dWFsUHJvbW90aW9ucyA9IHt9O1xyXG4gICAgICAgIGlmIChwcm9tb3RlZFByb3BlcnRpZXMuY291bnQpIHtcclxuICAgICAgICAgICAgcHJvbW90ZWRQcm9wZXJ0aWVzLmZvckVhY2goXHJcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoa3ZwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWN0dWFsUHJvbW90aW9uc1trdnAua2V5XSA9IGt2cC52YWx1ZS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHN0YXRlOiBzdGF0ZSxcclxuICAgICAgICBwcm9tb3RlZFByb3BlcnRpZXM6IGFjdHVhbFByb21vdGlvbnNcclxuICAgIH07XHJcbn1cclxuXHJcblNjb3BlVHJlZS5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbiAoanNvbikge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIGlmICghXy5pc0FycmF5KGpzb24pKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJyYXkgYXJndW1lbnQgZXhwZWN0ZWQuXCIpO1xyXG5cclxuICAgIGlmIChzZWxmLl9ub2Rlcy5jb3VudCAhPSAxKSB7XHJcbiAgICAgICAgLy8gVGhlcmUgYXJlIGhpZGRlbiBpZGxlIHN0YXRlOlxyXG4gICAgICAgIHNlbGYuX25vZGVzLmZvckVhY2hLZXkoXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChrZXkpIHtcclxuICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IGd1aWRzLmlkcy5pbml0aWFsU2NvcGUpIHJldHVybjtcclxuICAgICAgICAgICAgICAgIHNlbGYuX25vZGVzLnJlbW92ZShrZXkpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgc2VsZi5faW5pdGlhbE5vZGUuY2xlYXJDaGlsZHJlbigpO1xyXG4gICAgfVxyXG5cclxuICAgIHZhciBlID0gZmFzdC50cnkoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGpzb24uZm9yRWFjaChcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICAgICAgICAgIHZhciBzY29wZVBhcnQgPSB7fTtcclxuICAgICAgICAgICAgICAgIHZhciBhY3Rpdml0eSA9IHNlbGYuX2dldEFjdGl2aXR5QnlJZChpdGVtLmlkKTtcclxuICAgICAgICAgICAgICAgIGl0ZW0ucGFydHMuZm9yRWFjaChcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAocGFydCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWN0aXZpdHlQcm9wZXJ0eSA9IHNwZWNTdHJpbmdzLmhvc3RpbmcuZ2V0QWN0aXZpdHlQcm9wZXJ0eU5hbWUocGFydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpdml0eVByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZChzY29wZVBhcnRbYWN0aXZpdHlQcm9wZXJ0eV0gPSBhY3Rpdml0eVthY3Rpdml0eVByb3BlcnR5XSkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQWN0aXZpdHkgaGFzIG5vIHByb3BlcnR5ICdcIiArIHBhcnQgKyBcIicuXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGl2aXR5SWQgPSBzcGVjU3RyaW5ncy5ob3N0aW5nLmdldEFjdGl2aXR5SWQocGFydC52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZpdHlJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlUGFydFtwYXJ0Lm5hbWVdID0gc2VsZi5fZ2V0QWN0aXZpdHlCeUlkKGFjdGl2aXR5SWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoXy5pc0FycmF5KHBhcnQudmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlUGFydFZhbHVlID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVQYXJ0W3BhcnQubmFtZV0gPSBzY29wZVBhcnRWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0LnZhbHVlLmZvckVhY2goZnVuY3Rpb24gKHB2KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5SWQgPSBzcGVjU3RyaW5ncy5ob3N0aW5nLmdldEFjdGl2aXR5SWQocHYpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZpdHlJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVQYXJ0VmFsdWUucHVzaChzZWxmLl9nZXRBY3Rpdml0eUJ5SWQoYWN0aXZpdHlJZCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVQYXJ0VmFsdWUucHVzaChwdik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlUGFydFtwYXJ0Lm5hbWVdID0gcGFydC52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBuZXcgU2NvcGVOb2RlKGl0ZW0uaWQsIHNjb3BlUGFydCk7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9ub2Rlcy5hZGQoaXRlbS5pZCwgbm9kZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICBqc29uLmZvckVhY2goXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9ub2Rlcy5nZXQoaXRlbS5pZCkucGFyZW50ID0gc2VsZi5fbm9kZXMuZ2V0KGl0ZW0ucGFyZW50SWQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChlIGluc3RhbmNlb2YgRXJyb3IpIHRocm93IG5ldyBlcnJvcnMuV29ya2Zsb3dFcnJvcihcIkNhbm5vdCByZXN0b3JlIHN0YXRlIHRyZWUsIGJlY2F1c2UgZGF0YSBpcyBjb3JydXB0LiBJbm5lciBlcnJvcjogXCIgKyBlLnN0YWNrKTtcclxufVxyXG4vKiBTRVJJQUxJWkFUSU9OICovXHJcblxyXG4vKiBQUk9YWSAqL1xyXG5TY29wZVRyZWUucHJvdG90eXBlLmhhc1Byb3BlcnR5ID0gZnVuY3Rpb24gKGN1cnJlbnROb2RlLCBuYW1lKSB7XHJcbiAgICB2YXIgZm91bmQgPSBmYWxzZTtcclxuICAgIGN1cnJlbnROb2RlLmZvckVhY2hUb1Jvb3QoZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICBpZiAobm9kZS5pc1Byb3BlcnR5RXhpc3RzKG5hbWUpKSB7XHJcbiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGZvdW5kO1xyXG59XHJcblxyXG5TY29wZVRyZWUucHJvdG90eXBlLmdldFZhbHVlID0gZnVuY3Rpb24gKGN1cnJlbnROb2RlLCBuYW1lKSB7XHJcbiAgICB2YXIgY2FuUmV0dXJuUHJpdmF0ZSA9IHRydWU7XHJcbiAgICB2YXIgdmFsdWU7XHJcbiAgICBjdXJyZW50Tm9kZS5mb3JFYWNoVG9Sb290KGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgaWYgKGlzLmRlZmluZWQodmFsdWUgPSBub2RlLmdldFByb3BlcnR5VmFsdWUobmFtZSwgY2FuUmV0dXJuUHJpdmF0ZSkpKSByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgY2FuUmV0dXJuUHJpdmF0ZSA9IGZhbHNlO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbn1cclxuXHJcblNjb3BlVHJlZS5wcm90b3R5cGUuc2V0VmFsdWUgPSBmdW5jdGlvbiAoY3VycmVudE5vZGUsIG5hbWUsIHZhbHVlKSB7XHJcbiAgICBpZiAodGhpcy5pc09uSW5pdGlhbCkgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IHNldCBwcm9wZXJ0eSBvZiB0aGUgaW5pdGlhbCBzY29wZS5cIik7XHJcblxyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgdmFyIGNhblNldFByaXZhdGUgPSB0cnVlO1xyXG4gICAgdmFyIHNldERvbmUgPSBmYWxzZTtcclxuICAgIGN1cnJlbnROb2RlLmZvckVhY2hUb1Jvb3QoZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICBpZiAobm9kZSA9PT0gc2VsZi5faW5pdGlhbE5vZGUpIHJldHVybiBmYWxzZTtcclxuICAgICAgICBpZiAobm9kZS5zZXRQcm9wZXJ0eVZhbHVlKG5hbWUsIHZhbHVlLCBjYW5TZXRQcml2YXRlKSkge1xyXG4gICAgICAgICAgICBzZXREb25lID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYW5TZXRQcml2YXRlID0gZmFsc2U7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoIXNldERvbmUpIGN1cnJlbnROb2RlLmNyZWF0ZVByb3BlcnR5V2l0aFZhbHVlKG5hbWUsIHZhbHVlKTtcclxuXHJcbiAgICByZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuU2NvcGVUcmVlLnByb3RvdHlwZS5kZWxldGVQcm9wZXJ0eSA9IGZ1bmN0aW9uIChjdXJyZW50Tm9kZSwgbmFtZSkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgdmFyIGNhbkRlbGV0ZVByaXZhdGUgPSB0cnVlO1xyXG4gICAgdmFyIGRlbGV0ZURvbmUgPSBmYWxzZTtcclxuICAgIGN1cnJlbnROb2RlLmZvckVhY2hUb1Jvb3QoZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICBpZiAobm9kZSA9PT0gc2VsZi5faW5pdGlhbE5vZGUpIHJldHVybiBmYWxzZTtcclxuICAgICAgICBpZiAobm9kZS5kZWxldGVQcm9wZXJ0eShuYW1lLCBjYW5EZWxldGVQcml2YXRlKSkge1xyXG4gICAgICAgICAgICBkZWxldGVEb25lID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYW5EZWxldGVQcml2YXRlID0gZmFsc2U7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gZGVsZXRlRG9uZTtcclxufVxyXG5cclxuU2NvcGVUcmVlLnByb3RvdHlwZS5lbnVtZXJhdGVQcm9wZXJ0eU5hbWVzID0gZnVuY3Rpb24qIChjdXJyZW50Tm9kZSkge1xyXG4gICAgdmFyIGNhbkVudW1lcmF0ZVByaXZhdGUgPSB0cnVlO1xyXG4gICAgdmFyIG5vZGUgPSBjdXJyZW50Tm9kZTtcclxuICAgIGRvXHJcbiAgICB7XHJcbiAgICAgICAgeWllbGQqIG5vZGUuZW51bWVyYXRlUHJvcGVydHlOYW1lcyhjYW5FbnVtZXJhdGVQcml2YXRlKTtcclxuICAgICAgICBjYW5FbnVtZXJhdGVQcml2YXRlID0gZmFsc2U7XHJcbiAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50O1xyXG4gICAgfVxyXG4gICAgd2hpbGUgKG5vZGUpO1xyXG59XHJcbi8qIFBST1hZICovXHJcblxyXG4vKiBXQUxLICovXHJcblNjb3BlVHJlZS5wcm90b3R5cGUubmV4dCA9IGZ1bmN0aW9uIChub2RlSWQsIGNoaWxkSWQsIHNjb3BlUGFydCkge1xyXG4gICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChub2RlSWQpO1xyXG4gICAgdmFyIG5leHROb2RlID0gbmV3IFNjb3BlTm9kZShjaGlsZElkLCBzY29wZVBhcnQpO1xyXG4gICAgY3VycmVudE5vZGUuYWRkQ2hpbGQobmV4dE5vZGUpO1xyXG4gICAgdGhpcy5fbm9kZXMuYWRkKGNoaWxkSWQsIG5leHROb2RlKTtcclxuICAgIHJldHVybiBzY29wZS5jcmVhdGUodGhpcywgbmV4dE5vZGUpO1xyXG59XHJcblxyXG5TY29wZVRyZWUucHJvdG90eXBlLmJhY2sgPSBmdW5jdGlvbiAobm9kZUlkLCBrZWVwSXRlbSkge1xyXG4gICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5fZ2V0Tm9kZUJ5RXh0ZXJuYWxJZChub2RlSWQpO1xyXG4gICAgaWYgKGN1cnJlbnROb2RlID09PSB0aGlzLl9pbml0aWFsTm9kZSkgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGdvIGJhY2sgYmVjYXVzZSBjdXJyZW50IHNjb3BlIGlzIHRoZSBpbml0aWFsIHNjb3BlLlwiKTtcclxuICAgIHZhciB0b1JlbW92ZSA9IGN1cnJlbnROb2RlO1xyXG4gICAgdmFyIGdvVG8gPSB0b1JlbW92ZS5wYXJlbnQ7XHJcbiAgICBjdXJyZW50Tm9kZSA9IGdvVG87XHJcbiAgICBpZiAoIWtlZXBJdGVtKSB7XHJcbiAgICAgICAgZ29Uby5yZW1vdmVDaGlsZCh0b1JlbW92ZSk7XHJcbiAgICAgICAgdGhpcy5fbm9kZXMucmVtb3ZlKHRvUmVtb3ZlLmlkKTtcclxuICAgIH1cclxuICAgIHJldHVybiBzY29wZS5jcmVhdGUodGhpcywgY3VycmVudE5vZGUpO1xyXG59XHJcblxyXG5TY29wZVRyZWUucHJvdG90eXBlLmZpbmQgPSBmdW5jdGlvbiAobm9kZUlkKSB7XHJcbiAgICB2YXIgY3VycmVudE5vZGUgPSB0aGlzLl9nZXROb2RlQnlFeHRlcm5hbElkKG5vZGVJZCk7XHJcbiAgICByZXR1cm4gc2NvcGUuY3JlYXRlKHRoaXMsIGN1cnJlbnROb2RlKTtcclxufVxyXG4vKiBXQUxLICovXHJcblxyXG5TY29wZVRyZWUucHJvdG90eXBlLl9nZXROb2RlQnlFeHRlcm5hbElkID0gZnVuY3Rpb24gKGlkKSB7XHJcbiAgICBpZiAoaWQgPT09IG51bGwpIHJldHVybiB0aGlzLl9pbml0aWFsTm9kZTtcclxuICAgIHZhciBub2RlID0gdGhpcy5fbm9kZXMuZ2V0KGlkKTtcclxuICAgIGlmICghbm9kZSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlNjb3BlIG5vZGUgZm9yIGFjdGl2aXR5IGlkICdcIiArIGlkICsgXCInIGlzIG5vdCBmb3VuZC5cIik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbm9kZTtcclxufVxyXG5cclxuU2NvcGVUcmVlLnByb3RvdHlwZS5kZWxldGVTY29wZVBhcnQgPSBmdW5jdGlvbiAoY3VycmVudE5vZGVJZCwgaWQpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuX2dldE5vZGVCeUV4dGVybmFsSWQoY3VycmVudE5vZGVJZCk7XHJcbiAgICB2YXIgZGVsTm9kZSA9IHNlbGYuX25vZGVzLmdldChpZCk7XHJcbiAgICBpZiAoZGVsTm9kZSkge1xyXG4gICAgICAgIGlmIChkZWxOb2RlID09PSBzZWxmLl9pbml0aWFsTm9kZSkgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGRlbGV0ZSB0aGUgaW5pdGlhbCBzY29wZS5cIik7XHJcbiAgICAgICAgdmFyIGZvdW5kID0gZmFsc2U7XHJcbiAgICAgICAgZGVsTm9kZS5mb3JFYWNoVG9Sb290KFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGN1cnJlbnROb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKCFmb3VuZCkgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGRlbGV0ZSBzY29wZSwgYmVjYXVzZSBjdXJyZW50IGFjdGl2ZSBzY29wZSBpcyBpbnNpZGUgaW4gaXQuXCIpO1xyXG4gICAgICAgIGRlbE5vZGUucGFyZW50LnJlbW92ZUNoaWxkKGRlbE5vZGUpO1xyXG4gICAgICAgIHNlbGYuX3JlbW92ZUFsbE5vZGVzKGRlbE5vZGUpO1xyXG4gICAgfVxyXG59XHJcblxyXG5TY29wZVRyZWUucHJvdG90eXBlLl9yZW1vdmVBbGxOb2RlcyA9IGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgc2VsZi5fbm9kZXMucmVtb3ZlKG5vZGUuaWQpO1xyXG4gICAgbm9kZS5mb3JFYWNoQ2hpbGQoZnVuY3Rpb24gKGMpIHtcclxuICAgICAgICBzZWxmLl9yZW1vdmVBbGxOb2RlcyhjKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IFNjb3BlVHJlZTsiXX0=
