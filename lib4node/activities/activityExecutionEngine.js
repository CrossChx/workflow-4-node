"use strict";
var Activity = require("./activity");
var ActivityExecutionContext = require("./activityExecutionContext");
var ActivityExecutionState = require("./activityExecutionState");
var CallContext = require("./callContext");
var EventEmitter = require('events').EventEmitter;
var util = require("util");
var errors = require("../common/errors");
var _ = require("lodash");
var ActivityStateTracker = require("./activityStateTracker");
var enums = require("../common/enums");
var Promise = require("bluebird");
var fast = require("fast.js");
var asyncHelpers = require("../common/asyncHelpers");
var async = asyncHelpers.async;
var activityMarkup = require("./activityMarkup");
function ActivityExecutionEngine(rootActivity) {
  if (!(rootActivity instanceof Activity)) {
    if (_.isPlainObject(rootActivity)) {
      rootActivity = activityMarkup.parse(rootActivity);
    } else {
      throw new TypeError("Argument 'rootActivity' is not an activity or a markup.");
    }
  }
  this._rootActivity = rootActivity;
  this._context = new ActivityExecutionContext();
  this._isInitialized = false;
  this._rootState = null;
  this._trackers = [];
  this._hookContext();
  this._timestamp = null;
}
util.inherits(ActivityExecutionEngine, EventEmitter);
Object.defineProperties(ActivityExecutionEngine.prototype, {
  rootActivity: {get: function() {
      return this._rootActivity;
    }},
  execState: {get: function() {
      if (this._rootState) {
        return this._rootState.execState;
      } else {
        return null;
      }
    }},
  version: {get: function() {
      return this._rootActivity.version;
    }},
  updatedOn: {get: function() {
      return this._timestamp;
    }}
});
ActivityExecutionEngine.prototype._idle = {toString: function() {
    return enums.ActivityStates.idle;
  }};
ActivityExecutionEngine.prototype.isIdle = function(result) {
  return result === this._idle;
};
ActivityExecutionEngine.prototype._initialize = function() {
  if (!this._isInitialized) {
    this._context.initialize(this._rootActivity);
    this._isInitialized = true;
  }
};
ActivityExecutionEngine.prototype._setRootState = function(state) {
  var self = this;
  if (!self._rootState) {
    self._rootState = state;
    self._rootState.on(Activity.states.cancel, function() {
      self.emit(Activity.states.cancel);
    });
    self._rootState.on(Activity.states.complete, function(result) {
      self.emit(Activity.states.complete, result);
    });
    self._rootState.on(Activity.states.end, function(reason, result) {
      self._timestamp = new Date();
      self.emit(Activity.states.end, reason, result);
    });
    self._rootState.on(Activity.states.fail, function(e) {
      self.emit(Activity.states.fail, e);
    });
    self._rootState.on(Activity.states.run, function() {
      self.emit(Activity.states.run);
    });
    self._rootState.on(Activity.states.idle, function() {
      self.emit(Activity.states.idle);
    });
  }
};
ActivityExecutionEngine.prototype._hookContext = function() {
  var self = this;
  self._context.on(Activity.states.run, function(activity) {
    fast.forEach(self._trackers, function(t) {
      t.activityStateChanged(activity, Activity.states.run);
    });
  });
  self._context.on(Activity.states.end, function(activity, reason, result) {
    fast.forEach(self._trackers, function(t) {
      t.activityStateChanged(activity, reason, result);
    });
  });
};
ActivityExecutionEngine.prototype.addTracker = function(tracker) {
  if (!_.isObject(tracker))
    throw new TypeError("Parameter is not an object.");
  this._trackers.push(new ActivityStateTracker(tracker));
};
ActivityExecutionEngine.prototype.removeTracker = function(tracker) {
  var idx = -1;
  fast.forEach(this._trackers, function(t, i) {
    if (t._impl === tracker) {
      idx = i;
      return false;
    }
  });
  if (idx != -1)
    this._trackers.splice(idx, 1);
};
ActivityExecutionEngine.prototype.start = async($traceurRuntime.initGeneratorFunction(function $__0() {
  var args,
      $__1,
      $__2,
      $__3,
      $__4,
      $__5,
      $__6,
      $__7,
      $__8;
  var $arguments = arguments;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          this._verifyNotStarted();
          this._initialize();
          args = [new CallContext(self._context)];
          fast.forEach($arguments, function(a) {
            args.push(a);
          });
          $ctx.state = 10;
          break;
        case 10:
          $__1 = this._setRootState;
          $__2 = this._rootActivity;
          $__3 = $__2.start;
          $__4 = $__3.apply;
          $__5 = this._rootActivity;
          $__6 = $__4.call($__3, $__5, args);
          $ctx.state = 6;
          break;
        case 6:
          $ctx.state = 2;
          return $__6;
        case 2:
          $__7 = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          $__8 = $__1.call(this, $__7);
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__0, this);
}));
ActivityExecutionEngine.prototype.invoke = function() {
  var self = this;
  self._verifyNotStarted();
  self._initialize();
  var argRemoveToken = null;
  var args = [];
  fast.forEach(arguments, function(a) {
    args.push(a);
  });
  if (args.length)
    argRemoveToken = self._context.appendToContext(args);
  args.unshift(new CallContext(self._context));
  return new Promise(function(resolve, reject) {
    try {
      self._setRootState(self._context.getState(self._rootActivity.id));
      self.once(Activity.states.end, function(reason, result) {
        try {
          switch (reason) {
            case Activity.states.complete:
              resolve(result);
              break;
            case Activity.states.cancel:
              reject(new errors.Cancelled());
              break;
            case Activity.states.idle:
              resolve(self._idle);
              break;
            default:
              result = result || new errors.ActivityRuntimeError("Unknown error.");
              reject(result);
              break;
          }
        } finally {
          if (argRemoveToken) {
            self._context.removeFromContext(argRemoveToken);
            argRemoveToken = null;
          }
        }
      });
      self._rootActivity.start.apply(self._rootActivity, args);
    } catch (e) {
      reject(e);
      if (argRemoveToken) {
        self._context.removeFromContext(argRemoveToken);
        argRemoveToken = null;
      }
    }
  });
};
ActivityExecutionEngine.prototype._verifyNotStarted = function() {
  if (this.execState != null)
    throw new errors.ActivityStateExceptionError("Workflow has been started already.");
};
ActivityExecutionEngine.prototype.resumeBookmark = function(name, reason, result) {
  var self = this;
  self._initialize();
  return new Promise(function(resolve, reject) {
    try {
      self._setRootState(self._context.getState(self._rootActivity.id));
      if (self.execState === enums.ActivityStates.idle) {
        var bmTimestamp = self._context.getBookmarkTimestamp(name);
        self.once(Activity.states.end, function(reason, result) {
          try {
            if (reason === enums.ActivityStates.complete || reason === enums.ActivityStates.idle) {
              var endBmTimestamp = self._context.getBookmarkTimestamp(name);
              if (endBmTimestamp && endBmTimestamp === bmTimestamp) {
                if (reason === enums.ActivityStates.complete) {
                  reject(new errors.ActivityRuntimeError("Workflow has been completed before bookmark '" + name + "' reached."));
                } else {
                  reject(new errors.Idle("Workflow has been gone to idle before bookmark '" + name + "' reached."));
                }
              } else {
                resolve();
              }
            } else if (reason === enums.ActivityStates.cancel) {
              reject(new errors.ActivityRuntimeError("Workflow has been cancelled before bookmark '" + name + "' reached."));
            } else if (reason === enums.ActivityStates.fail) {
              reject(result);
            }
          } catch (e) {
            reject(e);
          }
        });
        self._context.resumeBookmarkExternal(name, reason, result);
      } else {
        reject(new errors.ActivityRuntimeError("Cannot resume bookmark, while the workflow is not in the idle state."));
      }
    } catch (e) {
      reject(e);
    }
  });
};
ActivityExecutionEngine.prototype.getStateAndPromotions = function(serializer, getPromotions) {
  if (serializer && !_.isObject(serializer))
    throw new Error("Argument 'serializer' is not an object.");
  this._initialize();
  return this._context.getStateAndPromotions(serializer, getPromotions);
};
ActivityExecutionEngine.prototype.setState = function(serializer, json) {
  if (serializer && !_.isObject(serializer))
    throw new Error("Argument 'serializer' is not an object.");
  if (!_.isObject(json))
    throw new TypeError("Argument 'json' is not an object.");
  this._initialize();
  this._timestamp = new Date();
  this._context.setState(serializer, json);
};
module.exports = ActivityExecutionEngine;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsQUFBSSxFQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsWUFBVyxDQUFDLENBQUM7QUFDcEMsQUFBSSxFQUFBLENBQUEsd0JBQXVCLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyw0QkFBMkIsQ0FBQyxDQUFDO0FBQ3BFLEFBQUksRUFBQSxDQUFBLHNCQUFxQixFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsMEJBQXlCLENBQUMsQ0FBQztBQUNoRSxBQUFJLEVBQUEsQ0FBQSxXQUFVLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxlQUFjLENBQUMsQ0FBQztBQUMxQyxBQUFJLEVBQUEsQ0FBQSxZQUFXLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxRQUFPLENBQUMsYUFBYSxDQUFDO0FBQ2pELEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGtCQUFpQixDQUFDLENBQUM7QUFDeEMsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsb0JBQW1CLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyx3QkFBdUIsQ0FBQyxDQUFDO0FBQzVELEFBQUksRUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGlCQUFnQixDQUFDLENBQUM7QUFDdEMsQUFBSSxFQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDakMsQUFBSSxFQUFBLENBQUEsSUFBRyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsU0FBUSxDQUFDLENBQUM7QUFDN0Is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T0FBTyxDQUFBLElBQUcsU0FBUyxzQkFBc0IsQUFBQyxDQUFDLFVBQVMsQ0FBRyxjQUFZLENBQUMsQ0FBQztBQUN6RSxDQUFBO0FBRUEsc0JBQXNCLFVBQVUsU0FBUyxFQUFJLFVBQVUsVUFBUyxDQUFHLENBQUEsSUFBRyxDQUFHO0FBQ3JFLEtBQUksVUFBUyxHQUFLLEVBQUMsQ0FBQSxTQUFTLEFBQUMsQ0FBQyxVQUFTLENBQUM7QUFBRyxRQUFNLElBQUksTUFBSSxBQUFDLENBQUMseUNBQXdDLENBQUMsQ0FBQztBQUFBLEFBQ3JHLEtBQUksQ0FBQyxDQUFBLFNBQVMsQUFBQyxDQUFDLElBQUcsQ0FBQztBQUFHLFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxtQ0FBa0MsQ0FBQyxDQUFDO0FBQUEsQUFFL0UsS0FBRyxZQUFZLEFBQUMsRUFBQyxDQUFDO0FBQ2xCLEtBQUcsV0FBVyxFQUFJLElBQUksS0FBRyxBQUFDLEVBQUMsQ0FBQztBQUM1QixLQUFHLFNBQVMsU0FBUyxBQUFDLENBQUMsVUFBUyxDQUFHLEtBQUcsQ0FBQyxDQUFDO0FBQzVDLENBQUE7QUFHQSxLQUFLLFFBQVEsRUFBSSx3QkFBc0IsQ0FBQztBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvYWN0aXZpdHlFeGVjdXRpb25FbmdpbmUuanMiLCJzb3VyY2VSb290IjoiQzovR0lUL21vbmdvLWNydW5jaC9kZXBzL3dvcmtmbG93LTQtbm9kZS9saWIvIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEFjdGl2aXR5ID0gcmVxdWlyZShcIi4vYWN0aXZpdHlcIik7XHJcbnZhciBBY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQgPSByZXF1aXJlKFwiLi9hY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHRcIik7XHJcbnZhciBBY3Rpdml0eUV4ZWN1dGlvblN0YXRlID0gcmVxdWlyZShcIi4vYWN0aXZpdHlFeGVjdXRpb25TdGF0ZVwiKTtcclxudmFyIENhbGxDb250ZXh0ID0gcmVxdWlyZShcIi4vY2FsbENvbnRleHRcIik7XHJcbnZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7XHJcbnZhciB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XHJcbnZhciBlcnJvcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2Vycm9yc1wiKTtcclxudmFyIF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG52YXIgQWN0aXZpdHlTdGF0ZVRyYWNrZXIgPSByZXF1aXJlKFwiLi9hY3Rpdml0eVN0YXRlVHJhY2tlclwiKTtcclxudmFyIGVudW1zID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lbnVtc1wiKTtcclxudmFyIFByb21pc2UgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XHJcbnZhciBmYXN0ID0gcmVxdWlyZShcImZhc3QuanNcIik7XHJcbnZhciBhc3luY0hlbHBlcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2FzeW5jSGVscGVyc1wiKTtcclxudmFyIGFzeW5jID0gYXN5bmNIZWxwZXJzLmFzeW5jO1xyXG52YXIgYWN0aXZpdHlNYXJrdXAgPSByZXF1aXJlKFwiLi9hY3Rpdml0eU1hcmt1cFwiKTtcclxuXHJcbmZ1bmN0aW9uIEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lKHJvb3RBY3Rpdml0eSkge1xyXG4gICAgaWYgKCEocm9vdEFjdGl2aXR5IGluc3RhbmNlb2YgQWN0aXZpdHkpKSB7XHJcbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChyb290QWN0aXZpdHkpKSB7XHJcbiAgICAgICAgICAgIHJvb3RBY3Rpdml0eSA9IGFjdGl2aXR5TWFya3VwLnBhcnNlKHJvb3RBY3Rpdml0eSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQXJndW1lbnQgJ3Jvb3RBY3Rpdml0eScgaXMgbm90IGFuIGFjdGl2aXR5IG9yIGEgbWFya3VwLlwiKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB0aGlzLl9yb290QWN0aXZpdHkgPSByb290QWN0aXZpdHk7XHJcbiAgICB0aGlzLl9jb250ZXh0ID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dCgpO1xyXG4gICAgdGhpcy5faXNJbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gICAgdGhpcy5fcm9vdFN0YXRlID0gbnVsbDtcclxuICAgIHRoaXMuX3RyYWNrZXJzID0gW107XHJcbiAgICB0aGlzLl9ob29rQ29udGV4dCgpO1xyXG4gICAgdGhpcy5fdGltZXN0YW1wID0gbnVsbDtcclxufVxyXG5cclxudXRpbC5pbmhlcml0cyhBY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZSwgRXZlbnRFbWl0dGVyKTtcclxuXHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZSwge1xyXG4gICAgcm9vdEFjdGl2aXR5OiB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yb290QWN0aXZpdHk7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIGV4ZWNTdGF0ZToge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fcm9vdFN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcm9vdFN0YXRlLmV4ZWNTdGF0ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIHZlcnNpb246IHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Jvb3RBY3Rpdml0eS52ZXJzaW9uO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICB1cGRhdGVkT246IHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RpbWVzdGFtcDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pXHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuX2lkbGUgPSB7XHJcbiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBlbnVtcy5BY3Rpdml0eVN0YXRlcy5pZGxlO1xyXG4gICAgfVxyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuaXNJZGxlID0gZnVuY3Rpb24gKHJlc3VsdCkge1xyXG4gICAgcmV0dXJuIHJlc3VsdCA9PT0gdGhpcy5faWRsZTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLl9pbml0aWFsaXplID0gZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKCF0aGlzLl9pc0luaXRpYWxpemVkKSB7XHJcbiAgICAgICAgdGhpcy5fY29udGV4dC5pbml0aWFsaXplKHRoaXMuX3Jvb3RBY3Rpdml0eSk7XHJcbiAgICAgICAgdGhpcy5faXNJbml0aWFsaXplZCA9IHRydWU7XHJcbiAgICB9XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5fc2V0Um9vdFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICBpZiAoIXNlbGYuX3Jvb3RTdGF0ZSkge1xyXG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZSA9IHN0YXRlO1xyXG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZS5vbihcclxuICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmNhbmNlbCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KEFjdGl2aXR5LnN0YXRlcy5jYW5jZWwpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXHJcbiAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZSwgZnVuY3Rpb24gKHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZSwgcmVzdWx0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgc2VsZi5fcm9vdFN0YXRlLm9uKFxyXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuZW5kLCBmdW5jdGlvbiAocmVhc29uLCByZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX3RpbWVzdGFtcCA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLmVuZCwgcmVhc29uLCByZXN1bHQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICBzZWxmLl9yb290U3RhdGUub24oXHJcbiAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5mYWlsLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5lbWl0KEFjdGl2aXR5LnN0YXRlcy5mYWlsLCBlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgc2VsZi5fcm9vdFN0YXRlLm9uKFxyXG4gICAgICAgICAgICBBY3Rpdml0eS5zdGF0ZXMucnVuLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoQWN0aXZpdHkuc3RhdGVzLnJ1bik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIHNlbGYuX3Jvb3RTdGF0ZS5vbihcclxuICAgICAgICAgICAgQWN0aXZpdHkuc3RhdGVzLmlkbGUsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChBY3Rpdml0eS5zdGF0ZXMuaWRsZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuX2hvb2tDb250ZXh0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgc2VsZi5fY29udGV4dC5vbihcclxuICAgICAgICBBY3Rpdml0eS5zdGF0ZXMucnVuLCBmdW5jdGlvbiAoYWN0aXZpdHkpIHtcclxuICAgICAgICAgICAgZmFzdC5mb3JFYWNoKHNlbGYuX3RyYWNrZXJzLFxyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKHQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0LmFjdGl2aXR5U3RhdGVDaGFuZ2VkKGFjdGl2aXR5LCBBY3Rpdml0eS5zdGF0ZXMucnVuKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgc2VsZi5fY29udGV4dC5vbihcclxuICAgICAgICBBY3Rpdml0eS5zdGF0ZXMuZW5kLCBmdW5jdGlvbiAoYWN0aXZpdHksIHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICAgICAgICAgIGZhc3QuZm9yRWFjaChzZWxmLl90cmFja2VycyxcclxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uICh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdC5hY3Rpdml0eVN0YXRlQ2hhbmdlZChhY3Rpdml0eSwgcmVhc29uLCByZXN1bHQpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5hZGRUcmFja2VyID0gZnVuY3Rpb24gKHRyYWNrZXIpIHtcclxuICAgIGlmICghXy5pc09iamVjdCh0cmFja2VyKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlBhcmFtZXRlciBpcyBub3QgYW4gb2JqZWN0LlwiKTtcclxuICAgIHRoaXMuX3RyYWNrZXJzLnB1c2gobmV3IEFjdGl2aXR5U3RhdGVUcmFja2VyKHRyYWNrZXIpKTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLnJlbW92ZVRyYWNrZXIgPSBmdW5jdGlvbiAodHJhY2tlcikge1xyXG4gICAgdmFyIGlkeCA9IC0xO1xyXG4gICAgZmFzdC5mb3JFYWNoKHRoaXMuX3RyYWNrZXJzLFxyXG4gICAgICAgIGZ1bmN0aW9uICh0LCBpKSB7XHJcbiAgICAgICAgICAgIGlmICh0Ll9pbXBsID09PSB0cmFja2VyKSB7XHJcbiAgICAgICAgICAgICAgICBpZHggPSBpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICBpZiAoaWR4ICE9IC0xKSB0aGlzLl90cmFja2Vycy5zcGxpY2UoaWR4LCAxKTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLnN0YXJ0ID0gYXN5bmMoZnVuY3Rpb24qICgpIHtcclxuICAgIHRoaXMuX3ZlcmlmeU5vdFN0YXJ0ZWQoKTtcclxuXHJcbiAgICB0aGlzLl9pbml0aWFsaXplKCk7XHJcblxyXG4gICAgdmFyIGFyZ3MgPSBbbmV3IENhbGxDb250ZXh0KHNlbGYuX2NvbnRleHQpXTtcclxuICAgIGZhc3QuZm9yRWFjaChcclxuICAgICAgICBhcmd1bWVudHMsIGZ1bmN0aW9uIChhKSB7XHJcbiAgICAgICAgICAgIGFyZ3MucHVzaChhKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICB0aGlzLl9zZXRSb290U3RhdGUoeWllbGQgdGhpcy5fcm9vdEFjdGl2aXR5LnN0YXJ0LmFwcGx5KHRoaXMuX3Jvb3RBY3Rpdml0eSwgYXJncykpO1xyXG59KTtcclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uRW5naW5lLnByb3RvdHlwZS5pbnZva2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgc2VsZi5fdmVyaWZ5Tm90U3RhcnRlZCgpO1xyXG5cclxuICAgIHNlbGYuX2luaXRpYWxpemUoKTtcclxuXHJcbiAgICB2YXIgYXJnUmVtb3ZlVG9rZW4gPSBudWxsO1xyXG4gICAgdmFyIGFyZ3MgPSBbXTtcclxuICAgIGZhc3QuZm9yRWFjaChcclxuICAgICAgICBhcmd1bWVudHMsIGZ1bmN0aW9uIChhKSB7XHJcbiAgICAgICAgICAgIGFyZ3MucHVzaChhKTtcclxuICAgICAgICB9KTtcclxuICAgIGlmIChhcmdzLmxlbmd0aCkgYXJnUmVtb3ZlVG9rZW4gPSBzZWxmLl9jb250ZXh0LmFwcGVuZFRvQ29udGV4dChhcmdzKTtcclxuICAgIGFyZ3MudW5zaGlmdChuZXcgQ2FsbENvbnRleHQoc2VsZi5fY29udGV4dCkpO1xyXG5cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgc2VsZi5fc2V0Um9vdFN0YXRlKHNlbGYuX2NvbnRleHQuZ2V0U3RhdGUoc2VsZi5fcm9vdEFjdGl2aXR5LmlkKSk7XHJcbiAgICAgICAgICAgIHNlbGYub25jZShcclxuICAgICAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5lbmQsIGZ1bmN0aW9uIChyZWFzb24sIHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocmVhc29uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEFjdGl2aXR5LnN0YXRlcy5jYW5jZWw6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuQ2FuY2VsbGVkKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBBY3Rpdml0eS5zdGF0ZXMuaWRsZTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHNlbGYuX2lkbGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdCA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gcmVzdWx0IHx8IG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJVbmtub3duIGVycm9yLlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QocmVzdWx0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBmaW5hbGx5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ1JlbW92ZVRva2VuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9jb250ZXh0LnJlbW92ZUZyb21Db250ZXh0KGFyZ1JlbW92ZVRva2VuKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ1JlbW92ZVRva2VuID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgc2VsZi5fcm9vdEFjdGl2aXR5LnN0YXJ0LmFwcGx5KHNlbGYuX3Jvb3RBY3Rpdml0eSwgYXJncyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJlamVjdChlKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChhcmdSZW1vdmVUb2tlbikge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fY29udGV4dC5yZW1vdmVGcm9tQ29udGV4dChhcmdSZW1vdmVUb2tlbik7XHJcbiAgICAgICAgICAgICAgICBhcmdSZW1vdmVUb2tlbiA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLl92ZXJpZnlOb3RTdGFydGVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKHRoaXMuZXhlY1N0YXRlICE9IG51bGwpIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlTdGF0ZUV4Y2VwdGlvbkVycm9yKFwiV29ya2Zsb3cgaGFzIGJlZW4gc3RhcnRlZCBhbHJlYWR5LlwiKTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25FbmdpbmUucHJvdG90eXBlLnJlc3VtZUJvb2ttYXJrID0gZnVuY3Rpb24gKG5hbWUsIHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICBzZWxmLl9pbml0aWFsaXplKCk7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHNlbGYuX3NldFJvb3RTdGF0ZShzZWxmLl9jb250ZXh0LmdldFN0YXRlKHNlbGYuX3Jvb3RBY3Rpdml0eS5pZCkpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHNlbGYuZXhlY1N0YXRlID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5pZGxlKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYm1UaW1lc3RhbXAgPSBzZWxmLl9jb250ZXh0LmdldEJvb2ttYXJrVGltZXN0YW1wKG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5vbmNlKFxyXG4gICAgICAgICAgICAgICAgICAgIEFjdGl2aXR5LnN0YXRlcy5lbmQsIGZ1bmN0aW9uIChyZWFzb24sIHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlYXNvbiA9PT0gZW51bXMuQWN0aXZpdHlTdGF0ZXMuY29tcGxldGUgfHwgcmVhc29uID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5pZGxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVuZEJtVGltZXN0YW1wID0gc2VsZi5fY29udGV4dC5nZXRCb29rbWFya1RpbWVzdGFtcChuYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kQm1UaW1lc3RhbXAgJiYgZW5kQm1UaW1lc3RhbXAgPT09IGJtVGltZXN0YW1wKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWFzb24gPT09IGVudW1zLkFjdGl2aXR5U3RhdGVzLmNvbXBsZXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IGVycm9ycy5BY3Rpdml0eVJ1bnRpbWVFcnJvcihcIldvcmtmbG93IGhhcyBiZWVuIGNvbXBsZXRlZCBiZWZvcmUgYm9va21hcmsgJ1wiICsgbmFtZSArIFwiJyByZWFjaGVkLlwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IGVycm9ycy5JZGxlKFwiV29ya2Zsb3cgaGFzIGJlZW4gZ29uZSB0byBpZGxlIGJlZm9yZSBib29rbWFyayAnXCIgKyBuYW1lICsgXCInIHJlYWNoZWQuXCIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJlYXNvbiA9PT0gZW51bXMuQWN0aXZpdHlTdGF0ZXMuY2FuY2VsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJXb3JrZmxvdyBoYXMgYmVlbiBjYW5jZWxsZWQgYmVmb3JlIGJvb2ttYXJrICdcIiArIG5hbWUgKyBcIicgcmVhY2hlZC5cIikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmVhc29uID09PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5mYWlsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fY29udGV4dC5yZXN1bWVCb29rbWFya0V4dGVybmFsKG5hbWUsIHJlYXNvbiwgcmVzdWx0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlamVjdChuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiQ2Fubm90IHJlc3VtZSBib29rbWFyaywgd2hpbGUgdGhlIHdvcmtmbG93IGlzIG5vdCBpbiB0aGUgaWRsZSBzdGF0ZS5cIikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJlamVjdChlKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuLyogU0VSSUFMSVpBVElPTiAqL1xyXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuZ2V0U3RhdGVBbmRQcm9tb3Rpb25zID0gZnVuY3Rpb24gKHNlcmlhbGl6ZXIsIGdldFByb21vdGlvbnMpIHtcclxuICAgIGlmIChzZXJpYWxpemVyICYmICFfLmlzT2JqZWN0KHNlcmlhbGl6ZXIpKSB0aHJvdyBuZXcgRXJyb3IoXCJBcmd1bWVudCAnc2VyaWFsaXplcicgaXMgbm90IGFuIG9iamVjdC5cIik7XHJcblxyXG4gICAgdGhpcy5faW5pdGlhbGl6ZSgpO1xyXG4gICAgcmV0dXJuIHRoaXMuX2NvbnRleHQuZ2V0U3RhdGVBbmRQcm9tb3Rpb25zKHNlcmlhbGl6ZXIsIGdldFByb21vdGlvbnMpO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkVuZ2luZS5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbiAoc2VyaWFsaXplciwganNvbikge1xyXG4gICAgaWYgKHNlcmlhbGl6ZXIgJiYgIV8uaXNPYmplY3Qoc2VyaWFsaXplcikpIHRocm93IG5ldyBFcnJvcihcIkFyZ3VtZW50ICdzZXJpYWxpemVyJyBpcyBub3QgYW4gb2JqZWN0LlwiKTtcclxuICAgIGlmICghXy5pc09iamVjdChqc29uKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFyZ3VtZW50ICdqc29uJyBpcyBub3QgYW4gb2JqZWN0LlwiKTtcclxuXHJcbiAgICB0aGlzLl9pbml0aWFsaXplKCk7XHJcbiAgICB0aGlzLl90aW1lc3RhbXAgPSBuZXcgRGF0ZSgpO1xyXG4gICAgdGhpcy5fY29udGV4dC5zZXRTdGF0ZShzZXJpYWxpemVyLCBqc29uKTtcclxufVxyXG4vKiBTRVJJQUxJWkFUSU9OICovXHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IEFjdGl2aXR5RXhlY3V0aW9uRW5naW5lOyJdfQ==
