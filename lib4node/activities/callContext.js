"use strict";
var is = require("../common/is");
function CallContext(executionContext, activityOrActivityId, scope) {
  this._executionContext = executionContext;
  this._activity = activityOrActivityId ? this._asActivity(activityOrActivityId) : null;
  this._scope = scope ? scope : null;
  this._executionState = null;
}
Object.defineProperties(CallContext.prototype, {
  activityId: {get: function() {
      return this._activity ? this._activity.id : null;
    }},
  _parentActivityId: {get: function() {
      if (!this._activity)
        return null;
      var state = this._executionContext.getState(this.activityId);
      return state.parentActivityId;
    }},
  _scopeTree: {get: function() {
      return this._executionContext._scopeTree;
    }},
  activity: {get: function() {
      return this._activity;
    }},
  executionContext: {get: function() {
      return this._executionContext;
    }},
  executionState: {get: function() {
      return this._executionState || (this._activity ? (this._executionState = this._executionContext.getState(this._activity.id)) : null);
    }},
  scope: {get: function() {
      return this._scope || (this._scope = this._scopeTree.find(this.activityId));
    }}
});
CallContext.prototype.next = function(childActivityOrActivityId) {
  var child = this._asActivity(childActivityOrActivityId);
  return new CallContext(this._executionContext, child, this._scopeTree.next(this.activityId, child.id, child.createScopePart()));
};
CallContext.prototype.back = function(keepScope) {
  var parentId = this._parentActivityId;
  if (parentId) {
    return new CallContext(this._executionContext, parentId, this._scopeTree.back(this.activityId, keepScope));
  } else {
    return null;
  }
};
CallContext.prototype._asActivity = function(activityOrActivityId) {
  return is.activity(activityOrActivityId) ? activityOrActivityId : this._executionContext._getKnownActivity(activityOrActivityId);
};
CallContext.prototype.complete = function(result) {
  this.activity.complete(this, result);
};
CallContext.prototype.cancel = function() {
  this.activity.cancel(this);
};
CallContext.prototype.idle = function() {
  this.activity.idle(this);
};
CallContext.prototype.fail = function(e) {
  this.activity.fail(this, e);
};
CallContext.prototype.end = function(reason, result) {
  this.activity.end(this, reason, result);
};
CallContext.prototype.schedule = function(obj, endcallback) {
  this.activity.schedule(this, obj, endcallback);
};
CallContext.prototype.createBookmark = function(name, callback) {
  return this._executionContext.createBookmark(this.activityId, name, callback);
};
CallContext.prototype.resumeBookmark = function(name, reason, result) {
  this._executionContext.resumeBookmarkInternal(this, name, reason, result);
};
module.exports = CallContext;
//# sourceMappingURL=data:application/json;base64,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QVMsSUFBSSxBQUFDLENBQUMsSUFBRyxDQUFHLE9BQUssQ0FBRyxPQUFLLENBQUMsQ0FBQztBQUMzQyxDQUFBO0FBRUEsVUFBVSxVQUFVLFNBQVMsRUFBSSxVQUFVLEdBQUUsQ0FBRyxDQUFBLFdBQVUsQ0FBRztBQUN6RCxLQUFHLFNBQVMsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFHLElBQUUsQ0FBRyxZQUFVLENBQUMsQ0FBQztBQUNsRCxDQUFBO0FBRUEsVUFBVSxVQUFVLGVBQWUsRUFBSSxVQUFVLElBQUcsQ0FBRyxDQUFBLFFBQU8sQ0FBRztBQUM3RCxPQUFPLENBQUEsSUFBRyxrQkFBa0IsZUFBZSxBQUFDLENBQUMsSUFBRyxXQUFXLENBQUcsS0FBRyxDQUFHLFNBQU8sQ0FBQyxDQUFDO0FBQ2pGLENBQUE7QUFFQSxVQUFVLFVBQVUsZUFBZSxFQUFJLFVBQVUsSUFBRyxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQ25FLEtBQUcsa0JBQWtCLHVCQUF1QixBQUFDLENBQUMsSUFBRyxDQUFHLEtBQUcsQ0FBRyxPQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7QUFDN0UsQ0FBQTtBQUVBLEtBQUssUUFBUSxFQUFJLFlBQVUsQ0FBQztBQUM1QiIsImZpbGUiOiJhY3Rpdml0aWVzL2NhbGxDb250ZXh0LmpzIiwic291cmNlUm9vdCI6IkM6L0dJVC93b3JrZmxvdy00LW5vZGUvbGliLyIsInNvdXJjZXNDb250ZW50IjpbInZhciBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XHJcblxyXG5mdW5jdGlvbiBDYWxsQ29udGV4dChleGVjdXRpb25Db250ZXh0LCBhY3Rpdml0eU9yQWN0aXZpdHlJZCwgc2NvcGUpIHtcclxuICAgIHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0O1xyXG4gICAgdGhpcy5fYWN0aXZpdHkgPSBhY3Rpdml0eU9yQWN0aXZpdHlJZCA/IHRoaXMuX2FzQWN0aXZpdHkoYWN0aXZpdHlPckFjdGl2aXR5SWQpIDogbnVsbDtcclxuICAgIHRoaXMuX3Njb3BlID0gc2NvcGUgPyBzY29wZSA6IG51bGw7XHJcbiAgICB0aGlzLl9leGVjdXRpb25TdGF0ZSA9IG51bGw7XHJcbn1cclxuXHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFxyXG4gICAgQ2FsbENvbnRleHQucHJvdG90eXBlLFxyXG4gICAge1xyXG4gICAgICAgIGFjdGl2aXR5SWQ6IHtcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fYWN0aXZpdHkgPyB0aGlzLl9hY3Rpdml0eS5pZCA6IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIF9wYXJlbnRBY3Rpdml0eUlkOiB7XHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hY3Rpdml0eSkgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3RhdGUgPSB0aGlzLl9leGVjdXRpb25Db250ZXh0LmdldFN0YXRlKHRoaXMuYWN0aXZpdHlJZCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGUucGFyZW50QWN0aXZpdHlJZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX3Njb3BlVHJlZToge1xyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRpb25Db250ZXh0Ll9zY29wZVRyZWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGFjdGl2aXR5OiB7XHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FjdGl2aXR5O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjdXRpb25Db250ZXh0OiB7XHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWN1dGlvblN0YXRlOiB7XHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGlvblN0YXRlIHx8ICh0aGlzLl9hY3Rpdml0eSA/ICh0aGlzLl9leGVjdXRpb25TdGF0ZSA9IHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQuZ2V0U3RhdGUodGhpcy5fYWN0aXZpdHkuaWQpKSA6IG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzY29wZToge1xyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9zY29wZSB8fCAodGhpcy5fc2NvcGUgPSB0aGlzLl9zY29wZVRyZWUuZmluZCh0aGlzLmFjdGl2aXR5SWQpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuKTtcclxuXHJcbkNhbGxDb250ZXh0LnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gKGNoaWxkQWN0aXZpdHlPckFjdGl2aXR5SWQpIHtcclxuICAgIHZhciBjaGlsZCA9IHRoaXMuX2FzQWN0aXZpdHkoY2hpbGRBY3Rpdml0eU9yQWN0aXZpdHlJZCk7XHJcbiAgICByZXR1cm4gbmV3IENhbGxDb250ZXh0KFxyXG4gICAgICAgIHRoaXMuX2V4ZWN1dGlvbkNvbnRleHQsXHJcbiAgICAgICAgY2hpbGQsXHJcbiAgICAgICAgdGhpcy5fc2NvcGVUcmVlLm5leHQodGhpcy5hY3Rpdml0eUlkLCBjaGlsZC5pZCwgY2hpbGQuY3JlYXRlU2NvcGVQYXJ0KCkpKTtcclxufVxyXG5cclxuQ2FsbENvbnRleHQucHJvdG90eXBlLmJhY2sgPSBmdW5jdGlvbiAoa2VlcFNjb3BlKSB7XHJcbiAgICB2YXIgcGFyZW50SWQgPSB0aGlzLl9wYXJlbnRBY3Rpdml0eUlkO1xyXG4gICAgaWYgKHBhcmVudElkKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBDYWxsQ29udGV4dChcclxuICAgICAgICAgICAgdGhpcy5fZXhlY3V0aW9uQ29udGV4dCxcclxuICAgICAgICAgICAgcGFyZW50SWQsXHJcbiAgICAgICAgICAgIHRoaXMuX3Njb3BlVHJlZS5iYWNrKHRoaXMuYWN0aXZpdHlJZCwga2VlcFNjb3BlKSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxufVxyXG5cclxuQ2FsbENvbnRleHQucHJvdG90eXBlLl9hc0FjdGl2aXR5ID0gZnVuY3Rpb24gKGFjdGl2aXR5T3JBY3Rpdml0eUlkKSB7XHJcbiAgICByZXR1cm4gaXMuYWN0aXZpdHkoYWN0aXZpdHlPckFjdGl2aXR5SWQpID8gYWN0aXZpdHlPckFjdGl2aXR5SWQgOiB0aGlzLl9leGVjdXRpb25Db250ZXh0Ll9nZXRLbm93bkFjdGl2aXR5KGFjdGl2aXR5T3JBY3Rpdml0eUlkKTtcclxufVxyXG5cclxuLyogQ2FsbGJhY2tzICovXHJcblxyXG5DYWxsQ29udGV4dC5wcm90b3R5cGUuY29tcGxldGUgPSBmdW5jdGlvbiAocmVzdWx0KSB7XHJcbiAgICB0aGlzLmFjdGl2aXR5LmNvbXBsZXRlKHRoaXMsIHJlc3VsdCk7XHJcbn1cclxuXHJcbkNhbGxDb250ZXh0LnByb3RvdHlwZS5jYW5jZWwgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB0aGlzLmFjdGl2aXR5LmNhbmNlbCh0aGlzKTtcclxufVxyXG5cclxuQ2FsbENvbnRleHQucHJvdG90eXBlLmlkbGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB0aGlzLmFjdGl2aXR5LmlkbGUodGhpcyk7XHJcbn1cclxuXHJcbkNhbGxDb250ZXh0LnByb3RvdHlwZS5mYWlsID0gZnVuY3Rpb24gKGUpIHtcclxuICAgIHRoaXMuYWN0aXZpdHkuZmFpbCh0aGlzLCBlKTtcclxufVxyXG5cclxuQ2FsbENvbnRleHQucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uIChyZWFzb24sIHJlc3VsdCkge1xyXG4gICAgdGhpcy5hY3Rpdml0eS5lbmQodGhpcywgcmVhc29uLCByZXN1bHQpO1xyXG59XHJcblxyXG5DYWxsQ29udGV4dC5wcm90b3R5cGUuc2NoZWR1bGUgPSBmdW5jdGlvbiAob2JqLCBlbmRjYWxsYmFjaykge1xyXG4gICAgdGhpcy5hY3Rpdml0eS5zY2hlZHVsZSh0aGlzLCBvYmosIGVuZGNhbGxiYWNrKTtcclxufVxyXG5cclxuQ2FsbENvbnRleHQucHJvdG90eXBlLmNyZWF0ZUJvb2ttYXJrID0gZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0aW9uQ29udGV4dC5jcmVhdGVCb29rbWFyayh0aGlzLmFjdGl2aXR5SWQsIG5hbWUsIGNhbGxiYWNrKTtcclxufVxyXG5cclxuQ2FsbENvbnRleHQucHJvdG90eXBlLnJlc3VtZUJvb2ttYXJrID0gZnVuY3Rpb24gKG5hbWUsIHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICB0aGlzLl9leGVjdXRpb25Db250ZXh0LnJlc3VtZUJvb2ttYXJrSW50ZXJuYWwodGhpcywgbmFtZSwgcmVhc29uLCByZXN1bHQpO1xyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IENhbGxDb250ZXh0O1xyXG4iXX0=
