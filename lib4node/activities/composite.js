"use strict";
var Activity = require("./activity");
var util = require("util");
var guids = require("../common/guids");
var Declarator = require("./declarator");
var is = require("../common/is");
var _ = require("lodash");
var activityMarkup = require("./activityMarkup");
function Composite() {
  Declarator.call(this);
  this[guids.types.composite] = true;
  this.reservedProperties.add("_implementation");
  this.nonSerializedProperties.add("_implementation");
  this.nonScopedProperties.add("createImplementation");
  this.nonScopedProperties.add("ensureImplementationCreated");
  this.nonScopedProperties.add(guids.types.composite);
}
util.inherits(Composite, Declarator);
Composite.prototype.forEachImmediateChild = function(f) {
  this.ensureImplementationCreated();
  Declarator.prototype.forEachImmediateChild.call(this, f);
};
Composite.prototype._forEach = function(f, visited, except) {
  this.ensureImplementationCreated();
  Declarator.prototype._forEach.call(this, f, visited, except);
};
Composite.prototype.createImplementation = function() {
  throw new Error("Method 'createImplementation' not implemented.");
};
Composite.prototype.ensureImplementationCreated = function() {
  if (is.undefined(this._implementation)) {
    this._implementation = this.createImplementation();
    if (_.isPlainObject(this._implementation))
      this._implementation = activityMarkup.parse(this._implementation);
    if (!(this._implementation instanceof Activity))
      throw new Error("Method 'createImplementation' must return an activity.");
  }
};
Composite.prototype.run = function(callContext, args) {
  if (!(this.get("_implementation") instanceof Activity))
    throw new Error("Composite activity's implementation is not available.");
  Declarator.prototype.run.call(this, callContext, args);
};
Composite.prototype.varsDeclared = function(callContext, args) {
  callContext.schedule(this.get("_implementation"), "_implInvoked");
};
Composite.prototype._implInvoked = function(callContext, reason, result) {
  callContext.end(reason, result);
};
module.exports = Composite;
//# sourceMappingURL=data:application/json;base64,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QUFBLEFBQ0osQ0FBQTtBQUVBLFFBQVEsVUFBVSxJQUFJLEVBQUksVUFBVSxXQUFVLENBQUcsQ0FBQSxJQUFHLENBQUc7QUFDbkQsS0FBSSxDQUFDLENBQUMsSUFBRyxJQUFJLEFBQUMsQ0FBQyxpQkFBZ0IsQ0FBQyxDQUFBLFVBQWEsU0FBTyxDQUFDO0FBQUcsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLHVEQUFzRCxDQUFDLENBQUM7QUFBQSxBQUNoSSxXQUFTLFVBQVUsSUFBSSxLQUFLLEFBQUMsQ0FBQyxJQUFHLENBQUcsWUFBVSxDQUFHLEtBQUcsQ0FBQyxDQUFDO0FBQzFELENBQUE7QUFFQSxRQUFRLFVBQVUsYUFBYSxFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsSUFBRyxDQUFHO0FBQzVELFlBQVUsU0FBUyxBQUFDLENBQUMsSUFBRyxJQUFJLEFBQUMsQ0FBQyxpQkFBZ0IsQ0FBQyxDQUFHLGVBQWEsQ0FBQyxDQUFDO0FBQ3JFLENBQUE7QUFFQSxRQUFRLFVBQVUsYUFBYSxFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQ3RFLFlBQVUsSUFBSSxBQUFDLENBQUMsTUFBSyxDQUFHLE9BQUssQ0FBQyxDQUFDO0FBQ25DLENBQUE7QUFFQSxLQUFLLFFBQVEsRUFBSSxVQUFRLENBQUM7QUFBQSIsImZpbGUiOiJhY3Rpdml0aWVzL2NvbXBvc2l0ZS5qcyIsInNvdXJjZVJvb3QiOiJDOi9HSVQvd29ya2Zsb3ctNC1ub2RlL2xpYi8iLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgQWN0aXZpdHkgPSByZXF1aXJlKFwiLi9hY3Rpdml0eVwiKTtcclxudmFyIHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcclxudmFyIGd1aWRzID0gcmVxdWlyZShcIi4uL2NvbW1vbi9ndWlkc1wiKTtcclxudmFyIERlY2xhcmF0b3IgPSByZXF1aXJlKFwiLi9kZWNsYXJhdG9yXCIpO1xyXG52YXIgaXMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2lzXCIpO1xyXG52YXIgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XHJcbnZhciBhY3Rpdml0eU1hcmt1cCA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5TWFya3VwXCIpO1xyXG5cclxuZnVuY3Rpb24gQ29tcG9zaXRlKCkge1xyXG4gICAgRGVjbGFyYXRvci5jYWxsKHRoaXMpO1xyXG4gICAgdGhpc1tndWlkcy50eXBlcy5jb21wb3NpdGVdID0gdHJ1ZTtcclxuICAgIHRoaXMucmVzZXJ2ZWRQcm9wZXJ0aWVzLmFkZChcIl9pbXBsZW1lbnRhdGlvblwiKTtcclxuICAgIHRoaXMubm9uU2VyaWFsaXplZFByb3BlcnRpZXMuYWRkKFwiX2ltcGxlbWVudGF0aW9uXCIpO1xyXG4gICAgdGhpcy5ub25TY29wZWRQcm9wZXJ0aWVzLmFkZChcImNyZWF0ZUltcGxlbWVudGF0aW9uXCIpO1xyXG4gICAgdGhpcy5ub25TY29wZWRQcm9wZXJ0aWVzLmFkZChcImVuc3VyZUltcGxlbWVudGF0aW9uQ3JlYXRlZFwiKTtcclxuICAgIHRoaXMubm9uU2NvcGVkUHJvcGVydGllcy5hZGQoZ3VpZHMudHlwZXMuY29tcG9zaXRlKTtcclxufVxyXG5cclxudXRpbC5pbmhlcml0cyhDb21wb3NpdGUsIERlY2xhcmF0b3IpO1xyXG5cclxuQ29tcG9zaXRlLnByb3RvdHlwZS5mb3JFYWNoSW1tZWRpYXRlQ2hpbGQgPSBmdW5jdGlvbiAoZikge1xyXG4gICAgdGhpcy5lbnN1cmVJbXBsZW1lbnRhdGlvbkNyZWF0ZWQoKTtcclxuICAgIERlY2xhcmF0b3IucHJvdG90eXBlLmZvckVhY2hJbW1lZGlhdGVDaGlsZC5jYWxsKHRoaXMsIGYpO1xyXG59XHJcblxyXG5Db21wb3NpdGUucHJvdG90eXBlLl9mb3JFYWNoID0gZnVuY3Rpb24gKGYsIHZpc2l0ZWQsIGV4Y2VwdCkge1xyXG4gICAgdGhpcy5lbnN1cmVJbXBsZW1lbnRhdGlvbkNyZWF0ZWQoKTtcclxuICAgIERlY2xhcmF0b3IucHJvdG90eXBlLl9mb3JFYWNoLmNhbGwodGhpcywgZiwgdmlzaXRlZCwgZXhjZXB0KTtcclxufVxyXG5cclxuQ29tcG9zaXRlLnByb3RvdHlwZS5jcmVhdGVJbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCAnY3JlYXRlSW1wbGVtZW50YXRpb24nIG5vdCBpbXBsZW1lbnRlZC5cIik7XHJcbn1cclxuXHJcbkNvbXBvc2l0ZS5wcm90b3R5cGUuZW5zdXJlSW1wbGVtZW50YXRpb25DcmVhdGVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKGlzLnVuZGVmaW5lZCh0aGlzLl9pbXBsZW1lbnRhdGlvbikpIHtcclxuICAgICAgICB0aGlzLl9pbXBsZW1lbnRhdGlvbiA9IHRoaXMuY3JlYXRlSW1wbGVtZW50YXRpb24oKTtcclxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHRoaXMuX2ltcGxlbWVudGF0aW9uKSkgdGhpcy5faW1wbGVtZW50YXRpb24gPSBhY3Rpdml0eU1hcmt1cC5wYXJzZSh0aGlzLl9pbXBsZW1lbnRhdGlvbik7XHJcbiAgICAgICAgaWYgKCEodGhpcy5faW1wbGVtZW50YXRpb24gaW5zdGFuY2VvZiBBY3Rpdml0eSkpIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCAnY3JlYXRlSW1wbGVtZW50YXRpb24nIG11c3QgcmV0dXJuIGFuIGFjdGl2aXR5LlwiKTtcclxuICAgIH1cclxufVxyXG5cclxuQ29tcG9zaXRlLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIGFyZ3MpIHtcclxuICAgIGlmICghKHRoaXMuZ2V0KFwiX2ltcGxlbWVudGF0aW9uXCIpIGluc3RhbmNlb2YgQWN0aXZpdHkpKSB0aHJvdyBuZXcgRXJyb3IoXCJDb21wb3NpdGUgYWN0aXZpdHkncyBpbXBsZW1lbnRhdGlvbiBpcyBub3QgYXZhaWxhYmxlLlwiKTtcclxuICAgIERlY2xhcmF0b3IucHJvdG90eXBlLnJ1bi5jYWxsKHRoaXMsIGNhbGxDb250ZXh0LCBhcmdzKTtcclxufVxyXG5cclxuQ29tcG9zaXRlLnByb3RvdHlwZS52YXJzRGVjbGFyZWQgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIGFyZ3MpIHtcclxuICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKHRoaXMuZ2V0KFwiX2ltcGxlbWVudGF0aW9uXCIpLCBcIl9pbXBsSW52b2tlZFwiKTtcclxufVxyXG5cclxuQ29tcG9zaXRlLnByb3RvdHlwZS5faW1wbEludm9rZWQgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IENvbXBvc2l0ZTsiXX0=
