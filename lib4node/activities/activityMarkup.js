"use strict";
"use strict";
var _ = require("lodash");
var errors = require("../common/errors");
var Activity = require("./activity");
var is = require("../common/is");
var StrMap = require("backpack-node").collections.StrMap;
var path = require("path");
var fs = require("fs");
var Reflection = require("backpack-node").system.Reflection;
var templateHelpers = require('./templateHelpers');
var requireFromRoot = function(resource) {
  function canRequire(rp) {
    var jsPath = !_.endsWith(rp, ".js") ? (rp + ".js") : rp;
    var indexPath = path.join(rp, "index.js");
    return fs.existsSync(jsPath) || fs.existsSync(indexPath);
  }
  if (canRequire(resource)) {
    return require(resource);
  }
  throw new Error("Required resource '" + resource + "' cannot be found.");
};
function ActivityMarkup() {
  this._systemTypes = new StrMap();
  this._registerSystemTypes();
}
ActivityMarkup.prototype._registerSystemTypes = function() {
  this._registerTypes(__dirname);
};
ActivityMarkup.prototype._registerTypes = function(sourcePath) {
  this._registerTypesTo(this._systemTypes, sourcePath);
};
ActivityMarkup.prototype._registerTypesTo = function(types, sourcePath) {
  var self = this;
  var obj = requireFromRoot(sourcePath);
  Reflection.visitObject(obj, function(inObj) {
    var alias = self._getAlias(inObj);
    if (alias && !types.containsKey(alias)) {
      types.add(alias, inObj);
    }
    return alias == null;
  });
};
ActivityMarkup.prototype._getAlias = function(type) {
  if (_.isFunction(type) && is.defined(type.super_)) {
    var alias = this._toCamelCase(type.name);
    do {
      if (type.super_ === Activity)
        return alias;
      type = type.super_;
    } while (type);
  }
  return null;
};
ActivityMarkup.prototype._toCamelCase = function(id) {
  return id[0].toLowerCase() + id.substr(1);
};
ActivityMarkup.prototype.parse = function(markup) {
  if (!markup)
    throw new TypeError("Parameter 'markup' expected.");
  if (_.isString(markup))
    markup = JSON.parse(markup);
  if (!_.isPlainObject(markup))
    throw new TypeError("Parameter 'markup' is not a plain object.");
  var types = new StrMap();
  this._systemTypes.forEach(function(item) {
    types.set(item.key, item.value);
  });
  var req = markup["@require"];
  if (req)
    this._require(types, req);
  return this._createActivity(types, markup);
};
ActivityMarkup.prototype._createActivity = function(types, markup) {
  var filedNames = _.filter(_.keys(markup), function(k) {
    return k != "@require";
  });
  if (filedNames.length != 1)
    throw new errors.ActivityMarkupError("There should be one field." + this._errorHint(markup));
  var activityAlias = filedNames[0];
  return this._createAndInitActivityInstance(types, activityAlias, markup);
};
ActivityMarkup.prototype._createAndInitActivityInstance = function(types, alias, markup) {
  var activity = this._createActivityInstance(types, alias);
  if (!activity)
    throw new errors.ActivityMarkupError("Unknown activity alias '" + alias + "'." + this._errorHint(markup));
  var activityRef = {
    name: alias,
    value: activity
  };
  var pars = markup[alias];
  if (pars)
    this._setupActivity(types, activityRef, pars);
  return activityRef.value;
};
ActivityMarkup.prototype._createActivityInstance = function(types, alias) {
  var type = types.get(alias);
  if (is.undefined(type))
    return null;
  return new type();
};
ActivityMarkup.prototype._setupActivity = function(types, activityRef, pars) {
  var self = this;
  var activity = activityRef.value;
  function noFunction(fieldName) {
    return activity.codeProperties.exists(fieldName);
  }
  if (_.isArray(pars)) {
    activity.args = [];
    pars.forEach(function(obj) {
      activity.args.push(self._createValue(types, obj, false, is.template(activity)));
    });
  } else if (_.isObject(pars)) {
    var to = null;
    for (var fieldName in pars) {
      if (fieldName == "args") {
        var v = self._createValue(types, pars[fieldName], true, is.template(activity));
        if (!_.isArray(v))
          v = [v];
        activity.args = v;
      } else if (fieldName == "@to") {
        if (to)
          throw new errors.ActivityMarkupError("Multiple to defined in activity '" + activityRef.name + "." + this._errorHint(pars));
        to = pars[fieldName];
      } else if (fieldName[0] == "!") {
        if (!activity.promotedProperties || !_.isFunction(activity.promoted))
          throw new errors.ActivityMarkupError("Activity '" + activityRef.name + " cannot have promoted properties." + this._errorHint(pars));
        activity.promoted(fieldName.substr(1), self._createValue(types, pars[fieldName], true, is.template(activity)));
      } else if (fieldName == "@require") {
        self._require(types, pars[fieldName]);
      } else {
        activity[fieldName] = self._createValue(types, pars[fieldName], true, is.template(activity), noFunction(fieldName));
      }
    }
    if (to) {
      var current = activity;
      var assign = activityRef.value = this._createActivityInstance(types, "assign");
      assign.value = current;
      assign.to = to;
    }
  } else {
    activity.args = [self._createValue(types, pars, false, is.template(activity))];
  }
};
ActivityMarkup.prototype._require = function(types, markup) {
  var self = this;
  if (_.isArray(markup)) {
    markup.forEach(function(item) {
      self._require(types, item);
    });
  } else if (_.isString(markup)) {
    self._registerTypesTo(types, markup);
  } else {
    throw new errors.ActivityMarkupError("Cannot register '" + markup + "'." + self._errorHint(markup));
  }
};
ActivityMarkup.prototype._createValue = function(types, markup, canBeArray, noTemplate, noFunction) {
  var self = this;
  if (_.isArray(markup)) {
    if (canBeArray) {
      var result = [];
      markup.forEach(function(v) {
        result.push(self._createValue(types, v));
      });
      return result;
    } else if (!noTemplate && templateHelpers.isTemplate(markup)) {
      var template = self._createActivityInstance(types, "template");
      template.declare = markup;
      return template;
    }
  } else if (_.isPlainObject(markup)) {
    var filedNames = _.keys(markup);
    if (filedNames.length == 1) {
      var fieldName = filedNames[0];
      var fieldValue = markup[fieldName];
      if (fieldName == "_") {
        return fieldValue;
      }
      if (types.containsKey(fieldName)) {
        return self._createAndInitActivityInstance(types, fieldName, markup);
      }
    }
    if (!noTemplate && templateHelpers.isTemplate(markup)) {
      var template = self._createActivityInstance(types, "template");
      template.declare = markup;
      return template;
    }
  } else if (_.isString(markup)) {
    var trimmed = markup.trim();
    if (trimmed.match(/^\s*function\s*\w*\s*\((?:\w+,)*(?:\w+)?\)\s*\{/)) {
      try {
        var f;
        eval("f = " + trimmed);
        if (_.isFunction(f)) {
          if (!noFunction) {
            var func = self._createActivityInstance(types, "func");
            func.code = markup;
            return func;
          } else {
            return f;
          }
        }
      } catch (e) {}
    } else if (trimmed.length > 1 && trimmed[0] == "#") {
      var expr = self._createActivityInstance(types, "expression");
      expr.expr = trimmed.substr(1);
      return expr;
    }
  } else if (_.isFunction(markup)) {
    if (!noFunction) {
      var func = self._createActivityInstance(types, "func");
      func.code = markup;
      return func;
    }
  }
  return markup;
};
ActivityMarkup.prototype._errorHint = function(markup) {
  var len = 20;
  var json = JSON.stringify(markup);
  if (json.length > len)
    json = json.substr(0, len) + " ...";
  return "\nSee error near:\n" + json;
};
ActivityMarkup.prototype.stringify = function(obj) {
  if (_.isString(obj))
    return obj;
  if (is.activity(obj))
    obj = this.toMarkup(obj);
  if (!_.isPlainObject(obj))
    throw new TypeError("Parameter 'obj' is not a plain object.");
  var cloned = _.clone(obj);
  this._functionsToString(cloned);
  return JSON.stringify(cloned);
};
ActivityMarkup.prototype._functionsToString = function(obj) {
  var self = this;
  for (var fieldName in obj) {
    var fieldValue = obj[fieldName];
    if (_.isFunction(fieldValue))
      obj[fieldName] = fieldValue.toString();
    else if (_.isObject(fieldValue))
      self._functionsToString(fieldValue);
    else if (_.isArray(fieldValue))
      fieldValue.forEach(function(v) {
        self._functionsToString(v);
      });
  }
};
ActivityMarkup.prototype.toMarkup = function(activity) {
  if (!is.activity(activity))
    throw new TypeError("Argument is not an activity instance.");
  var markup = {};
  var alias = this._getAlias(activity.constructor);
  var activityMarkup = this._createMarkupOfActivity(activity);
};
var activityMarkup = null;
module.exports = {
  parse: function(markup) {
    return (activityMarkup = (activityMarkup || new ActivityMarkup())).parse(markup);
  },
  toMarkup: function(activity) {
    return (activityMarkup = (activityMarkup || new ActivityMarkup())).toMarkup(activity);
  },
  stringify: function(obj) {
    return (activityMarkup = (activityMarkup || new ActivityMarkup())).stringify(obj);
  }
};
//# sourceMappingURL=data:application/json;base64,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TSxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7RUFDcEY7QUFFQSxTQUFPLENBQUcsVUFBVSxRQUFPLENBQUc7QUFDMUIsU0FBTyxDQUFBLENBQUMsY0FBYSxFQUFJLEVBQUMsY0FBYSxHQUFLLElBQUksZUFBYSxBQUFDLEVBQUMsQ0FBQyxDQUFDLFNBQVMsQUFBQyxDQUFDLFFBQU8sQ0FBQyxDQUFDO0VBQ3pGO0FBRUEsVUFBUSxDQUFHLFVBQVUsR0FBRSxDQUFHO0FBQ3RCLFNBQU8sQ0FBQSxDQUFDLGNBQWEsRUFBSSxFQUFDLGNBQWEsR0FBSyxJQUFJLGVBQWEsQUFBQyxFQUFDLENBQUMsQ0FBQyxVQUFVLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0FBQztFQUNyRjtBQUFBLEFBQ0osQ0FBQTtBQUFBIiwiZmlsZSI6ImFjdGl2aXRpZXMvYWN0aXZpdHlNYXJrdXAuanMiLCJzb3VyY2VSb290IjoiQzovR0lUL3dvcmtmbG93LTQtbm9kZS9saWIvIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG52YXIgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XHJcbnZhciBlcnJvcnMgPSByZXF1aXJlKFwiLi4vY29tbW9uL2Vycm9yc1wiKTtcclxudmFyIEFjdGl2aXR5ID0gcmVxdWlyZShcIi4vYWN0aXZpdHlcIik7XHJcbnZhciBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XHJcbnZhciBTdHJNYXAgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5jb2xsZWN0aW9ucy5TdHJNYXA7XHJcbnZhciBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbnZhciBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcclxudmFyIFJlZmxlY3Rpb24gPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5zeXN0ZW0uUmVmbGVjdGlvbjtcclxudmFyIHRlbXBsYXRlSGVscGVycyA9IHJlcXVpcmUoJy4vdGVtcGxhdGVIZWxwZXJzJyk7XHJcblxyXG52YXIgcmVxdWlyZUZyb21Sb290ID0gZnVuY3Rpb24gKHJlc291cmNlKSB7XHJcbiAgICBmdW5jdGlvbiBjYW5SZXF1aXJlIChycCkge1xyXG4gICAgICAgIHZhciBqc1BhdGggPSAhXy5lbmRzV2l0aChycCwgXCIuanNcIikgPyAocnAgKyBcIi5qc1wiKSA6IHJwO1xyXG4gICAgICAgIHZhciBpbmRleFBhdGggPSBwYXRoLmpvaW4ocnAsIFwiaW5kZXguanNcIik7XHJcbiAgICAgICAgcmV0dXJuIGZzLmV4aXN0c1N5bmMoanNQYXRoKSB8fCBmcy5leGlzdHNTeW5jKGluZGV4UGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNhblJlcXVpcmUocmVzb3VyY2UpKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUocmVzb3VyY2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHRocm93IG5ldyBFcnJvcihcIlJlcXVpcmVkIHJlc291cmNlICdcIiArIHJlc291cmNlICsgXCInIGNhbm5vdCBiZSBmb3VuZC5cIik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIEFjdGl2aXR5TWFya3VwICgpIHtcclxuICAgIHRoaXMuX3N5c3RlbVR5cGVzID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgdGhpcy5fcmVnaXN0ZXJTeXN0ZW1UeXBlcygpO1xyXG59XHJcblxyXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX3JlZ2lzdGVyU3lzdGVtVHlwZXMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB0aGlzLl9yZWdpc3RlclR5cGVzKF9fZGlybmFtZSk7XHJcbn1cclxuXHJcbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS5fcmVnaXN0ZXJUeXBlcyA9IGZ1bmN0aW9uIChzb3VyY2VQYXRoKSB7XHJcbiAgICB0aGlzLl9yZWdpc3RlclR5cGVzVG8odGhpcy5fc3lzdGVtVHlwZXMsIHNvdXJjZVBhdGgpO1xyXG59XHJcblxyXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX3JlZ2lzdGVyVHlwZXNUbyA9IGZ1bmN0aW9uICh0eXBlcywgc291cmNlUGF0aCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgdmFyIG9iaiA9IHJlcXVpcmVGcm9tUm9vdChzb3VyY2VQYXRoKTtcclxuICAgIFJlZmxlY3Rpb24udmlzaXRPYmplY3Qob2JqLCBmdW5jdGlvbiAoaW5PYmopIHtcclxuICAgICAgICB2YXIgYWxpYXMgPSBzZWxmLl9nZXRBbGlhcyhpbk9iaik7XHJcbiAgICAgICAgaWYgKGFsaWFzICYmICF0eXBlcy5jb250YWluc0tleShhbGlhcykpIHtcclxuICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBhY3Rpdml0eSB0eXBlXHJcbiAgICAgICAgICAgIHR5cGVzLmFkZChhbGlhcywgaW5PYmopO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYWxpYXMgPT0gbnVsbDtcclxuICAgIH0pO1xyXG59XHJcblxyXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX2dldEFsaWFzID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAgIGlmIChfLmlzRnVuY3Rpb24odHlwZSkgJiYgaXMuZGVmaW5lZCh0eXBlLnN1cGVyXykpIHtcclxuICAgICAgICB2YXIgYWxpYXMgPSB0aGlzLl90b0NhbWVsQ2FzZSh0eXBlLm5hbWUpO1xyXG4gICAgICAgIGRvXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBpZiAodHlwZS5zdXBlcl8gPT09IEFjdGl2aXR5KSByZXR1cm4gYWxpYXM7XHJcbiAgICAgICAgICAgIHR5cGUgPSB0eXBlLnN1cGVyXztcclxuICAgICAgICB9XHJcbiAgICAgICAgd2hpbGUgKHR5cGUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS5fdG9DYW1lbENhc2UgPSBmdW5jdGlvbiAoaWQpIHtcclxuICAgIHJldHVybiBpZFswXS50b0xvd2VyQ2FzZSgpICsgaWQuc3Vic3RyKDEpO1xyXG59XHJcblxyXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbiAobWFya3VwKSB7XHJcbiAgICBpZiAoIW1hcmt1cCkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlBhcmFtZXRlciAnbWFya3VwJyBleHBlY3RlZC5cIik7XHJcbiAgICBpZiAoXy5pc1N0cmluZyhtYXJrdXApKSBtYXJrdXAgPSBKU09OLnBhcnNlKG1hcmt1cCk7XHJcbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChtYXJrdXApKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiUGFyYW1ldGVyICdtYXJrdXAnIGlzIG5vdCBhIHBsYWluIG9iamVjdC5cIik7XHJcblxyXG4gICAgdmFyIHR5cGVzID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgdGhpcy5fc3lzdGVtVHlwZXMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICAgIHR5cGVzLnNldChpdGVtLmtleSwgaXRlbS52YWx1ZSk7XHJcbiAgICB9KTtcclxuICAgIHZhciByZXEgPSBtYXJrdXBbXCJAcmVxdWlyZVwiXTtcclxuICAgIGlmIChyZXEpIHRoaXMuX3JlcXVpcmUodHlwZXMsIHJlcSk7XHJcbiAgICByZXR1cm4gdGhpcy5fY3JlYXRlQWN0aXZpdHkodHlwZXMsIG1hcmt1cCk7XHJcbn1cclxuXHJcbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS5fY3JlYXRlQWN0aXZpdHkgPSBmdW5jdGlvbiAodHlwZXMsIG1hcmt1cCkge1xyXG4gICAgdmFyIGZpbGVkTmFtZXMgPSBfLmZpbHRlcihfLmtleXMobWFya3VwKSwgZnVuY3Rpb24gKGspIHsgcmV0dXJuIGsgIT0gXCJAcmVxdWlyZVwiIH0pO1xyXG4gICAgaWYgKGZpbGVkTmFtZXMubGVuZ3RoICE9IDEpIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlNYXJrdXBFcnJvcihcIlRoZXJlIHNob3VsZCBiZSBvbmUgZmllbGQuXCIgKyB0aGlzLl9lcnJvckhpbnQobWFya3VwKSk7XHJcblxyXG4gICAgdmFyIGFjdGl2aXR5QWxpYXMgPSBmaWxlZE5hbWVzWzBdO1xyXG4gICAgcmV0dXJuIHRoaXMuX2NyZWF0ZUFuZEluaXRBY3Rpdml0eUluc3RhbmNlKHR5cGVzLCBhY3Rpdml0eUFsaWFzLCBtYXJrdXApO1xyXG59XHJcblxyXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX2NyZWF0ZUFuZEluaXRBY3Rpdml0eUluc3RhbmNlID0gZnVuY3Rpb24gKHR5cGVzLCBhbGlhcywgbWFya3VwKSB7XHJcbiAgICB2YXIgYWN0aXZpdHkgPSB0aGlzLl9jcmVhdGVBY3Rpdml0eUluc3RhbmNlKHR5cGVzLCBhbGlhcyk7XHJcbiAgICBpZiAoIWFjdGl2aXR5KSB0aHJvdyBuZXcgZXJyb3JzLkFjdGl2aXR5TWFya3VwRXJyb3IoXCJVbmtub3duIGFjdGl2aXR5IGFsaWFzICdcIiArIGFsaWFzICsgXCInLlwiICsgdGhpcy5fZXJyb3JIaW50KG1hcmt1cCkpO1xyXG4gICAgdmFyIGFjdGl2aXR5UmVmID0ge1xyXG4gICAgICAgIG5hbWU6IGFsaWFzLFxyXG4gICAgICAgIHZhbHVlOiBhY3Rpdml0eVxyXG4gICAgfTtcclxuICAgIHZhciBwYXJzID0gbWFya3VwW2FsaWFzXTtcclxuICAgIGlmIChwYXJzKSB0aGlzLl9zZXR1cEFjdGl2aXR5KHR5cGVzLCBhY3Rpdml0eVJlZiwgcGFycyk7XHJcbiAgICByZXR1cm4gYWN0aXZpdHlSZWYudmFsdWU7XHJcbn1cclxuXHJcbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS5fY3JlYXRlQWN0aXZpdHlJbnN0YW5jZSA9IGZ1bmN0aW9uICh0eXBlcywgYWxpYXMpIHtcclxuICAgIHZhciB0eXBlID0gdHlwZXMuZ2V0KGFsaWFzKTtcclxuICAgIGlmIChpcy51bmRlZmluZWQodHlwZSkpIHJldHVybiBudWxsO1xyXG4gICAgcmV0dXJuIG5ldyB0eXBlKCk7XHJcbn1cclxuXHJcbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS5fc2V0dXBBY3Rpdml0eSA9IGZ1bmN0aW9uICh0eXBlcywgYWN0aXZpdHlSZWYsIHBhcnMpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHZhciBhY3Rpdml0eSA9IGFjdGl2aXR5UmVmLnZhbHVlO1xyXG5cclxuICAgIGZ1bmN0aW9uIG5vRnVuY3Rpb24gKGZpZWxkTmFtZSkge1xyXG4gICAgICAgIHJldHVybiBhY3Rpdml0eS5jb2RlUHJvcGVydGllcy5leGlzdHMoZmllbGROYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoXy5pc0FycmF5KHBhcnMpKSB7XHJcbiAgICAgICAgLy8gYXJnc1xyXG4gICAgICAgIGFjdGl2aXR5LmFyZ3MgPSBbXTtcclxuICAgICAgICBwYXJzLmZvckVhY2goXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChvYmopIHtcclxuICAgICAgICAgICAgICAgIGFjdGl2aXR5LmFyZ3MucHVzaChzZWxmLl9jcmVhdGVWYWx1ZSh0eXBlcywgb2JqLCBmYWxzZSwgaXMudGVtcGxhdGUoYWN0aXZpdHkpKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoXy5pc09iamVjdChwYXJzKSkge1xyXG4gICAgICAgIHZhciB0byA9IG51bGw7XHJcbiAgICAgICAgLy8gdmFsdWVzXHJcbiAgICAgICAgZm9yICh2YXIgZmllbGROYW1lIGluIHBhcnMpIHtcclxuICAgICAgICAgICAgaWYgKGZpZWxkTmFtZSA9PSBcImFyZ3NcIikge1xyXG4gICAgICAgICAgICAgICAgdmFyIHYgPSBzZWxmLl9jcmVhdGVWYWx1ZSh0eXBlcywgcGFyc1tmaWVsZE5hbWVdLCB0cnVlLCBpcy50ZW1wbGF0ZShhY3Rpdml0eSkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFfLmlzQXJyYXkodikpIHYgPSBbdl07XHJcbiAgICAgICAgICAgICAgICBhY3Rpdml0eS5hcmdzID0gdjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChmaWVsZE5hbWUgPT0gXCJAdG9cIikge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRvKSB0aHJvdyBuZXcgZXJyb3JzLkFjdGl2aXR5TWFya3VwRXJyb3IoXCJNdWx0aXBsZSB0byBkZWZpbmVkIGluIGFjdGl2aXR5ICdcIiArIGFjdGl2aXR5UmVmLm5hbWUgKyBcIi5cIiArIHRoaXMuX2Vycm9ySGludChwYXJzKSk7XHJcbiAgICAgICAgICAgICAgICB0byA9IHBhcnNbZmllbGROYW1lXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChmaWVsZE5hbWVbMF0gPT0gXCIhXCIpIHtcclxuICAgICAgICAgICAgICAgIC8vIFByb21vdGVkOlxyXG4gICAgICAgICAgICAgICAgaWYgKCFhY3Rpdml0eS5wcm9tb3RlZFByb3BlcnRpZXMgfHwgIV8uaXNGdW5jdGlvbihhY3Rpdml0eS5wcm9tb3RlZCkpIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlNYXJrdXBFcnJvcihcIkFjdGl2aXR5ICdcIiArIGFjdGl2aXR5UmVmLm5hbWUgKyBcIiBjYW5ub3QgaGF2ZSBwcm9tb3RlZCBwcm9wZXJ0aWVzLlwiICsgdGhpcy5fZXJyb3JIaW50KHBhcnMpKTtcclxuICAgICAgICAgICAgICAgIGFjdGl2aXR5LnByb21vdGVkKGZpZWxkTmFtZS5zdWJzdHIoMSksIHNlbGYuX2NyZWF0ZVZhbHVlKHR5cGVzLCBwYXJzW2ZpZWxkTmFtZV0sIHRydWUsIGlzLnRlbXBsYXRlKGFjdGl2aXR5KSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKGZpZWxkTmFtZSA9PSBcIkByZXF1aXJlXCIpIHtcclxuICAgICAgICAgICAgICAgIC8vIFJlcXVpcmU6XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9yZXF1aXJlKHR5cGVzLCBwYXJzW2ZpZWxkTmFtZV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYWN0aXZpdHlbZmllbGROYW1lXSA9IHNlbGYuX2NyZWF0ZVZhbHVlKHR5cGVzLCBwYXJzW2ZpZWxkTmFtZV0sIHRydWUsIGlzLnRlbXBsYXRlKGFjdGl2aXR5KSwgbm9GdW5jdGlvbihmaWVsZE5hbWUpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodG8pIHtcclxuICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBhY3Rpdml0eTtcclxuICAgICAgICAgICAgdmFyIGFzc2lnbiA9IGFjdGl2aXR5UmVmLnZhbHVlID0gdGhpcy5fY3JlYXRlQWN0aXZpdHlJbnN0YW5jZSh0eXBlcywgXCJhc3NpZ25cIik7XHJcbiAgICAgICAgICAgIGFzc2lnbi52YWx1ZSA9IGN1cnJlbnQ7XHJcbiAgICAgICAgICAgIGFzc2lnbi50byA9IHRvO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIC8vIDEgYXJnXHJcbiAgICAgICAgYWN0aXZpdHkuYXJncyA9IFtzZWxmLl9jcmVhdGVWYWx1ZSh0eXBlcywgcGFycywgZmFsc2UsIGlzLnRlbXBsYXRlKGFjdGl2aXR5KSldO1xyXG4gICAgfVxyXG59XHJcblxyXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX3JlcXVpcmUgPSBmdW5jdGlvbiAodHlwZXMsIG1hcmt1cCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIGlmIChfLmlzQXJyYXkobWFya3VwKSkge1xyXG4gICAgICAgIG1hcmt1cC5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgICAgIHNlbGYuX3JlcXVpcmUodHlwZXMsIGl0ZW0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoXy5pc1N0cmluZyhtYXJrdXApKSB7XHJcbiAgICAgICAgc2VsZi5fcmVnaXN0ZXJUeXBlc1RvKHR5cGVzLCBtYXJrdXApO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eU1hcmt1cEVycm9yKFwiQ2Fubm90IHJlZ2lzdGVyICdcIiArIG1hcmt1cCArIFwiJy5cIiArIHNlbGYuX2Vycm9ySGludChtYXJrdXApKTtcclxuICAgIH1cclxufVxyXG5cclxuQWN0aXZpdHlNYXJrdXAucHJvdG90eXBlLl9jcmVhdGVWYWx1ZSA9IGZ1bmN0aW9uICh0eXBlcywgbWFya3VwLCBjYW5CZUFycmF5LCBub1RlbXBsYXRlLCBub0Z1bmN0aW9uKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICBpZiAoXy5pc0FycmF5KG1hcmt1cCkpIHtcclxuICAgICAgICBpZiAoY2FuQmVBcnJheSkge1xyXG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107XHJcbiAgICAgICAgICAgIG1hcmt1cC5mb3JFYWNoKGZ1bmN0aW9uICh2KSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChzZWxmLl9jcmVhdGVWYWx1ZSh0eXBlcywgdikpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoIW5vVGVtcGxhdGUgJiYgdGVtcGxhdGVIZWxwZXJzLmlzVGVtcGxhdGUobWFya3VwKSkge1xyXG4gICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBzZWxmLl9jcmVhdGVBY3Rpdml0eUluc3RhbmNlKHR5cGVzLCBcInRlbXBsYXRlXCIpO1xyXG4gICAgICAgICAgICB0ZW1wbGF0ZS5kZWNsYXJlID0gbWFya3VwO1xyXG4gICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoXy5pc1BsYWluT2JqZWN0KG1hcmt1cCkpIHtcclxuICAgICAgICB2YXIgZmlsZWROYW1lcyA9IF8ua2V5cyhtYXJrdXApO1xyXG4gICAgICAgIGlmIChmaWxlZE5hbWVzLmxlbmd0aCA9PSAxKSB7XHJcbiAgICAgICAgICAgIHZhciBmaWVsZE5hbWUgPSBmaWxlZE5hbWVzWzBdO1xyXG4gICAgICAgICAgICB2YXIgZmllbGRWYWx1ZSA9IG1hcmt1cFtmaWVsZE5hbWVdO1xyXG5cclxuICAgICAgICAgICAgaWYgKGZpZWxkTmFtZSA9PSBcIl9cIikge1xyXG4gICAgICAgICAgICAgICAgLy8gRXNjYXBlOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkVmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0eXBlcy5jb250YWluc0tleShmaWVsZE5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBBY3Rpdml0eTpcclxuICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVBbmRJbml0QWN0aXZpdHlJbnN0YW5jZSh0eXBlcywgZmllbGROYW1lLCBtYXJrdXApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBQbGFpbiBvYmplY3Q6XHJcbiAgICAgICAgaWYgKCFub1RlbXBsYXRlICYmIHRlbXBsYXRlSGVscGVycy5pc1RlbXBsYXRlKG1hcmt1cCkpIHtcclxuICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gc2VsZi5fY3JlYXRlQWN0aXZpdHlJbnN0YW5jZSh0eXBlcywgXCJ0ZW1wbGF0ZVwiKTtcclxuICAgICAgICAgICAgdGVtcGxhdGUuZGVjbGFyZSA9IG1hcmt1cDtcclxuICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGVsc2UgaWYgKF8uaXNTdHJpbmcobWFya3VwKSkge1xyXG4gICAgICAgIHZhciB0cmltbWVkID0gbWFya3VwLnRyaW0oKTtcclxuICAgICAgICBpZiAodHJpbW1lZC5tYXRjaCgvXlxccypmdW5jdGlvblxccypcXHcqXFxzKlxcKCg/OlxcdyssKSooPzpcXHcrKT9cXClcXHMqXFx7LykpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHZhciBmO1xyXG4gICAgICAgICAgICAgICAgZXZhbChcImYgPSBcIiArIHRyaW1tZWQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihmKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghbm9GdW5jdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZnVuYyA9IHNlbGYuX2NyZWF0ZUFjdGl2aXR5SW5zdGFuY2UodHlwZXMsIFwiZnVuY1wiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuYy5jb2RlID0gbWFya3VwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuYztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmOyAvLyBha2Egd2hlbiBmdW5jLmNvZGVcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIC8vIEl0J3Mgbm90IGEgZnVuY3Rpb25cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICh0cmltbWVkLmxlbmd0aCA+IDEgJiYgdHJpbW1lZFswXSA9PSBcIiNcIikge1xyXG4gICAgICAgICAgICAvLyBFeHByZXNzaW9uXHJcbiAgICAgICAgICAgIHZhciBleHByID0gc2VsZi5fY3JlYXRlQWN0aXZpdHlJbnN0YW5jZSh0eXBlcywgXCJleHByZXNzaW9uXCIpO1xyXG4gICAgICAgICAgICBleHByLmV4cHIgPSB0cmltbWVkLnN1YnN0cigxKTtcclxuICAgICAgICAgICAgcmV0dXJuIGV4cHI7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoXy5pc0Z1bmN0aW9uKG1hcmt1cCkpIHtcclxuICAgICAgICBpZiAoIW5vRnVuY3Rpb24pIHtcclxuICAgICAgICAgICAgdmFyIGZ1bmMgPSBzZWxmLl9jcmVhdGVBY3Rpdml0eUluc3RhbmNlKHR5cGVzLCBcImZ1bmNcIik7XHJcbiAgICAgICAgICAgIGZ1bmMuY29kZSA9IG1hcmt1cDtcclxuICAgICAgICAgICAgcmV0dXJuIGZ1bmM7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBtYXJrdXA7XHJcbn1cclxuXHJcbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS5fZXJyb3JIaW50ID0gZnVuY3Rpb24gKG1hcmt1cCkge1xyXG4gICAgdmFyIGxlbiA9IDIwO1xyXG4gICAgdmFyIGpzb24gPSBKU09OLnN0cmluZ2lmeShtYXJrdXApO1xyXG4gICAgaWYgKGpzb24ubGVuZ3RoID4gbGVuKSBqc29uID0ganNvbi5zdWJzdHIoMCwgbGVuKSArIFwiIC4uLlwiO1xyXG4gICAgcmV0dXJuIFwiXFxuU2VlIGVycm9yIG5lYXI6XFxuXCIgKyBqc29uO1xyXG59XHJcblxyXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuc3RyaW5naWZ5ID0gZnVuY3Rpb24gKG9iaikge1xyXG4gICAgaWYgKF8uaXNTdHJpbmcob2JqKSkgcmV0dXJuIG9iajtcclxuICAgIGlmIChpcy5hY3Rpdml0eShvYmopKSBvYmogPSB0aGlzLnRvTWFya3VwKG9iaik7XHJcbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChvYmopKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiUGFyYW1ldGVyICdvYmonIGlzIG5vdCBhIHBsYWluIG9iamVjdC5cIik7XHJcbiAgICB2YXIgY2xvbmVkID0gXy5jbG9uZShvYmopO1xyXG4gICAgdGhpcy5fZnVuY3Rpb25zVG9TdHJpbmcoY2xvbmVkKTtcclxuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShjbG9uZWQpO1xyXG59XHJcblxyXG5BY3Rpdml0eU1hcmt1cC5wcm90b3R5cGUuX2Z1bmN0aW9uc1RvU3RyaW5nID0gZnVuY3Rpb24gKG9iaikge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgZm9yICh2YXIgZmllbGROYW1lIGluIG9iaikge1xyXG4gICAgICAgIHZhciBmaWVsZFZhbHVlID0gb2JqW2ZpZWxkTmFtZV07XHJcbiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihmaWVsZFZhbHVlKSkgb2JqW2ZpZWxkTmFtZV0gPSBmaWVsZFZhbHVlLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgZWxzZSBpZiAoXy5pc09iamVjdChmaWVsZFZhbHVlKSkgc2VsZi5fZnVuY3Rpb25zVG9TdHJpbmcoZmllbGRWYWx1ZSk7XHJcbiAgICAgICAgZWxzZSBpZiAoXy5pc0FycmF5KGZpZWxkVmFsdWUpKSBmaWVsZFZhbHVlLmZvckVhY2goZnVuY3Rpb24gKHYpIHtcclxuICAgICAgICAgICAgc2VsZi5fZnVuY3Rpb25zVG9TdHJpbmcodik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIFRvIE1hcmt1cDpcclxuXHJcbkFjdGl2aXR5TWFya3VwLnByb3RvdHlwZS50b01hcmt1cCA9IGZ1bmN0aW9uIChhY3Rpdml0eSkge1xyXG4gICAgaWYgKCFpcy5hY3Rpdml0eShhY3Rpdml0eSkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCBpcyBub3QgYW4gYWN0aXZpdHkgaW5zdGFuY2UuXCIpO1xyXG5cclxuICAgIHZhciBtYXJrdXAgPSB7fTtcclxuICAgIHZhciBhbGlhcyA9IHRoaXMuX2dldEFsaWFzKGFjdGl2aXR5LmNvbnN0cnVjdG9yKTtcclxuICAgIHZhciBhY3Rpdml0eU1hcmt1cCA9IHRoaXMuX2NyZWF0ZU1hcmt1cE9mQWN0aXZpdHkoYWN0aXZpdHkpO1xyXG5cclxufVxyXG5cclxuLy8gRXhwb3J0czpcclxuXHJcbnZhciBhY3Rpdml0eU1hcmt1cCA9IG51bGw7XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICAgIHBhcnNlOiBmdW5jdGlvbiAobWFya3VwKSB7XHJcbiAgICAgICAgcmV0dXJuIChhY3Rpdml0eU1hcmt1cCA9IChhY3Rpdml0eU1hcmt1cCB8fCBuZXcgQWN0aXZpdHlNYXJrdXAoKSkpLnBhcnNlKG1hcmt1cCk7XHJcbiAgICB9LFxyXG5cclxuICAgIHRvTWFya3VwOiBmdW5jdGlvbiAoYWN0aXZpdHkpIHtcclxuICAgICAgICByZXR1cm4gKGFjdGl2aXR5TWFya3VwID0gKGFjdGl2aXR5TWFya3VwIHx8IG5ldyBBY3Rpdml0eU1hcmt1cCgpKSkudG9NYXJrdXAoYWN0aXZpdHkpO1xyXG4gICAgfSxcclxuXHJcbiAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uIChvYmopIHtcclxuICAgICAgICByZXR1cm4gKGFjdGl2aXR5TWFya3VwID0gKGFjdGl2aXR5TWFya3VwIHx8IG5ldyBBY3Rpdml0eU1hcmt1cCgpKSkuc3RyaW5naWZ5KG9iaik7XHJcbiAgICB9XHJcbn0iXX0=
