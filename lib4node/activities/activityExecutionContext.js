"use strict";
var ActivityExecutionState = require("./activityExecutionState");
var ResumeBookmarkQueue = require("./resumeBookmarkQueue");
var enums = require("../common/enums");
var errors = require("../common/errors");
var util = require("util");
var EventEmitter = require('events').EventEmitter;
var _ = require("lodash");
var guids = require("../common/guids");
var ScopeTree = require("./scopeTree");
var StrMap = require("backpack-node").collections.StrMap;
var StrSet = require("backpack-node").collections.StrSet;
var is = require("../common/is");
var fast = require("fast.js");
var CallContext = require("./callContext");
function ActivityExecutionContext() {
  this._activityStates = new StrMap();
  this._bookmarks = new StrMap();
  this._resumeBMQueue = new ResumeBookmarkQueue();
  this._rootActivity = null;
  this._knownActivities = new StrMap();
  this._nextActivityId = 0;
  this._scopeTree = this._createScopeTree();
}
util.inherits(ActivityExecutionContext, EventEmitter);
Object.defineProperties(ActivityExecutionContext.prototype, {
  scope: {get: function() {
      return this._scopeTree.currentScope;
    }},
  hasScope: {get: function() {
      return !this._scopeTree.isOnInitial;
    }}
});
ActivityExecutionContext.prototype._createScopeTree = function() {
  var self = this;
  return new ScopeTree({resultCollected: function(context, reason, result, bookmarkName) {
      context.activity.resultCollected.call(context.scope, context, reason, result, bookmarkName);
    }}, function(id) {
    return self._getKnownActivity(id);
  });
};
ActivityExecutionContext.prototype._registerKnownActivity = function(activity) {
  this._knownActivities.add(activity.id, activity);
  if (is.composite(activity))
    activity.ensureImplementationCreated();
};
ActivityExecutionContext.prototype.initialize = function(rootActivity) {
  if (this._rootActivity)
    throw new Error("Context is already initialized.");
  if (!is.activity(rootActivity))
    throw new TypeError("Argument 'rootActivity' value is not an activity.");
  this._rootActivity = rootActivity;
  this._initialize(null, rootActivity, {id: 0});
};
ActivityExecutionContext.prototype.appendToContext = function(args) {
  this._checkInit();
  var self = this;
  var currMax = self._nextActivityId;
  var c = {id: currMax};
  if (_.isArray(args)) {
    var state = self.getState(self._rootActivity.id);
    args.forEach(function(arg) {
      if (is.activity(arg)) {
        self._initialize(self._rootActivity, arg, c);
        state.childActivityIds.add(arg.id);
      }
    });
  } else {
    throw new TypeError("Argument 'args' value is not an array.");
  }
  return {
    fromId: currMax,
    toId: this._nextActivityId
  };
};
ActivityExecutionContext.prototype.removeFromContext = function(removeToken) {
  this._checkInit();
  if (removeToken && is.defined(removeToken.fromId) && is.defined(removeToken.toId)) {
    var state = this.getState(this._rootActivity.id);
    for (var id = removeToken.fromId; id <= removeToken.toId; id++) {
      var sid = id.toString();
      this._knownActivities.remove(sid);
      state.childActivityIds.remove(sid);
    }
  } else {
    throw new TypeError("Argument 'removeToken' value is not a valid remove token object.");
  }
  this._nextActivityId = removeToken.fromId;
};
ActivityExecutionContext.prototype._checkInit = function() {
  if (!this._rootActivity)
    throw new Error("Context is not initialized.");
};
ActivityExecutionContext.prototype._initialize = function(parent, activity, idCounter) {
  var self = this;
  if (activity.id === null) {
    activity.id = (idCounter.id++).toString();
  } else if (activity.id != (idCounter.id++).toString()) {
    throw new Error("Activity " + activity.id + " has been assigned to an other context in a different tree which is not allowed.");
  }
  self._nextActivityId = idCounter.id;
  var state = self.getState(activity.id);
  state.parentActivityId = parent ? parent.id : null;
  self._registerKnownActivity(activity);
  activity.forEachImmediateChild(function(child) {
    self._initialize(activity, child, idCounter);
    state.childActivityIds.add(child.id);
  });
};
ActivityExecutionContext.prototype.getState = function(id) {
  var self = this;
  var state = self._activityStates.get(id);
  if (is.undefined(state)) {
    state = new ActivityExecutionState(id);
    state.on(enums.ActivityStates.run, function() {
      var activity = self._knownActivities.get(id);
      if (!activity)
        activity = {id: id};
      self.emit(enums.ActivityStates.run, activity);
    });
    state.on(enums.ActivityStates.end, function(reason, result) {
      var activity = self._knownActivities.get(id);
      if (!activity)
        activity = {id: id};
      self.emit(enums.ActivityStates.end, activity, reason, result);
    });
    self._activityStates.add(id, state);
  }
  return state;
};
ActivityExecutionContext.prototype._getKnownActivity = function(activityId) {
  var activity = this._knownActivities.get(activityId);
  if (!activity)
    throw new errors.ActivityRuntimeError("Activity by id '" + activityId + "' not found.");
  return activity;
};
ActivityExecutionContext.prototype.createBookmark = function(activityId, name, endCallback) {
  this.registerBookmark({
    name: name,
    activityId: activityId,
    timestamp: new Date().getTime(),
    endCallback: endCallback
  });
  return name;
};
ActivityExecutionContext.prototype.registerBookmark = function(bookmark) {
  if (this._bookmarks.get(bookmark.name))
    throw new errors.ActivityRuntimeError("Bookmark '" + bookmark.name + "' already exists.");
  this._bookmarks.set(bookmark.name, bookmark);
};
ActivityExecutionContext.prototype.isBookmarkExists = function(name) {
  return this._bookmarks.containsKey(name);
};
ActivityExecutionContext.prototype.getBookmarkTimestamp = function(name, throwIfNotFound) {
  var bm = this._bookmarks.get(name);
  if (is.undefined(bm) && throwIfNotFound)
    throw new Error("Bookmark '" + name + "' not found.");
  return bm ? bm.timestamp : null;
};
ActivityExecutionContext.prototype.deleteBookmark = function(name) {
  this._bookmarks.remove(name);
};
ActivityExecutionContext.prototype.resumeBookmarkInScope = function(callContext, name, reason, result) {
  var bm = this._bookmarks.get(name);
  if (is.undefined(bm)) {
    throw new Error("Bookmark '" + name + "' doesn't exists. Cannot continue with reason: " + reason + ".");
  }
  this._doResumeBookmark(callContext, bm, reason, result, reason == enums.ActivityStates.idle);
};
ActivityExecutionContext.prototype.resumeBookmarkInternal = function(callContext, name, reason, result) {
  var bm = this._bookmarks.get(name);
  this._resumeBMQueue.enqueue(name, reason, result);
};
ActivityExecutionContext.prototype.resumeBookmarkExternal = function(name, reason, result) {
  var self = this;
  var bm = self._bookmarks.get(name);
  if (is.undefined(bm))
    throw new errors.ActivityRuntimeError("Internal resume bookmark request cannot be processed because bookmark '" + command.name + "' doesn't exists.");
  self._doResumeBookmark(new CallContext(this, bm.activityId), bm, reason, result);
};
ActivityExecutionContext.prototype.processResumeBookmarkQueue = function() {
  var self = this;
  var command = self._resumeBMQueue.dequeue();
  if (command) {
    var bm = self._bookmarks.get(command.name);
    if (is.undefined(bm))
      throw new errors.ActivityRuntimeError("Internal resume bookmark request cannot be processed because bookmark '" + command.name + "' doesn't exists.");
    self._doResumeBookmark(new CallContext(this, bm.activityId), bm, command.reason, command.result);
    return true;
  }
  return false;
};
ActivityExecutionContext.prototype._doResumeBookmark = function(callContext, bookmark, reason, result, noRemove) {
  var scope = callContext.scope;
  if (!noRemove)
    this._bookmarks.remove(bookmark.name);
  if (is.undefined(scope.get(bookmark.endCallback))) {
    throw new errors.ActivityRuntimeError("Bookmark's '" + bookmark.name + "' callback '" + bookmark.endCallback + "' is not defined on the current scope.");
  }
  scope.get(bookmark.endCallback).call(scope, callContext, reason, result, bookmark);
};
ActivityExecutionContext.prototype.cancelExecution = function(activityIds) {
  var self = this;
  var allIds = new StrSet();
  fast.forEach(activityIds, function(id) {
    self._cancelSubtree(allIds, id);
  });
  self._bookmarks.forEachValue(function(bm) {
    if (allIds.exists(bm.activityId)) {
      self._bookmarks.remove(bm.name);
    }
  });
};
ActivityExecutionContext.prototype._cancelSubtree = function(allIds, activityId) {
  var self = this;
  allIds.add(activityId);
  var state = self.getState(activityId);
  state.childActivityIds.forEach(function(id) {
    self._cancelSubtree(allIds, id);
  });
  state.reportState(enums.ActivityStates.cancel);
};
ActivityExecutionContext.prototype.deleteScopeOfActivity = function(callContext, activityId) {
  this._scopeTree.deleteScopePart(callContext.activityId, activityId);
};
ActivityExecutionContext.prototype.getStateAndPromotions = function(serializer, getPromotions) {
  if (serializer && !_.isFunction(serializer.toJSON))
    throw new Error("Argument 'serializer' is not a serializer.");
  var activityStates = new StrMap();
  this._activityStates.forEachValue(function(s) {
    activityStates.add(s.activityId, s.asJSON());
  });
  var scopeStateAndPromotions = this._scopeTree.getState(getPromotions);
  var serialized;
  if (serializer) {
    serialized = serializer.toJSON({
      activityStates: activityStates,
      bookmarks: this._bookmarks,
      scope: scopeStateAndPromotions.state
    });
  } else {
    serialized = {
      activityStates: activityStates._serializeToJSON(),
      bookmarks: this._bookmarks._serializeToJSON(),
      scope: scopeStateAndPromotions.state
    };
  }
  return {
    state: serialized,
    promotedProperties: scopeStateAndPromotions.promotedProperties
  };
};
ActivityExecutionContext.prototype.setState = function(serializer, json) {
  if (serializer && !_.isFunction(serializer.fromJSON))
    throw new Error("Argument 'serializer' is not a serializer.");
  if (!_.isObject(json))
    throw new TypeError("Argument 'json' is not an object.");
  if (serializer) {
    json = serializer.fromJSON(json);
    if (!(json.activityStates instanceof StrMap))
      throw new TypeError("ActivityStates property value of argument 'json' is not an StrMap instance.");
    if (!(json.bookmarks instanceof StrMap))
      throw new TypeError("Bookmarks property value of argument 'json' is not an StrMap instance.");
  } else {
    if (!json.activityStates)
      throw new TypeError("ActivityStates property value of argument 'json' is not an object.");
    if (!json.bookmarks)
      throw new TypeError("Bookmarks property value of argument 'json' is not an object.");
    var activityStates = new StrMap();
    activityStates._deserializeFromJSON(json.activityStates);
    var bookmarks = new StrMap();
    bookmarks._deserializeFromJSON(json.bookmarks);
    json = {
      activityStates: activityStates,
      bookmarks: bookmarks,
      scope: json.scope
    };
  }
  this._activityStates.forEachValue(function(s) {
    var stored = json.activityStates.get(s.activityId);
    if (_.isUndefined(stored))
      throw new Error("Activity " + a.activityId + " state not found.");
    s.fromJSON(stored);
  });
  this._bookmarks = json.bookmarks;
  this._scopeTree.setState(json.scope);
};
module.exports = ActivityExecutionContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLEFBQUksRUFBQSxDQUFBLHNCQUFxQixFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsMEJBQXlCLENBQUMsQ0FBQztBQUNoRSxBQUFJLEVBQUEsQ0FBQSxtQkFBa0IsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLHVCQUFzQixDQUFDLENBQUM7QUFDMUQsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsaUJBQWdCLENBQUMsQ0FBQztBQUN0QyxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxrQkFBaUIsQ0FBQyxDQUFDO0FBQ3hDLEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLFlBQVcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFFBQU8sQ0FBQyxhQUFhLENBQUM7QUFDakQsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsaUJBQWdCLENBQUMsQ0FBQztBQUN0QyxBQUFJLEVBQUEsQ0FBQSxTQUFRLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxhQUFZLENBQUMsQ0FBQztBQUN0QyxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxlQUFjLENBQUMsWUFBWSxPQUFPLENBQUM7QUFDeEQsQUFBSSxFQUFBLENBQUEsTUFBSyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsZUFBYyxDQUFDLFlBQVksT0FBTyxDQUFDO0FBQ3hELEFBQUksRUFBQSxDQUFBLEVBQUMsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGNBQWEsQ0FBQyxDQUFDO0FBQ2hDLEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLFNBQVEsQ0FBQyxDQUFDO0FBQzdCLEFBQUksRUFBQSxDQUFBLFdBQVUsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLGVBQWMsQ0FBQyxDQUFDO0FBRTFDLE9BQVMseUJBQXVCLENBQUUsQUFBRCxDQUFHO0FBQ2hDLEtBQUcsZ0JBQWdCLEVBQUksSUFBSSxPQUFLLEFBQUMsRUFBQyxDQUFDO0FBQ25DLEtBQUcsV0FBVyxFQUFJLElBQUksT0FBSyxBQUFDLEVBQUMsQ0FBQztBQUM5QixLQUFHLGVBQWUsRUFBSSxJQUFJLG9CQUFrQixBQUFDLEVBQUMsQ0FBQztBQUMvQyxLQUFHLGNBQWMsRUFBSSxLQUFHLENBQUM7QUFDekIsS0FBRyxpQkFBaUIsRUFBSSxJQUFJLE9BQUssQUFBQyxFQUFDLENBQUM7QUFDcEMsS0FBRyxnQkFBZ0IsRUFBSSxFQUFBLENBQUM7QUFDeEIsS0FBRyxXQUFXLEVBQUksQ0FBQSxJQUFHLGlCQUFpQixBQUFDLEVBQUMsQ0FBQztBQUM3QztBQUFBLEFBRUEsR0FBRyxTQUFTLEFBQUMsQ0FBQyx3QkFBdUIsQ0FBRyxhQUFXLENBQUMsQ0FBQztBQUVyRCxLQUFLLGlCQUFpQixBQUFDLENBQ25CLHdCQUF1QixVQUFVLENBQ2pDO0FBQ0ksTUFBSSxDQUFHLEVBQ0gsR0FBRSxDQUFHLFVBQVUsQUFBRCxDQUFHO0FBQ2IsV0FBTyxDQUFBLElBQUcsV0FBVyxhQUFhLENBQUM7SUFDdkMsQ0FDSjtBQUNBLFNBQU8sQ0FBRyxFQUNOLEdBQUUsQ0FBRyxVQUFVLEFBQUQsQ0FBRztBQUNiLFdBQU8sRUFBQyxJQUFHLFdBQVcsWUFBWSxDQUFDO0lBQ3ZDLENBQ0o7QUFBQSxBQUNKLENBQ0osQ0FBQTtBQUVBLHVCQUF1QixVQUFVLGlCQUFpQixFQUFJLFVBQVUsQUFBRCxDQUFHO0FBQzlELEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixPQUFPLElBQUksVUFBUSxBQUFDLENBQ2hCLENBQ0ksZUFBYyxDQUFHLFVBQVUsT0FBTSxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsWUFBVyxDQUFHO0FBQzlELFlBQU0sU0FBUyxnQkFBZ0IsS0FBSyxBQUFDLENBQUMsT0FBTSxNQUFNLENBQUcsUUFBTSxDQUFHLE9BQUssQ0FBRyxPQUFLLENBQUcsYUFBVyxDQUFDLENBQUM7SUFDL0YsQ0FDSixDQUNBLFVBQVUsRUFBQyxDQUFHO0FBQ1YsU0FBTyxDQUFBLElBQUcsa0JBQWtCLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQTtFQUNwQyxDQUFDLENBQUM7QUFDVixDQUFBO0FBRUEsdUJBQXVCLFVBQVUsdUJBQXVCLEVBQUksVUFBVSxRQUFPLENBQUc7QUFDNUUsS0FBRyxpQkFBaUIsSUFBSSxBQUFDLENBQUMsUUFBTyxHQUFHLENBQUcsU0FBTyxDQUFDLENBQUM7QUFDaEQsS0FBSSxFQUFDLFVBQVUsQUFBQyxDQUFDLFFBQU8sQ0FBQztBQUFHLFdBQU8sNEJBQTRCLEFBQUMsRUFBQyxDQUFDO0FBQUEsQUFDdEUsQ0FBQztBQUVELHVCQUF1QixVQUFVLFdBQVcsRUFBSSxVQUFVLFlBQVcsQ0FBRztBQUNwRSxLQUFJLElBQUcsY0FBYztBQUFHLFFBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyxpQ0FBZ0MsQ0FBQyxDQUFDO0FBQUEsQUFDMUUsS0FBSSxDQUFDLEVBQUMsU0FBUyxBQUFDLENBQUMsWUFBVyxDQUFDO0FBQUcsUUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLG1EQUFrRCxDQUFDLENBQUM7QUFBQSxBQUV4RyxLQUFHLGNBQWMsRUFBSSxhQUFXLENBQUM7QUFDakMsS0FBRyxZQUFZLEFBQUMsQ0FBQyxJQUFHLENBQUcsYUFBVyxDQUFHLEVBQUMsRUFBQyxDQUFHLEVBQUEsQ0FBQyxDQUFDLENBQUM7QUFDakQsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLGdCQUFnQixFQUFJLFVBQVUsSUFBRyxDQUFHO0FBQ2pFLEtBQUcsV0FBVyxBQUFDLEVBQUMsQ0FBQztBQUVqQixBQUFJLElBQUEsQ0FBQSxJQUFHLEVBQUksS0FBRyxDQUFDO0FBRWYsQUFBSSxJQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsSUFBRyxnQkFBZ0IsQ0FBQztBQUNsQyxBQUFJLElBQUEsQ0FBQSxDQUFBLEVBQUksRUFBQyxFQUFDLENBQUcsUUFBTSxDQUFDLENBQUM7QUFFckIsS0FBSSxDQUFBLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFHO0FBQ2pCLEFBQUksTUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsU0FBUyxBQUFDLENBQUMsSUFBRyxjQUFjLEdBQUcsQ0FBQyxDQUFDO0FBQ2hELE9BQUcsUUFBUSxBQUFDLENBQ1IsU0FBVSxHQUFFLENBQUc7QUFDWCxTQUFJLEVBQUMsU0FBUyxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUc7QUFDbEIsV0FBRyxZQUFZLEFBQUMsQ0FBQyxJQUFHLGNBQWMsQ0FBRyxJQUFFLENBQUcsRUFBQSxDQUFDLENBQUM7QUFDNUMsWUFBSSxpQkFBaUIsSUFBSSxBQUFDLENBQUMsR0FBRSxHQUFHLENBQUMsQ0FBQztNQUN0QztBQUFBLElBQ0osQ0FBQyxDQUFDO0VBQ1YsS0FDSztBQUNELFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyx3Q0FBdUMsQ0FBQyxDQUFDO0VBQ2pFO0FBQUEsQUFFQSxPQUFPO0FBQ0gsU0FBSyxDQUFHLFFBQU07QUFDZCxPQUFHLENBQUcsQ0FBQSxJQUFHLGdCQUFnQjtBQUFBLEVBQzdCLENBQUM7QUFDTCxDQUFBO0FBRUEsdUJBQXVCLFVBQVUsa0JBQWtCLEVBQUksVUFBVSxXQUFVLENBQUc7QUFDMUUsS0FBRyxXQUFXLEFBQUMsRUFBQyxDQUFDO0FBRWpCLEtBQUksV0FBVSxHQUFLLENBQUEsRUFBQyxRQUFRLEFBQUMsQ0FBQyxXQUFVLE9BQU8sQ0FBQyxDQUFBLEVBQUssQ0FBQSxFQUFDLFFBQVEsQUFBQyxDQUFDLFdBQVUsS0FBSyxDQUFDLENBQUc7QUFDL0UsQUFBSSxNQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsSUFBRyxTQUFTLEFBQUMsQ0FBQyxJQUFHLGNBQWMsR0FBRyxDQUFDLENBQUM7QUFFaEQsUUFBUyxHQUFBLENBQUEsRUFBQyxFQUFJLENBQUEsV0FBVSxPQUFPLENBQUcsQ0FBQSxFQUFDLEdBQUssQ0FBQSxXQUFVLEtBQUssQ0FBRyxDQUFBLEVBQUMsRUFBRSxDQUFHO0FBQzVELEFBQUksUUFBQSxDQUFBLEdBQUUsRUFBSSxDQUFBLEVBQUMsU0FBUyxBQUFDLEVBQUMsQ0FBQztBQUN2QixTQUFHLGlCQUFpQixPQUFPLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0FBQztBQUNqQyxVQUFJLGlCQUFpQixPQUFPLEFBQUMsQ0FBQyxHQUFFLENBQUMsQ0FBQztJQUN0QztBQUFBLEVBQ0osS0FDSztBQUNELFFBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxrRUFBaUUsQ0FBQyxDQUFDO0VBQzNGO0FBQUEsQUFFQSxLQUFHLGdCQUFnQixFQUFJLENBQUEsV0FBVSxPQUFPLENBQUM7QUFDN0MsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLFdBQVcsRUFBSSxVQUFVLEFBQUQsQ0FBRztBQUN4RCxLQUFJLENBQUMsSUFBRyxjQUFjO0FBQUcsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLDZCQUE0QixDQUFDLENBQUM7QUFBQSxBQUMzRSxDQUFBO0FBRUEsdUJBQXVCLFVBQVUsWUFBWSxFQUFJLFVBQVUsTUFBSyxDQUFHLENBQUEsUUFBTyxDQUFHLENBQUEsU0FBUSxDQUFHO0FBQ3BGLEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFFZixLQUFJLFFBQU8sR0FBRyxJQUFNLEtBQUcsQ0FBRztBQUN0QixXQUFPLEdBQUcsRUFBSSxDQUFBLENBQUMsU0FBUSxHQUFHLEVBQUUsQ0FBQyxTQUFTLEFBQUMsRUFBQyxDQUFDO0VBQzdDLEtBQ0ssS0FBSSxRQUFPLEdBQUcsR0FBSyxDQUFBLENBQUMsU0FBUSxHQUFHLEVBQUUsQ0FBQyxTQUFTLEFBQUMsRUFBQyxDQUFHO0FBQ2pELFFBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyxXQUFVLEVBQUksQ0FBQSxRQUFPLEdBQUcsQ0FBQSxDQUFJLG1GQUFpRixDQUFDLENBQUM7RUFDbkk7QUFBQSxBQUNBLEtBQUcsZ0JBQWdCLEVBQUksQ0FBQSxTQUFRLEdBQUcsQ0FBQztBQUNuQyxBQUFJLElBQUEsQ0FBQSxLQUFJLEVBQUksQ0FBQSxJQUFHLFNBQVMsQUFBQyxDQUFDLFFBQU8sR0FBRyxDQUFDLENBQUM7QUFDdEMsTUFBSSxpQkFBaUIsRUFBSSxDQUFBLE1BQUssRUFBSSxDQUFBLE1BQUssR0FBRyxFQUFJLEtBQUcsQ0FBQztBQUNsRCxLQUFHLHVCQUF1QixBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFFckMsU0FBTyxzQkFBc0IsQUFBQyxDQUMxQixTQUFVLEtBQUksQ0FBRztBQUNiLE9BQUcsWUFBWSxBQUFDLENBQUMsUUFBTyxDQUFHLE1BQUksQ0FBRyxVQUFRLENBQUMsQ0FBQztBQUM1QyxRQUFJLGlCQUFpQixJQUFJLEFBQUMsQ0FBQyxLQUFJLEdBQUcsQ0FBQyxDQUFDO0VBQ3hDLENBQUMsQ0FBQztBQUNWLENBQUE7QUFFQSx1QkFBdUIsVUFBVSxTQUFTLEVBQUksVUFBVSxFQUFDLENBQUc7QUFDeEQsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUVmLEFBQUksSUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsZ0JBQWdCLElBQUksQUFBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDO0FBQ3hDLEtBQUksRUFBQyxVQUFVLEFBQUMsQ0FBQyxLQUFJLENBQUMsQ0FBRztBQUNyQixRQUFJLEVBQUksSUFBSSx1QkFBcUIsQUFBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDO0FBQ3RDLFFBQUksR0FBRyxBQUFDLENBQ0osS0FBSSxlQUFlLElBQUksQ0FBRyxVQUFVLEFBQUQsQ0FBRztBQUNsQyxBQUFJLFFBQUEsQ0FBQSxRQUFPLEVBQUksQ0FBQSxJQUFHLGlCQUFpQixJQUFJLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztBQUM1QyxTQUFJLENBQUMsUUFBTztBQUFHLGVBQU8sRUFBSSxFQUFDLEVBQUMsQ0FBRyxHQUFDLENBQUMsQ0FBQztBQUFBLEFBQ2xDLFNBQUcsS0FBSyxBQUFDLENBQUMsS0FBSSxlQUFlLElBQUksQ0FBRyxTQUFPLENBQUMsQ0FBQztJQUNqRCxDQUFDLENBQUM7QUFDTixRQUFJLEdBQUcsQUFBQyxDQUNKLEtBQUksZUFBZSxJQUFJLENBQUcsVUFBVSxNQUFLLENBQUcsQ0FBQSxNQUFLLENBQUc7QUFDaEQsQUFBSSxRQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsSUFBRyxpQkFBaUIsSUFBSSxBQUFDLENBQUMsRUFBQyxDQUFDLENBQUM7QUFDNUMsU0FBSSxDQUFDLFFBQU87QUFBRyxlQUFPLEVBQUksRUFBQyxFQUFDLENBQUcsR0FBQyxDQUFDLENBQUM7QUFBQSxBQUNsQyxTQUFHLEtBQUssQUFBQyxDQUFDLEtBQUksZUFBZSxJQUFJLENBQUcsU0FBTyxDQUFHLE9BQUssQ0FBRyxPQUFLLENBQUMsQ0FBQztJQUNqRSxDQUFDLENBQUM7QUFDTixPQUFHLGdCQUFnQixJQUFJLEFBQUMsQ0FBQyxFQUFDLENBQUcsTUFBSSxDQUFDLENBQUM7RUFDdkM7QUFBQSxBQUNBLE9BQU8sTUFBSSxDQUFDO0FBQ2hCLENBQUE7QUFFQSx1QkFBdUIsVUFBVSxrQkFBa0IsRUFBSSxVQUFVLFVBQVMsQ0FBRztBQUN6RSxBQUFJLElBQUEsQ0FBQSxRQUFPLEVBQUksQ0FBQSxJQUFHLGlCQUFpQixJQUFJLEFBQUMsQ0FBQyxVQUFTLENBQUMsQ0FBQztBQUNwRCxLQUFJLENBQUMsUUFBTztBQUFHLFFBQU0sSUFBSSxDQUFBLE1BQUsscUJBQXFCLEFBQUMsQ0FBQyxrQkFBaUIsRUFBSSxXQUFTLENBQUEsQ0FBSSxlQUFhLENBQUMsQ0FBQztBQUFBLEFBQ3RHLE9BQU8sU0FBTyxDQUFDO0FBQ25CLENBQUE7QUFFQSx1QkFBdUIsVUFBVSxlQUFlLEVBQUksVUFBVSxVQUFTLENBQUcsQ0FBQSxJQUFHLENBQUcsQ0FBQSxXQUFVLENBQUc7QUFDekYsS0FBRyxpQkFBaUIsQUFBQyxDQUNqQjtBQUNJLE9BQUcsQ0FBRyxLQUFHO0FBQ1QsYUFBUyxDQUFHLFdBQVM7QUFDckIsWUFBUSxDQUFHLENBQUEsR0FBSSxLQUFHLEFBQUMsRUFBQyxRQUFRLEFBQUMsRUFBQztBQUM5QixjQUFVLENBQUcsWUFBVTtBQUFBLEVBQzNCLENBQUMsQ0FBQztBQUNOLE9BQU8sS0FBRyxDQUFDO0FBQ2YsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLGlCQUFpQixFQUFJLFVBQVUsUUFBTyxDQUFHO0FBQ3RFLEtBQUksSUFBRyxXQUFXLElBQUksQUFBQyxDQUFDLFFBQU8sS0FBSyxDQUFDO0FBQUcsUUFBTSxJQUFJLENBQUEsTUFBSyxxQkFBcUIsQUFBQyxDQUFDLFlBQVcsRUFBSSxDQUFBLFFBQU8sS0FBSyxDQUFBLENBQUksb0JBQWtCLENBQUMsQ0FBQztBQUFBLEFBQ2pJLEtBQUcsV0FBVyxJQUFJLEFBQUMsQ0FBQyxRQUFPLEtBQUssQ0FBRyxTQUFPLENBQUMsQ0FBQztBQUNoRCxDQUFBO0FBRUEsdUJBQXVCLFVBQVUsaUJBQWlCLEVBQUksVUFBVSxJQUFHLENBQUc7QUFDbEUsT0FBTyxDQUFBLElBQUcsV0FBVyxZQUFZLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztBQUM1QyxDQUFBO0FBRUEsdUJBQXVCLFVBQVUscUJBQXFCLEVBQUksVUFBVSxJQUFHLENBQUcsQ0FBQSxlQUFjLENBQUc7QUFDdkYsQUFBSSxJQUFBLENBQUEsRUFBQyxFQUFJLENBQUEsSUFBRyxXQUFXLElBQUksQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0FBQ2xDLEtBQUksRUFBQyxVQUFVLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQSxFQUFLLGdCQUFjO0FBQUcsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLFlBQVcsRUFBSSxLQUFHLENBQUEsQ0FBSSxlQUFhLENBQUMsQ0FBQztBQUFBLEFBQzlGLE9BQU8sQ0FBQSxFQUFDLEVBQUksQ0FBQSxFQUFDLFVBQVUsRUFBSSxLQUFHLENBQUM7QUFDbkMsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLGVBQWUsRUFBSSxVQUFVLElBQUcsQ0FBRztBQUNoRSxLQUFHLFdBQVcsT0FBTyxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFDaEMsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLHNCQUFzQixFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsSUFBRyxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQ3BHLEFBQUksSUFBQSxDQUFBLEVBQUMsRUFBSSxDQUFBLElBQUcsV0FBVyxJQUFJLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztBQUNsQyxLQUFJLEVBQUMsVUFBVSxBQUFDLENBQUMsRUFBQyxDQUFDLENBQUc7QUFDbEIsUUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLFlBQVcsRUFBSSxLQUFHLENBQUEsQ0FBSSxrREFBZ0QsQ0FBQSxDQUFJLE9BQUssQ0FBQSxDQUFJLElBQUUsQ0FBQyxDQUFDO0VBQzNHO0FBQUEsQUFDQSxLQUFHLGtCQUFrQixBQUFDLENBQUMsV0FBVSxDQUFHLEdBQUMsQ0FBRyxPQUFLLENBQUcsT0FBSyxDQUFHLENBQUEsTUFBSyxHQUFLLENBQUEsS0FBSSxlQUFlLEtBQUssQ0FBQyxDQUFDO0FBQ2hHLENBQUE7QUFFQSx1QkFBdUIsVUFBVSx1QkFBdUIsRUFBSSxVQUFVLFdBQVUsQ0FBRyxDQUFBLElBQUcsQ0FBRyxDQUFBLE1BQUssQ0FBRyxDQUFBLE1BQUssQ0FBRztBQUNyRyxBQUFJLElBQUEsQ0FBQSxFQUFDLEVBQUksQ0FBQSxJQUFHLFdBQVcsSUFBSSxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFDbEMsS0FBRyxlQUFlLFFBQVEsQUFBQyxDQUFDLElBQUcsQ0FBRyxPQUFLLENBQUcsT0FBSyxDQUFDLENBQUM7QUFDckQsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLHVCQUF1QixFQUFJLFVBQVUsSUFBRyxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQ3hGLEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixBQUFJLElBQUEsQ0FBQSxFQUFDLEVBQUksQ0FBQSxJQUFHLFdBQVcsSUFBSSxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFDbEMsS0FBSSxFQUFDLFVBQVUsQUFBQyxDQUFDLEVBQUMsQ0FBQztBQUFHLFFBQU0sSUFBSSxDQUFBLE1BQUsscUJBQXFCLEFBQUMsQ0FBQyx5RUFBd0UsRUFBSSxDQUFBLE9BQU0sS0FBSyxDQUFBLENBQUksb0JBQWtCLENBQUMsQ0FBQztBQUFBLEFBQzNLLEtBQUcsa0JBQWtCLEFBQUMsQ0FBQyxHQUFJLFlBQVUsQUFBQyxDQUFDLElBQUcsQ0FBRyxDQUFBLEVBQUMsV0FBVyxDQUFDLENBQUcsR0FBQyxDQUFHLE9BQUssQ0FBRyxPQUFLLENBQUMsQ0FBQztBQUNwRixDQUFBO0FBRUEsdUJBQXVCLFVBQVUsMkJBQTJCLEVBQUksVUFBVSxBQUFELENBQUc7QUFDeEUsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUNmLEFBQUksSUFBQSxDQUFBLE9BQU0sRUFBSSxDQUFBLElBQUcsZUFBZSxRQUFRLEFBQUMsRUFBQyxDQUFDO0FBQzNDLEtBQUksT0FBTSxDQUFHO0FBQ1QsQUFBSSxNQUFBLENBQUEsRUFBQyxFQUFJLENBQUEsSUFBRyxXQUFXLElBQUksQUFBQyxDQUFDLE9BQU0sS0FBSyxDQUFDLENBQUM7QUFDMUMsT0FBSSxFQUFDLFVBQVUsQUFBQyxDQUFDLEVBQUMsQ0FBQztBQUFHLFVBQU0sSUFBSSxDQUFBLE1BQUsscUJBQXFCLEFBQUMsQ0FBQyx5RUFBd0UsRUFBSSxDQUFBLE9BQU0sS0FBSyxDQUFBLENBQUksb0JBQWtCLENBQUMsQ0FBQztBQUFBLEFBQzNLLE9BQUcsa0JBQWtCLEFBQUMsQ0FBQyxHQUFJLFlBQVUsQUFBQyxDQUFDLElBQUcsQ0FBRyxDQUFBLEVBQUMsV0FBVyxDQUFDLENBQUcsR0FBQyxDQUFHLENBQUEsT0FBTSxPQUFPLENBQUcsQ0FBQSxPQUFNLE9BQU8sQ0FBQyxDQUFDO0FBQ2hHLFNBQU8sS0FBRyxDQUFDO0VBQ2Y7QUFBQSxBQUNBLE9BQU8sTUFBSSxDQUFDO0FBQ2hCLENBQUE7QUFFQSx1QkFBdUIsVUFBVSxrQkFBa0IsRUFBSSxVQUFVLFdBQVUsQ0FBRyxDQUFBLFFBQU8sQ0FBRyxDQUFBLE1BQUssQ0FBRyxDQUFBLE1BQUssQ0FBRyxDQUFBLFFBQU8sQ0FBRztBQUM5RyxBQUFJLElBQUEsQ0FBQSxLQUFJLEVBQUksQ0FBQSxXQUFVLE1BQU0sQ0FBQztBQUM3QixLQUFJLENBQUMsUUFBTztBQUFHLE9BQUcsV0FBVyxPQUFPLEFBQUMsQ0FBQyxRQUFPLEtBQUssQ0FBQyxDQUFDO0FBQUEsQUFDcEQsS0FBSSxFQUFDLFVBQVUsQUFBQyxDQUFDLEtBQUksSUFBSSxBQUFDLENBQUMsUUFBTyxZQUFZLENBQUMsQ0FBQyxDQUFHO0FBQy9DLFFBQU0sSUFBSSxDQUFBLE1BQUsscUJBQXFCLEFBQUMsQ0FBQyxjQUFhLEVBQUksQ0FBQSxRQUFPLEtBQUssQ0FBQSxDQUFJLGVBQWEsQ0FBQSxDQUFJLENBQUEsUUFBTyxZQUFZLENBQUEsQ0FBSSx5Q0FBdUMsQ0FBQyxDQUFDO0VBQzVKO0FBQUEsQUFDQSxNQUFJLElBQUksQUFBQyxDQUFDLFFBQU8sWUFBWSxDQUFDLEtBQUssQUFBQyxDQUFDLEtBQUksQ0FBRyxZQUFVLENBQUcsT0FBSyxDQUFHLE9BQUssQ0FBRyxTQUFPLENBQUMsQ0FBQztBQUN0RixDQUFBO0FBRUEsdUJBQXVCLFVBQVUsZ0JBQWdCLEVBQUksVUFBVSxXQUFVLENBQUc7QUFDeEUsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUNmLEFBQUksSUFBQSxDQUFBLE1BQUssRUFBSSxJQUFJLE9BQUssQUFBQyxFQUFDLENBQUM7QUFDekIsS0FBRyxRQUFRLEFBQUMsQ0FBQyxXQUFVLENBQ25CLFVBQVUsRUFBQyxDQUFHO0FBQ1YsT0FBRyxlQUFlLEFBQUMsQ0FBQyxNQUFLLENBQUcsR0FBQyxDQUFDLENBQUM7RUFDbkMsQ0FBQyxDQUFDO0FBQ04sS0FBRyxXQUFXLGFBQWEsQUFBQyxDQUFDLFNBQVUsRUFBQyxDQUFHO0FBQ3ZDLE9BQUksTUFBSyxPQUFPLEFBQUMsQ0FBQyxFQUFDLFdBQVcsQ0FBQyxDQUFHO0FBQzlCLFNBQUcsV0FBVyxPQUFPLEFBQUMsQ0FBQyxFQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25DO0FBQUEsRUFDSixDQUFDLENBQUM7QUFDTixDQUFBO0FBRUEsdUJBQXVCLFVBQVUsZUFBZSxFQUFJLFVBQVUsTUFBSyxDQUFHLENBQUEsVUFBUyxDQUFHO0FBQzlFLEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxLQUFHLENBQUM7QUFDZixPQUFLLElBQUksQUFBQyxDQUFDLFVBQVMsQ0FBQyxDQUFDO0FBQ3RCLEFBQUksSUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsU0FBUyxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDckMsTUFBSSxpQkFBaUIsUUFBUSxBQUFDLENBQzFCLFNBQVUsRUFBQyxDQUFHO0FBQ1YsT0FBRyxlQUFlLEFBQUMsQ0FBQyxNQUFLLENBQUcsR0FBQyxDQUFDLENBQUM7RUFDbkMsQ0FBQyxDQUFDO0FBQ04sTUFBSSxZQUFZLEFBQUMsQ0FBQyxLQUFJLGVBQWUsT0FBTyxDQUFDLENBQUM7QUFDbEQsQ0FBQTtBQUVBLHVCQUF1QixVQUFVLHNCQUFzQixFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsVUFBUyxDQUFHO0FBQzFGLEtBQUcsV0FBVyxnQkFBZ0IsQUFBQyxDQUFDLFdBQVUsV0FBVyxDQUFHLFdBQVMsQ0FBQyxDQUFDO0FBQ3ZFLENBQUE7QUFHQSx1QkFBdUIsVUFBVSxzQkFBc0IsRUFBSSxVQUFVLFVBQVMsQ0FBRyxDQUFBLGFBQVksQ0FBRztBQUM1RixLQUFJLFVBQVMsR0FBSyxFQUFDLENBQUEsV0FBVyxBQUFDLENBQUMsVUFBUyxPQUFPLENBQUM7QUFBRyxRQUFNLElBQUksTUFBSSxBQUFDLENBQUMsNENBQTJDLENBQUMsQ0FBQztBQUFBLEFBRTdHLElBQUEsQ0FBQSxjQUFhLEVBQUksSUFBSSxPQUFLLEFBQUMsRUFBQyxDQUFDO0FBQ2pDLEtBQUcsZ0JBQWdCLGFBQWEsQUFBQyxDQUFDLFNBQVUsQ0FBQSxDQUFHO0FBQzNDLGlCQUFhLElBQUksQUFBQyxDQUFDLENBQUEsV0FBVyxDQUFHLENBQUEsQ0FBQSxPQUFPLEFBQUMsRUFBQyxDQUFDLENBQUM7RUFDaEQsQ0FBQyxDQUFDO0FBRUYsQUFBSSxJQUFBLENBQUEsdUJBQXNCLEVBQUksQ0FBQSxJQUFHLFdBQVcsU0FBUyxBQUFDLENBQUMsYUFBWSxDQUFDLENBQUM7QUFFckUsQUFBSSxJQUFBLENBQUEsVUFBUyxDQUFDO0FBQ2QsS0FBSSxVQUFTLENBQUc7QUFDWixhQUFTLEVBQUksQ0FBQSxVQUFTLE9BQU8sQUFBQyxDQUFDO0FBQzNCLG1CQUFhLENBQUcsZUFBYTtBQUM3QixjQUFRLENBQUcsQ0FBQSxJQUFHLFdBQVc7QUFDekIsVUFBSSxDQUFHLENBQUEsdUJBQXNCLE1BQU07QUFBQSxJQUN2QyxDQUFDLENBQUM7RUFDTixLQUNLO0FBQ0QsYUFBUyxFQUFJO0FBQ1QsbUJBQWEsQ0FBRyxDQUFBLGNBQWEsaUJBQWlCLEFBQUMsRUFBQztBQUNoRCxjQUFRLENBQUcsQ0FBQSxJQUFHLFdBQVcsaUJBQWlCLEFBQUMsRUFBQztBQUM1QyxVQUFJLENBQUcsQ0FBQSx1QkFBc0IsTUFBTTtBQUFBLElBQ3ZDLENBQUE7RUFDSjtBQUFBLEFBRUEsT0FBTztBQUNILFFBQUksQ0FBRyxXQUFTO0FBQ2hCLHFCQUFpQixDQUFHLENBQUEsdUJBQXNCLG1CQUFtQjtBQUFBLEVBQ2pFLENBQUM7QUFDTCxDQUFBO0FBRUEsdUJBQXVCLFVBQVUsU0FBUyxFQUFJLFVBQVUsVUFBUyxDQUFHLENBQUEsSUFBRyxDQUFHO0FBQ3RFLEtBQUksVUFBUyxHQUFLLEVBQUMsQ0FBQSxXQUFXLEFBQUMsQ0FBQyxVQUFTLFNBQVMsQ0FBQztBQUFHLFFBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyw0Q0FBMkMsQ0FBQyxDQUFDO0FBQUEsQUFDbkgsS0FBSSxDQUFDLENBQUEsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFDO0FBQUcsUUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLG1DQUFrQyxDQUFDLENBQUM7QUFBQSxBQUUvRSxLQUFJLFVBQVMsQ0FBRztBQUNaLE9BQUcsRUFBSSxDQUFBLFVBQVMsU0FBUyxBQUFDLENBQUMsSUFBRyxDQUFDLENBQUM7QUFDaEMsT0FBSSxDQUFDLENBQUMsSUFBRyxlQUFlLFdBQWEsT0FBSyxDQUFDO0FBQUcsVUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLDZFQUE0RSxDQUFDLENBQUM7QUFBQSxBQUNoSixPQUFJLENBQUMsQ0FBQyxJQUFHLFVBQVUsV0FBYSxPQUFLLENBQUM7QUFBRyxVQUFNLElBQUksVUFBUSxBQUFDLENBQUMsd0VBQXVFLENBQUMsQ0FBQztBQUFBLEVBQzFJLEtBQ0s7QUFDRCxPQUFJLENBQUMsSUFBRyxlQUFlO0FBQUcsVUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLG9FQUFtRSxDQUFDLENBQUM7QUFBQSxBQUNuSCxPQUFJLENBQUMsSUFBRyxVQUFVO0FBQUcsVUFBTSxJQUFJLFVBQVEsQUFBQyxDQUFDLCtEQUE4RCxDQUFDLENBQUM7QUFBQSxBQUVyRyxNQUFBLENBQUEsY0FBYSxFQUFJLElBQUksT0FBSyxBQUFDLEVBQUMsQ0FBQztBQUNqQyxpQkFBYSxxQkFBcUIsQUFBQyxDQUFDLElBQUcsZUFBZSxDQUFDLENBQUM7QUFDeEQsQUFBSSxNQUFBLENBQUEsU0FBUSxFQUFJLElBQUksT0FBSyxBQUFDLEVBQUMsQ0FBQztBQUM1QixZQUFRLHFCQUFxQixBQUFDLENBQUMsSUFBRyxVQUFVLENBQUMsQ0FBQztBQUM5QyxPQUFHLEVBQUk7QUFDSCxtQkFBYSxDQUFHLGVBQWE7QUFDN0IsY0FBUSxDQUFHLFVBQVE7QUFDbkIsVUFBSSxDQUFHLENBQUEsSUFBRyxNQUFNO0FBQUEsSUFDcEIsQ0FBQztFQUNMO0FBQUEsQUFFQSxLQUFHLGdCQUFnQixhQUFhLEFBQUMsQ0FBQyxTQUFVLENBQUEsQ0FBRztBQUMzQyxBQUFJLE1BQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxJQUFHLGVBQWUsSUFBSSxBQUFDLENBQUMsQ0FBQSxXQUFXLENBQUMsQ0FBQztBQUNsRCxPQUFJLENBQUEsWUFBWSxBQUFDLENBQUMsTUFBSyxDQUFDO0FBQUcsVUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLFdBQVUsRUFBSSxDQUFBLENBQUEsV0FBVyxDQUFBLENBQUksb0JBQWtCLENBQUMsQ0FBQztBQUFBLEFBQzVGLElBQUEsU0FBUyxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7RUFDdEIsQ0FBQyxDQUFDO0FBRUYsS0FBRyxXQUFXLEVBQUksQ0FBQSxJQUFHLFVBQVUsQ0FBQztBQUNoQyxLQUFHLFdBQVcsU0FBUyxBQUFDLENBQUMsSUFBRyxNQUFNLENBQUMsQ0FBQztBQUN4QyxDQUFBO0FBR0EsS0FBSyxRQUFRLEVBQUkseUJBQXVCLENBQUM7QUFBQSIsImZpbGUiOiJhY3Rpdml0aWVzL2FjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJDOi9HSVQvd29ya2Zsb3ctNC1ub2RlL2xpYi8iLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgQWN0aXZpdHlFeGVjdXRpb25TdGF0ZSA9IHJlcXVpcmUoXCIuL2FjdGl2aXR5RXhlY3V0aW9uU3RhdGVcIik7XHJcbnZhciBSZXN1bWVCb29rbWFya1F1ZXVlID0gcmVxdWlyZShcIi4vcmVzdW1lQm9va21hcmtRdWV1ZVwiKTtcclxudmFyIGVudW1zID0gcmVxdWlyZShcIi4uL2NvbW1vbi9lbnVtc1wiKTtcclxudmFyIGVycm9ycyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZXJyb3JzXCIpO1xyXG52YXIgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xyXG52YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyO1xyXG52YXIgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XHJcbnZhciBndWlkcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vZ3VpZHNcIik7XHJcbnZhciBTY29wZVRyZWUgPSByZXF1aXJlKFwiLi9zY29wZVRyZWVcIik7XHJcbnZhciBTdHJNYXAgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5jb2xsZWN0aW9ucy5TdHJNYXA7XHJcbnZhciBTdHJTZXQgPSByZXF1aXJlKFwiYmFja3BhY2stbm9kZVwiKS5jb2xsZWN0aW9ucy5TdHJTZXQ7XHJcbnZhciBpcyA9IHJlcXVpcmUoXCIuLi9jb21tb24vaXNcIik7XHJcbnZhciBmYXN0ID0gcmVxdWlyZShcImZhc3QuanNcIik7XHJcbnZhciBDYWxsQ29udGV4dCA9IHJlcXVpcmUoXCIuL2NhbGxDb250ZXh0XCIpO1xyXG5cclxuZnVuY3Rpb24gQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0KCkge1xyXG4gICAgdGhpcy5fYWN0aXZpdHlTdGF0ZXMgPSBuZXcgU3RyTWFwKCk7XHJcbiAgICB0aGlzLl9ib29rbWFya3MgPSBuZXcgU3RyTWFwKCk7XHJcbiAgICB0aGlzLl9yZXN1bWVCTVF1ZXVlID0gbmV3IFJlc3VtZUJvb2ttYXJrUXVldWUoKTtcclxuICAgIHRoaXMuX3Jvb3RBY3Rpdml0eSA9IG51bGw7XHJcbiAgICB0aGlzLl9rbm93bkFjdGl2aXRpZXMgPSBuZXcgU3RyTWFwKCk7XHJcbiAgICB0aGlzLl9uZXh0QWN0aXZpdHlJZCA9IDA7XHJcbiAgICB0aGlzLl9zY29wZVRyZWUgPSB0aGlzLl9jcmVhdGVTY29wZVRyZWUoKTtcclxufVxyXG5cclxudXRpbC5pbmhlcml0cyhBY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQsIEV2ZW50RW1pdHRlcik7XHJcblxyXG5PYmplY3QuZGVmaW5lUHJvcGVydGllcyhcclxuICAgIEFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUsXHJcbiAgICB7XHJcbiAgICAgICAgc2NvcGU6IHtcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fc2NvcGVUcmVlLmN1cnJlbnRTY29wZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgaGFzU2NvcGU6IHtcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIXRoaXMuX3Njb3BlVHJlZS5pc09uSW5pdGlhbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuKVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5fY3JlYXRlU2NvcGVUcmVlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgcmV0dXJuIG5ldyBTY29wZVRyZWUoXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICByZXN1bHRDb2xsZWN0ZWQ6IGZ1bmN0aW9uIChjb250ZXh0LCByZWFzb24sIHJlc3VsdCwgYm9va21hcmtOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBjb250ZXh0LmFjdGl2aXR5LnJlc3VsdENvbGxlY3RlZC5jYWxsKGNvbnRleHQuc2NvcGUsIGNvbnRleHQsIHJlYXNvbiwgcmVzdWx0LCBib29rbWFya05hbWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBmdW5jdGlvbiAoaWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2dldEtub3duQWN0aXZpdHkoaWQpXHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuX3JlZ2lzdGVyS25vd25BY3Rpdml0eSA9IGZ1bmN0aW9uIChhY3Rpdml0eSkge1xyXG4gICAgdGhpcy5fa25vd25BY3Rpdml0aWVzLmFkZChhY3Rpdml0eS5pZCwgYWN0aXZpdHkpO1xyXG4gICAgaWYgKGlzLmNvbXBvc2l0ZShhY3Rpdml0eSkpIGFjdGl2aXR5LmVuc3VyZUltcGxlbWVudGF0aW9uQ3JlYXRlZCgpO1xyXG59O1xyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5pbml0aWFsaXplID0gZnVuY3Rpb24gKHJvb3RBY3Rpdml0eSkge1xyXG4gICAgaWYgKHRoaXMuX3Jvb3RBY3Rpdml0eSkgdGhyb3cgbmV3IEVycm9yKFwiQ29udGV4dCBpcyBhbHJlYWR5IGluaXRpYWxpemVkLlwiKTtcclxuICAgIGlmICghaXMuYWN0aXZpdHkocm9vdEFjdGl2aXR5KSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFyZ3VtZW50ICdyb290QWN0aXZpdHknIHZhbHVlIGlzIG5vdCBhbiBhY3Rpdml0eS5cIik7XHJcblxyXG4gICAgdGhpcy5fcm9vdEFjdGl2aXR5ID0gcm9vdEFjdGl2aXR5O1xyXG4gICAgdGhpcy5faW5pdGlhbGl6ZShudWxsLCByb290QWN0aXZpdHksIHtpZDogMH0pO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLmFwcGVuZFRvQ29udGV4dCA9IGZ1bmN0aW9uIChhcmdzKSB7XHJcbiAgICB0aGlzLl9jaGVja0luaXQoKTtcclxuXHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgdmFyIGN1cnJNYXggPSBzZWxmLl9uZXh0QWN0aXZpdHlJZDtcclxuICAgIHZhciBjID0ge2lkOiBjdXJyTWF4fTtcclxuXHJcbiAgICBpZiAoXy5pc0FycmF5KGFyZ3MpKSB7XHJcbiAgICAgICAgdmFyIHN0YXRlID0gc2VsZi5nZXRTdGF0ZShzZWxmLl9yb290QWN0aXZpdHkuaWQpO1xyXG4gICAgICAgIGFyZ3MuZm9yRWFjaChcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGFyZykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGlzLmFjdGl2aXR5KGFyZykpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLl9pbml0aWFsaXplKHNlbGYuX3Jvb3RBY3Rpdml0eSwgYXJnLCBjKTtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jaGlsZEFjdGl2aXR5SWRzLmFkZChhcmcuaWQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAnYXJncycgdmFsdWUgaXMgbm90IGFuIGFycmF5LlwiKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGZyb21JZDogY3Vyck1heCxcclxuICAgICAgICB0b0lkOiB0aGlzLl9uZXh0QWN0aXZpdHlJZFxyXG4gICAgfTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5yZW1vdmVGcm9tQ29udGV4dCA9IGZ1bmN0aW9uIChyZW1vdmVUb2tlbikge1xyXG4gICAgdGhpcy5fY2hlY2tJbml0KCk7XHJcblxyXG4gICAgaWYgKHJlbW92ZVRva2VuICYmIGlzLmRlZmluZWQocmVtb3ZlVG9rZW4uZnJvbUlkKSAmJiBpcy5kZWZpbmVkKHJlbW92ZVRva2VuLnRvSWQpKSB7XHJcbiAgICAgICAgdmFyIHN0YXRlID0gdGhpcy5nZXRTdGF0ZSh0aGlzLl9yb290QWN0aXZpdHkuaWQpO1xyXG5cclxuICAgICAgICBmb3IgKHZhciBpZCA9IHJlbW92ZVRva2VuLmZyb21JZDsgaWQgPD0gcmVtb3ZlVG9rZW4udG9JZDsgaWQrKykge1xyXG4gICAgICAgICAgICB2YXIgc2lkID0gaWQudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgdGhpcy5fa25vd25BY3Rpdml0aWVzLnJlbW92ZShzaWQpO1xyXG4gICAgICAgICAgICBzdGF0ZS5jaGlsZEFjdGl2aXR5SWRzLnJlbW92ZShzaWQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAncmVtb3ZlVG9rZW4nIHZhbHVlIGlzIG5vdCBhIHZhbGlkIHJlbW92ZSB0b2tlbiBvYmplY3QuXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX25leHRBY3Rpdml0eUlkID0gcmVtb3ZlVG9rZW4uZnJvbUlkO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLl9jaGVja0luaXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAoIXRoaXMuX3Jvb3RBY3Rpdml0eSkgdGhyb3cgbmV3IEVycm9yKFwiQ29udGV4dCBpcyBub3QgaW5pdGlhbGl6ZWQuXCIpO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLl9pbml0aWFsaXplID0gZnVuY3Rpb24gKHBhcmVudCwgYWN0aXZpdHksIGlkQ291bnRlcikge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIGlmIChhY3Rpdml0eS5pZCA9PT0gbnVsbCkge1xyXG4gICAgICAgIGFjdGl2aXR5LmlkID0gKGlkQ291bnRlci5pZCsrKS50b1N0cmluZygpO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoYWN0aXZpdHkuaWQgIT0gKGlkQ291bnRlci5pZCsrKS50b1N0cmluZygpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQWN0aXZpdHkgXCIgKyBhY3Rpdml0eS5pZCArIFwiIGhhcyBiZWVuIGFzc2lnbmVkIHRvIGFuIG90aGVyIGNvbnRleHQgaW4gYSBkaWZmZXJlbnQgdHJlZSB3aGljaCBpcyBub3QgYWxsb3dlZC5cIik7XHJcbiAgICB9XHJcbiAgICBzZWxmLl9uZXh0QWN0aXZpdHlJZCA9IGlkQ291bnRlci5pZDtcclxuICAgIHZhciBzdGF0ZSA9IHNlbGYuZ2V0U3RhdGUoYWN0aXZpdHkuaWQpO1xyXG4gICAgc3RhdGUucGFyZW50QWN0aXZpdHlJZCA9IHBhcmVudCA/IHBhcmVudC5pZCA6IG51bGw7XHJcbiAgICBzZWxmLl9yZWdpc3Rlcktub3duQWN0aXZpdHkoYWN0aXZpdHkpO1xyXG5cclxuICAgIGFjdGl2aXR5LmZvckVhY2hJbW1lZGlhdGVDaGlsZChcclxuICAgICAgICBmdW5jdGlvbiAoY2hpbGQpIHtcclxuICAgICAgICAgICAgc2VsZi5faW5pdGlhbGl6ZShhY3Rpdml0eSwgY2hpbGQsIGlkQ291bnRlcik7XHJcbiAgICAgICAgICAgIHN0YXRlLmNoaWxkQWN0aXZpdHlJZHMuYWRkKGNoaWxkLmlkKTtcclxuICAgICAgICB9KTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIHZhciBzdGF0ZSA9IHNlbGYuX2FjdGl2aXR5U3RhdGVzLmdldChpZCk7XHJcbiAgICBpZiAoaXMudW5kZWZpbmVkKHN0YXRlKSkge1xyXG4gICAgICAgIHN0YXRlID0gbmV3IEFjdGl2aXR5RXhlY3V0aW9uU3RhdGUoaWQpO1xyXG4gICAgICAgIHN0YXRlLm9uKFxyXG4gICAgICAgICAgICBlbnVtcy5BY3Rpdml0eVN0YXRlcy5ydW4sIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBhY3Rpdml0eSA9IHNlbGYuX2tub3duQWN0aXZpdGllcy5nZXQoaWQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFhY3Rpdml0eSkgYWN0aXZpdHkgPSB7aWQ6IGlkfTtcclxuICAgICAgICAgICAgICAgIHNlbGYuZW1pdChlbnVtcy5BY3Rpdml0eVN0YXRlcy5ydW4sIGFjdGl2aXR5KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgc3RhdGUub24oXHJcbiAgICAgICAgICAgIGVudW1zLkFjdGl2aXR5U3RhdGVzLmVuZCwgZnVuY3Rpb24gKHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYWN0aXZpdHkgPSBzZWxmLl9rbm93bkFjdGl2aXRpZXMuZ2V0KGlkKTtcclxuICAgICAgICAgICAgICAgIGlmICghYWN0aXZpdHkpIGFjdGl2aXR5ID0ge2lkOiBpZH07XHJcbiAgICAgICAgICAgICAgICBzZWxmLmVtaXQoZW51bXMuQWN0aXZpdHlTdGF0ZXMuZW5kLCBhY3Rpdml0eSwgcmVhc29uLCByZXN1bHQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICBzZWxmLl9hY3Rpdml0eVN0YXRlcy5hZGQoaWQsIHN0YXRlKTtcclxuICAgIH1cclxuICAgIHJldHVybiBzdGF0ZTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5fZ2V0S25vd25BY3Rpdml0eSA9IGZ1bmN0aW9uIChhY3Rpdml0eUlkKSB7XHJcbiAgICB2YXIgYWN0aXZpdHkgPSB0aGlzLl9rbm93bkFjdGl2aXRpZXMuZ2V0KGFjdGl2aXR5SWQpO1xyXG4gICAgaWYgKCFhY3Rpdml0eSkgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eVJ1bnRpbWVFcnJvcihcIkFjdGl2aXR5IGJ5IGlkICdcIiArIGFjdGl2aXR5SWQgKyBcIicgbm90IGZvdW5kLlwiKTtcclxuICAgIHJldHVybiBhY3Rpdml0eTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5jcmVhdGVCb29rbWFyayA9IGZ1bmN0aW9uIChhY3Rpdml0eUlkLCBuYW1lLCBlbmRDYWxsYmFjaykge1xyXG4gICAgdGhpcy5yZWdpc3RlckJvb2ttYXJrKFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgbmFtZTogbmFtZSxcclxuICAgICAgICAgICAgYWN0aXZpdHlJZDogYWN0aXZpdHlJZCxcclxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSxcclxuICAgICAgICAgICAgZW5kQ2FsbGJhY2s6IGVuZENhbGxiYWNrXHJcbiAgICAgICAgfSk7XHJcbiAgICByZXR1cm4gbmFtZTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5yZWdpc3RlckJvb2ttYXJrID0gZnVuY3Rpb24gKGJvb2ttYXJrKSB7XHJcbiAgICBpZiAodGhpcy5fYm9va21hcmtzLmdldChib29rbWFyay5uYW1lKSkgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eVJ1bnRpbWVFcnJvcihcIkJvb2ttYXJrICdcIiArIGJvb2ttYXJrLm5hbWUgKyBcIicgYWxyZWFkeSBleGlzdHMuXCIpO1xyXG4gICAgdGhpcy5fYm9va21hcmtzLnNldChib29rbWFyay5uYW1lLCBib29rbWFyayk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuaXNCb29rbWFya0V4aXN0cyA9IGZ1bmN0aW9uIChuYW1lKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fYm9va21hcmtzLmNvbnRhaW5zS2V5KG5hbWUpO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLmdldEJvb2ttYXJrVGltZXN0YW1wID0gZnVuY3Rpb24gKG5hbWUsIHRocm93SWZOb3RGb3VuZCkge1xyXG4gICAgdmFyIGJtID0gdGhpcy5fYm9va21hcmtzLmdldChuYW1lKTtcclxuICAgIGlmIChpcy51bmRlZmluZWQoYm0pICYmIHRocm93SWZOb3RGb3VuZCkgdGhyb3cgbmV3IEVycm9yKFwiQm9va21hcmsgJ1wiICsgbmFtZSArIFwiJyBub3QgZm91bmQuXCIpO1xyXG4gICAgcmV0dXJuIGJtID8gYm0udGltZXN0YW1wIDogbnVsbDtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5kZWxldGVCb29rbWFyayA9IGZ1bmN0aW9uIChuYW1lKSB7XHJcbiAgICB0aGlzLl9ib29rbWFya3MucmVtb3ZlKG5hbWUpO1xyXG59XHJcblxyXG5BY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQucHJvdG90eXBlLnJlc3VtZUJvb2ttYXJrSW5TY29wZSA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgbmFtZSwgcmVhc29uLCByZXN1bHQpIHtcclxuICAgIHZhciBibSA9IHRoaXMuX2Jvb2ttYXJrcy5nZXQobmFtZSk7XHJcbiAgICBpZiAoaXMudW5kZWZpbmVkKGJtKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkJvb2ttYXJrICdcIiArIG5hbWUgKyBcIicgZG9lc24ndCBleGlzdHMuIENhbm5vdCBjb250aW51ZSB3aXRoIHJlYXNvbjogXCIgKyByZWFzb24gKyBcIi5cIik7XHJcbiAgICB9XHJcbiAgICB0aGlzLl9kb1Jlc3VtZUJvb2ttYXJrKGNhbGxDb250ZXh0LCBibSwgcmVhc29uLCByZXN1bHQsIHJlYXNvbiA9PSBlbnVtcy5BY3Rpdml0eVN0YXRlcy5pZGxlKTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5yZXN1bWVCb29rbWFya0ludGVybmFsID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBuYW1lLCByZWFzb24sIHJlc3VsdCkge1xyXG4gICAgdmFyIGJtID0gdGhpcy5fYm9va21hcmtzLmdldChuYW1lKTtcclxuICAgIHRoaXMuX3Jlc3VtZUJNUXVldWUuZW5xdWV1ZShuYW1lLCByZWFzb24sIHJlc3VsdCk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUucmVzdW1lQm9va21hcmtFeHRlcm5hbCA9IGZ1bmN0aW9uIChuYW1lLCByZWFzb24sIHJlc3VsdCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgdmFyIGJtID0gc2VsZi5fYm9va21hcmtzLmdldChuYW1lKTtcclxuICAgIGlmIChpcy51bmRlZmluZWQoYm0pKSB0aHJvdyBuZXcgZXJyb3JzLkFjdGl2aXR5UnVudGltZUVycm9yKFwiSW50ZXJuYWwgcmVzdW1lIGJvb2ttYXJrIHJlcXVlc3QgY2Fubm90IGJlIHByb2Nlc3NlZCBiZWNhdXNlIGJvb2ttYXJrICdcIiArIGNvbW1hbmQubmFtZSArIFwiJyBkb2Vzbid0IGV4aXN0cy5cIik7XHJcbiAgICBzZWxmLl9kb1Jlc3VtZUJvb2ttYXJrKG5ldyBDYWxsQ29udGV4dCh0aGlzLCBibS5hY3Rpdml0eUlkKSwgYm0sIHJlYXNvbiwgcmVzdWx0KTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5wcm9jZXNzUmVzdW1lQm9va21hcmtRdWV1ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHZhciBjb21tYW5kID0gc2VsZi5fcmVzdW1lQk1RdWV1ZS5kZXF1ZXVlKCk7XHJcbiAgICBpZiAoY29tbWFuZCkge1xyXG4gICAgICAgIHZhciBibSA9IHNlbGYuX2Jvb2ttYXJrcy5nZXQoY29tbWFuZC5uYW1lKTtcclxuICAgICAgICBpZiAoaXMudW5kZWZpbmVkKGJtKSkgdGhyb3cgbmV3IGVycm9ycy5BY3Rpdml0eVJ1bnRpbWVFcnJvcihcIkludGVybmFsIHJlc3VtZSBib29rbWFyayByZXF1ZXN0IGNhbm5vdCBiZSBwcm9jZXNzZWQgYmVjYXVzZSBib29rbWFyayAnXCIgKyBjb21tYW5kLm5hbWUgKyBcIicgZG9lc24ndCBleGlzdHMuXCIpO1xyXG4gICAgICAgIHNlbGYuX2RvUmVzdW1lQm9va21hcmsobmV3IENhbGxDb250ZXh0KHRoaXMsIGJtLmFjdGl2aXR5SWQpLCBibSwgY29tbWFuZC5yZWFzb24sIGNvbW1hbmQucmVzdWx0KTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5fZG9SZXN1bWVCb29rbWFyayA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgYm9va21hcmssIHJlYXNvbiwgcmVzdWx0LCBub1JlbW92ZSkge1xyXG4gICAgdmFyIHNjb3BlID0gY2FsbENvbnRleHQuc2NvcGU7XHJcbiAgICBpZiAoIW5vUmVtb3ZlKSB0aGlzLl9ib29rbWFya3MucmVtb3ZlKGJvb2ttYXJrLm5hbWUpO1xyXG4gICAgaWYgKGlzLnVuZGVmaW5lZChzY29wZS5nZXQoYm9va21hcmsuZW5kQ2FsbGJhY2spKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuQWN0aXZpdHlSdW50aW1lRXJyb3IoXCJCb29rbWFyaydzICdcIiArIGJvb2ttYXJrLm5hbWUgKyBcIicgY2FsbGJhY2sgJ1wiICsgYm9va21hcmsuZW5kQ2FsbGJhY2sgKyBcIicgaXMgbm90IGRlZmluZWQgb24gdGhlIGN1cnJlbnQgc2NvcGUuXCIpO1xyXG4gICAgfVxyXG4gICAgc2NvcGUuZ2V0KGJvb2ttYXJrLmVuZENhbGxiYWNrKS5jYWxsKHNjb3BlLCBjYWxsQ29udGV4dCwgcmVhc29uLCByZXN1bHQsIGJvb2ttYXJrKTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5jYW5jZWxFeGVjdXRpb24gPSBmdW5jdGlvbiAoYWN0aXZpdHlJZHMpIHtcclxuICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgIHZhciBhbGxJZHMgPSBuZXcgU3RyU2V0KCk7XHJcbiAgICBmYXN0LmZvckVhY2goYWN0aXZpdHlJZHMsXHJcbiAgICAgICAgZnVuY3Rpb24gKGlkKSB7XHJcbiAgICAgICAgICAgIHNlbGYuX2NhbmNlbFN1YnRyZWUoYWxsSWRzLCBpZCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICBzZWxmLl9ib29rbWFya3MuZm9yRWFjaFZhbHVlKGZ1bmN0aW9uIChibSkge1xyXG4gICAgICAgIGlmIChhbGxJZHMuZXhpc3RzKGJtLmFjdGl2aXR5SWQpKSB7XHJcbiAgICAgICAgICAgIHNlbGYuX2Jvb2ttYXJrcy5yZW1vdmUoYm0ubmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuX2NhbmNlbFN1YnRyZWUgPSBmdW5jdGlvbiAoYWxsSWRzLCBhY3Rpdml0eUlkKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICBhbGxJZHMuYWRkKGFjdGl2aXR5SWQpO1xyXG4gICAgdmFyIHN0YXRlID0gc2VsZi5nZXRTdGF0ZShhY3Rpdml0eUlkKTtcclxuICAgIHN0YXRlLmNoaWxkQWN0aXZpdHlJZHMuZm9yRWFjaChcclxuICAgICAgICBmdW5jdGlvbiAoaWQpIHtcclxuICAgICAgICAgICAgc2VsZi5fY2FuY2VsU3VidHJlZShhbGxJZHMsIGlkKTtcclxuICAgICAgICB9KTtcclxuICAgIHN0YXRlLnJlcG9ydFN0YXRlKGVudW1zLkFjdGl2aXR5U3RhdGVzLmNhbmNlbCk7XHJcbn1cclxuXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuZGVsZXRlU2NvcGVPZkFjdGl2aXR5ID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBhY3Rpdml0eUlkKSB7XHJcbiAgICB0aGlzLl9zY29wZVRyZWUuZGVsZXRlU2NvcGVQYXJ0KGNhbGxDb250ZXh0LmFjdGl2aXR5SWQsIGFjdGl2aXR5SWQpO1xyXG59XHJcblxyXG4vKiBTRVJJQUxJWkFUSU9OICovXHJcbkFjdGl2aXR5RXhlY3V0aW9uQ29udGV4dC5wcm90b3R5cGUuZ2V0U3RhdGVBbmRQcm9tb3Rpb25zID0gZnVuY3Rpb24gKHNlcmlhbGl6ZXIsIGdldFByb21vdGlvbnMpIHtcclxuICAgIGlmIChzZXJpYWxpemVyICYmICFfLmlzRnVuY3Rpb24oc2VyaWFsaXplci50b0pTT04pKSB0aHJvdyBuZXcgRXJyb3IoXCJBcmd1bWVudCAnc2VyaWFsaXplcicgaXMgbm90IGEgc2VyaWFsaXplci5cIik7XHJcblxyXG4gICAgdmFyIGFjdGl2aXR5U3RhdGVzID0gbmV3IFN0ck1hcCgpO1xyXG4gICAgdGhpcy5fYWN0aXZpdHlTdGF0ZXMuZm9yRWFjaFZhbHVlKGZ1bmN0aW9uIChzKSB7XHJcbiAgICAgICAgYWN0aXZpdHlTdGF0ZXMuYWRkKHMuYWN0aXZpdHlJZCwgcy5hc0pTT04oKSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB2YXIgc2NvcGVTdGF0ZUFuZFByb21vdGlvbnMgPSB0aGlzLl9zY29wZVRyZWUuZ2V0U3RhdGUoZ2V0UHJvbW90aW9ucyk7XHJcblxyXG4gICAgdmFyIHNlcmlhbGl6ZWQ7XHJcbiAgICBpZiAoc2VyaWFsaXplcikge1xyXG4gICAgICAgIHNlcmlhbGl6ZWQgPSBzZXJpYWxpemVyLnRvSlNPTih7XHJcbiAgICAgICAgICAgIGFjdGl2aXR5U3RhdGVzOiBhY3Rpdml0eVN0YXRlcyxcclxuICAgICAgICAgICAgYm9va21hcmtzOiB0aGlzLl9ib29rbWFya3MsXHJcbiAgICAgICAgICAgIHNjb3BlOiBzY29wZVN0YXRlQW5kUHJvbW90aW9ucy5zdGF0ZVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgc2VyaWFsaXplZCA9IHtcclxuICAgICAgICAgICAgYWN0aXZpdHlTdGF0ZXM6IGFjdGl2aXR5U3RhdGVzLl9zZXJpYWxpemVUb0pTT04oKSxcclxuICAgICAgICAgICAgYm9va21hcmtzOiB0aGlzLl9ib29rbWFya3MuX3NlcmlhbGl6ZVRvSlNPTigpLFxyXG4gICAgICAgICAgICBzY29wZTogc2NvcGVTdGF0ZUFuZFByb21vdGlvbnMuc3RhdGVcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0ZTogc2VyaWFsaXplZCxcclxuICAgICAgICBwcm9tb3RlZFByb3BlcnRpZXM6IHNjb3BlU3RhdGVBbmRQcm9tb3Rpb25zLnByb21vdGVkUHJvcGVydGllc1xyXG4gICAgfTtcclxufVxyXG5cclxuQWN0aXZpdHlFeGVjdXRpb25Db250ZXh0LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uIChzZXJpYWxpemVyLCBqc29uKSB7XHJcbiAgICBpZiAoc2VyaWFsaXplciAmJiAhXy5pc0Z1bmN0aW9uKHNlcmlhbGl6ZXIuZnJvbUpTT04pKSB0aHJvdyBuZXcgRXJyb3IoXCJBcmd1bWVudCAnc2VyaWFsaXplcicgaXMgbm90IGEgc2VyaWFsaXplci5cIik7XHJcbiAgICBpZiAoIV8uaXNPYmplY3QoanNvbikpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCAnanNvbicgaXMgbm90IGFuIG9iamVjdC5cIik7XHJcblxyXG4gICAgaWYgKHNlcmlhbGl6ZXIpIHtcclxuICAgICAgICBqc29uID0gc2VyaWFsaXplci5mcm9tSlNPTihqc29uKTtcclxuICAgICAgICBpZiAoIShqc29uLmFjdGl2aXR5U3RhdGVzIGluc3RhbmNlb2YgU3RyTWFwKSkgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFjdGl2aXR5U3RhdGVzIHByb3BlcnR5IHZhbHVlIG9mIGFyZ3VtZW50ICdqc29uJyBpcyBub3QgYW4gU3RyTWFwIGluc3RhbmNlLlwiKTtcclxuICAgICAgICBpZiAoIShqc29uLmJvb2ttYXJrcyBpbnN0YW5jZW9mIFN0ck1hcCkpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJCb29rbWFya3MgcHJvcGVydHkgdmFsdWUgb2YgYXJndW1lbnQgJ2pzb24nIGlzIG5vdCBhbiBTdHJNYXAgaW5zdGFuY2UuXCIpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgaWYgKCFqc29uLmFjdGl2aXR5U3RhdGVzKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQWN0aXZpdHlTdGF0ZXMgcHJvcGVydHkgdmFsdWUgb2YgYXJndW1lbnQgJ2pzb24nIGlzIG5vdCBhbiBvYmplY3QuXCIpO1xyXG4gICAgICAgIGlmICghanNvbi5ib29rbWFya3MpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJCb29rbWFya3MgcHJvcGVydHkgdmFsdWUgb2YgYXJndW1lbnQgJ2pzb24nIGlzIG5vdCBhbiBvYmplY3QuXCIpO1xyXG5cclxuICAgICAgICB2YXIgYWN0aXZpdHlTdGF0ZXMgPSBuZXcgU3RyTWFwKCk7XHJcbiAgICAgICAgYWN0aXZpdHlTdGF0ZXMuX2Rlc2VyaWFsaXplRnJvbUpTT04oanNvbi5hY3Rpdml0eVN0YXRlcyk7XHJcbiAgICAgICAgdmFyIGJvb2ttYXJrcyA9IG5ldyBTdHJNYXAoKTtcclxuICAgICAgICBib29rbWFya3MuX2Rlc2VyaWFsaXplRnJvbUpTT04oanNvbi5ib29rbWFya3MpO1xyXG4gICAgICAgIGpzb24gPSB7XHJcbiAgICAgICAgICAgIGFjdGl2aXR5U3RhdGVzOiBhY3Rpdml0eVN0YXRlcyxcclxuICAgICAgICAgICAgYm9va21hcmtzOiBib29rbWFya3MsXHJcbiAgICAgICAgICAgIHNjb3BlOiBqc29uLnNjb3BlXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLl9hY3Rpdml0eVN0YXRlcy5mb3JFYWNoVmFsdWUoZnVuY3Rpb24gKHMpIHtcclxuICAgICAgICB2YXIgc3RvcmVkID0ganNvbi5hY3Rpdml0eVN0YXRlcy5nZXQocy5hY3Rpdml0eUlkKTtcclxuICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZChzdG9yZWQpKSB0aHJvdyBuZXcgRXJyb3IoXCJBY3Rpdml0eSBcIiArIGEuYWN0aXZpdHlJZCArIFwiIHN0YXRlIG5vdCBmb3VuZC5cIik7XHJcbiAgICAgICAgcy5mcm9tSlNPTihzdG9yZWQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5fYm9va21hcmtzID0ganNvbi5ib29rbWFya3M7XHJcbiAgICB0aGlzLl9zY29wZVRyZWUuc2V0U3RhdGUoanNvbi5zY29wZSk7XHJcbn1cclxuLyogU0VSSUFMSVpBVElPTiAqL1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBBY3Rpdml0eUV4ZWN1dGlvbkNvbnRleHQ7Il19
